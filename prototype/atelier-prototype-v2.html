<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アトリエ錬金術 - プロトタイプv2</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Meiryo', monospace;
            padding: 15px;
            max-width: 800px;
            margin: 0 auto;
            background: #1a1a2e;
            color: #eee;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 22px;
        }

        /* 状態表示 */
        .state {
            background: #16213e;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        .state-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .state-item { flex: 1; text-align: center; }
        .state-label { font-size: 11px; color: #888; }
        .state-value { font-size: 18px; font-weight: bold; }

        .bar-container {
            background: #0a0a15;
            border-radius: 4px;
            height: 16px;
            margin-top: 4px;
            overflow: hidden;
            position: relative;
        }
        .bar { height: 100%; transition: width 0.3s ease; }
        .bar-pioneer { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        .bar-fatigue { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        /* フェーズ表示 */
        .phase-indicator {
            text-align: center;
            padding: 8px;
            background: #0f3460;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .phase-indicator .phase-name { color: #ffd700; font-weight: bold; }

        /* デッキ（素材カード一覧） */
        .deck-section {
            background: #16213e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #0f3460;
        }
        .deck-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .deck-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .material-card {
            width: 70px;
            padding: 8px 4px;
            background: #0a0a15;
            border: 2px solid #333;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        .material-card:hover { border-color: #ffd700; transform: translateY(-2px); }
        .material-card.selected {
            border-color: #ffd700;
            background: #2a2a3e;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .material-card .name { font-weight: bold; margin-bottom: 4px; }
        .material-card .attrs { font-size: 10px; color: #888; }
        .attr-fire { color: #e74c3c; }
        .attr-water { color: #3498db; }
        .attr-earth { color: #8b4513; }
        .attr-wind { color: #2ecc71; }

        /* 調合エリア */
        .craft-section {
            background: #16213e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #0f3460;
        }
        .craft-title {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }
        .craft-slots {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .craft-slot {
            width: 70px;
            height: 80px;
            background: #0a0a15;
            border: 2px dashed #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #555;
        }
        .craft-slot.filled {
            border-style: solid;
            border-color: #ffd700;
        }
        .craft-slot .slot-card {
            text-align: center;
            font-size: 11px;
        }

        /* 属性合計表示 */
        .attr-totals {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .attr-total { font-weight: bold; }

        /* 作成可能アイテム */
        .craftable-items {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .craft-option {
            padding: 10px 15px;
            background: #0a0a15;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s;
        }
        .craft-option:hover:not(.disabled) {
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        .craft-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .craft-option.highlight {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        .craft-option .item-name { font-weight: bold; margin-bottom: 4px; }
        .craft-option .item-req { font-size: 10px; color: #888; }
        .craft-option .item-effect { font-size: 11px; color: #2ecc71; margin-top: 4px; }
        .craft-option .item-effect.heal { color: #3498db; }

        /* アクションボタン */
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 12px;
        }
        .actions button {
            padding: 10px 20px;
            font-size: 13px;
            cursor: pointer;
            border: 2px solid #0f3460;
            background: #16213e;
            color: #eee;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .actions button:hover:not(:disabled) {
            background: #0f3460;
            border-color: #ffd700;
        }
        .actions button:disabled { opacity: 0.4; cursor: not-allowed; }
        .actions button.primary {
            background: #27ae60;
            border-color: #2ecc71;
        }
        .actions button.primary:hover:not(:disabled) { background: #2ecc71; }
        .actions button.danger {
            background: #c0392b;
            border-color: #e74c3c;
        }

        /* ログ */
        .log {
            background: #0a0a15;
            color: #0f0;
            padding: 10px;
            height: 120px;
            overflow-y: auto;
            font-size: 11px;
            border-radius: 6px;
            border: 1px solid #0f3460;
            margin-bottom: 10px;
        }
        .log p { margin: 2px 0; }
        .log .pioneer { color: #2ecc71; }
        .log .fatigue { color: #e74c3c; }
        .log .deck { color: #3498db; }
        .log .event { color: #ffd700; }
        .log .turn { color: #888; }

        .reset { text-align: center; }
        .reset button {
            padding: 8px 30px;
            font-size: 12px;
            cursor: pointer;
            background: #e74c3c;
            border: none;
            color: white;
            border-radius: 6px;
        }

        .game-over, .victory {
            font-weight: bold;
            font-size: 20px;
            margin: 12px 0;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
        }
        .game-over { color: #e74c3c; background: rgba(231, 76, 60, 0.2); }
        .victory { color: #2ecc71; background: rgba(46, 204, 113, 0.2); }

        .hint {
            font-size: 10px;
            color: #555;
            text-align: center;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <h1>アトリエ錬金術 - 開拓地1</h1>

    <!-- 状態表示 -->
    <div class="state">
        <div class="state-row">
            <div class="state-item">
                <div class="state-label">開拓度</div>
                <div class="state-value" id="pioneer">0%</div>
                <div class="bar-container">
                    <div class="bar bar-pioneer" id="pioneer-bar" style="width: 0%"></div>
                    <div class="bar-text" id="pioneer-text">0 / 100</div>
                </div>
            </div>
            <div class="state-item">
                <div class="state-label">消耗度</div>
                <div class="state-value" id="fatigue">0%</div>
                <div class="bar-container">
                    <div class="bar bar-fatigue" id="fatigue-bar" style="width: 0%"></div>
                    <div class="bar-text" id="fatigue-text">0 / 100</div>
                </div>
            </div>
            <div class="state-item">
                <div class="state-label">ターン</div>
                <div class="state-value" id="turn">1</div>
            </div>
            <div class="state-item">
                <div class="state-label">通貨</div>
                <div class="state-value" id="gold">30G</div>
            </div>
        </div>
    </div>

    <div id="message"></div>

    <!-- フェーズ表示 -->
    <div class="phase-indicator">
        <span class="phase-name" id="phase">素材を選んで調合しよう</span>
    </div>

    <!-- デッキ（素材カード一覧） -->
    <div class="deck-section">
        <div class="deck-title">
            <span>所持素材</span>
            <span id="deck-count">0枚</span>
        </div>
        <div class="deck-cards" id="deck-cards"></div>
    </div>

    <!-- 調合エリア -->
    <div class="craft-section">
        <div class="craft-title">調合スロット（素材をクリックして選択）</div>
        <div class="craft-slots" id="craft-slots">
            <div class="craft-slot" id="slot-0"><span>空</span></div>
            <div class="craft-slot" id="slot-1"><span>空</span></div>
            <div class="craft-slot" id="slot-2"><span>空</span></div>
        </div>

        <!-- 属性合計 -->
        <div class="attr-totals">
            <span class="attr-total attr-fire">火: <span id="total-fire">0</span></span>
            <span class="attr-total attr-water">水: <span id="total-water">0</span></span>
            <span class="attr-total attr-earth">土: <span id="total-earth">0</span></span>
            <span class="attr-total attr-wind">風: <span id="total-wind">0</span></span>
            <span style="color: #ffd700;">合計: <span id="total-all">0</span></span>
        </div>

        <!-- 作成可能アイテム -->
        <div class="craftable-items" id="craftable-items">
            <div class="craft-option" id="craft-weapon" onclick="craft('weapon')">
                <div class="item-name">武器</div>
                <div class="item-req">火+土 ≥ 8</div>
                <div class="item-effect">開拓度 UP</div>
            </div>
            <div class="craft-option" id="craft-potion" onclick="craft('potion')">
                <div class="item-name">薬</div>
                <div class="item-req">水+風 ≥ 8</div>
                <div class="item-effect heal">消耗度 DOWN</div>
            </div>
            <div class="craft-option" id="craft-tool" onclick="craft('tool')">
                <div class="item-name">道具</div>
                <div class="item-req">合計 ≥ 10</div>
                <div class="item-effect">特殊効果</div>
            </div>
        </div>
    </div>

    <!-- アクションボタン -->
    <div class="actions">
        <button onclick="clearSlots()">選択解除</button>
        <button onclick="openShop()" id="shop-btn">買い物 (12G)</button>
        <button onclick="endTurn()" class="danger">ターン終了</button>
    </div>

    <!-- ログ -->
    <div class="log" id="log"></div>

    <div class="reset">
        <button onclick="reset()">最初からやり直す</button>
    </div>

    <div class="hint">
        素材を選んで属性を組み合わせ、武器（開拓）か薬（回復）を作ろう！
    </div>

    <script>
        // === 素材データ ===
        const MATERIALS = [
            { name: '鉄鉱石', fire: 3, water: 0, earth: 2, wind: 0 },
            { name: '硫黄', fire: 4, water: 0, earth: 1, wind: 0 },
            { name: '薬草', fire: 0, water: 3, earth: 0, wind: 2 },
            { name: '苔', fire: 0, water: 2, earth: 1, wind: 2 },
            { name: '粘土', fire: 1, water: 1, earth: 3, wind: 0 },
            { name: '花', fire: 0, water: 2, earth: 0, wind: 3 },
            { name: '種', fire: 0, water: 1, earth: 1, wind: 3 },
            { name: '石', fire: 1, water: 0, earth: 4, wind: 0 },
            { name: '木の枝', fire: 2, water: 0, earth: 1, wind: 2 },
            { name: '水晶', fire: 1, water: 2, earth: 2, wind: 1 },
        ];

        // === ゲーム設定 ===
        const CONFIG = {
            fatiguePerTurn: 5,
            shopCost: 12,       // 15→12に緩和
            craftReward: 10,    // 調合報酬（5→10に増加）
            weaponReq: 8,       // 火+土の必要値
            potionReq: 8,       // 水+風の必要値
            toolReq: 10,        // 合計の必要値
            initialGold: 50,    // 初期ゴールド（30→50に増加）
            initialDeckSize: 10 // 初期デッキ（8→10に増加）
        };

        // === GAME STATE ===
        let state = {
            pioneer: 0,
            fatigue: 0,
            turn: 1,
            gold: 30,
            deck: [],           // 所持している素材カード
            selectedCards: [],  // 選択中のカード（インデックス）
            gameOver: false
        };

        // === 初期デッキ生成 ===
        function generateInitialDeck() {
            const deck = [];
            // バランスよく配布
            for (let i = 0; i < CONFIG.initialDeckSize; i++) {
                deck.push({ ...MATERIALS[Math.floor(Math.random() * MATERIALS.length)], id: i });
            }
            return deck;
        }

        // === 素材カード描画 ===
        function renderDeck() {
            const container = document.getElementById('deck-cards');
            container.innerHTML = '';

            state.deck.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'material-card' + (state.selectedCards.includes(index) ? ' selected' : '');
                div.onclick = () => toggleCard(index);

                const attrs = [];
                if (card.fire > 0) attrs.push(`<span class="attr-fire">火${card.fire}</span>`);
                if (card.water > 0) attrs.push(`<span class="attr-water">水${card.water}</span>`);
                if (card.earth > 0) attrs.push(`<span class="attr-earth">土${card.earth}</span>`);
                if (card.wind > 0) attrs.push(`<span class="attr-wind">風${card.wind}</span>`);

                div.innerHTML = `
                    <div class="name">${card.name}</div>
                    <div class="attrs">${attrs.join(' ')}</div>
                `;
                container.appendChild(div);
            });

            document.getElementById('deck-count').textContent = state.deck.length + '枚';
        }

        // === カード選択トグル ===
        function toggleCard(index) {
            if (state.gameOver) return;

            const pos = state.selectedCards.indexOf(index);
            if (pos >= 0) {
                state.selectedCards.splice(pos, 1);
            } else if (state.selectedCards.length < 3) {
                state.selectedCards.push(index);
            }

            renderDeck();
            renderSlots();
            updateCraftOptions();
        }

        // === スロット描画 ===
        function renderSlots() {
            for (let i = 0; i < 3; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (state.selectedCards[i] !== undefined) {
                    const card = state.deck[state.selectedCards[i]];
                    slot.className = 'craft-slot filled';
                    slot.innerHTML = `<div class="slot-card"><div>${card.name}</div></div>`;
                } else {
                    slot.className = 'craft-slot';
                    slot.innerHTML = '<span>空</span>';
                }
            }

            // 属性合計計算
            let totals = { fire: 0, water: 0, earth: 0, wind: 0 };
            state.selectedCards.forEach(idx => {
                const card = state.deck[idx];
                totals.fire += card.fire;
                totals.water += card.water;
                totals.earth += card.earth;
                totals.wind += card.wind;
            });

            document.getElementById('total-fire').textContent = totals.fire;
            document.getElementById('total-water').textContent = totals.water;
            document.getElementById('total-earth').textContent = totals.earth;
            document.getElementById('total-wind').textContent = totals.wind;
            document.getElementById('total-all').textContent = totals.fire + totals.water + totals.earth + totals.wind;
        }

        // === 作成可能アイテム更新 ===
        function updateCraftOptions() {
            let totals = { fire: 0, water: 0, earth: 0, wind: 0 };
            state.selectedCards.forEach(idx => {
                const card = state.deck[idx];
                totals.fire += card.fire;
                totals.water += card.water;
                totals.earth += card.earth;
                totals.wind += card.wind;
            });

            const fireEarth = totals.fire + totals.earth;
            const waterWind = totals.water + totals.wind;
            const all = totals.fire + totals.water + totals.earth + totals.wind;

            const weaponEl = document.getElementById('craft-weapon');
            const potionEl = document.getElementById('craft-potion');
            const toolEl = document.getElementById('craft-tool');

            // 武器: 火+土 >= 8
            weaponEl.classList.toggle('disabled', fireEarth < CONFIG.weaponReq || state.selectedCards.length === 0);
            weaponEl.classList.toggle('highlight', fireEarth >= CONFIG.weaponReq && state.selectedCards.length > 0);
            weaponEl.querySelector('.item-effect').textContent = `開拓度 +${Math.floor(fireEarth * 2)}%`;

            // 薬: 水+風 >= 8
            potionEl.classList.toggle('disabled', waterWind < CONFIG.potionReq || state.selectedCards.length === 0);
            potionEl.classList.toggle('highlight', waterWind >= CONFIG.potionReq && state.selectedCards.length > 0);
            potionEl.querySelector('.item-effect').textContent = `消耗度 -${Math.floor(waterWind * 2)}%`;

            // 道具: 合計 >= 10
            toolEl.classList.toggle('disabled', all < CONFIG.toolReq || state.selectedCards.length === 0);
            toolEl.classList.toggle('highlight', all >= CONFIG.toolReq && state.selectedCards.length > 0);
        }

        // === 調合実行 ===
        function craft(type) {
            if (state.gameOver || state.selectedCards.length === 0) return;

            let totals = { fire: 0, water: 0, earth: 0, wind: 0 };
            state.selectedCards.forEach(idx => {
                const card = state.deck[idx];
                totals.fire += card.fire;
                totals.water += card.water;
                totals.earth += card.earth;
                totals.wind += card.wind;
            });

            const fireEarth = totals.fire + totals.earth;
            const waterWind = totals.water + totals.wind;
            const all = totals.fire + totals.water + totals.earth + totals.wind;

            let success = false;
            let result = '';

            switch (type) {
                case 'weapon':
                    if (fireEarth >= CONFIG.weaponReq) {
                        const effect = Math.floor(fireEarth * 2);
                        state.pioneer = Math.min(100, state.pioneer + effect);
                        result = `【武器】を調合！ 開拓度 +${effect}%`;
                        success = true;
                    }
                    break;
                case 'potion':
                    if (waterWind >= CONFIG.potionReq) {
                        const effect = Math.floor(waterWind * 2);
                        state.fatigue = Math.max(0, state.fatigue - effect);
                        result = `【薬】を調合！ 消耗度 -${effect}%`;
                        success = true;
                    }
                    break;
                case 'tool':
                    if (all >= CONFIG.toolReq) {
                        // ランダムな特殊効果
                        const effects = [
                            { text: '頑丈な道具ができた！次のターンの消耗度上昇-3%', effect: () => { state.nextFatigueReduction = 3; } },
                            { text: '便利な道具ができた！+10G獲得', effect: () => { state.gold += 10; } },
                            { text: '探索道具ができた！開拓度+5%', effect: () => { state.pioneer = Math.min(100, state.pioneer + 5); } },
                        ];
                        const chosen = effects[Math.floor(Math.random() * effects.length)];
                        chosen.effect();
                        result = `【道具】を調合！ ${chosen.text}`;
                        success = true;
                    }
                    break;
            }

            if (success) {
                // 使用した素材を削除（インデックスの大きい順に削除）
                const sortedIndices = [...state.selectedCards].sort((a, b) => b - a);
                sortedIndices.forEach(idx => {
                    state.deck.splice(idx, 1);
                });
                state.selectedCards = [];

                log(result, 'pioneer');

                // ボーナスゴールド
                state.gold += CONFIG.craftReward;
                log(`調合報酬: +${CONFIG.craftReward}G`, 'deck');

                updateUI();
                checkEnd();
            }
        }

        // === 選択解除 ===
        function clearSlots() {
            state.selectedCards = [];
            renderDeck();
            renderSlots();
            updateCraftOptions();
        }

        // === 買い物 ===
        function openShop() {
            if (state.gold < CONFIG.shopCost) {
                log('お金が足りない！', 'fatigue');
                return;
            }

            state.gold -= CONFIG.shopCost;
            const newCard = { ...MATERIALS[Math.floor(Math.random() * MATERIALS.length)], id: Date.now() };
            state.deck.push(newCard);

            log(`【買い物】${newCard.name}を入手！ (-${CONFIG.shopCost}G)`, 'deck');
            updateUI();
        }

        // === ターン終了 ===
        function endTurn() {
            if (state.gameOver) return;

            // 消耗度上昇
            let fatigueDelta = CONFIG.fatiguePerTurn;
            if (state.nextFatigueReduction) {
                fatigueDelta -= state.nextFatigueReduction;
                state.nextFatigueReduction = 0;
            }
            state.fatigue = Math.min(100, state.fatigue + fatigueDelta);
            state.turn++;

            log(`ターン${state.turn}開始 - 消耗度 +${fatigueDelta}%`, 'turn');

            // ランダムイベント（15%）
            if (Math.random() < 0.15) {
                triggerRandomEvent();
            }

            clearSlots();
            updateUI();
            checkEnd();
        }

        // === ランダムイベント ===
        function triggerRandomEvent() {
            const events = [
                { text: '野生の素材を発見！', effect: () => {
                    const newCard = { ...MATERIALS[Math.floor(Math.random() * MATERIALS.length)], id: Date.now() };
                    state.deck.push(newCard);
                }},
                { text: '商人が通りかかった！ +10G', effect: () => { state.gold += 10; } },
                { text: '開拓が順調だ！ +5%', effect: () => { state.pioneer = Math.min(100, state.pioneer + 5); } },
                { text: '少し休憩... 消耗度 -5%', effect: () => { state.fatigue = Math.max(0, state.fatigue - 5); } },
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            event.effect();
            log(`【イベント】${event.text}`, 'event');
        }

        // === UI更新 ===
        function updateUI() {
            document.getElementById('pioneer').textContent = state.pioneer + '%';
            document.getElementById('pioneer-bar').style.width = state.pioneer + '%';
            document.getElementById('pioneer-text').textContent = state.pioneer + ' / 100';

            document.getElementById('fatigue').textContent = state.fatigue + '%';
            document.getElementById('fatigue-bar').style.width = state.fatigue + '%';
            document.getElementById('fatigue-text').textContent = state.fatigue + ' / 100';

            document.getElementById('turn').textContent = state.turn;
            document.getElementById('gold').textContent = state.gold + 'G';

            renderDeck();
            renderSlots();
            updateCraftOptions();
        }

        // === ログ ===
        function log(msg, className = '') {
            const logEl = document.getElementById('log');
            const p = document.createElement('p');
            p.textContent = `> ${msg}`;
            if (className) p.classList.add(className);
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // === 終了チェック ===
        function checkEnd() {
            const msgEl = document.getElementById('message');

            if (state.fatigue >= 100) {
                state.gameOver = true;
                msgEl.innerHTML = '<div class="game-over">GAME OVER<br><small>消耗度が限界に達した...</small></div>';
                return;
            }

            if (state.pioneer >= 100) {
                state.gameOver = true;
                msgEl.innerHTML = `<div class="victory">開拓完了！<br><small>ターン${state.turn}でクリア！</small></div>`;
                return;
            }

            if (state.deck.length === 0 && state.gold < CONFIG.shopCost) {
                state.gameOver = true;
                msgEl.innerHTML = '<div class="game-over">詰み...<br><small>素材もお金もない</small></div>';
            }
        }

        // === リセット ===
        function reset() {
            state = {
                pioneer: 0,
                fatigue: 0,
                turn: 1,
                gold: CONFIG.initialGold,
                deck: generateInitialDeck(),
                selectedCards: [],
                gameOver: false,
                nextFatigueReduction: 0
            };
            document.getElementById('log').innerHTML = '';
            document.getElementById('message').innerHTML = '';
            updateUI();
            log('=== ゲーム開始 ===', 'event');
            log('素材を選んで調合しよう！', 'event');
        }

        // === 初期化 ===
        reset();
    </script>
</body>
</html>
