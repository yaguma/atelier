---
description: 影響範囲分析を実施する
allowed-tools: Read, Glob, Grep, Task, Bash
argument-hint: [変更対象（ファイルパス/関数名/クラス名/自然言語）]
---
変更対象の影響範囲を分析し、修正が必要なファイルとリスク評価を提供します。一時ファイルを作成せず直接 Task で実行し、必要に応じて追加調査を繰り返し、最後に全体サマリーを作成します。

# context

出力ディレクトリ=".dcs"
カレントディレクトリ={{プロジェクトルート}}
分析ファイルリスト=[]

# step

- $1 がない場合、「引数に変更対象を指定してください（例: ファイルパス、関数名、クラス名、または自然言語）」と言って終了する
- $1 の内容を簡潔に説明する
- AskUserQuestion ツールを使って以下の質問を順番に実施し、context を更新する：
  1. 変更対象の種類を確認
  2. 変更内容の種類を確認
  3. 分析の目的を確認
  4. 除外条件の有無を確認
- 収集した context の内容をまとめてユーザに宣言する
- step2 を実行する

## step2

- 既存の出力ファイルを確認して、重複しないナンバリングを決定する
  - {{出力ディレクトリ}}/{{timestamp}}_* を検索
  - 今回の内容を簡単に英語化したもの（例: "calculate_function", "user_model"）を作成
  - 同じ timestamp と内容で既存ディレクトリがある場合、末尾の連番を +1 する
  - ベースディレクトリを "{{出力ディレクトリ}}/{{timestamp}}_{{内容の英語化}}" とする
    - 例: ".dcs/20251008_123456_calculate_function"
    - 例: ".dcs/20251008_123456_user_model"
- 分析結果ファイルのリストを準備する（セクション別分割ファイル）
  - インデックスファイル: "{{ベースディレクトリ}}/index.md"
  - サマリーファイル: "{{ベースディレクトリ}}/summary.md"
  - 各層別ファイル: "core.md", "api.md", "service.md", "data.md", "ui.md", "test.md", "config.md", "other.md"
  - その他: "external.md", "recommendations.md", "details.md"
- すべてのファイル名を 分析ファイルリスト に追加する
- <impact_analysis_template> の内容を context の情報で埋めて、Task ツールで直接実行する
  - subagent_type: "general-purpose"
  - description: "影響範囲分析の実行"
  - prompt: テンプレートの内容を context で埋めた完全なプロンプト
- Task の実行結果を受け取る
- step3 を実行する

## step3

- 出力されたファイルを Read で確認する
- 深掘り内容のルール に基づいて、追加調査が必要かを判断する
- 追加調査が必要な場合：
  - 追加調査の内容をリストとしてユーザに提示する
  - ユーザの承認を得る
  - 追加調査項目が複数ある場合、各項目に対して個別に Task ツールで追加調査を実行する
    - 各項目ごとに新しい連番で追加ファイルとして保存する（例: "2_core.md", "3_api.md", "4_service.md"）
    - 各ファイル名を 分析ファイルリスト に追加する
  - 再度 step3 を実行する（追加調査が不要になるまで繰り返す、最大5回）
- 追加調査が不要な場合：
  - step4 を実行する

## step4

- <summary_template> の内容を使って、Task ツールで最終サマリーファイルを作成する
  - subagent_type: "general-purpose"
  - description: "影響範囲分析 最終サマリーの作成"
  - prompt: サマリーテンプレートの内容を context で埋めた完全なプロンプト
  - 最終サマリーファイル名: "{{ベースディレクトリ}}/final_summary.md"
- 全ての分析ファイルのパスを分析回数別に整理して表示する
  - 初回分析ファイル一覧（インデックス、サマリー、層別ファイルなど）
  - 追加調査ファイル一覧（該当する場合）
  - 最終サマリー
- 分析完了をユーザに報告する

# rules

## 確認ポイント

AskUserQuestion ツールを使って、以下の質問を順番に実施する：

### 質問1: 変更対象の種類
- **質問**: 変更対象はどの種類ですか？
- **header**: "対象種類"
- **options**:
  - "ファイルパス" - 特定のファイル全体またはファイル内の特定箇所
  - "関数/メソッド" - 特定の関数やメソッド
  - "クラス/型" - クラスや型定義
  - "自然言語" - 機能や概念の説明（具体的なコード要素は未特定）

### 質問2: 変更内容の種類
- **質問**: どのような変更を予定していますか？
- **header**: "変更種類"
- **multiSelect**: true
- **options**:
  - "削除" - コードやファイルを削除する
  - "変更" - 既存のコードを修正する
  - "追加" - 新しいコードや機能を追加する
  - "リファクタリング" - 動作を変えずに内部実装を改善する

### 質問3: 分析の目的
- **質問**: この影響範囲分析の主な目的は何ですか？
- **header**: "分析目的"
- **options**:
  - "リリース前の影響確認" - 本番リリース前のリスク評価
  - "リファクタリング計画" - コード改善の影響範囲把握
  - "バグ修正の影響確認" - バグ修正による副作用の確認
  - "機能追加の影響確認" - 新機能追加による既存機能への影響確認

### 質問4: 除外条件
- **質問**: 分析から除外したい対象はありますか？
- **header**: "除外条件"
- **multiSelect**: true
- **options**:
  - "テストコード" - テストファイルを除外
  - "ドキュメント" - ドキュメントファイルを除外
  - "特定ディレクトリ" - 特定のディレクトリを除外（追記で指定）
  - "除外なし" - すべて分析対象にする

contextとして以下を保持する
- 変更対象（具体的なファイルパスまたはコード要素）
- 変更対象の種類
- 変更内容の種類
- 分析の目的
- 除外条件

## ファイル名のルール

### timestamp の形式
- yyyyMMddHHmmss 形式（例: 20251008123456）

### 内容の英語化のルール
- 変更対象を簡潔な英語に変換する
- スネークケース（snake_case）を使用
- 最大30文字程度に収める
- 例:
  - "calculateTotal 関数" → "calculate_total"
  - "ユーザーモデル" → "user_model"
  - "src/utils/helper.ts" → "utils_helper"
  - "APIエンドポイント" → "api_endpoint"

### セクション別ファイル名のルール
- 分析結果は論理的なセクション単位で分割し、各セクション500行以内を目標とする
- 各セクションはベースディレクトリ内に個別ファイルとして配置
- セクション一覧:
  - `index.md` - インデックス（全体概要とファイル一覧）
  - `summary.md` - 分析対象とサマリー
  - `core.md` - コアロジック層の影響
  - `api.md` - API層の影響
  - `service.md` - サービス層の影響
  - `data.md` - データアクセス層の影響
  - `ui.md` - UI層の影響
  - `test.md` - テストの影響
  - `config.md` - 設定の影響
  - `other.md` - その他の影響
  - `external.md` - 外部依存関係
  - `recommendations.md` - 推奨アクション
  - `details.md` - 分析詳細

### 追加調査ファイル名のルール
- 追加調査が必要な場合、追加調査ごとに新しいセクション別ファイルを作成
- 追加調査には連番プレフィックスを付与: `2_`, `3_`, `4_` など
- 例: `2_core.md`, `2_api.md`, `3_service.md` など（ベースディレクトリ内に配置）

### 完全なファイル名の例
**初回分析**:
- `.dcs/20251008123456_calculate_total/index.md` (インデックス)
- `.dcs/20251008123456_calculate_total/summary.md` (サマリー)
- `.dcs/20251008123456_calculate_total/core.md` (コアロジック層)
- `.dcs/20251008123456_calculate_total/api.md` (API層)
- ... (その他のセクション)

**追加調査1回目**:
- `.dcs/20251008123456_calculate_total/2_core.md` (追加調査のコアロジック層)
- `.dcs/20251008123456_calculate_total/2_api.md` (追加調査のAPI層)
- ... (その他のセクション)

**最終サマリー**:
- `.dcs/20251008123456_calculate_total/final_summary.md` (全体サマリー)

## ファイルパスの記載ルール

- **カレントディレクトリを基準とした相対パスを使用する**
- フルパス（絶対パス）は記載しない
- 例:
  - ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
  - ✅ `src/utils/helper.ts`
- カレントディレクトリは分析開始時の作業ディレクトリ
- すべてのファイルパスは相対パスで統一する

## リスク評価基準

総合的に以下の観点でリスクを評価する：

### 影響の深さ
- 直接参照: 高リスク
- 1階層の間接参照: 中リスク
- 2階層以上の間接参照: 低リスク

### 影響の範囲
- 影響を受けるファイル数が多い: リスク増加
- 影響が限定的: リスク低下

### コードの重要度
- コアロジック、データ処理: 高リスク
- API層、ビジネスロジック: 中リスク
- UI層、表示ロジック: 低リスク
- テストコード: 参考情報

### 変更の種類
- 削除、破壊的変更: 高リスク
- 型変更、インターフェース変更: 中リスク
- 追加、内部実装のみの変更: 低リスク

## ファイル種別の分類基準

以下の基準でファイルを分類する：

- **コアロジック**: ビジネスロジック、データモデル、ユーティリティ
- **API層**: エンドポイント、コントローラー、ルーティング
- **サービス層**: サービスクラス、ビジネスサービス
- **データアクセス層**: リポジトリ、DAO、クエリ
- **UI層**: コンポーネント、ビュー、テンプレート
- **テスト**: テストコード全般
- **設定**: 設定ファイル、環境変数
- **その他**: 上記に該当しないファイル

## 影響の種類

- **直接参照**: import/require による直接的な依存
- **関数呼び出し**: 関数・メソッドの直接呼び出し
- **継承**: クラスの継承関係
- **実装**: インターフェースの実装
- **型依存**: 型定義への依存
- **間接参照**: 中間ファイルを経由した依存

## 追加調査が必要な条件

以下の条件のいずれかに該当する場合、追加調査を提案する：

- リスク評価が「高」のファイルが5件以上ある
- 影響が大きいが詳細が不明なファイルがある
- 複雑な依存関係があるファイルがある（循環参照、多階層依存など）
- 外部APIとの連携部分に影響がある
- データベーススキーマとの関連がある
- 設定ファイルへの影響がある
- パフォーマンスへの影響が懸念される
- 分析結果に不明確な点や曖昧な箇所がある

## 深掘り内容のルール

調査した内容を元に、以下の観点で追加調査が必要な箇所をリストアップする：

- 影響が大きいが詳細が不明なファイル
- 複雑な依存関係があるファイル
- 外部APIとの連携部分
- データベーススキーマとの関連
- 設定ファイルへの影響
- パフォーマンスへの影響

具体的な調査内容を提示し、originRule を参考に深掘りする。

## step3 の繰り返しルール

- 追加調査が必要な項目がある場合、step3 を繰り返す
- 最大5回まで繰り返す（無限ループ防止）
- 追加調査項目が複数ある場合は、各項目ごとに個別に Task を実行する
- 各繰り返しで新しい連番のファイルを作成する
- ユーザーの承認を得てから次の調査を実行する
- 追加調査が不要になったら step4 に進む

# info

<impact_analysis_template>
あなたは影響範囲分析のエキスパートです。以下の情報に基づいて、変更対象の影響範囲を分析し、セクション別に分割してファイル出力してください。

# 分析対象の情報

変更対象: {{変更対象の具体的な情報}}
変更内容: {{変更内容の種類}}
分析目的: {{分析の目的}}
除外条件: {{除外条件（なければ「なし」）}}
ベースディレクトリ: {{ベースディレクトリ}}（例: ".dcs/20251008123456_calculate_total"）
カレントディレクトリ: {{カレントディレクトリ}}

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\... など）は使用しないでください。**
**各セクションファイルは500行以内を目標としてください。**

例:
- ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
- ✅ `src/utils/helper.ts`

# 出力ファイル構成

分析結果は以下のセクション別ファイルに分割して出力してください：

1. **インデックスファイル**: `{{ベースディレクトリ}}/index.md`
   - 全体概要と全セクションファイルへのリンク

2. **サマリーファイル**: `{{ベースディレクトリ}}/summary.md`
   - 分析対象、サマリー、リスク評価

3. **層別影響ファイル**（影響があるもののみ作成）:
   - `{{ベースディレクトリ}}/core.md` - コアロジック層
   - `{{ベースディレクトリ}}/api.md` - API層
   - `{{ベースディレクトリ}}/service.md` - サービス層
   - `{{ベースディレクトリ}}/data.md` - データアクセス層
   - `{{ベースディレクトリ}}/ui.md` - UI層
   - `{{ベースディレクトリ}}/test.md` - テスト
   - `{{ベースディレクトリ}}/config.md` - 設定
   - `{{ベースディレクトリ}}/other.md` - その他

4. **その他のファイル**:
   - `{{ベースディレクトリ}}/external.md` - 外部依存関係
   - `{{ベースディレクトリ}}/recommendations.md` - 推奨アクション
   - `{{ベースディレクトリ}}/details.md` - 分析詳細

# 分析手順

## 1. 変更対象の特定

- 変更対象が自然言語の場合、Grep/Globで具体的なファイル・関数・クラスを特定する
- 変更対象がファイルパスの場合、そのファイルの内容を Read で確認する
- 変更対象が関数/クラス名の場合、Grep で定義箇所を特定する
- 特定結果を記録する（相対パス、行番号、コード要素の種類）

## 2. 直接的な影響の分析

- Grep を使用して、変更対象を直接参照している箇所をすべて検索する
  - import/require 文
  - 関数・メソッド呼び出し
  - 継承・実装関係
  - 型定義の使用
- 各参照について以下を記録する
  - 相対パス:行番号
  - 影響の種類（直接参照、関数呼び出し、継承など）
  - コードのコンテキスト

## 3. 間接的な影響の分析

- 直接影響を受けるファイルそれぞれについて、さらにそれを参照しているファイルを検索する
- 最大3階層まで追跡する（必要に応じて調整）
- 各間接参照について記録する
  - 相対パス:行番号
  - 影響の種類
  - 影響の深さ（何階層目か）
  - 依存経路

## 4. ファイル種別の分類

- 以下の基準で、影響を受ける各ファイルを分類する
  - **コアロジック**: ビジネスロジック、データモデル、ユーティリティ
  - **API層**: エンドポイント、コントローラー、ルーティング
  - **サービス層**: サービスクラス、ビジネスサービス
  - **データアクセス層**: リポジトリ、DAO、クエリ
  - **UI層**: コンポーネント、ビュー、テンプレート
  - **テスト**: テストコード全般
  - **設定**: 設定ファイル、環境変数
  - **その他**: 上記に該当しないファイル
- ファイルパスやディレクトリ構造から推測する
- 必要に応じてファイル内容を Read で確認する

## 5. リスク評価

以下の基準に基づいて、各ファイルの影響度を総合的に評価する：

### 影響の深さ
- 直接参照: 高リスク
- 1階層の間接参照: 中リスク
- 2階層以上の間接参照: 低リスク

### 影響の範囲
- 影響を受けるファイル数が多い: リスク増加
- 影響が限定的: リスク低下

### コードの重要度
- コアロジック、データ処理: 高リスク
- API層、ビジネスロジック: 中リスク
- UI層、表示ロジック: 低リスク
- テストコード: 参考情報

### 変更の種類
- 削除、破壊的変更: 高リスク
- 型変更、インターフェース変更: 中リスク
- 追加、内部実装のみの変更: 低リスク

総合的なリスクレベル（高/中/低）を判定し、リスク評価の根拠を記録する。

## 6. 外部依存関係の確認

- package.json、go.mod、requirements.txt などの依存関係ファイルを確認する
- 変更対象が外部パッケージに影響する可能性を調査する
- 外部依存の参考情報として記録する

## 7. 推奨アクションの生成

- リスク評価に基づいて、優先的に確認すべきファイルをリストアップする
- テスト推奨範囲を提示する
- その他の注意事項を記述する

## 8. セクション別ファイル出力

以下の順序で各セクションファイルを作成してください。**各ファイルは Write ツールを使って個別に保存してください。**

### 8.1 インデックスファイルの作成

最初に `{{ベースディレクトリ}}/index.md` を作成してください。

### 8.2 サマリーファイルの作成

次に `{{ベースディレクトリ}}/summary.md` を作成してください。

### 8.3 層別影響ファイルの作成

影響があるファイル種別について、それぞれ個別ファイルを作成してください：
- `{{ベースディレクトリ}}/core.md` - コアロジック層（影響がある場合のみ）
- `{{ベースディレクトリ}}/api.md` - API層（影響がある場合のみ）
- `{{ベースディレクトリ}}/service.md` - サービス層（影響がある場合のみ）
- `{{ベースディレクトリ}}/data.md` - データアクセス層（影響がある場合のみ）
- `{{ベースディレクトリ}}/ui.md` - UI層（影響がある場合のみ）
- `{{ベースディレクトリ}}/test.md` - テスト（影響がある場合のみ）
- `{{ベースディレクトリ}}/config.md` - 設定（影響がある場合のみ）
- `{{ベースディレクトリ}}/other.md` - その他（影響がある場合のみ）

### 8.4 その他のファイルの作成

以下のファイルを作成してください：
- `{{ベースディレクトリ}}/external.md` - 外部依存関係
- `{{ベースディレクトリ}}/recommendations.md` - 推奨アクション
- `{{ベースディレクトリ}}/details.md` - 分析詳細

# 各セクションファイルの出力形式

## インデックスファイル (`index.md`)

```markdown
# 影響範囲分析 - インデックス

**実施日時**: {{実施日時}}
**分析者**: Claude Code

---

## 分析概要

### 変更対象
- **対象**: {{変更対象の詳細}}
- **変更内容**: {{変更内容の種類}}
- **分析目的**: {{分析の目的}}

### サマリー

| 項目 | 内容 |
|------|------|
| 影響を受けるファイル数 | XX件 |
| 総合リスク評価 | **高/中/低** |
| 最大影響深度 | X階層 |

---

## 分析結果ファイル一覧

### 基本情報
- [サマリー](./summary.md) - 分析対象とリスク評価

### 影響を受けるファイル（層別）
- [コアロジック層](./core.md) - XX件の影響
- [API層](./api.md) - XX件の影響
- [サービス層](./service.md) - XX件の影響
- [データアクセス層](./data.md) - XX件の影響
- [UI層](./ui.md) - XX件の影響
- [テスト](./test.md) - XX件の影響
- [設定](./config.md) - XX件の影響
- [その他](./other.md) - XX件の影響

### その他の情報
- [外部依存関係](./external.md)
- [推奨アクション](./recommendations.md)
- [分析詳細](./details.md)

---

## クイックナビゲーション

### 高リスク項目
1. {{高リスク項目1}} - [詳細](./{{section}}.md)
2. {{高リスク項目2}} - [詳細](./{{section}}.md)

### 即座に対応が必要な項目
1. {{対応項目1}} - [詳細](./recommendations.md)
2. {{対応項目2}} - [詳細](./recommendations.md)

---

*各ファイルの詳細は上記リンクから参照してください。*
```

## サマリーファイル (`summary.md`)

```markdown
# 影響範囲分析 - サマリー

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md)

---

## 分析対象

### 変更対象
- **対象**: {{変更対象の詳細（相対パス:行番号、関数名など）}}
- **変更内容**: {{変更内容の種類}}
- **分析目的**: {{分析の目的}}
- **除外条件**: {{除外条件}}

---

## サマリー

| 項目 | 内容 |
|------|------|
| 影響を受けるファイル数 | XX件 |
| 総合リスク評価 | **高/中/低** |
| 最大影響深度 | X階層 |
| 推奨対応優先度 | 高/中/低 |

### リスク評価の根拠
{{総合的なリスク評価の理由を簡潔に記述}}

---

## ファイル種別ごとの影響統計

| ファイル種別 | 影響ファイル数 | リスクレベル | 詳細 |
|-------------|--------------|------------|------|
| コアロジック | XX件 | 高/中/低 | [詳細](./core.md) |
| API層 | XX件 | 高/中/低 | [詳細](./api.md) |
| サービス層 | XX件 | 高/中/低 | [詳細](./service.md) |
| データアクセス層 | XX件 | 高/中/低 | [詳細](./data.md) |
| UI層 | XX件 | 高/中/低 | [詳細](./ui.md) |
| テスト | XX件 | 低 | [詳細](./test.md) |
| 設定 | XX件 | 高/中/低 | [詳細](./config.md) |
| その他 | XX件 | 高/中/低 | [詳細](./other.md) |

---

## 追加調査が必要な項目

以下の項目について、追加調査が推奨されます：

1. {{追加調査項目1}}
2. {{追加調査項目2}}
3. {{追加調査項目3}}

（追加調査が不要な場合は「なし」と記載）

---

*詳細な影響内容は各層別ファイルを参照してください。*
```

## 層別影響ファイル (`core.md`, `api.md`, `service.md`, `data.md`, `ui.md`, `test.md`, `config.md`, `other.md`)

各層のファイルは以下の形式で記述してください：

```markdown
# 影響範囲分析 - {{層名}}層

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md) | [サマリー](./summary.md)

---

## {{層名}}層の影響概要

| 項目 | 内容 |
|------|------|
| 影響ファイル数 | XX件 |
| リスクレベル | **高/中/低** |
| 直接影響 | XX件 |
| 間接影響 | XX件 |

---

## 直接的な影響

### [相対パス:行番号](相対パス#L行番号)

- **影響の種類**: 直接参照/関数呼び出し/継承/実装/型依存
- **影響度**: 高/中/低
- **理由**: {{なぜこの影響度なのか、どのような修正が必要か}}
- **コードコンテキスト**: {{関連するコードの説明}}
- **推奨対応**: {{対応方法}}

### [相対パス:行番号](相対パス#L行番号)

（同様の形式で記述）

---

## 間接的な影響（2階層）

### [相対パス:行番号](相対パス#L行番号)

- **影響の種類**: 間接参照
- **依存経路**: 変更対象 → 中間ファイルA → このファイル
- **影響度**: 中/低
- **理由**: {{影響の説明}}
- **推奨対応**: {{対応方法}}

---

## 間接的な影響（3階層以上）

### [相対パス:行番号](相対パス#L行番号)

（同様の形式で記述）

---

*このファイルには{{層名}}層に関する影響のみを記載しています。他の層の影響は対応するファイルを参照してください。*
```

## 外部依存関係ファイル (`external.md`)

```markdown
# 影響範囲分析 - 外部依存関係

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md)

---

## 影響を受ける可能性のある外部パッケージ

### パッケージ名@バージョン

- **使用箇所**: {{どこで使用されているか（相対パス）}}
- **影響の可能性**: {{どのような影響が考えられるか}}
- **リスクレベル**: 高/中/低
- **推奨対応**: {{必要な対応があれば}}

---

## パッケージ依存関係の注意事項

- {{注意事項1}}
- {{注意事項2}}

---

*外部パッケージへの影響は間接的である可能性があります。実際の影響は詳細な検証が必要です。*
```

## 推奨アクションファイル (`recommendations.md`)

```markdown
# 影響範囲分析 - 推奨アクション

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md)

---

## 優先度: 高（即座に対応が必要）

### 1. [相対パス:行番号](相対パス#L行番号)

- **理由**: {{なぜ即座に対応が必要か}}
- **影響範囲**: {{影響範囲}}
- **推奨対応**: {{具体的な対応方法}}
- **所要時間**: {{概算}}

### 2. [相対パス:行番号](相対パス#L行番号)

（同様の形式で記述）

---

## 優先度: 中（レビューと検証が必要）

### 1. [相対パス:行番号](相対パス#L行番号)

- **理由**: {{なぜレビューが必要か}}
- **影響範囲**: {{影響範囲}}
- **推奨対応**: {{具体的な対応方法}}

---

## 優先度: 低（念のため確認推奨）

### 1. [相対パス:行番号](相対パス#L行番号)

- **理由**: {{確認が推奨される理由}}

---

## テスト推奨範囲

### ユニットテスト
- {{テストすべき関数・クラス1}}
- {{テストすべき関数・クラス2}}

### 統合テスト
- {{テストすべきモジュール間連携1}}
- {{テストすべきモジュール間連携2}}

### E2Eテスト
- {{テストすべきユーザーシナリオ1}}
- {{テストすべきユーザーシナリオ2}}

---

## その他の注意事項

- {{注意すべき点1}}
- {{注意すべき点2}}
- {{注意すべき点3}}

---

*推奨アクションは分析結果に基づいて生成されています。実際の対応は状況に応じて調整してください。*
```

## 分析詳細ファイル (`details.md`)

```markdown
# 影響範囲分析 - 分析詳細

**実施日時**: {{実施日時}}
**分析者**: Claude Code

[← インデックスに戻る](./index.md)

---

## 検索キーワード

### 使用した検索パターン
- `{{パターン1}}`
- `{{パターン2}}`
- `{{パターン3}}`

---

## 分析範囲

### 対象ディレクトリ
- {{分析したディレクトリ（相対パス）}}

### 除外条件
- {{除外条件1}}
- {{除外条件2}}

### 分析深度
- 最大追跡階層: {{何階層まで追跡したか}}
- 分析したファイル総数: {{総数}}

---

## 分析手法

### 使用したツール
- {{使用したツール1}}
- {{使用したツール2}}

### 分析アプローチ
{{分析アプローチの説明}}

---

## 制限事項

- {{分析の制限や注意点1}}
- {{分析の制限や注意点2}}
- {{分析の制限や注意点3}}

---

## 追加情報

### 検出できなかった可能性のある影響
- 動的な呼び出し（リフレクション、eval など）
- 文字列による間接的な参照
- ランタイムでの動的ロード

---

*この分析結果は自動生成されたものです。実際の影響範囲は、コードレビューやテストを通じて確認してください。*
```

# 分析の注意点

- 動的な呼び出し（リフレクション、eval など）は検出できない可能性がある
- 文字列による間接的な参照は検出が困難
- コメントアウトされたコードは除外する
- テストコードは参考情報として含めるが、リスク評価は低めに設定する
- 循環参照がある場合は無限ループに注意し、訪問済みファイルを記録する
- すべての影響を受けるファイルを修正対象として提示する
- **すべてのファイルパスは相対パスで記載する（絶対パスは使用しない）**
- **各セクションファイルは500行以内を目標とする。500行を超える場合は、さらに細かく分割する**

# 出力手順

**重要**: 必ず以下の順序でファイルを作成してください：

1. **インデックスファイルを最初に作成** (`{{ベースディレクトリ}}/index.md`)
   - Write ツールで保存
   - 全セクションファイルへのリンクを含める

2. **サマリーファイルを作成** (`{{ベースディレクトリ}}/summary.md`)
   - Write ツールで保存

3. **影響がある層別ファイルを作成**（影響があるものだけ）
   - 各ファイルを個別に Write ツールで保存
   - 例: `{{ベースディレクトリ}}/core.md`, `{{ベースディレクトリ}}/api.md`, ...

4. **その他のファイルを作成**
   - `{{ベースディレクトリ}}/external.md`
   - `{{ベースディレクトリ}}/recommendations.md`
   - `{{ベースディレクトリ}}/details.md`
   - 各ファイルを個別に Write ツールで保存

**各ファイルは Write ツールを使って個別に保存してください。一つのファイルにまとめないでください。**
</impact_analysis_template>

<summary_template>
あなたは影響範囲分析のサマリー作成エキスパートです。以下の情報に基づいて、全体サマリーを作成してください。

# サマリー作成対象の情報

変更対象: {{変更対象の具体的な情報}}
分析ファイルリスト: {{分析ファイルリスト}}（インデックスファイル、サマリーファイル、層別ファイルなど）
最終サマリーファイル名: {{サマリーファイル名}}（例: ".dcs/20251008123456_calculate_total/final_summary.md"）
カレントディレクトリ: {{カレントディレクトリ}}

# 重要な注意事項

**すべてのファイルパスは、カレントディレクトリを基準とした相対パスで記載してください。**
**絶対パス（/Users/... や C:\... など）は使用しないでください。**
**このファイルは500行以内に収まるように簡潔に記述してください。**

例:
- ❌ `/Users/makotan/projects/esample/src/utils/helper.ts`
- ✅ `src/utils/helper.ts`

# サマリー作成手順

## 1. 全分析ファイルの読み込み

- {{分析ファイルリスト}} に含まれるすべてのファイルを Read で読み込む
- 各ファイルの内容を把握する

## 2. 情報の統合

- すべての分析結果から以下の情報を統合する
  - 影響を受けるファイルの総数
  - 総合リスク評価（最も高いリスクレベル）
  - 最大影響深度
  - ファイル種別ごとの影響数
  - 優先度別の推奨アクション数

## 3. ハイライトの抽出

- 最も重要な発見をハイライトする
- 特に注意が必要な箇所を強調する
- 追加調査で判明した重要事項を記載する

## 4. 統合推奨アクションの作成

- 全分析結果から優先度の高いアクションを抽出する
- 重複を排除し、優先順位を付ける
- 全体的な対応方針を提示する

## 5. サマリーファイルの出力

以下の出力形式で {{サマリーファイル名}} に結果を保存してください。

# 出力形式

```markdown
# 影響範囲分析 - 最終サマリー

**実施日時**: {{実施日時}}
**分析者**: Claude Code

---

## ナビゲーション

- [初回分析インデックス](./index.md)
- [初回分析サマリー](./summary.md)

（追加調査がある場合は追加）
- [追加調査2（コアロジック層）](./2_core.md)
- [追加調査3（API層）](./3_api.md)

---

## 分析概要

### 変更対象
- **対象**: {{変更対象の詳細}}
- **変更内容**: {{変更内容の種類}}
- **分析目的**: {{分析の目的}}

### 分析実施状況
- **実施した分析回数**: {{分析回数}}回（初回 + 追加調査{{N}}回）
- **作成されたファイル数**: {{ファイル数}}件

---

## 総合サマリー

| 項目 | 内容 |
|------|------|
| 影響を受けるファイル総数 | XX件 |
| 総合リスク評価 | **高/中/低** |
| 最大影響深度 | X階層 |
| 推奨対応優先度 | 高/中/低 |

### 総合リスク評価の根拠
{{全体を通じたリスク評価の理由を記述}}

---

## 主要な発見事項

### 重要なハイライト

1. **{{ハイライト1のタイトル}}**
   - {{詳細説明}}
   - 影響: {{影響の概要}}
   - リスク: 高/中/低

2. **{{ハイライト2のタイトル}}**
   - {{詳細説明}}
   - 影響: {{影響の概要}}
   - リスク: 高/中/低

3. **{{ハイライト3のタイトル}}**
   - {{詳細説明}}
   - 影響: {{影響の概要}}
   - リスク: 高/中/低

---

## ファイル種別ごとの影響統計

| ファイル種別 | 影響ファイル数 | リスクレベル | 備考 |
|-------------|--------------|------------|------|
| コアロジック | XX件 | 高/中/低 | {{備考}} |
| API層 | XX件 | 高/中/低 | {{備考}} |
| サービス層 | XX件 | 高/中/低 | {{備考}} |
| データアクセス層 | XX件 | 高/中/低 | {{備考}} |
| UI層 | XX件 | 高/中/低 | {{備考}} |
| テスト | XX件 | 低 | {{備考}} |
| 設定 | XX件 | 高/中/低 | {{備考}} |
| その他 | XX件 | 高/中/低 | {{備考}} |

---

## 統合推奨アクション

### 優先度: 高（即座に対応が必要）

1. [相対パス:行番号](相対パス#L行番号) - {{理由}}
2. [相対パス:行番号](相対パス#L行番号) - {{理由}}
3. [相対パス:行番号](相対パス#L行番号) - {{理由}}

### 優先度: 中（レビューと検証が必要）

1. [相対パス:行番号](相対パス#L行番号) - {{理由}}
2. [相対パス:行番号](相対パス#L行番号) - {{理由}}
3. [相対パス:行番号](相対パス#L行番号) - {{理由}}

### 優先度: 低（念のため確認推奨）

1. [相対パス:行番号](相対パス#L行番号) - {{理由}}
2. [相対パス:行番号](相対パス#L行番号) - {{理由}}

---

## 全体的な対応方針

### 推奨アプローチ

1. **{{アプローチ1}}**
   - {{詳細説明}}

2. **{{アプローチ2}}**
   - {{詳細説明}}

3. **{{アプローチ3}}**
   - {{詳細説明}}

### テスト戦略

- **ユニットテスト**: {{テスト対象と範囲}}
- **統合テスト**: {{テスト対象と範囲}}
- **E2Eテスト**: {{テスト対象と範囲}}
- **リグレッションテスト**: {{特に注意すべき領域}}

### リスク軽減策

1. {{リスク軽減策1}}
2. {{リスク軽減策2}}
3. {{リスク軽減策3}}

---

## 外部依存関係の統合情報

### 影響を受ける外部パッケージ

- **パッケージ名**: パッケージ名@バージョン
  - **影響の可能性**: {{統合された影響情報}}
  - **推奨対応**: {{推奨される対応}}

---

## 追加で考慮すべき事項

1. **{{考慮事項1}}**
   - {{詳細}}

2. **{{考慮事項2}}**
   - {{詳細}}

3. **{{考慮事項3}}**
   - {{詳細}}

---

## 詳細分析ファイル一覧

以下のファイルに詳細な分析結果が記録されています：

1. [{{ファイル名1}}]({{相対パス1}}) - 初回分析
2. [{{ファイル名2}}]({{相対パス2}}) - 追加調査1
3. [{{ファイル名3}}]({{相対パス3}}) - 追加調査2
...

---

## 分析の制限事項と注意点

- {{制限事項1}}
- {{制限事項2}}
- {{制限事項3}}

---

*このサマリーは複数の分析結果を統合して自動生成されたものです。詳細は個別の分析ファイルを参照してください。*
```

# サマリー作成の注意点

- すべての分析ファイルの内容を網羅的に把握する
- 重複する情報を排除し、簡潔にまとめる
- 最も重要な情報を優先的に記載する
- 全体の傾向やパターンを識別する
- **すべてのファイルパスは相対パスで記載する（絶対パスは使用しない）**

必ず Write ツールを使用して、{{サマリーファイル名}} に結果を保存してください。
</summary_template>
