/**
 * rank-service.interface.ts - RankServiceインターフェース
 *
 * TASK-0014: ContributionCalculator・RankService実装
 *
 * @description
 * ランクシステムのインターフェース定義。
 * ランク管理、昇格判定、昇格試験などの機能を提供する。
 *
 * @信頼性レベル 🔵
 * - 設計文書・要件定義書に基づいた定義
 * - ランクゲージシステム
 * - 昇格試験システム
 */

import type { GuildRank } from '@shared/types';
import type { IGuildRankMaster } from '@shared/types/master-data';

// =============================================================================
// 昇格結果
// =============================================================================

/**
 * 【機能概要】: 昇格結果
 * 【実装方針】: 昇格前後のランクとボーナス報酬を格納
 * 🔵 信頼性レベル: 設計文書に明記
 */
export interface PromotionResult {
  /** 昇格前のランク */
  previousRank: GuildRank;
  /** 昇格後のランク */
  newRank: GuildRank;
  /** ボーナス報酬（ゴールド） */
  bonusReward: number;
}

// =============================================================================
// 昇格試験
// =============================================================================

/**
 * 【機能概要】: 昇格試験要件
 * 【実装方針】: 必要アイテムと数量、最低品質を定義
 * 🔵 信頼性レベル: 設計文書に明記
 */
export interface PromotionTestRequirement {
  /** 必要アイテムID */
  itemId: string;
  /** 必要数量 */
  quantity: number;
  /** 最低品質（オプション） */
  minQuality?: string;
}

/**
 * 【機能概要】: 昇格試験情報
 * 【実装方針】: 現在進行中の昇格試験の情報
 * 🔵 信頼性レベル: 設計文書に明記
 */
export interface PromotionTest {
  /** 目標ランク */
  targetRank: GuildRank;
  /** 試験要件リスト */
  requirements: PromotionTestRequirement[];
  /** 残り日数 */
  remainingDays: number;
  /** 完了した要件 */
  completedRequirements: number[];
}

// =============================================================================
// RankServiceインターフェース
// =============================================================================

/**
 * 【機能概要】: RankServiceインターフェース
 * 【実装方針】: ランク操作、昇格判定、昇格試験を提供
 * 🔵 信頼性レベル: 設計文書・要件定義書に明記
 */
export interface IRankService {
  // ===========================================================================
  // ランク操作
  // ===========================================================================

  /**
   * 【機能概要】: 現在のランクを取得
   * 【実装方針】: プレイヤーの現在ランクを返す
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 現在のギルドランク
   */
  getCurrentRank(): GuildRank;

  /**
   * 【機能概要】: 昇格ゲージを取得
   * 【実装方針】: 0〜100の昇格ゲージ値を返す
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格ゲージ（0〜100）
   */
  getPromotionGauge(): number;

  /**
   * 【機能概要】: 累積貢献度を取得
   * 【実装方針】: 現在ランクでの累積貢献度を返す
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 累積貢献度
   */
  getAccumulatedContribution(): number;

  /**
   * 【機能概要】: 貢献度を加算
   * 【実装方針】: 貢献度を累積し、ゲージを更新
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @param amount - 加算する貢献度
   */
  addContribution(amount: number): void;

  /**
   * 【機能概要】: ランクを設定
   * 【実装方針】: ランクを直接設定（ゲームデータ復元用）
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @param rank - 設定するランク
   */
  setRank(rank: GuildRank): void;

  // ===========================================================================
  // 昇格判定
  // ===========================================================================

  /**
   * 【機能概要】: 昇格可能かどうかを判定
   * 【実装方針】: ゲージが100以上で昇格可能
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格可能な場合true
   */
  canPromote(): boolean;

  /**
   * 【機能概要】: 昇格を実行
   * 【実装方針】: ランクアップ、ゲージリセット、ボーナス付与
   * 【エラー】: 昇格不可能な場合
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格結果
   */
  promote(): PromotionResult;

  // ===========================================================================
  // 昇格試験
  // ===========================================================================

  /**
   * 【機能概要】: 昇格試験中かどうかを判定
   * 【実装方針】: 昇格試験が進行中の場合true
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格試験中の場合true
   */
  isInPromotionTest(): boolean;

  /**
   * 【機能概要】: 昇格試験を開始
   * 【実装方針】: ランク要件に基づいた試験を開始
   * 【エラー】: 既に試験中、または昇格不可能な場合
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格試験情報
   */
  startPromotionTest(): PromotionTest;

  /**
   * 【機能概要】: 現在の昇格試験を取得
   * 【実装方針】: 進行中の昇格試験情報を返す
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 昇格試験情報（試験中でない場合はnull）
   */
  getCurrentPromotionTest(): PromotionTest | null;

  /**
   * 【機能概要】: 昇格試験の要件を満たしたことを報告
   * 【実装方針】: 要件インデックスを完了マーク
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @param requirementIndex - 満たした要件のインデックス
   */
  completePromotionTestRequirement(requirementIndex: number): void;

  /**
   * 【機能概要】: 昇格試験を完了
   * 【実装方針】: 成功時は昇格、失敗時はゲージ減少
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @param success - 試験成功の場合true
   * @returns 成功時は昇格結果、失敗時はnull
   */
  completePromotionTest(success: boolean): PromotionResult | null;

  /**
   * 【機能概要】: 昇格試験の残り日数を減らす
   * 【実装方針】: 日終了処理で呼び出し
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 期限切れで失敗した場合true
   */
  decrementPromotionTestDays(): boolean;

  // ===========================================================================
  // ランク情報取得
  // ===========================================================================

  /**
   * 【機能概要】: ランク要件を取得
   * 【実装方針】: マスターデータからランク情報を取得
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @param rank - 取得するランク
   * @returns ランクマスター情報（存在しない場合はnull）
   */
  getRankRequirements(rank: GuildRank): IGuildRankMaster | null;

  /**
   * 【機能概要】: 次のランクを取得
   * 【実装方針】: G→F→E→D→C→B→A→S、Sの次はnull
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 次のランク（最高ランクの場合はnull）
   */
  getNextRank(): GuildRank | null;

  /**
   * 【機能概要】: 昇格に必要な残り貢献度を取得
   * 【実装方針】: 必要貢献度 - 累積貢献度
   * 🔵 信頼性レベル: 設計文書に明記
   *
   * @returns 残り必要貢献度（昇格可能な場合は0）
   */
  getRemainingContribution(): number;
}
