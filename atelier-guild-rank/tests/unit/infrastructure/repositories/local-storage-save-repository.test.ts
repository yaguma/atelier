/**
 * LocalStorageSaveRepository ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
 * TASK-0007 ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…
 *
 * @description
 * T-0007-01 ã€œ T-0007-12 ã‚’å®Ÿè£…
 */

import type { ISaveDataRepository } from '@domain/interfaces';
import { LocalStorageSaveRepository } from '@shared/services/repositories';
import type { ISaveData } from '@shared/types';
import { ApplicationError, GamePhase, GuildRank, toCardId } from '@shared/types';
import { beforeEach, describe, expect, it, vi } from 'vitest';

// =============================================================================
// ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
// =============================================================================

/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®æ¨™æº–ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
 * æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œã®å…¸å‹çš„ãªçŠ¶æ…‹ã‚’è¡¨ç¾
 */
const createTestSaveData = (): ISaveData => ({
  version: '1.0.0',
  lastSaved: '2026-01-16T12:00:00.000Z',
  gameState: {
    currentRank: GuildRank.G,
    rankHp: 50,
    remainingDays: 25,
    currentDay: 5,
    currentPhase: GamePhase.QUEST_ACCEPT,
    gold: 1000,
    comboCount: 0,
    actionPoints: 3,
    isPromotionTest: false,
  },
  deckState: {
    deck: [toCardId('gathering_backyard'), toCardId('recipe_healing_potion')],
    hand: [toCardId('enhance_sage_catalyst')],
    discard: [],
    ownedCards: [
      toCardId('gathering_backyard'),
      toCardId('recipe_healing_potion'),
      toCardId('enhance_sage_catalyst'),
    ],
  },
  inventoryState: {
    materials: [],
    craftedItems: [],
    storageLimit: 30,
  },
  questState: {
    activeQuests: [],
    todayClients: [],
    todayQuests: [],
    questLimit: 3,
  },
  artifacts: [],
});

// =============================================================================
// ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
// =============================================================================

describe('LocalStorageSaveRepository', () => {
  let repository: ISaveDataRepository;
  let storage: Storage;

  beforeEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å®Ÿéš›ã«å‹•ä½œã™ã‚‹localStorageã‚’ç”¨æ„ã™ã‚‹
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: vi.fn()ã®ãƒ¢ãƒƒã‚¯ã§ã¯ãªãã€å®Ÿéš›ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Ÿè£…ã‚’ä½¿ç”¨
    const storageMap = new Map<string, string>();
    storage = {
      getItem: vi.fn((key: string) => storageMap.get(key) ?? null),
      setItem: vi.fn((key: string, value: string) => {
        storageMap.set(key, value);
      }),
      removeItem: vi.fn((key: string) => {
        storageMap.delete(key);
      }),
      clear: vi.fn(() => {
        storageMap.clear();
      }),
      length: 0,
      key: vi.fn(() => null),
    };
    vi.stubGlobal('localStorage', storage);

    // ã€ãƒªãƒã‚¸ãƒˆãƒªåˆæœŸåŒ–ã€‘: æ–°ã—ã„LocalStorageSaveRepositoryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    repository = new LocalStorageSaveRepository();
  });

  // =============================================================================
  // æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
  // =============================================================================

  describe('T-0007-01: ã‚»ãƒ¼ãƒ–â†’ãƒ­ãƒ¼ãƒ‰ã§åŒä¸€ãƒ‡ãƒ¼ã‚¿å–å¾—', () => {
    it('ã‚»ãƒ¼ãƒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨å®Œå…¨ã«åŒä¸€ã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿ãŒæ­£ã—ãå‹•ä½œã—ã€å®Œå…¨ã«åŒä¸€ã®ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: save()ã§ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€load()ã§èª­ã¿è¾¼ã‚“ã§å†…å®¹ãŒä¸€è‡´ã™ã‚‹ã‹æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ï¼ˆgameState, deckStateç­‰ï¼‰ãŒå…ƒã®ãƒ‡ãƒ¼ã‚¿ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹
      // ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ï¼ˆTASK-0007 Section 4.1 T-0007-01ï¼‰ã«æ˜è¨˜ã•ã‚ŒãŸå¿…é ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œã®å…¸å‹çš„ãªã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ï¼ˆãƒ©ãƒ³ã‚¯Gã€5æ—¥ç›®ã€æ‰‹æœ­3æšï¼‰
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: localStorageã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      const testSaveData = createTestSaveData();

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: LocalStorageSaveRepository.save()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      // ã€å‡¦ç†å†…å®¹ã€‘: å†…éƒ¨ã§JSON.stringify()ã«ã‚ˆã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã¨localStorage.setItem()ãŒå®Ÿè¡Œã•ã‚Œã‚‹
      await repository.save(testSaveData);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: LocalStorageSaveRepository.load()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      // ã€å‡¦ç†å†…å®¹ã€‘: å†…éƒ¨ã§localStorage.getItem()ã¨JSON.parse()ã«ã‚ˆã‚‹ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŒå®Ÿè¡Œã•ã‚Œã‚‹
      const loadedData = await repository.load();

      // ã€çµæœæ¤œè¨¼ã€‘: load()ã®è¿”ã‚Šå€¤ãŒå…ƒã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹ã‹ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ï¼ˆgameState, deckStateç­‰ï¼‰ãŒå…ƒã®ãƒ‡ãƒ¼ã‚¿ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹
      // ã€å“è³ªä¿è¨¼ã€‘: JSON serialization/deserializationãŒæ­£ã—ãå‹•ä½œã—ã€ãƒ‡ãƒ¼ã‚¿ç ´æãŒãªã„ã“ã¨ã‚’ä¿è¨¼
      expect(loadedData).toEqual(testSaveData); // ã€æ¤œè¨¼é …ç›®ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã®æ§‹é€ ãŒå®Œå…¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒã‚¹ãƒˆã—ãŸgameStateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ç¢ºã«å¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(loadedData?.gameState.currentRank).toBe(GuildRank.G); // ã€æ¤œè¨¼é …ç›®ã€‘: ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å¾©å…ƒã¯æœ€é‡è¦æ©Ÿèƒ½ ğŸ”µ
      expect(loadedData?.gameState.currentDay).toBe(5); // ã€æ¤œè¨¼é …ç›®ã€‘: æ—¥æ•°ãŒæ­£ç¢ºã«å¾©å…ƒã•ã‚Œã‚‹ ğŸ”µ

      // ã€çµæœæ¤œè¨¼ã€‘: é…åˆ—ï¼ˆdeck, handï¼‰ã®é †åºãŒä¿æŒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(loadedData?.deckState.deck).toEqual([
        toCardId('gathering_backyard'),
        toCardId('recipe_healing_potion'),
      ]); // ã€æ¤œè¨¼é …ç›®ã€‘: ãƒ‡ãƒƒã‚­ã®é †åºå¤‰æ›´ã¯ã‚²ãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ã«å½±éŸ¿ ğŸ”µ
    });
  });

  describe('T-0007-02: å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨æ™‚ï¼‰ã§trueè¿”å´', () => {
    it('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€exists()ãŒtrueã‚’è¿”ã™', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€exists()ãŒtrueã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: save()å®Ÿè¡Œå¾Œã«exists()ã‚’å‘¼ã³ã€trueãŒè¿”ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: localStorageã«ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚ŒãŸã“ã¨ãŒç¢ºèªã§ãã‚‹
      // ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ï¼ˆTASK-0007 Section 4.1 T-0007-02ï¼‰ã«æ˜è¨˜ã•ã‚ŒãŸå¿…é ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®æº–å‚™
      const testSaveData = createTestSaveData();

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      await repository.save(testSaveData);

      // ã€çµæœæ¤œè¨¼ã€‘: exists()ãŒtrueã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: localStorage.getItem(STORAGE_KEY) !== null ãŒ true ã«ãªã‚‹
      expect(repository.exists()).toBe(true); // ã€æ¤œè¨¼é …ç›®ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª ğŸ”µ
    });
  });

  describe('T-0007-03: å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå­˜åœ¨æ™‚ï¼‰ã§falseè¿”å´', () => {
    it('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€exists()ãŒfalseã‚’è¿”ã™', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€exists()ãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: save()ã‚’å®Ÿè¡Œã—ã¦ã„ãªã„çŠ¶æ…‹ã§exists()ã‚’å‘¼ã³ã€falseãŒè¿”ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆå›èµ·å‹•æ™‚ã®æ­£ã—ã„å‹•ä½œã‚’ä¿è¨¼
      // ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ï¼ˆTASK-0007 Section 4.1 T-0007-03ï¼‰ã«æ˜è¨˜ã•ã‚ŒãŸå¿…é ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: localStorageãŒç©ºã®çŠ¶æ…‹ï¼ˆbeforeEachã§ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰

      // ã€çµæœæ¤œè¨¼ã€‘: exists()ãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: localStorage.getItem(STORAGE_KEY) === null ãŒ true ã«ãªã‚‹
      expect(repository.exists()).toBe(false); // ã€æ¤œè¨¼é …ç›®ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã®ç¢ºèª ğŸ”µ
    });
  });

  describe('T-0007-04: å‰Šé™¤å¾Œã«exists()ãŒfalseã‚’è¿”ã™', () => {
    it('delete()å®Ÿè¡Œå¾Œã«ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: delete()å®Ÿè¡Œå¾Œã«ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: save()â†’delete()ã®é †ã§å®Ÿè¡Œã—ã€exists()ã¨load()ã§å‰Šé™¤ã‚’ç¢ºèª
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒç‰©ç†çš„ã«å‰Šé™¤ã•ã‚Œã‚‹
      // ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ï¼ˆTASK-0007 Section 4.1 T-0007-04ï¼‰ã«æ˜è¨˜ã•ã‚ŒãŸå¿…é ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      const testSaveData = createTestSaveData();
      await repository.save(testSaveData);

      // ã€å‰ææ¡ä»¶ç¢ºèªã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(repository.exists()).toBe(true); // ã€æ¤œè¨¼é …ç›®ã€‘: å‰Šé™¤å‰ã®çŠ¶æ…‹ç¢ºèª ğŸ”µ

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      // ã€å‡¦ç†å†…å®¹ã€‘: localStorage.removeItem()ãŒå®Ÿè¡Œã•ã‚Œã‚‹
      await repository.delete();

      // ã€çµæœæ¤œè¨¼ã€‘: exists()ãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: localStorage.getItem(STORAGE_KEY) === null ã«ãªã‚‹
      expect(repository.exists()).toBe(false); // ã€æ¤œè¨¼é …ç›®ã€‘: å‰Šé™¤å¾Œã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ ğŸ”µ

      // ã€çµæœæ¤œè¨¼ã€‘: load()ãŒnullã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚nullãŒè¿”ã‚‹
      const loadedData = await repository.load();
      expect(loadedData).toBeNull(); // ã€æ¤œè¨¼é …ç›®ã€‘: å‰Šé™¤å¾Œã®ãƒ­ãƒ¼ãƒ‰çµæœ ğŸ”µ
    });
  });

  describe('T-0007-06: æœ€çµ‚ä¿å­˜æ—¥æ™‚ã®å–å¾—', () => {
    it('getLastSavedTime()ãŒæ­£ã—ã„æ—¥æ™‚ã‚’è¿”ã™', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: getLastSavedTime()ãŒæ­£ã—ã„æ—¥æ™‚ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®lastSavedãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒDateå‹ã¨ã—ã¦å–å¾—ã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ISO8601å½¢å¼ã®æ—¥æ™‚æ–‡å­—åˆ—ãŒDateå‹ã«å¤‰æ›ã•ã‚Œã‚‹
      // ğŸ”µ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã«æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ISO8601å½¢å¼ã®æ—¥æ™‚æ–‡å­—åˆ—ã‚’å«ã‚€ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
      const testSaveData = createTestSaveData();
      await repository.save(testSaveData);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœ€çµ‚ä¿å­˜æ—¥æ™‚ã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: new Date(parsed.lastSaved)ã§ISOæ–‡å­—åˆ—ãŒDateå‹ã«å¤‰æ›ã•ã‚Œã‚‹
      const lastSavedTime = repository.getLastSavedTime();

      // ã€çµæœæ¤œè¨¼ã€‘: Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(lastSavedTime).toBeInstanceOf(Date); // ã€æ¤œè¨¼é …ç›®ã€‘: Dateå‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ

      // ã€çµæœæ¤œè¨¼ã€‘: ISOæ–‡å­—åˆ—ãŒæ­£ã—ãDateå‹ã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹
      expect(lastSavedTime?.toISOString()).toBe('2026-01-16T12:00:00.000Z'); // ã€æ¤œè¨¼é …ç›®ã€‘: æ—¥æ™‚ã®æ­£ç¢ºæ€§ ğŸ”µ
    });
  });

  describe('T-0007-07: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿æœªå­˜åœ¨æ™‚ã®getLastSavedTime()', () => {
    it('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€getLastSavedTime()ãŒnullã‚’è¿”ã™', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€getLastSavedTime()ãŒnullã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆå›èµ·å‹•æ™‚ã‚„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å¾Œã«nullãŒè¿”ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: localStorage.getItem(STORAGE_KEY)ãŒnullã‚’è¿”ã™ãŸã‚
      // ğŸ”µ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã§Date | nullå‹ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹

      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: localStorageãŒç©ºã®çŠ¶æ…‹ï¼ˆbeforeEachã§ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœ€çµ‚ä¿å­˜æ—¥æ™‚ã‚’å–å¾—
      const lastSavedTime = repository.getLastSavedTime();

      // ã€çµæœæ¤œè¨¼ã€‘: nullãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(lastSavedTime).toBeNull(); // ã€æ¤œè¨¼é …ç›®ã€‘: nullãƒã‚§ãƒƒã‚¯ã®æ­£ç¢ºæ€§ ğŸ”µ
    });
  });

  // =============================================================================
  // ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
  // =============================================================================

  describe('T-0007-05: ç ´æãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã§nullè¿”å´', () => {
    it('JSONãƒ‘ãƒ¼ã‚¹ä¸å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€nullã‚’è¿”ã™', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: JSONãƒ‘ãƒ¼ã‚¹ä¸å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«nullã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¸æ­£ãªJSONæ–‡å­—åˆ—ã‚’localStorageã«è¨­å®šã—ã€load()ãŒnullã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§localStorageã‚’ç·¨é›†ã—ãŸå ´åˆã‚„ã€ãƒ‡ãƒ¼ã‚¿ç ´ææ™‚ã«ã‚²ãƒ¼ãƒ ãŒèµ·å‹•å¯èƒ½
      // ğŸ”µ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ï¼ˆTASK-0007 Section 4.1 T-0007-05ï¼‰ã«æ˜è¨˜ã•ã‚ŒãŸå¿…é ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ä¸æ­£ãªJSONæ–‡å­—åˆ—ã‚’localStorageã«è¨­å®š
      // ã€ä¸æ­£ãªç†ç”±ã€‘: JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆé–‰ã˜æ‹¬å¼§ãªã—ã€ã‚­ãƒ¼ãŒã‚¯ã‚©ãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç­‰ï¼‰
      localStorage.setItem('atelier-guild-rank-save', '{invalid json}');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: load()ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: JSON.parse()ãŒã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ãŒã€try-catchã§ã‚­ãƒ£ãƒƒãƒã•ã‚Œã‚‹
      const loadedData = await repository.load();

      // ã€çµæœæ¤œè¨¼ã€‘: nullãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ApplicationErrorã‚’æŠ•ã’ãªã„ï¼ˆä¾‹å¤–ã‚’é£²ã¿è¾¼ã‚€ï¼‰
      expect(loadedData).toBeNull(); // ã€æ¤œè¨¼é …ç›®ã€‘: ç ´æãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ğŸ”µ

      // ã€è£œè¶³æ¤œè¨¼ã€‘: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ï¼ˆæ‰‹å‹•ç¢ºèªï¼‰
      // console.error('Failed to parse save data', error) ãŒå‘¼ã°ã‚Œã‚‹
    });
  });

  describe('T-0007-08: localStorageå®¹é‡è¶…éæ™‚ã®ã‚¨ãƒ©ãƒ¼', () => {
    it('localStorageå®¹é‡è¶…éæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: localStorageå®¹é‡è¶…éæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: localStorage.setItemãŒQuotaExceededErrorã‚’æŠ•ã’ã‚‹ã‚ˆã†ãƒ¢ãƒƒã‚¯ã—ã€ApplicationErrorãŒæŠ•ã’ã‚‰ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå®¹é‡ä¸è¶³ã€ã¨æ˜ç¤ºã—ã€å¯¾å‡¦æ–¹æ³•ã‚’ç¤ºã™
      // ğŸ”µ è¦ä»¶å®šç¾©æ›¸ï¼ˆSection 4.3 EDGE-002ï¼‰ã«æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹Edgeã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: é€šå¸¸ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
      const testSaveData = createTestSaveData();

      // ã€ãƒ¢ãƒƒã‚¯è¨­å®šã€‘: localStorage.setItemãŒQuotaExceededErrorã‚’æŠ•ã’ã‚‹ã‚ˆã†ãƒ¢ãƒƒã‚¯
      // ã€å®Ÿè£…æ–¹é‡ã€‘: beforeEachã§ä½œæˆã—ãŸlocalStorageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®setItemã‚’ä¸Šæ›¸ã
      const originalSetItem = storage.setItem;
      storage.setItem = vi.fn(() => {
        const error = new Error('QuotaExceededError');
        error.name = 'QuotaExceededError';
        throw error;
      });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: save()ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: QuotaExceededErrorãŒã‚­ãƒ£ãƒƒãƒã•ã‚Œã€ApplicationErrorã«å¤‰æ›ã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ApplicationError(ErrorCodes.SAVE_FAILED, 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™') ãŒæŠ•ã’ã‚‰ã‚Œã‚‹
      await expect(repository.save(testSaveData)).rejects.toThrow(ApplicationError); // ã€æ¤œè¨¼é …ç›®ã€‘: ApplicationErrorãŒæŠ•ã’ã‚‰ã‚Œã‚‹ ğŸ”µ
      await expect(repository.save(testSaveData)).rejects.toThrow('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); // ã€æ¤œè¨¼é …ç›®ã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ğŸ”µ

      // ã€ãƒ¢ãƒƒã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‘: ãƒ¢ãƒƒã‚¯ã‚’å¾©å…ƒ
      storage.setItem = originalSetItem;
    });
  });

  describe('T-0007-09: localStorageéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã‚¨ãƒ©ãƒ¼', () => {
    it('localStorageãŒå­˜åœ¨ã—ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: localStorageãŒå­˜åœ¨ã—ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: localStorageã‚’undefinedã«ãƒ¢ãƒƒã‚¯ã—ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ã‚¨ãƒ©ãƒ¼ãŒæŠ•ã’ã‚‰ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ä½¿ç”¨ã‚’ä¿ƒã™
      // ğŸŸ¡ è¦ä»¶å®šç¾©æ›¸ã«ã¯è¨˜è¼‰ã‚ã‚‹ãŒã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰STORAGE_NOT_SUPPORTEDã¯æœªå®šç¾©ï¼ˆè¦è¿½åŠ æ¤œè¨ï¼‰

      // ã€ãƒ¢ãƒƒã‚¯è¨­å®šã€‘: localStorageã‚’undefinedã«ãƒ¢ãƒƒã‚¯
      const originalLocalStorage = global.localStorage;
      // @ts-expect-error - ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«localStorageã‚’undefinedã«è¨­å®š
      delete global.localStorage;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: typeof localStorage === 'undefined' ã®åˆ¤å®šã§ã‚¨ãƒ©ãƒ¼ãŒæŠ•ã’ã‚‰ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ApplicationError(ErrorCodes.STORAGE_NOT_SUPPORTED, 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“')
      expect(() => new LocalStorageSaveRepository()).toThrow(ApplicationError); // ã€æ¤œè¨¼é …ç›®ã€‘: ApplicationErrorãŒæŠ•ã’ã‚‰ã‚Œã‚‹ ğŸŸ¡

      // ã€ãƒ¢ãƒƒã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‘: localStorageã‚’å¾©å…ƒ
      global.localStorage = originalLocalStorage;
    });
  });

  // =============================================================================
  // å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
  // =============================================================================

  describe('T-0007-10: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿', () => {
    it('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹å ´åˆã€nullã‚’è¿”ã™', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ç•°ãªã‚‹å ´åˆã®å‹•ä½œã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€load()ã§nullãŒè¿”ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯æ–°è¦ã‚²ãƒ¼ãƒ æ‰±ã„ï¼ˆPhase 1ã®ä»•æ§˜ï¼‰
      // ğŸŸ¡ ã‚¿ã‚¹ã‚¯å®šç¾©æ›¸ã§ã€Œæ¨å¥¨æ¡ä»¶ã€ã¨ã—ã¦è¨˜è¼‰ï¼ˆå¿…é ˆã§ã¯ãªã„ï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
      const oldVersionSaveData: ISaveData = {
        ...createTestSaveData(),
        version: '0.9.0', // å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³
      };

      // ã€ç›´æ¥localStorageè¨­å®šã€‘: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      localStorage.setItem('atelier-guild-rank-save', JSON.stringify(oldVersionSaveData));

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: load()ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•°isValidVersion()ãŒ false ã‚’è¿”ã™
      const loadedData = await repository.load();

      // ã€çµæœæ¤œè¨¼ã€‘: nullãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®ãŸã‚äº’æ›æ€§ãªã—ã¨ã—ã¦æ‰±ã†
      expect(loadedData).toBeNull(); // ã€æ¤œè¨¼é …ç›®ã€‘: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ç ´æé˜²æ­¢ ğŸŸ¡
    });
  });

  describe('T-0007-11: ç©ºã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿', () => {
    it('æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå‡¦ç†ã§ãã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã™ã¹ã¦ã®é…åˆ—ãŒç©ºã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã—ã€æ­£ã—ãå¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ç©ºé…åˆ—ãŒ[]ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹
      // ğŸŸ¡ è¦ä»¶å®šç¾©æ›¸ã«ã¯æ˜è¨˜ãªã—ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šã®ãŸã‚ã®è¿½åŠ ã‚±ãƒ¼ã‚¹

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
      const minimalSaveData: ISaveData = {
        version: '1.0.0',
        lastSaved: '2026-01-16T00:00:00.000Z',
        gameState: {
          currentRank: GuildRank.G,
          rankHp: 50,
          remainingDays: 30,
          currentDay: 1,
          currentPhase: GamePhase.QUEST_ACCEPT,
          gold: 0,
          comboCount: 0,
          actionPoints: 3,
          isPromotionTest: false,
        },
        deckState: {
          deck: [],
          hand: [],
          discard: [],
          ownedCards: [],
        },
        inventoryState: {
          materials: [],
          craftedItems: [],
          storageLimit: 30,
        },
        questState: {
          activeQuests: [],
          todayClients: [],
          todayQuests: [],
          questLimit: 3,
        },
        artifacts: [],
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: save()â†’load()ã‚’å®Ÿè¡Œ
      await repository.save(minimalSaveData);
      const loadedData = await repository.load();

      // ã€çµæœæ¤œè¨¼ã€‘: ç©ºé…åˆ—ãŒæ­£ã—ãå¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(loadedData).toEqual(minimalSaveData); // ã€æ¤œè¨¼é …ç›®ã€‘: æœ€å°ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã‚‚æ­£å¸¸å‹•ä½œ ğŸŸ¡
      expect(loadedData?.deckState.deck).toEqual([]); // ã€æ¤œè¨¼é …ç›®ã€‘: ç©ºé…åˆ—ãŒ[]ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹ ğŸŸ¡
      expect(loadedData?.artifacts).toEqual([]); // ã€æ¤œè¨¼é …ç›®ã€‘: ç©ºé…åˆ—ã®ä¸€è²«æ€§ ğŸŸ¡
    });
  });

  describe('T-0007-12: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒ¼ãƒ–', () => {
    it('å¤§é‡ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒ»ç´ æã‚’æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå‡¦ç†ã§ãã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å¤§é‡ã®ã‚¢ã‚¤ãƒ†ãƒ ãƒ»ç´ æã‚’æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ï¼ˆ100msä»¥å†…ï¼‰ã‚’æº€ãŸã™ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã‚‚ãƒ‡ãƒ¼ã‚¿æ¬ æãªãå‡¦ç†ã§ãã‚‹
      // ğŸŸ¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã¯è¦ä»¶å®šç¾©æ›¸ã«è¨˜è¼‰ã‚ã‚‹ãŒã€å…·ä½“çš„ãªãƒ‡ãƒ¼ã‚¿é‡ã¯æ¨æ¸¬

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å¤§é‡ã®ã‚«ãƒ¼ãƒ‰ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’æŒã¤ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
      const largeSaveData: ISaveData = {
        ...createTestSaveData(),
        deckState: {
          deck: Array(100)
            .fill(null)
            .map((_, i) => toCardId(`card_${i}`)),
          hand: Array(10)
            .fill(null)
            .map((_, i) => toCardId(`hand_${i}`)),
          discard: Array(50)
            .fill(null)
            .map((_, i) => toCardId(`discard_${i}`)),
          ownedCards: Array(200)
            .fill(null)
            .map((_, i) => toCardId(`owned_${i}`)),
        },
      };

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: save()ã‚’å®Ÿè¡Œã—ã€å‡¦ç†æ™‚é–“ã‚’æ¸¬å®š
      const startTime = performance.now();
      await repository.save(largeSaveData);
      const endTime = performance.now();

      // ã€çµæœæ¤œè¨¼ã€‘: å‡¦ç†æ™‚é–“ãŒ100msä»¥å†…ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ï¼‰
      const elapsedTime = endTime - startTime;
      expect(elapsedTime).toBeLessThan(100); // ã€æ¤œè¨¼é …ç›®ã€‘: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ï¼ˆ100msä»¥å†…ï¼‰ğŸŸ¡

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: load()ã‚’å®Ÿè¡Œã—ã€ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      const loadedData = await repository.load();

      // ã€çµæœæ¤œè¨¼ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ãŒæ¬ æãªãå¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(loadedData?.deckState.deck.length).toBe(100); // ã€æ¤œè¨¼é …ç›®ã€‘: ãƒ‡ãƒ¼ã‚¿é‡ã®ä¸€è‡´ ğŸŸ¡
      expect(loadedData?.deckState.ownedCards.length).toBe(200); // ã€æ¤œè¨¼é …ç›®ã€‘: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ ğŸŸ¡
    });
  });
});
