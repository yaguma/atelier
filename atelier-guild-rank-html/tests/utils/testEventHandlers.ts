/**
 * ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
 *
 * ã€ç›®çš„ã€‘: ã‚·ãƒ¼ãƒ³é·ç§»çµ±åˆãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
 * ã€ç†ç”±ã€‘: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®ã‚·ãƒ¼ãƒ³é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚
 * ã€ä¿¡é ¼æ€§ã€‘: ðŸ”µ è¨­è¨ˆæ–‡æ›¸ï¼ˆdataflow.mdï¼‰ã«åŸºã¥ãå®Ÿè£…
 */

import { SceneKeys } from '@game/config/SceneKeys';

/**
 * ã‚·ãƒ¼ãƒ³é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒ³é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²
 * ã€è¨­è¨ˆæ–¹é‡ã€‘: EventBus â†’ SceneManagerã®é€£æºã‚’ç¢ºç«‹
 * ã€ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã€‘:
 *   - Bootå®Œäº† â†’ Titleé·ç§»
 *   - æ–°è¦ã‚²ãƒ¼ãƒ /ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ â†’ Mainé·ç§»
 *   - ã‚·ãƒ§ãƒƒãƒ—é–‹é–‰
 *   - æ˜‡æ ¼è©¦é¨“é–‹é–‰
 *   - æ—¥æ•°çµ‚äº† â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢åˆ¤å®š
 *   - ãƒ©ãƒ³ã‚¯æ›´æ–° â†’ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢åˆ¤å®š
 *   - ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
 *
 * @param game Phaserã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @param eventBus EventBusã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @param sceneManager SceneManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @param stateManager StateManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 */
export function setupSceneTransitionEventHandlers(
  game: any,
  eventBus: any,
  sceneManager: any,
  stateManager: any
) {
  // =============================================================================
  // Bootå®Œäº† â†’ Titleé·ç§»
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: BootSceneå®Œäº†
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†æ™‚
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: TitleSceneã¸é·ç§»ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   */
  const bootScene = game.scene.getScene(SceneKeys.BOOT);
  bootScene.events.on('complete', () => {
    sceneManager.goTo(SceneKeys.TITLE, {}, { type: 'fade', duration: 500 });
  });

  // =============================================================================
  // æ–°è¦ã‚²ãƒ¼ãƒ /ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ â†’ Mainé·ç§»
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:game:start:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ã€Œæ–°è¦ã‚²ãƒ¼ãƒ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘:
   *   1. æ–°è¦ã‚²ãƒ¼ãƒ ã®å ´åˆã€åˆæœŸçŠ¶æ…‹ã‚’è¨­å®šï¼ˆæ—¥æ•°1ã€ã‚´ãƒ¼ãƒ«ãƒ‰100ã€ãƒ©ãƒ³ã‚¯Gï¼‰
   *   2. MainSceneã¸é·ç§»ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   */
  eventBus.on('ui:game:start:requested', (payload: any) => {
    if (payload.isNewGame) {
      // ã€æ–°è¦ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã€‘: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      // ã€åˆæœŸçŠ¶æ…‹ã€‘: æ—¥æ•°1ã€ã‚´ãƒ¼ãƒ«ãƒ‰100ã€ãƒ©ãƒ³ã‚¯G
      stateManager.updateProgress({ currentDay: 1 });
      stateManager.updatePlayer({ gold: 100, rank: 'G' });
    }
    sceneManager.goTo(SceneKeys.MAIN, {}, { type: 'fade', duration: 500 });
  });

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:game:continue:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ã€Œã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘:
   *   1. localStorageã‹ã‚‰ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
   *   2. StateManagerã«çŠ¶æ…‹ã‚’å¾©å…ƒ
   *   3. MainSceneã¸é·ç§»ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   */
  eventBus.on('ui:game:continue:requested', () => {
    // ã€ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã€‘: localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
    // ã€ãƒ‡ãƒ¼ã‚¿å½¢å¼ã€‘: JSONå½¢å¼ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿
    const saveData = localStorage.getItem('atelier_guild_rank_save_1');
    if (saveData) {
      const parsed = JSON.parse(saveData);
      const state = JSON.parse(parsed.state);
      // ã€çŠ¶æ…‹å¾©å…ƒã€‘: é€²è¡ŒçŠ¶æ³ã‚’å¾©å…ƒ
      stateManager.updateProgress(state.progress);
    }
    sceneManager.goTo(SceneKeys.MAIN, {}, { type: 'fade', duration: 500 });
  });

  // =============================================================================
  // ã‚·ãƒ§ãƒƒãƒ—é–‹é–‰
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:shop:open:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§ã€Œã‚·ãƒ§ãƒƒãƒ—ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠž
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: ShopSceneã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
   */
  eventBus.on('ui:shop:open:requested', () => {
    sceneManager.openOverlay(SceneKeys.SHOP);
  });

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:shop:close:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ã§ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: ShopSceneã‚’çµ‚äº†ã—ã€MainSceneã¸æˆ»ã‚‹
   */
  eventBus.on('ui:shop:close:requested', () => {
    sceneManager.closeOverlay(SceneKeys.SHOP);
  });

  // =============================================================================
  // æ˜‡æ ¼è©¦é¨“é–‹é–‰
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:rankup:open:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§ã€Œæ˜‡æ ¼è©¦é¨“ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠž
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: RankUpSceneã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
   */
  eventBus.on('ui:rankup:open:requested', () => {
    sceneManager.openOverlay(SceneKeys.RANK_UP);
  });

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:rankup:close:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: æ˜‡æ ¼è©¦é¨“ç”»é¢ã§ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: RankUpSceneã‚’çµ‚äº†ã—ã€MainSceneã¸æˆ»ã‚‹
   */
  eventBus.on('ui:rankup:close:requested', () => {
    sceneManager.closeOverlay(SceneKeys.RANK_UP);
  });

  // =============================================================================
  // æ—¥æ•°çµ‚äº† â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢åˆ¤å®š
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:day:end:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: æ—¥æ•°çµ‚äº†æ™‚ï¼ˆDayEndãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ï¼‰
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘:
   *   - æ—¥æ•°ãŒæœ€å¤§æ—¥æ•°ã«é”ã—ã¦ã„ã‚‹å ´åˆ â†’ GameOverSceneã¸é·ç§»
   *   - ãã‚Œä»¥å¤–ã®å ´åˆ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆæ¬¡ã®æ—¥ã¸ï¼‰
   */
  eventBus.on('ui:day:end:requested', () => {
    const progress = stateManager.getProgressData();
    // ã€ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¡ä»¶ã€‘: æ—¥æ•°åˆ‡ã‚Œï¼ˆã‹ã¤ãƒ©ãƒ³ã‚¯ãŒSæœªæº€ï¼‰
    if (progress.currentDay >= (progress.maxDay || 60)) {
      sceneManager.goTo(SceneKeys.GAME_OVER, {}, { type: 'fade', duration: 500 });
    }
  });

  // =============================================================================
  // ãƒ©ãƒ³ã‚¯æ›´æ–° â†’ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢åˆ¤å®š
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:rank:updated
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘:
   *   - Sãƒ©ãƒ³ã‚¯ã«åˆ°é”ã—ãŸå ´åˆ â†’ GameClearSceneã¸é·ç§»
   *   - ãã‚Œä»¥å¤–ã®å ´åˆ â†’ ä½•ã‚‚ã—ãªã„
   */
  eventBus.on('ui:rank:updated', (payload: any) => {
    // ã€ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ¡ä»¶ã€‘: Sãƒ©ãƒ³ã‚¯åˆ°é”
    if (payload.newRank === 'S') {
      sceneManager.goTo(SceneKeys.GAME_CLEAR, {}, { type: 'fade', duration: 500 });
    }
  });

  // =============================================================================
  // ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
  // =============================================================================

  /**
   * ã€ã‚¤ãƒ™ãƒ³ãƒˆã€‘: ui:title:return:requested
   * ã€ãƒˆãƒªã‚¬ãƒ¼ã€‘: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢ç”»é¢ã§ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   * ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘: TitleSceneã¸é·ç§»ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
   */
  eventBus.on('ui:title:return:requested', () => {
    sceneManager.goTo(SceneKeys.TITLE, {}, { type: 'fade', duration: 500 });
  });
}
