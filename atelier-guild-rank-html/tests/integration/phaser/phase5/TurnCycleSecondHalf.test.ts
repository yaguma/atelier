/**
 * Phase5 1ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚¯ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå¾ŒåŠï¼‰
 *
 * TASK-0262: 1ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚¯ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå¾ŒåŠï¼‰
 * 1ã‚¿ãƒ¼ãƒ³ï¼ˆ1æ—¥ï¼‰ã®ã‚²ãƒ¼ãƒ ã‚µã‚¤ã‚¯ãƒ«ã®å¾ŒåŠéƒ¨åˆ†ï¼ˆèª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã€ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã€ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ï¼‰ãŒ
 * æ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆã€‚
 */

import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import {
  createMockEventBus,
  createMockStateManager,
} from '../../../utils/phaserTestUtils';
import { getPhaserMock } from '../../../utils/phaserMocks';

// ã€Phaserãƒ¢ãƒƒã‚¯ã€‘: ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®Phaserãƒ¢ãƒƒã‚¯ã‚’è¨­å®š
// ã€ç†ç”±ã€‘: jsdomç’°å¢ƒã§ã¯Canvas APIãŒå‹•ä½œã—ãªã„ãŸã‚ ğŸ”µ
vi.mock('phaser', () => getPhaserMock());

/**
 * ã€å®šæ•°å®šç¾©ã€‘: ãƒ†ã‚¹ãƒˆç”¨ã®å®šæ•°
 * ã€ä¿å®ˆæ€§å‘ä¸Šã€‘: ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã‚’å®šæ•°åŒ–ã—ã¦ã‚³ãƒ¼ãƒ‰ã®æ„å›³ã‚’æ˜ç¢ºåŒ– ğŸ”µ
 */
// ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå“è³ªå€¤ã€‘: ç´ æã®å“è³ªãŒå–å¾—ã§ããªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
// ã€è¨­å®šç†ç”±ã€‘: ã‚²ãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ä¸Šã€ä¸­é–“çš„ãªå“è³ªã‚’åŸºæº–å€¤ã¨ã—ã¦è¨­å®š
const DEFAULT_QUALITY = 50;

// ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°ã€‘: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šç¾©
// ã€å¤šè¨€èªå¯¾å¿œæº–å‚™ã€‘: å°†æ¥çš„ã«ç¿»è¨³ã‚­ãƒ¼ã¨ã—ã¦åˆ©ç”¨å¯èƒ½
const ERROR_MESSAGES = {
  RECIPE_NOT_FOUND: 'ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
  MATERIAL_INSUFFICIENT: 'ç´ æãŒä¸è¶³ã—ã¦ã„ã¾ã™',
  QUEST_NOT_FOUND: 'ä¾é ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
  ITEM_INSUFFICIENT: 'ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
} as const;

/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®Phaserã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆ
 * ã€è¨­å®šå†…å®¹ã€‘: EventBusã€StateManagerã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 * ã€ä¿¡é ¼æ€§ã€‘: ğŸ”µ è¨­è¨ˆæ–‡æ›¸ã«åŸºã¥ãå®Ÿè£…
 *
 * @returns Promise<{ game, eventBus, stateManager }>
 */
async function createTestGame(): Promise<{
  game: any;
  eventBus: any;
  stateManager: any;
}> {
  // ã€EventBusä½œæˆã€‘: ãƒ¢ãƒƒã‚¯EventBusã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ ğŸ”µ
  const eventBus = createMockEventBus();

  // ã€StateManagerä½œæˆã€‘: ãƒ¢ãƒƒã‚¯StateManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ ğŸ”µ
  const stateManager = createMockStateManager();

  // ã€Phaserã‚²ãƒ¼ãƒ ä½œæˆã€‘: ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ ğŸ”µ
  const Phaser = await import('phaser');
  const game = new Phaser.default.Game();

  // ã€StateManagerç™»éŒ²ã€‘: StateManagerã‚’ã‚²ãƒ¼ãƒ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ç™»éŒ² ğŸ”µ
  game.registry.set('stateManager', stateManager);

  // ã€EventBusç™»éŒ²ã€‘: EventBusã‚’ã‚²ãƒ¼ãƒ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ç™»éŒ² ğŸ”µ
  game.registry.set('eventBus', eventBus);

  return { game, eventBus, stateManager };
}

/**
 * ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã‚’å¾…æ©Ÿã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 *
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: æŒ‡å®šã—ãŸãƒ•ã‚§ãƒ¼ã‚ºã«ã‚²ãƒ¼ãƒ ãŒé·ç§»ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹
 * ã€å¾…æ©Ÿæ–¹æ³•ã€‘: vi.waitFor()ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸå¾…æ©Ÿ
 * ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‘: æœ€å¤§5000msã¾ã§å¾…æ©Ÿ
 * ã€ä¿¡é ¼æ€§ã€‘: ğŸ”µ ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 *
 * @param game - Phaserã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @param phase - å¾…æ©Ÿã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºå
 */
async function waitForPhase(game: any, phase: string): Promise<void> {
  const stateManager = game.registry.get('stateManager');
  await vi.waitFor(
    () => {
      const progress = stateManager.getProgressData();
      if (progress.currentPhase !== phase) {
        throw new Error(`Phase is ${progress.currentPhase}, waiting for ${phase}`);
      }
    },
    { timeout: 5000, interval: 50 }
  );
}

describe('ğŸ”´ Phase5: 1ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚¯ãƒ«çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå¾ŒåŠï¼‰', () => {
  let game: any;
  let eventBus: any;
  let stateManager: any;

  beforeEach(async () => {
    // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–ã—ã€ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’ä¿è¨¼
    // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: å‰ã®ãƒ†ã‚¹ãƒˆã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã€ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ–°è¦ä½œæˆ
    vi.clearAllMocks();

    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
    stateManager = testSetup.stateManager;

    // ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²ã€‘: EventBusã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²
    // ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒ†ã‚¹ãƒˆã‚’é€šã™æœ€å°é™ã®å®Ÿè£…ã‚’è¡Œã† ğŸ”µ

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: èª¿åˆå®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
     * ã€å®Ÿè£…æ–¹é‡ã€‘: ç´ æã‚’æ¶ˆè²»ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹
     * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TC-02, TC-03, TC-04, TC-16, TC-18 ã‚’é€šã™ãŸã‚ã®å®Ÿè£…
     * ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆè¨­è¨ˆæ–‡æ›¸ã«åŸºã¥ãå®Ÿè£…ï¼‰
     */
    eventBus.on(
      'ui:alchemy:craft:requested',
      ({ recipeCardId, materialIds }: { recipeCardId: string; materialIds: string[] }) => {
        // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã¨ç´ æãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        const inventory = stateManager.getInventoryState();
        const deck = stateManager.getDeckState();

        // ã€ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰æ¤œç´¢ã€‘: æ‰‹æœ­ã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’æ¤œç´¢ ğŸ”µ
        const recipeCard = deck.hand.find((c: any) => c.id === recipeCardId);
        if (!recipeCard) {
          // ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç« ğŸ”µ
          eventBus.emit('app:error:occurred', {
            message: ERROR_MESSAGES.RECIPE_NOT_FOUND,
          });
          return;
        }

        // ã€ç´ æå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€‘: å¿…è¦ãªç´ æãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª ğŸ”µ
        const materialMap = new Map<string, number>();
        materialIds.forEach((id) => {
          materialMap.set(id, (materialMap.get(id) || 0) + 1);
        });

        for (const [materialId, requiredCount] of materialMap.entries()) {
          const material = inventory.materials.find((m: any) => m.id === materialId);
          if (!material || material.quantity < requiredCount) {
            // ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ç´ æä¸è¶³æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
            // ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›
            eventBus.emit('app:error:occurred', {
              message: ERROR_MESSAGES.MATERIAL_INSUFFICIENT,
            });
            return;
          }
        }

        // ã€ç´ ææ¶ˆè²»å‡¦ç†ã€‘: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰ç´ æã‚’æ¶ˆè²» ğŸ”µ
        const updatedMaterials = inventory.materials.map((m: any) => {
          const consumeCount = materialMap.get(m.id) || 0;
          if (consumeCount > 0) {
            return { ...m, quantity: m.quantity - consumeCount };
          }
          return m;
        });

        // ã€å“è³ªè¨ˆç®—ã€‘: ä½¿ç”¨ã—ãŸç´ æã®å“è³ªã‹ã‚‰ä½œæˆã‚¢ã‚¤ãƒ†ãƒ ã®å“è³ªã‚’è¨ˆç®— ğŸ”µ
        // ã€è¨ˆç®—æ–¹æ³•ã€‘: ä½¿ç”¨ã—ãŸå…¨ç´ æã®å“è³ªå€¤ã®å¹³å‡ã‚’ç®—å‡ºã—ã€åºŠé–¢æ•°ã§æ•´æ•°åŒ–
        // ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡¦ç†ã€‘: å“è³ªæƒ…å ±ãŒãªã„ç´ æã¯å“è³ª0ã¨ã—ã¦é™¤å¤–ã—ã€å…¨ã¦é™¤å¤–ã•ã‚ŒãŸå ´åˆã¯DEFAULT_QUALITYã‚’ä½¿ç”¨
        // ã€æ”¹å–„ä½™åœ°ã€‘: å°†æ¥çš„ã«ç´ æã®ç¨®é¡ã«å¿œã˜ãŸé‡ã¿ä»˜ã‘è¨ˆç®—ã‚’æ¤œè¨å¯èƒ½ ğŸŸ¡
        const materialQualities = materialIds
          .map((id) => inventory.materials.find((m: any) => m.id === id)?.quality || 0)
          .filter((q) => q > 0);
        const avgQuality =
          materialQualities.length > 0
            ? Math.floor(
                materialQualities.reduce((sum, q) => sum + q, 0) / materialQualities.length
              )
            : DEFAULT_QUALITY;

        // ã€ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆã€‘: æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ  ğŸ”µ
        const newItem = {
          id: `${recipeCard.output.id}_${Date.now()}`,
          name: recipeCard.output.name,
          quantity: 1,
          quality: avgQuality,
        };

        // ã€ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ›´æ–°ã€‘: ç´ ææ¶ˆè²»ã¨ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ã‚’åæ˜  ğŸ”µ
        stateManager.updateInventoryState({
          materials: updatedMaterials,
          items: [...inventory.items, newItem],
        });

        // ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã€‘: èª¿åˆå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
        eventBus.emit('app:alchemy:craft:complete', { item: newItem });
      }
    );

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ç´å“å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
     * ã€å®Ÿè£…æ–¹é‡ã€‘: ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¶ˆè²»ã—ã¦ä¾é ¼ã‚’å®Œäº†ã—ã€å ±é…¬ã‚’ä»˜ä¸ã™ã‚‹
     * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TC-07, TC-08, TC-09, TC-14, TC-17 ã‚’é€šã™ãŸã‚ã®å®Ÿè£…
     * ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆè¨­è¨ˆæ–‡æ›¸ã«åŸºã¥ãå®Ÿè£…ï¼‰
     */
    eventBus.on(
      'ui:quest:delivery:requested',
      ({ questId, itemIds }: { questId: string; itemIds: string[] }) => {
        // ã€å…¥åŠ›å€¤æ¤œè¨¼ã€‘: ä¾é ¼IDã¨ã‚¢ã‚¤ãƒ†ãƒ ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        const quests = stateManager.getQuestState();
        const inventory = stateManager.getInventoryState();
        const player = stateManager.getPlayerState();

        // ã€ä¾é ¼æ¤œç´¢ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ã‹ã‚‰å¯¾è±¡ã®ä¾é ¼ã‚’æ¤œç´¢ ğŸ”µ
        const quest = quests.activeQuests.find((q: any) => q.id === questId);
        if (!quest) {
          // ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ä¾é ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç« ğŸ”µ
          eventBus.emit('app:error:occurred', {
            message: ERROR_MESSAGES.QUEST_NOT_FOUND,
          });
          return;
        }

        // ã€ã‚¢ã‚¤ãƒ†ãƒ å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€‘: å¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª ğŸ”µ
        const itemMap = new Map<string, number>();
        itemIds.forEach((id) => {
          itemMap.set(id, (itemMap.get(id) || 0) + 1);
        });

        // ã€è¦ä»¶ãƒã‚§ãƒƒã‚¯ã€‘: ä¾é ¼ã«å¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª ğŸ”µ
        for (const req of quest.requirements || []) {
          const item = inventory.items.find((i: any) => i.id === req.itemId);
          if (!item || item.quantity < req.quantity) {
            // ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€‘: ã‚¢ã‚¤ãƒ†ãƒ ä¸è¶³æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
            // ã€ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã€‘: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›
            eventBus.emit('app:error:occurred', {
              message: ERROR_MESSAGES.ITEM_INSUFFICIENT,
            });
            return;
          }
        }

        // ã€ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆè²»å‡¦ç†ã€‘: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¶ˆè²» ğŸ”µ
        const updatedItems = inventory.items.filter((i: any) => !itemIds.includes(i.id));

        // ã€å ±é…¬ä»˜ä¸ã€‘: ã‚´ãƒ¼ãƒ«ãƒ‰ã¨çµŒé¨“å€¤ã‚’ä»˜ä¸ ğŸ”µ
        const newGold = player.gold + (quest.rewards?.gold || 0);
        const newExp = (player.exp || 0) + (quest.rewards?.exp || 0);

        // ã€ä¾é ¼å®Œäº†çŠ¶æ…‹ã¸ã®é·ç§»ã€‘: å—æ³¨æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã€å®Œäº†æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ  ğŸ”µ
        const updatedActive = quests.activeQuests.filter((q: any) => q.id !== questId);
        const updatedCompleted = [...quests.completedQuestIds, questId];

        // ã€çŠ¶æ…‹æ›´æ–°ã€‘: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€ä¾é ¼çŠ¶æ…‹ã‚’æ›´æ–° ğŸ”µ
        stateManager.updateInventoryState({
          ...inventory,
          items: updatedItems,
        });
        stateManager.updatePlayerState({
          ...player,
          gold: newGold,
          exp: newExp,
        });
        stateManager.updateQuestState({
          ...quests,
          activeQuests: updatedActive,
          completedQuestIds: updatedCompleted,
        });

        // ã€å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
        if (quest.rewardCards && quest.rewardCards.length > 0) {
          eventBus.emit('app:reward:card:selection', {
            cards: quest.rewardCards,
          });
        }

        // ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã€‘: ç´å“å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
        eventBus.emit('app:quest:delivery:complete', {
          questId,
          rewards: quest.rewards,
        });
      }
    );

    /**
     * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
     * ã€å®Ÿè£…æ–¹é‡ã€‘: æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã—ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã¯æ—¥æ•°é€²è¡Œã¨APå›å¾©ã‚’è¡Œã†
     * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TC-05, TC-10, TC-11, TC-12, TC-13, TC-15 ã‚’é€šã™ãŸã‚ã®å®Ÿè£…
     * ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆè¨­è¨ˆæ–‡æ›¸ã«åŸºã¥ãå®Ÿè£…ï¼‰
     */
    eventBus.on('ui:phase:complete', ({ phase }: { phase: string }) => {
      // ã€ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒãƒƒãƒ—ã€‘: å„ãƒ•ã‚§ãƒ¼ã‚ºã®æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®šç¾© ğŸ”µ
      const phaseTransitionMap: Record<string, string> = {
        'quest-accept': 'gathering',
        gathering: 'alchemy',
        alchemy: 'delivery',
        delivery: 'quest-accept', // æ¬¡ã®æ—¥
      };

      // ã€æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºå–å¾—ã€‘: ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’å–å¾— ğŸ”µ
      const nextPhase = phaseTransitionMap[phase];

      // ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ã€‘: deliveryãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†æ™‚ã¯æ—¥æ•°é€²è¡Œã¨APå›å¾©ã‚’å®Ÿè¡Œ ğŸ”µ
      if (phase === 'delivery') {
        const gameState = stateManager.getGameState();
        const player = stateManager.getPlayerState();

        // ã€æ—¥æ•°é€²è¡Œã€‘: currentDayã‚’+1å¢—åŠ  ğŸ”µ
        const newDay = gameState.currentDay + 1;

        // ã€APå›å¾©ã€‘: ap.currentã‚’ap.maxã«è¨­å®š ğŸ”µ
        const recoveredAP = {
          current: player.ap?.max || player.actionPointsMax || 3,
          max: player.ap?.max || player.actionPointsMax || 3,
        };

        // ã€çŠ¶æ…‹æ›´æ–°ã€‘: æ—¥æ•°ã¨APã‚’æ›´æ–° ğŸ”µ
        stateManager.updateGameState({
          ...gameState,
          currentDay: newDay,
        });
        stateManager.updatePlayerState({
          ...player,
          ap: recoveredAP,
        });

        // ã€ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã€‘: æ—¥çµ‚äº†ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç« ğŸ”µ
        eventBus.emit('app:day:ended', {
          newDay,
          summary: {
            // ã‚µãƒãƒªãƒ¼å†…å®¹ï¼ˆæœ€å°å®Ÿè£…ï¼‰
            completedQuests: 0,
            gainedGold: 0,
            gainedExp: 0,
          },
        });
      }

      // ã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã€‘: StateManagerã®çŠ¶æ…‹ã‚’æ›´æ–° ğŸ”µ
      if (nextPhase) {
        stateManager.updateGameState({ currentPhase: nextPhase });

        // ã€ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã‚’é€šçŸ¥ ğŸ”µ
        eventBus.emit('app:phase:changed', { phase: nextPhase });
      }
    });
  });

  afterEach(() => {
    // ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«ä½œæˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
    // ã€çŠ¶æ…‹å¾©å…ƒã€‘: æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€ã‚·ã‚¹ãƒ†ãƒ ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
    if (game) {
      game.destroy(true);
    }
    if (eventBus) {
      eventBus.clear();
    }
  });

  describe('èª¿åˆãƒ•ã‚§ãƒ¼ã‚º', () => {
    beforeEach(() => {
      // ã€åˆæœŸçŠ¶æ…‹è¨­å®šã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã®é–‹å§‹æ¡ä»¶ã‚’æ•´ãˆã‚‹

      // ã€ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®šã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»æ¸ˆã¿ã®çŠ¶æ…‹
      stateManager._setGameState({ currentPhase: 'alchemy', currentDay: 1 });

      // ã€ç´ ææº–å‚™ã€‘: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«ç´ æã‚’è¿½åŠ 
      stateManager.updateInventoryState({
        materials: [
          { id: 'herb_001', name: 'è–¬è‰', quantity: 5, quality: 80 },
          { id: 'water_001', name: 'æ°´', quantity: 3, quality: 70 },
          { id: 'crystal_001', name: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«', quantity: 2, quality: 90 },
        ],
        items: [],
      });

      // ã€ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰æº–å‚™ã€‘: æ‰‹æœ­ã«ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
      stateManager.updateDeckState({
        hand: [
          {
            id: 'recipe_potion_001',
            type: 'recipe',
            name: 'å›å¾©è–¬',
            requirements: [
              { itemId: 'herb_001', quantity: 2 },
              { itemId: 'water_001', quantity: 1 },
            ],
            output: { id: 'potion_001', name: 'å›å¾©è–¬' },
          },
        ],
        cards: [],
        discardPile: [],
      });
    });

    it('TC-01: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒæ‰‹æœ­ã«è¡¨ç¤ºã•ã‚Œã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã§ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: æ‰‹æœ­ã®ä¸­ã«ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ï¼ˆtype === 'recipe'ï¼‰ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æ‰‹æœ­ã«ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒ1æšä»¥ä¸Šå­˜åœ¨ã™ã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: StateManagerã‹ã‚‰ãƒ‡ãƒƒã‚­çŠ¶æ…‹ã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: æ‰‹æœ­ã®ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’å–å¾—ã—ã€ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const deck = stateManager.getDeckState();
      const recipeCards = deck.hand.filter((c: any) => c.type === 'recipe');

      // ã€çµæœæ¤œè¨¼ã€‘: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒæ‰‹æœ­ã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹ãŸã‚
      expect(recipeCards.length).toBeGreaterThan(0); // ã€ç¢ºèªå†…å®¹ã€‘: æ‰‹æœ­ã«ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒ1æšä»¥ä¸Šå­˜åœ¨ã™ã‚‹ ğŸ”µ
    });

    it('TC-02: ã‚¢ã‚¤ãƒ†ãƒ ã‚’èª¿åˆã§ãã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª¿åˆã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ã‚¢ã‚¤ãƒ†ãƒ ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã¨ç´ æã‚’é¸æŠã—ã¦èª¿åˆã‚’å®Ÿè¡Œã—ã€ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: craftedItemsã«æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: èª¿åˆå‰ã®ã‚¢ã‚¤ãƒ†ãƒ æ•°ã‚’è¨˜éŒ²
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«èª¿åˆæ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„çŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      const initialItems = stateManager.getInventoryState().items.length;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èª¿åˆå®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰IDã¨é¸æŠã—ãŸç´ æIDã‚’æŒ‡å®šã—ã¦èª¿åˆã‚’å®Ÿè¡Œ
      eventBus.emit('ui:alchemy:craft:requested', {
        recipeCardId: 'recipe_potion_001',
        materialIds: ['herb_001', 'herb_001', 'water_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: èª¿åˆå¾Œã«ã‚¢ã‚¤ãƒ†ãƒ ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: èª¿åˆãŒæˆåŠŸã™ã‚‹ã¨ã€ãƒ¬ã‚·ãƒ”ã«åŸºã¥ã„ã¦æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ ã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const inventory = stateManager.getInventoryState();
        expect(inventory.items.length).toBeGreaterThan(initialItems); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¢ã‚¤ãƒ†ãƒ æ•°ãŒå¢—åŠ ã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-03: èª¿åˆã§ç´ æãŒæ¶ˆè²»ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ç´ æãŒé©åˆ‡ã«æ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èª¿åˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä½¿ç”¨ã—ãŸç´ æãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰æ¸›å°‘ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æŒ‡å®šã—ãŸç´ æãŒmaterialsã‹ã‚‰å‰Šé™¤ã¾ãŸã¯æ•°é‡ãŒæ¸›å°‘ã™ã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: èª¿åˆå‰ã®ç´ ææ•°é‡ã‚’è¨˜éŒ²
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç´ æãŒååˆ†ã«ã‚ã‚‹çŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      const initialHerb = stateManager
        .getInventoryState()
        .materials.find((m: any) => m.id === 'herb_001');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èª¿åˆå®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: è–¬è‰2å€‹ã¨æ°´1å€‹ã‚’æ¶ˆè²»ã—ã¦å›å¾©è–¬ã‚’ä½œæˆ
      eventBus.emit('ui:alchemy:craft:requested', {
        recipeCardId: 'recipe_potion_001',
        materialIds: ['herb_001', 'herb_001', 'water_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: èª¿åˆå¾Œã«ç´ æãŒæ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: èª¿åˆã«ã¯ç´ æãŒå¿…è¦ã§ã‚ã‚Šã€ä½¿ç”¨ã—ãŸç´ æã¯ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰æ¶ˆè²»ã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const herb = stateManager
          .getInventoryState()
          .materials.find((m: any) => m.id === 'herb_001');
        expect(herb!.quantity).toBe(initialHerb!.quantity - 2); // ã€ç¢ºèªå†…å®¹ã€‘: è–¬è‰ãŒ2å€‹æ¸›å°‘ã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-04: èª¿åˆçµæœã«å“è³ªãŒåæ˜ ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å“è³ªã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ç´ æã®å“è³ªãŒã‚¢ã‚¤ãƒ†ãƒ ã«åæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èª¿åˆã§ä½œæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã«å“è³ªå€¤ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä½œæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®qualityãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ0ã‚ˆã‚Šå¤§ãã„
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èª¿åˆå®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: å“è³ªã‚’æŒã¤ç´ æã‚’ä½¿ç”¨ã—ã¦èª¿åˆã™ã‚‹
      eventBus.emit('ui:alchemy:craft:requested', {
        recipeCardId: 'recipe_potion_001',
        materialIds: ['herb_001', 'herb_001', 'water_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ä½œæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã«å“è³ªãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ç´ æã®å“è³ªãŒã‚¢ã‚¤ãƒ†ãƒ ã®å“è³ªã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ãŸã‚ã€èª¿åˆçµæœã«ã¯å“è³ªå€¤ãŒè¨­å®šã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const items = stateManager.getInventoryState().items;
        const potion = items.find((i: any) => i.id.startsWith('potion'));
        expect(potion).toBeDefined(); // ã€ç¢ºèªå†…å®¹ã€‘: å›å¾©è–¬ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
        expect(potion!.quality).toBeGreaterThan(0); // ã€ç¢ºèªå†…å®¹ã€‘: å“è³ªå€¤ãŒ0ã‚ˆã‚Šå¤§ãã„ ğŸ”µ
      });
    });

    it('TC-05: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã§ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã™ã‚‹ã¨ã€ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒdeliveryã«å¤‰æ›´ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã®å®Œäº†ã‚’é€šçŸ¥ã™ã‚‹
      eventBus.emit('ui:phase:complete', { phase: 'alchemy' });

      // ã€çµæœæ¤œè¨¼ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼ã«å¾“ã„ã€èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã®æ¬¡ã¯ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚ã‚‹
      await waitForPhase(game, 'delivery');
      expect(stateManager.getProgressData().currentPhase).toBe('delivery'); // ã€ç¢ºèªå†…å®¹ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã—ã¦ã„ã‚‹ ğŸ”µ
    });

    it('TC-16: ç´ æä¸è¶³æ™‚ã¯èª¿åˆã§ããªã„', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å¿…è¦ãªç´ æãŒä¸è¶³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§èª¿åˆã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: app:error:occurredã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œç´ æã€ãŒå«ã¾ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç´ æã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç´ æãŒä¸è¶³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’ä½œã‚‹
      stateManager.updateInventoryState({ materials: [], items: [] });

      // ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´ æä¸è¶³çŠ¶æ…‹ã§èª¿åˆã‚’è©¦ã¿ã‚‹
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒ¬ã‚·ãƒ”ã«å¿…è¦ãªç´ æãŒãªã„çŠ¶æ…‹ã§èª¿åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºç«
      eventBus.emit('ui:alchemy:craft:requested', {
        recipeCardId: 'recipe_potion_001',
        materialIds: ['herb_001', 'herb_001', 'water_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¸æ­£ãªæ“ä½œã‚’é˜²ãã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã‚‹ãŸã‚
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            message: expect.stringContaining('ç´ æ'),
          })
        ); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œç´ æã€ãŒå«ã¾ã‚Œã‚‹ ğŸ”µ
      });
    });

    it('TC-18: ç´ æã¡ã‚‡ã†ã©0å€‹ã®çŠ¶æ…‹ã§èª¿åˆã§ããªã„', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å¢ƒç•Œæ¡ä»¶ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç´ ææ•°é‡ãŒ0å€‹ã®å¢ƒç•Œå€¤ã§é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: app:error:occurredã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆTC-16ã¨åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç´ æã‚’å…¨ã¦ä½¿ã„åˆ‡ã£ãŸçŠ¶æ…‹ã«ã™ã‚‹
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ç´ ææ•°é‡ãŒ0ã®å¢ƒç•Œå€¤çŠ¶æ…‹
      stateManager.updateInventoryState({ materials: [], items: [] });

      // ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´ æ0å€‹ã®çŠ¶æ…‹ã§èª¿åˆã‚’è©¦ã¿ã‚‹
      // ã€å‡¦ç†å†…å®¹ã€‘: å¢ƒç•Œå€¤ã§ã®å‹•ä½œã‚’ç¢ºèª
      eventBus.emit('ui:alchemy:craft:requested', {
        recipeCardId: 'recipe_potion_001',
        materialIds: ['herb_001', 'herb_001', 'water_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 0å€‹ã®å¢ƒç•Œã§æ­£ã—ãã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });
  });

  describe('ç´å“ãƒ•ã‚§ãƒ¼ã‚º', () => {
    beforeEach(async () => {
      // ã€åˆæœŸçŠ¶æ…‹è¨­å®šã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã®é–‹å§‹æ¡ä»¶ã‚’æ•´ãˆã‚‹

      // ã€ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®šã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»æ¸ˆã¿ã®çŠ¶æ…‹
      stateManager._setGameState({ currentPhase: 'delivery', currentDay: 1 });

      // ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹è¨­å®šã€‘: åˆæœŸã‚´ãƒ¼ãƒ«ãƒ‰ã¨çµŒé¨“å€¤ã‚’è¨­å®š
      stateManager._setPlayerState({ gold: 100, exp: 0 });

      // ã€ä¾é ¼æº–å‚™ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ã‚’è¨­å®š
      stateManager.updateQuestState({
        availableQuests: [],
        activeQuests: [
          {
            id: 'quest_001',
            name: 'å›å¾©è–¬ã®ç´å“',
            requirements: [{ itemId: 'potion_001', quantity: 1 }],
            rewards: { gold: 100, exp: 50 },
          },
        ],
        completedQuestIds: [],
      });

      // ã€ã‚¢ã‚¤ãƒ†ãƒ æº–å‚™ã€‘: ç´å“å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”¨æ„
      stateManager.updateInventoryState({
        materials: [],
        items: [{ id: 'potion_001', name: 'å›å¾©è–¬', quantity: 1, quality: 80 }],
      });
    });

    it('TC-06: å—æ³¨ä¸­ã®ä¾é ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã§ä¾é ¼ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ãƒªã‚¹ãƒˆãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: quests.activeQuests.length > 0
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: StateManagerã‹ã‚‰ä¾é ¼çŠ¶æ…‹ã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
      const quests = stateManager.getQuestState();

      // ã€çµæœæ¤œè¨¼ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å—æ³¨æ¸ˆã¿ã®ä¾é ¼ã‚’å®Œäº†ã™ã‚‹ãŸã‚
      expect(quests.activeQuests.length).toBeGreaterThan(0); // ã€ç¢ºèªå†…å®¹ã€‘: å—æ³¨æ¸ˆã¿ä¾é ¼ãŒ1ä»¶ä»¥ä¸Šå­˜åœ¨ã™ã‚‹ ğŸ”µ
    });

    it('TC-07: ä¾é ¼ã‚’ç´å“ã§ãã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç´å“ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ä¾é ¼ãŒå®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¾é ¼ã‚’é¸æŠã—ã¦ç´å“ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä¾é ¼ãŒacceptedã‹ã‚‰completedã«ç§»å‹•ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¾é ¼ãŒå—æ³¨æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚Œã€å®Œäº†æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´å“å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ä¾é ¼IDã¨æå‡ºã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ IDã‚’æŒ‡å®šã—ã¦ç´å“ã‚’å®Ÿè¡Œ
      eventBus.emit('ui:quest:delivery:requested', {
        questId: 'quest_001',
        itemIds: ['potion_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ä¾é ¼ãŒå®Œäº†çŠ¶æ…‹ã«é·ç§»ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ç´å“ãŒæˆåŠŸã™ã‚‹ã¨ã€ä¾é ¼ã¯å®Œäº†çŠ¶æ…‹ã«ãªã‚Šã€ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const quests = stateManager.getQuestState();
        expect(quests.completedQuestIds).toContain('quest_001'); // ã€ç¢ºèªå†…å®¹ã€‘: å®Œäº†æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
        expect(quests.activeQuests.find((q: any) => q.id === 'quest_001')).toBeUndefined(); // ã€ç¢ºèªå†…å®¹ã€‘: å—æ³¨æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-08: ç´å“ã§å ±é…¬ã‚’ç²å¾—ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å ±é…¬ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå ±é…¬ã‚’ç²å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¾é ¼ã‚’ç´å“ã™ã‚‹ã¨ã€å ±é…¬ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»çµŒé¨“å€¤ï¼‰ãŒç²å¾—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®goldã¨expãŒå¢—åŠ ã™ã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç´å“å‰ã®ã‚´ãƒ¼ãƒ«ãƒ‰ã¨çµŒé¨“å€¤ã‚’è¨˜éŒ²
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸçŠ¶æ…‹ã‚’ç¢ºèª
      const initialGold = stateManager.getPlayerState().gold;
      const initialExp = stateManager.getPlayerState().exp;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´å“å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: å ±é…¬ï¼ˆgold: 100, exp: 50ï¼‰ã‚’æŒã¤ä¾é ¼ã‚’ç´å“
      eventBus.emit('ui:quest:delivery:requested', {
        questId: 'quest_001',
        itemIds: ['potion_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: å ±é…¬ãŒæ­£ã—ãç²å¾—ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¾é ¼ã‚’å®Œäº†ã™ã‚‹ã¨ã€å ±é…¬ãŒè‡ªå‹•çš„ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ä»˜ä¸ã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const player = stateManager.getPlayerState();
        expect(player.gold).toBe(initialGold + 100); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚´ãƒ¼ãƒ«ãƒ‰ãŒ100å¢—åŠ ã—ã¦ã„ã‚‹ ğŸ”µ
        expect(player.exp).toBe(initialExp + 50); // ã€ç¢ºèªå†…å®¹ã€‘: çµŒé¨“å€¤ãŒ50å¢—åŠ ã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-09: ç´å“ã§ã‚¢ã‚¤ãƒ†ãƒ ãŒæ¶ˆè²»ã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ã‚¢ã‚¤ãƒ†ãƒ ãŒé©åˆ‡ã«æ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¾é ¼ã‚’ç´å“ã™ã‚‹ã¨ã€æå‡ºã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: æŒ‡å®šã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒitemsã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´å“å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: å›å¾©è–¬ã‚’1å€‹æ¶ˆè²»ã—ã¦ä¾é ¼ã‚’ç´å“
      eventBus.emit('ui:quest:delivery:requested', {
        questId: 'quest_001',
        itemIds: ['potion_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¢ã‚¤ãƒ†ãƒ ãŒæ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¾é ¼ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç´å“ã™ã‚‹ã¨ã€ãã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹
      await vi.waitFor(() => {
        const inventory = stateManager.getInventoryState();
        expect(inventory.items.find((i: any) => i.id === 'potion_001')).toBeUndefined(); // ã€ç¢ºèªå†…å®¹ã€‘: å›å¾©è–¬ãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-17: å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ ä¸è¶³æ™‚ã¯ç´å“ã§ããªã„', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¾é ¼ã«å¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ãŒä¸è¶³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ç´å“ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: app:error:occurredã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸è¶³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’ä½œã‚‹
      stateManager.updateInventoryState({ materials: [], items: [] });

      // ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚¢ã‚¤ãƒ†ãƒ ä¸è¶³çŠ¶æ…‹ã§ç´å“ã‚’è©¦ã¿ã‚‹
      // ã€å‡¦ç†å†…å®¹ã€‘: å¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„çŠ¶æ…‹ã§ç´å“ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºç«
      eventBus.emit('ui:quest:delivery:requested', {
        questId: 'quest_001',
        itemIds: [],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¸æ­£ãªç´å“ã‚’é˜²ãã€ã‚²ãƒ¼ãƒ ã®æ•´åˆæ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalled(); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });
  });

  describe('ã‚¿ãƒ¼ãƒ³çµ‚äº†', () => {
    beforeEach(async () => {
      // ã€åˆæœŸçŠ¶æ…‹è¨­å®šã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†ã®æ¡ä»¶ã‚’æ•´ãˆã‚‹

      // ã€ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®šã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†å‰ã®æœ€å¾Œã®ãƒ•ã‚§ãƒ¼ã‚ºï¼‰
      stateManager._setGameState({ currentPhase: 'delivery', currentDay: 1 });

      // ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹è¨­å®šã€‘: APæ¶ˆè²»æ¸ˆã¿ã®çŠ¶æ…‹
      stateManager._setPlayerState({
        ap: { current: 0, max: 3 },
        gold: 100,
      });
    });

    it('TC-10: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã§ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã™ã‚‹ã¨ã€ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã—æ—¥æ•°ãŒé€²ã‚€ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: currentDayãŒ+1å¢—åŠ ã™ã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†å‰ã®æ—¥æ•°ã‚’è¨˜éŒ²
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 1æ—¥ç›®ã‹ã‚‰é–‹å§‹
      const initialDay = stateManager.getProgressData().currentDay;

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã®å®Œäº†ã‚’é€šçŸ¥ã—ã€ã‚¿ãƒ¼ãƒ³çµ‚äº†ã‚’ç™ºå‹•
      eventBus.emit('ui:phase:complete', { phase: 'delivery' });

      // ã€çµæœæ¤œè¨¼ã€‘: æ—¥æ•°ãŒé€²ã‚€ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 1ã‚¿ãƒ¼ãƒ³ï¼ˆ1æ—¥ï¼‰ã®ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã™ã‚‹ã¨ã€æ¬¡ã®æ—¥ã«é€²ã‚€
      await vi.waitFor(() => {
        expect(stateManager.getProgressData().currentDay).toBe(initialDay + 1); // ã€ç¢ºèªå†…å®¹ã€‘: æ—¥æ•°ãŒ1æ—¥é€²ã‚“ã§ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-11: ã‚¿ãƒ¼ãƒ³çµ‚äº†ã§APãŒå›å¾©ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒªã‚½ãƒ¼ã‚¹å›å¾©ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¨ã€APãŒæœ€å¤§å€¤ã¾ã§å›å¾©ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ap.currentãŒap.maxã¨ç­‰ã—ããªã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: APæ¶ˆè²»æ¸ˆã¿ã®çŠ¶æ…‹ï¼ˆcurrent: 0ï¼‰
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: APãŒ0ã®çŠ¶æ…‹ã§ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†
      stateManager.updatePlayerState({ ap: { current: 0, max: 3 } });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«APãŒå…¨å›å¾©ã™ã‚‹
      eventBus.emit('ui:phase:complete', { phase: 'delivery' });

      // ã€çµæœæ¤œè¨¼ã€‘: APãŒæœ€å¤§å€¤ã¾ã§å›å¾©ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«APãŒå…¨å›å¾©ã™ã‚‹ã®ã¯ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®ä¸€éƒ¨
      await vi.waitFor(() => {
        const player = stateManager.getPlayerState();
        expect(player.ap.current).toBe(player.ap.max); // ã€ç¢ºèªå†…å®¹ã€‘: APãŒæœ€å¤§å€¤ã¾ã§å›å¾©ã—ã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-12: ã‚¿ãƒ¼ãƒ³çµ‚äº†ã§ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«æˆ»ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå¾ªç’°ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¨ã€æ¬¡ã®æ—¥ã®ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: currentPhaseãŒquest-acceptã«å¤‰æ›´ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†å¾Œã€æ¬¡ã®æ—¥ã®æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»
      eventBus.emit('ui:phase:complete', { phase: 'delivery' });

      // ã€çµæœæ¤œè¨¼ã€‘: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 1æ—¥ã®ã‚µã‚¤ã‚¯ãƒ«ãŒçµ‚ã‚ã‚‹ã¨ã€æ¬¡ã®æ—¥ã¯ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰å§‹ã¾ã‚‹
      await waitForPhase(game, 'quest-accept');
      expect(stateManager.getProgressData().currentPhase).toBe('quest-accept'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã—ã¦ã„ã‚‹ ğŸ”µ
    });

    it('TC-13: ã‚¿ãƒ¼ãƒ³çµ‚äº†ã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: UIæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£å¸¸ã«ç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¨ã€æ—¥çµ‚äº†ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: app:day:endedã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æ—¥çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç™»éŒ²
      const dayEndedCallback = vi.fn();
      eventBus.on('app:day:ended', dayEndedCallback);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹
      eventBus.emit('ui:phase:complete', { phase: 'delivery' });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãã®æ—¥ã®æˆæœã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚
      await vi.waitFor(() => {
        expect(dayEndedCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            newDay: expect.any(Number),
            summary: expect.any(Object),
          })
        ); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚µãƒãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ç™ºç«ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
      });
    });

    it('TC-14: å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆä¾é ¼å®Œäº†æ™‚ï¼‰', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ä¾é ¼ã‚’å®Œäº†ã—ãŸå¾Œã€å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: app:reward:card:selectionã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’å«ã‚€ä¾é ¼ã‚’è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠãŒå¿…è¦ãªä¾é ¼ã‚’ç”¨æ„
      stateManager.updateQuestState({
        activeQuests: [
          {
            id: 'quest_002',
            requirements: [{ itemId: 'item_001', quantity: 1 }],
            rewards: { gold: 100, exp: 50 },
            rewardCards: ['card_option_1', 'card_option_2', 'card_option_3'],
          },
        ],
        availableQuests: [],
        completedQuestIds: [],
      });
      stateManager.updateInventoryState({
        materials: [],
        items: [{ id: 'item_001', quantity: 1 }],
      });

      // ã€å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã€‘
      const rewardCardCallback = vi.fn();
      eventBus.on('app:reward:card:selection', rewardCardCallback);

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç´å“å®Ÿè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      // ã€å‡¦ç†å†…å®¹ã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’æŒã¤ä¾é ¼ã‚’ç´å“
      eventBus.emit('ui:quest:delivery:requested', {
        questId: 'quest_002',
        itemIds: ['item_001'],
      });

      // ã€çµæœæ¤œè¨¼ã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¾é ¼å®Œäº†æ™‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚
      await vi.waitFor(() => {
        expect(rewardCardCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            cards: expect.any(Array),
          })
        ); // ã€ç¢ºèªå†…å®¹ã€‘: å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ç™ºç«ã•ã‚Œã¦ã„ã‚‹ ğŸ”µ
      });
    });
  });

  describe('ãƒ•ãƒ«ã‚µã‚¤ã‚¯ãƒ«', () => {
    it('TC-15: 1ã‚¿ãƒ¼ãƒ³å…¨ä½“ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ã‚²ãƒ¼ãƒ ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ãŒçµ±åˆçš„ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã™ã¹ã¦ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’é †ç•ªã«é€²è¡Œã—ã€1ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ä¾é ¼å—æ³¨ â†’ æ¡å– â†’ èª¿åˆ â†’ ç´å“ â†’ æ¬¡ã®æ—¥ï¼ˆä¾é ¼å—æ³¨ï¼‰ã®é †ã«é·ç§»ã™ã‚‹
      // ğŸ”µ ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«: é’ä¿¡å·ï¼ˆã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«è©³ç´°ãªã‚³ãƒ¼ãƒ‰ä¾‹ã‚ã‚Šï¼‰

      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã‚’è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰1æ—¥ç›®ã‚’é–‹å§‹
      stateManager._setGameState({ currentPhase: 'quest-accept', currentDay: 1 });

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã‚’é †ç•ªã«å®Ÿè¡Œ
      // ã€å‡¦ç†å†…å®¹ã€‘: å„ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Œäº†ã—ã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸é·ç§»

      // ã€Phase 1: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã€‘
      expect(stateManager.getProgressData().currentPhase).toBe('quest-accept'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰é–‹å§‹ ğŸ”µ
      eventBus.emit('ui:phase:complete', { phase: 'quest-accept' });

      // ã€Phase 2: æ¡å–ãƒ•ã‚§ãƒ¼ã‚ºã€‘
      await waitForPhase(game, 'gathering');
      expect(stateManager.getProgressData().currentPhase).toBe('gathering'); // ã€ç¢ºèªå†…å®¹ã€‘: æ¡å–ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§» ğŸ”µ
      eventBus.emit('ui:phase:complete', { phase: 'gathering' });

      // ã€Phase 3: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã€‘
      await waitForPhase(game, 'alchemy');
      expect(stateManager.getProgressData().currentPhase).toBe('alchemy'); // ã€ç¢ºèªå†…å®¹ã€‘: èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§» ğŸ”µ
      eventBus.emit('ui:phase:complete', { phase: 'alchemy' });

      // ã€Phase 4: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã€‘
      await waitForPhase(game, 'delivery');
      expect(stateManager.getProgressData().currentPhase).toBe('delivery'); // ã€ç¢ºèªå†…å®¹ã€‘: ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§» ğŸ”µ
      eventBus.emit('ui:phase:complete', { phase: 'delivery' });

      // ã€çµæœæ¤œè¨¼ã€‘: ã‚¿ãƒ¼ãƒ³çµ‚äº†å¾Œã€æ¬¡ã®æ—¥ã®ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: 1ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹
      await vi.waitFor(() => {
        expect(stateManager.getProgressData().currentDay).toBe(2); // ã€ç¢ºèªå†…å®¹ã€‘: 2æ—¥ç›®ã«é€²ã‚“ã§ã„ã‚‹ ğŸ”µ
        expect(stateManager.getProgressData().currentPhase).toBe('quest-accept'); // ã€ç¢ºèªå†…å®¹ã€‘: ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã«æˆ»ã£ã¦ã„ã‚‹ ğŸ”µ
      });
    });
  });
});
