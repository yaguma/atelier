# TASK-0262: 1ターンサイクル統合テスト（後半） - Redフェーズ記録

**タスクID**: TASK-0262
**機能名**: 1ターンサイクル統合テスト（後半）
**フェーズ**: Red（失敗するテスト作成）
**作成日**: 2026-01-13

---

## 1. 作成したテストケースの一覧

### 1.1 調合フェーズ - 正常系（5テストケース）

| No | テストケースID | テスト名 | 状態 | 信頼性 |
|----|--------------|---------|------|-------|
| 1 | TC-01 | レシピカードが手札に表示される | ✅ 成功 | 🔵 |
| 2 | TC-02 | アイテムを調合できる | ❌ 失敗 | 🔵 |
| 3 | TC-03 | 調合で素材が消費される | ❌ 失敗 | 🔵 |
| 4 | TC-04 | 調合結果に品質が反映される | ❌ 失敗 | 🔵 |
| 5 | TC-05 | 調合フェーズ完了で納品フェーズに遷移する | ❌ 失敗 | 🔵 |

### 1.2 納品フェーズ - 正常系（4テストケース）

| No | テストケースID | テスト名 | 状態 | 信頼性 |
|----|--------------|---------|------|-------|
| 6 | TC-06 | 受注中の依頼が表示される | ✅ 成功 | 🔵 |
| 7 | TC-07 | 依頼を納品できる | ❌ 失敗 | 🔵 |
| 8 | TC-08 | 納品で報酬を獲得する | ❌ 失敗 | 🔵 |
| 9 | TC-09 | 納品でアイテムが消費される | ❌ 失敗 | 🔵 |

### 1.3 ターン終了 - 正常系（5テストケース）

| No | テストケースID | テスト名 | 状態 | 信頼性 |
|----|--------------|---------|------|-------|
| 10 | TC-10 | フェーズ完了でターンが終了する | ❌ 失敗 | 🔵 |
| 11 | TC-11 | ターン終了でAPが回復する | ❌ 失敗 | 🔵 |
| 12 | TC-12 | ターン終了で依頼受注フェーズに戻る | ❌ 失敗 | 🔵 |
| 13 | TC-13 | ターン終了サマリーが表示される | ❌ 失敗 | 🔵 |
| 14 | TC-14 | 報酬カード選択ダイアログが表示される | ❌ 失敗 | 🔵 |

### 1.4 フルサイクル - 正常系（1テストケース）

| No | テストケースID | テスト名 | 状態 | 信頼性 |
|----|--------------|---------|------|-------|
| 15 | TC-15 | 1ターン全体が正常に完了する | ❌ 失敗 | 🔵 |

### 1.5 異常系・境界値（3テストケース）

| No | テストケースID | テスト名 | 状態 | 信頼性 |
|----|--------------|---------|------|-------|
| 16 | TC-16 | 素材不足時は調合できない | ❌ 失敗 | 🔵 |
| 17 | TC-17 | 必要アイテム不足時は納品できない | ❌ 失敗 | 🔵 |
| 18 | TC-18 | 素材ちょうど0個の状態で調合できない | ❌ 失敗 | 🔵 |

---

## 2. テスト実行結果サマリー

```
Test Files: 1 failed (1)
Tests: 16 failed | 2 passed (18)
Duration: 31.74s
```

### 2.1 成功したテスト（2個）

- **TC-01: レシピカードが手札に表示される**
  - 理由: StateManagerのモックが正しく動作し、手札のデッキ状態を取得できた

- **TC-06: 受注中の依頼が表示される**
  - 理由: StateManagerのモックが正しく動作し、依頼状態を取得できた

### 2.2 失敗したテスト（16個）

失敗の理由は、以下の実装が未完了であるため：

1. **調合関連のイベントハンドラ未実装**
   - `ui:alchemy:craft:requested` イベントのハンドラが存在しない
   - 調合処理ロジックが実装されていない

2. **納品関連のイベントハンドラ未実装**
   - `ui:quest:delivery:requested` イベントのハンドラが存在しない
   - 納品処理ロジックが実装されていない

3. **フェーズ遷移ロジック未実装**
   - `ui:phase:complete` イベントのハンドラが存在しない
   - フェーズ遷移処理が実装されていない

4. **ターン終了処理未実装**
   - 日数進行処理が実装されていない
   - AP回復処理が実装されていない
   - サマリーイベント発火が実装されていない

---

## 3. テストコードの全文

テストファイル: `tests/integration/phaser/phase5/TurnCycleSecondHalf.test.ts`

```typescript
/**
 * Phase5 1ターンサイクル統合テスト（後半）
 *
 * TASK-0262: 1ターンサイクル統合テスト（後半）
 * 1ターン（1日）のゲームサイクルの後半部分（調合フェーズ、納品フェーズ、ターン終了処理）が
 * 正しく動作することを検証する統合テスト。
 */

// ... 全テストコードは実装済み（約650行）
```

詳細: `tests/integration/phaser/phase5/TurnCycleSecondHalf.test.ts` 参照

---

## 4. 期待される失敗内容

### 4.1 調合フェーズの失敗

**TC-02: アイテムを調合できる**
```
AssertionError: expected 0 to be greater than 0
```
- 原因: 調合処理が実装されていないため、アイテムが追加されない

**TC-03: 調合で素材が消費される**
```
AssertionError: expected 5 to be 3 // Object.is equality
```
- 原因: 素材消費処理が実装されていないため、素材数が減少しない

**TC-04: 調合結果に品質が反映される**
```
AssertionError: expected undefined to be defined
```
- 原因: 調合処理が実装されていないため、アイテムが作成されない

**TC-05: 調合フェーズ完了で納品フェーズに遷移する**
```
Error: Phase is alchemy, waiting for delivery
```
- 原因: フェーズ遷移処理が実装されていない

**TC-16: 素材不足時は調合できない**
```
AssertionError: expected "spy" to be called with arguments
Number of calls: 0
```
- 原因: エラーハンドリング処理が実装されていない

**TC-18: 素材ちょうど0個の状態で調合できない**
```
AssertionError: expected "spy" to be called at least once
```
- 原因: エラーハンドリング処理が実装されていない

### 4.2 納品フェーズの失敗

**TC-07: 依頼を納品できる**
```
AssertionError: expected [] to include 'quest_001'
```
- 原因: 納品処理が実装されていないため、依頼状態が更新されない

**TC-08: 納品で報酬を獲得する**
```
AssertionError: expected 100 to be 200 // Object.is equality
```
- 原因: 報酬付与処理が実装されていないため、ゴールドが増加しない

**TC-09: 納品でアイテムが消費される**
```
AssertionError: expected { id: 'potion_001', ... } to be undefined
```
- 原因: アイテム消費処理が実装されていないため、アイテムが削除されない

**TC-17: 必要アイテム不足時は納品できない**
```
AssertionError: expected "spy" to be called at least once
```
- 原因: エラーハンドリング処理が実装されていない

### 4.3 ターン終了の失敗

**TC-10: フェーズ完了でターンが終了する**
```
AssertionError: expected 1 to be 2 // Object.is equality
```
- 原因: 日数進行処理が実装されていない

**TC-11: ターン終了でAPが回復する**
```
AssertionError: expected +0 to be 3 // Object.is equality
```
- 原因: AP回復処理が実装されていない

**TC-12: ターン終了で依頼受注フェーズに戻る**
```
Error: Phase is delivery, waiting for quest-accept
```
- 原因: フェーズ循環処理が実装されていない

**TC-13: ターン終了サマリーが表示される**
```
AssertionError: expected "spy" to be called with arguments
Number of calls: 0
```
- 原因: サマリーイベント発火が実装されていない

**TC-14: 報酬カード選択ダイアログが表示される**
```
AssertionError: expected "spy" to be called with arguments
Number of calls: 0
```
- 原因: 報酬カード選択イベント発火が実装されていない

### 4.4 フルサイクルの失敗

**TC-15: 1ターン全体が正常に完了する**
```
Error: Phase is quest-accept, waiting for gathering
```
- 原因: フェーズ遷移処理が実装されていないため、最初のフェーズ完了で遷移できない

---

## 5. Greenフェーズで実装すべき内容

### 5.1 調合関連の実装

1. **調合イベントハンドラの実装**
   ```typescript
   eventBus.on('ui:alchemy:craft:requested', ({ recipeCardId, materialIds }) => {
     // 1. 素材の存在確認
     // 2. 素材不足の場合はエラーイベント発火
     // 3. 調合処理を実行
     // 4. 素材を消費
     // 5. アイテムを作成（品質計算）
     // 6. インベントリを更新
     // 7. 調合完了イベントを発火
   });
   ```

2. **エラーハンドリング**
   - 素材不足時に `app:error:occurred` イベントを発火
   - エラーメッセージに「素材」を含める

### 5.2 納品関連の実装

1. **納品イベントハンドラの実装**
   ```typescript
   eventBus.on('ui:quest:delivery:requested', ({ questId, itemIds }) => {
     // 1. 依頼の存在確認
     // 2. アイテムの存在確認
     // 3. アイテム不足の場合はエラーイベント発火
     // 4. アイテムを消費
     // 5. 報酬を付与（ゴールド・経験値）
     // 6. 依頼を完了状態に遷移
     // 7. 報酬カードがある場合は選択イベントを発火
     // 8. 納品完了イベントを発火
   });
   ```

2. **エラーハンドリング**
   - アイテム不足時に `app:error:occurred` イベントを発火

### 5.3 フェーズ遷移の実装

1. **フェーズ完了イベントハンドラの実装**
   ```typescript
   eventBus.on('ui:phase:complete', ({ phase }) => {
     // フェーズ遷移マップ
     const phaseTransitionMap: Record<string, string> = {
       'quest-accept': 'gathering',
       'gathering': 'alchemy',
       'alchemy': 'delivery',
       'delivery': 'quest-accept', // 次の日
     };

     const nextPhase = phaseTransitionMap[phase];

     if (phase === 'delivery') {
       // ターン終了処理
       // 1. 日数を+1
       // 2. APを回復
       // 3. サマリーイベント発火
     }

     // 次のフェーズに遷移
     stateManager.updateGameState({ currentPhase: nextPhase });
   });
   ```

### 5.4 ターン終了処理の実装

1. **日数進行処理**
   - `currentDay` を +1 増加

2. **AP回復処理**
   - `ap.current` を `ap.max` に設定

3. **サマリーイベント発火**
   ```typescript
   eventBus.emit('app:day:ended', {
     newDay: currentDay + 1,
     summary: {
       // サマリー内容
     },
   });
   ```

---

## 6. 実装の優先順位

### Phase 1: 調合フェーズの実装（高優先度）
- TC-02, TC-03, TC-04, TC-16, TC-18 を通す実装
- 調合処理の基本ロジック
- エラーハンドリング

### Phase 2: 納品フェーズの実装（高優先度）
- TC-07, TC-08, TC-09, TC-17 を通す実装
- 納品処理の基本ロジック
- 報酬付与処理
- エラーハンドリング

### Phase 3: フェーズ遷移の実装（高優先度）
- TC-05, TC-12 を通す実装
- フェーズ遷移ロジック

### Phase 4: ターン終了処理の実装（中優先度）
- TC-10, TC-11, TC-13 を通す実装
- 日数進行
- AP回復
- サマリーイベント

### Phase 5: 報酬カード選択の実装（低優先度）
- TC-14 を通す実装
- 報酬カード選択イベント発火

### Phase 6: フルサイクルの統合（最終確認）
- TC-15 を通す実装
- すべてのフェーズが連携して動作することを確認

---

## 7. 品質判定結果

### 7.1 テスト品質評価

✅ **高品質**

**評価基準**:
- ✅ テスト実行: 実行可能で失敗することを確認済み
- ✅ 期待値: 明確で具体的
- ✅ アサーション: 適切
- ✅ 実装方針: 明確
- ✅ 信頼性レベル: 🔵（青信号）が18/18（100%）

### 7.2 テストケースの網羅性

| カテゴリ | 目標 | 実装数 | 達成率 |
|---------|-----|-------|-------|
| 調合フェーズ - 正常系 | 5 | 5 | 100% |
| 納品フェーズ - 正常系 | 4 | 4 | 100% |
| ターン終了 - 正常系 | 5 | 5 | 100% |
| フルサイクル - 正常系 | 1 | 1 | 100% |
| 異常系 | 2 | 2 | 100% |
| 境界値 | 1 | 1 | 100% |
| **合計** | **18** | **18** | **100%** |

### 7.3 信頼性レベル評価

- **総テストケース数**: 18項目
- 🔵 **青信号**: 18項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

---

## 8. 日本語コメントの品質

### 8.1 コメント記載状況

✅ **すべてのテストケースに必須コメントを記載**

- ✅ テスト目的
- ✅ テスト内容
- ✅ 期待される動作
- ✅ 信頼性レベル（🔵）
- ✅ テストデータ準備の理由
- ✅ 初期条件設定の説明
- ✅ 実際の処理実行の説明
- ✅ 処理内容の説明
- ✅ 結果検証の説明
- ✅ 期待値確認の理由
- ✅ 各expectステートメントの確認内容

### 8.2 コメント品質評価

✅ **高品質**

- コメントが分かりやすく、テストの意図が明確
- 信頼性レベルが適切に記載されている
- Given-When-Thenパターンに沿ったコメント構造
- 各アサーションに具体的な確認内容が記載されている

---

## 9. 次のステップ

### 9.1 推奨される次のアクション

次のコマンドで**Greenフェーズ（最小実装）**を開始してください：

```bash
/tdd-green atelier-guild-rank-phaser TASK-0262
```

### 9.2 実装時の注意事項

1. **最小実装を心がける**
   - テストを通すために必要最小限のコードを書く
   - 過度な最適化は避ける

2. **1つずつテストを通す**
   - Phase 1（調合フェーズ）から順番に実装
   - 各フェーズのテストが通ったことを確認してから次に進む

3. **既存パターンの活用**
   - TASK-0261（前半テスト）の実装パターンを参考にする
   - イベントハンドラの構造を統一する

4. **エラーハンドリングの徹底**
   - 異常系テストを必ず通す
   - エラーメッセージを分かりやすくする

---

## 10. 関連文書

- **タスクファイル**: `docs/tasks/atelier-guild-rank-phaser/TASK-0262.md`
- **要件定義書**: `docs/implements/atelier-guild-rank-phaser/TASK-0262/turn-cycle-second-half-requirements.md`
- **テストケース定義書**: `docs/implements/atelier-guild-rank-phaser/TASK-0262/turn-cycle-second-half-testcases.md`
- **タスクノート**: `docs/implements/atelier-guild-rank-phaser/TASK-0262/note.md`
- **テストファイル**: `tests/integration/phaser/phase5/TurnCycleSecondHalf.test.ts`
- **前半テスト参考**: `tests/integration/phaser/phase5/TurnCycleFirstHalf.test.ts`

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-13 | 1.0.0 | Redフェーズ記録作成 |
