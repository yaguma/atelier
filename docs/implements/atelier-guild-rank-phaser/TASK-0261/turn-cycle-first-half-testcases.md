# TDDテストケース：1ターンサイクル統合テスト（前半）

**タスクID**: TASK-0261
**作成日**: 2026-01-13
**機能名**: 1ターンサイクル統合テスト（前半）- 依頼受注・採取フェーズ
**出力ファイル名**: `tests/integration/phaser/phase5/TurnCycleFirstHalf.test.ts`

---

## テストケース作成対象の情報

- **機能名**: 1ターンサイクル統合テスト（前半）
- **タスクID**: TASK-0261
- **要件名**: atelier-guild-rank-phaser
- **プログラミング言語**: TypeScript 5.x
- **テストフレームワーク**: Vitest

---

## 1. 正常系テストケース（基本的な動作）

### TC-01: 依頼受注フェーズ - 依頼一覧表示

- **テスト名**: 依頼受注フェーズで依頼一覧が正しく表示される
  - **何をテストするか**: ゲーム開始後、依頼受注フェーズに入ると利用可能な依頼が表示されること
  - **期待される動作**: StateManagerから取得した利用可能な依頼リストが空でないこと
- **入力値**: ゲーム開始イベント `ui:game:start:requested` with `{ isNewGame: true }`
  - **入力データの意味**: 新規ゲームを開始し、依頼受注フェーズから始まることを想定
- **期待される結果**: `stateManager.getQuests().available.length > 0`
  - **期待結果の理由**: 初期状態では必ず利用可能な依頼が存在する（マスターデータに依存）
- **テストの目的**: 依頼受注フェーズの初期表示が正しく動作することを確認
  - **確認ポイント**: StateManagerから正しく依頼データを取得できているか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 2. 入力・出力の仕様）

---

### TC-02: 依頼受注フェーズ - 依頼受注成功

- **テスト名**: 依頼を正常に受注できる
  - **何をテストするか**: 利用可能な依頼を選択して受注リクエストを送信すると、その依頼が受注済み依頼リストに追加されること
  - **期待される動作**: 受注済み依頼リストに選択した依頼が追加され、利用可能な依頼リストから削除される
- **入力値**: 依頼受注イベント `ui:quest:accept:requested` with `{ questId: quests.available[0].id }`
  - **入力データの意味**: 利用可能な依頼リストの最初の依頼を受注する
- **期待される結果**:
  - `stateManager.getQuests().accepted` に受注した依頼が含まれる
  - `stateManager.getQuests().available` から受注した依頼が削除される
  - **期待結果の理由**: 依頼受注処理により、依頼が利用可能リストから受注済みリストへ移動する
- **テストの目的**: 依頼受注機能が正しく動作することを確認
  - **確認ポイント**: EventBusを介した依頼受注リクエストが正しく処理されるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.1 依頼受注フェーズの基本フロー）

---

### TC-03: 依頼受注フェーズ - フェーズスキップ

- **テスト名**: 依頼受注フェーズをスキップして採取フェーズに遷移できる
  - **何をテストするか**: 依頼を受注せずにフェーズスキップボタンをクリックすると、採取フェーズに遷移すること
  - **期待される動作**: 現在のフェーズが「gathering」に変更され、採取フェーズが開始される
- **入力値**: フェーズスキップイベント `ui:phase:skip:requested` with `{ phase: 'quest-accept' }`
  - **入力データの意味**: 依頼受注フェーズをスキップして次のフェーズへ進む
- **期待される結果**: `stateManager.getProgress().currentPhase === 'gathering'`
  - **期待結果の理由**: フェーズスキップにより、次のフェーズ（採取フェーズ）に自動的に遷移する
- **テストの目的**: フェーズスキップ機能が正しく動作することを確認
  - **確認ポイント**: フェーズ遷移が正しく行われ、状態が更新されるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.3 フェーズスキップ）

---

### TC-04: 依頼受注フェーズ - フェーズ完了による遷移

- **テスト名**: 依頼受注フェーズ完了後、採取フェーズに遷移する
  - **何をテストするか**: 依頼受注フェーズの完了イベントを発火すると、採取フェーズに遷移すること
  - **期待される動作**: 現在のフェーズが「gathering」に変更され、採取フェーズが開始される
- **入力値**: フェーズ完了イベント `ui:phase:complete` with `{ phase: 'quest-accept' }`
  - **入力データの意味**: 依頼受注フェーズを完了し、次のフェーズへ進む
- **期待される結果**: `stateManager.getProgress().currentPhase === 'gathering'`
  - **期待結果の理由**: フェーズ完了により、次のフェーズ（採取フェーズ）に自動的に遷移する
- **テストの目的**: フェーズ完了による遷移が正しく動作することを確認
  - **確認ポイント**: フェーズ遷移のシーケンスが設計通りに動作するか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.4 フェーズ完了による遷移）

---

### TC-05: 採取フェーズ - 採取地カード表示

- **テスト名**: 採取フェーズで採取地カードが手札に表示される
  - **何をテストするか**: 採取フェーズに遷移すると、手札に採取地カードが存在すること（初期デッキに依存）
  - **期待される動作**: 手札の中に`type === 'gathering'`のカードが1枚以上存在する
- **入力値**: フェーズ遷移により採取フェーズに到達
  - **入力データの意味**: 依頼受注フェーズから採取フェーズへの自然な遷移
- **期待される結果**: `deck.hand.filter(c => c.type === 'gathering').length >= 0`
  - **期待結果の理由**: 初期デッキの構成により、採取地カードが手札に含まれる可能性がある（必須ではない）
- **テストの目的**: 採取フェーズの初期表示が正しく動作することを確認
  - **確認ポイント**: デッキ状態が正しく取得できるか（採取カードがない場合はテストをスキップ）
- 🟡 **信頼性レベル**: 黄信号（初期デッキの内容に依存するため、妥当な推測 - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 初期デッキ依存の制約）

---

### TC-06: 採取フェーズ - 採取実行と素材獲得

- **テスト名**: 採取カードを使用して素材を獲得できる
  - **何をテストするか**: 採取地カードを使用して素材選択を行うと、インベントリに素材が追加され、APが消費されること
  - **期待される動作**: 素材数が増加し、現在のAPが減少する
- **入力値**: 採取実行イベント `ui:gathering:execute:requested` with `{ cardId: gatheringCard.id, selectedMaterialIds: ['material_option_1'] }`
  - **入力データの意味**: 手札の採取地カードを使用し、素材選択肢から1つを選択する
- **期待される結果**:
  - `stateManager.getInventory().materials.length` が採取前より増加
  - `stateManager.getPlayerData().ap.current` が採取前より減少
  - **期待結果の理由**: 採取処理により素材が獲得され、APが消費される
- **テストの目的**: 採取機能の基本動作が正しく実装されていることを確認
  - **確認ポイント**: 採取処理が正しく実行され、状態が適切に更新されるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.2 採取フェーズの基本フロー）

---

### TC-07: 採取フェーズ - カードの手札から捨て札への移動

- **テスト名**: 使用した採取カードが手札から捨て札に移動する
  - **何をテストするか**: 採取カードを使用すると、そのカードが手札から削除され、捨て札に追加されること
  - **期待される動作**: 手札から使用したカードが消え、捨て札に同じカードが追加される
- **入力値**: 採取実行イベント `ui:gathering:execute:requested` with `{ cardId: gatheringCard.id, selectedMaterialIds: ['material_option_1'] }`
  - **入力データの意味**: 手札の採取地カードを使用する
- **期待される結果**:
  - `updatedDeck.hand` に使用したカードが含まれない
  - `updatedDeck.discard` に使用したカードが含まれる
  - **期待結果の理由**: デッキ管理システムにより、使用したカードは捨て札に移動する
- **テストの目的**: デッキ管理機能が正しく動作することを確認
  - **確認ポイント**: カードの状態遷移（手札→捨て札）が正しく行われるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `dataflow.md` - 2.1 カード使用フロー）

---

### TC-08: 採取フェーズ - フェーズスキップ

- **テスト名**: 採取フェーズをスキップして調合フェーズに遷移できる
  - **何をテストするか**: 採取を実行せずにフェーズスキップボタンをクリックすると、調合フェーズに遷移すること
  - **期待される動作**: 現在のフェーズが「alchemy」に変更され、調合フェーズが開始される
- **入力値**: フェーズスキップイベント `ui:phase:skip:requested` with `{ phase: 'gathering' }`
  - **入力データの意味**: 採取フェーズをスキップして次のフェーズへ進む
- **期待される結果**: `stateManager.getProgress().currentPhase === 'alchemy'`
  - **期待結果の理由**: フェーズスキップにより、次のフェーズ（調合フェーズ）に自動的に遷移する
- **テストの目的**: フェーズスキップ機能が採取フェーズでも正しく動作することを確認
  - **確認ポイント**: 複数フェーズでスキップ機能が一貫して動作するか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.3 フェーズスキップ）

---

### TC-09: 採取フェーズ - フェーズ完了による遷移

- **テスト名**: 採取フェーズ完了後、調合フェーズに遷移する
  - **何をテストするか**: 採取フェーズの完了イベントを発火すると、調合フェーズに遷移すること
  - **期待される動作**: 現在のフェーズが「alchemy」に変更され、調合フェーズが開始される
- **入力値**: フェーズ完了イベント `ui:phase:complete` with `{ phase: 'gathering' }`
  - **入力データの意味**: 採取フェーズを完了し、次のフェーズへ進む
- **期待される結果**: `stateManager.getProgress().currentPhase === 'alchemy'`
  - **期待結果の理由**: フェーズ完了により、次のフェーズ（調合フェーズ）に自動的に遷移する
- **テストの目的**: フェーズ完了による遷移が採取フェーズでも正しく動作することを確認
  - **確認ポイント**: フェーズ遷移のシーケンスが一貫して動作するか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.4 フェーズ完了による遷移）

---

### TC-10: フェーズ遷移時の状態保持 - 素材保持

- **テスト名**: フェーズ遷移後も獲得した素材が保持される
  - **何をテストするか**: 採取フェーズで素材を獲得した後、調合フェーズに遷移しても素材が保持されること
  - **期待される動作**: 採取フェーズで獲得した素材が調合フェーズでも存在する
- **入力値**:
  1. 採取実行により素材獲得
  2. フェーズ完了イベント `ui:phase:complete` with `{ phase: 'gathering' }`
  - **入力データの意味**: 採取後にフェーズを進めて状態保持を確認
- **期待される結果**: `materialsAfterTransition === materialsBeforeTransition`
  - **期待結果の理由**: StateManagerがフェーズを跨いで状態を正しく保持する
- **テストの目的**: フェーズ遷移時の状態保持機能が正しく動作することを確認
  - **確認ポイント**: インベントリ状態がフェーズを跨いで一貫して保持されるか
- 🟡 **信頼性レベル**: 黄信号（設計文書から妥当な推測 - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - フェーズ遷移の制約）

---

### TC-11: フェーズ遷移時の状態保持 - 依頼保持

- **テスト名**: 受注した依頼がフェーズを跨いで保持される
  - **何をテストするか**: 依頼受注フェーズで依頼を受注した後、複数フェーズを跨いでも受注済み依頼が保持されること
  - **期待される動作**: 依頼受注フェーズで受注した依頼が調合フェーズでも受注済み依頼リストに存在する
- **入力値**:
  1. 依頼受注イベント `ui:quest:accept:requested`
  2. フェーズ完了イベント（quest-accept → gathering → alchemy）
  - **入力データの意味**: 依頼受注後に複数フェーズを経由して状態保持を確認
- **期待される結果**: `acceptedAfter === acceptedBefore`
  - **期待結果の理由**: StateManagerが受注済み依頼をフェーズを跨いで正しく保持する
- **テストの目的**: フェーズ遷移時の依頼状態保持機能が正しく動作することを確認
  - **確認ポイント**: クエスト状態がフェーズを跨いで一貫して保持されるか
- 🟡 **信頼性レベル**: 黄信号（設計文書から妥当な推測 - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - フェーズ遷移の制約）

---

### TC-12: EventBus通信 - 依頼受注時のイベント発火

- **テスト名**: 依頼受注時に正しいイベントが発火される
  - **何をテストするか**: 依頼を受注すると`app:quests:accepted:updated`イベントが発火されること
  - **期待される動作**: EventBusで`app:quests:accepted:updated`イベントが発火され、リスナーが呼ばれる
- **入力値**: 依頼受注イベント `ui:quest:accept:requested` with `{ questId: quests.available[0].id }`
  - **入力データの意味**: 依頼受注リクエストを送信し、イベント発火を確認
- **期待される結果**: `questAcceptedCallback` が呼ばれる
  - **期待結果の理由**: EventBusによる通知パターンで、依頼受注時に状態更新イベントが発火される
- **テストの目的**: EventBus通信が正しく動作することを確認
  - **確認ポイント**: UI→Application層の通信が正しく行われるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `core-systems.md` - 2.3 イベント定義）

---

### TC-13: EventBus通信 - 採取実行時のイベント発火

- **テスト名**: 採取実行時に正しいイベントが発火される
  - **何をテストするか**: 採取を実行すると`app:gathering:complete`イベントが発火され、素材とAP使用量の情報が含まれること
  - **期待される動作**: EventBusで`app:gathering:complete`イベントが発火され、ペイロードに素材配列とAP使用量が含まれる
- **入力値**: 採取実行イベント `ui:gathering:execute:requested` with `{ cardId: gatheringCard.id, selectedMaterialIds: ['material_option_1'] }`
  - **入力データの意味**: 採取実行リクエストを送信し、完了イベントの発火を確認
- **期待される結果**: `gatheringCompleteCallback` が `{ materials: Array, apUsed: Number }` を含むペイロードで呼ばれる
  - **期待結果の理由**: EventBusによる通知パターンで、採取完了時に結果情報を含むイベントが発火される
- **テストの目的**: EventBus通信が正しく動作し、適切なペイロードが渡されることを確認
  - **確認ポイント**: Application層からUIへの通知が正しく行われるか
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `core-systems.md` - 2.3 イベント定義、`dataflow.md` - 2.2 採取フロー）

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-14: 依頼受注フェーズ - 最大受注数制限

- **テスト名**: 最大3つまでしか依頼を受注できない
  - **エラーケースの概要**: 既に3つの依頼を受注済みの状態で4つ目の依頼を受注しようとする
  - **エラー処理の重要性**: ゲームバランスを保つため、受注数制限は必須の仕様
- **入力値**:
  1. 3つの依頼を受注
  2. 4つ目の依頼受注リクエスト `ui:quest:accept:requested`
  - **不正な理由**: 最大受注数（3つ）を超えるため
  - **実際の発生シナリオ**: プレイヤーが制限を超えて依頼を受注しようとした場合
- **期待される結果**: `app:error:occurred` イベントが発火され、エラーメッセージに「最大」が含まれる
  - **エラーメッセージの内容**: 「最大3つまで依頼を受注できます」のような分かりやすいメッセージ
  - **システムの安全性**: 受注済み依頼が3つのままで、不正な受注が拒否される
- **テストの目的**: 依頼受注数の制限が正しく機能することを確認
  - **品質保証の観点**: ゲームルールの整合性を保証し、想定外の動作を防ぐ
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 依頼受注の制約）

---

### TC-15: 採取フェーズ - AP不足時の採取不可

- **テスト名**: AP不足時は採取を実行できない
  - **エラーケースの概要**: 現在のAPが0の状態で採取カードを使用しようとする
  - **エラー処理の重要性**: リソース管理を正しく行うため、AP消費の制限は必須
- **入力値**:
  1. APを0に設定 `stateManager.updatePlayer({ ap: { current: 0, max: 3 } })`
  2. 採取実行リクエスト `ui:gathering:execute:requested`
  - **不正な理由**: 採取には最低1APが必要だが、現在のAPが0のため
  - **実際の発生シナリオ**: プレイヤーがAPを使い切った後に採取を試みた場合
- **期待される結果**: `app:error:occurred` イベントが発火され、エラーメッセージに「AP」が含まれる
  - **エラーメッセージの内容**: 「APが不足しています」のような分かりやすいメッセージ
  - **システムの安全性**: 素材が獲得されず、APが負の値にならない
- **テストの目的**: AP消費の制限が正しく機能することを確認
  - **品質保証の観点**: リソース管理の整合性を保証し、バグを防ぐ
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 採取の制約）

---

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-16: 依頼受注フェーズ - 依頼0件受注でのスキップ

- **テスト名**: 依頼を1つも受注せずにフェーズをスキップできる
  - **境界値の意味**: 受注数の最小値（0件）での動作確認
  - **境界値での動作保証**: 依頼を受注しない場合でもゲームが正常に進行する
- **入力値**: フェーズスキップイベント `ui:phase:skip:requested` with `{ phase: 'quest-accept' }`
  - **境界値選択の根拠**: 受注数0は有効な状態であり、スキップ可能な境界値
  - **実際の使用場面**: プレイヤーが依頼を受注せずに進めたい場合
- **期待される結果**: `stateManager.getProgress().currentPhase === 'gathering'`
  - **境界での正確性**: 受注数が0でもフェーズ遷移が正常に動作する
  - **一貫した動作**: 受注数に関わらず、スキップ機能は一貫して動作する
- **テストの目的**: 最小値（受注数0）での動作の安定性を確認
  - **堅牢性の確認**: 極端な条件下でもシステムが安定動作する
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 4.3 フェーズスキップ）

---

### TC-17: 依頼受注フェーズ - 依頼3件受注での境界値

- **テスト名**: ちょうど3件の依頼を受注した状態で次のフェーズに進める
  - **境界値の意味**: 受注数の最大値（3件）での動作確認
  - **境界値での動作保証**: 最大受注数でもゲームが正常に進行する
- **入力値**:
  1. 3つの依頼を受注
  2. フェーズ完了イベント `ui:phase:complete` with `{ phase: 'quest-accept' }`
  - **境界値選択の根拠**: 受注数3は最大値であり、正常な境界値
  - **実際の使用場面**: プレイヤーが最大数の依頼を受注して進めた場合
- **期待される結果**:
  - `stateManager.getQuests().accepted.length === 3`
  - `stateManager.getProgress().currentPhase === 'gathering'`
  - **境界での正確性**: 最大受注数でもフェーズ遷移が正常に動作する
  - **一貫した動作**: 受注数が最大値でも、フェーズ完了処理は正常に動作する
- **テストの目的**: 最大値（受注数3）での動作の安定性を確認
  - **堅牢性の確認**: 最大値付近でもシステムが安定動作する
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 依頼受注の制約）

---

### TC-18: 採取フェーズ - AP最大値（3）での採取実行

- **テスト名**: AP最大値の状態で採取を実行できる
  - **境界値の意味**: AP最大値（3）での採取実行を確認
  - **境界値での動作保証**: AP満タンの状態で採取が正常に動作する
- **入力値**:
  1. APを最大値に設定（初期状態で3）
  2. 採取実行リクエスト `ui:gathering:execute:requested`
  - **境界値選択の根拠**: AP最大値は採取可能な境界値
  - **実際の使用場面**: ゲーム開始直後や日数開始時にAPが満タンの状態
- **期待される結果**:
  - 素材が獲得される
  - APが減少する（例: 3 → 2）
  - **境界での正確性**: AP最大値でも採取処理が正常に動作する
  - **一貫した動作**: APの値に関わらず、採取処理は一貫して動作する
- **テストの目的**: AP最大値での動作の安定性を確認
  - **堅牢性の確認**: 境界値でもシステムが安定動作する
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 採取の制約）

---

### TC-19: 採取フェーズ - AP残り1での採取実行

- **テスト名**: AP残り1の状態で採取を実行できる
  - **境界値の意味**: AP最小値（1）での採取実行を確認
  - **境界値での動作保証**: AP最小限の状態で採取が正常に動作する
- **入力値**:
  1. APを1に設定 `stateManager.updatePlayer({ ap: { current: 1, max: 3 } })`
  2. 採取実行リクエスト `ui:gathering:execute:requested`
  - **境界値選択の根拠**: AP1は採取可能な最小値
  - **実際の使用場面**: プレイヤーがAPを使い切る直前の状態
- **期待される結果**:
  - 素材が獲得される
  - APが0になる（1 → 0）
  - **境界での正確性**: AP最小値（1）でも採取処理が正常に動作する
  - **一貫した動作**: APが1の場合も、採取処理は正常に完了する
- **テストの目的**: AP最小値（1）での動作の安定性を確認
  - **堅牢性の確認**: 極端な条件下でもシステムが安定動作する
- 🔵 **信頼性レベル**: 青信号（設計文書に明確な記載あり - `turn-cycle-first-half-requirements.md` - 3. 制約条件 - 採取の制約）

---

### TC-20: 採取フェーズ - 手札にカードがない場合のスキップ

- **テスト名**: 手札に採取カードがない場合、テストをスキップする
  - **境界値の意味**: 採取カード数の最小値（0枚）での動作確認
  - **境界値での動作保証**: 採取カードがなくてもゲームが正常に進行する
- **入力値**: 採取カード検索 `deck.hand.find(c => c.type === 'gathering')`
  - **境界値選択の根拠**: 採取カードが手札にない場合は有効な状態
  - **実際の使用場面**: 初期デッキの構成により、採取カードが手札にない場合がある
- **期待される結果**: テストがスキップされる（`if (!gatheringCard) return;`）
  - **境界での正確性**: 採取カードがない場合、テストは実行されない
  - **一貫した動作**: テストの実行条件に応じて適切にスキップされる
- **テストの目的**: 境界条件（カード0枚）での堅牢性を確認
  - **堅牢性の確認**: テスト環境の不確定要素に対応できる
- 🟡 **信頼性レベル**: 黄信号（初期デッキの内容に依存するため、妥当な推測 - `turn-cycle-first-half-requirements.md` - 4.7 カードが手札にない場合）

---

## 4. 開発言語・フレームワーク

- **プログラミング言語**: TypeScript 5.x
  - **言語選択の理由**: Phaser 3.87+の推奨言語であり、型安全性が高い
  - **テストに適した機能**: 型推論により、テストコードの品質が向上する
- **テストフレームワーク**: Vitest
  - **フレームワーク選択の理由**: Viteベースのプロジェクトと相性が良く、高速なテスト実行が可能
  - **テスト実行環境**: jsdom環境でPhaserモックを使用してテストを実行
- 🔵 **信頼性レベル**: 青信号（`CLAUDE.md` - HTML版 (atelier-guild-rank-html/)、`note.md` - 1. 技術スタック）

---

## 5. テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```typescript
// 【テスト目的】: 依頼受注フェーズで依頼一覧が正しく表示されることを確認する
// 【テスト内容】: ゲーム開始後、依頼受注フェーズに遷移し、利用可能な依頼が存在することを検証する
// 【期待される動作】: StateManagerから取得した利用可能な依頼リストが空でないこと
// 🔵 信頼性レベル: 青信号（設計文書に明確な記載あり）
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: ゲームインスタンスを作成し、依頼受注フェーズまで遷移する
// 【初期条件設定】: 新規ゲームを開始し、依頼受注フェーズがアクティブな状態にする
// 【前提条件確認】: ゲームが正常に初期化され、依頼受注フェーズに到達していることを確認
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: 依頼受注リクエストイベントを発火する
// 【処理内容】: EventBus経由で依頼IDを指定して受注リクエストを送信する
// 【実行タイミング】: 依頼一覧が表示された後、ユーザーが依頼を選択したタイミングを想定
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: 依頼が受注済みリストに追加され、利用可能リストから削除されることを確認
// 【期待値確認】: 受注済み依頼数が1増加し、利用可能依頼数が1減少することを検証
// 【品質保証】: この検証により、依頼受注処理が正しく動作し、状態が適切に更新されることを保証
```

### 各expectステートメントのコメント

```typescript
// 【検証項目】: 受注済み依頼リストに選択した依頼が含まれる
// 🔵 信頼性レベル: 青信号
expect(updatedQuests.accepted).toContainEqual(
  expect.objectContaining({ id: questToAccept.id })
); // 【確認内容】: 受注した依頼が受注済みリストに正しく追加されることを確認

// 【検証項目】: 利用可能な依頼リストから選択した依頼が削除される
// 🔵 信頼性レベル: 青信号
expect(updatedQuests.available).not.toContainEqual(
  expect.objectContaining({ id: questToAccept.id })
); // 【確認内容】: 受注した依頼が利用可能リストから適切に削除されることを確認
```

### セットアップ・クリーンアップのコメント

```typescript
beforeEach(async () => {
  // 【テスト前準備】: 各テスト実行前にゲームインスタンスとモックを初期化する
  // 【環境初期化】: 前のテストの影響を受けないよう、新規のゲームインスタンスを作成
  vi.clearAllMocks();

  const testSetup = await createTestGame();
  game = testSetup.game;
  eventBus = testSetup.eventBus;
  stateManager = game.registry.get('stateManager');

  // 【ゲーム開始】: 新規ゲームを開始し、依頼受注フェーズまで遷移
  eventBus.emit('ui:game:start:requested', { isNewGame: true });
  await waitForPhase(game, 'quest-accept');
});

afterEach(() => {
  // 【テスト後処理】: ゲームインスタンスを破棄し、リソースを解放
  // 【状態復元】: EventBusのリスナーをクリアし、次のテストに影響しないようにする
  game.destroy(true);
  eventBus.clear();
  vi.restoreAllMocks();
});
```

---

## 6. 要件定義との対応関係

### 参照した機能概要

- **依頼受注機能**: `turn-cycle-first-half-requirements.md` - 1. 機能の概要
- **採取機能**: `turn-cycle-first-half-requirements.md` - 1. 機能の概要
- **フェーズ遷移**: `turn-cycle-first-half-requirements.md` - 1. 機能の概要

### 参照した入力・出力仕様

- **依頼受注フェーズの入力**: `turn-cycle-first-half-requirements.md` - 2. 入力・出力の仕様
- **採取フェーズの入力**: `turn-cycle-first-half-requirements.md` - 2. 入力・出力の仕様
- **イベント発火の出力**: `turn-cycle-first-half-requirements.md` - 2. 入力・出力の仕様

### 参照した制約条件

- **依頼受注の制約**: `turn-cycle-first-half-requirements.md` - 3. 制約条件
- **採取の制約**: `turn-cycle-first-half-requirements.md` - 3. 制約条件
- **フェーズ遷移の制約**: `turn-cycle-first-half-requirements.md` - 3. 制約条件
- **Phaserテスト環境の制約**: `turn-cycle-first-half-requirements.md` - 3. 制約条件

### 参照した使用例

- **依頼受注フェーズの基本フロー**: `turn-cycle-first-half-requirements.md` - 4.1
- **採取フェーズの基本フロー**: `turn-cycle-first-half-requirements.md` - 4.2
- **フェーズスキップ**: `turn-cycle-first-half-requirements.md` - 4.3
- **フェーズ完了による遷移**: `turn-cycle-first-half-requirements.md` - 4.4
- **最大受注数制限**: `turn-cycle-first-half-requirements.md` - 4.5
- **AP不足時の採取**: `turn-cycle-first-half-requirements.md` - 4.6
- **カードが手札にない場合**: `turn-cycle-first-half-requirements.md` - 4.7

---

## 7. テストケース一覧サマリー

| # | カテゴリ | テスト名 | 信頼性 |
|---|---------|---------|-------|
| TC-01 | 正常系 | 依頼一覧表示 | 🔵 |
| TC-02 | 正常系 | 依頼受注成功 | 🔵 |
| TC-03 | 正常系 | フェーズスキップ（依頼受注） | 🔵 |
| TC-04 | 正常系 | フェーズ完了による遷移（依頼受注） | 🔵 |
| TC-05 | 正常系 | 採取地カード表示 | 🟡 |
| TC-06 | 正常系 | 採取実行と素材獲得 | 🔵 |
| TC-07 | 正常系 | カードの手札から捨て札への移動 | 🔵 |
| TC-08 | 正常系 | フェーズスキップ（採取） | 🔵 |
| TC-09 | 正常系 | フェーズ完了による遷移（採取） | 🔵 |
| TC-10 | 正常系 | 素材保持 | 🟡 |
| TC-11 | 正常系 | 依頼保持 | 🟡 |
| TC-12 | 正常系 | 依頼受注時のイベント発火 | 🔵 |
| TC-13 | 正常系 | 採取実行時のイベント発火 | 🔵 |
| TC-14 | 異常系 | 最大受注数制限 | 🔵 |
| TC-15 | 異常系 | AP不足時の採取不可 | 🔵 |
| TC-16 | 境界値 | 依頼0件受注でのスキップ | 🔵 |
| TC-17 | 境界値 | 依頼3件受注での境界値 | 🔵 |
| TC-18 | 境界値 | AP最大値（3）での採取実行 | 🔵 |
| TC-19 | 境界値 | AP残り1での採取実行 | 🔵 |
| TC-20 | 境界値 | 手札にカードがない場合のスキップ | 🟡 |

**総テストケース数**: 20ケース
- **正常系**: 13ケース
- **異常系**: 2ケース
- **境界値**: 5ケース

---

## 8. 信頼性レベルサマリー

| 信頼性 | テストケース数 | 割合 | 説明 |
|--------|--------------|------|------|
| 🔵 青信号 | 16ケース | 80% | 設計文書・要件定義書に詳細な記載がある |
| 🟡 黄信号 | 4ケース | 20% | 設計文書から妥当な推測（初期デッキ依存、状態保持） |
| 🔴 赤信号 | 0ケース | 0% | 推測なし |

**総テストケース数**: 20ケース

### 品質評価

✅ **高品質**

- **テストケース分類**: 正常系・異常系・境界値が網羅されている
- **期待値定義**: 各テストケースの期待値が明確に記載されている
- **技術選択**: TypeScript 5.x、Vitestが確定している
- **実装可能性**: 既存のテストユーティリティとモックを使用して実現可能
- **信頼性レベル**: 🔵（青信号）が80%を占める

### 詳細評価

#### 網羅性

- ✅ 依頼受注フェーズの基本動作（表示、受注、スキップ、完了）
- ✅ 採取フェーズの基本動作（カード表示、採取実行、カード移動、スキップ、完了）
- ✅ フェーズ遷移時の状態保持（素材、依頼）
- ✅ EventBus通信（依頼受注、採取完了）
- ✅ エラーハンドリング（最大受注数、AP不足）
- ✅ 境界値テスト（受注数0/3、AP最大/最小、カード0枚）

#### 実装可能性

本タスクは統合テストの実装であり、以下の理由で高い実装可能性を持つ：

1. **明確なテスト対象**: 依頼受注フェーズと採取フェーズの動作が設計文書に詳細に記載されている
2. **既存の参考実装**: `SceneTransitionIntegration.test.ts` が類似の統合テストの実装例として存在
3. **充実したテストユーティリティ**: `phaserTestUtils.ts` にモック作成やウェイト処理の関数が揃っている
4. **詳細なイベント定義**: EventBusで使用するイベントが `core-systems.md` に明記されている

#### 黄信号（🟡）項目について

黄信号項目は以下の4つ：
- **TC-05**: 採取地カード表示（初期デッキに採取カードが含まれるかどうかはランダム要素により不確定）
- **TC-10**: 素材保持（設計書に明記されていないが、妥当な推測）
- **TC-11**: 依頼保持（設計書に明記されていないが、妥当な推測）
- **TC-20**: 手札にカードがない場合のスキップ（初期デッキ依存）

これらは設計文書から合理的に推測可能であり、実装上の問題はない。

---

## 9. 次のステップ

### 推奨する次のコマンド

```bash
/tdd-red atelier-guild-rank-phaser TASK-0261
```

**説明**: Redフェーズ（失敗テスト作成）を開始し、このテストケースに基づいて実際のテストコードを実装します。

### 実装の流れ

1. **Red**: テストを実装し、失敗することを確認する
2. **Green**: テストをパスする最小限の実装を行う
3. **Refactor**: コードを整理し、品質を向上させる
4. **Code Review**: コードレビューを実施し、品質を確認する
5. **Verify Complete**: カバレッジを確認し、完了条件を満たすことを確認する

### カバレッジ目標

| テスト対象 | 目標カバレッジ | 備考 |
|-----------|---------------|------|
| 依頼受注フェーズ | 90% | TC-01〜TC-04, TC-14, TC-16〜TC-17 |
| 採取フェーズ | 90% | TC-05〜TC-09, TC-15, TC-18〜TC-20 |
| フェーズ遷移 | 100% | TC-03, TC-04, TC-08, TC-09, TC-10, TC-11 |
| EventBus通信 | 100% | TC-12, TC-13 |

---

## 10. 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-13 | 初版作成（TASK-0261のテストケース定義） |

---

## 11. 関連ドキュメント

- **タスク詳細**: `docs/tasks/atelier-guild-rank-phaser/TASK-0261.md`
- **要件定義書**: `docs/implements/atelier-guild-rank-phaser/TASK-0261/turn-cycle-first-half-requirements.md`
- **タスクノート**: `docs/implements/atelier-guild-rank-phaser/TASK-0261/note.md`
- **アーキテクチャ設計**: `docs/design/atelier-guild-rank-phaser/architecture.md`
- **データフロー設計**: `docs/design/atelier-guild-rank-phaser/dataflow.md`
- **コアシステム設計**: `docs/design/atelier-guild-rank-phaser/core-systems.md`
- **参考テスト実装**: `atelier-guild-rank-html/tests/integration/phaser/phase5/SceneTransitionIntegration.test.ts`
- **テストユーティリティ**: `atelier-guild-rank-html/tests/utils/phaserTestUtils.ts`
- **Phaserモック**: `atelier-guild-rank-html/tests/utils/phaserMocks.ts`
