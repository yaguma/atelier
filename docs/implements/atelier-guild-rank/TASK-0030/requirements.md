# TASK-0030: E2Eテスト・デバッグ - 要件定義書

**バージョン**: 1.0.0
**作成日**: 2026-01-18
**タスクID**: TASK-0030
**要件名**: atelier-guild-rank
**フェーズ**: 4 - 統合・テスト

---

## 1. 概要

本要件定義書は、TASK-0030「E2Eテスト・デバッグ」の機能要件、非機能要件、受け入れ基準を定義する。
Playwright E2E設定（TASK-0037）が完了済みであり、本タスクではゲームフロー全体のE2Eテスト、デバッグツール、テストヘルパー、パフォーマンステストを実装する。

### 1.1 目的

- ゲーム全体のクリティカルパスを自動テストでカバー
- 開発・テスト効率化のためのデバッグツール提供
- パフォーマンス指標の計測と監視

### 1.2 スコープ

| 項目 | 含まれる | 含まれない |
|------|---------|-----------|
| E2Eテスト | ゲームフロー、セーブ/ロード、クリア/オーバー | 全カード組み合わせテスト |
| デバッグツール | 状態操作、ログ出力 | 本番環境での利用 |
| テストヘルパー | ページオブジェクト、状態セットアップ | ユニットテストヘルパー |
| パフォーマンス | フレームレート、メモリ、ロード時間 | 詳細プロファイリング |

---

## 2. 機能要件（EARS記法）

### 2.1 ゲームフローE2Eテスト

#### REQ-E2E-001: 新規ゲーム開始テスト

**When** タイトル画面で「新規ゲーム」ボタンをクリックした場合、
**the system shall** MainSceneに遷移し、初期状態（Gランク、残り30日、100ゴールド）で表示する。

**受け入れ基準**:
- [ ] タイトル画面が表示される
- [ ] 新規ゲームボタンがクリック可能
- [ ] MainScene遷移後、ランクが「G」と表示される
- [ ] 残り日数が「30」と表示される
- [ ] 所持金が「100G」と表示される

#### REQ-E2E-002: 1日サイクル完了テスト

**When** メイン画面で1日のサイクル（依頼受注→採取→調合→納品）を実行した場合、
**the system shall** 各フェーズが正常に遷移し、翌日に進む。

**受け入れ基準**:
- [ ] 依頼受注フェーズで依頼を選択・受注できる
- [ ] 採取フェーズで採取地カードを使用し素材を獲得できる
- [ ] 調合フェーズでレシピカードを使用しアイテムを作成できる
- [ ] 納品フェーズで依頼を完了し報酬を獲得できる
- [ ] 日終了後、残り日数が1減少する

#### REQ-E2E-003: セーブ/ロードテスト

**When** ゲーム進行中にセーブを実行し、ページリロード後にコンティニューを選択した場合、
**the system shall** セーブ時の状態を正確に復元する。

**受け入れ基準**:
- [ ] セーブ実行が成功する
- [ ] ページリロード後、タイトル画面でコンティニューが有効になる
- [ ] コンティニュー後、セーブ時の日数が復元される
- [ ] コンティニュー後、セーブ時のランクが復元される
- [ ] コンティニュー後、セーブ時の所持金が復元される

#### REQ-E2E-004: ゲームクリアテスト

**When** Sランクに到達した場合、
**the system shall** ゲームクリア画面を表示する。

**受け入れ基準**:
- [ ] Sランク状態をデバッグツールでセットアップできる
- [ ] ランク昇格条件を満たした際にクリア画面に遷移する
- [ ] クリア画面からタイトルに戻れる

#### REQ-E2E-005: ゲームオーバーテスト

**When** Sランク未到達の状態で残り日数が0になった場合、
**the system shall** ゲームオーバー画面を表示する。

**受け入れ基準**:
- [ ] 残り日数1の状態をデバッグツールでセットアップできる
- [ ] 日終了処理後にゲームオーバー画面に遷移する
- [ ] ゲームオーバー画面からタイトルに戻れる

---

### 2.2 デバッグツール

#### REQ-DBG-001: ランク変更機能

**While** 開発モード（`import.meta.env.DEV === true`）の場合、
**the system shall** `window.debug.setRank(rank)` でギルドランクを即時変更できる。

**受け入れ基準**:
- [ ] `debug.setRank('S')` でSランクに変更できる
- [ ] `debug.setRank('G')` でGランクに変更できる
- [ ] ランク変更後、UIが即座に更新される
- [ ] 本番モードではdebugオブジェクトが存在しない

#### REQ-DBG-002: ゴールド追加機能

**While** 開発モードの場合、
**the system shall** `window.debug.addGold(amount)` で所持金を追加できる。

**受け入れ基準**:
- [ ] `debug.addGold(1000)` で1000ゴールド追加できる
- [ ] ゴールド追加後、UIが即座に更新される
- [ ] 負の値を指定した場合、ゴールドが減少する

#### REQ-DBG-003: 日付スキップ機能

**While** 開発モードの場合、
**the system shall** `window.debug.skipToDay(day)` で指定日にスキップできる。

**受け入れ基準**:
- [ ] `debug.skipToDay(1)` で残り1日にスキップできる
- [ ] `debug.skipToDay(30)` で残り30日にスキップできる
- [ ] 日付スキップ後、UIが即座に更新される

#### REQ-DBG-004: 全カード解放機能

**While** 開発モードの場合、
**the system shall** `window.debug.unlockAllCards()` で全カードを解放できる。

**受け入れ基準**:
- [ ] 全カード解放後、デッキに全種類のカードが追加される
- [ ] 手札に反映される

#### REQ-DBG-005: 状態ログ出力機能

**While** 開発モードの場合、
**the system shall** `window.debug.logState()` で現在のゲーム状態をコンソールに出力できる。

**受け入れ基準**:
- [ ] ゲーム状態（ランク、日数、ゴールド等）がコンソールに出力される
- [ ] デッキ状態（手札、山札、捨て札）が出力される
- [ ] インベントリ状態（素材、アイテム）が出力される

#### REQ-DBG-006: 行動ポイント設定機能

**While** 開発モードの場合、
**the system shall** `window.debug.setActionPoints(ap)` で行動ポイントを設定できる。

**受け入れ基準**:
- [ ] `debug.setActionPoints(10)` で行動ポイントを10に設定できる
- [ ] 行動ポイント変更後、UIが即座に更新される

#### REQ-DBG-007: セーブデータ削除機能

**While** 開発モードの場合、
**the system shall** `window.debug.clearSaveData()` でセーブデータを削除できる。

**受け入れ基準**:
- [ ] セーブデータ削除後、localStorageから該当データが消去される
- [ ] ページリロード後、コンティニューが無効になる

#### REQ-DBG-008: ゲーム状態取得機能

**While** 開発モードの場合、
**the system shall** `window.gameState()` で現在のゲーム状態オブジェクトを取得できる。

**受け入れ基準**:
- [ ] `window.gameState()` がIGameState型のオブジェクトを返す
- [ ] E2Eテストから`page.evaluate(() => window.gameState())`で状態取得可能

---

### 2.3 テストヘルパー

#### REQ-TH-001: ゲームページオブジェクト（既存拡張）

**the system shall** GamePageクラスで基本的なゲーム画面操作を提供する。

**受け入れ基準**:
- [ ] `waitForGameLoad()` でゲームロード完了を待機できる
- [ ] `getCanvasSize()` でキャンバスサイズを取得できる
- [ ] `clickCanvas(x, y)` で座標クリックを実行できる
- [ ] `takeScreenshot(name)` でスクリーンショットを保存できる

#### REQ-TH-002: タイトルページオブジェクト

**the system shall** TitlePageクラスでタイトル画面操作を提供する。

**受け入れ基準**:
- [ ] `waitForTitleLoad()` でタイトル画面表示を待機できる
- [ ] `clickNewGame()` で新規ゲームを開始できる
- [ ] `clickContinue()` でコンティニューを選択できる
- [ ] `isContinueEnabled()` でコンティニューの有効/無効を取得できる

#### REQ-TH-003: メインページオブジェクト

**the system shall** MainPageクラスでメイン画面操作を提供する。

**受け入れ基準**:
- [ ] `getCurrentPhase()` で現在フェーズを取得できる
- [ ] `getRemainingDays()` で残り日数を取得できる
- [ ] `getGold()` で所持金を取得できる
- [ ] `getCurrentRank()` で現在ランクを取得できる
- [ ] `skipPhase()` でフェーズをスキップできる
- [ ] `endDay()` で日を終了できる

#### REQ-TH-004: リザルトページオブジェクト

**the system shall** ResultPageクラスでリザルト画面操作を提供する。

**受け入れ基準**:
- [ ] `waitForResultScreen()` でリザルト画面表示を待機できる
- [ ] `isGameClear()` でクリア状態を判定できる
- [ ] `isGameOver()` でオーバー状態を判定できる
- [ ] `returnToTitle()` でタイトルに戻れる

#### REQ-TH-005: ゲーム状態セットアップヘルパー

**the system shall** GameStateHelperクラスでテスト用状態セットアップを提供する。

**受け入れ基準**:
- [ ] `setGameState(state)` で任意の状態を設定できる
- [ ] `setupSRankState()` でSランク状態をセットアップできる
- [ ] `setupGameOverState()` でゲームオーバー直前状態をセットアップできる
- [ ] `setupRichState()` でリソース豊富な状態をセットアップできる

---

### 2.4 パフォーマンステスト

#### REQ-PERF-001: フレームレート計測

**the system shall** ゲーム実行中のフレームレートを計測できる。

**受け入れ基準**:
- [ ] `measureFrameRate(duration)` で指定時間のFPSを計測できる
- [ ] 計測結果が数値（fps）で返される
- [ ] 目標値: 60fps安定

#### REQ-PERF-002: メモリ使用量計測

**the system shall** ゲーム実行中のメモリ使用量を計測できる。

**受け入れ基準**:
- [ ] `getMemoryUsage()` でメモリ使用量を取得できる
- [ ] 計測結果がバイト単位で返される
- [ ] 目標値: 100MB以下

#### REQ-PERF-003: 起動時間計測

**the system shall** ゲーム起動時間を計測できる。

**受け入れ基準**:
- [ ] DOMContentLoadedからゲーム表示完了までの時間を計測できる
- [ ] 目標値: 2秒以内

#### REQ-PERF-004: シーン遷移時間計測

**the system shall** シーン遷移時間を計測できる。

**受け入れ基準**:
- [ ] シーン変更開始から表示完了までの時間を計測できる
- [ ] 目標値: 500ms以内

---

## 3. 非機能要件

### 3.1 保守性

| 項目 | 要件 |
|------|------|
| **コード構造** | ページオブジェクトパターンに従う |
| **再利用性** | ヘルパー関数は汎用的に設計 |
| **可読性** | テストケースは日本語コメントで意図を明記 |

### 3.2 信頼性

| 項目 | 要件 |
|------|------|
| **テスト安定性** | フレーキーテストを排除（リトライ不要な設計） |
| **タイムアウト** | 適切な待機処理を実装 |
| **独立性** | テスト間の依存を排除 |

### 3.3 セキュリティ

| 項目 | 要件 |
|------|------|
| **デバッグツール無効化** | 本番ビルドではデバッグツールを含めない |
| **環境分離** | `import.meta.env.DEV`で開発/本番を判定 |

### 3.4 互換性

| 項目 | 要件 |
|------|------|
| **ブラウザ** | Chromium（Playwright標準） |
| **CI/CD** | GitHub Actions互換（ヘッドレスモード） |

---

## 4. 受け入れ基準

### 4.1 必須条件（Must Have）

- [ ] **AC-001**: 新規ゲーム開始E2Eテスト（T-0030-01）が通る
- [ ] **AC-002**: 1日サイクルE2Eテスト（T-0030-02）が通る
- [ ] **AC-003**: セーブ/ロードE2Eテスト（T-0030-03）が通る
- [ ] **AC-004**: ゲームクリアE2Eテスト（T-0030-04）が通る
- [ ] **AC-005**: ゲームオーバーE2Eテスト（T-0030-05）が通る
- [ ] **AC-006**: コンソールエラーがない
- [ ] **AC-007**: 主要ゲームフローにクリティカルな問題がない

### 4.2 推奨条件（Should Have）

- [ ] **AC-008**: デバッグツール（setRank, addGold, skipToDay, unlockAllCards, logState）が動作する
- [ ] **AC-009**: テストヘルパー（ページオブジェクト、状態セットアップ）が実装されている
- [ ] **AC-010**: パフォーマンスが許容範囲内（60fps、100MB以下、起動2秒以内）

### 4.3 任意条件（Nice to Have）

- [ ] **AC-011**: 追加デバッグコマンド（setActionPoints, clearSaveData）が実装されている
- [ ] **AC-012**: パフォーマンステストヘルパーが実装されている
- [ ] **AC-013**: CI/CDパイプラインでE2Eテストが自動実行される

---

## 5. 制約条件

### 5.1 技術的制約

| 制約 | 説明 | 対策 |
|------|------|------|
| **Canvasベーステスト** | PhaserゲームはDOM要素が少ない | window経由でゲーム状態を公開 |
| **座標ベース操作** | UI要素の座標計算が必要 | ページオブジェクトで抽象化 |
| **非同期処理** | アニメーション完了待機が必要 | 適切なwait処理を実装 |
| **開発サーバー依存** | テスト実行時にdevサーバーが必要 | webServerオプションで自動起動 |

### 5.2 環境制約

| 制約 | 説明 |
|------|------|
| **Playwright 1.57+** | 最新のPlaywrightを使用 |
| **Node.js** | Playwright実行環境 |
| **Chromium** | テスト対象ブラウザ |

### 5.3 運用制約

| 制約 | 説明 |
|------|------|
| **CI実行時間** | E2Eテストは2分以内に完了 |
| **並列実行** | CI環境ではworker=1で順次実行 |

---

## 6. 前提条件

### 6.1 依存タスク

| タスク | 状態 | 内容 |
|--------|------|------|
| **TASK-0037** | 完了 | Playwright E2E設定 |
| **TASK-0028** | 完了 | サービス統合・DI設定 |
| **TASK-0029** | 完了 | セーブ/ロード機能統合 |

### 6.2 既存実装

| 項目 | パス |
|------|------|
| **Playwright設定** | `playwright.config.ts`（未作成、note.mdに定義あり） |
| **テストフィクスチャ** | `e2e/fixtures/game.fixture.ts`（未作成） |
| **ページオブジェクト** | `e2e/pages/game.page.ts`（未作成） |
| **起動テスト** | `e2e/specs/boot.spec.ts`（未作成） |

### 6.3 利用可能サービス

| サービス | 説明 |
|---------|------|
| **StateManager** | ゲーム状態の一元管理 |
| **Container** | DIコンテナ経由のサービスアクセス |
| **EventBus** | イベント駆動のUI更新 |
| **SaveLoadService** | セーブ/ロード機能 |

---

## 7. 成果物一覧

### 7.1 E2Eテストファイル

| ファイル | 説明 |
|---------|------|
| `e2e/specs/game-flow.test.ts` | ゲームフローE2Eテスト |
| `e2e/specs/boot.spec.ts` | 起動テスト（既存） |

### 7.2 ページオブジェクト

| ファイル | 説明 |
|---------|------|
| `e2e/pages/game.page.ts` | ゲーム基本操作（既存拡張） |
| `e2e/pages/title.page.ts` | タイトル画面操作 |
| `e2e/pages/main.page.ts` | メイン画面操作 |
| `e2e/pages/result.page.ts` | リザルト画面操作 |

### 7.3 テストヘルパー

| ファイル | 説明 |
|---------|------|
| `e2e/fixtures/game.fixture.ts` | テストフィクスチャ（既存） |
| `e2e/helpers/game-state.helper.ts` | ゲーム状態セットアップ |
| `e2e/helpers/performance.helper.ts` | パフォーマンス計測 |

### 7.4 デバッグツール

| ファイル | 説明 |
|---------|------|
| `src/shared/utils/debug.ts` | デバッグツール本体 |

### 7.5 更新ファイル

| ファイル | 説明 |
|---------|------|
| `src/main.ts` | デバッグツールのグローバル登録 |

---

## 8. テストケース一覧

| テストID | テスト内容 | 期待結果 | 優先度 |
|---------|----------|----------|--------|
| T-0030-01 | 新規ゲーム開始 | MainScene表示、初期状態確認 | 必須 |
| T-0030-02 | 1日サイクル完了 | 全フェーズ遷移、翌日開始 | 必須 |
| T-0030-03 | セーブ→ロード | 状態復元 | 必須 |
| T-0030-04 | ゲームクリア | クリア画面表示 | 必須 |
| T-0030-05 | ゲームオーバー | オーバー画面表示 | 必須 |
| T-0030-06 | デバッグツール動作 | 各コマンド正常動作 | 推奨 |
| T-0030-07 | パフォーマンス計測 | 目標値内 | 推奨 |

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| **E2E（End-to-End）テスト** | ブラウザを介したシステム全体のテスト |
| **ページオブジェクト** | UI操作を抽象化したデザインパターン |
| **フィクスチャ** | テスト用の共通セットアップ |
| **デバッグツール** | 開発時のみ有効なテスト補助機能 |
| **EARS記法** | Easy Approach to Requirements Syntax |

---

## 関連文書

- **タスク詳細**: [../../tasks/atelier-guild-rank/phase-4/TASK-0030.md](../../tasks/atelier-guild-rank/phase-4/TASK-0030.md)
- **タスクノート**: [note.md](note.md)
- **データフロー設計**: [../../design/atelier-guild-rank/dataflow.md](../../design/atelier-guild-rank/dataflow.md)
- **アーキテクチャ設計**: [../../design/atelier-guild-rank/architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-18 | 1.0.0 | 初版作成 |
