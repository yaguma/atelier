# TASK-0023: 採取フェーズUI（ドラフト採取）要件定義書

**バージョン**: 1.0.0
**作成日**: 2026-01-18
**タスクID**: TASK-0023
**要件名**: atelier-guild-rank

---

## 1. 概要

### 1.1 タスク目的

採取フェーズにおけるドラフト採取システムのUIを実装する。プレイヤーが採取地カードを使用して素材を採取する際に、3つの素材選択肢から1つを選ぶドラフト方式のUIを提供する。

### 1.2 信頼性レベル

- 🔵 **青信号**: 設計文書に明記されている
- 🟡 **黄信号**: 設計文書から妥当に推測できる
- 🔴 **赤信号**: 設計文書にない追加要素

### 1.3 依存タスク

| タスクID | タスク名 | 状態 | 依存内容 |
|----------|----------|------|----------|
| TASK-0020 | MainScene共通レイアウト | 完了 | BaseComponent基盤、共通レイアウト |
| TASK-0021 | HeaderUI/SidebarUI/FooterUI | 完了 | 共通UIコンポーネント |
| TASK-0011 | GatheringService | 完了 | 採取ロジック、DraftSession管理 |

---

## 2. 機能要件

### 2.1 ドラフト採取セッション管理 🔵

#### FR-001: ドラフトセッション開始

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-001 |
| **優先度** | 必須 |
| **説明** | 採取地カード選択後、ドラフト採取セッションを開始する |
| **入力** | 採取地カード、強化カード（任意） |
| **出力** | DraftSessionオブジェクト |
| **トリガー** | 「採取を開始する」ボタン押下またはEnterキー |

**処理フロー**:
1. GatheringService.startDraftGathering()を呼び出す
2. DraftSessionを初期化する
3. 最初のラウンドの素材選択肢を表示する
4. `GameEventType.GATHERING_STARTED`イベントを発行する

#### FR-002: 素材選択肢表示

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-002 |
| **優先度** | 必須 |
| **説明** | 各ラウンドで3つの素材選択肢を表示する |
| **入力** | MaterialOption[]（3要素） |
| **出力** | 素材カードUI×3 |
| **信頼性** | 🔵 |

**素材カード表示要素**:
- 素材アイコン（絵文字またはアセット）
- 素材名
- 品質（C/B/A/S）
- レア表示（レア素材の場合）
- ショートカットキー（1/2/3）

#### FR-003: 素材選択

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-003 |
| **優先度** | 必須 |
| **説明** | プレイヤーが3つの選択肢から1つを選択する |
| **入力** | 素材インデックス（0, 1, 2） |
| **出力** | 選択された素材がDraftSessionに追加される |
| **信頼性** | 🔵 |

**入力方法**:
- マウスクリック
- キーボードショートカット（1, 2, 3）

**処理フロー**:
1. GatheringService.selectMaterial()を呼び出す
2. 選択された素材を獲得済みリストに追加する
3. `GameEventType.MATERIAL_SELECTED`イベントを発行する
4. 次のラウンドに進む（または全ラウンド終了）

#### FR-004: ラウンドスキップ

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-004 |
| **優先度** | 必須 |
| **説明** | 現在のラウンドをスキップして次に進む |
| **入力** | なし |
| **出力** | ラウンドカウンタ増加、素材選択なし |
| **信頼性** | 🔵 |

**入力方法**:
- 「このラウンドをスキップ」ボタン
- キーボードショートカット（S または 0）

#### FR-005: 採取終了

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-005 |
| **優先度** | 必須 |
| **説明** | 採取セッションを終了し、結果を確定する |
| **入力** | なし |
| **出力** | GatheringResult（獲得素材、消費コスト） |
| **信頼性** | 🔵 |

**入力方法**:
- 「採取を終了する」ボタン
- キーボードショートカット（E）
- 全ラウンド完了時（自動）

**処理フロー**:
1. GatheringService.endGathering()を呼び出す
2. コストを計算する
3. `GameEventType.GATHERING_ENDED`イベントを発行する
4. 採取完了画面を表示する

### 2.2 UI表示要件 🔵

#### FR-006: ラウンドインジケーター

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-006 |
| **優先度** | 必須 |
| **説明** | 現在のラウンド/最大ラウンドと選択済み個数を表示 |
| **表示形式** | 「【採取地名】 ラウンド N/M | 選択済み: X個」 |
| **信頼性** | 🔵 |

#### FR-007: 獲得済み素材リスト

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-007 |
| **優先度** | 必須 |
| **説明** | 現在のセッションで獲得した素材を表示 |
| **表示形式** | アイコン + 名前(品質) ×数量 |
| **最大表示行数** | 5行（スクロール可能） |
| **信頼性** | 🔵 |

#### FR-008: コスト表示パネル

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-008 |
| **優先度** | 必須 |
| **説明** | 現在のコスト状況をリアルタイム表示 |
| **表示項目** | 基本コスト、追加コスト、合計、追加日数 |
| **信頼性** | 🔵 |

**コスト計算ルール** 🔵:

| 選択個数 | 追加コスト | 追加日数 |
|---------|-----------|---------|
| 0個（偵察のみ） | 0 | 0 |
| 1〜2個 | 1 | 0 |
| 3〜4個 | 2 | 0 |
| 5〜6個 | 3 | 0 |
| 7個以上 | 3 | +1日 |

**警告表示**:
| 選択個数 | 警告レベル | 表示スタイル |
|---------|-----------|-------------|
| 0〜4個 | なし | 通常表示 |
| 5〜6個 | 警告 | 黄色表示 |
| 7個以上 | 危険 | 赤色点滅 + 「翌日持越し」表示 |

### 2.3 採取地詳細表示 🔵

#### FR-009: 採取地詳細パネル

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-009 |
| **優先度** | 必須 |
| **説明** | 採取開始前に採取地の詳細情報を表示 |
| **表示項目** | 採取地名、基本コスト、提示回数、レア出現率、出現可能素材 |
| **信頼性** | 🔵 |

### 2.4 採取結果表示 🔵

#### FR-010: 採取完了画面

| 項目 | 内容 |
|------|------|
| **要件ID** | FR-010 |
| **優先度** | 必須 |
| **説明** | 採取終了後に結果サマリーを表示 |
| **表示項目** | 採取地名、獲得素材一覧、消費コスト詳細 |
| **信頼性** | 🔵 |

---

## 3. 非機能要件

### 3.1 パフォーマンス要件 🔵

| 要件ID | 指標 | 目標値 | 優先度 |
|--------|------|--------|--------|
| NFR-001 | ラウンド遷移時間 | < 500ms | 必須 |
| NFR-002 | 素材選択反応時間 | < 16ms（1フレーム） | 必須 |
| NFR-003 | 結果画面表示時間 | < 300ms | 必須 |
| NFR-004 | メモリ使用量 | < 15MB（フェーズ単体） | 推奨 |

### 3.2 アクセシビリティ要件 🔵

#### NFR-005: キーボード操作

| キー | 動作 | 信頼性 |
|------|------|--------|
| `1` | 左の素材を選択 | 🔵 |
| `2` | 中央の素材を選択 | 🔵 |
| `3` | 右の素材を選択 | 🔵 |
| `S` または `0` | このラウンドをスキップ | 🔵 |
| `E` | 採取を終了する | 🔵 |
| `Enter` | 選択中の素材を確定/採取開始 | 🟡 |
| `Escape` | キャンセル（未選択時のみ） | 🔵 |

#### NFR-006: フォーカス管理

| 要件 | 内容 |
|------|------|
| フォーカス順序 | 素材カード群（左→右）→ スキップボタン → 採取終了ボタン |
| フォーカスリング | 選択可能なカードにはフォーカスリングを表示 |

### 3.3 可用性要件 🟡

| 要件ID | 要件 | 内容 |
|--------|------|------|
| NFR-007 | EventBus未初期化時 | 警告ログを出力し、UI処理は継続 |
| NFR-008 | GatheringServiceエラー時 | try-catchで捕捉し、エラーダイアログ表示 |
| NFR-009 | 無効な素材インデックス | ApplicationErrorをスローし、ログ出力 |

---

## 4. 受け入れ基準

### 4.1 必須基準（MUST） 🔵

| AC-ID | 基準 | 検証方法 |
|-------|------|----------|
| AC-001 | GatheringPhaseUIが正常に初期化される | ユニットテスト |
| AC-002 | 採取セッションを開始できる | ユニットテスト |
| AC-003 | 3つの素材選択肢が正しく表示される | ユニットテスト |
| AC-004 | 素材を選択できる（インデックス0, 1, 2） | ユニットテスト |
| AC-005 | 選択後にプールが更新される | ユニットテスト |
| AC-006 | ラウンドをスキップできる | ユニットテスト |
| AC-007 | 採取を途中で終了できる | ユニットテスト |
| AC-008 | 全ラウンド完了後にisCompleteがtrueになる | ユニットテスト |
| AC-009 | 獲得素材が正しく表示される | ユニットテスト |
| AC-010 | コスト計算が正しく行われる（0〜7個以上） | ユニットテスト |
| AC-011 | EventBusにイベントが正しく発行される | ユニットテスト |
| AC-012 | キーボードショートカットが動作する | ユニットテスト |

### 4.2 推奨基準（SHOULD） 🟡

| AC-ID | 基準 | 検証方法 |
|-------|------|----------|
| AC-013 | 素材提示アニメーションが再生される | 手動テスト |
| AC-014 | 素材選択アニメーションが再生される | 手動テスト |
| AC-015 | レア素材にキラキラエフェクトが表示される | 手動テスト |
| AC-016 | 7個選択時に警告が表示される | ユニットテスト |

### 4.3 異常系基準 🔵

| AC-ID | 基準 | 検証方法 |
|-------|------|----------|
| AC-017 | EventBus未初期化時に警告ログが出力される | ユニットテスト |
| AC-018 | 行動ポイント不足時に開始ボタンが非活性になる | ユニットテスト |
| AC-019 | キャンセルは素材未選択時のみ可能 | ユニットテスト |

### 4.4 境界値基準 🔵

| AC-ID | 基準 | 検証方法 |
|-------|------|----------|
| AC-020 | 0個選択（偵察のみ）でコスト0 | ユニットテスト |
| AC-021 | 最大提示回数（5回）まで正常動作 | ユニットテスト |
| AC-022 | 6個選択でペナルティなし上限（コスト3） | ユニットテスト |
| AC-023 | 7個選択で翌日持越しペナルティ（+1日） | ユニットテスト |

---

## 5. 制約条件

### 5.1 技術的制約

| 制約ID | 制約内容 | 理由 |
|--------|----------|------|
| TC-001 | BaseComponentを継承する | アーキテクチャ規約 |
| TC-002 | create()とdestroy()を実装する | BaseComponent規約 |
| TC-003 | EventBusはscene.data.get('eventBus')から取得 | 既存パターン準拠 |
| TC-004 | rexUIプラグインはテスト環境で動作しないためモック対応 | テスト環境制約 |
| TC-005 | Proxyパターンでコンテナ座標管理 | モック対応のため |

### 5.2 依存関係

| 依存ID | 依存対象 | 依存内容 |
|--------|----------|----------|
| DEP-001 | GatheringService | ドラフト採取ロジック（TASK-0011で実装済み） |
| DEP-002 | BaseComponent | UI基底クラス（TASK-0020で実装済み） |
| DEP-003 | EventBus | イベント発行・購読 |
| DEP-004 | Button | ボタンコンポーネント |
| DEP-005 | CardUI | カード表示コンポーネント |

### 5.3 ファイル構成

| ファイル | パス | 種別 |
|----------|------|------|
| GatheringPhaseUI | `src/presentation/ui/phases/GatheringPhaseUI.ts` | 実装 |
| GatheringPhaseUI.spec | `src/presentation/ui/phases/GatheringPhaseUI.spec.ts` | テスト |
| MaterialCardUI（任意） | `src/presentation/ui/components/MaterialCardUI.ts` | 実装 |
| MaterialCardUI.spec（任意） | `src/presentation/ui/components/MaterialCardUI.spec.ts` | テスト |

---

## 6. テストケース概要

### 6.1 正常系テスト 🔵

| TC-ID | テストケース | 期待結果 |
|-------|-------------|----------|
| TC-201 | GatheringPhaseUI初期化 | コンポーネントが正常に生成される |
| TC-202 | 採取セッション開始 | DraftSessionが開始され、素材選択肢が表示される |
| TC-203 | 素材選択（インデックス0, 1, 2） | 選択した素材がselectedMaterialsに追加される |
| TC-204 | ラウンドスキップ | 素材追加なしで次ラウンドに進む |
| TC-205 | 採取終了 | GatheringResultが返され、コストが計算される |
| TC-206 | 全ラウンド完了 | isCompleteがtrueになる |

### 6.2 異常系テスト 🔵

| TC-ID | テストケース | 期待結果 |
|-------|-------------|----------|
| TC-207 | EventBus未初期化 | 警告ログ出力、UI処理は継続 |
| TC-208 | GatheringService未設定 | エラーログ出力、適切なフォールバック |

### 6.3 境界値テスト 🔵

| TC-ID | テストケース | 期待結果 |
|-------|-------------|----------|
| TC-209 | 0個選択（偵察のみ） | 追加コスト0、追加日数0 |
| TC-210 | 最大提示回数（5回） | 5ラウンド全て正常動作 |
| TC-211 | 6個選択 | 追加コスト3、追加日数0 |
| TC-212 | 7個選択 | 追加コスト3、追加日数+1 |

### 6.4 統合テスト

| TC-ID | テストケース | 期待結果 |
|-------|-------------|----------|
| T-0023-01 | 素材プール表示 | 6つの素材が2行3列で表示される |
| T-0023-02 | 素材選択 | プールから削除、獲得リストに追加 |
| T-0023-03 | 選択上限 | 上限到達で選択不可 |
| T-0023-04 | 採取終了 | 次フェーズへ遷移準備完了 |

---

## 7. データモデル

### 7.1 DraftSession 🔵

```typescript
interface DraftSession {
  sessionId: string;
  card: Card;
  currentRound: number;
  maxRounds: number;
  selectedMaterials: MaterialInstance[];
  currentOptions: MaterialOption[];
  isComplete: boolean;
}
```

### 7.2 MaterialOption 🔵

```typescript
interface MaterialOption {
  materialId: string;
  name: string;
  icon: string;
  quality: Quality;
  isRare: boolean;
}
```

### 7.3 GatheringCostResult 🔵

```typescript
interface GatheringCostResult {
  baseCost: number;
  additionalCost: number;
  totalCost: number;
  extraDay: boolean;
  warningLevel: 'none' | 'warning' | 'danger';
}
```

---

## 8. イベント仕様

### 8.1 発行イベント 🔵

| イベント名 | ペイロード | 発火タイミング |
|-----------|-----------|---------------|
| `GATHERING_STARTED` | `{ locationId, presentationCount }` | ドラフト開始時 |
| `MATERIAL_PRESENTED` | `{ round, materials }` | 素材3つ提示時 |
| `MATERIAL_SELECTED` | `{ round, materialId }` | 素材選択時 |
| `ROUND_SKIPPED` | `{ round }` | ラウンドスキップ時 |
| `GATHERING_COMPLETED` | `{ locationId, materials, totalCost, extraDay }` | 採取完了時 |

### 8.2 購読イベント 🟡

| イベント名 | 処理内容 |
|-----------|---------|
| `ACTION_POINTS_CHANGED` | 行動ポイント変更時にUI更新 |
| `PHASE_TRANSITION_REQUESTED` | フェーズ遷移リクエスト処理 |

---

## 9. 関連文書

| 文書 | パス |
|------|------|
| タスクノート | `/home/user/atelier/docs/implements/atelier-guild-rank/TASK-0023/note.md` |
| タスクファイル | `/home/user/atelier/docs/tasks/atelier-guild-rank/phase-3/TASK-0023.md` |
| 採取フェーズ設計 | `/home/user/atelier/docs/design/atelier-guild-rank/ui-design/screens/gathering.md` |
| QuestAcceptPhaseUI（参考） | `/home/user/atelier/atelier-guild-rank/src/presentation/ui/phases/QuestAcceptPhaseUI.ts` |
| GatheringService | `/home/user/atelier/atelier-guild-rank/src/application/services/gathering-service.ts` |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-18 | 1.0.0 | 初版作成 |
