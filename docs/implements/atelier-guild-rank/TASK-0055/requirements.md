# TASK-0055 要件定義: RankUpSceneリファクタリング

**作成日**: 2026-01-23
**タスクID**: TASK-0055

---

## 1. 概要

RankUpScene.ts（1,011行）を責務ごとにコンポーネント分割し、コードの保守性と再利用性を向上させる。

---

## 2. 目的

1. 1,011行の大型ファイルを400行以下に削減
2. 3つ以上のサブコンポーネントに責務を分割
3. any型を適切な型定義に置き換え
4. 共通ユーティリティ（TASK-0053, 0054）を活用してコード重複を削減
5. テストカバレッジ80%以上を達成

---

## 3. 機能要件

### 3.1 コンポーネント分割

#### REQ-055-01: RankUpSceneメインコンポーネント
**優先度**: 高

- シーン管理と子コンポーネントの統合のみを担当
- 子コンポーネントの初期化とライフサイクル管理
- 200行以下

#### REQ-055-02: RankUpHeaderコンポーネント
**優先度**: 高

- 画面タイトル表示（「🏆 昇格試験」）
- 現在ランク → 目標ランクの表示
- ランク情報の更新メソッド

#### REQ-055-03: RankUpRequirementsコンポーネント
**優先度**: 高

- 昇格条件（課題）一覧の表示
- 課題の完了状態表示（✓/○）
- 期限表示

#### REQ-055-04: RankUpTestPanelコンポーネント
**優先度**: 高

- 試験開始ボタン
- 辞退ボタン
- 試験状態に応じた表示切り替え
  - NotStarted: 試験開始/辞退ボタン
  - InProgress: 進行中インジケーター
  - Completed: クリア表示
  - Failed: 失敗表示、タイトルへボタン

#### REQ-055-05: RankUpRewardsコンポーネント
**優先度**: 中

- ボーナスゴールド表示
- アーティファクト選択UI（3択）
- アーティファクトカードの表示
- 選択ボタンとホバーエフェクト

### 3.2 共通ユーティリティ活用

#### REQ-055-06: UIBackgroundBuilder使用
**優先度**: 中

- パネル背景の作成に`UIBackgroundBuilder`を使用
- `Colors.background.primary`等のテーマ定数を使用

#### REQ-055-07: HoverAnimation使用
**優先度**: 中

- ボタンとカードに`applyHoverAnimation`を適用
- `AnimationPresets.button.hover`等のプリセットを使用

### 3.3 型定義改善

#### REQ-055-08: any型の置き換え
**優先度**: 高

- `startButton: any` → 適切な型/インターフェース
- `declineButton: any` → 適切な型/インターフェース
- ボタン状態管理の型安全性確保

---

## 4. 非機能要件

### 4.1 コード品質

#### NFR-055-01: 行数制限
- メインコンポーネント: 200行以下
- 各サブコンポーネント: 200行以下
- 合計: 現在の1,011行 → 400行以下（メインファイル）

#### NFR-055-02: テストカバレッジ
- 新規コンポーネント: 80%以上
- 分岐カバレッジ: 75%以上

### 4.2 互換性

#### NFR-055-03: 既存動作の維持
- リファクタリング後も既存の全機能が正常に動作
- 既存テストが全て通過

#### NFR-055-04: rexUIプラグイン互換性
- rexUIプラグインとの互換性を維持
- any型はrexUI関連のみ許容（TASK-0059で対応）

---

## 5. 受け入れ基準

### AC-055-01: ファイルサイズ
- [ ] RankUpScene.tsが400行以下

### AC-055-02: コンポーネント分割
- [ ] 3つ以上のサブコンポーネントが作成されている
- [ ] 各コンポーネントが単一責任の原則を守っている

### AC-055-03: 型安全性
- [ ] rexUI以外のany型が排除されている
- [ ] 適切なインターフェース/型が定義されている

### AC-055-04: 共通ユーティリティ使用
- [ ] `UIBackgroundBuilder`が使用されている
- [ ] `Colors`/`AnimationPresets`が使用されている
- [ ] `applyHoverAnimation`が使用されている

### AC-055-05: テスト
- [ ] 既存テストが全て通過
- [ ] 新規コンポーネントのテストカバレッジが80%以上

### AC-055-06: 動作確認
- [ ] 試験開始フローが正常に動作
- [ ] 辞退フローが正常に動作
- [ ] 試験クリア→報酬選択フローが正常に動作
- [ ] 試験失敗→タイトル遷移フローが正常に動作
- [ ] キーボード操作が正常に動作

---

## 6. 実装制約

1. **段階的リファクタリング**: 一度に全てを変更せず、コンポーネントごとに分離
2. **後方互換性**: 既存のイベント発行・購読パターンを維持
3. **依存関係**: BaseComponentクラスの継承関係を維持
4. **テスト先行**: テストを先に作成してから実装

---

## 7. 関連タスク

- **前提**: TASK-0053（共通UIユーティリティ）✅
- **前提**: TASK-0054（テーマ定数統一）✅
- **後続**: TASK-0059（rexUI型定義追加）
- **後続**: TASK-0060（ディレクトリ構造整理）
