# TDD要件定義書: ツールチップ表示システム

**タスクID**: TASK-0041
**作成日**: 2026-01-20
**要件名**: atelier-guild-rank
**信頼性レベル**: 🟡 黄信号（標準的なUIパターンから推測）
**フェーズ**: Phase 5 - UI強化・ポリッシュ

---

## 1. 機能概要

ゲーム全体で使用可能なツールチップ表示システムを実装する。ホバー時にアイテムや要素の詳細情報を表示し、ユーザーの理解を助ける。TooltipManagerをシングルトンパターンで実装し、シーン間で再利用可能にする。

---

## 2. 完了条件

- [ ] TooltipManagerシングルトン実装
- [ ] ツールチップ表示/非表示機能
- [ ] 表示位置の自動調整（画面端対応）
- [ ] 表示遅延設定機能
- [ ] 単体テスト実装

---

## 3. 機能要件

### FR-001: シングルトンインスタンス管理

**信頼性**: 🟡

**説明**: TooltipManagerはシングルトンパターンで実装し、アプリケーション全体で一つのインスタンスのみを保持する。

**入力**:
- なし（getInstance()でインスタンス取得）

**出力**:
- TooltipManagerインスタンス

**制約**:
- getInstance()は常に同一のインスタンスを返すこと
- 複数のシーンから呼び出しても同一インスタンスであること
- テスト時にはresetInstance()でリセット可能にすること

---

### FR-002: シーン初期化

**信頼性**: 🟡

**説明**: TooltipManagerを特定のPhaserシーンに紐付けて初期化する。

**入力**:
- scene: Phaser.Scene - 紐付けるシーンインスタンス

**出力**:
- なし（内部状態の更新）

**制約**:
- sceneがnullまたはundefinedの場合はエラー
- 初期化時にツールチップコンテナを作成すること
- 既に初期化済みの場合は前のコンテナを破棄してから再初期化

---

### FR-003: ツールチップ表示

**信頼性**: 🟡

**説明**: 指定された設定でツールチップを表示する。遅延設定がある場合は指定時間後に表示する。

**入力**:
- config: TooltipConfig
  - content: string - 表示するテキスト
  - x: number - 表示位置X座標
  - y: number - 表示位置Y座標
  - delay?: number - 表示遅延（ms）、デフォルト500ms
  - maxWidth?: number - 最大幅、デフォルト200px

**出力**:
- なし（ツールチップの表示）

**制約**:
- 初期化前に呼び出された場合は何もしない（エラーを投げない）
- 既にツールチップが表示中の場合は前のものを非表示にしてから表示
- 遅延中に再度show()が呼ばれた場合は前のタイマーをキャンセル

---

### FR-004: ツールチップ非表示

**信頼性**: 🟡

**説明**: 表示中のツールチップを非表示にする。遅延タイマーが動作中の場合はキャンセルする。

**入力**:
- なし

**出力**:
- なし（ツールチップの非表示）

**制約**:
- 表示前（遅延中）に呼び出された場合はタイマーをキャンセル
- 既に非表示の場合は何もしない
- 初期化前に呼び出された場合は何もしない

---

### FR-005: 表示位置の自動調整

**信頼性**: 🟡

**説明**: ツールチップが画面端からはみ出さないよう、表示位置を自動調整する。

**入力**:
- x: number - 希望X座標
- y: number - 希望Y座標

**出力**:
- 調整後の座標（内部処理）

**制約**:
- 右端からはみ出す場合は左方向にシフト
- 下端からはみ出す場合は上方向にシフト
- 上端・左端のチェックも行い、最小10pxのマージンを確保
- camera.width/heightを使用して画面サイズを取得

---

### FR-006: コンテンツ更新

**信頼性**: 🟡

**説明**: ツールチップの表示内容を更新する。

**入力**:
- content: string - 新しいテキスト内容
- maxWidth?: number - 最大幅

**出力**:
- なし（表示内容の更新）

**制約**:
- テキストのwordWrapを適用すること
- 背景サイズをテキストサイズに合わせて自動調整
- パディングを考慮（左右8px、上下8px）

---

### FR-007: リソース破棄

**信頼性**: 🟡

**説明**: TooltipManagerのリソースを解放する。

**入力**:
- なし

**出力**:
- なし（リソースの解放）

**制約**:
- 遅延タイマーをキャンセル
- ツールチップコンテナを破棄
- sceneへの参照をクリア
- 再度initialize()を呼び出せば再利用可能

---

## 4. 非機能要件

### NFR-001: パフォーマンス

**カテゴリ**: パフォーマンス

**説明**: ツールチップの表示・非表示は即座に行われ、ゲームのフレームレートに影響を与えない。

**基準**:
- 表示・非表示処理は1フレーム（16ms）以内に完了
- メモリリークを発生させない

---

### NFR-002: 深度管理

**カテゴリ**: 表示優先度

**説明**: ツールチップは他のUI要素より前面に表示される。

**基準**:
- depth値: 500〜600（Toast同等または上）
- 推奨値: 1000（最前面）

---

### NFR-003: 保守性

**カテゴリ**: 保守性

**説明**: コードはClean Architectureに従い、presentation層に配置される。

**基準**:
- ファイル配置: `src/presentation/ui/components/TooltipManager.ts`
- 他層への依存なし（Domain/Applicationに依存しない）

---

### NFR-004: テスタビリティ

**カテゴリ**: テスト容易性

**説明**: 単体テストで十分にテスト可能な設計とする。

**基準**:
- シングルトンのリセット機能（resetInstance()）
- Phaserモックとの互換性
- カバレッジ80%以上

---

## 5. インターフェース定義

### 入力インターフェース

```typescript
/**
 * ツールチップ設定
 */
export interface TooltipConfig {
  /** 表示するテキスト内容 */
  content: string;
  /** 表示位置X座標 */
  x: number;
  /** 表示位置Y座標 */
  y: number;
  /** 表示遅延（ms）、デフォルト500ms */
  delay?: number;
  /** 最大幅（px）、デフォルト200px */
  maxWidth?: number;
}
```

### 出力インターフェース

```typescript
/**
 * TooltipManager クラス
 * シングルトンパターンで実装
 */
export class TooltipManager {
  /**
   * シングルトンインスタンスを取得
   */
  static getInstance(): TooltipManager;

  /**
   * テスト用: インスタンスをリセット
   */
  static resetInstance(): void;

  /**
   * シーンを紐付けて初期化
   * @param scene - Phaserシーン
   */
  initialize(scene: Phaser.Scene): void;

  /**
   * ツールチップを表示
   * @param config - 表示設定
   */
  show(config: TooltipConfig): void;

  /**
   * ツールチップを非表示
   */
  hide(): void;

  /**
   * リソースを破棄
   */
  destroy(): void;

  /**
   * 初期化済みかどうか
   */
  isInitialized(): boolean;

  /**
   * 現在表示中かどうか
   */
  isVisible(): boolean;
}
```

---

## 6. エラーケース

| エラーコード | 条件 | 処理 |
|------------|------|------|
| ERR-001 | initialize()にnull/undefinedのsceneを渡す | Errorをスロー |
| ERR-002 | initialize()にscene.add.containerがないsceneを渡す | Errorをスロー |
| ERR-003 | 初期化前にshow()を呼び出す | 何もしない（エラーなし） |
| ERR-004 | 初期化前にhide()を呼び出す | 何もしない（エラーなし） |
| ERR-005 | TooltipConfigのcontentが空文字 | そのまま表示（空のツールチップ） |
| ERR-006 | TooltipConfigのx, yがNaN/Infinity | 0, 0として扱う（警告ログ出力） |

---

## 7. 依存関係

### 外部依存

- **Phaser 3** (3.87+): ゲームエンジン本体
  - Phaser.Scene: シーン管理
  - Phaser.GameObjects.Container: UIコンテナ
  - Phaser.GameObjects.Rectangle: 背景
  - Phaser.GameObjects.Text: テキスト表示

### 内部依存

- なし（独立したコンポーネント）

### 参照（依存ではない）

- `src/presentation/ui/theme.ts`: カラーパレット・スタイル定義

---

## 8. テスト戦略

### テスト対象

1. **シングルトンパターン**
   - getInstance()が同一インスタンスを返す
   - resetInstance()でリセットできる

2. **初期化処理**
   - initialize()でツールチップコンテナが作成される
   - 無効なsceneでエラーがスローされる

3. **表示/非表示**
   - show()でツールチップが表示される
   - hide()でツールチップが非表示になる
   - 遅延表示が正しく動作する

4. **位置調整**
   - 右端からはみ出す場合に左にシフト
   - 下端からはみ出す場合に上にシフト
   - 上端・左端の境界チェック

5. **リソース管理**
   - destroy()でリソースが解放される
   - タイマーがキャンセルされる

### テスト除外

- **実際のPhaser描画**: Phaserの内部レンダリング処理はテスト対象外
- **rexUIプラグイン**: 現在のシンプル実装ではrexUIを使用しない

### モック対象

- **Phaser.Scene**: シーンのモック
- **Phaser.GameObjects.Container**: コンテナのモック
- **Phaser.GameObjects.Rectangle**: 背景のモック
- **Phaser.GameObjects.Text**: テキストのモック
- **setTimeout/clearTimeout**: タイマーのモック（vi.useFakeTimers()）

---

## 9. 設計上の注意点

### 9.1 シングルトンパターンの考慮

- テスト容易性のためresetInstance()を提供
- シーン遷移時に前のシーンのリソースを解放すること
- 複数シーンでの再利用を考慮した設計

### 9.2 depth管理

- ツールチップは最前面に表示（depth: 1000）
- 他のUI要素と競合しないこと
- Toast（depth: 500）より上に設定

### 9.3 座標の境界チェック

- scene.cameras.main.width/heightで画面サイズを取得
- マージンは10pxを確保
- ツールチップのサイズを考慮した計算

### 9.4 メモリリーク防止

- destroy()でタイマー、コンテナ、参照を全て解放
- シーン破棄時に自動的にクリーンアップ
- イベントリスナーがある場合は確実に削除

### 9.5 表示遅延の実装

- setTimeoutを使用（Phaser.timeではなくブラウザ標準）
- タイマーIDを保持し、適切にclearTimeout
- デフォルト遅延: 500ms（ユーザビリティを考慮）

---

## 10. 受け入れ基準

### AC-001: シングルトンインスタンス

**Given**: TooltipManagerが未初期化の状態
**When**: getInstance()を複数回呼び出す
**Then**: 全ての呼び出しで同一のインスタンスが返される

---

### AC-002: シーン初期化

**Given**: TooltipManagerインスタンスが取得済み
**When**: 有効なPhaserシーンでinitialize()を呼び出す
**Then**: ツールチップコンテナが作成され、isInitialized()がtrueを返す

---

### AC-003: ツールチップ表示

**Given**: TooltipManagerが初期化済み
**When**: show()を呼び出し、遅延時間が経過する
**Then**: 指定位置にツールチップが表示される

---

### AC-004: 表示遅延キャンセル

**Given**: show()が呼び出され、遅延中
**When**: 遅延時間経過前にhide()を呼び出す
**Then**: ツールチップは表示されない

---

### AC-005: 画面右端での位置調整

**Given**: TooltipManagerが初期化済み
**When**: 画面右端付近（x = 画面幅 - 50）でshow()を呼び出す
**Then**: ツールチップが画面内に収まるよう左にシフトされる

---

### AC-006: 画面下端での位置調整

**Given**: TooltipManagerが初期化済み
**When**: 画面下端付近（y = 画面高さ - 50）でshow()を呼び出す
**Then**: ツールチップが画面内に収まるよう上にシフトされる

---

### AC-007: リソース解放

**Given**: TooltipManagerが初期化済みでツールチップ表示中
**When**: destroy()を呼び出す
**Then**: タイマーがキャンセルされ、コンテナが破棄され、isInitialized()がfalseを返す

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-20 | 1.0.0 | 初版作成 |
