# TASK-0045: 調合フェーズUI実装（再実装） 要件定義書

**バージョン**: 1.0.0
**作成日**: 2026-01-21
**タスクID**: TASK-0045
**カテゴリ**: UI層 (Presentation)

---

## 1. 概要

### 1.1 目的

本タスクは、調合フェーズのUIコンポーネントを実装することを目的とする。プレイヤーがレシピを選択し、素材を配置して調合を実行できるインターフェースを提供する。

### 1.2 スコープ

| 項目 | 内容 |
|------|------|
| **実装対象** | AlchemyPhaseUI, RecipeListUI |
| **依存サービス** | IAlchemyService |
| **参照実装** | GatheringPhaseUI, DeliveryPhaseUI |
| **対象レイヤー** | Presentation層 |

### 1.3 前提条件

- IAlchemyService（TASK-0012）が実装済みであること
- BaseComponent（TASK-0018）が利用可能であること
- MaterialSlotUI（TASK-0044）が利用可能であること

---

## 2. 機能要件（EARS記法）

### 2.1 AlchemyPhaseUI コンポーネント

#### 2.1.1 初期化（Ubiquitous）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-001 | システムは、AlchemyPhaseUIを初期化する際、BaseComponentを継承して作成するものとする | 🔵青 |
| FR-002 | システムは、初期化時にIAlchemyServiceをコンストラクタで受け取るものとする | 🔵青 |
| FR-003 | システムは、初期化時に調合完了時のコールバック関数をオプションで受け取るものとする | 🔵青 |
| FR-004 | システムは、create()メソッドで全てのUI要素を作成するものとする | 🔵青 |
| FR-005 | システムは、destroy()メソッドで全てのUI要素を適切に破棄するものとする | 🔵青 |

#### 2.1.2 レシピ一覧表示（Event-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-010 | プレイヤーが調合フェーズに入ったとき、システムは利用可能なレシピ一覧を左側パネルに表示するものとする | 🔵青 |
| FR-011 | プレイヤーがレシピをクリックしたとき、システムはそのレシピを選択状態にするものとする | 🔵青 |
| FR-012 | レシピが選択されたとき、システムは必要素材情報を調合エリアに表示するものとする | 🔵青 |
| FR-013 | レシピが選択されたとき、システムは対応する素材スロットを表示するものとする | 🔵青 |

#### 2.1.3 素材選択（Event-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-020 | プレイヤーが所持素材をクリックしたとき、システムはその素材を選択中の素材スロットに配置するものとする | 🔵青 |
| FR-021 | 素材がスロットに配置されたとき、システムは所持素材一覧から該当素材の表示を更新するものとする | 🟡黄 |
| FR-022 | プレイヤーが配置済み素材をクリックしたとき、システムはその素材をスロットから取り除くものとする | 🟡黄 |
| FR-023 | 素材がスロットに配置されたとき、システムはpreviewQuality()を使用して品質プレビューを更新するものとする | 🔵青 |

#### 2.1.4 品質プレビュー（State-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-030 | レシピと素材が選択されている間、システムは完成品の予測品質を表示するものとする | 🔵青 |
| FR-031 | 素材が変更されている間、システムはリアルタイムで品質プレビューを更新するものとする | 🔵青 |
| FR-032 | 必要素材が不足している間、システムは品質プレビューを「-」または空白で表示するものとする | 🟡黄 |

#### 2.1.5 調合実行（Event-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-040 | プレイヤーが調合ボタンをクリックしたとき、システムはalchemyService.craft()を呼び出すものとする | 🔵青 |
| FR-041 | 調合が成功したとき、システムは生成されたItemInstanceをコールバックで通知するものとする | 🔵青 |
| FR-042 | 調合が成功したとき、システムは使用した素材を素材スロットからクリアするものとする | 🔵青 |
| FR-043 | 調合が成功したとき、システムは選択状態をリセットするものとする | 🟡黄 |

#### 2.1.6 調合ボタン状態（State-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-050 | 必要素材が全て揃っている間、システムは調合ボタンを有効状態にするものとする | 🔵青 |
| FR-051 | 必要素材が不足している間、システムは調合ボタンを無効状態にするものとする | 🔵青 |
| FR-052 | レシピが未選択の間、システムは調合ボタンを無効状態にするものとする | 🔵青 |

### 2.2 RecipeListUI コンポーネント

#### 2.2.1 初期化（Ubiquitous）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-100 | システムは、RecipeListUIを初期化する際、BaseComponentを継承して作成するものとする | 🔵青 |
| FR-101 | システムは、初期化時にIRecipeCardMaster[]を受け取るものとする | 🔵青 |
| FR-102 | システムは、初期化時に選択時コールバック関数をオプションで受け取るものとする | 🔵青 |

#### 2.2.2 レシピ表示（Ubiquitous）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-110 | システムは、各レシピを縦方向のリストとして表示するものとする | 🔵青 |
| FR-111 | システムは、各レシピにレシピ名を表示するものとする | 🔵青 |
| FR-112 | システムは、各レシピに必要素材の要約（素材名×数量）を表示するものとする | 🔵青 |

#### 2.2.3 選択状態（Event-Driven）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-120 | プレイヤーがレシピをクリックしたとき、システムはそのレシピをハイライト表示するものとする | 🔵青 |
| FR-121 | プレイヤーがレシピをクリックしたとき、システムはコールバック関数を呼び出すものとする | 🔵青 |
| FR-122 | 新しいレシピが選択されたとき、システムは以前の選択を解除するものとする | 🔵青 |

### 2.3 異常系（Unwanted Behavior）

| ID | 要件 | 信頼性 |
|----|------|--------|
| FR-200 | 存在しないレシピIDが指定された場合、システムはエラーをコンソールにログ出力し、処理を中断するものとする | 🔵青 |
| FR-201 | 素材不足で調合を試みた場合、システムはボタンが無効なため処理を実行しないものとする | 🔵青 |
| FR-202 | sceneがnullまたはundefinedの場合、システムはコンストラクタでエラーをスローするものとする | 🔵青 |
| FR-203 | IAlchemyServiceがnullの場合、システムはコンストラクタでエラーをスローするものとする | 🟡黄 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 | 信頼性 |
|----|------|--------|
| NFR-001 | UIの初期化は100ms以内に完了するものとする | 🟡黄 |
| NFR-002 | 品質プレビューの更新は16ms以内（60FPS維持）に完了するものとする | 🟡黄 |
| NFR-003 | レシピリストは最大20件まで表示可能とする | 🟡黄 |

### 3.2 保守性

| ID | 要件 | 信頼性 |
|----|------|--------|
| NFR-010 | コードはBiomeのルールに準拠するものとする | 🔵青 |
| NFR-011 | 各クラスにJSDocコメントを記述するものとする | 🔵青 |
| NFR-012 | 信頼性レベル（青/黄/赤）をコメントで明記するものとする | 🔵青 |
| NFR-013 | UI定数は専用の定数オブジェクトで管理するものとする | 🔵青 |

### 3.3 テスタビリティ

| ID | 要件 | 信頼性 |
|----|------|--------|
| NFR-020 | サービスはコンストラクタインジェクションで受け取るものとする | 🔵青 |
| NFR-021 | ユニットテストのカバレッジは80%以上を達成するものとする | 🔵青 |
| NFR-022 | Phaserシーンはモック可能な設計とするものとする | 🔵青 |

### 3.4 一貫性

| ID | 要件 | 信頼性 |
|----|------|--------|
| NFR-030 | THEMEで定義された色・フォント・サイズを使用するものとする | 🔵青 |
| NFR-031 | GatheringPhaseUI・DeliveryPhaseUIと同様の実装パターンに従うものとする | 🔵青 |
| NFR-032 | パスエイリアス（@domain, @presentation等）を使用するものとする | 🔵青 |

---

## 4. 受け入れ基準

### 4.1 必須基準（MUST）

| ID | 基準 | テストID |
|----|------|----------|
| AC-001 | AlchemyPhaseUI.tsファイルが`src/presentation/ui/phases/`に作成される | T-0045-01 |
| AC-002 | RecipeListUI.tsファイルが`src/presentation/ui/components/`に作成される | T-0045-01 |
| AC-003 | レシピ一覧が表示され、選択可能である | T-0045-02 |
| AC-004 | 素材をスロットに配置できる | T-0045-03 |
| AC-005 | 完成品質がプレビュー表示される | T-0045-04 |
| AC-006 | 調合ボタンで調合を実行できる | T-0045-05 |
| AC-007 | 素材不足時に調合ボタンが無効化される | T-0045-06 |
| AC-008 | 全てのテストケースがパスする | - |
| AC-009 | Biome lintエラーがゼロである | - |

### 4.2 推奨基準（SHOULD）

| ID | 基準 | 備考 |
|----|------|------|
| AC-010 | 調合可能なレシピが視覚的に区別される | フィルタリング機能 |
| AC-011 | 素材不足時に不足素材が赤くハイライトされる | 警告表示 |
| AC-012 | レシピ選択時にスムーズなアニメーションがある | UX向上 |

### 4.3 オプション基準（MAY）

| ID | 基準 | 備考 |
|----|------|------|
| AC-020 | 調合成功時にエフェクト/アニメーションが表示される | 演出強化 |
| AC-021 | キーボードショートカットに対応する | アクセシビリティ |

---

## 5. 境界値・エッジケース

### 5.1 レシピリスト

| ケース | 入力 | 期待結果 | 信頼性 |
|--------|------|----------|--------|
| 空リスト | recipes = [] | 空のリスト表示、選択不可 | 🔵青 |
| 1件 | recipes.length = 1 | 1件表示、選択可能 | 🔵青 |
| 最大件数 | recipes.length = 20 | スクロール可能なリスト表示 | 🟡黄 |
| 超過 | recipes.length > 20 | 上位20件を表示 | 🔴赤 |

### 5.2 素材選択

| ケース | 入力 | 期待結果 | 信頼性 |
|--------|------|----------|--------|
| 素材0件 | materials = [] | 所持素材エリア空表示 | 🔵青 |
| 必要数ちょうど | 必要数 = 所持数 | 全スロット配置可能 | 🔵青 |
| 素材不足 | 必要数 > 所持数 | 調合ボタン無効 | 🔵青 |
| 素材余剰 | 必要数 < 所持数 | 選択可能な素材を表示 | 🔵青 |

### 5.3 品質

| ケース | 入力 | 期待結果 | 信頼性 |
|--------|------|----------|--------|
| 最低品質（D） | 全素材がD品質 | D品質プレビュー | 🔵青 |
| 最高品質（S） | 全素材がS品質 | S品質プレビュー | 🔵青 |
| 混合品質 | 異なる品質の素材 | 平均品質に基づくプレビュー | 🔵青 |
| 最低品質制限 | minQuality設定あり | 条件を満たさない素材は選択不可 | 🔵青 |

---

## 6. テストケース概要

| テストID | テスト内容 | カバー要件 |
|----------|----------|------------|
| T-0045-01 | AlchemyPhaseUI初期化 | FR-001〜FR-005, FR-100〜FR-102 |
| T-0045-02 | レシピ選択 | FR-010〜FR-013, FR-110〜FR-122 |
| T-0045-03 | 素材選択 | FR-020〜FR-023 |
| T-0045-04 | 品質プレビュー | FR-030〜FR-032 |
| T-0045-05 | 調合実行 | FR-040〜FR-043 |
| T-0045-06 | 素材不足 | FR-050〜FR-052, FR-201 |
| T-0045-07 | 異常系 | FR-200, FR-202, FR-203 |

---

## 7. 成果物

| 成果物 | パス |
|--------|------|
| フェーズUI | `src/presentation/ui/phases/AlchemyPhaseUI.ts` |
| レシピリスト | `src/presentation/ui/components/RecipeListUI.ts` |
| ユニットテスト | `tests/unit/presentation/alchemy-phase-ui.test.ts` |

---

## 8. 信頼性レベル凡例

| レベル | 意味 | 根拠 |
|--------|------|------|
| 🔵青 | 設計文書に明記 | TASK-0045.md, note.md, IAlchemyService定義 |
| 🟡黄 | 設計文書から妥当な推測 | GatheringPhaseUI/DeliveryPhaseUI実装パターン |
| 🔴赤 | 設計文書にない推測 | 一般的なUIパターン |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-21 | 1.0.0 | 初版作成 |
