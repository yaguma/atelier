# TASK-0104: QuestBoardService実装

**タスクID**: TASK-0104
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 1 - Domain層 基盤整備
**信頼性レベル**: 🟡 *REQ-005・design-interview.md D5から妥当な推測*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-005, REQ-005-01〜REQ-005-03
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **型定義**: [📝 interfaces.ts](../../design/free-phase-navigation/interfaces.ts)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md) - セクション6

## タスク概要

掲示板方式の依頼管理サービスを新規作成する。掲示板依頼の累積・期限切れ削除、訪問依頼の3日ごとの更新をFunctional Coreパターンで実装する。

## 依存タスク

- **前提タスク**: [TASK-0102: フェーズ遷移定義の更新とIGameState拡張](TASK-0102.md)
- **後続タスク**: [TASK-0109: QuestService - 掲示板方式対応](TASK-0109.md), [TASK-0110: GameFlowManager - 掲示板連携統合](TASK-0110.md)

## 完了条件

- [ ] QuestBoardServiceがFunctional Core（純粋関数）として実装されている
- [ ] updateBoard()が期限切れ依頼の除去と訪問依頼の更新を正しく行う
- [ ] acceptBoardQuest()/acceptVisitorQuest()が受注処理を正しく行う
- [ ] テストが全て通る

---

## 実装詳細

### 1. QuestBoardService 実装 🟡

**信頼性**: 🟡 *REQ-005・interfaces.ts IQuestBoardServiceから妥当な推測*

**実装ファイル**: `src/features/quest/services/quest-board-service.ts`

```typescript
export function updateBoard(input: IQuestBoardUpdateInput): IQuestBoardUpdateResult {
  // 1. 期限切れ掲示板依頼の除去
  // 2. 訪問依頼の更新判定（3日ごと）
  // 3. 掲示板枠に空きがあれば新規依頼追加
}

export function acceptBoardQuest(board: IQuestBoardState, questId: string): IQuestBoardState {
  // 掲示板から依頼を削除して受注済みに
}

export function acceptVisitorQuest(board: IQuestBoardState, questId: string): IQuestBoardState {
  // 訪問依頼から受注
}
```

### 2. 期限切れ処理ロジック 🔵

**信頼性**: 🔵 *REQ-005-01「掲示板には依頼が累積的に掲載され、期限切れまで残る」より*

掲示板依頼のexpiryDayがcurrentDay以下の場合、依頼を除去する。

### 3. 訪問依頼更新ロジック 🔵

**信頼性**: 🔵 *REQ-005-02「訪問依頼は3日ごとに更新」より*

lastVisitorUpdateDayとcurrentDayの差が更新間隔（3日）以上の場合、訪問依頼を差し替える。

---

## 単体テスト要件

### テストケース1: 期限切れ依頼の除去 🔵

**信頼性**: 🔵 *REQ-005-01より*

**Given**: currentDay=5, 掲示板に期限切れ依頼（expiryDay=4）あり
**When**: updateBoard()を呼び出す
**Then**: 期限切れ依頼が除去される

### テストケース2: 訪問依頼の更新 🔵

**信頼性**: 🔵 *REQ-005-02より*

**Given**: lastVisitorUpdateDay=1, currentDay=4, 更新間隔=3
**When**: updateBoard()を呼び出す
**Then**: 訪問依頼が新しいものに差し替えられる

### テストケース3: 訪問依頼の更新タイミング前 🔵

**信頼性**: 🔵 *REQ-005-02より*

**Given**: lastVisitorUpdateDay=2, currentDay=3, 更新間隔=3
**When**: updateBoard()を呼び出す
**Then**: 訪問依頼は変更されない

### テストケース4: 掲示板依頼の受注 🔵

**信頼性**: 🔵 *dataflow.md セクション6.2より*

**Given**: 掲示板に依頼が存在
**When**: acceptBoardQuest(questId)を呼び出す
**Then**: 指定依頼が掲示板から削除される

### テストケース5: ランクによる更新頻度変化 🟡

**信頼性**: 🟡 *REQ-005-03から妥当な推測*

**Given**: ランクによる更新頻度設定がある
**When**: updateBoard()を呼び出す
**Then**: ランクに応じた掲示板更新が行われる

---

## 統合テスト要件

### 統合テスト1: QuestServiceとの連携 🟡

**信頼性**: 🟡 *architecture.md・dataflow.mdから妥当な推測*

**テスト内容**: QuestBoardService.updateBoard()がQuestService.generateBoardQuests()を正しく活用するか
**期待結果**: 掲示板に新規依頼が正しく追加される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0104` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 純粋関数として実装すること（外部状態を参照・変更しない）
- 訪問依頼の更新間隔（「数日」の定義）は定数化し、将来的にランク連動に拡張可能にする
- 既存のQuestServiceの依頼生成ロジックを活用（重複実装しない）

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 2 | 1 | 0 | 3 |
| 単体テスト | 4 | 1 | 0 | 5 |
| 統合テスト | 0 | 1 | 0 | 1 |

### 全体評価

- **総項目数**: 9項目
- 🔵 **青信号**: 6項目 (67%)
- 🟡 **黄信号**: 3項目 (33%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: 掲示板更新のAPI設計、ランクによる更新頻度
