# TASK-0107: GameFlowManager - processAPOverflow()メソッド追加

**タスクID**: TASK-0107
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - Application層 フロー制御
**信頼性レベル**: 🔵 *REQ-003・architecture.md・dataflow.md セクション3より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-003, REQ-003-01〜REQ-003-06, EDGE-002
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md) - セクション3

## タスク概要

AP超過時の自動日進行処理をGameFlowManagerに追加する。APOverflowServiceの計算結果を受け取り、消費日数分のendDay()を順次実行し、ゲームオーバー判定も行う。

## 依存タスク

- **前提タスク**: [TASK-0103: APOverflowService実装](TASK-0103.md)
- **後続タスク**: [TASK-0115: APOverflowPreview実装](TASK-0115.md)

## 完了条件

- [ ] processAPOverflow()が消費日数分のendDay()を順次実行する
- [ ] 各endDay()で既存の日終了処理が正しく実行される
- [ ] ゲームオーバー判定が各日で正しく行われる
- [ ] IAutoAdvanceDayResultが正しく返される
- [ ] テストが全て通る

---

## 実装詳細

### 1. processAPOverflow()メソッド 🔵

**信頼性**: 🔵 *architecture.md「processAPOverflow(consumedAP)」・dataflow.md セクション3.1より*

**実装ファイル**: `src/shared/services/game-flow/game-flow-manager.ts`

```typescript
async processAPOverflow(overflowResult: IAPOverflowResult): Promise<IAutoAdvanceDayResult> {
  // 1. overflowResult.daysConsumed分のendDay()を順次実行
  // 2. 各endDay()後にゲームオーバー判定
  // 3. 途中でゲームオーバーなら停止
  // 4. 最終的にnextDayAPを設定
  // 5. IAutoAdvanceDayResultを返却
}
```

### 2. 順次endDay()実行 🔵

**信頼性**: 🔵 *EDGE-002「各日の日終了処理を順次実行」・design-interview.md D6より*

各endDay()で以下を実行:
1. 残り日数を1減算
2. 依頼期限更新（updateDeadlines()）
3. 手札補充（refillHand()）
4. 掲示板更新
5. ランク判定
6. セーブ

### 3. ゲームオーバー判定 🔵

**信頼性**: 🔵 *REQ-003-04「残り日数が0以下になった場合、ゲームオーバー判定」より*

各endDay()後に残り日数をチェックし、0以下ならゲームオーバー。

---

## 単体テスト要件

### テストケース1: 1日分のAP超過処理 🔵

**Given**: overflowResult={daysConsumed: 1, nextDayAP: 2}
**When**: processAPOverflow()を呼び出す
**Then**: endDay()が1回実行、newActionPoints=2

### テストケース2: 複数日分のAP超過処理 🟡

**Given**: overflowResult={daysConsumed: 2, nextDayAP: 2}
**When**: processAPOverflow()を呼び出す
**Then**: endDay()が2回実行、各日で日終了処理が実行

### テストケース3: AP超過中のゲームオーバー 🔵

**Given**: remainingDays=1, overflowResult={daysConsumed: 2}
**When**: processAPOverflow()を呼び出す
**Then**: 1回目のendDay()後にゲームオーバー、isGameOver=true

### テストケース4: 各endDay()で依頼期限が更新される 🔵

**Given**: 受注済み依頼あり
**When**: processAPOverflow()で2日分処理
**Then**: 依頼期限が2回更新される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0107` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- endDay()の呼び出しは同期的に順次実行（非同期ループに注意）
- ゲームオーバー判定は各日の終了後に行い、途中停止の可能性を考慮
- DAY_ENDED/DAY_STARTEDイベントは各日ごとに発行される

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 3 | 0 | 0 | 3 |
| 単体テスト | 3 | 1 | 0 | 4 |

### 全体評価

- **総項目数**: 7項目
- 🔵 **青信号**: 6項目 (86%)
- 🟡 **黄信号**: 1項目 (14%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質
