# TASK-0105: 採取場所データ定義とGatheringService拡張

**タスクID**: TASK-0105
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 1 - Domain層 基盤整備
**信頼性レベル**: 🔵 *REQ-002・architecture.md・ヒアリングQ4より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-002, REQ-002-01〜REQ-002-05
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **型定義**: [📝 interfaces.ts](../../design/free-phase-navigation/interfaces.ts)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md) - セクション4

## タスク概要

採取2段階化に必要な場所データ定義と、GatheringServiceへの場所関連メソッド追加を行う。IGatheringLocation型の実装、場所データの定義、手札連動のフィルタリングロジックを実装する。

## 依存タスク

- **前提タスク**: なし（独立して実装可能）
- **後続タスク**: [TASK-0113: LocationSelectUI実装](TASK-0113.md), [TASK-0114: GatheringPhaseUI変更](TASK-0114.md)

## 完了条件

- [ ] IGatheringLocation型が実装されている
- [ ] 採取場所マスタデータが定義されている
- [ ] GatheringServiceに場所一覧取得・フィルタリングメソッドが追加されている
- [ ] 手札カードとの連動ロジックが実装されている
- [ ] テストが全て通る

---

## 実装詳細

### 1. 採取場所型定義の実装 🔵

**信頼性**: 🔵 *interfaces.ts IGatheringLocation・IMaterialPreviewより*

**実装ファイル**: `src/features/gathering/types/gathering-location.ts`

IGatheringLocation, IMaterialPreview, GatheringStage, ILocationSelectResult の型を実装する。

### 2. 採取場所マスタデータ 🟡

**信頼性**: 🟡 *REQ-002-01〜REQ-002-03から妥当な推測（具体的な場所データは未定義）*

**実装ファイル**: `src/features/gathering/data/locations.ts`

採取場所のマスタデータを定義する。各場所には名前、移動APコスト、採取可能素材、マップ座標を含む。

### 3. GatheringService拡張 🔵

**信頼性**: 🔵 *REQ-002-04・REQ-002-05・dataflow.md セクション4.1より*

**実装ファイル**: `src/features/gathering/services/gathering-service.ts`

```typescript
// 新規メソッド
getAvailableLocations(hand: Card[]): IGatheringLocation[];
getLocationDetail(cardId: string): IGatheringLocation | undefined;
```

手札にある採取地カードと連動し、選択可能な場所のみを返す。

---

## 単体テスト要件

### テストケース1: 手札カードに対応する場所のみ返す 🔵

**信頼性**: 🔵 *REQ-002-04「手札にある採取地カードと連動」より*

**Given**: 手札に「近くの森」「鉱山」のカードがある
**When**: getAvailableLocations(hand)を呼び出す
**Then**: 「近くの森」「鉱山」のみがisSelectable=trueで返される

### テストケース2: 手札に採取地カードがない場合 🟡

**信頼性**: 🟡 *EDGE-103から妥当な推測*

**Given**: 手札に採取地カードがない
**When**: getAvailableLocations(hand)を呼び出す
**Then**: 空配列が返される

### テストケース3: 各場所にAPコストと素材プレビューが含まれる 🔵

**信頼性**: 🔵 *REQ-002-02・REQ-002-03より*

**Given**: 場所データが定義されている
**When**: getLocationDetail(cardId)を呼び出す
**Then**: movementAPCostとavailableMaterialsが正しく含まれる

### テストケース4: GatheringStage状態遷移 🔵

**信頼性**: 🔵 *dataflow.md セクション4.2 状態遷移図より*

**Given**: 初期状態はLOCATION_SELECT
**When**: 場所を選択
**Then**: DRAFT_SESSIONに遷移

---

## 統合テスト要件

### 統合テスト1: DeckServiceとの連携 🔵

**信頼性**: 🔵 *dataflow.md セクション4.1 「手札カードフィルタ」より*

**テスト内容**: DeckService.getHand()から取得したカードでgetAvailableLocations()が正しく動作するか
**期待結果**: 手札の採取地カードに対応する場所のみ返される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0105` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 採取場所マスタデータの具体的な値はゲームバランスに依存するため、初期値は仮設定で良い
- 既存のGatheringServiceの構造を破壊しないよう、メソッド追加で対応
- 将来的にマップビジュアルを追加する拡張性を考慮する（mapX, mapY座標を含める）

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 2 | 1 | 0 | 3 |
| 単体テスト | 3 | 1 | 0 | 4 |
| 統合テスト | 1 | 0 | 0 | 1 |

### 全体評価

- **総項目数**: 8項目
- 🔵 **青信号**: 6項目 (75%)
- 🟡 **黄信号**: 2項目 (25%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: 採取場所マスタデータの具体的な値、手札0枚時の動作
