# TASK-0119: 統合テスト - AP超過自動日進行

**タスクID**: TASK-0119
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 統合テスト・E2E
**信頼性レベル**: 🔵 *REQ-003, EDGE-002, 設計文書dataflow.mdより*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md)
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md)

## タスク概要

AP超過による自動日進行機能の統合テストを実装する。APOverflowService、GameFlowManager.processAPOverflow()、APOverflowPreviewの連携を検証する。単日・複数日の消費、ゲームオーバー判定、プレビュー表示を網羅的にテストする。

## 依存タスク

- **前提タスク**: [TASK-0107](TASK-0107.md), [TASK-0115](TASK-0115.md)
- **後続タスク**: [TASK-0121](TASK-0121.md)

## 完了条件

- [ ] AP超過による単日自動日進行が正しく動作
- [ ] 複数日消費（EDGE-002）時の順次endDay()が正しく動作
- [ ] ゲームオーバー判定が各日の日終了で正しく実行
- [ ] AP超過プレビューが正しく表示され、続行/キャンセルが動作
- [ ] startDay()でのAP回復（MAX_AP - apOverflow）が正しく動作
- [ ] 全テストが成功

---

## 実装詳細

### 1. AP超過計算テスト 🔵

**信頼性**: 🔵 *REQ-003-01「超過分は翌日APから差し引き」、architecture.md AP超過計算テーブルより*

**テストファイル**: `tests/integration/free-phase-navigation/ap-overflow.test.ts`

テスト項目（計算テーブルに基づく全パターン）:
- AP消費1、残AP3 → 超過なし、翌日AP3
- AP消費3、残AP3 → 超過なし、翌日AP3
- AP消費4、残AP3 → 超過1、1日消費、翌日AP2
- AP消費5、残AP3 → 超過2、1日消費、翌日AP1
- AP消費6、残AP3 → 超過3、1日消費、翌日AP3（ちょうど1日分）
- AP消費7、残AP3 → 超過4、2日消費、翌日AP2
- AP消費3、残AP1 → 超過2、1日消費、翌日AP1
- AP消費4、残AP2 → 超過2、1日消費、翌日AP1

```typescript
describe('AP超過自動日進行 統合テスト', () => {
  it.each([
    { consume: 1, current: 3, expectOverflow: false, expectDays: 0, expectNextAP: 3 },
    { consume: 4, current: 3, expectOverflow: true, expectDays: 1, expectNextAP: 2 },
    { consume: 6, current: 3, expectOverflow: true, expectDays: 1, expectNextAP: 3 },
    { consume: 7, current: 3, expectOverflow: true, expectDays: 2, expectNextAP: 2 },
  ])('AP消費$consume/残$current → $expectDays日消費、翌日AP$expectNextAP', async (params) => {
    // 統合テスト実装
  });
});
```

### 2. 順次日進行テスト 🔵

**信頼性**: 🔵 *EDGE-002「各日の日終了処理を順次実行」、設計判断D6より*

テスト項目:
- 2日消費時にendDay()が2回呼ばれる
- 各endDay()で依頼期限が更新される
- 各endDay()で手札補充が実行される
- 途中でゲームオーバー条件を満たした場合に停止

### 3. ゲームオーバー判定テスト 🔵

**信頼性**: 🔵 *REQ-003-04「自動日進行で残り日数0以下→ゲームオーバー判定」より*

テスト項目:
- 残り日数2で3日消費 → 1日目の日終了後にゲームオーバー
- 残り日数10で2日消費 → 正常に日進行
- ゲームオーバー時にGAME_OVERイベント発行

### 4. AP超過プレビュー連携テスト 🟡

**信頼性**: 🟡 *NFR-102・設計判断D7から妥当な推測*

テスト項目:
- AP超過発生時にプレビューダイアログ表示
- プレビューに消費AP・超過AP・翌日AP・消費日数が表示
- 「続行」ボタンで日進行実行
- 「キャンセル」ボタンで行動取り消し

### 5. startDay() AP回復テスト 🔵

**信頼性**: 🔵 *REQ-003-01、architecture.md startDay()変更点より*

テスト項目:
- apOverflow=0のとき、AP=MAX_AP(3)で回復
- apOverflow=1のとき、AP=MAX_AP-1=2で回復
- apOverflow=2のとき、AP=MAX_AP-2=1で回復
- 回復後にapOverflowが0にリセットされる

---

## 単体テスト要件

本タスクは統合テストが主体のため、単体テスト要件は前提タスク（TASK-0107, TASK-0115）で網羅済み。統合テストではAPOverflowServiceとGameFlowManagerの連携、およびUIプレビューとの連動を中心に検証する。

---

## 統合テスト要件

- APOverflowService + GameFlowManager + StateManager の連携
- AP超過計算 → 日進行処理 → 状態更新のフロー
- endDay()の順次実行と各日での副作用（依頼期限更新、手札補充）
- ゲームオーバー判定の各日チェック
- APOverflowPreview表示とユーザー操作（続行/キャンセル）の連携

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0119` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- テストファイルは `tests/integration/free-phase-navigation/` に配置
- endDay()の副作用（依頼期限更新、手札補充）をモック/スパイで検証
- ゲームオーバー判定はcheckGameOver()の既存実装をモックで制御

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 4 | 1 | 0 | 5 |
| テスト要件 | 4 | 1 | 0 | 5 |

- **総項目数**: 10項目
- 🔵 **青信号**: 8項目 (80%)
- 🟡 **黄信号**: 2項目 (20%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
