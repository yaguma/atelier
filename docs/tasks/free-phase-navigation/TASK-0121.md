# TASK-0121: E2Eテスト - 総合シナリオ

**タスクID**: TASK-0121
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 統合テスト・E2E
**信頼性レベル**: 🟡 *全REQ・NFR要件から妥当な推測（E2Eシナリオ詳細は未定義）*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md)
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md)

## タスク概要

フェーズ自由遷移システム全体のE2Eテストを実装する。Playwrightを使用し、実際のブラウザ上でユーザー操作を模擬する。フェーズ自由遷移、採取2段階化、AP超過自動日進行、依頼掲示板の全機能を組み合わせた統合シナリオをテストする。

## 依存タスク

- **前提タスク**: [TASK-0118](TASK-0118.md), [TASK-0119](TASK-0119.md), [TASK-0120](TASK-0120.md)（全Phase 3タスク完了前提）
- **後続タスク**: なし（最終タスク）

## 完了条件

- [ ] フェーズ自由遷移のE2Eシナリオが動作
- [ ] 採取2段階化のE2Eシナリオが動作
- [ ] AP超過自動日進行のE2Eシナリオが動作
- [ ] 依頼掲示板のE2Eシナリオが動作
- [ ] 複合シナリオ（1日の自由な行動フロー）が動作
- [ ] NFR-001（フェーズ切り替え200ms以内）のパフォーマンス検証
- [ ] 全テストが成功

---

## 実装詳細

### 1. フェーズ自由遷移 E2Eシナリオ 🔵

**信頼性**: 🔵 *REQ-001, REQ-006より*

**テストファイル**: `e2e/specs/free-phase-navigation/phase-switching.spec.ts`

テスト項目:
- タブクリックでフェーズ切り替え（全4フェーズ巡回）
- アクティブタブの視覚的強調確認
- フェーズ切り替え後のUI表示確認
- 「日終了」ボタンで日が進行する

```typescript
test('全フェーズをタブで自由に切り替えできる', async ({ page }) => {
  const mainPage = new MainPage(page);
  await mainPage.goto();

  // 依頼受注 → 採取
  await mainPage.clickPhaseTab('gathering');
  await expect(mainPage.getActiveTab()).toBe('gathering');

  // 採取 → 調合
  await mainPage.clickPhaseTab('alchemy');
  await expect(mainPage.getActiveTab()).toBe('alchemy');

  // 調合 → 納品
  await mainPage.clickPhaseTab('delivery');
  await expect(mainPage.getActiveTab()).toBe('delivery');

  // 納品 → 依頼受注
  await mainPage.clickPhaseTab('quest_accept');
  await expect(mainPage.getActiveTab()).toBe('quest_accept');
});
```

### 2. 採取2段階化 E2Eシナリオ 🟡

**信頼性**: 🟡 *REQ-002から妥当な推測（UI操作の詳細は実装依存）*

テスト項目:
- 採取タブ → 場所選択画面表示
- 場所カードにAPコスト・素材プレビュー表示
- 場所選択 → ドラフト採取画面遷移
- ドラフト採取完了 → 結果表示

### 3. AP超過自動日進行 E2Eシナリオ 🟡

**信頼性**: 🟡 *REQ-003・NFR-101・NFR-102から妥当な推測*

テスト項目:
- AP超過行動実行 → プレビューダイアログ表示
- プレビューに消費AP・翌日AP情報表示
- 「続行」→ 日が進行し通知表示
- 翌日APが超過分差し引かれている
- 日終了処理（依頼期限更新等）が実行されている

### 4. 依頼掲示板 E2Eシナリオ 🟡

**信頼性**: 🟡 *REQ-005から妥当な推測（UI詳細は実装依存）*

テスト項目:
- 依頼受注タブで掲示板と訪問依頼が表示
- 掲示板から依頼受注
- 訪問依頼から依頼受注
- 受注上限（3件）超過時のエラー表示

### 5. 複合シナリオ: 1日の自由な行動フロー 🟡

**信頼性**: 🟡 *全要件を統合した推測*

テスト項目:
1. ゲーム開始 → 依頼受注フェーズ
2. 掲示板から依頼を受注
3. 採取タブへ切り替え → 場所選択 → ドラフト採取
4. 調合タブへ切り替え → アイテム調合
5. 納品タブへ切り替え → 納品実行
6. 依頼タブへ戻り → 追加依頼受注
7. 「日終了」ボタンで日進行

### 6. パフォーマンス検証 🟡

**信頼性**: 🟡 *NFR-001・NFR-002から妥当な推測（具体的計測方法は実装依存）*

テスト項目:
- フェーズ切り替え時間が200ms以内
- 自動日進行処理が500ms以内

---

## 単体テスト要件

本タスクはE2Eテストのため、単体テスト要件は対象外。全前提タスク（TASK-0118, TASK-0119, TASK-0120）の統合テストが合格していることが前提条件。

---

## 統合テスト要件

本タスクはE2Eテストのため、統合テスト要件は前提タスク（TASK-0118, TASK-0119, TASK-0120）で網羅済み。E2Eテストではブラウザ上の実際のユーザー操作を通じた全機能の総合検証を行う。

---

## Page Objects

**ファイル**: `e2e/pages/FreePhaseNavigation/`

- `MainPage.ts` - メインシーン操作（既存を拡張）
- `PhaseTabPage.ts` - タブUI操作
- `LocationSelectPage.ts` - 場所選択操作
- `APOverflowPreviewPage.ts` - AP超過プレビュー操作
- `QuestBoardPage.ts` - 掲示板操作

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0121` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- E2Eテストファイルは `e2e/specs/free-phase-navigation/` に配置
- Page Objectsは `e2e/pages/FreePhaseNavigation/` に配置
- Playwrightの設定（タイムアウト10秒、失敗時スクリーンショット）に従う
- data-testid属性をUI実装時に追加する必要がある
- パフォーマンス検証はPlaywrightのperformance APIを使用

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 1 | 5 | 0 | 6 |
| テスト要件 | 1 | 5 | 0 | 6 |

- **総項目数**: 12項目
- 🔵 **青信号**: 2項目 (17%)
- 🟡 **黄信号**: 10項目 (83%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善（E2Eテストシナリオの詳細はUI実装後に確定する必要あり）

**推測が多い項目**: E2Eシナリオの具体的なUI操作手順、パフォーマンス計測方法、Page Objectの詳細API
