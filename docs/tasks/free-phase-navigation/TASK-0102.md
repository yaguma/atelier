# TASK-0102: フェーズ遷移定義の更新とIGameState拡張

**タスクID**: TASK-0102
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 1 - Domain層 基盤整備
**信頼性レベル**: 🔵 *REQ-001・architecture.md・既存実装より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-001, REQ-003
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **型定義**: [📝 interfaces.ts](../../design/free-phase-navigation/interfaces.ts)

## タスク概要

現在の線形フェーズ遷移（QUEST_ACCEPT→GATHERING→ALCHEMY→DELIVERY）を、全フェーズ間の自由遷移に変更する。併せて、IGameStateにAP超過・掲示板関連のフィールドを追加する。

## 依存タスク

- **前提タスク**: なし（Phase 1の最初のタスク）
- **後続タスク**: [TASK-0103](TASK-0103.md), [TASK-0104](TASK-0104.md), [TASK-0105](TASK-0105.md), [TASK-0106](TASK-0106.md)

## 完了条件

- [ ] VALID_PHASE_TRANSITIONSが全フェーズ間の遷移を許可する
- [ ] IGameStateにapOverflow, questBoardフィールドが追加されている
- [ ] 初期状態にデフォルト値が設定されている
- [ ] 既存テストが全て通る
- [ ] 新規テストが追加されている

---

## 実装詳細

### 1. VALID_PHASE_TRANSITIONSの更新 🔵

**信頼性**: 🔵 *REQ-001-01・設計文書architecture.md・design-interview.md D1より*

**実装ファイル**: `src/shared/services/state-manager/initial-state.ts`

```typescript
// 変更前（線形遷移）
export const VALID_PHASE_TRANSITIONS: Record<GamePhase, GamePhase[]> = {
  [GamePhase.QUEST_ACCEPT]: [GamePhase.GATHERING],
  [GamePhase.GATHERING]: [GamePhase.ALCHEMY],
  [GamePhase.ALCHEMY]: [GamePhase.DELIVERY],
  [GamePhase.DELIVERY]: [GamePhase.QUEST_ACCEPT],
};

// 変更後（自由遷移）
export const VALID_PHASE_TRANSITIONS: Record<GamePhase, GamePhase[]> = {
  [GamePhase.QUEST_ACCEPT]: [GamePhase.GATHERING, GamePhase.ALCHEMY, GamePhase.DELIVERY],
  [GamePhase.GATHERING]: [GamePhase.QUEST_ACCEPT, GamePhase.ALCHEMY, GamePhase.DELIVERY],
  [GamePhase.ALCHEMY]: [GamePhase.QUEST_ACCEPT, GamePhase.GATHERING, GamePhase.DELIVERY],
  [GamePhase.DELIVERY]: [GamePhase.QUEST_ACCEPT, GamePhase.GATHERING, GamePhase.ALCHEMY],
};
```

### 2. IGameState拡張 🟡

**信頼性**: 🟡 *要件から妥当な推測（フィールド名はinterfaces.tsの設計に基づく）*

**実装ファイル**: `src/shared/types/game-state.ts`（または既存のIGameState定義ファイル）

```typescript
// 追加フィールド
apOverflow: number;            // 前日のAP超過分（デフォルト: 0）
boardQuests: IBoardQuest[];    // 掲示板依頼（デフォルト: []）
visitorQuests: IVisitorQuest[]; // 訪問依頼（デフォルト: []）
lastVisitorUpdateDay: number;  // 訪問依頼の最終更新日（デフォルト: 0）
```

### 3. 初期状態のデフォルト値設定 🔵

**信頼性**: 🔵 *既存initial-state.tsの初期化パターンより*

**実装ファイル**: `src/shared/services/state-manager/initial-state.ts`

初期状態に新規フィールドのデフォルト値を追加する。

---

## 単体テスト要件

### テストケース1: 全フェーズ間の遷移が許可されている 🔵

**信頼性**: 🔵 *REQ-001-01より*

**Given**: VALID_PHASE_TRANSITIONSが定義されている
**When**: 任意のフェーズから他の3フェーズへの遷移を確認
**Then**: すべての遷移が許可されている

**テストファイル**: `tests/unit/shared/services/state-manager/initial-state.test.ts`

```typescript
describe('VALID_PHASE_TRANSITIONS', () => {
  it('全フェーズから他の全フェーズへの遷移が許可されている', () => {
    const phases = Object.values(GamePhase);
    for (const from of phases) {
      const allowed = VALID_PHASE_TRANSITIONS[from];
      const otherPhases = phases.filter(p => p !== from);
      expect(allowed).toEqual(expect.arrayContaining(otherPhases));
    }
  });

  it('自フェーズへの遷移は含まれない', () => {
    const phases = Object.values(GamePhase);
    for (const phase of phases) {
      expect(VALID_PHASE_TRANSITIONS[phase]).not.toContain(phase);
    }
  });
});
```

### テストケース2: StateManager.canTransitionTo()が自由遷移に対応 🔵

**信頼性**: 🔵 *既存StateManager実装より*

**Given**: StateManagerが初期化されている
**When**: canTransitionTo()で任意のフェーズへの遷移を確認
**Then**: 現在フェーズ以外への遷移がすべてtrueを返す

### テストケース3: IGameState初期値にAP超過・掲示板フィールドが含まれる 🟡

**信頼性**: 🟡 *interfaces.ts設計から妥当な推測*

**Given**: 初期状態を生成
**When**: 新規フィールドを確認
**Then**: apOverflow=0, boardQuests=[], visitorQuests=[], lastVisitorUpdateDay=0

---

## 統合テスト要件

### 統合テスト1: StateManagerでのフェーズ遷移 🔵

**信頼性**: 🔵 *既存StateManager統合テストパターンより*

**テスト内容**: StateManagerを通じたフェーズ遷移がイベントを正しく発行するか
**期待結果**: PHASE_CHANGEDイベントが正しいペイロードで発行される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0102` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 既存の `canTransitionTo()` ロジックは変更不要（VALID_PHASE_TRANSITIONSの値変更のみ）
- 既存テストが新しい遷移ルールで壊れないか確認が必要
- IGameStateの型変更は他のコンポーネントに広く影響するため、デフォルト値の設定を確実に行う

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 2 | 1 | 0 | 3 |
| 単体テスト | 2 | 1 | 0 | 3 |
| 統合テスト | 1 | 0 | 0 | 1 |

### 全体評価

- **総項目数**: 7項目
- 🔵 **青信号**: 5項目 (71%)
- 🟡 **黄信号**: 2項目 (29%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質
