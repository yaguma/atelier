# TASK-0118: 統合テスト - フェーズ自由遷移

**タスクID**: TASK-0118
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 統合テスト・E2E
**信頼性レベル**: 🔵 *REQ-001, 設計文書architecture.md・dataflow.mdより*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md)
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md)

## タスク概要

フェーズ自由遷移機能の統合テストを実装する。GameFlowManager.switchPhase()、PhaseTabUI、FooterUI、MainSceneの連携を検証する。全フェーズ間の遷移が正しく動作し、UIの状態が同期されることをテストする。

## 依存タスク

- **前提タスク**: [TASK-0106](TASK-0106.md), [TASK-0111](TASK-0111.md), [TASK-0112](TASK-0112.md), [TASK-0116](TASK-0116.md)
- **後続タスク**: [TASK-0121](TASK-0121.md)

## 完了条件

- [ ] 全12パターンのフェーズ遷移（4×3）が正しく動作することを確認
- [ ] PhaseTabUIのクリックによるフェーズ遷移が正しく動作
- [ ] 採取セッション中のフェーズ遷移で確認ダイアログが表示される
- [ ] フェーズ遷移時にPHASE_CHANGEDイベントが正しく発行される
- [ ] MainSceneのshowPhase()がタブUIと連動して正しく動作
- [ ] 全テストが成功

---

## 実装詳細

### 1. フェーズ遷移の網羅テスト 🔵

**信頼性**: 🔵 *REQ-001-01「どのフェーズからでも他の任意のフェーズへ即座に遷移」より*

**テストファイル**: `tests/integration/free-phase-navigation/phase-switching.test.ts`

テスト項目:
- QUEST_ACCEPT → GATHERING, ALCHEMY, DELIVERY
- GATHERING → QUEST_ACCEPT, ALCHEMY, DELIVERY
- ALCHEMY → QUEST_ACCEPT, GATHERING, DELIVERY
- DELIVERY → QUEST_ACCEPT, GATHERING, ALCHEMY
- 同一フェーズへの遷移（何も起きない）
- VALID_PHASE_TRANSITIONSが全ペアを許可していることの検証

```typescript
describe('フェーズ自由遷移 統合テスト', () => {
  const allPhases = [GamePhase.QUEST_ACCEPT, GamePhase.GATHERING, GamePhase.ALCHEMY, GamePhase.DELIVERY];

  for (const from of allPhases) {
    for (const to of allPhases) {
      if (from !== to) {
        it(`${from} → ${to} への遷移が成功する`, async () => {
          stateManager.setPhase(from);
          const result = await gameFlowManager.switchPhase({ targetPhase: to });
          expect(result.success).toBe(true);
          expect(stateManager.getState().currentPhase).toBe(to);
        });
      }
    }
  }
});
```

### 2. PhaseTabUI連携テスト 🔵

**信頼性**: 🔵 *REQ-006-03「タブクリックで即座にフェーズを切り替え」より*

テスト項目:
- タブクリック → switchPhase()呼び出し → UI更新
- アクティブタブのハイライト更新
- PHASE_CHANGEDイベントでのタブ状態同期

### 3. 採取セッション中遷移テスト 🟡

**信頼性**: 🟡 *REQ-001-03・EDGE-001から妥当な推測*

テスト項目:
- 採取セッション中にフェーズ遷移 → 確認ダイアログ表示
- 確認ダイアログで「続行」→ セッション破棄 → 遷移実行
- 確認ダイアログで「キャンセル」→ セッション維持 → 遷移中止
- 採取セッション外でのフェーズ遷移 → 即座に遷移

### 4. MainScene連携テスト 🔵

**信頼性**: 🔵 *設計文書architecture.md MainScene変更点より*

テスト項目:
- showPhase()が正しいフェーズUIを表示
- _completedPhasesが廃止されていること
- 固定順序ロジック（nextPhase）が削除されていること

---

## 単体テスト要件

本タスクは統合テストが主体のため、単体テスト要件は前提タスク（TASK-0106, TASK-0111, TASK-0112, TASK-0116）で網羅済み。統合テストでは各コンポーネント間の連携を中心に検証する。

---

## 統合テスト要件

- GameFlowManager + StateManager + EventBus の連携
- PhaseTabUI → GameFlowManager → StateManager → EventBus → PhaseTabUI のイベントフロー
- MainScene.showPhase() とフェーズUI切り替えの連携
- 採取セッション中遷移時の確認ダイアログフロー

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0118` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- テストファイルは `tests/integration/free-phase-navigation/` に配置
- エイリアス `@features/`, `@shared/` を使用
- Phaserシーンのモックは既存のテストパターンに従う
- rexUIプラグインのモックが必要

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 3 | 1 | 0 | 4 |
| テスト要件 | 3 | 1 | 0 | 4 |

- **総項目数**: 8項目
- 🔵 **青信号**: 6項目 (75%)
- 🟡 **黄信号**: 2項目 (25%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
