# TASK-0120: 統合テスト - 採取2段階化

**タスクID**: TASK-0120
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 統合テスト・E2E
**信頼性レベル**: 🔵 *REQ-002, 設計文書dataflow.md「採取2段階化データフロー」より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md)
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md)

## タスク概要

採取2段階化（場所選択→ドラフト採取）の統合テストを実装する。LocationSelectUI、GatheringPhaseUI（GatheringStage状態機械）、GatheringServiceの連携を検証する。場所選択から採取完了までの一連のフローをテストする。

## 依存タスク

- **前提タスク**: [TASK-0113](TASK-0113.md), [TASK-0114](TASK-0114.md)
- **後続タスク**: [TASK-0121](TASK-0121.md)

## 完了条件

- [ ] 場所選択→ドラフト採取の2段階フローが正しく動作
- [ ] 手札の採取地カードに基づく場所フィルタリングが正しく動作
- [ ] 場所選択でAPコスト・素材プレビューが正しく表示
- [ ] GatheringStage状態遷移（LOCATION_SELECT→DRAFT_SESSION→GATHER_RESULT）が正しく動作
- [ ] 採取地カード0枚時の空状態表示が正しく動作
- [ ] 全テストが成功

---

## 実装詳細

### 1. 場所選択フローテスト 🔵

**信頼性**: 🔵 *REQ-002-01〜REQ-002-05より*

**テストファイル**: `tests/integration/free-phase-navigation/gathering-two-stage.test.ts`

テスト項目:
- 採取フェーズ開始時にLOCATION_SELECTステージが表示
- 利用可能な採取地が手札に基づいてフィルタリング
- 各採取地のAPコスト表示
- 各採取地の入手可能素材プレビュー表示
- 採取地選択後にDRAFT_SESSIONステージへ遷移

```typescript
describe('採取2段階化 統合テスト', () => {
  describe('場所選択フロー', () => {
    it('採取フェーズ開始時にLOCATION_SELECTステージが表示される', () => {
      gatheringPhaseUI.create();
      expect(gatheringPhaseUI.getCurrentStage()).toBe(GatheringStage.LOCATION_SELECT);
    });

    it('手札の採取地カードに基づいて場所がフィルタリングされる', () => {
      const hand = [createLocationCard('forest'), createLocationCard('cave')];
      stateManager.updateState({ hand });
      const locations = gatheringService.getAvailableLocations(hand);
      expect(locations).toHaveLength(2);
      expect(locations.map(l => l.id)).toContain('forest');
      expect(locations.map(l => l.id)).toContain('cave');
    });
  });
});
```

### 2. GatheringStage状態遷移テスト 🔵

**信頼性**: 🔵 *設計文書architecture.md GatheringPhaseUI変更点より*

テスト項目:
- LOCATION_SELECT → DRAFT_SESSION（場所選択完了時）
- DRAFT_SESSION → GATHER_RESULT（採取完了時）
- GATHER_RESULT → LOCATION_SELECT（次の採取開始時）
- フェーズ離脱時にLOCATION_SELECTにリセット

### 3. AP消費連携テスト 🔵

**信頼性**: 🔵 *REQ-003-05「採取でのAP消費がAP上限超過した場合、自動日進行」より*

テスト項目:
- 場所選択でAPコスト消費
- AP超過発生時にAPOverflowPreview表示
- 採取完了後のAP残量更新

### 4. 空手札状態テスト 🟡

**信頼性**: 🟡 *EDGE-103から妥当な推測*

テスト項目:
- 採取地カード0枚時に「採取地カードがありません」表示
- ショップ誘導メッセージの表示
- 場所選択不可の状態でドラフト採取に進めないこと

---

## 単体テスト要件

本タスクは統合テストが主体のため、単体テスト要件は前提タスク（TASK-0113, TASK-0114）で網羅済み。統合テストではLocationSelectUI、GatheringPhaseUI、GatheringServiceの連携を中心に検証する。

---

## 統合テスト要件

- LocationSelectUI → GatheringService → StateManager の連携
- GatheringStage状態機械の遷移フロー検証
- 場所選択 → ドラフト採取 → 結果表示の一連のフロー
- AP消費とAP超過サービスとの連携
- 空手札状態のエッジケース処理

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0120` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- テストファイルは `tests/integration/free-phase-navigation/` に配置
- GatheringPhaseUIのステージ遷移は内部状態を直接検証
- LocationSelectUIのrexUIコンポーネントはモックで対応

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 3 | 1 | 0 | 4 |
| テスト要件 | 3 | 1 | 0 | 4 |

- **総項目数**: 8項目
- 🔵 **青信号**: 6項目 (75%)
- 🟡 **黄信号**: 2項目 (25%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
