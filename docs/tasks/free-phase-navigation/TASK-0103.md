# TASK-0103: APOverflowServiceå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0103
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - Domainå±¤ åŸºç›¤æ•´å‚™
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *REQ-003ãƒ»architecture.mdãƒ»design-interview.md D2ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-003, REQ-003-01ã€œREQ-003-06
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/free-phase-navigation/architecture.md)
- **å‹å®šç¾©**: [ğŸ“ interfaces.ts](../../design/free-phase-navigation/interfaces.ts)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [ğŸ”„ dataflow.md](../../design/free-phase-navigation/dataflow.md) - ã‚»ã‚¯ã‚·ãƒ§ãƒ³3

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

APè¶…éè¨ˆç®—ã‚’è¡Œã†ç´”ç²‹é–¢æ•°ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ–°è¦ä½œæˆã™ã‚‹ã€‚æ¶ˆè²»APãŒæ®‹APã‚’è¶…éã—ãŸå ´åˆã®æ—¥æ•°æ¶ˆè²»ãƒ»ç¿Œæ—¥APè¨ˆç®—ã‚’Functional Coreãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0102: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»å®šç¾©ã®æ›´æ–°ã¨IGameStateæ‹¡å¼µ](TASK-0102.md)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0107: GameFlowManager - processAPOverflow()](TASK-0107.md), [TASK-0115: APOverflowPreviewå®Ÿè£…](TASK-0115.md)

## å®Œäº†æ¡ä»¶

- [ ] APOverflowServiceãŒFunctional Coreï¼ˆç´”ç²‹é–¢æ•°ï¼‰ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] calculateOverflow()ãŒæ­£ã—ã„IAPOverflowResultã‚’è¿”ã™
- [ ] å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆï¼ˆAP0ã€APè¶…éãªã—ã€1æ—¥è¶…éã€è¤‡æ•°æ—¥è¶…éï¼‰ãŒå…¨ã¦é€šã‚‹
- [ ] å‰¯ä½œç”¨ãŒãªã„ï¼ˆå¤–éƒ¨çŠ¶æ…‹ã‚’å‚ç…§ãƒ»å¤‰æ›´ã—ãªã„ï¼‰

---

## å®Ÿè£…è©³ç´°

### 1. APOverflowService ã‚¯ãƒ©ã‚¹å®šç¾© ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã€ŒAPOverflowServiceï¼ˆæ–°è¦Domainå±¤ï¼‰ã€ãƒ»interfaces.ts IAPOverflowServiceã‚ˆã‚Š*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/gathering/services/ap-overflow-service.ts`

```typescript
export function calculateOverflow(input: IAPConsumptionInput): IAPOverflowResult {
  const { currentAP, consumeAP, maxAP = MAX_ACTION_POINTS } = input;
  const overflowAP = Math.max(0, consumeAP - currentAP);
  const hasOverflow = overflowAP > 0;
  const daysConsumed = hasOverflow ? Math.ceil(overflowAP / maxAP) : 0;
  const nextDayAP = hasOverflow ? (overflowAP % maxAP === 0 ? maxAP : maxAP - (overflowAP % maxAP)) : 0;
  const remainingAP = hasOverflow ? 0 : currentAP - consumeAP;

  return { hasOverflow, overflowAP, daysConsumed, nextDayAP: hasOverflow ? (overflowAP % maxAP === 0 ? maxAP : maxAP - (overflowAP % maxAP)) : 0, remainingAP };
}
```

### 2. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-003-01ãƒ»architecture.mdè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯è¡¨ã‚ˆã‚Š*

| ç¾åœ¨AP | æ¶ˆè²»AP | è¶…éAP | æ¶ˆè²»æ—¥æ•° | ç¿Œæ—¥AP |
|--------|--------|--------|---------|--------|
| 3 | 2 | 0 | 0 | - (æ®‹1) |
| 3 | 3 | 0 | 0 | - (æ®‹0) |
| 3 | 4 | 1 | 1 | 2 |
| 3 | 6 | 3 | 1 | 3(=MAX) |
| 3 | 7 | 4 | 2 | 2 |
| 2 | 5 | 3 | 1 | 3(=MAX) |
| 1 | 4 | 3 | 1 | 3(=MAX) |
| 0 | 3 | 3 | 1 | 3(=MAX) |

### 3. DIã‚³ãƒ³ãƒ†ãƒŠç™»éŒ² ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®DIç™»éŒ²ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚ˆã‚Š*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/shared/services/di-container.ts`ï¼ˆã¾ãŸã¯DIç™»éŒ²ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

APOverflowServiceã‚’DIã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã™ã‚‹ã€‚

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: APè¶…éãªã— ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯è¡¨ã‚ˆã‚Š*

**Given**: currentAP=3, consumeAP=2
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=false, overflowAP=0, daysConsumed=0, remainingAP=1

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/features/gathering/services/ap-overflow-service.test.ts`

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: 1æ—¥åˆ†ã®APè¶…é ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *REQ-003-01ãƒ»ãƒ’ã‚¢ãƒªãƒ³ã‚°Q5ã€ŒAPä¸Šé™è¶…éã§ç¿Œæ—¥AP2é–‹å§‹ã€ã‚ˆã‚Š*

**Given**: currentAP=3, consumeAP=4
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=true, overflowAP=1, daysConsumed=1, nextDayAP=2

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã¡ã‚‡ã†ã©MAX_APåˆ†ã®è¶…é ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯è¡¨ã‚ˆã‚Š*

**Given**: currentAP=3, consumeAP=6
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=true, overflowAP=3, daysConsumed=1, nextDayAP=3(=MAX)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: è¤‡æ•°æ—¥åˆ†ã®APè¶…é ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *REQ-003-03ãƒ»EDGE-002ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬*

**Given**: currentAP=3, consumeAP=7
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=true, overflowAP=4, daysConsumed=2, nextDayAP=2

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: APæ®‹é‡0ã‹ã‚‰ã®æ¶ˆè²» ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *EDGE-101ã‹ã‚‰*

**Given**: currentAP=0, consumeAP=3
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=true, overflowAP=3, daysConsumed=1, nextDayAP=3

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6: ã¡ã‚‡ã†ã©APæ®‹é‡ã‚’å…¨ã¦æ¶ˆè²» ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ*

**Given**: currentAP=3, consumeAP=3
**When**: calculateOverflow()ã‚’å‘¼ã³å‡ºã™
**Then**: hasOverflow=false, overflowAP=0, daysConsumed=0, remainingAP=0

---

## çµ±åˆãƒ†ã‚¹ãƒˆè¦ä»¶

### çµ±åˆãƒ†ã‚¹ãƒˆ1: GatheringServiceã¨ã®é€£æº ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³3.1ã‚ˆã‚Š*

**ãƒ†ã‚¹ãƒˆå†…å®¹**: GatheringService.calculateGatheringCost()ã®çµæœã‚’calculateOverflowã«æ¸¡ã™
**æœŸå¾…çµæœ**: æ­£ã—ã„APè¶…éåˆ¤å®šãŒå¾—ã‚‰ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0103` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ï¼ˆå¤–éƒ¨çŠ¶æ…‹ã‚’å‚ç…§ãƒ»å¤‰æ›´ã—ãªã„ï¼‰
- MAX_ACTION_POINTSå®šæ•°ï¼ˆç¾åœ¨3ï¼‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°ã¨ã—ã¦æ¸¡ã™
- overflowAP % maxAP === 0 ã®å ´åˆã€nextDayAPã¯maxAPï¼ˆ0ã§ã¯ãªã„ï¼‰ã«æ³¨æ„
- å°†æ¥çš„ã« `src/shared/services/` ã¸ã®ç§»å‹•ã‚’æ¤œè¨ï¼ˆdesign-interview.md D2å‚ç…§ï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 3 | 0 | 0 | 3 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 5 | 1 | 0 | 6 |
| çµ±åˆãƒ†ã‚¹ãƒˆ | 1 | 0 | 0 | 1 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 10é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 9é …ç›® (90%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (10%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: âœ… é«˜å“è³ª
