# TASK-0106: GameFlowManager - switchPhase()ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

**ã‚¿ã‚¹ã‚¯ID**: TASK-0106
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - Applicationå±¤ ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *REQ-001ãƒ»architecture.mdãƒ»dataflow.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-001, REQ-001-01ã€œREQ-001-03
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/free-phase-navigation/architecture.md)
- **å‹å®šç¾©**: [ğŸ“ interfaces.ts](../../design/free-phase-navigation/interfaces.ts)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [ğŸ”„ dataflow.md](../../design/free-phase-navigation/dataflow.md) - ã‚»ã‚¯ã‚·ãƒ§ãƒ³2

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

GameFlowManagerã«ãƒ•ã‚§ãƒ¼ã‚ºè‡ªç”±é·ç§»ã®ãŸã‚ã®switchPhase()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚æ—¢å­˜ã®endPhase()ã®æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºè‡ªå‹•æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å»ƒæ­¢ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®é·ç§»ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ä¸­æ–­ç¢ºèªãƒ­ã‚¸ãƒƒã‚¯ã‚‚å«ã‚€ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0102: ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»å®šç¾©ã®æ›´æ–°ã¨IGameStateæ‹¡å¼µ](TASK-0102.md)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0111: PhaseTabUIå®Ÿè£…](TASK-0111.md), [TASK-0114: GatheringPhaseUIå¤‰æ›´](TASK-0114.md), [TASK-0116: MainSceneå¤‰æ›´](TASK-0116.md)

## å®Œäº†æ¡ä»¶

- [ ] switchPhase()ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚ŒIPhaseSwitchResultã‚’è¿”ã™
- [ ] é€²è¡Œä¸­ã®æ“ä½œãƒã‚§ãƒƒã‚¯ï¼ˆæ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­ç¢ºèªï¼‰ãŒå‹•ä½œã™ã‚‹
- [ ] StateManager.setPhase()ã¨ã®é€£æºãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] PHASE_CHANGEDã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãç™ºè¡Œã•ã‚Œã‚‹
- [ ] ãƒ†ã‚¹ãƒˆãŒå…¨ã¦é€šã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. switchPhase()ãƒ¡ã‚½ãƒƒãƒ‰ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã€ŒendPhase() â†’ switchPhase(targetPhase)ã€ãƒ»dataflow.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.1ã‚ˆã‚Š*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/shared/services/game-flow/game-flow-manager.ts`

```typescript
async switchPhase(request: IPhaseSwitchRequest): Promise<IPhaseSwitchResult> {
  const currentPhase = this.stateManager.getState().currentPhase;
  // 1. é€²è¡Œä¸­æ“ä½œãƒã‚§ãƒƒã‚¯
  // 2. æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­ç¢ºèªï¼ˆå¿…è¦ãªå ´åˆï¼‰
  // 3. StateManager.setPhase(targetPhase)
  // 4. IPhaseSwitchResultè¿”å´
}
```

### 2. æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­ç¢ºèª ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *EDGE-001ãƒ»REQ-001-03ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬*

æ¡å–ãƒ‰ãƒ©ãƒ•ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œä¸­ã«switchPhase()ãŒå‘¼ã°ã‚ŒãŸå ´åˆ:
- forceAbort=trueã®å ´åˆ: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å³åº§ã«ç ´æ£„ã—ã¦é·ç§»
- forceAbort=falseã®å ´åˆ: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆUIãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®é€£æºï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ: PhaseSwitchFailureReason.USER_CANCELLEDã‚’è¿”ã™

### 3. endPhase()ã®å¤‰æ›´ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã€Œæ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã®è‡ªå‹•æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å»ƒæ­¢ã€ã‚ˆã‚Š*

æ—¢å­˜ã®endPhase()å†…ã®`nextPhaseMap`ã‚’ä½¿ã£ãŸè‡ªå‹•é·ç§»ã‚’å‰Šé™¤ã—ã€switchPhase()ã«å§”è­²ã™ã‚‹ã€‚

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: é€šå¸¸ã®ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆ ğŸ”µ

**Given**: currentPhase=QUEST_ACCEPT, é€²è¡Œä¸­æ“ä½œãªã—
**When**: switchPhase({targetPhase: GATHERING})
**Then**: success=true, newPhase=GATHERING

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡ã‚Šæ›¿ãˆï¼ˆforceAbort=trueï¼‰ ğŸŸ¡

**Given**: currentPhase=GATHERING, æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œä¸­
**When**: switchPhase({targetPhase: ALCHEMY, forceAbort: true})
**Then**: success=true, ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„å¾Œã«ALCHEMYã«é·ç§»

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: åŒã˜ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®åˆ‡ã‚Šæ›¿ãˆè©¦è¡Œ ğŸ”µ

**Given**: currentPhase=QUEST_ACCEPT
**When**: switchPhase({targetPhase: QUEST_ACCEPT})
**Then**: success=trueï¼ˆä½•ã‚‚å¤‰æ›´ã—ãªã„ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãªã—ã§ç„¡è¦–ï¼‰

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: PHASE_CHANGEDã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œ ğŸ”µ

**Given**: currentPhase=QUEST_ACCEPT
**When**: switchPhase({targetPhase: GATHERING})
**Then**: EventBusã‹ã‚‰PHASE_CHANGED({previousPhase: QUEST_ACCEPT, newPhase: GATHERING})ãŒç™ºè¡Œã•ã‚Œã‚‹

---

## çµ±åˆãƒ†ã‚¹ãƒˆè¦ä»¶

### çµ±åˆãƒ†ã‚¹ãƒˆ1: StateManager + EventBusé€£æº ğŸ”µ

**ãƒ†ã‚¹ãƒˆå†…å®¹**: switchPhase()ãŒStateManagerã®çŠ¶æ…‹æ›´æ–°ã¨EventBusã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã‚’æ­£ã—ãè¡Œã†ã‹
**æœŸå¾…çµæœ**: çŠ¶æ…‹ã¨ã‚¤ãƒ™ãƒ³ãƒˆãŒä¸€è‡´ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0106` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- æ—¢å­˜ã®endPhase()ã‚’ä¸€åº¦ã«å…¨å»ƒæ­¢ã™ã‚‹ã®ã§ã¯ãªãã€switchPhase()ã‚’è¿½åŠ ã—ã¤ã¤æ®µéšçš„ã«ç§»è¡Œ
- æ¡å–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­ç¢ºèªã¯UIãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é€£æºãŒå¿…è¦ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã¯Presentationå±¤ï¼‰
- éåŒæœŸå‡¦ç†ï¼ˆPromiseï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«æ³¨æ„

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 2 | 1 | 0 | 3 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 1 | 0 | 4 |
| çµ±åˆãƒ†ã‚¹ãƒˆ | 1 | 0 | 0 | 1 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 8é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 6é …ç›® (75%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (25%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: âœ… é«˜å“è³ª
