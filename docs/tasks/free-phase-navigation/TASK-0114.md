# TASK-0114: GatheringPhaseUI変更

**タスクID**: TASK-0114
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 3 - Presentation層 UI実装
**信頼性レベル**: 🔵 *REQ-002・architecture.md・dataflow.md セクション4より*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/free-phase-navigation/requirements.md) - REQ-002, REQ-001-03
- **設計文書**: [📐 architecture.md](../../design/free-phase-navigation/architecture.md)
- **データフロー**: [🔄 dataflow.md](../../design/free-phase-navigation/dataflow.md) - セクション4

## タスク概要

GatheringPhaseUIに場所選択ステージ（LocationSelectUI）を統合し、GatheringStage状態遷移を実装する。フェーズ離脱時のセッション中断確認ダイアログも実装。

## 依存タスク

- **前提タスク**: [TASK-0106: GameFlowManager - switchPhase()](TASK-0106.md), [TASK-0113: LocationSelectUI実装](TASK-0113.md)
- **後続タスク**: [TASK-0120: 統合テスト - 採取2段階化](TASK-0120.md)

## 完了条件

- [ ] 採取フェーズ進入時にLocationSelectUIが表示される
- [ ] GatheringStage状態遷移（LOCATION_SELECT → DRAFT_SESSION → GATHER_RESULT）が動作する
- [ ] フェーズ離脱時にセッション中断確認ダイアログが表示される（セッション進行中のみ）
- [ ] セッション破棄時にLOCATION_SELECTに戻る
- [ ] テストが全て通る

---

## 実装詳細

### 1. GatheringStage状態遷移の実装 🔵

**信頼性**: 🔵 *dataflow.md セクション4.2 状態遷移図より*

**実装ファイル**: `src/features/gathering/components/GatheringPhaseUI.ts`

LOCATION_SELECT → DRAFT_SESSION → GATHER_RESULT の状態遷移を管理。

### 2. LocationSelectUI統合 🔵

**信頼性**: 🔵 *architecture.md「HandView と LocationDetail は LocationSelectUI に統合」より*

GatheringPhaseUI.show()でLOCATION_SELECTステージを初期表示。

### 3. セッション中断確認ダイアログ 🟡

**信頼性**: 🟡 *EDGE-001・REQ-001-03・design-interview.md D3から妥当な推測*

ドラフトセッション中のフェーズ切り替え時に確認ダイアログを表示。「中断する」→セッション破棄、「キャンセル」→フェーズ切り替えキャンセル。

---

## 単体テスト要件

### テストケース1: 初期状態がLOCATION_SELECT 🔵

**Given**: 採取フェーズに遷移
**When**: GatheringPhaseUI.show()
**Then**: LocationSelectUIが表示される

### テストケース2: 場所選択後にDRAFT_SESSION遷移 🔵

**Given**: LocationSelectUIが表示
**When**: 場所を選択
**Then**: ドラフト採取セッションが開始

### テストケース3: 中断確認ダイアログ表示 🟡

**Given**: ドラフトセッション進行中
**When**: フェーズ切り替えが要求される
**Then**: 中断確認ダイアログが表示される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0114` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 既存のGatheringPhaseUIの構造を理解した上で修正
- 既存のfinalizeGatheringSession()パターンを活用
- 確認ダイアログはrexUI.add.dialog()で実装

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 2 | 1 | 0 | 3 |
| 単体テスト | 2 | 1 | 0 | 3 |

### 全体評価

- **総項目数**: 6項目
- 🔵 **青信号**: 4項目 (67%)
- 🟡 **黄信号**: 2項目 (33%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質
