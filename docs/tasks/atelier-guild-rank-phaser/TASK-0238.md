# TASK-0238: MainScene EventBusçµ±åˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0238
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

MainSceneã®EventBusé€£æºã‚’å®Œæˆã•ã›ã‚‹ã€‚UIå±¤ã¨Applicationå±¤ã®é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆé€šä¿¡ã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0237, TASK-0165
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0239

## å®Œäº†æ¡ä»¶

- [ ] MainSceneå›ºæœ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] UIã‚¤ãƒ™ãƒ³ãƒˆãŒApplicationå±¤ã«ä¼é”ã•ã‚Œã‚‹
- [ ] Applicationå±¤ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒUIã«åæ˜ ã•ã‚Œã‚‹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ãŒã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. MainSceneã‚¤ãƒ™ãƒ³ãƒˆå®šç¾© ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/MainSceneEvents.ts`

```typescript
/**
 * MainSceneã§ç™ºç«ãƒ»è³¼èª­ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
 */
export const MainSceneEvents = {
  // UI â†’ Application (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ)
  UI_TO_APP: {
    // ãƒ•ã‚§ãƒ¼ã‚ºæ“ä½œ
    PHASE_SKIP_REQUESTED: 'ui:phase:skip:requested',
    PHASE_COMPLETE: 'ui:phase:complete',

    // ä¾é ¼æ“ä½œ
    QUEST_ACCEPT_REQUESTED: 'ui:quest:accept:requested',
    QUEST_DELIVERY_REQUESTED: 'ui:quest:delivery:requested',

    // æ¡å–æ“ä½œ
    GATHERING_CONFIRM_REQUESTED: 'ui:gathering:confirm:requested',
    GATHERING_MATERIAL_SELECTED: 'ui:gathering:material:selected',

    // èª¿åˆæ“ä½œ
    ALCHEMY_CRAFT_REQUESTED: 'ui:alchemy:craft:requested',
    ALCHEMY_RECIPE_SELECTED: 'ui:alchemy:recipe:selected',
    ALCHEMY_MATERIAL_SELECTED: 'ui:alchemy:material:selected',

    // ã‚«ãƒ¼ãƒ‰æ“ä½œ
    CARD_DRAW_REQUESTED: 'ui:card:draw:requested',
    CARD_USE_REQUESTED: 'ui:card:use:requested',
    DECK_SHUFFLE_REQUESTED: 'ui:deck:shuffle:requested',

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ“ä½œ
    SIDEBAR_QUEST_SELECTED: 'ui:sidebar:quest:selected',
    SIDEBAR_ITEM_SELECTED: 'ui:sidebar:item:selected',
  },

  // Application â†’ UI (çŠ¶æ…‹æ›´æ–°)
  APP_TO_UI: {
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    GAME_STATE_UPDATED: 'app:game:state:updated',
    PLAYER_DATA_UPDATED: 'app:player:data:updated',

    // ãƒ•ã‚§ãƒ¼ã‚º
    PHASE_CHANGED: 'app:phase:changed',
    PHASE_DATA_LOADED: 'app:phase:data:loaded',

    // ä¾é ¼
    AVAILABLE_QUESTS_UPDATED: 'app:quests:available:updated',
    ACCEPTED_QUESTS_UPDATED: 'app:quests:accepted:updated',

    // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª
    INVENTORY_UPDATED: 'app:inventory:updated',

    // ãƒ‡ãƒƒã‚­ãƒ»æ‰‹æœ­
    HAND_UPDATED: 'app:hand:updated',
    DECK_UPDATED: 'app:deck:updated',

    // é€šçŸ¥
    NOTIFICATION_SHOW: 'app:notification:show',
    ERROR_OCCURRED: 'app:error:occurred',
  },
} as const;
```

### 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒªã‚¹ãƒŠãƒ¼ç®¡ç†*

```typescript
// MainSceneã«è¿½åŠ 

protected setupEventListeners(): void {
  this.setupApplicationEventListeners();
  this.setupUIEventForwarding();
}

private setupApplicationEventListeners(): void {
  const { APP_TO_UI } = MainSceneEvents;

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
  this.eventBus.on(APP_TO_UI.GAME_STATE_UPDATED, (data: any) => {
    this.handleGameStateUpdate(data);
  });

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  this.eventBus.on(APP_TO_UI.PLAYER_DATA_UPDATED, (data: any) => {
    this.handlePlayerDataUpdate(data);
  });

  // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´
  this.eventBus.on(APP_TO_UI.PHASE_CHANGED, (data: { phase: string }) => {
    this.switchToPhase(data.phase as PhaseType);
  });

  // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
  this.eventBus.on(APP_TO_UI.PHASE_DATA_LOADED, (data: any) => {
    this.handlePhaseDataLoaded(data);
  });

  // ä¾é ¼ãƒªã‚¹ãƒˆæ›´æ–°
  this.eventBus.on(APP_TO_UI.AVAILABLE_QUESTS_UPDATED, (data: { quests: Quest[] }) => {
    this.handleAvailableQuestsUpdate(data.quests);
  });

  this.eventBus.on(APP_TO_UI.ACCEPTED_QUESTS_UPDATED, (data: { quests: Quest[] }) => {
    this.handleAcceptedQuestsUpdate(data.quests);
  });

  // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ›´æ–°
  this.eventBus.on(APP_TO_UI.INVENTORY_UPDATED, (data: { items: Item[] }) => {
    this.handleInventoryUpdate(data.items);
  });

  // æ‰‹æœ­ãƒ»ãƒ‡ãƒƒã‚­æ›´æ–°
  this.eventBus.on(APP_TO_UI.HAND_UPDATED, (data: { cards: Card[] }) => {
    this.setHand(data.cards);
  });

  this.eventBus.on(APP_TO_UI.DECK_UPDATED, (data: { deckCount: number; discardCount: number }) => {
    this.deckView.setDeckCount(data.deckCount);
    this.deckView.setDiscardCount(data.discardCount);
  });

  // é€šçŸ¥
  this.eventBus.on(APP_TO_UI.NOTIFICATION_SHOW, (data: { message: string; type: string }) => {
    this.showNotification(data.message, data.type);
  });

  // ã‚¨ãƒ©ãƒ¼
  this.eventBus.on(APP_TO_UI.ERROR_OCCURRED, (data: { message: string }) => {
    this.showError(data.message);
  });
}

private setupUIEventForwarding(): void {
  // UIå±¤ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’Applicationå±¤å‘ã‘ã«å¤‰æ›ãƒ»è»¢é€
  // ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
}
```

### 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©å®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒãƒ³ãƒ‰ãƒ©å‡¦ç†*

```typescript
// MainSceneã«è¿½åŠ 

private handleGameStateUpdate(data: any): void {
  if (data.currentPhase) {
    this.currentPhase = data.currentPhase;
    this.phaseIndicator.setCurrentPhase(data.currentPhase);
  }

  if (data.playerData) {
    this.setPlayerData(data.playerData);
  }

  if (data.inventory) {
    this.sidebarUI.setInventory(data.inventory);
  }

  if (data.acceptedQuests) {
    this.sidebarUI.setQuests(data.acceptedQuests);
  }
}

private handlePlayerDataUpdate(data: any): void {
  this.headerUI.setRank(data.rank);
  this.headerUI.setExp(data.exp, data.maxExp);
  this.headerUI.setDay(data.day, data.maxDay);
  this.headerUI.setGold(data.gold);
  this.headerUI.setAP(data.ap, data.maxAP);
}

private handlePhaseDataLoaded(data: any): void {
  const info = this.phaseContainers.get(this.activePhase!);
  if (!info || !info.container) return;

  // ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
  switch (this.activePhase) {
    case 'quest-accept':
      const questContainer = info.container as QuestAcceptContainer;
      if (data.availableQuests) {
        questContainer.setAvailableQuests(data.availableQuests);
      }
      break;

    case 'gathering':
      const gatheringContainer = info.container as GatheringContainer;
      if (data.ap) {
        gatheringContainer.setCurrentAP(data.ap.current, data.ap.max);
      }
      break;

    case 'alchemy':
      const alchemyContainer = info.container as AlchemyContainer;
      if (data.recipeCards) {
        alchemyContainer.setRecipeCards(data.recipeCards);
      }
      if (data.materials) {
        alchemyContainer.setAvailableMaterials(data.materials);
      }
      break;

    case 'delivery':
      const deliveryContainer = info.container as DeliveryContainer;
      if (data.acceptedQuests) {
        deliveryContainer.setAcceptedQuests(data.acceptedQuests);
      }
      if (data.inventory) {
        deliveryContainer.setInventory(data.inventory);
      }
      break;
  }
}

private handleAvailableQuestsUpdate(quests: Quest[]): void {
  if (this.activePhase === 'quest-accept') {
    const info = this.phaseContainers.get('quest-accept');
    if (info?.container) {
      (info.container as QuestAcceptContainer).setAvailableQuests(quests);
    }
  }
}

private handleAcceptedQuestsUpdate(quests: Quest[]): void {
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°
  this.sidebarUI.setQuests(quests);

  // ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆã¯ã‚³ãƒ³ãƒ†ãƒŠã‚‚æ›´æ–°
  if (this.activePhase === 'delivery') {
    const info = this.phaseContainers.get('delivery');
    if (info?.container) {
      (info.container as DeliveryContainer).setAcceptedQuests(quests);
    }
  }
}

private handleInventoryUpdate(items: Item[]): void {
  // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°
  this.sidebarUI.setInventory(items);

  // èª¿åˆãƒ»ç´å“ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆã¯ã‚³ãƒ³ãƒ†ãƒŠã‚‚æ›´æ–°
  if (this.activePhase === 'alchemy') {
    const info = this.phaseContainers.get('alchemy');
    if (info?.container) {
      // ç´ æã¨ã—ã¦ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿
      const materials = items.filter(i => i.type === 'material');
      (info.container as AlchemyContainer).setAvailableMaterials(materials as any);
    }
  }

  if (this.activePhase === 'delivery') {
    const info = this.phaseContainers.get('delivery');
    if (info?.container) {
      (info.container as DeliveryContainer).setInventory(items);
    }
  }
}
```

### 4. é€šçŸ¥ãƒ»ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// MainSceneã«è¿½åŠ 

private notificationQueue: Array<{ message: string; type: string }> = [];
private isShowingNotification: boolean = false;

private showNotification(message: string, type: string): void {
  this.notificationQueue.push({ message, type });

  if (!this.isShowingNotification) {
    this.displayNextNotification();
  }
}

private async displayNextNotification(): Promise<void> {
  if (this.notificationQueue.length === 0) {
    this.isShowingNotification = false;
    return;
  }

  this.isShowingNotification = true;
  const { message, type } = this.notificationQueue.shift()!;

  const colors: Record<string, number> = {
    success: 0x00aa00,
    info: 0x0088ff,
    warning: 0xffaa00,
    error: 0xff4444,
  };

  const notification = this.add.container(
    MainSceneLayout.SCREEN_WIDTH / 2,
    MainSceneLayout.HEADER.HEIGHT + 20
  );

  const bg = this.add.graphics();
  bg.fillStyle(colors[type] ?? colors.info, 0.9);
  bg.fillRoundedRect(-200, -20, 400, 40, 8);
  notification.add(bg);

  const text = this.add.text(0, 0, message, {
    ...TextStyles.body,
    fontSize: '14px',
  }).setOrigin(0.5);
  notification.add(text);

  notification.setAlpha(0);
  notification.setY(notification.y - 20);
  notification.setDepth(500);

  // å…¥å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.tweenPromise({
    targets: notification,
    alpha: 1,
    y: notification.y + 20,
    duration: 200,
    ease: 'Power2.easeOut',
  });

  // è¡¨ç¤ºç¶­æŒ
  await this.delay(2000);

  // é€€å ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.tweenPromise({
    targets: notification,
    alpha: 0,
    y: notification.y - 20,
    duration: 200,
    ease: 'Power2.easeIn',
  });

  notification.destroy();

  // æ¬¡ã®é€šçŸ¥ã‚’è¡¨ç¤º
  this.displayNextNotification();
}

private showError(message: string): void {
  this.showNotification(message, 'error');
}

private tweenPromise(config: any): Promise<void> {
  return new Promise(resolve => {
    this.tweens.add({
      ...config,
      onComplete: () => resolve(),
    });
  });
}

private delay(ms: number): Promise<void> {
  return new Promise(resolve => this.time.delayedCall(ms, resolve));
}
```

### 5. ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†*

```typescript
// MainSceneã«è¿½åŠ 

protected removeEventListeners(): void {
  const { APP_TO_UI } = MainSceneEvents;

  // ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
  Object.values(APP_TO_UI).forEach(event => {
    this.eventBus.off(event);
  });
}

shutdown(): void {
  this.removeEventListeners();
  this.notificationQueue = [];

  // ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  this.phaseContainers.forEach(info => {
    if (info.container) {
      info.container.destroy();
    }
  });
  this.phaseContainers.clear();

  super.shutdown();
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ ğŸŸ¡

**Given**: MainSceneãŒèµ·å‹•ã—ã¦ã„ã‚‹
**When**: app:player:data:updatedã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
**Then**: ãƒ˜ãƒƒãƒ€ãƒ¼UIãŒæ›´æ–°ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç« ğŸŸ¡

**Given**: MainSceneãŒèµ·å‹•ã—ã¦ã„ã‚‹
**When**: ä¾é ¼ã‚’é¸æŠ
**Then**: ui:quest:accept:requestedã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ğŸŸ¡

**Given**: MainSceneãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–
**When**: shutdownã‚’å‘¼ã¶
**Then**: ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè§£é™¤ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0238` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚¤ãƒ™ãƒ³ãƒˆå‘½åè¦å‰‡ã®çµ±ä¸€
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼ˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤ï¼‰
- Applicationå±¤ã¨ã®è²¬å‹™åˆ†é›¢

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 5é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 5é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆApplicationå±¤å®Ÿè£…æ™‚ã«èª¿æ•´è¦ï¼‰
