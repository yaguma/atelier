# TASK-0202: HeaderUIãƒ©ãƒ³ã‚¯ãƒ»ã‚²ãƒ¼ã‚¸å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0202
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒ˜ãƒƒãƒ€ãƒ¼UIã®ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã¨çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0201
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0203

## å®Œäº†æ¡ä»¶

- [ ] ãƒ©ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸè‰²ãŒé©ç”¨ã•ã‚Œã‚‹
- [ ] çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸ãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§æ›´æ–°ã•ã‚Œã‚‹
- [ ] çµŒé¨“å€¤ã®æ•°å€¤è¡¨ç¤ºãŒã‚ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. HeaderUIåŸºæœ¬å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *TASK-0201ã®è¨­è¨ˆã«åŸºã¥ã*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/header/HeaderUI.ts`

```typescript
import Phaser from 'phaser';
import { Rank } from '../../../../domain/rank/Rank';
import { IHeaderUI, HeaderUIData, HeaderUIOptions } from './IHeaderUI';
import { HeaderLayout, HeaderColors } from './HeaderConstants';
import { getRankColor, formatGold, formatDay } from './HeaderUtils';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class HeaderUI implements IHeaderUI {
  public readonly container: Phaser.GameObjects.Container;

  private scene: Phaser.Scene;
  private background!: Phaser.GameObjects.Graphics;

  // ãƒ©ãƒ³ã‚¯è¡¨ç¤º
  private rankContainer!: Phaser.GameObjects.Container;
  private rankText!: Phaser.GameObjects.Text;
  private rankBadge!: Phaser.GameObjects.Graphics;

  // çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸
  private expGaugeBackground!: Phaser.GameObjects.Graphics;
  private expGaugeFill!: Phaser.GameObjects.Graphics;
  private expText!: Phaser.GameObjects.Text;

  // æ—¥æ•°ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»AP
  private dayText!: Phaser.GameObjects.Text;
  private goldText!: Phaser.GameObjects.Text;
  private apGaugeBackground!: Phaser.GameObjects.Graphics;
  private apGaugeFill!: Phaser.GameObjects.Graphics;
  private apText!: Phaser.GameObjects.Text;

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
  private menuButton!: Phaser.GameObjects.Container;

  private currentData: HeaderUIData | null = null;
  private onMenuClick?: () => void;

  constructor(scene: Phaser.Scene, options: HeaderUIOptions = {}) {
    this.scene = scene;
    this.onMenuClick = options.onMenuClick;

    const x = options.x ?? HeaderLayout.X;
    const y = options.y ?? HeaderLayout.Y;
    const width = options.width ?? HeaderLayout.WIDTH;

    this.container = scene.add.container(x, y);
    this.container.setDepth(500);

    this.createBackground(width);
    this.createRankDisplay();
    this.createExpGauge();
    this.createDayDisplay();
    this.createGoldDisplay();
    this.createAPGauge();
    this.createMenuButton();
  }

  private createBackground(width: number): void {
    this.background = this.scene.add.graphics();
    this.background.fillStyle(HeaderColors.BACKGROUND, HeaderColors.BACKGROUND_ALPHA);
    this.background.fillRect(0, 0, width, HeaderLayout.HEIGHT);
    this.background.lineStyle(1, HeaderColors.BORDER);
    this.background.strokeRect(0, 0, width, HeaderLayout.HEIGHT);
    this.container.add(this.background);
  }

  private createRankDisplay(): void {
    this.rankContainer = this.scene.add.container(HeaderLayout.RANK_X, HeaderLayout.HEIGHT / 2);

    // ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸èƒŒæ™¯
    this.rankBadge = this.scene.add.graphics();
    this.rankBadge.fillStyle(HeaderColors.RANK_F, 1);
    this.rankBadge.fillRoundedRect(-30, -25, 60, 50, 8);
    this.rankContainer.add(this.rankBadge);

    // ãƒ©ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ
    this.rankText = this.scene.add.text(0, 0, 'F', {
      fontSize: '32px',
      fontFamily: 'Arial',
      color: '#ffffff',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    this.rankContainer.add(this.rankText);

    // ã€ŒRankã€ãƒ©ãƒ™ãƒ«
    const rankLabel = this.scene.add.text(0, -35, 'Rank', {
      ...TextStyles.bodySmall,
      fontSize: '10px',
    }).setOrigin(0.5);
    this.rankContainer.add(rankLabel);

    this.container.add(this.rankContainer);
  }

  private createExpGauge(): void {
    const gaugeX = HeaderLayout.EXP_GAUGE_X;
    const gaugeY = HeaderLayout.HEIGHT / 2;
    const gaugeWidth = HeaderLayout.EXP_GAUGE_WIDTH;
    const gaugeHeight = HeaderLayout.EXP_GAUGE_HEIGHT;

    // çµŒé¨“å€¤ãƒ©ãƒ™ãƒ«
    const expLabel = this.scene.add.text(gaugeX, gaugeY - 20, 'çµŒé¨“å€¤', {
      ...TextStyles.bodySmall,
      fontSize: '11px',
    });
    this.container.add(expLabel);

    // ã‚²ãƒ¼ã‚¸èƒŒæ™¯
    this.expGaugeBackground = this.scene.add.graphics();
    this.expGaugeBackground.fillStyle(Colors.backgroundDark, 1);
    this.expGaugeBackground.fillRoundedRect(gaugeX, gaugeY - gaugeHeight / 2, gaugeWidth, gaugeHeight, 4);
    this.expGaugeBackground.lineStyle(1, Colors.panelBorder);
    this.expGaugeBackground.strokeRoundedRect(gaugeX, gaugeY - gaugeHeight / 2, gaugeWidth, gaugeHeight, 4);
    this.container.add(this.expGaugeBackground);

    // ã‚²ãƒ¼ã‚¸å¡—ã‚Š
    this.expGaugeFill = this.scene.add.graphics();
    this.container.add(this.expGaugeFill);

    // æ•°å€¤ãƒ†ã‚­ã‚¹ãƒˆ
    this.expText = this.scene.add.text(gaugeX + gaugeWidth / 2, gaugeY, '0/0', {
      ...TextStyles.body,
      fontSize: '12px',
    }).setOrigin(0.5);
    this.container.add(this.expText);
  }

  updateRank(rank: Rank): void {
    const color = getRankColor(rank);

    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    this.rankText.setText(rank.name);

    // ãƒãƒƒã‚¸è‰²æ›´æ–°
    this.rankBadge.clear();
    this.rankBadge.fillStyle(color, 1);
    this.rankBadge.fillRoundedRect(-30, -25, 60, 50, 8);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.scene.tweens.add({
      targets: this.rankContainer,
      scaleX: 1.2,
      scaleY: 1.2,
      duration: 150,
      yoyo: true,
      ease: 'Power2',
    });
  }

  updateExp(current: number, required: number): void {
    const gaugeX = HeaderLayout.EXP_GAUGE_X;
    const gaugeY = HeaderLayout.HEIGHT / 2;
    const gaugeWidth = HeaderLayout.EXP_GAUGE_WIDTH;
    const gaugeHeight = HeaderLayout.EXP_GAUGE_HEIGHT;

    const ratio = required > 0 ? Math.min(current / required, 1) : 0;
    const fillWidth = gaugeWidth * ratio;

    // ã‚²ãƒ¼ã‚¸æ›´æ–°
    this.expGaugeFill.clear();
    this.expGaugeFill.fillStyle(Colors.accent, 1);
    if (fillWidth > 0) {
      this.expGaugeFill.fillRoundedRect(
        gaugeX + 2, gaugeY - gaugeHeight / 2 + 2,
        fillWidth - 4, gaugeHeight - 4, 2
      );
    }

    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    this.expText.setText(`${current}/${required}`);
  }

  animateExpGain(amount: number): void {
    // çµŒé¨“å€¤ç²å¾—æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const floatText = this.scene.add.text(
      HeaderLayout.EXP_GAUGE_X + HeaderLayout.EXP_GAUGE_WIDTH / 2,
      HeaderLayout.HEIGHT / 2 - 30,
      `+${amount} EXP`,
      { ...TextStyles.body, fontSize: '14px', color: '#00ff00' }
    ).setOrigin(0.5);

    this.scene.tweens.add({
      targets: floatText,
      y: floatText.y - 30,
      alpha: 0,
      duration: 1000,
      ease: 'Power2',
      onComplete: () => floatText.destroy(),
    });
  }

  // updateDay, updateGold, updateAPã¯æ¬¡ã®TASK-0203ã§å®Ÿè£…
  updateDay(current: number, max: number): void {}
  updateGold(gold: number): void {}
  updateAP(current: number, max: number): void {}
  animateGoldChange(amount: number): void {}
  animateAPChange(amount: number): void {}

  updateAll(data: HeaderUIData): void {
    this.currentData = data;
    this.updateRank(data.rank);
    this.updateExp(data.currentExp, data.requiredExp);
    this.updateDay(data.currentDay, data.maxDay);
    this.updateGold(data.gold);
    this.updateAP(data.currentAP, data.maxAP);
  }

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  destroy(): void {
    this.container.destroy();
  }

  private createDayDisplay(): void {
    this.dayText = this.scene.add.text(HeaderLayout.DAY_X, HeaderLayout.HEIGHT / 2, '', {
      ...TextStyles.body,
    }).setOrigin(0, 0.5);
    this.container.add(this.dayText);
  }

  private createGoldDisplay(): void {
    const goldIcon = this.scene.add.text(HeaderLayout.GOLD_X - 25, HeaderLayout.HEIGHT / 2, 'ğŸ’°', {
      fontSize: '20px',
    }).setOrigin(0.5);
    this.container.add(goldIcon);

    this.goldText = this.scene.add.text(HeaderLayout.GOLD_X, HeaderLayout.HEIGHT / 2, '0', {
      ...TextStyles.body,
      color: '#ffd700',
    }).setOrigin(0, 0.5);
    this.container.add(this.goldText);
  }

  private createAPGauge(): void {
    const apLabel = this.scene.add.text(HeaderLayout.AP_X, HeaderLayout.HEIGHT / 2 - 20, 'AP', {
      ...TextStyles.bodySmall,
      fontSize: '11px',
    });
    this.container.add(apLabel);

    // APè¡¨ç¤ºã®è©³ç´°å®Ÿè£…ã¯TASK-0203ã§
    this.apGaugeBackground = this.scene.add.graphics();
    this.apGaugeFill = this.scene.add.graphics();
    this.apText = this.scene.add.text(0, 0, '', TextStyles.body);
    this.container.add(this.apGaugeBackground);
    this.container.add(this.apGaugeFill);
    this.container.add(this.apText);
  }

  private createMenuButton(): void {
    this.menuButton = this.scene.add.container(HeaderLayout.MENU_X, HeaderLayout.HEIGHT / 2);

    const buttonBg = this.scene.add.graphics();
    buttonBg.fillStyle(Colors.backgroundDark, 1);
    buttonBg.fillRoundedRect(-20, -20, 40, 40, 8);
    this.menuButton.add(buttonBg);

    const menuIcon = this.scene.add.text(0, 0, 'â˜°', {
      fontSize: '24px',
    }).setOrigin(0.5);
    this.menuButton.add(menuIcon);

    this.menuButton.setInteractive(
      new Phaser.Geom.Rectangle(-20, -20, 40, 40),
      Phaser.Geom.Rectangle.Contains
    );
    this.menuButton.on('pointerdown', () => {
      if (this.onMenuClick) this.onMenuClick();
    });

    this.container.add(this.menuButton);
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ©ãƒ³ã‚¯è¡¨ç¤ºæ›´æ–° ğŸ”µ

**Given**: HeaderUIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: updateRankã‚’å‘¼ã¶
**Then**: ãƒ©ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã¨è‰²ãŒæ›´æ–°ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸æ›´æ–° ğŸ”µ

**Given**: HeaderUIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: updateExp(50, 100)ã‚’å‘¼ã¶
**Then**: ã‚²ãƒ¼ã‚¸ãŒ50%å¡—ã‚‰ã‚Œã€ãƒ†ã‚­ã‚¹ãƒˆãŒ"50/100"ã«ãªã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: çµŒé¨“å€¤ç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**Given**: HeaderUIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: animateExpGain(100)ã‚’å‘¼ã¶
**Then**: "+100 EXP"ãŒãƒ•ãƒ­ãƒ¼ãƒˆã—ã¦æ¶ˆãˆã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0202` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ãƒ©ãƒ³ã‚¯å¤‰æ›´æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡º
- çµŒé¨“å€¤ã‚²ãƒ¼ã‚¸ã®æ»‘ã‚‰ã‹ãªæ›´æ–°
- ãƒ©ãƒ³ã‚¯æ˜‡æ ¼æ™‚ã®ç‰¹åˆ¥æ¼”å‡ºï¼ˆå¾Œç¶šã‚¿ã‚¹ã‚¯ã§å¯¾å¿œï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
