# TASK-0179: DialogManagerè¨­è¨ˆãƒ»å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0179
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºãƒ»ç®¡ç†ã‚’ä¸€å…ƒåŒ–ã™ã‚‹DialogManagerã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚ã‚­ãƒ¥ãƒ¼ç®¡ç†ã‚„é‡è¤‡è¡¨ç¤ºé˜²æ­¢ã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0175
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0181

## å®Œäº†æ¡ä»¶

- [x] DialogManagerã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚­ãƒ¥ãƒ¼ç®¡ç†ãŒã§ãã‚‹
- [x] åŒæ™‚ã«1ã¤ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
- [x] ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ãŸã‚‰æ¬¡ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. DialogManagerå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/managers/DialogManager.ts`

```typescript
import Phaser from 'phaser';
import Dialog from 'phaser3-rex-plugins/templates/ui/dialog/Dialog';
import { UIFactory } from '../ui/UIFactory';
import { DialogOptions } from '../ui/UITypes';

interface QueuedDialog {
  options: DialogOptions;
  resolve: () => void;
}

export class DialogManager {
  private static instance: DialogManager | null = null;
  private currentDialog: Dialog | null = null;
  private queue: QueuedDialog[] = [];
  private uiFactory: UIFactory | null = null;
  private scene: Phaser.Scene | null = null;

  private constructor() {}

  public static getInstance(): DialogManager {
    if (!DialogManager.instance) {
      DialogManager.instance = new DialogManager();
    }
    return DialogManager.instance;
  }

  public static resetInstance(): void {
    if (DialogManager.instance) {
      DialogManager.instance.closeAll();
      DialogManager.instance = null;
    }
  }

  public setContext(scene: Phaser.Scene, uiFactory: UIFactory): void {
    this.scene = scene;
    this.uiFactory = uiFactory;
  }

  /**
   * ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆPromiseè¿”å´ï¼‰
   */
  public async show(options: DialogOptions): Promise<void> {
    return new Promise((resolve) => {
      if (this.currentDialog) {
        // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        this.queue.push({ options, resolve });
      } else {
        // å³æ™‚è¡¨ç¤º
        this.displayDialog(options, resolve);
      }
    });
  }

  /**
   * ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
   */
  public async confirm(
    title: string,
    message: string,
    confirmText: string = 'ç¢ºèª',
    cancelText: string = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
  ): Promise<boolean> {
    return new Promise((resolve) => {
      this.show({
        title,
        content: message,
        buttons: [
          {
            text: cancelText,
            onClick: () => resolve(false),
          },
          {
            text: confirmText,
            onClick: () => resolve(true),
            primary: true,
          },
        ],
      });
    });
  }

  /**
   * ã‚¢ãƒ©ãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
   */
  public async alert(
    title: string,
    message: string,
    buttonText: string = 'OK'
  ): Promise<void> {
    return this.show({
      title,
      content: message,
      buttons: [
        {
          text: buttonText,
          onClick: () => {},
          primary: true,
        },
      ],
    });
  }

  /**
   * ç¾åœ¨ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
   */
  public close(): void {
    if (this.currentDialog) {
      this.currentDialog.destroy();
      this.currentDialog = null;
      this.processQueue();
    }
  }

  /**
   * ã™ã¹ã¦ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ï¼ˆã‚­ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢ï¼‰
   */
  public closeAll(): void {
    if (this.currentDialog) {
      this.currentDialog.destroy();
      this.currentDialog = null;
    }
    this.queue.forEach(q => q.resolve());
    this.queue = [];
  }

  /**
   * ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºä¸­ã‹ã©ã†ã‹
   */
  public isShowing(): boolean {
    return this.currentDialog !== null;
  }

  /**
   * ã‚­ãƒ¥ãƒ¼ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒã‚ã‚‹ã‹
   */
  public hasQueued(): boolean {
    return this.queue.length > 0;
  }

  private displayDialog(options: DialogOptions, resolve: () => void): void {
    if (!this.uiFactory) {
      console.error('DialogManager: UIFactory not set');
      resolve();
      return;
    }

    // ãƒœã‚¿ãƒ³ã«resolveå‘¼ã³å‡ºã—ã‚’è¿½åŠ 
    const wrappedOptions: DialogOptions = {
      ...options,
      buttons: options.buttons?.map(btn => ({
        ...btn,
        onClick: () => {
          btn.onClick();
          this.currentDialog = null;
          resolve();
          this.processQueue();
        },
      })),
    };

    this.currentDialog = this.uiFactory.createDialog(wrappedOptions);
  }

  private processQueue(): void {
    if (this.queue.length > 0) {
      const next = this.queue.shift()!;
      this.displayDialog(next.options, next.resolve);
    }
  }
}
```

### 2. DialogManagerã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/managers/index.ts`

```typescript
export { DialogManager } from './DialogManager';
export { SceneManager } from './SceneManager';
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º ğŸŸ¡

**Given**: DialogManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹
**When**: show()ã‚’å‘¼ã¶
**Then**: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚­ãƒ¥ãƒ¼ç®¡ç† ğŸŸ¡

**Given**: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºä¸­
**When**: åˆ¥ã®show()ã‚’å‘¼ã¶
**Then**: ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã•ã‚Œã€å‰ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ãŸå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: confirm ğŸŸ¡

**Given**: DialogManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹
**When**: confirm()ã‚’å‘¼ã³ç¢ºèªãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
**Then**: trueãŒè¿”ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: closeAll ğŸŸ¡

**Given**: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ã‚­ãƒ¥ãƒ¼ãŒã‚ã‚‹
**When**: closeAll()ã‚’å‘¼ã¶
**Then**: ã™ã¹ã¦ãŒé–‰ã˜ã‚‰ã‚Œã‚­ãƒ¥ãƒ¼ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0179` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚·ãƒ¼ãƒ³é·ç§»æ™‚ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çŠ¶æ…‹ç®¡ç†
- UIFactoryã®å‚ç…§ãŒå¿…è¦
- Promiseã®ãƒªã‚¸ã‚§ã‚¯ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ¤œè¨

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
