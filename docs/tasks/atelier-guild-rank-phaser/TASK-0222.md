# TASK-0222: GatheringContainerè¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0222
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

æ¡å–ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã®åŸºæœ¬è¨­è¨ˆã‚’è¡Œã†ã€‚ç´ æé¸æŠç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0213, TASK-0220, TASK-0221
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0223

## å®Œäº†æ¡ä»¶

- [ ] IGatheringContainerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] GatheringContainerOptionsãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã€ç´ æé¸æŠã€APã‚³ã‚¹ãƒˆï¼‰ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹
- [ ] BasePhaseContainerã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. GatheringContainerãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIè¨­è¨ˆæ›¸*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/GatheringContainerConstants.ts`

```typescript
export const GatheringContainerLayout = {
  // å…¨ä½“ã‚µã‚¤ã‚º
  WIDTH: 800,
  HEIGHT: 500,
  PADDING: 20,

  // æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢
  CARD_AREA: {
    X: 20,
    Y: 60,
    WIDTH: 220,
    HEIGHT: 350,
  },

  // ç´ æé¸æŠã‚¨ãƒªã‚¢
  MATERIAL_AREA: {
    X: 260,
    Y: 60,
    WIDTH: 380,
    HEIGHT: 350,
  },

  // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆAPã‚³ã‚¹ãƒˆãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
  SIDE_PANEL: {
    X: 660,
    Y: 60,
    WIDTH: 120,
    HEIGHT: 350,
  },

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
  ACTION_AREA: {
    Y: 430,
    BUTTON_SPACING: 20,
  },
} as const;
```

### 2. IGatheringContainerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/IGatheringContainer.ts`

```typescript
import { GatheringCard } from '../../../../domain/card/GatheringCard';
import { Material } from '../../../../domain/material/Material';
import { IPhaseContainer } from './IPhaseContainer';
import { MaterialOption } from '../material/IMaterialOptionView';

export interface GatheringResult {
  selectedMaterials: Material[];
  totalAPCost: number;
  gatheringCard: GatheringCard;
}

export interface GatheringContainerOptions {
  scene: Phaser.Scene;
  eventBus: EventBus;
  x?: number;
  y?: number;
  onGatheringComplete?: (result: GatheringResult) => void;
  onSkip?: () => void;
}

export interface IGatheringContainer extends IPhaseContainer {
  // æ¡å–åœ°ã‚«ãƒ¼ãƒ‰è¨­å®š
  setGatheringCard(card: GatheringCard): void;
  getGatheringCard(): GatheringCard | null;

  // ç´ æé¸æŠè‚¢è¨­å®š
  setMaterialOptions(options: MaterialOption[]): void;

  // APç®¡ç†
  setCurrentAP(current: number, max: number): void;

  // é¸æŠçŠ¶æ…‹
  getSelectedMaterials(): Material[];
  getTotalAPCost(): number;

  // æ“ä½œ
  confirmGathering(): void;
  resetSelection(): void;
}
```

### 3. GatheringContaineråŸºæœ¬å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¡å–ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/GatheringContainer.ts`

```typescript
import Phaser from 'phaser';
import { BasePhaseContainer } from './BasePhaseContainer';
import { IGatheringContainer, GatheringContainerOptions, GatheringResult } from './IGatheringContainer';
import { GatheringContainerLayout } from './GatheringContainerConstants';
import { GatheringCard } from '../../../../domain/card/GatheringCard';
import { Material } from '../../../../domain/material/Material';
import { MaterialOption } from '../material/IMaterialOptionView';
import { MaterialOptionView } from '../material/MaterialOptionView';
import { GatheringCostView } from '../gathering/GatheringCostView';
import { CardView } from '../card/CardView';
import { EventBus } from '../../core/EventBus';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class GatheringContainer extends BasePhaseContainer implements IGatheringContainer {
  private gatheringCard: GatheringCard | null = null;
  private cardView?: CardView;
  private materialOptionView?: MaterialOptionView;
  private costView?: GatheringCostView;

  private currentAP: number = 0;
  private maxAP: number = 10;

  private onGatheringComplete?: (result: GatheringResult) => void;
  private onSkip?: () => void;

  // ãƒœã‚¿ãƒ³
  private confirmButton?: Phaser.GameObjects.Container;
  private skipButton?: Phaser.GameObjects.Container;

  constructor(options: GatheringContainerOptions) {
    super({
      scene: options.scene,
      eventBus: options.eventBus,
      x: options.x ?? 0,
      y: options.y ?? 0,
      width: GatheringContainerLayout.WIDTH,
      height: GatheringContainerLayout.HEIGHT,
    });

    this.onGatheringComplete = options.onGatheringComplete;
    this.onSkip = options.onSkip;

    this.createBackground();
    this.createTitle('ğŸŒ¿ æ¡å–ãƒ•ã‚§ãƒ¼ã‚º');
    this.createLayout();
    this.createActionButtons();
  }

  private createLayout(): void {
    const { CARD_AREA, MATERIAL_AREA, SIDE_PANEL } = GatheringContainerLayout;

    // æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢
    this.createAreaLabel(CARD_AREA.X, CARD_AREA.Y - 20, 'æ¡å–åœ°');

    // ç´ æé¸æŠã‚¨ãƒªã‚¢
    this.createAreaLabel(MATERIAL_AREA.X, MATERIAL_AREA.Y - 20, 'ç´ æã‚’é¸æŠ');

    // APã‚³ã‚¹ãƒˆã‚¨ãƒªã‚¢
    this.costView = new GatheringCostView(this.scene, {
      x: SIDE_PANEL.X,
      y: SIDE_PANEL.Y,
      currentAP: this.currentAP,
      maxAP: this.maxAP,
    });
    this.container.add(this.costView.container);
  }

  private createAreaLabel(x: number, y: number, text: string): void {
    const label = this.scene.add.text(x, y, text, {
      ...TextStyles.body,
      fontSize: '13px',
      color: '#aaaaaa',
    });
    this.container.add(label);
  }

  private createActionButtons(): void {
    const { ACTION_AREA, WIDTH } = GatheringContainerLayout;
    const centerX = WIDTH / 2;

    // ç¢ºå®šãƒœã‚¿ãƒ³
    this.confirmButton = this.createButton(
      centerX + 60,
      ACTION_AREA.Y,
      'âœ… æ¡å–ã™ã‚‹',
      () => this.confirmGathering(),
      true
    );
    this.container.add(this.confirmButton);

    // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³
    this.skipButton = this.createButton(
      centerX - 60,
      ACTION_AREA.Y,
      'ã‚¹ã‚­ãƒƒãƒ—',
      () => this.handleSkip(),
      false
    );
    this.container.add(this.skipButton);

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    const resetButton = this.createButton(
      WIDTH - 80,
      ACTION_AREA.Y,
      'ğŸ”„ ãƒªã‚»ãƒƒãƒˆ',
      () => this.resetSelection(),
      false
    );
    this.container.add(resetButton);
  }

  setGatheringCard(card: GatheringCard): void {
    this.gatheringCard = card;

    // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’ç ´æ£„
    if (this.cardView) {
      this.cardView.destroy();
    }

    // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ
    const { CARD_AREA } = GatheringContainerLayout;
    this.cardView = new CardView(this.scene, {
      x: CARD_AREA.X + CARD_AREA.WIDTH / 2,
      y: CARD_AREA.Y + 100,
      card: card,
      scale: 1.0,
    });
    this.container.add(this.cardView.container);
  }

  getGatheringCard(): GatheringCard | null {
    return this.gatheringCard;
  }

  setMaterialOptions(options: MaterialOption[]): void {
    // æ—¢å­˜ã®ãƒ“ãƒ¥ãƒ¼ã‚’ç ´æ£„
    if (this.materialOptionView) {
      this.materialOptionView.destroy();
    }

    const { MATERIAL_AREA } = GatheringContainerLayout;

    this.materialOptionView = new MaterialOptionView(this.scene, {
      x: MATERIAL_AREA.X,
      y: MATERIAL_AREA.Y,
      options: options,
      maxSelections: 3,
      onSelect: (material) => this.handleMaterialSelect(material),
      onDeselect: (material) => this.handleMaterialDeselect(material),
    });
    this.container.add(this.materialOptionView.container);
  }

  private handleMaterialSelect(material: Material): void {
    this.updateCostDisplay();
    this.eventBus.emit('gathering:material:selected', { material });
  }

  private handleMaterialDeselect(material: Material): void {
    this.updateCostDisplay();
    this.eventBus.emit('gathering:material:deselected', { material });
  }

  private updateCostDisplay(): void {
    const totalCost = this.getTotalAPCost();
    this.costView?.setRequiredAP(totalCost);
    this.updateConfirmButtonState();
  }

  private updateConfirmButtonState(): void {
    const canConfirm = this.canConfirmGathering();
    if (this.confirmButton) {
      this.confirmButton.setAlpha(canConfirm ? 1 : 0.5);
    }
  }

  private canConfirmGathering(): boolean {
    const selected = this.getSelectedMaterials();
    const totalCost = this.getTotalAPCost();
    return selected.length > 0 && this.currentAP >= totalCost;
  }

  setCurrentAP(current: number, max: number): void {
    this.currentAP = current;
    this.maxAP = max;
    this.costView?.setCurrentAP(current, max);
    this.updateConfirmButtonState();
  }

  getSelectedMaterials(): Material[] {
    return this.materialOptionView?.getSelectedMaterials() ?? [];
  }

  getTotalAPCost(): number {
    // é¸æŠã—ãŸç´ ææ•°ã«å¿œã˜ãŸã‚³ã‚¹ãƒˆè¨ˆç®—
    const selectedCount = this.getSelectedMaterials().length;
    const baseCost = this.gatheringCard?.apCost ?? 1;
    return baseCost * selectedCount;
  }

  confirmGathering(): void {
    if (!this.canConfirmGathering()) return;
    if (!this.gatheringCard) return;

    const result: GatheringResult = {
      selectedMaterials: this.getSelectedMaterials(),
      totalAPCost: this.getTotalAPCost(),
      gatheringCard: this.gatheringCard,
    };

    this.eventBus.emit('gathering:confirm', result);

    if (this.onGatheringComplete) {
      this.onGatheringComplete(result);
    }
  }

  resetSelection(): void {
    this.materialOptionView?.clearSelection();
    this.updateCostDisplay();
    this.eventBus.emit('gathering:reset', {});
  }

  private handleSkip(): void {
    this.eventBus.emit('gathering:skip', {});
    if (this.onSkip) {
      this.onSkip();
    }
  }

  enter(): void {
    super.enter();
    this.resetSelection();
  }

  exit(): void {
    super.exit();
  }

  destroy(): void {
    this.cardView?.destroy();
    this.materialOptionView?.destroy();
    this.costView?.destroy();
    super.destroy();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚³ãƒ³ãƒ†ãƒŠåˆæœŸåŒ– ğŸ”µ

**Given**: GatheringContainerã‚’åˆæœŸåŒ–
**When**: ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
**Then**: ã‚³ãƒ³ãƒ†ãƒŠãŒä½œæˆã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æ¡å–åœ°ã‚«ãƒ¼ãƒ‰è¨­å®š ğŸ”µ

**Given**: GatheringContainerãŒã‚ã‚‹
**When**: setGatheringCard(card)ã‚’å‘¼ã¶
**Then**: ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç´ æé¸æŠè‚¢è¨­å®š ğŸ”µ

**Given**: GatheringContainerãŒã‚ã‚‹
**When**: setMaterialOptions([...])ã‚’å‘¼ã¶
**Then**: ç´ æé¸æŠã‚°ãƒªãƒƒãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0222` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- BasePhaseContainerã®ç¶™æ‰¿æ´»ç”¨
- MaterialOptionViewã¨GatheringCostViewã®é€£æº
- APã‚³ã‚¹ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
