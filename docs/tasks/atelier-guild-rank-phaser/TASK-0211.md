# TASK-0211: Phase2統合テスト

**タスクID**: TASK-0211
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 2 - 基本シーン・共通UI実装
**信頼性レベル**: 🔵 *設計書に記載*

## 関連文書

- **概要**: [overview.md](./overview.md)
- **UI設計**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## タスク概要

Phase 2で実装した基本シーン・共通UIコンポーネントの統合テストを実施する。

## 依存タスク

- **前提タスク**: TASK-0188, TASK-0198, TASK-0204, TASK-0208
- **後続タスク**: TASK-0212 (Phase 3)

## 完了条件

- [ ] BootScene → TitleScene遷移が動作する
- [ ] CardView各種が正しく表示される
- [ ] HandContainerが正しく動作する
- [ ] HeaderUIが正しく更新される
- [ ] SidebarUIが正しく動作する
- [ ] PhaseIndicatorが正しく切り替わる
- [ ] DeckViewが正しく動作する
- [ ] 全コンポーネントの連携が正常

---

## 実装詳細

### 1. 統合テストシーン 🔵

**信頼性**: 🔵 *Phase 2全体の検証*

**実装ファイル**: `src/presentation/phaser/scenes/Phase2IntegrationTestScene.ts`

```typescript
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { HeaderUI } from '../ui/header/HeaderUI';
import { SidebarUI } from '../ui/sidebar/SidebarUI';
import { HandContainer } from '../ui/hand/HandContainer';
import { PhaseIndicator } from '../ui/phase/PhaseIndicator';
import { DeckView } from '../ui/deck/DeckView';
import { UIFactory } from '../ui/common/UIFactory';
import { GamePhase } from '../../../domain/common/GamePhase';
// テスト用のモックデータをインポート

export class Phase2IntegrationTestScene extends BaseGameScene {
  private headerUI!: HeaderUI;
  private sidebarUI!: SidebarUI;
  private handContainer!: HandContainer;
  private phaseIndicator!: PhaseIndicator;
  private deckView!: DeckView;
  private uiFactory!: UIFactory;

  constructor() {
    super('Phase2IntegrationTestScene' as any);
  }

  protected onInit(data?: SceneInitData): void {}
  protected onPreload(): void {}

  protected onCreate(data?: SceneInitData): void {
    this.uiFactory = new UIFactory(this);

    // 各コンポーネントを配置
    this.createHeader();
    this.createSidebar();
    this.createPhaseIndicator();
    this.createDeck();
    this.createHand();

    // 初期データ設定
    this.setInitialData();

    // テストコントロールパネル
    this.createTestControls();
  }

  private createHeader(): void {
    this.headerUI = new HeaderUI(this, {
      onMenuClick: () => console.log('Menu clicked'),
    });
  }

  private createSidebar(): void {
    this.sidebarUI = new SidebarUI(this, this.uiFactory, {
      onQuestSelect: (quest) => console.log(`Quest: ${quest.name}`),
      onItemSelect: (item) => console.log(`Item: ${item.id}`),
    });
  }

  private createPhaseIndicator(): void {
    this.phaseIndicator = new PhaseIndicator(this, {
      x: 200,
      y: 100,
      clickable: true,
      onPhaseClick: (phase) => this.handlePhaseChange(phase),
    });
  }

  private createDeck(): void {
    this.deckView = new DeckView(this, {
      onClick: () => this.handleDeckClick(),
    });
  }

  private createHand(): void {
    this.handContainer = new HandContainer(this, {
      onCardSelect: (card, index) => console.log(`Card: ${card.name}, Index: ${index}`),
      onCardDeselect: (card, index) => console.log(`Deselected: ${card.name}`),
    });
  }

  private setInitialData(): void {
    // ヘッダーデータ
    this.headerUI.updateAll({
      rank: { name: 'E' } as any,
      currentExp: 75,
      requiredExp: 100,
      currentDay: 10,
      maxDay: 30,
      gold: 2500,
      currentAP: 8,
      maxAP: 10,
    });

    // サイドバーデータ
    this.sidebarUI.setQuests(this.createMockQuests());
    this.sidebarUI.setInventory(this.createMockInventory());

    // デッキ
    this.deckView.setCount(15);

    // 手札
    this.handContainer.setCards(this.createMockCards());

    // フェーズ
    this.phaseIndicator.setCurrentPhase('quest_accept');
  }

  private handlePhaseChange(phase: GamePhase): void {
    console.log(`Phase changed to: ${phase}`);
    this.phaseIndicator.setCurrentPhase(phase);
  }

  private async handleDeckClick(): Promise<void> {
    console.log('Deck clicked - Drawing card');
    const drawnCard = await this.deckView.animateDraw();
    // 手札に追加のアニメーション
    drawnCard.destroy();
  }

  private createTestControls(): void {
    const controls = [
      { label: 'ドロー', action: () => this.deckView.animateDraw() },
      { label: 'シャッフル', action: () => this.deckView.animateShuffle() },
      { label: 'EXP+10', action: () => this.headerUI.animateExpGain(10) },
      { label: 'Gold+100', action: () => this.headerUI.animateGoldChange(100) },
      { label: 'AP-1', action: () => this.headerUI.animateAPChange(-1) },
      { label: '次フェーズ', action: () => this.advancePhase() },
    ];

    controls.forEach((ctrl, index) => {
      const button = this.uiFactory.createButton({
        x: 100,
        y: 200 + index * 50,
        width: 120,
        height: 40,
        text: ctrl.label,
        onClick: ctrl.action,
      });
      this.add.existing(button);
    });
  }

  private advancePhase(): void {
    const phases: GamePhase[] = ['quest_accept', 'gathering', 'alchemy', 'delivery'];
    const currentIndex = phases.indexOf(this.phaseIndicator.getCurrentPhase());
    const nextIndex = (currentIndex + 1) % phases.length;
    this.phaseIndicator.setCurrentPhase(phases[nextIndex]);
  }

  private createMockQuests(): any[] {
    return [
      { id: 'q1', name: '初心者の依頼', remainingDays: 10, isComplete: false, reward: { gold: 100, exp: 20 } },
      { id: 'q2', name: '薬草採取', remainingDays: 3, isComplete: false, reward: { gold: 200, exp: 30 } },
      { id: 'q3', name: '傷薬作成', remainingDays: 7, isComplete: true, reward: { gold: 300, exp: 50 } },
    ];
  }

  private createMockInventory(): any[] {
    return [
      { id: 'i1', type: 'material', count: 5, data: { name: '薬草', category: 'plant', quality: 2 } },
      { id: 'i2', type: 'material', count: 3, data: { name: '鉄鉱石', category: 'mineral', quality: 3 } },
      { id: 'i3', type: 'item', count: 1, data: { name: '傷薬', category: 'potion' } },
    ];
  }

  private createMockCards(): any[] {
    // モックカードの生成
    return [];
  }

  protected setupEventListeners(): void {}
}
```

### 2. 統合テストケース 🔵

**信頼性**: 🔵 *Phase 2検証*

**テストファイル**: `tests/integration/presentation/Phase2Integration.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';

describe('Phase2 統合テスト', () => {
  describe('シーン遷移', () => {
    it.skip('BootScene → TitleScene への遷移が正常', () => {
      // アセット読み込み後の遷移テスト
    });

    it.skip('TitleScene → MainScene への遷移が正常', () => {
      // 新規ゲーム開始時の遷移テスト
    });
  });

  describe('HeaderUI連携', () => {
    it.skip('経験値獲得時にゲージとアニメーションが更新される', () => {
      // 経験値更新の連携テスト
    });

    it.skip('ゴールド変化時に表示とアニメーションが更新される', () => {
      // ゴールド更新の連携テスト
    });

    it.skip('AP消費時にゲージと警告が正しく表示される', () => {
      // AP更新の連携テスト
    });
  });

  describe('HandContainer連携', () => {
    it.skip('カード選択時にイベントが発火する', () => {
      // 選択イベントの連携テスト
    });

    it.skip('カード追加時にアニメーションが動作する', () => {
      // 追加アニメーションの連携テスト
    });

    it.skip('カード削除時にレイアウトが再調整される', () => {
      // 削除時の連携テスト
    });
  });

  describe('SidebarUI連携', () => {
    it.skip('依頼選択時にイベントが発火する', () => {
      // 依頼選択の連携テスト
    });

    it.skip('インベントリ選択時にイベントが発火する', () => {
      // インベントリ選択の連携テスト
    });

    it.skip('タブ切り替え時にコンテンツが正しく表示される', () => {
      // タブ切り替えの連携テスト
    });
  });

  describe('PhaseIndicator連携', () => {
    it.skip('フェーズ切り替え時にアニメーションが動作する', () => {
      // フェーズ切り替えの連携テスト
    });

    it.skip('フェーズ完了時に表示が更新される', () => {
      // フェーズ完了の連携テスト
    });
  });

  describe('DeckView連携', () => {
    it.skip('ドロー時にカードが手札に移動する', () => {
      // ドローアニメーションの連携テスト
    });

    it.skip('枚数変化時に表示が更新される', () => {
      // 枚数更新の連携テスト
    });
  });

  describe('コンポーネント間連携', () => {
    it.skip('カードをプレイするとAPが消費される', () => {
      // カードプレイ→AP消費の連携
    });

    it.skip('依頼完了するとゴールドとEXPが増える', () => {
      // 依頼完了→報酬の連携
    });

    it.skip('フェーズ変更時に関連UIが更新される', () => {
      // フェーズ変更→UI更新の連携
    });
  });
});
```

### 3. 手動テストチェックリスト 🔵

**信頼性**: 🔵 *視覚確認*

```markdown
## Phase2 手動テストチェックリスト

### BootScene
- [ ] プログレスバーが0%から100%まで進む
- [ ] 読み込み完了後にTitleSceneに遷移する

### TitleScene
- [ ] タイトルロゴが表示される
- [ ] 「新規ゲーム」ボタンが動作する
- [ ] 「コンティニュー」ボタンが動作する（セーブデータがある場合）

### CardView
- [ ] 採取地カードが正しく表示される
- [ ] レシピカードが正しく表示される
- [ ] 強化カードが正しく表示される
- [ ] ホバー時にカードが拡大する
- [ ] ツールチップが表示される

### HandContainer
- [ ] 手札が水平に並ぶ
- [ ] 手札が扇形に並ぶ（切り替え時）
- [ ] カードを選択できる
- [ ] 選択解除できる
- [ ] カード追加アニメーションが動作する
- [ ] カード削除アニメーションが動作する

### HeaderUI
- [ ] ランクが正しく表示される
- [ ] 経験値ゲージが正しく表示される
- [ ] 日数が正しく表示される
- [ ] ゴールドが正しく表示される
- [ ] APゲージが正しく表示される
- [ ] 各種アニメーションが動作する

### SidebarUI
- [ ] タブ切り替えが動作する
- [ ] 依頼リストが表示される
- [ ] インベントリグリッドが表示される
- [ ] フィルターが動作する
- [ ] 選択状態が表示される

### PhaseIndicator
- [ ] 4フェーズが表示される
- [ ] 現在フェーズがハイライトされる
- [ ] フェーズ切り替えアニメーションが動作する

### DeckView
- [ ] デッキスタックが表示される
- [ ] 残り枚数が表示される
- [ ] ドローアニメーションが動作する
- [ ] シャッフルアニメーションが動作する
```

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0211` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 各コンポーネント間のイベント連携
- アニメーションの競合
- パフォーマンスのボトルネック

---

## 信頼性レベルサマリー

- **総項目数**: 3項目
- 🔵 **青信号**: 3項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
