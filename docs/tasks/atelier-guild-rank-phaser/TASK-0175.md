# TASK-0175: UIFactoryダイアログ生成実装

**タスクID**: TASK-0175
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 1 - Phaser基盤・インフラ構築
**信頼性レベル**: 🟡 *妥当な推測に基づく*

## 関連文書

- **概要**: [overview.md](./overview.md)
- **コアシステム**: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## タスク概要

UIFactoryのcreateDialog()メソッドを実装し、確認ダイアログや情報ダイアログを生成できるようにする。

## 依存タスク

- **前提タスク**: TASK-0174
- **後続タスク**: TASK-0179, TASK-0231, TASK-0244, TASK-0258

## 完了条件

- [ ] createDialog()メソッドが実装されている
- [ ] モーダル背景が表示される
- [ ] タイトル、コンテンツ、ボタンが配置される
- [ ] ボタンクリックでダイアログが閉じる
- [ ] カスタムコンテンツが配置できる

---

## 実装詳細

### 1. createDialog実装 🟡

**信頼性**: 🟡 *rexUI.Dialogを使用*

**実装ファイル**: `src/presentation/phaser/ui/UIFactory.ts`に追加

```typescript
import Dialog from 'phaser3-rex-plugins/templates/ui/dialog/Dialog';

createDialog(options: DialogOptions): Dialog {
  const {
    title, content, buttons, width, modal
  } = options;

  const dialogWidth = width ?? 400;

  // モーダル背景
  let modalBackground: Phaser.GameObjects.Rectangle | undefined;
  if (modal !== false) {
    modalBackground = this.scene.add.rectangle(
      this.scene.cameras.main.centerX,
      this.scene.cameras.main.centerY,
      this.scene.cameras.main.width,
      this.scene.cameras.main.height,
      Colors.overlay,
      Colors.overlayAlpha
    ).setInteractive();
  }

  // ダイアログ本体
  const dialog = this.rexUI.add.dialog({
    x: this.scene.cameras.main.centerX,
    y: this.scene.cameras.main.centerY,
    width: dialogWidth,

    background: this.rexUI.add.roundRectangle(
      0, 0, 0, 0, 12, Colors.panelBackground
    ),

    title: this.scene.add.text(0, 0, title, TextStyles.titleSmall),

    content: typeof content === 'string'
      ? this.scene.add.text(0, 0, content, {
          ...TextStyles.body,
          wordWrap: { width: dialogWidth - 40 }
        })
      : content,

    actions: buttons?.map(btn => {
      const buttonLabel = this.createButton({
        x: 0, y: 0,
        text: btn.text,
        width: 100,
        style: {
          backgroundColor: btn.primary ? Colors.primary : Colors.secondary,
        },
        onClick: () => {
          btn.onClick();
          this.closeDialog(dialog, modalBackground);
        }
      });
      return buttonLabel;
    }),

    space: {
      title: 20,
      content: 20,
      action: 10,
      left: 20,
      right: 20,
      top: 20,
      bottom: 20,
    },

    align: {
      actions: 'right',
    },
  }).layout();

  // ダイアログをトップに
  dialog.setDepth(1000);
  if (modalBackground) {
    modalBackground.setDepth(999);
  }

  // ESCキーで閉じる
  this.scene.input.keyboard?.once('keydown-ESC', () => {
    this.closeDialog(dialog, modalBackground);
  });

  return dialog;
}

private closeDialog(
  dialog: Dialog,
  modalBackground?: Phaser.GameObjects.Rectangle
): void {
  dialog.destroy();
  if (modalBackground) {
    modalBackground.destroy();
  }
}

// 確認ダイアログ（便利メソッド）
createConfirmDialog(options: {
  title: string;
  message: string;
  onConfirm: () => void;
  onCancel?: () => void;
  confirmText?: string;
  cancelText?: string;
}): Dialog {
  return this.createDialog({
    title: options.title,
    content: options.message,
    modal: true,
    buttons: [
      {
        text: options.cancelText ?? 'キャンセル',
        onClick: () => options.onCancel?.(),
      },
      {
        text: options.confirmText ?? '確認',
        onClick: options.onConfirm,
        primary: true,
      },
    ],
  });
}

// 情報ダイアログ（便利メソッド）
createAlertDialog(options: {
  title: string;
  message: string;
  onClose?: () => void;
  buttonText?: string;
}): Dialog {
  return this.createDialog({
    title: options.title,
    content: options.message,
    modal: true,
    buttons: [
      {
        text: options.buttonText ?? 'OK',
        onClick: () => options.onClose?.(),
        primary: true,
      },
    ],
  });
}
```

---

## 単体テスト要件

### テストケース1: ダイアログ生成 🟡

**Given**: UIFactoryインスタンスがある
**When**: createDialog()を呼ぶ
**Then**: Dialogオブジェクトが返される

### テストケース2: ボタンクリック 🟡

**Given**: ダイアログにボタンがある
**When**: ボタンをクリックする
**Then**: onClickが呼ばれダイアログが閉じる

### テストケース3: 確認ダイアログ 🟡

**Given**: UIFactoryインスタンスがある
**When**: createConfirmDialog()を呼ぶ
**Then**: 確認/キャンセルボタン付きダイアログが表示される

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0175` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- モーダル背景は入力をブロックする
- ダイアログのZ-indexを適切に設定
- 複数ダイアログの重ね表示を考慮

---

## 信頼性レベルサマリー

- **総項目数**: 1項目
- 🔵 **青信号**: 0項目 (0%)
- 🟡 **黄信号**: 1項目 (100%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 中品質
