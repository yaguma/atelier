# TASK-0176: UIFactoryãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”Ÿæˆå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0176
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

UIFactoryã®createProgressBar()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã€ã‚²ãƒ¼ã‚¸ã‚„é€²æ—è¡¨ç¤ºã‚’ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0174
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0184, TASK-0201

## å®Œäº†æ¡ä»¶

- [ ] createProgressBar()ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å€¤ã®æ›´æ–°ãŒåæ˜ ã•ã‚Œã‚‹
- [ ] ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãæ›´æ–°ãŒã§ãã‚‹
- [ ] ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ãŒã§ãã‚‹
- [ ] ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ãŒé©ç”¨ã§ãã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. createProgressBarå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *Graphicsã‚’ä½¿ç”¨ã—ãŸç‹¬è‡ªå®Ÿè£…*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/UIFactory.ts`ã«è¿½åŠ 

```typescript
export interface ProgressBarObject {
  container: Phaser.GameObjects.Container;
  background: Phaser.GameObjects.Graphics;
  bar: Phaser.GameObjects.Graphics;
  text?: Phaser.GameObjects.Text;
  getValue: () => number;
  setValue: (value: number, animate?: boolean) => void;
  setMaxValue: (maxValue: number) => void;
}

createProgressBar(options: ProgressBarOptions): ProgressBarObject {
  const {
    x, y, width, height,
    value, maxValue,
    barColor, backgroundColor,
    showText
  } = options;

  const bgColor = backgroundColor ?? Colors.backgroundDark;
  const fillColor = barColor ?? Colors.primary;
  const radius = height / 2;

  // ã‚³ãƒ³ãƒ†ãƒŠ
  const container = this.scene.add.container(x, y);

  // èƒŒæ™¯
  const background = this.scene.add.graphics();
  background.fillStyle(bgColor);
  background.fillRoundedRect(-width/2, -height/2, width, height, radius);
  container.add(background);

  // ãƒãƒ¼
  const bar = this.scene.add.graphics();
  container.add(bar);

  // ãƒ†ã‚­ã‚¹ãƒˆ
  let textObj: Phaser.GameObjects.Text | undefined;
  if (showText) {
    textObj = this.scene.add.text(0, 0, '', TextStyles.bodySmall)
      .setOrigin(0.5);
    container.add(textObj);
  }

  // çŠ¶æ…‹ç®¡ç†
  let currentValue = value;
  let currentMaxValue = maxValue;

  const updateBar = (val: number, animate: boolean = false) => {
    const percent = Math.max(0, Math.min(1, val / currentMaxValue));
    const barWidth = (width - 4) * percent;

    if (animate && this.scene.tweens) {
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
      this.scene.tweens.addCounter({
        from: currentValue,
        to: val,
        duration: 300,
        onUpdate: (tween) => {
          const tweenValue = tween.getValue();
          const tweenPercent = tweenValue / currentMaxValue;
          const tweenWidth = (width - 4) * tweenPercent;

          bar.clear();
          bar.fillStyle(fillColor);
          if (tweenWidth > 0) {
            bar.fillRoundedRect(
              -width/2 + 2,
              -height/2 + 2,
              tweenWidth,
              height - 4,
              radius - 2
            );
          }

          if (textObj) {
            textObj.setText(`${Math.round(tweenValue)}/${currentMaxValue}`);
          }
        },
      });
    } else {
      // å³æ™‚æ›´æ–°
      bar.clear();
      bar.fillStyle(fillColor);
      if (barWidth > 0) {
        bar.fillRoundedRect(
          -width/2 + 2,
          -height/2 + 2,
          barWidth,
          height - 4,
          radius - 2
        );
      }

      if (textObj) {
        textObj.setText(`${Math.round(val)}/${currentMaxValue}`);
      }
    }

    currentValue = val;
  };

  // åˆæœŸæç”»
  updateBar(value, false);

  return {
    container,
    background,
    bar,
    text: textObj,
    getValue: () => currentValue,
    setValue: (val, animate = false) => updateBar(val, animate),
    setMaxValue: (max) => {
      currentMaxValue = max;
      updateBar(currentValue, false);
    },
  };
}

// ãƒ©ãƒ³ã‚¯ã‚²ãƒ¼ã‚¸ï¼ˆç‰¹æ®Šãªãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼‰
createRankGauge(options: {
  x: number;
  y: number;
  width: number;
  height: number;
  contribution: number;
  maxContribution: number;
}): ProgressBarObject {
  return this.createProgressBar({
    ...options,
    value: options.contribution,
    maxValue: options.maxContribution,
    barColor: Colors.gold,
    backgroundColor: Colors.backgroundDark,
    showText: true,
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”Ÿæˆ ğŸŸ¡

**Given**: UIFactoryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹
**When**: createProgressBar()ã‚’å‘¼ã¶
**Then**: ProgressBarObjectãŒè¿”ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å€¤ã®æ›´æ–° ğŸŸ¡

**Given**: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãŒã‚ã‚‹
**When**: setValue(50)ã‚’å‘¼ã¶
**Then**: ãƒãƒ¼ã®å¹…ãŒ50%ã«ãªã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–° ğŸŸ¡

**Given**: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãŒã‚ã‚‹
**When**: setValue(100, true)ã‚’å‘¼ã¶
**Then**: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å€¤ãŒæ›´æ–°ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0176` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å€¤ãŒ0ã€œmaxValueã®ç¯„å›²ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã‚¯ãƒ©ãƒ³ãƒ—
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®é€£ç¶šæ›´æ–°ã¸ã®å¯¾å¿œ
- å°æ•°å€¤ã®ä¸¸ã‚å‡¦ç†

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
