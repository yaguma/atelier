# TASK-0199: MaterialViewè¨­è¨ˆãƒ»å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0199
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ç´ æã‚¢ã‚¤ãƒ†ãƒ ã®è¦–è¦šçš„è¡¨ç¾ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚ç´ æã‚¢ã‚¤ã‚³ãƒ³ã€åå‰ã€å“è³ªã€å€‹æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0162, TASK-0163
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0200

## å®Œäº†æ¡ä»¶

- [x] IMaterialViewã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [x] MaterialViewã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ç´ æåãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] å“è³ªãŒè‰²åˆ†ã‘ã§è¡¨ç¤ºã•ã‚Œã‚‹
- [x] å€‹æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] ã‚¯ãƒªãƒƒã‚¯/ãƒ›ãƒãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒå‹•ä½œã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. MaterialViewå®šæ•°ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ç´ æè¡¨ç¤ºã®æ¨™æº–åŒ–*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/material/MaterialConstants.ts`

```typescript
export const MaterialLayout = {
  // ã‚µã‚¤ã‚º
  ICON_SIZE: 48,
  BADGE_SIZE: 20,

  // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º
  COMPACT_WIDTH: 60,
  COMPACT_HEIGHT: 70,

  // è©³ç´°è¡¨ç¤º
  DETAIL_WIDTH: 200,
  DETAIL_HEIGHT: 60,
} as const;

export const MaterialQualityColors: Record<number, number> = {
  1: 0x808080,  // ç°è‰²ï¼ˆæ™®é€šï¼‰
  2: 0x00ff00,  // ç·‘ï¼ˆè‰¯ï¼‰
  3: 0x0080ff,  // é’ï¼ˆå„ªï¼‰
  4: 0xaa00ff,  // ç´«ï¼ˆç§€ï¼‰
  5: 0xffd700,  // é‡‘ï¼ˆæ¥µï¼‰
};

export type MaterialViewMode = 'compact' | 'detail';
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/material/IMaterialView.ts`

```typescript
import Phaser from 'phaser';
import { Material } from '../../../../domain/material/Material';

export interface MaterialViewOptions {
  material: Material;
  x: number;
  y: number;
  mode?: MaterialViewMode;
  count?: number;
  showQuality?: boolean;
  interactive?: boolean;
  onClick?: (material: Material) => void;
  onHover?: (material: Material, isHovering: boolean) => void;
}

export interface IMaterialView {
  readonly container: Phaser.GameObjects.Container;
  readonly material: Material;

  // è¡¨ç¤ºæ›´æ–°
  setCount(count: number): void;
  setSelected(selected: boolean): void;
  setEnabled(enabled: boolean): void;

  // ä½ç½®ãƒ»è¡¨ç¤º
  setPosition(x: number, y: number): void;
  setVisible(visible: boolean): void;
  setAlpha(alpha: number): void;

  // ç ´æ£„
  destroy(): void;
}
```

### 2. MaterialViewå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *åŸºæœ¬çš„ãªUIå®Ÿè£…*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/material/MaterialView.ts`

```typescript
import Phaser from 'phaser';
import { Material } from '../../../../domain/material/Material';
import { IMaterialView, MaterialViewOptions } from './IMaterialView';
import { MaterialLayout, MaterialQualityColors, MaterialViewMode } from './MaterialConstants';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class MaterialView implements IMaterialView {
  public readonly container: Phaser.GameObjects.Container;
  public readonly material: Material;

  private scene: Phaser.Scene;
  private mode: MaterialViewMode;
  private count: number;
  private selected: boolean = false;
  private enabled: boolean = true;

  private background!: Phaser.GameObjects.Graphics;
  private iconSprite!: Phaser.GameObjects.Sprite | Phaser.GameObjects.Text;
  private nameText?: Phaser.GameObjects.Text;
  private countText!: Phaser.GameObjects.Text;
  private qualityIndicator!: Phaser.GameObjects.Graphics;

  private onClick?: (material: Material) => void;
  private onHover?: (material: Material, isHovering: boolean) => void;

  constructor(scene: Phaser.Scene, options: MaterialViewOptions) {
    this.scene = scene;
    this.material = options.material;
    this.mode = options.mode ?? 'compact';
    this.count = options.count ?? 1;
    this.onClick = options.onClick;
    this.onHover = options.onHover;

    this.container = scene.add.container(options.x, options.y);

    if (this.mode === 'compact') {
      this.createCompactView(options);
    } else {
      this.createDetailView(options);
    }

    if (options.interactive !== false) {
      this.setInteractive(true);
    }
  }

  private createCompactView(options: MaterialViewOptions): void {
    const { COMPACT_WIDTH, COMPACT_HEIGHT, ICON_SIZE, BADGE_SIZE } = MaterialLayout;

    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.background.fillStyle(Colors.backgroundDark, 0.8);
    this.background.fillRoundedRect(
      -COMPACT_WIDTH / 2, -COMPACT_HEIGHT / 2,
      COMPACT_WIDTH, COMPACT_HEIGHT, 6
    );
    this.container.add(this.background);

    // ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã¾ãŸã¯çµµæ–‡å­—ï¼‰
    const iconKey = `material_${this.material.id}`;
    if (this.scene.textures.exists(iconKey)) {
      this.iconSprite = this.scene.add.sprite(0, -10, iconKey);
      this.iconSprite.setDisplaySize(ICON_SIZE, ICON_SIZE);
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³
      this.iconSprite = this.scene.add.text(0, -10, this.getMaterialEmoji(), {
        fontSize: '32px',
      }).setOrigin(0.5);
    }
    this.container.add(this.iconSprite);

    // å“è³ªã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    if (options.showQuality !== false && this.material.quality) {
      this.qualityIndicator = this.scene.add.graphics();
      const qualityColor = MaterialQualityColors[this.material.quality] ?? Colors.textPrimary;
      this.qualityIndicator.fillStyle(qualityColor);
      this.qualityIndicator.fillCircle(COMPACT_WIDTH / 2 - 8, -COMPACT_HEIGHT / 2 + 8, 6);
      this.container.add(this.qualityIndicator);
    }

    // å€‹æ•°ãƒãƒƒã‚¸
    if (this.count > 1) {
      this.countText = this.scene.add.text(
        COMPACT_WIDTH / 2 - 5, COMPACT_HEIGHT / 2 - 5,
        `x${this.count}`,
        { ...TextStyles.bodySmall, fontSize: '11px', color: '#ffffff' }
      ).setOrigin(1, 1);
      this.container.add(this.countText);
    }
  }

  private createDetailView(options: MaterialViewOptions): void {
    const { DETAIL_WIDTH, DETAIL_HEIGHT, ICON_SIZE } = MaterialLayout;

    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.background.fillStyle(Colors.backgroundDark, 0.9);
    this.background.fillRoundedRect(0, 0, DETAIL_WIDTH, DETAIL_HEIGHT, 8);
    this.container.add(this.background);

    // ã‚¢ã‚¤ã‚³ãƒ³
    const iconKey = `material_${this.material.id}`;
    if (this.scene.textures.exists(iconKey)) {
      this.iconSprite = this.scene.add.sprite(8 + ICON_SIZE / 2, DETAIL_HEIGHT / 2, iconKey);
      this.iconSprite.setDisplaySize(ICON_SIZE, ICON_SIZE);
    } else {
      this.iconSprite = this.scene.add.text(8 + ICON_SIZE / 2, DETAIL_HEIGHT / 2, this.getMaterialEmoji(), {
        fontSize: '28px',
      }).setOrigin(0.5);
    }
    this.container.add(this.iconSprite);

    // ç´ æå
    this.nameText = this.scene.add.text(
      ICON_SIZE + 20, 12,
      this.material.name,
      { ...TextStyles.body, fontSize: '14px' }
    );
    this.container.add(this.nameText);

    // å“è³ªãƒ†ã‚­ã‚¹ãƒˆ
    if (this.material.quality) {
      const qualityColor = MaterialQualityColors[this.material.quality] ?? Colors.textPrimary;
      const qualityText = this.scene.add.text(
        ICON_SIZE + 20, 32,
        `å“è³ª: ${this.material.quality}`,
        { ...TextStyles.bodySmall, fontSize: '12px', color: `#${qualityColor.toString(16).padStart(6, '0')}` }
      );
      this.container.add(qualityText);
    }

    // å€‹æ•°
    this.countText = this.scene.add.text(
      DETAIL_WIDTH - 10, DETAIL_HEIGHT / 2,
      `x${this.count}`,
      { ...TextStyles.body, fontSize: '16px' }
    ).setOrigin(1, 0.5);
    this.container.add(this.countText);
  }

  setCount(count: number): void {
    this.count = count;
    if (this.countText) {
      this.countText.setText(`x${count}`);
      this.countText.setVisible(count > 1 || this.mode === 'detail');
    }
  }

  setSelected(selected: boolean): void {
    this.selected = selected;
    this.updateVisualState();
  }

  setEnabled(enabled: boolean): void {
    this.enabled = enabled;
    this.container.setAlpha(enabled ? 1 : 0.5);
    this.setInteractive(enabled);
  }

  setPosition(x: number, y: number): void {
    this.container.setPosition(x, y);
  }

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  setAlpha(alpha: number): void {
    this.container.setAlpha(alpha);
  }

  destroy(): void {
    this.container.destroy();
  }

  private setInteractive(enabled: boolean): void {
    if (enabled) {
      const bounds = this.mode === 'compact'
        ? new Phaser.Geom.Rectangle(
            -MaterialLayout.COMPACT_WIDTH / 2, -MaterialLayout.COMPACT_HEIGHT / 2,
            MaterialLayout.COMPACT_WIDTH, MaterialLayout.COMPACT_HEIGHT
          )
        : new Phaser.Geom.Rectangle(0, 0, MaterialLayout.DETAIL_WIDTH, MaterialLayout.DETAIL_HEIGHT);

      this.container.setInteractive(bounds, Phaser.Geom.Rectangle.Contains);
      this.container.on('pointerover', () => {
        if (this.enabled && this.onHover) {
          this.onHover(this.material, true);
        }
      });
      this.container.on('pointerout', () => {
        if (this.enabled && this.onHover) {
          this.onHover(this.material, false);
        }
      });
      this.container.on('pointerdown', () => {
        if (this.enabled && this.onClick) {
          this.onClick(this.material);
        }
      });
    } else {
      this.container.disableInteractive();
    }
  }

  private updateVisualState(): void {
    const borderColor = this.selected ? Colors.accent : Colors.panelBorder;
    const borderWidth = this.selected ? 2 : 1;

    if (this.mode === 'compact') {
      this.background.clear();
      this.background.fillStyle(Colors.backgroundDark, 0.8);
      this.background.fillRoundedRect(
        -MaterialLayout.COMPACT_WIDTH / 2, -MaterialLayout.COMPACT_HEIGHT / 2,
        MaterialLayout.COMPACT_WIDTH, MaterialLayout.COMPACT_HEIGHT, 6
      );
      this.background.lineStyle(borderWidth, borderColor);
      this.background.strokeRoundedRect(
        -MaterialLayout.COMPACT_WIDTH / 2, -MaterialLayout.COMPACT_HEIGHT / 2,
        MaterialLayout.COMPACT_WIDTH, MaterialLayout.COMPACT_HEIGHT, 6
      );
    } else {
      this.background.clear();
      this.background.fillStyle(Colors.backgroundDark, 0.9);
      this.background.fillRoundedRect(0, 0, MaterialLayout.DETAIL_WIDTH, MaterialLayout.DETAIL_HEIGHT, 8);
      this.background.lineStyle(borderWidth, borderColor);
      this.background.strokeRoundedRect(0, 0, MaterialLayout.DETAIL_WIDTH, MaterialLayout.DETAIL_HEIGHT, 8);
    }
  }

  private getMaterialEmoji(): string {
    // ç´ æã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸçµµæ–‡å­—
    const category = this.material.category;
    switch (category) {
      case 'plant': return 'ğŸŒ¿';
      case 'mineral': return 'ğŸ’';
      case 'liquid': return 'ğŸ’§';
      case 'powder': return 'âœ¨';
      case 'monster': return 'ğŸ¦´';
      default: return 'ğŸ“¦';
    }
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º ğŸŸ¡

**Given**: ç´ æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
**When**: MaterialViewã‚’compactãƒ¢ãƒ¼ãƒ‰ã§ç”Ÿæˆã™ã‚‹
**Then**: ã‚¢ã‚¤ã‚³ãƒ³ã¨å€‹æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è©³ç´°è¡¨ç¤º ğŸŸ¡

**Given**: ç´ æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
**When**: MaterialViewã‚’detailãƒ¢ãƒ¼ãƒ‰ã§ç”Ÿæˆã™ã‚‹
**Then**: åå‰ã€å“è³ªã€å€‹æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å“è³ªè‰²åˆ†ã‘ ğŸŸ¡

**Given**: å“è³ª5ã®ç´ æãŒã‚ã‚‹
**When**: MaterialViewã‚’ç”Ÿæˆã™ã‚‹
**Then**: é‡‘è‰²ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0199` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç´ æã‚¢ã‚¤ã‚³ãƒ³ã‚¢ã‚»ãƒƒãƒˆã®æœ‰ç„¡ã«ã‚ˆã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- å“è³ªã®è‰²åˆ†ã‘ãƒ«ãƒ¼ãƒ«
- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ/è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
