# TASK-0264: ã‚·ãƒ§ãƒƒãƒ—è³¼å…¥çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0264
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚·ãƒ§ãƒƒãƒ—ä»•æ§˜**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚ã‚«ãƒ¼ãƒ‰è³¼å…¥ã€ç´ æè³¼å…¥ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ã®ãƒ•ãƒ­ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0243 (ShopSceneãƒ†ã‚¹ãƒˆ)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0269

## å®Œäº†æ¡ä»¶

- [ ] ã‚«ãƒ¼ãƒ‰è³¼å…¥ãƒ•ãƒ­ãƒ¼ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ç´ æè³¼å…¥ãƒ•ãƒ­ãƒ¼ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ãƒ•ãƒ­ãƒ¼ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»ãƒ©ãƒ³ã‚¯åˆ¶é™ã®æ¤œè¨¼ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] è³¼å…¥å¾Œã®çŠ¶æ…‹åŒæœŸãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

---

## ãƒ†ã‚¹ãƒˆå®Ÿè£…è©³ç´°

### 1. ã‚·ãƒ§ãƒƒãƒ—è³¼å…¥çµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ†ã‚¹ãƒˆ*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/phase5/ShopPurchaseIntegration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createTestGame, waitForScene, navigateToShop } from '../../../utils/phaserTestUtils';
import { EventBus } from '@/presentation/phaser/core/EventBus';
import { PhaserStateManager } from '@/presentation/phaser/state/PhaserStateManager';
import { SceneKeys } from '@/presentation/phaser/config/SceneKeys';

describe('Shop Purchase Integration', () => {
  let game: Phaser.Game;
  let eventBus: EventBus;
  let stateManager: PhaserStateManager;

  beforeEach(async () => {
    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
    stateManager = game.registry.get('stateManager');

    // ã‚²ãƒ¼ãƒ é–‹å§‹ã—ã¦ã‚·ãƒ§ãƒƒãƒ—ã¸
    eventBus.emit('ui:game:start:requested', { isNewGame: true });
    await navigateToShop(game, eventBus);
  });

  afterEach(() => {
    game.destroy(true);
  });

  describe('Card Purchase', () => {
    it('ã‚«ãƒ¼ãƒ‰ã‚’è³¼å…¥ã§ãã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });
      const initialDeckSize = stateManager.getDeck().cards.length;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        const deck = stateManager.getDeck();
        expect(deck.cards.length).toBe(initialDeckSize + 1);
      });
    });

    it('è³¼å…¥ã—ãŸã‚«ãƒ¼ãƒ‰ãŒãƒ‡ãƒƒã‚­ã«è¿½åŠ ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_forest',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        const deck = stateManager.getDeck();
        expect(deck.cards).toContainEqual(
          expect.objectContaining({ id: expect.stringContaining('forest') })
        );
      });
    });

    it('ã‚´ãƒ¼ãƒ«ãƒ‰ä¸è¶³æ™‚ã¯è³¼å…¥ã§ããªã„', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 10, rank: 'E' });

      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic', // ä¾¡æ ¼ > 10
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            message: expect.stringContaining('ã‚´ãƒ¼ãƒ«ãƒ‰'),
          })
        );
      });
    });

    it('ãƒ©ãƒ³ã‚¯åˆ¶é™ã®ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ã¯è³¼å…¥ã§ããªã„', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 10000, rank: 'E' });

      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'rare_recipe_card_a_rank', // Aãƒ©ãƒ³ã‚¯å¿…è¦
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            message: expect.stringContaining('ãƒ©ãƒ³ã‚¯'),
          })
        );
      });
    });

    it('è³¼å…¥ã§ã‚´ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ãæ¸›å°‘ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });
      const initialGold = stateManager.getPlayerData().gold;
      const cardPrice = 100; // åŸºæœ¬ã‚«ãƒ¼ãƒ‰ä¾¡æ ¼

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.gold).toBe(initialGold - cardPrice);
      });
    });
  });

  describe('Material Purchase', () => {
    it('ç´ æã‚’è³¼å…¥ã§ãã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });
      const initialMaterials = stateManager.getInventory().materials;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity: 5,
      });

      // Assert
      await vi.waitFor(() => {
        const inventory = stateManager.getInventory();
        const herb = inventory.materials.find(m => m.id === 'herb_basic');
        expect(herb).toBeDefined();
        expect(herb!.quantity).toBeGreaterThanOrEqual(5);
      });
    });

    it('åŒã˜ç´ æã‚’è¤‡æ•°å›è³¼å…¥ã™ã‚‹ã¨æ•°é‡ãŒåŠ ç®—ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 1000, rank: 'E' });
      stateManager.updateInventory({
        materials: [{ id: 'herb_basic', name: 'è–¬è‰', quantity: 3, quality: 70 }],
        craftedItems: [],
        artifacts: [],
      });

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity: 5,
      });

      // Assert
      await vi.waitFor(() => {
        const herb = stateManager.getInventory().materials.find(m => m.id === 'herb_basic');
        expect(herb!.quantity).toBe(8);
      });
    });

    it('æ•°é‡æŒ‡å®šãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 1000, rank: 'E' });
      const pricePerUnit = 20;
      const quantity = 10;
      const initialGold = stateManager.getPlayerData().gold;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity,
      });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.gold).toBe(initialGold - pricePerUnit * quantity);
      });
    });
  });

  describe('Artifact Purchase', () => {
    it('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’è³¼å…¥ã§ãã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 5000, rank: 'C' });
      const initialArtifacts = stateManager.getInventory().artifacts;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'artifact',
        itemId: 'artifact_quality_boost',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        const inventory = stateManager.getInventory();
        expect(inventory.artifacts.length).toBeGreaterThan(initialArtifacts.length);
      });
    });

    it('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ã«ã¯é«˜ãƒ©ãƒ³ã‚¯ãŒå¿…è¦', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 10000, rank: 'E' });

      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'artifact',
        itemId: 'artifact_quality_boost', // Cãƒ©ãƒ³ã‚¯å¿…è¦
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalled();
      });
    });

    it('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŠ¹æœãŒé©ç”¨ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 5000, rank: 'C' });

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'artifact',
        itemId: 'artifact_ap_boost', // AP+1
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.ap.max).toBeGreaterThan(3); // åˆæœŸå€¤3
      });
    });
  });

  describe('Purchase Events', () => {
    it('è³¼å…¥æˆåŠŸæ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });

      const purchaseCallback = vi.fn();
      eventBus.on('app:shop:purchased', purchaseCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(purchaseCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            item: expect.any(Object),
            quantity: 1,
            newGold: expect.any(Number),
          })
        );
      });
    });

    it('ã‚´ãƒ¼ãƒ«ãƒ‰æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });

      const goldCallback = vi.fn();
      eventBus.on('app:player:data:updated', goldCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(goldCallback).toHaveBeenCalled();
      });
    });
  });

  describe('Shop UI State', () => {
    it('è³¼å…¥å¾Œã‚‚ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ã«ç•™ã¾ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(game.scene.isActive(SceneKeys.SHOP)).toBe(true);
      });
    });

    it('ã‚·ãƒ§ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ã¨ãƒ¡ã‚¤ãƒ³ã‚·ãƒ¼ãƒ³ã«æˆ»ã‚‹', async () => {
      // Act
      eventBus.emit('ui:shop:close:requested');

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
    });

    it('è³¼å…¥å¾Œã®ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });

      const uiUpdateCallback = vi.fn();
      eventBus.on('app:player:data:updated', uiUpdateCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'gathering_card_basic',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(uiUpdateCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            gold: expect.any(Number),
          })
        );
      });
    });
  });

  describe('Edge Cases', () => {
    it('å­˜åœ¨ã—ãªã„å•†å“ã¯è³¼å…¥ã§ããªã„', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 10000, rank: 'S' });

      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'card',
        itemId: 'nonexistent_item',
        quantity: 1,
      });

      // Assert
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalled();
      });
    });

    it('æ•°é‡0ã§ã®è³¼å…¥è¦æ±‚ã¯ç„¡è¦–ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 500, rank: 'E' });
      const initialGold = stateManager.getPlayerData().gold;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity: 0,
      });

      // Assert
      await new Promise(resolve => setTimeout(resolve, 100));
      expect(stateManager.getPlayerData().gold).toBe(initialGold);
    });

    it('å¤§é‡è³¼å…¥ã§ã‚‚æ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({ gold: 100000, rank: 'S' });
      const quantity = 99;

      // Act
      eventBus.emit('ui:shop:purchase:requested', {
        category: 'material',
        itemId: 'herb_basic',
        quantity,
      });

      // Assert
      await vi.waitFor(() => {
        const herb = stateManager.getInventory().materials.find(m => m.id === 'herb_basic');
        expect(herb!.quantity).toBe(quantity);
      });
    });
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0264` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|-----------|---------------|
| ã‚«ãƒ¼ãƒ‰è³¼å…¥ | 95% |
| ç´ æè³¼å…¥ | 95% |
| ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ | 90% |
| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | 85% |

---

## æ³¨æ„äº‹é …

- ä¾¡æ ¼è¨ˆç®—ã®æ­£ç¢ºæ€§
- ãƒ©ãƒ³ã‚¯åˆ¶é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- çŠ¶æ…‹æ›´æ–°ã®åŒæœŸ

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
