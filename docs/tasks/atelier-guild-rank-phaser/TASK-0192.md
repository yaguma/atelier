# TASK-0192: CardViewå¼·åŒ–ã‚«ãƒ¼ãƒ‰å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0192
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

å¼·åŒ–ã‚«ãƒ¼ãƒ‰ï¼ˆEnhancementCardï¼‰ã®è¦–è¦šçš„è¡¨ç¾ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0191
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0193

## å®Œäº†æ¡ä»¶

- [x] EnhancementCardViewã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚«ãƒ¼ãƒ‰åãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] APã‚³ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] åŠ¹æœèª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] åŠ¹æœã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. EnhancementCardViewå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *GatheringCardViewã‚’å‚è€ƒ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/card/EnhancementCardView.ts`

```typescript
import Phaser from 'phaser';
import { ICardView, CardViewOptions } from './ICardView';
import { CardState, CardStateStyles } from './CardState';
import { CardSize, CardSizeType } from './CardConstants';
import { getCardTypeDisplayOption } from './CardTypeOptions';
import { EnhancementCard } from '../../../../domain/card/EnhancementCard';
import { TextStyles } from '../../config/TextStyles';

export class EnhancementCardView implements ICardView {
  public readonly container: Phaser.GameObjects.Container;
  public readonly card: EnhancementCard;

  private scene: Phaser.Scene;
  private size: CardSizeType;
  private state: CardState;
  private background!: Phaser.GameObjects.Graphics;
  private nameText!: Phaser.GameObjects.Text;
  private costText!: Phaser.GameObjects.Text;
  private effectText!: Phaser.GameObjects.Text;
  private onClick?: (card: EnhancementCard) => void;
  private onHover?: (card: EnhancementCard, isHovering: boolean) => void;

  constructor(scene: Phaser.Scene, options: CardViewOptions) {
    this.scene = scene;
    this.card = options.card as EnhancementCard;
    this.size = options.size ?? 'STANDARD';
    this.state = options.state ?? 'normal';
    this.onClick = options.onClick as any;
    this.onHover = options.onHover as any;

    const { width, height } = CardSize[this.size];

    // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
    this.container = scene.add.container(options.x, options.y);

    // èƒŒæ™¯
    this.background = scene.add.graphics();
    this.container.add(this.background);

    // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ã®è‰²ã‚’å–å¾—
    const typeOption = getCardTypeDisplayOption('enhancement');

    // èƒŒæ™¯æç”»
    this.drawBackground(typeOption.backgroundColor, typeOption.borderColor);

    // ç¨®åˆ¥ãƒ©ãƒ™ãƒ«
    const typeLabel = scene.add.text(
      -width/2 + 8, -height/2 + 8,
      'å¼·åŒ–',
      { ...TextStyles.bodySmall, fontSize: '10px', color: typeOption.labelColor }
    );
    this.container.add(typeLabel);

    // APã‚³ã‚¹ãƒˆ
    this.costText = scene.add.text(
      width/2 - 15, -height/2 + 8,
      `${this.card.apCost}`,
      TextStyles.cardCost
    ).setOrigin(1, 0);
    this.container.add(this.costText);

    // ã‚«ãƒ¼ãƒ‰å
    this.nameText = scene.add.text(
      0, -height/2 + 40,
      this.card.name,
      { ...TextStyles.cardName, wordWrap: { width: width - 16 } }
    ).setOrigin(0.5, 0);
    this.container.add(this.nameText);

    // åŠ¹æœã‚¢ã‚¤ã‚³ãƒ³ï¼ˆåŠ¹æœã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ï¼‰
    const effectIcon = this.getEffectIcon();
    const iconText = scene.add.text(
      0, -height/2 + 75,
      effectIcon,
      { fontSize: '32px' }
    ).setOrigin(0.5);
    this.container.add(iconText);

    // åŠ¹æœèª¬æ˜
    const effectDescription = this.getEffectDescription();
    this.effectText = scene.add.text(
      0, height/2 - 40,
      effectDescription,
      { ...TextStyles.cardDescription, align: 'center', wordWrap: { width: width - 16 } }
    ).setOrigin(0.5, 0);
    this.container.add(this.effectText);

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
    if (options.interactive !== false) {
      this.setInteractive(true);
    }

    // åˆæœŸçŠ¶æ…‹é©ç”¨
    this.applyState();
  }

  getState(): CardState {
    return this.state;
  }

  setState(state: CardState): void {
    this.state = state;
    this.applyState();
  }

  update(card: EnhancementCard): void {
    this.nameText.setText(card.name);
    this.costText.setText(`${card.apCost}`);
    this.effectText.setText(this.getEffectDescription());
  }

  setPosition(x: number, y: number): void {
    this.container.setPosition(x, y);
  }

  setScale(scale: number): void {
    this.container.setScale(scale);
  }

  setAlpha(alpha: number): void {
    this.container.setAlpha(alpha);
  }

  setInteractive(enabled: boolean): void {
    if (enabled) {
      const { width, height } = CardSize[this.size];
      const hitArea = new Phaser.Geom.Rectangle(-width/2, -height/2, width, height);

      this.container.setInteractive(hitArea, Phaser.Geom.Rectangle.Contains);
      this.container.on('pointerover', () => {
        if (this.state !== 'disabled' && this.state !== 'selected') {
          this.setState('hover');
          if (this.onHover) this.onHover(this.card, true);
        }
      });
      this.container.on('pointerout', () => {
        if (this.state === 'hover') {
          this.setState('normal');
          if (this.onHover) this.onHover(this.card, false);
        }
      });
      this.container.on('pointerdown', () => {
        if (this.state !== 'disabled' && this.onClick) {
          this.onClick(this.card);
        }
      });
    } else {
      this.container.disableInteractive();
    }
  }

  setSelected(selected: boolean): void {
    this.setState(selected ? 'selected' : 'normal');
  }

  destroy(): void {
    this.container.destroy();
  }

  private drawBackground(bgColor: number, borderColor: number): void {
    const { width, height } = CardSize[this.size];
    const style = CardStateStyles[this.state];

    this.background.clear();
    this.background.fillStyle(bgColor, style.alpha);
    this.background.fillRoundedRect(-width/2, -height/2, width, height, 8);
    this.background.lineStyle(style.borderWidth, borderColor);
    this.background.strokeRoundedRect(-width/2, -height/2, width, height, 8);
  }

  private applyState(): void {
    const style = CardStateStyles[this.state];
    const typeOption = getCardTypeDisplayOption('enhancement');

    this.drawBackground(typeOption.backgroundColor, typeOption.borderColor);
    this.container.setScale(style.scale);
    this.container.setAlpha(style.alpha);
  }

  private getEffectIcon(): string {
    // åŠ¹æœã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³
    const effectType = this.card.effect?.type;
    switch (effectType) {
      case 'draw': return 'ğŸƒ';
      case 'ap_restore': return 'âš¡';
      case 'quality_up': return 'â¬†ï¸';
      case 'cost_reduction': return 'ğŸ’°';
      default: return 'âœ¨';
    }
  }

  private getEffectDescription(): string {
    return this.card.description ?? 'åŠ¹æœãªã—';
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ ğŸŸ¡

**Given**: EnhancementCardãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
**When**: EnhancementCardViewã‚’ç”Ÿæˆã™ã‚‹
**Then**: ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: åŠ¹æœã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º ğŸŸ¡

**Given**: EnhancementCardViewãŒã‚ã‚‹
**When**: åŠ¹æœã‚¿ã‚¤ãƒ—ã‚’ç¢ºèªã™ã‚‹
**Then**: å¯¾å¿œã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0192` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- åŠ¹æœã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
- é•·ã„åŠ¹æœèª¬æ˜ã®çœç•¥è¡¨ç¤º
- çµµæ–‡å­—ã®äº’æ›æ€§ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
