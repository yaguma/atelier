# TASK-0180: ToastManagerè¨­è¨ˆãƒ»å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0180
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼‰ã‚’ç®¡ç†ã™ã‚‹ToastManagerã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0174
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0181

## å®Œäº†æ¡ä»¶

- [x] ToastManagerã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãŒç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [x] ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
- [x] è¤‡æ•°ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒã‚¹ã‚¿ãƒƒã‚¯è¡¨ç¤ºã•ã‚Œã‚‹
- [x] æˆåŠŸ/ã‚¨ãƒ©ãƒ¼/è­¦å‘Š/æƒ…å ±ã®ç¨®åˆ¥ãŒã‚ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ToastManagerå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒˆãƒ¼ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/managers/ToastManager.ts`

```typescript
import Phaser from 'phaser';
import { Colors, ColorStrings } from '../config/ColorPalette';
import { TextStyles } from '../config/TextStyles';

export type ToastType = 'success' | 'error' | 'warning' | 'info';

interface ToastOptions {
  message: string;
  type?: ToastType;
  duration?: number;
}

interface ActiveToast {
  container: Phaser.GameObjects.Container;
  timer: Phaser.Time.TimerEvent;
}

export class ToastManager {
  private static instance: ToastManager | null = null;
  private scene: Phaser.Scene | null = null;
  private activeToasts: ActiveToast[] = [];
  private readonly maxToasts = 5;
  private readonly toastHeight = 50;
  private readonly toastSpacing = 10;
  private readonly defaultDuration = 3000;

  private constructor() {}

  public static getInstance(): ToastManager {
    if (!ToastManager.instance) {
      ToastManager.instance = new ToastManager();
    }
    return ToastManager.instance;
  }

  public static resetInstance(): void {
    if (ToastManager.instance) {
      ToastManager.instance.clearAll();
      ToastManager.instance = null;
    }
  }

  public setScene(scene: Phaser.Scene): void {
    this.scene = scene;
  }

  /**
   * ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤º
   */
  public show(options: ToastOptions): void {
    if (!this.scene) {
      console.error('ToastManager: Scene not set');
      return;
    }

    const { message, type = 'info', duration = this.defaultDuration } = options;

    // æœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
    while (this.activeToasts.length >= this.maxToasts) {
      this.removeToast(this.activeToasts[0]);
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆä½œæˆ
    const toast = this.createToast(message, type);

    // ã‚¿ã‚¤ãƒãƒ¼è¨­å®š
    const timer = this.scene.time.delayedCall(duration, () => {
      this.removeToast({ container: toast, timer });
    });

    this.activeToasts.push({ container: toast, timer });

    // ä½ç½®ã‚’æ›´æ–°
    this.updatePositions();

    // å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    toast.setAlpha(0);
    toast.setY(toast.y - 20);
    this.scene.tweens.add({
      targets: toast,
      alpha: 1,
      y: toast.y + 20,
      duration: 200,
      ease: 'Power2',
    });
  }

  /**
   * æˆåŠŸãƒˆãƒ¼ã‚¹ãƒˆ
   */
  public success(message: string, duration?: number): void {
    this.show({ message, type: 'success', duration });
  }

  /**
   * ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆ
   */
  public error(message: string, duration?: number): void {
    this.show({ message, type: 'error', duration });
  }

  /**
   * è­¦å‘Šãƒˆãƒ¼ã‚¹ãƒˆ
   */
  public warning(message: string, duration?: number): void {
    this.show({ message, type: 'warning', duration });
  }

  /**
   * æƒ…å ±ãƒˆãƒ¼ã‚¹ãƒˆ
   */
  public info(message: string, duration?: number): void {
    this.show({ message, type: 'info', duration });
  }

  /**
   * ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
   */
  public clearAll(): void {
    this.activeToasts.forEach(toast => {
      toast.timer.destroy();
      toast.container.destroy();
    });
    this.activeToasts = [];
  }

  private createToast(message: string, type: ToastType): Phaser.GameObjects.Container {
    if (!this.scene) throw new Error('Scene not set');

    const width = 300;
    const height = this.toastHeight;
    const x = this.scene.cameras.main.centerX;
    const y = 60; // åˆæœŸYä½ç½®ï¼ˆå¾Œã§æ›´æ–°ï¼‰

    const container = this.scene.add.container(x, y);

    // èƒŒæ™¯è‰²
    const bgColor = this.getTypeColor(type);
    const background = this.scene.add.graphics();
    background.fillStyle(bgColor);
    background.fillRoundedRect(-width/2, -height/2, width, height, 8);
    container.add(background);

    // ã‚¢ã‚¤ã‚³ãƒ³
    const icon = this.scene.add.text(
      -width/2 + 15, 0,
      this.getTypeIcon(type),
      { fontSize: '20px' }
    ).setOrigin(0, 0.5);
    container.add(icon);

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const text = this.scene.add.text(
      -width/2 + 45, 0,
      message,
      { ...TextStyles.body, color: '#ffffff' }
    ).setOrigin(0, 0.5);
    container.add(text);

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    const closeBtn = this.scene.add.text(
      width/2 - 15, 0,
      'Ã—',
      { fontSize: '20px', color: '#ffffff' }
    ).setOrigin(0.5).setInteractive({ useHandCursor: true });
    closeBtn.on('pointerdown', () => {
      const toastData = this.activeToasts.find(t => t.container === container);
      if (toastData) {
        this.removeToast(toastData);
      }
    });
    container.add(closeBtn);

    // æ·±åº¦ã‚’è¨­å®š
    container.setDepth(2000);

    return container;
  }

  private removeToast(toast: ActiveToast): void {
    if (!this.scene) return;

    const index = this.activeToasts.indexOf(toast);
    if (index === -1) return;

    this.activeToasts.splice(index, 1);
    toast.timer.destroy();

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    this.scene.tweens.add({
      targets: toast.container,
      alpha: 0,
      y: toast.container.y - 20,
      duration: 200,
      onComplete: () => {
        toast.container.destroy();
        this.updatePositions();
      },
    });
  }

  private updatePositions(): void {
    this.activeToasts.forEach((toast, index) => {
      const targetY = 60 + index * (this.toastHeight + this.toastSpacing);
      if (this.scene) {
        this.scene.tweens.add({
          targets: toast.container,
          y: targetY,
          duration: 150,
        });
      }
    });
  }

  private getTypeColor(type: ToastType): number {
    switch (type) {
      case 'success': return Colors.success;
      case 'error': return Colors.danger;
      case 'warning': return Colors.warning;
      case 'info': return Colors.info;
    }
  }

  private getTypeIcon(type: ToastType): string {
    switch (type) {
      case 'success': return 'âœ“';
      case 'error': return 'âœ•';
      case 'warning': return 'âš ';
      case 'info': return 'â„¹';
    }
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º ğŸŸ¡

**Given**: ToastManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹
**When**: show()ã‚’å‘¼ã¶
**Then**: ãƒˆãƒ¼ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è‡ªå‹•æ¶ˆå» ğŸŸ¡

**Given**: ãƒˆãƒ¼ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: æŒ‡å®šæ™‚é–“ãŒçµŒéã™ã‚‹
**Then**: ãƒˆãƒ¼ã‚¹ãƒˆãŒæ¶ˆãˆã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: æœ€å¤§æ•°åˆ¶é™ ğŸŸ¡

**Given**: maxToastså€‹ã®ãƒˆãƒ¼ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: æ–°ã—ã„ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
**Then**: å¤ã„ãƒˆãƒ¼ã‚¹ãƒˆãŒå‰Šé™¤ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0180` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚·ãƒ¼ãƒ³é·ç§»æ™‚ã®ãƒˆãƒ¼ã‚¹ãƒˆçŠ¶æ…‹ç®¡ç†
- é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ˜ã‚Šè¿”ã—å‡¦ç†
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®çŠ¶æ…‹ç®¡ç†

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
