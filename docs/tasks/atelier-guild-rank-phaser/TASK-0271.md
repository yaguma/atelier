# TASK-0271: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«æœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0271
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”´ *Phaserå›ºæœ‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬**: TASK-0270

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

é »ç¹ã«ç”Ÿæˆãƒ»ç ´æ£„ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã€ç´ æã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç­‰ï¼‰ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’é©ç”¨ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0270 (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0274

## å®Œäº†æ¡ä»¶

- [x] ObjectPoolã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚«ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ—ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] ç´ æã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ—ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«ãƒ—ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ãŒç¢ºèªã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ObjectPoolå®Ÿè£… ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaseræœ€é©åŒ–*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/utils/ObjectPool.ts`

```typescript
import Phaser from 'phaser';

export interface PoolableObject extends Phaser.GameObjects.GameObject {
  reset(): void;
  setPooled(pooled: boolean): void;
  isPooled(): boolean;
}

export interface ObjectPoolConfig<T extends PoolableObject> {
  scene: Phaser.Scene;
  factory: () => T;
  initialSize?: number;
  maxSize?: number;
  autoExpand?: boolean;
}

/**
 * æ±ç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«
 */
export class ObjectPool<T extends PoolableObject> {
  private scene: Phaser.Scene;
  private factory: () => T;
  private pool: T[] = [];
  private active: Set<T> = new Set();
  private maxSize: number;
  private autoExpand: boolean;

  constructor(config: ObjectPoolConfig<T>) {
    this.scene = config.scene;
    this.factory = config.factory;
    this.maxSize = config.maxSize ?? 100;
    this.autoExpand = config.autoExpand ?? true;

    // åˆæœŸãƒ—ãƒ¼ãƒ«ä½œæˆ
    const initialSize = config.initialSize ?? 10;
    for (let i = 0; i < initialSize; i++) {
      this.createObject();
    }
  }

  private createObject(): T {
    const obj = this.factory();
    obj.setPooled(true);
    obj.setActive(false);
    obj.setVisible(false);
    this.pool.push(obj);
    return obj;
  }

  /**
   * ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
   */
  acquire(): T | null {
    let obj = this.pool.find(o => !this.active.has(o));

    if (!obj) {
      if (this.autoExpand && this.pool.length < this.maxSize) {
        obj = this.createObject();
      } else {
        console.warn('ObjectPool exhausted');
        return null;
      }
    }

    obj.setActive(true);
    obj.setVisible(true);
    obj.setPooled(false);
    this.active.add(obj);

    return obj;
  }

  /**
   * ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ—ãƒ¼ãƒ«ã«è¿”å´
   */
  release(obj: T): void {
    if (!this.active.has(obj)) {
      console.warn('Trying to release object not in active set');
      return;
    }

    obj.reset();
    obj.setActive(false);
    obj.setVisible(false);
    obj.setPooled(true);
    this.active.delete(obj);
  }

  /**
   * å…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´
   */
  releaseAll(): void {
    this.active.forEach(obj => {
      obj.reset();
      obj.setActive(false);
      obj.setVisible(false);
      obj.setPooled(true);
    });
    this.active.clear();
  }

  /**
   * ãƒ—ãƒ¼ãƒ«ã‚’ç ´æ£„
   */
  destroy(): void {
    this.pool.forEach(obj => obj.destroy());
    this.pool = [];
    this.active.clear();
  }

  /**
   * çµ±è¨ˆæƒ…å ±
   */
  getStats(): { total: number; active: number; available: number } {
    return {
      total: this.pool.length,
      active: this.active.size,
      available: this.pool.length - this.active.size,
    };
  }
}
```

### 2. PoolableCardViewå®Ÿè£… ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/cards/PoolableCardView.ts`

```typescript
import Phaser from 'phaser';
import { PoolableObject } from '../../utils/ObjectPool';
import { CardViewOptions } from './CardView';

/**
 * ãƒ—ãƒ¼ãƒ«å¯¾å¿œã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼
 */
export class PoolableCardView extends Phaser.GameObjects.Container implements PoolableObject {
  private _isPooled: boolean = false;
  private cardData: any = null;
  private background: Phaser.GameObjects.Graphics;
  private nameText: Phaser.GameObjects.Text;
  private descText: Phaser.GameObjects.Text;

  constructor(scene: Phaser.Scene, x: number = 0, y: number = 0) {
    super(scene, x, y);

    // åŸºæœ¬è¦ç´ ã‚’äº‹å‰ä½œæˆ
    this.background = scene.add.graphics();
    this.add(this.background);

    this.nameText = scene.add.text(0, -40, '', {
      fontSize: '14px',
      color: '#ffffff',
    }).setOrigin(0.5);
    this.add(this.nameText);

    this.descText = scene.add.text(0, 20, '', {
      fontSize: '10px',
      color: '#cccccc',
      wordWrap: { width: 80 },
    }).setOrigin(0.5);
    this.add(this.descText);

    this.setSize(100, 140);
    scene.add.existing(this);
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
   */
  setCardData(data: any): void {
    this.cardData = data;

    // èƒŒæ™¯æç”»
    this.background.clear();
    this.background.fillStyle(this.getCardColor(data.type), 1);
    this.background.fillRoundedRect(-50, -70, 100, 140, 8);
    this.background.lineStyle(2, 0xffffff, 0.5);
    this.background.strokeRoundedRect(-50, -70, 100, 140, 8);

    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    this.nameText.setText(data.name || '');
    this.descText.setText(data.description || '');
  }

  private getCardColor(type: string): number {
    switch (type) {
      case 'gathering': return 0x4a7c59;
      case 'recipe': return 0x7c4a5c;
      case 'enhancement': return 0x5c5a7c;
      default: return 0x555555;
    }
  }

  /**
   * ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ¼ãƒ«è¿”å´æ™‚ï¼‰
   */
  reset(): void {
    this.cardData = null;
    this.setPosition(0, 0);
    this.setScale(1);
    this.setAlpha(1);
    this.setAngle(0);

    this.background.clear();
    this.nameText.setText('');
    this.descText.setText('');

    this.removeInteractive();
    this.removeAllListeners();
  }

  setPooled(pooled: boolean): void {
    this._isPooled = pooled;
  }

  isPooled(): boolean {
    return this._isPooled;
  }

  getCardData(): any {
    return this.cardData;
  }
}
```

### 3. CardPoolManagerå®Ÿè£… ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ãƒ—ãƒ¼ãƒ«ç®¡ç†*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/managers/CardPoolManager.ts`

```typescript
import Phaser from 'phaser';
import { ObjectPool } from '../utils/ObjectPool';
import { PoolableCardView } from '../ui/cards/PoolableCardView';

/**
 * ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ç®¡ç†
 */
export class CardPoolManager {
  private pool: ObjectPool<PoolableCardView>;
  private scene: Phaser.Scene;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;

    this.pool = new ObjectPool<PoolableCardView>({
      scene,
      factory: () => new PoolableCardView(scene),
      initialSize: 20, // åˆæœŸ20æš
      maxSize: 50, // æœ€å¤§50æš
      autoExpand: true,
    });
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
   */
  acquireCard(cardData: any, x: number, y: number): PoolableCardView | null {
    const card = this.pool.acquire();

    if (card) {
      card.setPosition(x, y);
      card.setCardData(cardData);
    }

    return card;
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’è¿”å´
   */
  releaseCard(card: PoolableCardView): void {
    this.pool.release(card);
  }

  /**
   * è¤‡æ•°ã‚«ãƒ¼ãƒ‰ã‚’è¿”å´
   */
  releaseCards(cards: PoolableCardView[]): void {
    cards.forEach(card => this.pool.release(card));
  }

  /**
   * å…¨ã‚«ãƒ¼ãƒ‰ã‚’è¿”å´
   */
  releaseAll(): void {
    this.pool.releaseAll();
  }

  /**
   * çµ±è¨ˆå–å¾—
   */
  getStats(): { total: number; active: number; available: number } {
    return this.pool.getStats();
  }

  /**
   * ç ´æ£„
   */
  destroy(): void {
    this.pool.destroy();
  }
}
```

### 4. EffectPoolå®Ÿè£… ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«*

```typescript
// src/presentation/phaser/effects/PoolableEffect.ts

import Phaser from 'phaser';
import { PoolableObject } from '../utils/ObjectPool';

export class PoolableParticle extends Phaser.GameObjects.Particles.ParticleEmitter implements PoolableObject {
  private _isPooled: boolean = false;

  reset(): void {
    this.stop();
    this.setPosition(0, 0);
  }

  setPooled(pooled: boolean): void {
    this._isPooled = pooled;
  }

  isPooled(): boolean {
    return this._isPooled;
  }
}

export class EffectPoolManager {
  private sparklePool: ObjectPool<PoolableParticle>;

  constructor(scene: Phaser.Scene) {
    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãƒ—ãƒ¼ãƒ«
    // å®Ÿéš›ã®å®Ÿè£…ã¯Phaserãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¾å­˜
  }

  playSparkle(x: number, y: number): void {
    // ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã‚¨ãƒŸãƒƒã‚¿ãƒ¼ã‚’å–å¾—ã—ã¦å†ç”Ÿ
  }

  destroy(): void {
    this.sparklePool?.destroy();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ—ãƒ¼ãƒ«å–å¾—ãƒ»è¿”å´ ğŸ”´

**Given**: ObjectPoolãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: acquire â†’ release ã‚’å®Ÿè¡Œ
**Then**: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå†åˆ©ç”¨ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ—ãƒ¼ãƒ«æ‹¡å¼µ ğŸ”´

**Given**: åˆæœŸã‚µã‚¤ã‚º10ã®ãƒ—ãƒ¼ãƒ«
**When**: 15å€‹å–å¾—
**Then**: ãƒ—ãƒ¼ãƒ«ãŒè‡ªå‹•æ‹¡å¼µã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™ ğŸ”´

**Given**: maxSize=20ã®ãƒ—ãƒ¼ãƒ«
**When**: 21å€‹å–å¾—
**Then**: nullãŒè¿”ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0271` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| é …ç›® | æœ€é©åŒ–å‰ | ç›®æ¨™ |
|------|---------|------|
| ã‚«ãƒ¼ãƒ‰ç”Ÿæˆæ™‚é–“ | è¨ˆæ¸¬å€¤ | -50% |
| GCç™ºç”Ÿé »åº¦ | è¨ˆæ¸¬å€¤ | -30% |
| FPSå®‰å®šæ€§ | è¨ˆæ¸¬å€¤ | +10% |

---

## æ³¨æ„äº‹é …

- ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã®å®Œå…¨æ€§
- å¾ªç’°å‚ç…§ã®é˜²æ­¢
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 4é …ç›® (100%)

**å“è³ªè©•ä¾¡**: ä½å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ãƒ»Phaserå›ºæœ‰ï¼‰
