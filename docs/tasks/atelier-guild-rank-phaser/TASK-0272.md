# TASK-0272: ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚¢ãƒˆãƒ©ã‚¹æœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0272
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: DIRECT
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”´ *Phaserå›ºæœ‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬**: TASK-0270

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

è¤‡æ•°ã®å°ã•ãªãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’1ã¤ã®ã‚¢ãƒˆãƒ©ã‚¹ã«ã¾ã¨ã‚ã€æç”»ãƒãƒƒãƒã‚’æ¸›ã‚‰ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0270 (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0275

## å®Œäº†æ¡ä»¶

- [x] ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚¢ãƒˆãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [x] ã‚«ãƒ¼ãƒ‰ç”¨ã‚¢ãƒˆãƒ©ã‚¹ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] ç´ æç”¨ã‚¢ãƒˆãƒ©ã‚¹ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] UIç”¨ã‚¢ãƒˆãƒ©ã‚¹ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [x] æç”»ãƒãƒƒãƒæ•°ãŒå‰Šæ¸›ã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ã‚¢ãƒˆãƒ©ã‚¹æ§‹æˆè¨­è¨ˆ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaseræœ€é©åŒ–*

```
assets/
â”œâ”€â”€ atlas/
â”‚   â”œâ”€â”€ cards.json       # ã‚«ãƒ¼ãƒ‰ã‚¢ãƒˆãƒ©ã‚¹å®šç¾©
â”‚   â”œâ”€â”€ cards.png        # ã‚«ãƒ¼ãƒ‰ã‚¢ãƒˆãƒ©ã‚¹ç”»åƒ
â”‚   â”œâ”€â”€ materials.json   # ç´ æã‚¢ãƒˆãƒ©ã‚¹å®šç¾©
â”‚   â”œâ”€â”€ materials.png    # ç´ æã‚¢ãƒˆãƒ©ã‚¹ç”»åƒ
â”‚   â”œâ”€â”€ ui.json          # UIã‚¢ãƒˆãƒ©ã‚¹å®šç¾©
â”‚   â””â”€â”€ ui.png           # UIã‚¢ãƒˆãƒ©ã‚¹ç”»åƒ
```

### 2. ã‚¢ãƒˆãƒ©ã‚¹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/generate-atlas.ts`

```typescript
/**
 * ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚¢ãƒˆãƒ©ã‚¹ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ä½¿ç”¨: npx ts-node scripts/generate-atlas.ts
 * ä¾å­˜: free-tex-packer-core
 */
import { packAsync } from 'free-tex-packer-core';
import * as fs from 'fs';
import * as path from 'path';

interface AtlasConfig {
  name: string;
  sourceDir: string;
  outputDir: string;
  maxWidth: number;
  maxHeight: number;
  padding: number;
}

const atlasConfigs: AtlasConfig[] = [
  {
    name: 'cards',
    sourceDir: 'assets/images/cards',
    outputDir: 'assets/atlas',
    maxWidth: 2048,
    maxHeight: 2048,
    padding: 2,
  },
  {
    name: 'materials',
    sourceDir: 'assets/images/materials',
    outputDir: 'assets/atlas',
    maxWidth: 1024,
    maxHeight: 1024,
    padding: 2,
  },
  {
    name: 'ui',
    sourceDir: 'assets/images/ui',
    outputDir: 'assets/atlas',
    maxWidth: 2048,
    maxHeight: 2048,
    padding: 2,
  },
];

async function generateAtlas(config: AtlasConfig): Promise<void> {
  const images: { path: string; contents: Buffer }[] = [];

  // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åé›†
  const files = fs.readdirSync(config.sourceDir);

  for (const file of files) {
    if (file.match(/\.(png|jpg|jpeg)$/i)) {
      const filePath = path.join(config.sourceDir, file);
      images.push({
        path: file,
        contents: fs.readFileSync(filePath),
      });
    }
  }

  console.log(`Packing ${images.length} images for ${config.name}...`);

  // ã‚¢ãƒˆãƒ©ã‚¹ç”Ÿæˆ
  const result = await packAsync(images, {
    textureName: config.name,
    width: config.maxWidth,
    height: config.maxHeight,
    padding: config.padding,
    allowRotation: false,
    detectIdentical: true,
    allowTrim: true,
    exporter: 'Phaser3',
    removeFileExtension: true,
  });

  // å‡ºåŠ›
  for (const output of result) {
    const outputPath = path.join(config.outputDir, output.name);
    fs.writeFileSync(outputPath, output.buffer);
    console.log(`Generated: ${outputPath}`);
  }
}

async function main(): Promise<void> {
  console.log('=== Texture Atlas Generation ===');

  for (const config of atlasConfigs) {
    // å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    if (!fs.existsSync(config.outputDir)) {
      fs.mkdirSync(config.outputDir, { recursive: true });
    }

    // ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
    if (!fs.existsSync(config.sourceDir)) {
      console.warn(`Warning: Source directory not found: ${config.sourceDir}`);
      continue;
    }

    await generateAtlas(config);
  }

  console.log('=== Complete ===');
}

main().catch(console.error);
```

### 3. ã‚¢ãƒˆãƒ©ã‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaserå›ºæœ‰*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/loaders/AtlasLoader.ts`

```typescript
import Phaser from 'phaser';

export interface AtlasDefinition {
  key: string;
  textureURL: string;
  atlasURL: string;
}

/**
 * ã‚¢ãƒˆãƒ©ã‚¹å®šç¾©
 */
export const ATLAS_DEFINITIONS: AtlasDefinition[] = [
  {
    key: 'cards-atlas',
    textureURL: 'assets/atlas/cards.png',
    atlasURL: 'assets/atlas/cards.json',
  },
  {
    key: 'materials-atlas',
    textureURL: 'assets/atlas/materials.png',
    atlasURL: 'assets/atlas/materials.json',
  },
  {
    key: 'ui-atlas',
    textureURL: 'assets/atlas/ui.png',
    atlasURL: 'assets/atlas/ui.json',
  },
];

/**
 * ã‚¢ãƒˆãƒ©ã‚¹ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
export class AtlasLoader {
  private scene: Phaser.Scene;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
  }

  /**
   * å…¨ã‚¢ãƒˆãƒ©ã‚¹ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
   */
  preloadAllAtlases(): void {
    for (const atlas of ATLAS_DEFINITIONS) {
      this.scene.load.atlas(atlas.key, atlas.textureURL, atlas.atlasURL);
    }
  }

  /**
   * ç‰¹å®šã®ã‚¢ãƒˆãƒ©ã‚¹ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
   */
  preloadAtlas(key: string): void {
    const atlas = ATLAS_DEFINITIONS.find(a => a.key === key);

    if (!atlas) {
      console.warn(`Atlas not found: ${key}`);
      return;
    }

    this.scene.load.atlas(atlas.key, atlas.textureURL, atlas.atlasURL);
  }

  /**
   * ã‚¢ãƒˆãƒ©ã‚¹ã‹ã‚‰ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
   */
  createSprite(
    atlasKey: string,
    frameName: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Sprite {
    return this.scene.add.sprite(x, y, atlasKey, frameName);
  }

  /**
   * ã‚¢ãƒˆãƒ©ã‚¹ã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆ
   */
  createImage(
    atlasKey: string,
    frameName: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Image {
    return this.scene.add.image(x, y, atlasKey, frameName);
  }

  /**
   * ãƒ•ãƒ¬ãƒ¼ãƒ åä¸€è¦§ã‚’å–å¾—
   */
  getFrameNames(atlasKey: string): string[] {
    const texture = this.scene.textures.get(atlasKey);

    if (!texture) {
      console.warn(`Atlas texture not found: ${atlasKey}`);
      return [];
    }

    return texture.getFrameNames();
  }

  /**
   * ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   */
  hasFrame(atlasKey: string, frameName: string): boolean {
    const texture = this.scene.textures.get(atlasKey);

    if (!texture) {
      return false;
    }

    return texture.has(frameName);
  }
}
```

### 4. ã‚¢ãƒˆãƒ©ã‚¹å¯¾å¿œã‚¹ãƒ—ãƒ©ã‚¤ãƒˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaserå›ºæœ‰*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/factories/AtlasSpriteFactory.ts`

```typescript
import Phaser from 'phaser';
import { AtlasLoader } from '../loaders/AtlasLoader';

/**
 * ã‚¢ãƒˆãƒ©ã‚¹å¯¾å¿œã‚¹ãƒ—ãƒ©ã‚¤ãƒˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
 */
export class AtlasSpriteFactory {
  private scene: Phaser.Scene;
  private atlasLoader: AtlasLoader;

  // ãƒ•ãƒ¬ãƒ¼ãƒ åãƒãƒƒãƒ”ãƒ³ã‚°
  private static readonly CARD_FRAMES: Record<string, string> = {
    'gathering': 'card-gathering',
    'recipe': 'card-recipe',
    'enhancement': 'card-enhancement',
  };

  private static readonly MATERIAL_FRAMES: Record<string, string> = {
    'herb': 'mat-herb',
    'ore': 'mat-ore',
    'liquid': 'mat-liquid',
    'crystal': 'mat-crystal',
    'monster': 'mat-monster',
  };

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.atlasLoader = new AtlasLoader(scene);
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
   */
  createCardSprite(
    cardType: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Sprite | null {
    const frameName = AtlasSpriteFactory.CARD_FRAMES[cardType];

    if (!frameName) {
      console.warn(`Unknown card type: ${cardType}`);
      return null;
    }

    if (!this.atlasLoader.hasFrame('cards-atlas', frameName)) {
      console.warn(`Card frame not found: ${frameName}`);
      return null;
    }

    return this.atlasLoader.createSprite('cards-atlas', frameName, x, y);
  }

  /**
   * ç´ æã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
   */
  createMaterialSprite(
    materialCategory: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Sprite | null {
    const frameName = AtlasSpriteFactory.MATERIAL_FRAMES[materialCategory];

    if (!frameName) {
      console.warn(`Unknown material category: ${materialCategory}`);
      return null;
    }

    if (!this.atlasLoader.hasFrame('materials-atlas', frameName)) {
      console.warn(`Material frame not found: ${frameName}`);
      return null;
    }

    return this.atlasLoader.createSprite('materials-atlas', frameName, x, y);
  }

  /**
   * UIã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚’ä½œæˆ
   */
  createUISprite(
    frameName: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Sprite | null {
    if (!this.atlasLoader.hasFrame('ui-atlas', frameName)) {
      console.warn(`UI frame not found: ${frameName}`);
      return null;
    }

    return this.atlasLoader.createSprite('ui-atlas', frameName, x, y);
  }

  /**
   * ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
   */
  createIcon(
    iconName: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Image {
    // UIã‚¢ãƒˆãƒ©ã‚¹ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    if (this.atlasLoader.hasFrame('ui-atlas', `icon-${iconName}`)) {
      return this.atlasLoader.createImage('ui-atlas', `icon-${iconName}`, x, y);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
    const placeholder = this.scene.add.graphics();
    placeholder.fillStyle(0x666666);
    placeholder.fillCircle(x, y, 16);

    // ä»£ã‚ã‚Šã«ç©ºã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿”ã™
    const image = this.scene.add.image(x, y, '__DEFAULT');
    image.setVisible(false);

    return image;
  }
}
```

### 5. BootSceneã‚¢ãƒˆãƒ©ã‚¹èª­ã¿è¾¼ã¿æ›´æ–° ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *æ—¢å­˜ã‚³ãƒ¼ãƒ‰ä¿®æ­£*

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/BootScene.ts`

```typescript
// BootScene.preload() ã«è¿½åŠ 

import { AtlasLoader, ATLAS_DEFINITIONS } from '../loaders/AtlasLoader';

// preload() å†…
preload(): void {
  // ... æ—¢å­˜ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å‡¦ç†

  // ã‚¢ãƒˆãƒ©ã‚¹èª­ã¿è¾¼ã¿
  const atlasLoader = new AtlasLoader(this);
  atlasLoader.preloadAllAtlases();

  // é€²æ—æ›´æ–°ï¼ˆã‚¢ãƒˆãƒ©ã‚¹åˆ†ã‚’è¿½åŠ ï¼‰
  this.load.on('progress', (value: number) => {
    this.updateProgressBar(value);
  });
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

| é …ç›® | æœ€é©åŒ–å‰ | ç›®æ¨™ |
|------|---------|------|
| æç”»ãƒãƒƒãƒæ•° | è¨ˆæ¸¬å€¤ | -50% |
| ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚¹ãƒ¯ãƒƒãƒ— | è¨ˆæ¸¬å€¤ | -80% |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | è¨ˆæ¸¬å€¤ | Â±10% |

---

## å®Ÿè£…æ‰‹é †

1. `/direct-setup` - ã‚¢ãƒˆãƒ©ã‚¹ç”Ÿæˆãƒ»ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
2. `/direct-verify` - å‹•ä½œç¢ºèªãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

---

## ç¢ºèªé …ç›®

- [x] ã‚¢ãƒˆãƒ©ã‚¹ç”»åƒãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹
- [x] ãƒ•ãƒ¬ãƒ¼ãƒ åã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [x] æç”»ãƒãƒƒãƒæ•°ãŒå‰Šæ¸›ã•ã‚Œã‚‹
- [x] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤§å¹…ã«å¢—åŠ ã—ãªã„

---

## æ³¨æ„äº‹é …

- ã‚¢ãƒˆãƒ©ã‚¹ã‚µã‚¤ã‚ºã¯2048x2048ä»¥ä¸‹ã‚’æ¨å¥¨
- ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ãƒ–ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é˜²æ­¢
- åœ§ç¸®è¨­å®šã®æœ€é©åŒ–

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 5é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 5é …ç›® (100%)

**å“è³ªè©•ä¾¡**: ä½å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ãƒ»Phaserå›ºæœ‰ï¼‰
