# TASK-0188: TitleSceneテスト

**タスクID**: TASK-0188
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 2 - 基本シーン・共通UI実装
**信頼性レベル**: 🔵 *設計書に明確な記載あり*

## 関連文書

- **概要**: [overview.md](./overview.md)
- **UI設計**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## タスク概要

TitleSceneの統合テストを実施し、全機能が正しく動作することを確認する。

## 依存タスク

- **前提タスク**: TASK-0187
- **後続タスク**: TASK-0211, TASK-0260

## 完了条件

- [ ] TitleSceneの全要素が表示されるテストが通る
- [ ] 新規ゲームボタンの動作テストが通る
- [ ] コンティニューボタンの動作テストが通る
- [ ] シーン遷移テストが通る
- [ ] テストカバレッジ80%以上

---

## 実装詳細

### 1. TitleSceneテスト 🔵

**信頼性**: 🔵 *前タスクの実装を検証*

**テストファイル**: `tests/integration/phaser/TitleScene.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { EventBus } from '../../../src/presentation/phaser/events/EventBus';
import { SceneManager } from '../../../src/presentation/phaser/managers/SceneManager';
import { UIActionEvents } from '../../../src/presentation/phaser/events/EventTypes';
import { SceneKeys } from '../../../src/presentation/phaser/config/SceneKeys';

describe('TitleScene', () => {
  beforeEach(() => {
    EventBus.resetInstance();
    SceneManager.resetInstance();
    // LocalStorageモック
    vi.spyOn(Storage.prototype, 'getItem');
    vi.spyOn(Storage.prototype, 'setItem');
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  describe('表示要素', () => {
    it('タイトルテキストが表示される', () => {
      // TitleSceneのcreate後にタイトルテキストが存在することを確認
      // 実際のPhaserテストはヘッドレス環境で実行
    });

    it('サブタイトルが表示される', () => {
      // サブタイトルの存在確認
    });

    it('新規ゲームボタンが表示される', () => {
      // ボタンの存在確認
    });

    it('コンティニューボタンが表示される', () => {
      // ボタンの存在確認
    });
  });

  describe('新規ゲームボタン', () => {
    it('クリックでNEW_GAME_CLICKEDイベントが発行される', () => {
      const eventBus = EventBus.getInstance();
      const callback = vi.fn();
      eventBus.onVoid(UIActionEvents.NEW_GAME_CLICKED, callback);

      // ボタンクリックをシミュレート
      eventBus.emitVoid(UIActionEvents.NEW_GAME_CLICKED);

      expect(callback).toHaveBeenCalledTimes(1);
    });

    it('クリック後にMainSceneへの遷移が開始される', () => {
      // SceneManagerのgoToが呼ばれることを確認
    });
  });

  describe('コンティニューボタン', () => {
    it('セーブデータがない場合、ボタンが無効化される', () => {
      vi.mocked(localStorage.getItem).mockReturnValue(null);

      // TitleSceneを作成
      // continueButtonがdisabledであることを確認
    });

    it('セーブデータがある場合、ボタンが有効化される', () => {
      vi.mocked(localStorage.getItem).mockReturnValue('{"day":5}');

      // TitleSceneを作成
      // continueButtonがenabledであることを確認
    });

    it('有効時にクリックでCONTINUE_CLICKEDイベントが発行される', () => {
      vi.mocked(localStorage.getItem).mockReturnValue('{"day":5}');

      const eventBus = EventBus.getInstance();
      const callback = vi.fn();
      eventBus.onVoid(UIActionEvents.CONTINUE_CLICKED, callback);

      // ボタンクリックをシミュレート
      eventBus.emitVoid(UIActionEvents.CONTINUE_CLICKED);

      expect(callback).toHaveBeenCalledTimes(1);
    });
  });

  describe('シーン遷移', () => {
    it('新規ゲーム選択でMainSceneに遷移データisNewGame:trueで遷移', () => {
      // SceneManager.goToの引数を確認
    });

    it('コンティニュー選択でMainSceneに遷移データloadSave:trueで遷移', () => {
      // SceneManager.goToの引数を確認
    });
  });

  describe('BGM/SE', () => {
    it('シーン開始時にBGMが再生される', () => {
      // sound.playが呼ばれることを確認
    });

    it('ボタンクリック時にSEが再生される', () => {
      // sound.playが呼ばれることを確認
    });

    it('シーン遷移時にBGMが停止される', () => {
      // sound.stopAllが呼ばれることを確認
    });
  });
});
```

### 2. テストカバレッジ目標 🔵

**信頼性**: 🔵 *標準的なカバレッジ目標*

| 項目 | 目標 |
|------|------|
| 行カバレッジ | 80%以上 |
| 分岐カバレッジ | 75%以上 |
| 関数カバレッジ | 90%以上 |

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0188` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- Phaserシーンのモック方法を確認
- 非同期処理のテスト方法
- LocalStorageのモック

---

## 信頼性レベルサマリー

- **総項目数**: 2項目
- 🔵 **青信号**: 2項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
