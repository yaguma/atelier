# TASK-0207: SidebarUIã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0207
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªï¼ˆæ‰€æŒå“ï¼‰è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚ç´ æã¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€è¦§è¡¨ç¤ºã—ã€é¸æŠãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0206
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0208

## å®Œäº†æ¡ä»¶

- [ ] ç´ æãƒ»ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã§ãã‚‹
- [ ] é¸æŠçŠ¶æ…‹ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹
- [ ] ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. InventoryGridItemå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ *

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/sidebar/InventoryGridItem.ts`

```typescript
import Phaser from 'phaser';
import { InventoryItem } from '../../../../domain/item/InventoryItem';
import { Material } from '../../../../domain/material/Material';
import { Item } from '../../../../domain/item/Item';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';
import { MaterialQualityColors } from '../material/MaterialConstants';

export interface InventoryGridItemOptions {
  item: InventoryItem;
  x: number;
  y: number;
  size?: number;
  onClick?: (item: InventoryItem) => void;
  onHover?: (item: InventoryItem, isHovering: boolean) => void;
}

export class InventoryGridItem {
  public readonly container: Phaser.GameObjects.Container;
  public readonly item: InventoryItem;

  private scene: Phaser.Scene;
  private size: number;
  private selected: boolean = false;

  private background!: Phaser.GameObjects.Graphics;
  private iconDisplay!: Phaser.GameObjects.Text | Phaser.GameObjects.Sprite;
  private countBadge!: Phaser.GameObjects.Container;
  private qualityIndicator?: Phaser.GameObjects.Graphics;

  private onClick?: (item: InventoryItem) => void;
  private onHover?: (item: InventoryItem, isHovering: boolean) => void;

  constructor(scene: Phaser.Scene, options: InventoryGridItemOptions) {
    this.scene = scene;
    this.item = options.item;
    this.size = options.size ?? 56;
    this.onClick = options.onClick;
    this.onHover = options.onHover;

    this.container = scene.add.container(options.x, options.y);
    this.create();
  }

  private create(): void {
    const { size } = this;

    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.drawBackground(false);
    this.container.add(this.background);

    // ã‚¢ã‚¤ã‚³ãƒ³
    this.createIcon();

    // å€‹æ•°ãƒãƒƒã‚¸
    this.createCountBadge();

    // å“è³ªã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆç´ æã®å ´åˆï¼‰
    if (this.item.type === 'material') {
      this.createQualityIndicator();
    }

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
    this.container.setInteractive(
      new Phaser.Geom.Rectangle(-size / 2, -size / 2, size, size),
      Phaser.Geom.Rectangle.Contains
    );

    this.container.on('pointerover', () => {
      this.drawBackground(true);
      if (this.onHover) this.onHover(this.item, true);
    });

    this.container.on('pointerout', () => {
      this.drawBackground(this.selected);
      if (this.onHover) this.onHover(this.item, false);
    });

    this.container.on('pointerdown', () => {
      if (this.onClick) this.onClick(this.item);
    });
  }

  private drawBackground(highlight: boolean): void {
    const { size } = this;
    const bgColor = this.selected
      ? Colors.accent
      : highlight
        ? 0x4a4a6a
        : 0x2a2a4a;

    this.background.clear();
    this.background.fillStyle(bgColor, 0.9);
    this.background.fillRoundedRect(-size / 2, -size / 2, size, size, 6);

    if (this.selected || highlight) {
      this.background.lineStyle(2, this.selected ? Colors.accent : 0x6a6a8a);
      this.background.strokeRoundedRect(-size / 2, -size / 2, size, size, 6);
    }
  }

  private createIcon(): void {
    const emoji = this.getItemEmoji();
    this.iconDisplay = this.scene.add.text(0, -5, emoji, {
      fontSize: '28px',
    }).setOrigin(0.5);
    this.container.add(this.iconDisplay);
  }

  private createCountBadge(): void {
    const { size, item } = this;

    if (item.count <= 1) return;

    this.countBadge = this.scene.add.container(size / 2 - 8, size / 2 - 8);

    const badgeBg = this.scene.add.graphics();
    badgeBg.fillStyle(0x333333, 0.9);
    badgeBg.fillCircle(0, 0, 12);
    this.countBadge.add(badgeBg);

    const countText = this.scene.add.text(0, 0, `${item.count}`, {
      fontSize: '10px',
      color: '#ffffff',
    }).setOrigin(0.5);
    this.countBadge.add(countText);

    this.container.add(this.countBadge);
  }

  private createQualityIndicator(): void {
    const { size, item } = this;
    const material = item.data as Material;

    if (!material.quality) return;

    const qualityColor = MaterialQualityColors[material.quality] ?? 0x808080;

    this.qualityIndicator = this.scene.add.graphics();
    this.qualityIndicator.fillStyle(qualityColor, 1);
    this.qualityIndicator.fillCircle(-size / 2 + 8, -size / 2 + 8, 5);
    this.container.add(this.qualityIndicator);
  }

  private getItemEmoji(): string {
    switch (this.item.type) {
      case 'material':
        const material = this.item.data as Material;
        return this.getMaterialEmoji(material.category);
      case 'item':
        const item = this.item.data as Item;
        return this.getItemTypeEmoji(item.category);
      default:
        return 'ğŸ“¦';
    }
  }

  private getMaterialEmoji(category: string): string {
    switch (category) {
      case 'plant': return 'ğŸŒ¿';
      case 'mineral': return 'ğŸ’';
      case 'liquid': return 'ğŸ’§';
      case 'powder': return 'âœ¨';
      case 'monster': return 'ğŸ¦´';
      default: return 'ğŸ“¦';
    }
  }

  private getItemTypeEmoji(category: string): string {
    switch (category) {
      case 'potion': return 'ğŸ§ª';
      case 'bomb': return 'ğŸ’£';
      case 'accessory': return 'ğŸ’';
      case 'food': return 'ğŸ';
      default: return 'ğŸ“¦';
    }
  }

  setSelected(selected: boolean): void {
    this.selected = selected;
    this.drawBackground(false);
  }

  updateCount(count: number): void {
    if (this.countBadge) {
      const countText = this.countBadge.getAt(1) as Phaser.GameObjects.Text;
      countText.setText(`${count}`);
      this.countBadge.setVisible(count > 1);
    }
  }

  destroy(): void {
    this.container.destroy();
  }
}
```

### 2. SidebarUIã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *TASK-0205ã®æ‹¡å¼µ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/sidebar/SidebarUI.ts` (è¿½åŠ )

```typescript
// SidebarUIã‚¯ãƒ©ã‚¹ã«è¿½åŠ 

private inventoryItems: InventoryGridItem[] = [];
private selectedItemId: string | null = null;
private inventoryFilter: string = 'all';

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–
private filterTabs!: Phaser.GameObjects.Container;

private createInventoryContent(): void {
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–
  this.filterTabs = this.scene.add.container(0, 0);
  this.inventoryContainer.add(this.filterTabs);

  const filters = [
    { label: 'å…¨ã¦', value: 'all' },
    { label: 'ç´ æ', value: 'material' },
    { label: 'ã‚¢ã‚¤ãƒ†ãƒ ', value: 'item' },
  ];

  filters.forEach((filter, index) => {
    const tab = this.createFilterTab(filter.label, filter.value, index * 80);
    this.filterTabs.add(tab);
  });

  // ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ
  this.inventoryGridContainer = this.scene.add.container(0, 40);
  this.inventoryContainer.add(this.inventoryGridContainer);
}

private createFilterTab(label: string, value: string, x: number): Phaser.GameObjects.Container {
  const tab = this.scene.add.container(x, 0);

  const bg = this.scene.add.graphics();
  const isActive = this.inventoryFilter === value;
  bg.fillStyle(isActive ? 0x4a4a8a : 0x2a2a4a, 1);
  bg.fillRoundedRect(0, 0, 75, 30, 4);
  tab.add(bg);

  const text = this.scene.add.text(37, 15, label, {
    ...TextStyles.bodySmall,
    fontSize: '11px',
  }).setOrigin(0.5);
  tab.add(text);

  tab.setInteractive(
    new Phaser.Geom.Rectangle(0, 0, 75, 30),
    Phaser.Geom.Rectangle.Contains
  );
  tab.on('pointerdown', () => {
    this.setInventoryFilter(value);
  });

  tab.setData('bg', bg);
  tab.setData('value', value);

  return tab;
}

setInventoryFilter(filter: string): void {
  this.inventoryFilter = filter;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ–ã®æ›´æ–°
  this.filterTabs.each((tab: Phaser.GameObjects.Container) => {
    const bg = tab.getData('bg') as Phaser.GameObjects.Graphics;
    const value = tab.getData('value') as string;
    const isActive = value === filter;

    bg.clear();
    bg.fillStyle(isActive ? 0x4a4a8a : 0x2a2a4a, 1);
    bg.fillRoundedRect(0, 0, 75, 30, 4);
  });

  // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
  this.renderInventoryGrid();
}

setInventory(items: InventoryItem[]): void {
  this.inventory = items;
  this.renderInventoryGrid();
}

private renderInventoryGrid(): void {
  // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
  this.inventoryItems.forEach(item => item.destroy());
  this.inventoryItems = [];

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  const filteredItems = this.inventoryFilter === 'all'
    ? this.inventory
    : this.inventory.filter(item => item.type === this.inventoryFilter);

  // ã‚°ãƒªãƒƒãƒ‰é…ç½®
  const columns = 4;
  const itemSize = 56;
  const spacing = 8;

  filteredItems.forEach((inventoryItem, index) => {
    const row = Math.floor(index / columns);
    const col = index % columns;

    const gridItem = new InventoryGridItem(this.scene, {
      item: inventoryItem,
      x: col * (itemSize + spacing) + itemSize / 2,
      y: row * (itemSize + spacing) + itemSize / 2,
      size: itemSize,
      onClick: (item) => this.handleItemClick(item),
      onHover: (item, isHovering) => this.handleItemHover(item, isHovering),
    });

    this.inventoryGridContainer.add(gridItem.container);
    this.inventoryItems.push(gridItem);
  });

  // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
  if (this.selectedItemId) {
    this.highlightItem(this.selectedItemId);
  }
}

private handleItemClick(item: InventoryItem): void {
  this.selectedItemId = item.id;
  this.inventoryItems.forEach(gridItem => {
    gridItem.setSelected(gridItem.item.id === item.id);
  });

  if (this.onItemSelect) {
    this.onItemSelect(item);
  }
}

private handleItemHover(item: InventoryItem, isHovering: boolean): void {
  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆåˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨é€£æºï¼‰
}

highlightItem(itemId: string): void {
  this.selectedItemId = itemId;
  this.inventoryItems.forEach(gridItem => {
    gridItem.setSelected(gridItem.item.id === itemId);
  });
}

clearItemHighlight(): void {
  this.selectedItemId = null;
  this.inventoryItems.forEach(gridItem => {
    gridItem.setSelected(false);
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º ğŸŸ¡

**Given**: ç´ æ5å€‹ã€ã‚¢ã‚¤ãƒ†ãƒ 3å€‹ãŒã‚ã‚‹
**When**: setInventoryã‚’å‘¼ã¶
**Then**: 8å€‹ã®ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ ğŸŸ¡

**Given**: ç´ æ5å€‹ã€ã‚¢ã‚¤ãƒ†ãƒ 3å€‹ãŒã‚ã‚‹
**When**: setInventoryFilter('material')ã‚’å‘¼ã¶
**Then**: 5å€‹ã®ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ ğŸŸ¡

**Given**: ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
**Then**: ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0207` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è¨ˆç®—
- ã‚¢ã‚¤ãƒ†ãƒ ãŒå¤šã„å ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã®é¸æŠçŠ¶æ…‹

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
