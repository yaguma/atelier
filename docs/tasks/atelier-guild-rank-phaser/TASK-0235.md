# TASK-0235: MainSceneåŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0235
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

MainSceneã®åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚ãƒ˜ãƒƒãƒ€ãƒ¼ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã€ãƒ•ãƒƒã‚¿ãƒ¼ã®é…ç½®ã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0201, TASK-0205, TASK-0209
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0236

## å®Œäº†æ¡ä»¶

- [ ] MainSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ˜ãƒƒãƒ€ãƒ¼UIãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚µã‚¤ãƒ‰ãƒãƒ¼UIãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠè¡¨ç¤ºé ˜åŸŸï¼‰ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼‰ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. MainSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIè¨­è¨ˆæ›¸*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/MainSceneConstants.ts`

```typescript
export const MainSceneLayout = {
  // ç”»é¢ã‚µã‚¤ã‚ºï¼ˆè¨­å®šã‹ã‚‰å–å¾—ã™ã¹ãã ãŒå›ºå®šå€¤ã§å®šç¾©ï¼‰
  SCREEN_WIDTH: 1024,
  SCREEN_HEIGHT: 768,

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢
  HEADER: {
    X: 0,
    Y: 0,
    WIDTH: 1024,
    HEIGHT: 60,
  },

  // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰
  SIDEBAR: {
    X: 824,
    Y: 60,
    WIDTH: 200,
    HEIGHT: 658, // 768 - 60 (header) - 50 (footer)
  },

  // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠè¡¨ç¤ºï¼‰
  MAIN_AREA: {
    X: 0,
    Y: 60,
    WIDTH: 824,
    HEIGHT: 658,
  },

  // ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼‰
  FOOTER: {
    X: 0,
    Y: 718,
    WIDTH: 824,
    HEIGHT: 50,
  },

  // ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠé…ç½®
  PHASE_CONTAINER: {
    X: 12,
    Y: 70,
    WIDTH: 800,
    HEIGHT: 500,
  },
} as const;
```

### 2. MainSceneåŸºæœ¬æ§‹é€  ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚·ãƒ¼ãƒ³è¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/MainScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { MainSceneLayout } from './MainSceneConstants';
import { SceneKeys } from '../config/SceneKeys';
import { HeaderUI } from '../ui/common/HeaderUI';
import { SidebarUI } from '../ui/common/SidebarUI';
import { PhaseIndicator } from '../ui/common/PhaseIndicator';
import { EventBus } from '../core/EventBus';
import { Colors } from '../config/ColorPalette';

export interface MainSceneData extends SceneInitData {
  playerData?: any;
  gameState?: any;
}

export class MainScene extends BaseGameScene {
  // UI Components
  private headerUI!: HeaderUI;
  private sidebarUI!: SidebarUI;
  private phaseIndicator!: PhaseIndicator;

  // ã‚¨ãƒªã‚¢èƒŒæ™¯
  private mainAreaBg!: Phaser.GameObjects.Graphics;
  private sidebarBg!: Phaser.GameObjects.Graphics;

  // EventBus
  private eventBus!: EventBus;

  // ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º
  private currentPhase: string = 'quest-accept';

  constructor() {
    super(SceneKeys.MAIN);
  }

  protected onInit(data?: MainSceneData): void {
    this.eventBus = new EventBus();
  }

  protected onPreload(): void {
    // MainSceneå›ºæœ‰ã®ã‚¢ã‚»ãƒƒãƒˆãƒ­ãƒ¼ãƒ‰ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  }

  protected onCreate(data?: MainSceneData): void {
    this.createBackground();
    this.createAreas();
    this.createHeaderUI();
    this.createSidebarUI();
    this.createPhaseIndicator();

    // åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
    if (data?.playerData) {
      this.setPlayerData(data.playerData);
    }
    if (data?.gameState) {
      this.setGameState(data.gameState);
    }
  }

  private createBackground(): void {
    // å…¨ä½“èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(Colors.backgroundDark, 1);
    bg.fillRect(
      0,
      0,
      MainSceneLayout.SCREEN_WIDTH,
      MainSceneLayout.SCREEN_HEIGHT
    );
  }

  private createAreas(): void {
    const { MAIN_AREA, SIDEBAR, FOOTER } = MainSceneLayout;

    // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢èƒŒæ™¯
    this.mainAreaBg = this.add.graphics();
    this.mainAreaBg.fillStyle(Colors.backgroundMedium, 1);
    this.mainAreaBg.fillRect(
      MAIN_AREA.X,
      MAIN_AREA.Y,
      MAIN_AREA.WIDTH,
      MAIN_AREA.HEIGHT
    );

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼èƒŒæ™¯
    this.sidebarBg = this.add.graphics();
    this.sidebarBg.fillStyle(Colors.panelBackground, 1);
    this.sidebarBg.fillRect(
      SIDEBAR.X,
      SIDEBAR.Y,
      SIDEBAR.WIDTH,
      SIDEBAR.HEIGHT
    );
    this.sidebarBg.lineStyle(1, Colors.panelBorder);
    this.sidebarBg.strokeRect(
      SIDEBAR.X,
      SIDEBAR.Y,
      SIDEBAR.WIDTH,
      SIDEBAR.HEIGHT
    );

    // ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢èƒŒæ™¯
    const footerBg = this.add.graphics();
    footerBg.fillStyle(Colors.backgroundMedium, 1);
    footerBg.fillRect(
      FOOTER.X,
      FOOTER.Y,
      FOOTER.WIDTH,
      FOOTER.HEIGHT
    );
  }

  private createHeaderUI(): void {
    const { HEADER } = MainSceneLayout;

    this.headerUI = new HeaderUI(this, {
      x: HEADER.X,
      y: HEADER.Y,
      width: HEADER.WIDTH,
      height: HEADER.HEIGHT,
    });
  }

  private createSidebarUI(): void {
    const { SIDEBAR } = MainSceneLayout;

    this.sidebarUI = new SidebarUI(this, {
      x: SIDEBAR.X,
      y: SIDEBAR.Y,
      width: SIDEBAR.WIDTH,
      height: SIDEBAR.HEIGHT,
      onQuestSelect: (quest) => this.handleQuestSelect(quest),
      onItemSelect: (item) => this.handleItemSelect(item),
    });
  }

  private createPhaseIndicator(): void {
    const { FOOTER } = MainSceneLayout;

    this.phaseIndicator = new PhaseIndicator(this, {
      x: FOOTER.X + FOOTER.WIDTH / 2,
      y: FOOTER.Y + FOOTER.HEIGHT / 2,
      phases: ['quest-accept', 'gathering', 'alchemy', 'delivery'],
      currentPhase: this.currentPhase,
      onPhaseClick: (phase) => this.handlePhaseClick(phase),
    });
  }

  // ãƒ‡ãƒ¼ã‚¿è¨­å®šãƒ¡ã‚½ãƒƒãƒ‰
  setPlayerData(playerData: any): void {
    // ãƒ˜ãƒƒãƒ€ãƒ¼UIæ›´æ–°
    this.headerUI.setRank(playerData.rank);
    this.headerUI.setExp(playerData.exp, playerData.maxExp);
    this.headerUI.setDay(playerData.day, playerData.maxDay);
    this.headerUI.setGold(playerData.gold);
    this.headerUI.setAP(playerData.ap, playerData.maxAP);
  }

  setGameState(gameState: any): void {
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°
    if (gameState.quests) {
      this.sidebarUI.setQuests(gameState.quests);
    }
    if (gameState.inventory) {
      this.sidebarUI.setInventory(gameState.inventory);
    }

    // ãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
    if (gameState.currentPhase) {
      this.currentPhase = gameState.currentPhase;
      this.phaseIndicator.setCurrentPhase(gameState.currentPhase);
    }
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
  private handleQuestSelect(quest: any): void {
    this.eventBus.emit('sidebar:quest:selected', { quest });
  }

  private handleItemSelect(item: any): void {
    this.eventBus.emit('sidebar:item:selected', { item });
  }

  private handlePhaseClick(phase: string): void {
    // ãƒ•ã‚§ãƒ¼ã‚ºã‚¯ãƒªãƒƒã‚¯ã¯æƒ…å ±è¡¨ç¤ºã®ã¿ï¼ˆé·ç§»ã¯ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã§åˆ¶å¾¡ï¼‰
    this.eventBus.emit('phase:indicator:clicked', { phase });
  }

  // Getter
  getEventBus(): EventBus {
    return this.eventBus;
  }

  getMainAreaBounds(): { x: number; y: number; width: number; height: number } {
    return {
      x: MainSceneLayout.PHASE_CONTAINER.X,
      y: MainSceneLayout.PHASE_CONTAINER.Y,
      width: MainSceneLayout.PHASE_CONTAINER.WIDTH,
      height: MainSceneLayout.PHASE_CONTAINER.HEIGHT,
    };
  }

  protected setupEventListeners(): void {
    // EventBusã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  }

  update(time: number, delta: number): void {
    // ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  }
}
```

### 3. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒãƒƒã‚°ãƒ˜ãƒ«ãƒ‘ãƒ¼ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *é–‹ç™ºç”¨ãƒ„ãƒ¼ãƒ«*

```typescript
// MainSceneã«è¿½åŠ ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰

private debugMode: boolean = false;
private debugGraphics?: Phaser.GameObjects.Graphics;

toggleDebugMode(): void {
  this.debugMode = !this.debugMode;

  if (this.debugMode) {
    this.showDebugOverlay();
  } else {
    this.hideDebugOverlay();
  }
}

private showDebugOverlay(): void {
  if (this.debugGraphics) return;

  this.debugGraphics = this.add.graphics();
  this.debugGraphics.setDepth(1000);

  const areas = [
    { ...MainSceneLayout.HEADER, name: 'HEADER', color: 0xff0000 },
    { ...MainSceneLayout.SIDEBAR, name: 'SIDEBAR', color: 0x00ff00 },
    { ...MainSceneLayout.MAIN_AREA, name: 'MAIN_AREA', color: 0x0000ff },
    { ...MainSceneLayout.FOOTER, name: 'FOOTER', color: 0xffff00 },
    { ...MainSceneLayout.PHASE_CONTAINER, name: 'PHASE_CONTAINER', color: 0xff00ff },
  ];

  areas.forEach(area => {
    this.debugGraphics!.lineStyle(2, area.color, 0.8);
    this.debugGraphics!.strokeRect(area.X, area.Y, area.WIDTH, area.HEIGHT);

    const label = this.add.text(area.X + 5, area.Y + 5, area.name, {
      fontSize: '10px',
      color: `#${area.color.toString(16).padStart(6, '0')}`,
    });
    label.setDepth(1001);
    label.setData('debugLabel', true);
  });
}

private hideDebugOverlay(): void {
  if (this.debugGraphics) {
    this.debugGraphics.destroy();
    this.debugGraphics = undefined;
  }

  // ãƒ‡ãƒãƒƒã‚°ãƒ©ãƒ™ãƒ«ã‚‚å‰Šé™¤
  this.children.each((child: Phaser.GameObjects.GameObject) => {
    if (child.getData && child.getData('debugLabel')) {
      child.destroy();
    }
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚·ãƒ¼ãƒ³åˆæœŸåŒ– ğŸ”µ

**Given**: MainSceneã‚’èµ·å‹•
**When**: createãŒå®Œäº†
**Then**: ãƒ˜ãƒƒãƒ€ãƒ¼ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã€ãƒ•ãƒƒã‚¿ãƒ¼ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ‡ãƒ¼ã‚¿è¨­å®š ğŸ”µ

**Given**: MainSceneãŒèµ·å‹•ã—ã¦ã„ã‚‹
**When**: setPlayerDataã‚’å‘¼ã¶
**Then**: ãƒ˜ãƒƒãƒ€ãƒ¼UIã«å€¤ãŒåæ˜ ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå–å¾— ğŸ”µ

**Given**: MainSceneãŒèµ·å‹•ã—ã¦ã„ã‚‹
**When**: getMainAreaBoundsã‚’å‘¼ã¶
**Then**: ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠã®é…ç½®æƒ…å ±ãŒè¿”ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0235` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•°ã®ä¸€å…ƒç®¡ç†
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã¯å°†æ¥æ¤œè¨
- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®æœ¬ç•ªé™¤å¤–

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 2é …ç›® (67%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (33%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
