# TASK-0226: AlchemyPreviewPanelå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0226
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

èª¿åˆãƒ•ã‚§ãƒ¼ã‚ºã§èª¿åˆçµæœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã™ã‚‹ãƒ‘ãƒãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã€‚é¸æŠä¸­ã®ç´ æã‹ã‚‰äºˆæ¸¬ã•ã‚Œã‚‹å“è³ªã‚„ç‰¹æ€§ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0199
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0227

## å®Œäº†æ¡ä»¶

- [ ] IAlchemyPreviewPanelã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] äºˆæ¸¬å“è³ªãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é¸æŠç´ æãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] èª¿åˆå¯å¦ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒã‚ã‚‹
- [ ] ç´ æå¤‰æ›´æ™‚ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. IAlchemyPreviewPanelã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *èª¿åˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/alchemy/IAlchemyPreviewPanel.ts`

```typescript
import Phaser from 'phaser';
import { Material } from '../../../../domain/material/Material';
import { Recipe } from '../../../../domain/card/RecipeCard';

export interface AlchemyPreview {
  recipe: Recipe;
  materials: Material[];
  predictedQuality: string;
  predictedTraits: string[];
  canCraft: boolean;
  missingMaterials: string[];
}

export interface AlchemyPreviewPanelOptions {
  x?: number;
  y?: number;
}

export interface IAlchemyPreviewPanel {
  readonly container: Phaser.GameObjects.Container;

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
  setPreview(preview: AlchemyPreview | null): void;
  getPreview(): AlchemyPreview | null;

  // ç´ æè¿½åŠ ãƒ»å‰Šé™¤ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ç”¨ï¼‰
  addMaterial(material: Material): void;
  removeMaterial(material: Material): void;
  clearMaterials(): void;

  // è¡¨ç¤ºåˆ¶å¾¡
  setVisible(visible: boolean): void;
  setEnabled(enabled: boolean): void;

  // ç ´æ£„
  destroy(): void;
}
```

### 2. AlchemyPreviewPanelå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *èª¿åˆçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/alchemy/AlchemyPreviewPanel.ts`

```typescript
import Phaser from 'phaser';
import { IAlchemyPreviewPanel, AlchemyPreview, AlchemyPreviewPanelOptions } from './IAlchemyPreviewPanel';
import { Material } from '../../../../domain/material/Material';
import { MaterialView } from '../material/MaterialView';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class AlchemyPreviewPanel implements IAlchemyPreviewPanel {
  public readonly container: Phaser.GameObjects.Container;

  private scene: Phaser.Scene;
  private preview: AlchemyPreview | null = null;

  // UIè¦ç´ 
  private background!: Phaser.GameObjects.Graphics;
  private titleText!: Phaser.GameObjects.Text;
  private recipeNameText!: Phaser.GameObjects.Text;
  private qualitySection!: Phaser.GameObjects.Container;
  private materialsSection!: Phaser.GameObjects.Container;
  private traitsSection!: Phaser.GameObjects.Container;
  private statusIndicator!: Phaser.GameObjects.Container;

  private materialViews: MaterialView[] = [];

  constructor(scene: Phaser.Scene, options: AlchemyPreviewPanelOptions = {}) {
    this.scene = scene;

    const x = options.x ?? 0;
    const y = options.y ?? 0;

    this.container = scene.add.container(x, y);
    this.create();
  }

  private create(): void {
    const width = 250;
    const height = 350;

    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.background.fillStyle(Colors.panelBackground, 0.95);
    this.background.fillRoundedRect(0, 0, width, height, 8);
    this.background.lineStyle(1, Colors.panelBorder);
    this.background.strokeRoundedRect(0, 0, width, height, 8);
    this.container.add(this.background);

    // ã‚¿ã‚¤ãƒˆãƒ«
    this.titleText = this.scene.add.text(width / 2, 15, 'ğŸ”® èª¿åˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼', {
      ...TextStyles.body,
      fontSize: '14px',
      fontStyle: 'bold',
    }).setOrigin(0.5, 0);
    this.container.add(this.titleText);

    // ãƒ¬ã‚·ãƒ”å
    this.recipeNameText = this.scene.add.text(width / 2, 45, '', {
      ...TextStyles.body,
      fontSize: '16px',
      color: '#ffd700',
    }).setOrigin(0.5, 0);
    this.container.add(this.recipeNameText);

    // äºˆæ¸¬å“è³ªã‚»ã‚¯ã‚·ãƒ§ãƒ³
    this.qualitySection = this.scene.add.container(15, 80);
    this.container.add(this.qualitySection);
    this.createQualitySection();

    // ç´ æãƒªã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    this.materialsSection = this.scene.add.container(15, 150);
    this.container.add(this.materialsSection);
    this.createMaterialsSection();

    // ç‰¹æ€§ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    this.traitsSection = this.scene.add.container(15, 260);
    this.container.add(this.traitsSection);
    this.createTraitsSection();

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    this.statusIndicator = this.scene.add.container(width / 2, height - 30);
    this.container.add(this.statusIndicator);
    this.createStatusIndicator();

    // åˆæœŸçŠ¶æ…‹ã¯ç©º
    this.showEmptyState();
  }

  private createQualitySection(): void {
    const label = this.scene.add.text(0, 0, 'äºˆæ¸¬å“è³ª', {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#aaaaaa',
    });
    this.qualitySection.add(label);
  }

  private createMaterialsSection(): void {
    const label = this.scene.add.text(0, 0, 'ä½¿ç”¨ç´ æ', {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#aaaaaa',
    });
    this.materialsSection.add(label);
  }

  private createTraitsSection(): void {
    const label = this.scene.add.text(0, 0, 'ç¶™æ‰¿ç‰¹æ€§', {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#aaaaaa',
    });
    this.traitsSection.add(label);
  }

  private createStatusIndicator(): void {
    // èª¿åˆå¯å¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
  }

  setPreview(preview: AlchemyPreview | null): void {
    this.preview = preview;

    if (!preview) {
      this.showEmptyState();
      return;
    }

    // ãƒ¬ã‚·ãƒ”å
    this.recipeNameText.setText(preview.recipe.name ?? 'Unknown Recipe');

    // å“è³ªè¡¨ç¤º
    this.updateQualityDisplay(preview.predictedQuality);

    // ç´ æãƒªã‚¹ãƒˆ
    this.updateMaterialsList(preview.materials);

    // ç‰¹æ€§ãƒªã‚¹ãƒˆ
    this.updateTraitsList(preview.predictedTraits);

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    this.updateStatusIndicator(preview.canCraft, preview.missingMaterials);
  }

  getPreview(): AlchemyPreview | null {
    return this.preview;
  }

  private showEmptyState(): void {
    this.recipeNameText.setText('ãƒ¬ã‚·ãƒ”ã‚’é¸æŠã—ã¦ãã ã•ã„');

    // å“è³ªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    this.clearSection(this.qualitySection, 1);
    const emptyQuality = this.scene.add.text(0, 20, '-', {
      ...TextStyles.body,
      fontSize: '20px',
      color: '#666666',
    });
    this.qualitySection.add(emptyQuality);

    // ç´ æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    this.clearSection(this.materialsSection, 1);
    const emptyMaterials = this.scene.add.text(0, 20, 'ç´ æã‚’é¸æŠã—ã¦ãã ã•ã„', {
      ...TextStyles.body,
      fontSize: '11px',
      color: '#666666',
    });
    this.materialsSection.add(emptyMaterials);

    // ç‰¹æ€§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    this.clearSection(this.traitsSection, 1);

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚¯ãƒªã‚¢
    this.updateStatusIndicator(false, []);
  }

  private updateQualityDisplay(quality: string): void {
    this.clearSection(this.qualitySection, 1);

    const qualityColors: Record<string, string> = {
      'legendary': '#ffd700',
      'epic': '#a335ee',
      'rare': '#0070dd',
      'good': '#1eff00',
      'normal': '#ffffff',
      'poor': '#9d9d9d',
    };

    const color = qualityColors[quality] ?? qualityColors['normal'];
    const qualityText = this.scene.add.text(0, 20, quality.toUpperCase(), {
      ...TextStyles.body,
      fontSize: '20px',
      fontStyle: 'bold',
      color: color,
    });
    this.qualitySection.add(qualityText);

    // å“è³ªã‚²ãƒ¼ã‚¸
    const qualityLevels = ['poor', 'normal', 'good', 'rare', 'epic', 'legendary'];
    const level = qualityLevels.indexOf(quality);
    const gauge = this.scene.add.graphics();
    gauge.fillStyle(0x333333, 1);
    gauge.fillRoundedRect(0, 50, 200, 8, 4);
    if (level >= 0) {
      gauge.fillStyle(parseInt(color.replace('#', ''), 16), 1);
      gauge.fillRoundedRect(0, 50, (level + 1) / qualityLevels.length * 200, 8, 4);
    }
    this.qualitySection.add(gauge);
  }

  private updateMaterialsList(materials: Material[]): void {
    this.clearSection(this.materialsSection, 1);

    // æ—¢å­˜ã®MaterialViewã‚’ç ´æ£„
    this.materialViews.forEach(mv => mv.destroy());
    this.materialViews = [];

    if (materials.length === 0) {
      const emptyText = this.scene.add.text(0, 20, 'ç´ æãªã—', {
        ...TextStyles.body,
        fontSize: '11px',
        color: '#666666',
      });
      this.materialsSection.add(emptyText);
      return;
    }

    materials.slice(0, 4).forEach((material, index) => {
      const mv = new MaterialView(this.scene, {
        x: (index % 2) * 100,
        y: 20 + Math.floor(index / 2) * 45,
        material: material,
        showQuantity: false,
        compact: true,
      });
      this.materialsSection.add(mv.container);
      this.materialViews.push(mv);
    });

    if (materials.length > 4) {
      const moreText = this.scene.add.text(0, 110, `+${materials.length - 4} more`, {
        ...TextStyles.body,
        fontSize: '10px',
        color: '#aaaaaa',
      });
      this.materialsSection.add(moreText);
    }
  }

  private updateTraitsList(traits: string[]): void {
    this.clearSection(this.traitsSection, 1);

    if (traits.length === 0) {
      const emptyText = this.scene.add.text(0, 20, 'ç¶™æ‰¿ç‰¹æ€§ãªã—', {
        ...TextStyles.body,
        fontSize: '11px',
        color: '#666666',
      });
      this.traitsSection.add(emptyText);
      return;
    }

    traits.slice(0, 3).forEach((trait, index) => {
      const traitText = this.scene.add.text(0, 20 + index * 18, `â€¢ ${trait}`, {
        ...TextStyles.body,
        fontSize: '11px',
        color: '#aaaaff',
      });
      this.traitsSection.add(traitText);
    });
  }

  private updateStatusIndicator(canCraft: boolean, missing: string[]): void {
    // æ—¢å­˜ã‚’ã‚¯ãƒªã‚¢
    this.statusIndicator.removeAll(true);

    if (canCraft) {
      const okText = this.scene.add.text(0, 0, 'âœ… èª¿åˆå¯èƒ½', {
        ...TextStyles.body,
        fontSize: '14px',
        color: '#00ff00',
      }).setOrigin(0.5);
      this.statusIndicator.add(okText);
    } else if (missing.length > 0) {
      const ngText = this.scene.add.text(0, 0, 'âŒ ç´ æä¸è¶³', {
        ...TextStyles.body,
        fontSize: '14px',
        color: '#ff4444',
      }).setOrigin(0.5);
      this.statusIndicator.add(ngText);
    } else {
      const waitText = this.scene.add.text(0, 0, 'â³ å¾…æ©Ÿä¸­', {
        ...TextStyles.body,
        fontSize: '14px',
        color: '#aaaaaa',
      }).setOrigin(0.5);
      this.statusIndicator.add(waitText);
    }
  }

  private clearSection(section: Phaser.GameObjects.Container, keepFirst: number): void {
    const children = section.getAll().slice(keepFirst);
    children.forEach(child => child.destroy());
  }

  addMaterial(material: Material): void {
    if (!this.preview) return;

    const newMaterials = [...this.preview.materials, material];
    this.setPreview({
      ...this.preview,
      materials: newMaterials,
    });
  }

  removeMaterial(material: Material): void {
    if (!this.preview) return;

    const newMaterials = this.preview.materials.filter(m => m !== material);
    this.setPreview({
      ...this.preview,
      materials: newMaterials,
    });
  }

  clearMaterials(): void {
    if (!this.preview) return;

    this.setPreview({
      ...this.preview,
      materials: [],
    });
  }

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  setEnabled(enabled: boolean): void {
    this.container.setAlpha(enabled ? 1 : 0.5);
  }

  destroy(): void {
    this.materialViews.forEach(mv => mv.destroy());
    this.container.destroy();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š ğŸŸ¡

**Given**: AlchemyPreviewPanelãŒã‚ã‚‹
**When**: setPreview(preview)ã‚’å‘¼ã¶
**Then**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å“è³ªè¡¨ç¤º ğŸŸ¡

**Given**: äºˆæ¸¬å“è³ªãŒ "rare"
**When**: è¡¨ç¤ºã‚’ç¢ºèª
**Then**: å“è³ªãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²ã¨ã‚²ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç´ æè¿½åŠ ãƒ»å‰Šé™¤ ğŸŸ¡

**Given**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
**When**: addMaterial/removeMaterialã‚’å‘¼ã¶
**Then**: ç´ æãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0226` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å“è³ªäºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ç¢ºæ€§
- MaterialViewã®å†åˆ©ç”¨
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆå®Ÿè£…æ™‚ã«è©³ç´°ç¢ºèªè¦ï¼‰
