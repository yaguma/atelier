# TASK-0245: RankUpSceneè©¦é¨“è¡¨ç¤ºãƒ»é€²è¡Œå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0245
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

æ˜‡æ ¼è©¦é¨“ã®é€²è¡Œè¡¨ç¤ºã¨çµæœè¡¨ç¤ºã‚’å®Ÿè£…ã™ã‚‹ã€‚è©¦é¨“é–‹å§‹ã‹ã‚‰çµæœç™ºè¡¨ã¾ã§ã®ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0244
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0246

## å®Œäº†æ¡ä»¶

- [ ] è©¦é¨“é–‹å§‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è©¦é¨“é€²è¡Œä¸­ã®è¡¨ç¤ºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] æˆåŠŸæ™‚ã®æ¼”å‡ºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å¤±æ•—æ™‚ã®æ¼”å‡ºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. è©¦é¨“é–‹å§‹æ¼”å‡º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³*

```typescript
// RankUpSceneã«è¿½åŠ 

private examOverlay!: Phaser.GameObjects.Container;
private isExamInProgress: boolean = false;

async startExam(): Promise<void> {
  if (this.isExamInProgress) return;
  this.isExamInProgress = true;

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
  this.createExamOverlay();

  // é–‹å§‹æ¼”å‡º
  await this.playExamStartAnimation();

  // è©¦é¨“é€²è¡Œè¡¨ç¤º
  await this.showExamProgress();
}

private createExamOverlay(): void {
  this.examOverlay = this.add.container(0, 0);
  this.examOverlay.setDepth(100);

  // åŠé€æ˜èƒŒæ™¯
  const bg = this.add.graphics();
  bg.fillStyle(0x000000, 0.8);
  bg.fillRect(0, 0, RankUpSceneLayout.SCREEN_WIDTH, RankUpSceneLayout.SCREEN_HEIGHT);
  this.examOverlay.add(bg);
}

private async playExamStartAnimation(): Promise<void> {
  return new Promise((resolve) => {
    const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
    const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

    // è©¦é¨“é–‹å§‹ãƒ†ã‚­ã‚¹ãƒˆ
    const startText = this.add.text(centerX, centerY, 'æ˜‡æ ¼è©¦é¨“é–‹å§‹', {
      fontSize: '48px',
      fontStyle: 'bold',
      color: '#ffcc00',
    }).setOrigin(0.5).setAlpha(0).setScale(2);
    this.examOverlay.add(startText);

    // å…‰å½©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const glow = this.add.graphics();
    glow.fillStyle(0xffcc00, 0.3);
    glow.fillCircle(centerX, centerY, 0);
    this.examOverlay.add(glow);

    // å…‰å½©æ‹¡å¤§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.tweens.add({
      targets: glow,
      scaleX: 5,
      scaleY: 5,
      alpha: 0,
      duration: 1000,
      ease: 'Power2.easeOut',
    });

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.tweens.add({
      targets: startText,
      alpha: 1,
      scale: 1,
      duration: 500,
      ease: 'Back.easeOut',
      onComplete: () => {
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        this.time.delayedCall(1000, () => {
          this.tweens.add({
            targets: startText,
            alpha: 0,
            y: centerY - 50,
            duration: 300,
            onComplete: () => {
              startText.destroy();
              resolve();
            },
          });
        });
      },
    });
  });
}
```

### 2. è©¦é¨“é€²è¡Œè¡¨ç¤º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é€²è¡ŒUI*

```typescript
// RankUpSceneã«è¿½åŠ 

private progressSteps: Phaser.GameObjects.Container[] = [];

private async showExamProgress(): Promise<void> {
  const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
  const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

  // é€²è¡Œã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
  const steps = [
    { text: 'ä¾é ¼é”æˆçŠ¶æ³ã‚’ç¢ºèªä¸­...', delay: 500 },
    { text: 'èª¿åˆå®Ÿç¸¾ã‚’ç¢ºèªä¸­...', delay: 800 },
    { text: 'æ¡å–å®Ÿç¸¾ã‚’ç¢ºèªä¸­...', delay: 600 },
    { text: 'æœ€çµ‚åˆ¤å®šä¸­...', delay: 1000 },
  ];

  for (let i = 0; i < steps.length; i++) {
    const step = steps[i];
    await this.showProgressStep(step.text, centerY - 50 + i * 40, step.delay);
  }

  // çµæœåˆ¤å®šï¼ˆApplicationå±¤ã‹ã‚‰é€šçŸ¥ã‚’å¾…ã¤ï¼‰
  this.eventBus.emit('rankup:exam:evaluate', {
    requirements: this.sceneData.requirements,
  });
}

private async showProgressStep(text: string, y: number, duration: number): Promise<void> {
  return new Promise((resolve) => {
    const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;

    const stepContainer = this.add.container(centerX, y);
    this.examOverlay.add(stepContainer);
    this.progressSteps.push(stepContainer);

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³
    const loader = this.add.graphics();
    loader.lineStyle(3, Colors.primary);
    loader.arc(-100, 0, 12, 0, Phaser.Math.PI2 * 0.75);
    loader.strokePath();
    stepContainer.add(loader);

    // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.tweens.add({
      targets: loader,
      angle: 360,
      duration: 800,
      repeat: -1,
    });

    // ãƒ†ã‚­ã‚¹ãƒˆ
    const stepText = this.add.text(-70, 0, text, {
      ...TextStyles.body,
      fontSize: '16px',
    }).setOrigin(0, 0.5).setAlpha(0);
    stepContainer.add(stepText);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    this.tweens.add({
      targets: stepText,
      alpha: 1,
      duration: 200,
    });

    // å®Œäº†
    this.time.delayedCall(duration, () => {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¶ˆã™
      loader.destroy();

      // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
      const check = this.add.text(-100, 0, 'âœ“', {
        fontSize: '20px',
        color: '#00ff00',
      }).setOrigin(0.5);
      stepContainer.add(check);

      resolve();
    });
  });
}
```

### 3. æˆåŠŸæ¼”å‡º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æˆåŠŸUI*

```typescript
// RankUpSceneã«è¿½åŠ 

async showExamSuccess(newRank: string): Promise<void> {
  // é€²è¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
  this.clearProgressSteps();

  const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
  const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

  // æˆåŠŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  await this.playSuccessParticles();

  // ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—è¡¨ç¤º
  const resultContainer = this.add.container(centerX, centerY);
  this.examOverlay.add(resultContainer);

  // æˆåŠŸãƒ†ã‚­ã‚¹ãƒˆ
  const successText = this.add.text(0, -80, 'ğŸ‰ æ˜‡æ ¼æˆåŠŸï¼', {
    fontSize: '36px',
    fontStyle: 'bold',
    color: '#00ff00',
  }).setOrigin(0.5).setAlpha(0);
  resultContainer.add(successText);

  // æ–°ãƒ©ãƒ³ã‚¯è¡¨ç¤º
  const newRankContainer = this.createNewRankDisplay(newRank);
  newRankContainer.setAlpha(0);
  resultContainer.add(newRankContainer);

  // å ±é…¬ãƒªã‚¹ãƒˆ
  const rewardsText = this.add.text(0, 100, 'ç²å¾—å ±é…¬:', {
    ...TextStyles.heading,
    fontSize: '18px',
  }).setOrigin(0.5).setAlpha(0);
  resultContainer.add(rewardsText);

  const rewardsList = this.createRewardsDisplay();
  rewardsList.setY(140);
  rewardsList.setAlpha(0);
  resultContainer.add(rewardsList);

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.tweenPromise({
    targets: successText,
    alpha: 1,
    y: successText.y - 20,
    duration: 500,
    ease: 'Power2.easeOut',
  });

  await this.tweenPromise({
    targets: newRankContainer,
    alpha: 1,
    scale: { from: 0.5, to: 1 },
    duration: 500,
    ease: 'Back.easeOut',
  });

  await this.delay(300);

  await this.tweenPromise({
    targets: [rewardsText, rewardsList],
    alpha: 1,
    duration: 300,
  });

  // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³
  await this.delay(500);
  this.showContinueButton();
}

private createNewRankDisplay(rank: string): Phaser.GameObjects.Container {
  const container = this.add.container(0, 0);

  // å…‰å½©èƒŒæ™¯
  const glow = this.add.graphics();
  glow.fillStyle(0xffcc00, 0.3);
  glow.fillCircle(0, 0, 80);
  container.add(glow);

  // ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸
  const badge = this.add.graphics();
  badge.fillStyle(0xffcc00, 1);
  badge.fillCircle(0, 0, 50);
  container.add(badge);

  // ãƒ©ãƒ³ã‚¯æ–‡å­—
  const rankText = this.add.text(0, 0, rank, {
    fontSize: '36px',
    fontStyle: 'bold',
    color: '#000000',
  }).setOrigin(0.5);
  container.add(rankText);

  return container;
}

private createRewardsDisplay(): Phaser.GameObjects.Container {
  const container = this.add.container(0, 0);

  let x = -((this.sceneData.rewards.length - 1) * 100) / 2;
  this.sceneData.rewards.forEach((reward, index) => {
    const rewardItem = this.add.container(x, 0);

    const icon = this.add.text(0, 0, this.getRewardIcon(reward.type), {
      fontSize: '32px',
    }).setOrigin(0.5);
    rewardItem.add(icon);

    const name = this.add.text(0, 30, reward.name, {
      ...TextStyles.body,
      fontSize: '12px',
    }).setOrigin(0.5);
    rewardItem.add(name);

    container.add(rewardItem);
    x += 100;
  });

  return container;
}

private async playSuccessParticles(): Promise<void> {
  return new Promise((resolve) => {
    const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
    const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

    // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    for (let i = 0; i < 50; i++) {
      const confetti = this.add.graphics();
      const colors = [0xffcc00, 0x00ff00, 0xff00ff, 0x00ffff];
      confetti.fillStyle(colors[i % colors.length], 1);
      confetti.fillRect(-5, -5, 10, 10);
      confetti.x = centerX + Phaser.Math.Between(-100, 100);
      confetti.y = centerY;
      confetti.setDepth(101);
      this.examOverlay.add(confetti);

      this.tweens.add({
        targets: confetti,
        x: confetti.x + Phaser.Math.Between(-200, 200),
        y: RankUpSceneLayout.SCREEN_HEIGHT + 50,
        angle: Phaser.Math.Between(0, 720),
        duration: Phaser.Math.Between(1500, 2500),
        ease: 'Power1.easeIn',
        onComplete: () => confetti.destroy(),
      });
    }

    this.time.delayedCall(500, resolve);
  });
}
```

### 4. å¤±æ•—æ¼”å‡º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å¤±æ•—UI*

```typescript
// RankUpSceneã«è¿½åŠ 

async showExamFailure(reason: string): Promise<void> {
  // é€²è¡Œã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
  this.clearProgressSteps();

  const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
  const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

  const resultContainer = this.add.container(centerX, centerY);
  this.examOverlay.add(resultContainer);

  // å¤±æ•—ãƒ†ã‚­ã‚¹ãƒˆ
  const failText = this.add.text(0, -60, 'è©¦é¨“ä¸åˆæ ¼', {
    fontSize: '32px',
    fontStyle: 'bold',
    color: '#ff4444',
  }).setOrigin(0.5).setAlpha(0);
  resultContainer.add(failText);

  // ç†ç”±
  const reasonText = this.add.text(0, 0, reason, {
    ...TextStyles.body,
    fontSize: '16px',
    color: '#aaaaaa',
    wordWrap: { width: 400 },
    align: 'center',
  }).setOrigin(0.5).setAlpha(0);
  resultContainer.add(reasonText);

  // ã‚¢ãƒ‰ãƒã‚¤ã‚¹
  const adviceText = this.add.text(0, 60, 'æ¡ä»¶ã‚’æº€ãŸã—ã¦ã‹ã‚‰å†æŒ‘æˆ¦ã—ã¦ãã ã•ã„', {
    ...TextStyles.body,
    fontSize: '14px',
    color: '#888888',
  }).setOrigin(0.5).setAlpha(0);
  resultContainer.add(adviceText);

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.tweenPromise({
    targets: failText,
    alpha: 1,
    duration: 300,
  });

  // ç”»é¢æºã‚Œ
  this.cameras.main.shake(200, 0.01);

  await this.delay(200);

  await this.tweenPromise({
    targets: [reasonText, adviceText],
    alpha: 1,
    duration: 300,
  });

  // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³
  await this.delay(500);
  this.showRetryButton();
}

private showRetryButton(): void {
  const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
  const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

  const retryBtn = UIFactory.createButton(this, {
    x: centerX,
    y: centerY + 150,
    width: 200,
    height: 50,
    text: 'æˆ»ã‚‹',
    onClick: () => this.closeExamOverlay(),
  });
  retryBtn.setDepth(102);
  this.examOverlay.add(retryBtn);
}

private showContinueButton(): void {
  const centerX = RankUpSceneLayout.SCREEN_WIDTH / 2;
  const centerY = RankUpSceneLayout.SCREEN_HEIGHT / 2;

  const continueBtn = UIFactory.createButton(this, {
    x: centerX,
    y: centerY + 200,
    width: 200,
    height: 50,
    text: 'ç¶šã‘ã‚‹',
    onClick: () => this.onExamComplete(),
  });
  continueBtn.setDepth(102);
  this.examOverlay.add(continueBtn);
}

private clearProgressSteps(): void {
  this.progressSteps.forEach(step => step.destroy());
  this.progressSteps = [];
}

private closeExamOverlay(): void {
  this.tweens.add({
    targets: this.examOverlay,
    alpha: 0,
    duration: 300,
    onComplete: () => {
      this.examOverlay.destroy();
      this.isExamInProgress = false;
    },
  });
}

private onExamComplete(): void {
  this.eventBus.emit('rankup:exam:complete', {
    newRank: this.sceneData.targetRank,
    rewards: this.sceneData.rewards,
  });

  // ãƒ¡ã‚¤ãƒ³ã‚·ãƒ¼ãƒ³ã«æˆ»ã‚‹
  this.sceneManager.switchTo(SceneKeys.MAIN);
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
private tweenPromise(config: any): Promise<void> {
  return new Promise(resolve => {
    this.tweens.add({
      ...config,
      onComplete: () => resolve(),
    });
  });
}

private delay(ms: number): Promise<void> {
  return new Promise(resolve => this.time.delayedCall(ms, resolve));
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: è©¦é¨“é–‹å§‹ ğŸ”µ

**Given**: è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹
**When**: æŒ‘æˆ¦ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: è©¦é¨“é–‹å§‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç”Ÿã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æˆåŠŸæ¼”å‡º ğŸ”µ

**Given**: è©¦é¨“é€²è¡Œä¸­
**When**: æˆåŠŸé€šçŸ¥ã‚’å—ä¿¡
**Then**: æ˜‡æ ¼æˆåŠŸæ¼”å‡ºã¨å ±é…¬è¡¨ç¤ºãŒè¡Œã‚ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å¤±æ•—æ¼”å‡º ğŸ”µ

**Given**: è©¦é¨“é€²è¡Œä¸­
**When**: å¤±æ•—é€šçŸ¥ã‚’å—ä¿¡
**Then**: å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0245` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- æ¼”å‡ºä¸­ã®æ“ä½œãƒ­ãƒƒã‚¯

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
