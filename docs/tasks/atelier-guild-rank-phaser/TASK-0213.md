# TASK-0213: BasePhaseContainerå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0213
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

BasePhaseContainerã®å…·ä½“çš„ãªå®Ÿè£…ã‚’è¡Œã†ã€‚å…±é€šæ©Ÿèƒ½ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã‚’å®Œäº†ã•ã›ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0212
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0216, TASK-0222, TASK-0227, TASK-0232

## å®Œäº†æ¡ä»¶

- [x] BasePhaseContainerãŒå®Œå…¨ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆenter/exitï¼‰ãŒå‹•ä½œã™ã‚‹
- [x] EventBusé€£æºãŒå‹•ä½œã™ã‚‹
- [x] æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆãŒå‹•ä½œã™ã‚‹
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒé€šã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *å„ãƒ•ã‚§ãƒ¼ã‚ºã§å…±æœ‰*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/BasePhaseContainer.ts` (è¿½åŠ )

```typescript
// BasePhaseContainerã«è¿½åŠ 

// ãƒ•ã‚§ãƒ¼ã‚ºã‚¿ã‚¤ãƒˆãƒ«
protected createTitle(title: string): Phaser.GameObjects.Text {
  const titleText = this.scene.add.text(
    this.width / 2,
    20,
    title,
    {
      ...TextStyles.heading,
      fontSize: '24px',
    }
  ).setOrigin(0.5, 0);
  this.container.add(titleText);
  return titleText;
}

// èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
protected createDescription(description: string, y: number): Phaser.GameObjects.Text {
  const descText = this.scene.add.text(
    this.width / 2,
    y,
    description,
    {
      ...TextStyles.body,
      fontSize: '14px',
      wordWrap: { width: this.width - 40 },
      align: 'center',
    }
  ).setOrigin(0.5, 0);
  this.container.add(descText);
  return descText;
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
protected createActionButtons(
  buttons: Array<{
    label: string;
    primary?: boolean;
    onClick: () => void;
    enabled?: boolean;
  }>
): Phaser.GameObjects.Container {
  const buttonContainer = this.scene.add.container(0, this.height - 60);
  const buttonWidth = 120;
  const buttonSpacing = 20;
  const totalWidth = buttons.length * buttonWidth + (buttons.length - 1) * buttonSpacing;
  const startX = (this.width - totalWidth) / 2;

  buttons.forEach((btn, index) => {
    const x = startX + index * (buttonWidth + buttonSpacing) + buttonWidth / 2;
    const button = this.createButton(
      x,
      0,
      btn.label,
      btn.onClick,
      btn.primary ?? false,
      btn.enabled ?? true
    );
    buttonContainer.add(button);
  });

  this.container.add(buttonContainer);
  return buttonContainer;
}

// ãƒœã‚¿ãƒ³ç”Ÿæˆ
protected createButton(
  x: number,
  y: number,
  label: string,
  onClick: () => void,
  primary: boolean = false,
  enabled: boolean = true
): Phaser.GameObjects.Container {
  const buttonContainer = this.scene.add.container(x, y);
  const width = 120;
  const height = 40;

  const bg = this.scene.add.graphics();
  const bgColor = primary ? Colors.accent : Colors.backgroundDark;
  bg.fillStyle(bgColor, enabled ? 1 : 0.5);
  bg.fillRoundedRect(-width / 2, -height / 2, width, height, 6);
  bg.lineStyle(2, primary ? Colors.accentLight : Colors.panelBorder);
  bg.strokeRoundedRect(-width / 2, -height / 2, width, height, 6);
  buttonContainer.add(bg);

  const text = this.scene.add.text(0, 0, label, {
    ...TextStyles.button,
    fontSize: '14px',
  }).setOrigin(0.5);
  text.setAlpha(enabled ? 1 : 0.5);
  buttonContainer.add(text);

  if (enabled) {
    buttonContainer.setInteractive(
      new Phaser.Geom.Rectangle(-width / 2, -height / 2, width, height),
      Phaser.Geom.Rectangle.Contains
    );
    buttonContainer.on('pointerover', () => {
      bg.clear();
      bg.fillStyle(primary ? Colors.accentLight : 0x4a4a6a, 1);
      bg.fillRoundedRect(-width / 2, -height / 2, width, height, 6);
      bg.lineStyle(2, primary ? Colors.accentLight : Colors.panelBorder);
      bg.strokeRoundedRect(-width / 2, -height / 2, width, height, 6);
    });
    buttonContainer.on('pointerout', () => {
      bg.clear();
      bg.fillStyle(bgColor, 1);
      bg.fillRoundedRect(-width / 2, -height / 2, width, height, 6);
      bg.lineStyle(2, primary ? Colors.accentLight : Colors.panelBorder);
      bg.strokeRoundedRect(-width / 2, -height / 2, width, height, 6);
    });
    buttonContainer.on('pointerdown', onClick);
  }

  buttonContainer.setData('bg', bg);
  buttonContainer.setData('text', text);
  buttonContainer.setData('enabled', enabled);

  return buttonContainer;
}

// ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
protected setButtonEnabled(button: Phaser.GameObjects.Container, enabled: boolean): void {
  const bg = button.getData('bg') as Phaser.GameObjects.Graphics;
  const text = button.getData('text') as Phaser.GameObjects.Text;
  button.setData('enabled', enabled);

  text.setAlpha(enabled ? 1 : 0.5);
  bg.setAlpha(enabled ? 1 : 0.5);

  if (enabled) {
    button.setInteractive();
  } else {
    button.disableInteractive();
  }
}
```

### 2. çŠ¶æ…‹ç®¡ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *çŠ¶æ…‹ã®è¿½è·¡*

```typescript
// BasePhaseContainerã«è¿½åŠ 

// å†…éƒ¨çŠ¶æ…‹
protected state: Record<string, any> = {};

// çŠ¶æ…‹ã®å–å¾—/è¨­å®š
protected getState<T>(key: string): T | undefined {
  return this.state[key] as T;
}

protected setState<T>(key: string, value: T): void {
  const oldValue = this.state[key];
  this.state[key] = value;
  this.onStateChange(key, oldValue, value);
}

protected clearState(): void {
  this.state = {};
}

// çŠ¶æ…‹å¤‰æ›´æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
protected onStateChange(key: string, oldValue: any, newValue: any): void {}
```

### 3. ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹è¡¨ç¤º ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *éåŒæœŸå‡¦ç†ä¸­ã®è¡¨ç¤º*

```typescript
// BasePhaseContainerã«è¿½åŠ 

private loadingOverlay?: Phaser.GameObjects.Container;

protected showLoading(message: string = 'å‡¦ç†ä¸­...'): void {
  if (this.loadingOverlay) return;

  this.loadingOverlay = this.scene.add.container(0, 0);

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯
  const overlay = this.scene.add.graphics();
  overlay.fillStyle(0x000000, 0.7);
  overlay.fillRect(0, 0, this.width, this.height);
  this.loadingOverlay.add(overlay);

  // ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  const spinner = this.scene.add.text(
    this.width / 2,
    this.height / 2 - 20,
    'âŸ³',
    { fontSize: '48px' }
  ).setOrigin(0.5);
  this.loadingOverlay.add(spinner);

  this.scene.tweens.add({
    targets: spinner,
    rotation: Math.PI * 2,
    duration: 1000,
    repeat: -1,
    ease: 'Linear',
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const loadingText = this.scene.add.text(
    this.width / 2,
    this.height / 2 + 30,
    message,
    { ...TextStyles.body, fontSize: '14px' }
  ).setOrigin(0.5);
  this.loadingOverlay.add(loadingText);

  this.container.add(this.loadingOverlay);
}

protected hideLoading(): void {
  if (this.loadingOverlay) {
    this.loadingOverlay.destroy();
    this.loadingOverlay = undefined;
  }
}
```

### 4. ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°*

```typescript
// BasePhaseContainerã«è¿½åŠ 

protected showError(message: string, onDismiss?: () => void): void {
  const errorContainer = this.scene.add.container(0, 0);

  // èƒŒæ™¯
  const bg = this.scene.add.graphics();
  bg.fillStyle(0x000000, 0.8);
  bg.fillRect(0, 0, this.width, this.height);
  errorContainer.add(bg);

  // ã‚¨ãƒ©ãƒ¼ãƒ‘ãƒãƒ«
  const panelWidth = 300;
  const panelHeight = 150;
  const panelX = (this.width - panelWidth) / 2;
  const panelY = (this.height - panelHeight) / 2;

  const panel = this.scene.add.graphics();
  panel.fillStyle(0x4a2a2a, 1);
  panel.fillRoundedRect(panelX, panelY, panelWidth, panelHeight, 8);
  panel.lineStyle(2, 0xff4444);
  panel.strokeRoundedRect(panelX, panelY, panelWidth, panelHeight, 8);
  errorContainer.add(panel);

  // ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  const icon = this.scene.add.text(
    this.width / 2,
    panelY + 30,
    'âš ï¸',
    { fontSize: '32px' }
  ).setOrigin(0.5);
  errorContainer.add(icon);

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const text = this.scene.add.text(
    this.width / 2,
    panelY + 70,
    message,
    {
      ...TextStyles.body,
      fontSize: '14px',
      wordWrap: { width: panelWidth - 20 },
      align: 'center',
    }
  ).setOrigin(0.5);
  errorContainer.add(text);

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  const closeBtn = this.createButton(
    this.width / 2,
    panelY + panelHeight - 30,
    'OK',
    () => {
      errorContainer.destroy();
      if (onDismiss) onDismiss();
    },
    true
  );
  errorContainer.add(closeBtn);

  this.container.add(errorContainer);
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ ğŸŸ¡

**Given**: BasePhaseContainerãŒã‚ã‚‹
**When**: createTitle('ãƒ†ã‚¹ãƒˆ')ã‚’å‘¼ã¶
**Then**: ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒœã‚¿ãƒ³æœ‰åŠ¹/ç„¡åŠ¹ ğŸŸ¡

**Given**: ãƒœã‚¿ãƒ³ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
**When**: setButtonEnabled(button, false)ã‚’å‘¼ã¶
**Then**: ãƒœã‚¿ãƒ³ãŒã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º ğŸŸ¡

**Given**: ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹
**When**: showLoading()ã‚’å‘¼ã¶
**Then**: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0213` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã®å†åˆ©ç”¨æ€§
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®UX

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 4é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
