# TASK-0181: Phase1çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0181
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”´ *Phaserå›ºæœ‰ã®èª¿æŸ»ãŒå¿…è¦*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **è¨­è¨ˆæ–‡æ›¸**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

Phase 1ã§å®Ÿè£…ã—ãŸå…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆEventBusã€SceneManagerã€UIFactoryã€DialogManagerã€ToastManagerï¼‰ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0166, TASK-0171, TASK-0178, TASK-0179, TASK-0180
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0182ä»¥é™ï¼ˆPhase 2ï¼‰

## å®Œäº†æ¡ä»¶

- [ ] å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé€£æºã—ã¦å‹•ä½œã™ã‚‹
- [ ] EventBusã‚’ä»‹ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€šä¿¡ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚·ãƒ¼ãƒ³é·ç§»ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] UIè¦ç´ ã®ç”Ÿæˆã¨è¡¨ç¤ºãŒå‹•ä½œã™ã‚‹
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. çµ±åˆãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *å®Ÿéš›ã®å‹•ä½œç¢ºèªãŒå¿…è¦*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/Phase1Integration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { EventBus } from '../../../src/presentation/phaser/events/EventBus';
import { SceneManager } from '../../../src/presentation/phaser/managers/SceneManager';
import { DialogManager } from '../../../src/presentation/phaser/managers/DialogManager';
import { ToastManager } from '../../../src/presentation/phaser/managers/ToastManager';

describe('Phase 1 çµ±åˆãƒ†ã‚¹ãƒˆ', () => {
  beforeEach(() => {
    EventBus.resetInstance();
    SceneManager.resetInstance();
    DialogManager.resetInstance();
    ToastManager.resetInstance();
  });

  describe('EventBusçµ±åˆ', () => {
    it('å…¨ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒEventBusã‚’å…±æœ‰ã™ã‚‹', () => {
      const eventBus = EventBus.getInstance();
      // å„ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒEventBusã‚’å‚ç…§ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      expect(eventBus).toBeDefined();
    });

    it('ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡ŒãŒå„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ä¼æ’­ã™ã‚‹', () => {
      const eventBus = EventBus.getInstance();
      const callback = vi.fn();

      eventBus.on('state:gold:changed', callback);
      eventBus.emit('state:gold:changed', { gold: 100, delta: 50 });

      expect(callback).toHaveBeenCalledWith({ gold: 100, delta: 50 });
    });
  });

  describe('ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ç®¡ç†', () => {
    it('å„ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§ã‚ã‚‹', () => {
      const eventBus1 = EventBus.getInstance();
      const eventBus2 = EventBus.getInstance();
      expect(eventBus1).toBe(eventBus2);

      const sceneManager1 = SceneManager.getInstance();
      const sceneManager2 = SceneManager.getInstance();
      expect(sceneManager1).toBe(sceneManager2);
    });

    it('resetInstanceå¾Œã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã‚‹', () => {
      const eventBus1 = EventBus.getInstance();
      EventBus.resetInstance();
      const eventBus2 = EventBus.getInstance();
      expect(eventBus1).not.toBe(eventBus2);
    });
  });

  describe('ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢', () => {
    it('EventBusã®clearã§å…¨ãƒªã‚¹ãƒŠãƒ¼ãŒè§£é™¤ã•ã‚Œã‚‹', () => {
      const eventBus = EventBus.getInstance();

      eventBus.on('state:gold:changed', () => {});
      eventBus.on('state:ap:changed', () => {});
      eventBus.onVoid('ui:newGame:clicked', () => {});

      expect(eventBus.getListenerCount()).toBe(3);

      eventBus.clear();

      expect(eventBus.getListenerCount()).toBe(0);
    });
  });
});
```

### 2. UIFactoryçµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaserã®ãƒ¢ãƒƒã‚¯ç’°å¢ƒãŒå¿…è¦*

```typescript
describe('UIFactoryçµ±åˆ', () => {
  // Note: ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã¯Phaserã®ãƒ¢ãƒƒã‚¯ç’°å¢ƒãŒå¿…è¦
  // å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã¾ãŸã¯headlessãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ

  it.skip('ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãŒEventBusã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹', async () => {
    // å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
  });

  it.skip('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒœã‚¿ãƒ³ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
    // å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
  });

  it.skip('ãƒˆãƒ¼ã‚¹ãƒˆãŒæŒ‡å®šæ™‚é–“å¾Œã«æ¶ˆãˆã‚‹', async () => {
    // å®Ÿè£…æ™‚ã«è©³ç´°åŒ–
  });
});
```

### 3. å‹•ä½œç¢ºèªç”¨ãƒ‡ãƒ¢ã‚·ãƒ¼ãƒ³ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *æ‰‹å‹•ç¢ºèªç”¨*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/DemoScene.ts`

```typescript
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { SceneKeys } from '../config/SceneKeys';
import { DialogManager } from '../managers/DialogManager';
import { ToastManager } from '../managers/ToastManager';

export class DemoScene extends BaseGameScene {
  constructor() {
    super('DemoScene' as any);
  }

  protected onInit(data?: SceneInitData): void {}

  protected onPreload(): void {}

  protected onCreate(data?: SceneInitData): void {
    // ã‚¿ã‚¤ãƒˆãƒ«
    this.uiFactory.createTitleLabel({
      x: 640, y: 50,
      text: 'Phase 1 çµ±åˆãƒ‡ãƒ¢',
      size: 'large',
    });

    // ãƒœã‚¿ãƒ³ãƒ†ã‚¹ãƒˆ
    this.uiFactory.createButton({
      x: 200, y: 150,
      text: 'ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæˆåŠŸï¼‰',
      onClick: () => ToastManager.getInstance().success('æˆåŠŸã—ã¾ã—ãŸï¼'),
    });

    this.uiFactory.createButton({
      x: 400, y: 150,
      text: 'ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰',
      onClick: () => ToastManager.getInstance().error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'),
    });

    this.uiFactory.createButton({
      x: 600, y: 150,
      text: 'ãƒ€ã‚¤ã‚¢ãƒ­ã‚°',
      onClick: () => {
        DialogManager.getInstance().confirm(
          'ç¢ºèª',
          'ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ'
        ).then(result => {
          ToastManager.getInstance().info(result ? 'å®Ÿè¡Œã—ã¾ã—ãŸ' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        });
      },
    });

    // EventBusãƒ†ã‚¹ãƒˆ
    this.uiFactory.createButton({
      x: 200, y: 250,
      text: 'Gold +100',
      onClick: () => {
        this.eventBus.emit('state:gold:changed', { gold: 1100, delta: 100 });
      },
    });

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒ†ã‚¹ãƒˆ
    const progressBar = this.uiFactory.createProgressBar({
      x: 640, y: 350,
      width: 400,
      height: 24,
      value: 30,
      maxValue: 100,
      showText: true,
    });

    this.uiFactory.createButton({
      x: 640, y: 420,
      text: 'ã‚²ãƒ¼ã‚¸ +10',
      onClick: () => {
        const newValue = Math.min(100, progressBar.getValue() + 10);
        progressBar.setValue(newValue, true);
      },
    });
  }

  protected setupEventListeners(): void {
    const unsub = this.eventBus.on('state:gold:changed', (payload) => {
      ToastManager.getInstance().info(`Gold: ${payload.gold} (+${payload.delta})`);
    });
    this.subscribe(unsub);
  }
}
```

---

## ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå˜ä½“å‹•ä½œ

- [ ] EventBus: emit/on/off/once/clear
- [ ] SceneManager: goTo/replace/goBack/openOverlay/closeOverlay
- [ ] UIFactory: createButton/createLabel/createDialog/createProgressBar/createScrollPanel/createGridButtons
- [ ] DialogManager: show/confirm/alert/close/closeAll
- [ ] ToastManager: success/error/warning/info/clearAll

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé€£æº

- [ ] EventBus â†’ UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°
- [ ] UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â†’ EventBusç™ºè¡Œ
- [ ] DialogManager â†’ UIFactoryé€£æº
- [ ] ToastManager â†’ ã‚·ãƒ¼ãƒ³é€£æº

### ãƒ¡ãƒ¢ãƒªç®¡ç†

- [ ] ã‚·ãƒ¼ãƒ³ç ´æ£„æ™‚ã®ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
- [ ] ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‰ã˜æ™‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç ´æ£„
- [ ] ãƒˆãƒ¼ã‚¹ãƒˆæ¶ˆå»æ™‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç ´æ£„

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0181` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- Phaserã®ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ãŒå¿…è¦
- ä¸€éƒ¨ãƒ†ã‚¹ãƒˆã¯headlessãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œ
- æ‰‹å‹•ç¢ºèªç”¨ã®ãƒ‡ãƒ¢ã‚·ãƒ¼ãƒ³ã‚’æ´»ç”¨

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 3é …ç›® (100%)

**å“è³ªè©•ä¾¡**: è¦èª¿æŸ»
