# TASK-0246: RankUpSceneãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0246
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

RankUpSceneã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚å˜ä½“ãƒ†ã‚¹ãƒˆã¨è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0245
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0259

## å®Œäº†æ¡ä»¶

- [ ] RankUpSceneã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è¦ä»¶é”æˆåˆ¤å®šã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è©¦é¨“é€²è¡Œãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. RankUpSceneå˜ä½“ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *åŸºæœ¬ãƒ†ã‚¹ãƒˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/phaser/scenes/RankUpScene.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { RankUpScene, RankUpSceneData } from '@/presentation/phaser/scenes/RankUpScene';
import { RankExamRequirement, RankUpReward } from '@/presentation/phaser/scenes/RankUpSceneConstants';
import { createMockScene, createMockEventBus } from '@tests/utils/phaserTestUtils';

describe('RankUpScene', () => {
  let scene: RankUpScene;
  let mockEventBus: any;

  const mockRequirements: RankExamRequirement[] = [
    { type: 'quest', description: 'ä¾é ¼ã‚’10ä»¶å®Œäº†', targetValue: 10, currentValue: 10 },
    { type: 'alchemy', description: 'èª¿åˆã‚’20å›å®Ÿè¡Œ', targetValue: 20, currentValue: 15 },
    { type: 'gold', description: 'æ‰€æŒé‡‘1000G', targetValue: 1000, currentValue: 1500 },
  ];

  const mockRewards: RankUpReward[] = [
    { type: 'card', name: 'ä¸Šç´šæ¡å–åœ°ã‚«ãƒ¼ãƒ‰' },
    { type: 'artifact', name: 'éŒ¬é‡‘è¡“å¸«ã®æŒ‡è¼ª' },
    { type: 'unlock', name: 'æ–°ãƒ¬ã‚·ãƒ”è§£æ”¾' },
  ];

  const mockSceneData: RankUpSceneData = {
    currentRank: 'E',
    targetRank: 'D',
    examTitle: 'Dç´šæ˜‡æ ¼è©¦é¨“',
    examDescription: 'Dç´šéŒ¬é‡‘è¡“å¸«ã¨ã—ã¦èªã‚ã‚‰ã‚Œã‚‹ãŸã‚ã®è©¦é¨“ã§ã™ã€‚',
    requirements: [...mockRequirements],
    rewards: mockRewards,
  };

  beforeEach(() => {
    mockEventBus = createMockEventBus();
    scene = createMockScene(RankUpScene, mockSceneData, mockEventBus);
  });

  describe('åˆæœŸåŒ–', () => {
    it('ç¾åœ¨ãƒ©ãƒ³ã‚¯ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.getCurrentRank()).toBe('E');
    });

    it('ç›®æ¨™ãƒ©ãƒ³ã‚¯ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.getTargetRank()).toBe('D');
    });

    it('è¦ä»¶ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹', () => {
      expect(scene.getDisplayedRequirements()).toHaveLength(3);
    });

    it('å ±é…¬ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹', () => {
      expect(scene.getDisplayedRewards()).toHaveLength(3);
    });
  });

  describe('è¦ä»¶é”æˆåˆ¤å®š', () => {
    it('ã™ã¹ã¦é”æˆæ™‚ã¯trueã‚’è¿”ã™', () => {
      const allMetData = {
        ...mockSceneData,
        requirements: [
          { type: 'quest', description: 'test', targetValue: 10, currentValue: 10 },
          { type: 'alchemy', description: 'test', targetValue: 20, currentValue: 25 },
        ],
      };
      const testScene = createMockScene(RankUpScene, allMetData, mockEventBus);

      expect(testScene.areAllRequirementsMet()).toBe(true);
    });

    it('ä¸€éƒ¨æœªé”æˆæ™‚ã¯falseã‚’è¿”ã™', () => {
      expect(scene.areAllRequirementsMet()).toBe(false);
    });

    it('æŒ‘æˆ¦ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãŒæ­£ã—ã„', () => {
      // æœªé”æˆæ™‚ã¯ç„¡åŠ¹
      expect(scene.isChallengeButtonEnabled()).toBe(false);

      // é”æˆå¾Œã¯æœ‰åŠ¹
      scene.updateRequirement(1, 20); // èª¿åˆã‚’20ã«æ›´æ–°
      expect(scene.areAllRequirementsMet()).toBe(true);
      expect(scene.isChallengeButtonEnabled()).toBe(true);
    });
  });

  describe('é€²æ—è¨ˆç®—', () => {
    it('ç·åˆé€²æ—ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹', () => {
      // 3è¦ä»¶ä¸­2é”æˆ = 66.67%
      const progress = scene.getOverallProgress();
      expect(Math.round(progress * 100)).toBe(67);
    });

    it('å€‹åˆ¥é€²æ—ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹', () => {
      const reqProgress = scene.getRequirementProgress(1);
      expect(reqProgress).toBe(0.75); // 15/20
    });
  });
});
```

### 2. è©¦é¨“ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ*

```typescript
describe('è©¦é¨“ãƒ•ãƒ­ãƒ¼', () => {
  it('è©¦é¨“é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', async () => {
    const allMetData = {
      ...mockSceneData,
      requirements: [
        { type: 'quest', description: 'test', targetValue: 10, currentValue: 15 },
      ],
    };
    const testScene = createMockScene(RankUpScene, allMetData, mockEventBus);

    const challengeHandler = vi.fn();
    mockEventBus.on('rankup:challenge:start', challengeHandler);

    testScene.startExam();

    // éåŒæœŸå‡¦ç†ã‚’å¾…ã¤
    await vi.waitFor(() => {
      expect(challengeHandler).toHaveBeenCalled();
    });
  });

  it('è©¦é¨“è©•ä¾¡ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', async () => {
    const evaluateHandler = vi.fn();
    mockEventBus.on('rankup:exam:evaluate', evaluateHandler);

    const allMetData = {
      ...mockSceneData,
      requirements: [
        { type: 'quest', description: 'test', targetValue: 10, currentValue: 15 },
      ],
    };
    const testScene = createMockScene(RankUpScene, allMetData, mockEventBus);

    await testScene.startExam();

    expect(evaluateHandler).toHaveBeenCalled();
  });

  it('æˆåŠŸæ™‚ã«showExamSuccessãŒå‘¼ã°ã‚Œã‚‹', async () => {
    const testScene = createMockScene(RankUpScene, mockSceneData, mockEventBus);
    const successSpy = vi.spyOn(testScene, 'showExamSuccess');

    await testScene.showExamSuccess('D');

    expect(successSpy).toHaveBeenCalledWith('D');
  });

  it('å¤±æ•—æ™‚ã«showExamFailureãŒå‘¼ã°ã‚Œã‚‹', async () => {
    const testScene = createMockScene(RankUpScene, mockSceneData, mockEventBus);
    const failureSpy = vi.spyOn(testScene, 'showExamFailure');

    await testScene.showExamFailure('èª¿åˆå›æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™');

    expect(failureSpy).toHaveBeenCalled();
  });

  it('è©¦é¨“å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', () => {
    const completeHandler = vi.fn();
    mockEventBus.on('rankup:exam:complete', completeHandler);

    const allMetData = {
      ...mockSceneData,
      requirements: [
        { type: 'quest', description: 'test', targetValue: 10, currentValue: 15 },
      ],
    };
    const testScene = createMockScene(RankUpScene, allMetData, mockEventBus);

    testScene.onExamComplete();

    expect(completeHandler).toHaveBeenCalledWith({
      newRank: 'D',
      rewards: mockRewards,
    });
  });
});
```

### 3. UIæ›´æ–°ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIæ›´æ–°*

```typescript
describe('UIæ›´æ–°', () => {
  it('è¦ä»¶æ›´æ–°æ™‚ã«UIãŒå†æç”»ã•ã‚Œã‚‹', () => {
    const initialProgress = scene.getRequirementProgress(1);
    expect(initialProgress).toBe(0.75);

    scene.updateRequirement(1, 18);

    const updatedProgress = scene.getRequirementProgress(1);
    expect(updatedProgress).toBe(0.9);
  });

  it('é€²æ—ãƒãƒ¼ãŒæ­£ã—ãæ›´æ–°ã•ã‚Œã‚‹', () => {
    scene.updateRequirement(1, 20); // ã™ã¹ã¦é”æˆ

    const overallProgress = scene.getOverallProgress();
    expect(overallProgress).toBe(1);
  });

  it('é”æˆãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
    // åˆæœŸçŠ¶æ…‹ï¼š2/3é”æˆ
    expect(scene.getMetRequirementsCount()).toBe(2);

    // å…¨é”æˆ
    scene.updateRequirement(1, 20);
    expect(scene.getMetRequirementsCount()).toBe(3);
  });
});
```

### 4. è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ç›®è¦–ç¢ºèª*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/test/RankUpTestScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene } from '../BaseGameScene';
import { RankUpScene, RankUpSceneData } from '../RankUpScene';
import { RankExamRequirement, RankUpReward } from '../RankUpSceneConstants';

export class RankUpTestScene extends BaseGameScene {
  constructor() {
    super('RankUpTestScene');
  }

  protected onCreate(): void {
    this.createTestControls();
    this.launchRankUpScene('partial');
  }

  private createTestControls(): void {
    const panel = this.add.container(10, 10);

    const bg = this.add.graphics();
    bg.fillStyle(0x333333, 0.9);
    bg.fillRoundedRect(0, 0, 200, 350, 8);
    panel.add(bg);

    const title = this.add.text(100, 15, 'RankUp Test', {
      fontSize: '16px',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    panel.add(title);

    const buttons = [
      { label: 'æœªé”æˆãƒ‡ãƒ¼ã‚¿', action: () => this.launchRankUpScene('notMet') },
      { label: 'éƒ¨åˆ†é”æˆãƒ‡ãƒ¼ã‚¿', action: () => this.launchRankUpScene('partial') },
      { label: 'å…¨é”æˆãƒ‡ãƒ¼ã‚¿', action: () => this.launchRankUpScene('allMet') },
      { label: 'æˆåŠŸæ¼”å‡º', action: () => this.testSuccess() },
      { label: 'å¤±æ•—æ¼”å‡º', action: () => this.testFailure() },
      { label: 'è¦ä»¶æ›´æ–°', action: () => this.testUpdateRequirement() },
      { label: 'ãƒªãƒ­ãƒ¼ãƒ‰', action: () => this.reloadScene() },
    ];

    buttons.forEach((btn, index) => {
      const y = 50 + index * 40;
      const button = this.createTestButton(btn.label, 100, y, btn.action);
      panel.add(button);
    });

    panel.setDepth(1000);
  }

  private createTestButton(
    label: string,
    x: number,
    y: number,
    onClick: () => void
  ): Phaser.GameObjects.Container {
    const btn = this.add.container(x, y);

    const bg = this.add.graphics();
    bg.fillStyle(0x555555, 1);
    bg.fillRoundedRect(-80, -15, 160, 30, 4);
    btn.add(bg);

    const text = this.add.text(0, 0, label, {
      fontSize: '12px',
    }).setOrigin(0.5);
    btn.add(text);

    btn.setSize(160, 30);
    btn.setInteractive({ useHandCursor: true });
    btn.on('pointerdown', onClick);

    return btn;
  }

  private launchRankUpScene(type: 'notMet' | 'partial' | 'allMet'): void {
    this.scene.stop('RankUpScene');

    let requirements: RankExamRequirement[];

    switch (type) {
      case 'notMet':
        requirements = [
          { type: 'quest', description: 'ä¾é ¼ã‚’10ä»¶å®Œäº†', targetValue: 10, currentValue: 3 },
          { type: 'alchemy', description: 'èª¿åˆã‚’20å›å®Ÿè¡Œ', targetValue: 20, currentValue: 5 },
          { type: 'gold', description: 'æ‰€æŒé‡‘1000G', targetValue: 1000, currentValue: 500 },
        ];
        break;
      case 'partial':
        requirements = [
          { type: 'quest', description: 'ä¾é ¼ã‚’10ä»¶å®Œäº†', targetValue: 10, currentValue: 10 },
          { type: 'alchemy', description: 'èª¿åˆã‚’20å›å®Ÿè¡Œ', targetValue: 20, currentValue: 15 },
          { type: 'gold', description: 'æ‰€æŒé‡‘1000G', targetValue: 1000, currentValue: 1500 },
        ];
        break;
      case 'allMet':
        requirements = [
          { type: 'quest', description: 'ä¾é ¼ã‚’10ä»¶å®Œäº†', targetValue: 10, currentValue: 12 },
          { type: 'alchemy', description: 'èª¿åˆã‚’20å›å®Ÿè¡Œ', targetValue: 20, currentValue: 25 },
          { type: 'gold', description: 'æ‰€æŒé‡‘1000G', targetValue: 1000, currentValue: 2000 },
          { type: 'item', description: 'ãƒ’ãƒ¼ãƒ«ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’5å€‹ä½œæˆ', targetValue: 5, currentValue: 8 },
        ];
        break;
    }

    const rewards: RankUpReward[] = [
      { type: 'card', name: 'ä¸Šç´šæ£®ã®æ¡å–åœ°', description: 'ãƒ¬ã‚¢ç´ æãŒå‡ºã‚„ã™ã„' },
      { type: 'artifact', name: 'éŒ¬é‡‘è¡“å¸«ã®æŒ‡è¼ª', description: 'èª¿åˆæˆåŠŸç‡+5%' },
      { type: 'unlock', name: 'ä¸Šç´šãƒ¬ã‚·ãƒ”è§£æ”¾' },
    ];

    const testData: RankUpSceneData = {
      currentRank: 'E',
      targetRank: 'D',
      examTitle: 'Dç´šæ˜‡æ ¼è©¦é¨“',
      examDescription: 'Dç´šéŒ¬é‡‘è¡“å¸«ã¨ã—ã¦èªã‚ã‚‰ã‚Œã‚‹ãŸã‚ã®è©¦é¨“ã§ã™ã€‚\nåŸºæœ¬çš„ãªèª¿åˆæŠ€è¡“ã¨ä¾é ¼é‚è¡Œèƒ½åŠ›ãŒå•ã‚ã‚Œã¾ã™ã€‚',
      requirements,
      rewards,
    };

    this.scene.launch('RankUpScene', testData);
  }

  private testSuccess(): void {
    const rankUpScene = this.scene.get('RankUpScene') as RankUpScene;
    rankUpScene?.showExamSuccess('D');
  }

  private testFailure(): void {
    const rankUpScene = this.scene.get('RankUpScene') as RankUpScene;
    rankUpScene?.showExamFailure('èª¿åˆå›æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆç¾åœ¨15å›/å¿…è¦20å›ï¼‰');
  }

  private testUpdateRequirement(): void {
    const rankUpScene = this.scene.get('RankUpScene') as RankUpScene;
    // èª¿åˆå›æ•°ã‚’æ›´æ–°
    rankUpScene?.updateRequirement(1, 20);
  }

  private reloadScene(): void {
    this.scene.stop('RankUpScene');
    this.launchRankUpScene('partial');
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ ğŸ”µ

- RankUpSceneåˆæœŸåŒ–: 100%
- è¦ä»¶é”æˆåˆ¤å®š: 100%
- é€²æ—è¨ˆç®—: 100%
- è©¦é¨“ãƒ•ãƒ­ãƒ¼: 100%
- UIæ›´æ–°: 100%

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0246` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- éåŒæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•
- EventBusã®ãƒ¢ãƒƒã‚¯åŒ–
- è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
