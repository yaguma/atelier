# TASK-0166: EventBusãƒ†ã‚¹ãƒˆï¼ˆ32ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

**ã‚¿ã‚¹ã‚¯ID**: TASK-0166
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

å®šç¾©ã•ã‚ŒãŸ32ç¨®é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã™ã¹ã¦ã«ã¤ã„ã¦ã€ç™ºè¡Œãƒ»è³¼èª­ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0165
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0181

## å®Œäº†æ¡ä»¶

- [ ] å…¨UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ21ç¨®é¡ï¼‰ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] å…¨çŠ¶æ…‹æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ11ç¨®é¡ï¼‰ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãã‚¤ãƒ™ãƒ³ãƒˆã®å‹å®‰å…¨æ€§ãŒãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãªã—ã‚¤ãƒ™ãƒ³ãƒˆã®å‹•ä½œãŒãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‹ã‚‰å°å‡º*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/events/UIActionEvents.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { EventBus } from '../../../../src/presentation/phaser/events/EventBus';
import { UIActionEvents } from '../../../../src/presentation/phaser/events/EventTypes';

describe('UIActionEvents', () => {
  let eventBus: EventBus;

  beforeEach(() => {
    EventBus.resetInstance();
    eventBus = EventBus.getInstance();
  });

  describe('ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ', () => {
    it('NEW_GAME_CLICKEDãŒç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.onVoid(UIActionEvents.NEW_GAME_CLICKED, callback);
      eventBus.emitVoid(UIActionEvents.NEW_GAME_CLICKED);
      expect(callback).toHaveBeenCalledTimes(1);
    });

    it('CONTINUE_CLICKEDãŒç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.onVoid(UIActionEvents.CONTINUE_CLICKED, callback);
      eventBus.emitVoid(UIActionEvents.CONTINUE_CLICKED);
      expect(callback).toHaveBeenCalledTimes(1);
    });
  });

  describe('ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ', () => {
    it('QUEST_SELECTEDãŒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãã§ç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.on('ui:quest:selected', callback);
      eventBus.emit('ui:quest:selected', { questId: 'quest-001' });
      expect(callback).toHaveBeenCalledWith({ questId: 'quest-001' });
    });
    // ... ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚åŒæ§˜
  });

  // ... å…¨21ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ãƒ†ã‚¹ãƒˆ
});
```

### 2. çŠ¶æ…‹æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‹ã‚‰å°å‡º*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/events/StateUpdateEvents.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { EventBus } from '../../../../src/presentation/phaser/events/EventBus';
import { StateUpdateEvents } from '../../../../src/presentation/phaser/events/EventTypes';

describe('StateUpdateEvents', () => {
  let eventBus: EventBus;

  beforeEach(() => {
    EventBus.resetInstance();
    eventBus = EventBus.getInstance();
  });

  describe('ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚¤ãƒ™ãƒ³ãƒˆ', () => {
    it('GAME_STATE_CHANGEDãŒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãã§ç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.on('state:game:changed', callback);
      eventBus.emit('state:game:changed', { state: 'playing' });
      expect(callback).toHaveBeenCalledWith({ state: 'playing' });
    });

    it('PHASE_CHANGEDãŒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãã§ç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.on('state:phase:changed', callback);
      eventBus.emit('state:phase:changed', {
        phase: 'gathering',
        previousPhase: 'questAccept'
      });
      expect(callback).toHaveBeenCalledWith({
        phase: 'gathering',
        previousPhase: 'questAccept'
      });
    });
  });

  describe('ãƒªã‚½ãƒ¼ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ', () => {
    it('GOLD_CHANGEDãŒæ­£ã—ã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ç™ºè¡Œã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.on('state:gold:changed', callback);
      eventBus.emit('state:gold:changed', { gold: 1500, delta: 100 });
      expect(callback).toHaveBeenCalledWith({ gold: 1500, delta: 100 });
    });
    // ... ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚åŒæ§˜
  });

  // ... å…¨11ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ãƒ†ã‚¹ãƒˆ
});
```

### 3. ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *è‡ªå‹•æ¤œè¨¼*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/events/EventCompleteness.test.ts`

```typescript
import { describe, it, expect } from 'vitest';
import { UIActionEvents, StateUpdateEvents } from '../../../../src/presentation/phaser/events/EventTypes';

describe('ã‚¤ãƒ™ãƒ³ãƒˆå®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯', () => {
  it('UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯21ç¨®é¡ã‚ã‚‹', () => {
    const count = Object.keys(UIActionEvents).length;
    expect(count).toBe(21);
  });

  it('çŠ¶æ…‹æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã¯11ç¨®é¡ã‚ã‚‹', () => {
    const count = Object.keys(StateUpdateEvents).length;
    expect(count).toBe(11);
  });

  it('åˆè¨ˆ32ã‚¤ãƒ™ãƒ³ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹', () => {
    const total = Object.keys(UIActionEvents).length + Object.keys(StateUpdateEvents).length;
    expect(total).toBe(32);
  });

  it('ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¼ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã‚ã‚‹', () => {
    const allKeys = [
      ...Object.values(UIActionEvents),
      ...Object.values(StateUpdateEvents)
    ];
    const uniqueKeys = new Set(allKeys);
    expect(uniqueKeys.size).toBe(allKeys.length);
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0166` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å„ãƒ†ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹
- beforeEachã§EventBusã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
- ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å‹ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 3é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
