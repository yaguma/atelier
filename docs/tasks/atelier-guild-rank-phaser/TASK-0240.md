# TASK-0240: ShopSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0240
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚·ãƒ§ãƒƒãƒ—ã‚·ãƒ¼ãƒ³ã®åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚ã‚«ãƒ¼ãƒ‰ã€ç´ æã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®è³¼å…¥UIã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0170, TASK-0177
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0241

## å®Œäº†æ¡ä»¶

- [ ] ShopSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ§ãƒƒãƒ—ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å•†å“ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹
- [ ] è³¼å…¥ç¢ºèªã‚¨ãƒªã‚¢ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ShopSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šæ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIè¨­è¨ˆæ›¸*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/ShopSceneConstants.ts`

```typescript
export const ShopSceneLayout = {
  // ç”»é¢ã‚µã‚¤ã‚º
  SCREEN_WIDTH: 1024,
  SCREEN_HEIGHT: 768,

  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ‰€æŒé‡‘è¡¨ç¤ºï¼‰
  HEADER: {
    X: 0,
    Y: 0,
    WIDTH: 1024,
    HEIGHT: 60,
  },

  // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–
  CATEGORY_TAB: {
    X: 50,
    Y: 80,
    WIDTH: 924,
    HEIGHT: 50,
    TAB_WIDTH: 150,
    TAB_HEIGHT: 40,
  },

  // å•†å“ãƒªã‚¹ãƒˆ
  ITEM_LIST: {
    X: 50,
    Y: 150,
    WIDTH: 600,
    HEIGHT: 500,
  },

  // å•†å“è©³ç´°ãƒ»è³¼å…¥ã‚¨ãƒªã‚¢
  DETAIL_AREA: {
    X: 670,
    Y: 150,
    WIDTH: 304,
    HEIGHT: 400,
  },

  // è³¼å…¥ç¢ºèªãƒœã‚¿ãƒ³
  PURCHASE_BUTTON: {
    X: 770,
    Y: 570,
    WIDTH: 200,
    HEIGHT: 50,
  },

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³
  BACK_BUTTON: {
    X: 50,
    Y: 680,
    WIDTH: 120,
    HEIGHT: 40,
  },
} as const;

export type ShopCategory = 'cards' | 'materials' | 'artifacts';
```

### 2. ShopSceneåŸºæœ¬æ§‹é€  ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚·ãƒ¼ãƒ³è¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/ShopScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { ShopSceneLayout, ShopCategory } from './ShopSceneConstants';
import { SceneKeys } from '../config/SceneKeys';
import { UIFactory } from '../ui/UIFactory';
import { Colors } from '../config/ColorPalette';
import { TextStyles } from '../config/TextStyles';

export interface ShopSceneData extends SceneInitData {
  playerGold: number;
  availableCards?: any[];
  availableMaterials?: any[];
  availableArtifacts?: any[];
  returnScene?: string;
}

export class ShopScene extends BaseGameScene {
  // UIè¦ç´ 
  private goldDisplay!: Phaser.GameObjects.Container;
  private categoryTabs!: Map<ShopCategory, Phaser.GameObjects.Container>;
  private itemListPanel!: any; // ScrollablePanel
  private detailPanel!: Phaser.GameObjects.Container;
  private purchaseButton!: Phaser.GameObjects.Container;
  private backButton!: Phaser.GameObjects.Container;

  // çŠ¶æ…‹
  private currentCategory: ShopCategory = 'cards';
  private selectedItem: any = null;
  private playerGold: number = 0;
  private shopData: ShopSceneData = {} as ShopSceneData;

  constructor() {
    super(SceneKeys.SHOP);
  }

  protected onInit(data?: ShopSceneData): void {
    if (data) {
      this.shopData = data;
      this.playerGold = data.playerGold ?? 0;
    }
  }

  protected onPreload(): void {
    // ã‚·ãƒ§ãƒƒãƒ—å›ºæœ‰ã‚¢ã‚»ãƒƒãƒˆ
  }

  protected onCreate(data?: ShopSceneData): void {
    this.createBackground();
    this.createHeader();
    this.createCategoryTabs();
    this.createItemList();
    this.createDetailPanel();
    this.createPurchaseButton();
    this.createBackButton();

    // åˆæœŸã‚«ãƒ†ã‚´ãƒªè¡¨ç¤º
    this.switchCategory('cards');
  }

  private createBackground(): void {
    const bg = this.add.graphics();
    bg.fillStyle(Colors.backgroundDark, 1);
    bg.fillRect(0, 0, ShopSceneLayout.SCREEN_WIDTH, ShopSceneLayout.SCREEN_HEIGHT);
  }

  private createHeader(): void {
    const { HEADER } = ShopSceneLayout;

    // ãƒ˜ãƒƒãƒ€ãƒ¼èƒŒæ™¯
    const headerBg = this.add.graphics();
    headerBg.fillStyle(Colors.panelBackground, 1);
    headerBg.fillRect(HEADER.X, HEADER.Y, HEADER.WIDTH, HEADER.HEIGHT);

    // ã‚¿ã‚¤ãƒˆãƒ«
    this.add.text(HEADER.WIDTH / 2, HEADER.HEIGHT / 2, 'ã‚·ãƒ§ãƒƒãƒ—', {
      ...TextStyles.title,
    }).setOrigin(0.5);

    // æ‰€æŒé‡‘è¡¨ç¤º
    this.goldDisplay = this.add.container(HEADER.WIDTH - 100, HEADER.HEIGHT / 2);

    const goldIcon = this.add.text(-50, 0, 'ğŸ’°', { fontSize: '20px' }).setOrigin(0.5);
    const goldText = this.add.text(0, 0, `${this.playerGold} G`, {
      ...TextStyles.body,
      fontSize: '18px',
    }).setOrigin(0.5);
    goldText.setName('goldText');

    this.goldDisplay.add([goldIcon, goldText]);
  }

  private createCategoryTabs(): void {
    const { CATEGORY_TAB } = ShopSceneLayout;

    this.categoryTabs = new Map();

    const categories: { key: ShopCategory; label: string }[] = [
      { key: 'cards', label: 'ã‚«ãƒ¼ãƒ‰' },
      { key: 'materials', label: 'ç´ æ' },
      { key: 'artifacts', label: 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ' },
    ];

    categories.forEach((cat, index) => {
      const x = CATEGORY_TAB.X + index * (CATEGORY_TAB.TAB_WIDTH + 10);
      const tab = this.createCategoryTab(cat.key, cat.label, x, CATEGORY_TAB.Y);
      this.categoryTabs.set(cat.key, tab);
    });
  }

  private createCategoryTab(
    category: ShopCategory,
    label: string,
    x: number,
    y: number
  ): Phaser.GameObjects.Container {
    const { CATEGORY_TAB } = ShopSceneLayout;

    const container = this.add.container(x, y);

    const bg = this.add.graphics();
    bg.fillStyle(Colors.buttonNormal, 1);
    bg.fillRoundedRect(0, 0, CATEGORY_TAB.TAB_WIDTH, CATEGORY_TAB.TAB_HEIGHT, 8);
    bg.setName('bg');
    container.add(bg);

    const text = this.add.text(
      CATEGORY_TAB.TAB_WIDTH / 2,
      CATEGORY_TAB.TAB_HEIGHT / 2,
      label,
      { ...TextStyles.body }
    ).setOrigin(0.5);
    container.add(text);

    container.setSize(CATEGORY_TAB.TAB_WIDTH, CATEGORY_TAB.TAB_HEIGHT);
    container.setInteractive({ useHandCursor: true });

    container.on('pointerover', () => {
      if (this.currentCategory !== category) {
        bg.clear();
        bg.fillStyle(Colors.buttonHover, 1);
        bg.fillRoundedRect(0, 0, CATEGORY_TAB.TAB_WIDTH, CATEGORY_TAB.TAB_HEIGHT, 8);
      }
    });

    container.on('pointerout', () => {
      if (this.currentCategory !== category) {
        bg.clear();
        bg.fillStyle(Colors.buttonNormal, 1);
        bg.fillRoundedRect(0, 0, CATEGORY_TAB.TAB_WIDTH, CATEGORY_TAB.TAB_HEIGHT, 8);
      }
    });

    container.on('pointerdown', () => {
      this.switchCategory(category);
    });

    return container;
  }

  private createItemList(): void {
    const { ITEM_LIST } = ShopSceneLayout;

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ‘ãƒãƒ«
    this.itemListPanel = this.rexUI.add.scrollablePanel({
      x: ITEM_LIST.X,
      y: ITEM_LIST.Y,
      width: ITEM_LIST.WIDTH,
      height: ITEM_LIST.HEIGHT,
      scrollMode: 0, // vertical

      background: this.rexUI.add.roundRectangle(0, 0, 0, 0, 8, Colors.panelBackground),

      panel: {
        child: this.createItemListContent([]),
        mask: { padding: 1 },
      },

      slider: {
        track: this.rexUI.add.roundRectangle(0, 0, 10, 0, 5, Colors.backgroundMedium),
        thumb: this.rexUI.add.roundRectangle(0, 0, 10, 40, 5, Colors.primary),
      },

      space: { left: 10, right: 10, top: 10, bottom: 10, panel: 10 },
    }).setOrigin(0, 0).layout();
  }

  private createItemListContent(items: any[]): any {
    const sizer = this.rexUI.add.sizer({
      orientation: 'y',
      space: { item: 8 },
    });

    items.forEach(item => {
      const itemRow = this.createShopItemRow(item);
      sizer.add(itemRow);
    });

    return sizer;
  }

  private createShopItemRow(item: any): Phaser.GameObjects.Container {
    const container = this.add.container(0, 0);

    // èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(Colors.backgroundMedium, 1);
    bg.fillRoundedRect(0, 0, 560, 60, 8);
    container.add(bg);

    // åå‰
    const name = this.add.text(20, 20, item.name, {
      ...TextStyles.body,
      fontSize: '16px',
    });
    container.add(name);

    // ä¾¡æ ¼
    const price = this.add.text(480, 20, `${item.price} G`, {
      ...TextStyles.body,
      fontSize: '16px',
      color: item.price > this.playerGold ? '#ff4444' : '#ffffff',
    });
    container.add(price);

    container.setSize(560, 60);
    container.setInteractive({ useHandCursor: true });

    container.on('pointerdown', () => {
      this.selectItem(item);
    });

    return container;
  }

  private createDetailPanel(): void {
    const { DETAIL_AREA } = ShopSceneLayout;

    this.detailPanel = this.add.container(DETAIL_AREA.X, DETAIL_AREA.Y);

    // èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(Colors.panelBackground, 1);
    bg.fillRoundedRect(0, 0, DETAIL_AREA.WIDTH, DETAIL_AREA.HEIGHT, 8);
    bg.lineStyle(1, Colors.panelBorder);
    bg.strokeRoundedRect(0, 0, DETAIL_AREA.WIDTH, DETAIL_AREA.HEIGHT, 8);
    this.detailPanel.add(bg);

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const placeholder = this.add.text(
      DETAIL_AREA.WIDTH / 2,
      DETAIL_AREA.HEIGHT / 2,
      'å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„',
      { ...TextStyles.body, color: '#888888' }
    ).setOrigin(0.5);
    placeholder.setName('placeholder');
    this.detailPanel.add(placeholder);
  }

  private createPurchaseButton(): void {
    const { PURCHASE_BUTTON } = ShopSceneLayout;

    this.purchaseButton = UIFactory.createButton(this, {
      x: PURCHASE_BUTTON.X,
      y: PURCHASE_BUTTON.Y,
      width: PURCHASE_BUTTON.WIDTH,
      height: PURCHASE_BUTTON.HEIGHT,
      text: 'è³¼å…¥',
      onClick: () => this.handlePurchase(),
    });

    this.purchaseButton.setVisible(false);
  }

  private createBackButton(): void {
    const { BACK_BUTTON } = ShopSceneLayout;

    this.backButton = UIFactory.createButton(this, {
      x: BACK_BUTTON.X,
      y: BACK_BUTTON.Y,
      width: BACK_BUTTON.WIDTH,
      height: BACK_BUTTON.HEIGHT,
      text: 'æˆ»ã‚‹',
      onClick: () => this.handleBack(),
    });
  }

  // ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ
  switchCategory(category: ShopCategory): void {
    this.currentCategory = category;

    // ã‚¿ãƒ–çŠ¶æ…‹æ›´æ–°
    this.categoryTabs.forEach((tab, key) => {
      const bg = tab.getByName('bg') as Phaser.GameObjects.Graphics;
      bg.clear();
      if (key === category) {
        bg.fillStyle(Colors.primary, 1);
      } else {
        bg.fillStyle(Colors.buttonNormal, 1);
      }
      bg.fillRoundedRect(
        0, 0,
        ShopSceneLayout.CATEGORY_TAB.TAB_WIDTH,
        ShopSceneLayout.CATEGORY_TAB.TAB_HEIGHT,
        8
      );
    });

    // å•†å“ãƒªã‚¹ãƒˆæ›´æ–°
    this.updateItemList();

    // é¸æŠè§£é™¤
    this.selectedItem = null;
    this.updateDetailPanel();
  }

  private updateItemList(): void {
    // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ãŸå•†å“ãƒªã‚¹ãƒˆå–å¾—
    let items: any[] = [];
    switch (this.currentCategory) {
      case 'cards':
        items = this.shopData.availableCards ?? [];
        break;
      case 'materials':
        items = this.shopData.availableMaterials ?? [];
        break;
      case 'artifacts':
        items = this.shopData.availableArtifacts ?? [];
        break;
    }

    // ãƒªã‚¹ãƒˆå†æ§‹ç¯‰
    const content = this.createItemListContent(items);
    this.itemListPanel.setChildrenMap({ panel: content });
    this.itemListPanel.layout();
  }

  // å•†å“é¸æŠ
  selectItem(item: any): void {
    this.selectedItem = item;
    this.updateDetailPanel();
    this.purchaseButton.setVisible(true);
  }

  private updateDetailPanel(): void {
    // æ—¢å­˜å†…å®¹ã‚¯ãƒªã‚¢
    this.detailPanel.each((child: Phaser.GameObjects.GameObject) => {
      if (child.name !== 'placeholder') {
        // èƒŒæ™¯ä»¥å¤–ã‚’å‰Šé™¤
      }
    });

    if (!this.selectedItem) {
      const placeholder = this.detailPanel.getByName('placeholder') as Phaser.GameObjects.Text;
      if (placeholder) {
        placeholder.setVisible(true);
      }
      return;
    }

    const placeholder = this.detailPanel.getByName('placeholder') as Phaser.GameObjects.Text;
    if (placeholder) {
      placeholder.setVisible(false);
    }

    // é¸æŠå•†å“ã®è©³ç´°è¡¨ç¤º
    const { DETAIL_AREA } = ShopSceneLayout;

    const nameText = this.add.text(20, 20, this.selectedItem.name, {
      ...TextStyles.heading,
    });
    this.detailPanel.add(nameText);

    const priceText = this.add.text(20, 60, `ä¾¡æ ¼: ${this.selectedItem.price} G`, {
      ...TextStyles.body,
      color: this.selectedItem.price > this.playerGold ? '#ff4444' : '#00ff00',
    });
    this.detailPanel.add(priceText);

    if (this.selectedItem.description) {
      const descText = this.add.text(20, 100, this.selectedItem.description, {
        ...TextStyles.body,
        wordWrap: { width: DETAIL_AREA.WIDTH - 40 },
      });
      this.detailPanel.add(descText);
    }
  }

  // è³¼å…¥å‡¦ç†
  private handlePurchase(): void {
    if (!this.selectedItem) return;
    if (this.selectedItem.price > this.playerGold) {
      this.showToast('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    this.eventBus.emit('shop:purchase:requested', {
      item: this.selectedItem,
      category: this.currentCategory,
    });
  }

  // æˆ»ã‚‹å‡¦ç†
  private handleBack(): void {
    const returnScene = this.shopData.returnScene ?? SceneKeys.MAIN;
    this.sceneManager.switchTo(returnScene);
  }

  // æ‰€æŒé‡‘æ›´æ–°
  updateGold(newGold: number): void {
    this.playerGold = newGold;
    const goldText = this.goldDisplay.getByName('goldText') as Phaser.GameObjects.Text;
    if (goldText) {
      goldText.setText(`${this.playerGold} G`);
    }
    this.updateDetailPanel();
  }

  // è³¼å…¥å®Œäº†é€šçŸ¥
  onPurchaseComplete(item: any): void {
    this.showToast(`${item.name}ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`, 'success');
    this.updateItemList();
    this.selectedItem = null;
    this.updateDetailPanel();
    this.purchaseButton.setVisible(false);
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚·ãƒ¼ãƒ³åˆæœŸåŒ– ğŸ”µ

**Given**: ShopSceneã‚’èµ·å‹•
**When**: createãŒå®Œäº†
**Then**: ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã€å•†å“ãƒªã‚¹ãƒˆã€è©³ç´°ãƒ‘ãƒãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ ğŸ”µ

**Given**: ShopSceneãŒèµ·å‹•ã—ã¦ã„ã‚‹
**When**: ç´ æã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: ç´ æã‚«ãƒ†ã‚´ãƒªã®å•†å“ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å•†å“é¸æŠ ğŸ”µ

**Given**: å•†å“ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: å•†å“ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: è©³ç´°ãƒ‘ãƒãƒ«ã«å•†å“æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0240` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- è³¼å…¥ä¸å¯æ™‚ã®ä¾¡æ ¼è¡¨ç¤ºï¼ˆèµ¤è‰²ï¼‰
- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è¡¨ç¤ºå½¢å¼ã®é•ã„

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 2é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
