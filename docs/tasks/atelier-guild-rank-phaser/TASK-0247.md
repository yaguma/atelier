# TASK-0247: GameOverSceneå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0247
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã€‚å¤±æ•—ç†ç”±ã®è¡¨ç¤ºã¨å†æŒ‘æˆ¦ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹æ©Ÿèƒ½ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0170, TASK-0173
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0249

## å®Œäº†æ¡ä»¶

- [ ] ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å¤±æ•—ç†ç”±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å†æŒ‘æˆ¦ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] æ¼”å‡ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. GameOverSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIè¨­è¨ˆæ›¸*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/GameOverScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { SceneKeys } from '../config/SceneKeys';
import { UIFactory } from '../ui/UIFactory';
import { Colors } from '../config/ColorPalette';
import { TextStyles } from '../config/TextStyles';

export interface GameOverSceneData extends SceneInitData {
  reason: string;
  finalDay: number;
  finalRank: string;
  totalQuests: number;
  totalAlchemy: number;
}

export class GameOverScene extends BaseGameScene {
  private sceneData!: GameOverSceneData;
  private mainContainer!: Phaser.GameObjects.Container;

  constructor() {
    super(SceneKeys.GAME_OVER);
  }

  protected onInit(data?: GameOverSceneData): void {
    if (data) {
      this.sceneData = data;
    }
  }

  protected onPreload(): void {
    // GameOverSceneå›ºæœ‰ã‚¢ã‚»ãƒƒãƒˆ
  }

  protected onCreate(data?: GameOverSceneData): void {
    this.createBackground();
    this.createMainContent();
    this.playEntranceAnimation();
  }

  private createBackground(): void {
    // æš—ã„èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(0x1a0000, 1);
    bg.fillRect(0, 0, 1024, 768);

    // æš—ã„éœ§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    for (let i = 0; i < 5; i++) {
      const fog = this.add.graphics();
      fog.fillStyle(0x330000, 0.3);
      fog.fillCircle(
        Phaser.Math.Between(0, 1024),
        Phaser.Math.Between(0, 768),
        Phaser.Math.Between(100, 300)
      );
    }
  }

  private createMainContent(): void {
    this.mainContainer = this.add.container(512, 384);
    this.mainContainer.setAlpha(0);

    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
    const gameOverText = this.add.text(0, -200, 'GAME OVER', {
      fontSize: '64px',
      fontStyle: 'bold',
      color: '#ff4444',
    }).setOrigin(0.5);
    this.mainContainer.add(gameOverText);

    // å¤±æ•—ç†ç”±
    const reasonText = this.add.text(0, -100, this.sceneData.reason, {
      ...TextStyles.body,
      fontSize: '20px',
      color: '#ff8888',
      wordWrap: { width: 600 },
      align: 'center',
    }).setOrigin(0.5);
    this.mainContainer.add(reasonText);

    // çµ±è¨ˆãƒ‘ãƒãƒ«
    const statsPanel = this.createStatsPanel();
    statsPanel.setY(30);
    this.mainContainer.add(statsPanel);

    // ãƒœã‚¿ãƒ³
    const retryButton = UIFactory.createButton(this, {
      x: -100,
      y: 200,
      width: 180,
      height: 50,
      text: 'æœ€åˆã‹ã‚‰',
      onClick: () => this.handleRetry(),
    });
    this.mainContainer.add(retryButton);

    const titleButton = UIFactory.createButton(this, {
      x: 100,
      y: 200,
      width: 180,
      height: 50,
      text: 'ã‚¿ã‚¤ãƒˆãƒ«ã¸',
      style: 'secondary',
      onClick: () => this.handleTitle(),
    });
    this.mainContainer.add(titleButton);
  }

  private createStatsPanel(): Phaser.GameObjects.Container {
    const panel = this.add.container(0, 0);

    // ãƒ‘ãƒãƒ«èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(0x330000, 0.8);
    bg.fillRoundedRect(-200, -80, 400, 160, 8);
    bg.lineStyle(1, 0xff4444, 0.5);
    bg.strokeRoundedRect(-200, -80, 400, 160, 8);
    panel.add(bg);

    // çµ±è¨ˆæƒ…å ±
    const stats = [
      { label: 'åˆ°é”æ—¥æ•°', value: `${this.sceneData.finalDay} æ—¥ç›®` },
      { label: 'æœ€çµ‚ãƒ©ãƒ³ã‚¯', value: this.sceneData.finalRank },
      { label: 'å®Œäº†ä¾é ¼', value: `${this.sceneData.totalQuests} ä»¶` },
      { label: 'èª¿åˆå›æ•°', value: `${this.sceneData.totalAlchemy} å›` },
    ];

    stats.forEach((stat, index) => {
      const y = -50 + index * 35;

      const label = this.add.text(-150, y, stat.label, {
        ...TextStyles.body,
        fontSize: '14px',
        color: '#888888',
      });
      panel.add(label);

      const value = this.add.text(150, y, stat.value, {
        ...TextStyles.body,
        fontSize: '16px',
        color: '#ffffff',
      }).setOrigin(1, 0);
      panel.add(value);
    });

    return panel;
  }

  private async playEntranceAnimation(): Promise<void> {
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    this.tweens.add({
      targets: this.mainContainer,
      alpha: 1,
      duration: 500,
      ease: 'Power2.easeOut',
    });

    // ç”»é¢æºã‚Œ
    await this.delay(100);
    this.cameras.main.shake(300, 0.02);
  }

  private handleRetry(): void {
    this.eventBus.emit('game:restart');
    this.sceneManager.switchTo(SceneKeys.BOOT);
  }

  private handleTitle(): void {
    this.sceneManager.switchTo(SceneKeys.TITLE);
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => this.time.delayedCall(ms, resolve));
  }
}
```

### 2. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ¡ä»¶åˆ¥è¡¨ç¤º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¡ä»¶åˆ†å²*

```typescript
// GameOverSceneã«è¿½åŠ 

interface GameOverReason {
  type: 'deadline' | 'bankruptcy' | 'rankDown';
  title: string;
  description: string;
  icon: string;
}

private getGameOverReason(): GameOverReason {
  // sceneData.reasonã‹ã‚‰åˆ¤å®š
  const reason = this.sceneData.reason;

  if (reason.includes('æœŸé™') || reason.includes('æ—¥æ•°')) {
    return {
      type: 'deadline',
      title: 'æœŸé™åˆ‡ã‚Œ',
      description: 'æŒ‡å®šã•ã‚ŒãŸæ—¥æ•°å†…ã«Sç´šã«åˆ°é”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
      icon: 'â°',
    };
  }

  if (reason.includes('æ‰€æŒé‡‘') || reason.includes('ã‚´ãƒ¼ãƒ«ãƒ‰')) {
    return {
      type: 'bankruptcy',
      title: 'è³‡é‡‘ä¸è¶³',
      description: 'æ´»å‹•ã«å¿…è¦ãªè³‡é‡‘ãŒåº•ã‚’ã¤ãã¾ã—ãŸã€‚',
      icon: 'ğŸ’¸',
    };
  }

  if (reason.includes('ãƒ©ãƒ³ã‚¯') || reason.includes('é™æ ¼')) {
    return {
      type: 'rankDown',
      title: 'ãƒ©ãƒ³ã‚¯é™æ ¼',
      description: 'ã‚®ãƒ«ãƒ‰ã‹ã‚‰ã®é™¤åå‡¦åˆ†ã‚’å—ã‘ã¾ã—ãŸã€‚',
      icon: 'ğŸ“‰',
    };
  }

  return {
    type: 'deadline',
    title: 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼',
    description: reason,
    icon: 'âŒ',
  };
}

private createDetailedReason(): Phaser.GameObjects.Container {
  const container = this.add.container(0, -80);
  const reasonInfo = this.getGameOverReason();

  // ã‚¢ã‚¤ã‚³ãƒ³
  const icon = this.add.text(0, -40, reasonInfo.icon, {
    fontSize: '48px',
  }).setOrigin(0.5);
  container.add(icon);

  // ã‚¿ã‚¤ãƒˆãƒ«
  const title = this.add.text(0, 10, reasonInfo.title, {
    ...TextStyles.heading,
    fontSize: '24px',
    color: '#ff6666',
  }).setOrigin(0.5);
  container.add(title);

  // èª¬æ˜
  const desc = this.add.text(0, 50, reasonInfo.description, {
    ...TextStyles.body,
    fontSize: '16px',
    color: '#aaaaaa',
    wordWrap: { width: 500 },
    align: 'center',
  }).setOrigin(0.5);
  container.add(desc);

  return container;
}
```

### 3. æ¼”å‡ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦–è¦šåŠ¹æœ*

```typescript
// GameOverSceneã«è¿½åŠ 

private createDramaticEffect(): void {
  // èµ¤ã„ãƒ“ãƒãƒƒãƒˆåŠ¹æœ
  const vignette = this.add.graphics();
  vignette.fillStyle(0xff0000, 0.3);

  // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒãƒƒãƒˆ
  const gradientRadius = 600;
  for (let i = 0; i < 10; i++) {
    const alpha = 0.1 * (i / 10);
    vignette.fillStyle(0x000000, alpha);
    vignette.fillCircle(512, 384, gradientRadius - i * 40);
  }

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆè½ä¸‹ã™ã‚‹ç°ï¼‰
  this.createAshParticles();
}

private createAshParticles(): void {
  for (let i = 0; i < 30; i++) {
    const ash = this.add.graphics();
    ash.fillStyle(0x666666, 0.5);
    ash.fillCircle(0, 0, Phaser.Math.Between(2, 5));
    ash.x = Phaser.Math.Between(0, 1024);
    ash.y = Phaser.Math.Between(-50, -10);

    this.tweens.add({
      targets: ash,
      y: 800,
      x: ash.x + Phaser.Math.Between(-100, 100),
      alpha: 0,
      duration: Phaser.Math.Between(3000, 6000),
      delay: Phaser.Math.Between(0, 2000),
      repeat: -1,
      onRepeat: () => {
        ash.x = Phaser.Math.Between(0, 1024);
        ash.y = -10;
        ash.setAlpha(0.5);
      },
    });
  }
}

// BGMãƒ»åŠ¹æœéŸ³ï¼ˆå°†æ¥çš„ã«è¿½åŠ ï¼‰
private playGameOverSound(): void {
  // this.sound.play('game_over_sfx');
  // this.sound.play('game_over_bgm', { loop: true, volume: 0.5 });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚·ãƒ¼ãƒ³åˆæœŸåŒ– ğŸ”µ

**Given**: GameOverSceneã‚’èµ·å‹•
**When**: createãŒå®Œäº†
**Then**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: çµ±è¨ˆè¡¨ç¤º ğŸ”µ

**Given**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
**When**: ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
**Then**: åˆ°é”æ—¥æ•°ã€ãƒ©ãƒ³ã‚¯ã€ä¾é ¼æ•°ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ ğŸ”µ

**Given**: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: æœ€åˆã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: game:restartã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0247` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å¤±æ•—ç†ç”±ã®ç¨®é¡ã«å¿œã˜ãŸè¡¨ç¤º
- æ¼”å‡ºã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ï¼ˆæ¶ˆå»ç¢ºèªï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
