# TASK-0214: QuestPanelè¨­è¨ˆãƒ»å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0214
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ä¾é ¼ã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã€‚ä¾é ¼åã€æœŸé™ã€å ±é…¬ã€å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0177
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0215

## å®Œäº†æ¡ä»¶

- [ ] IQuestPanelã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ä¾é ¼åãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æœŸé™ã¨æ®‹ã‚Šæ—¥æ•°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å ±é…¬ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ã€çµŒé¨“å€¤ã€ã‚«ãƒ¼ãƒ‰ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é€²æ—çŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. QuestPanelå®šæ•° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ä¾é ¼è¡¨ç¤º*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/quest/QuestPanelConstants.ts`

```typescript
export const QuestPanelLayout = {
  WIDTH: 400,
  HEIGHT: 500,
  PADDING: 15,

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  HEADER_HEIGHT: 60,
  REWARD_HEIGHT: 80,
  REQUIREMENT_HEIGHT: 200,
  PROGRESS_HEIGHT: 60,
} as const;

export const QuestDifficultyColors: Record<string, number> = {
  'easy': 0x00aa00,
  'normal': 0x0088ff,
  'hard': 0xaa00ff,
  'expert': 0xff4400,
};
```

### 2. IQuestPanelã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/quest/IQuestPanel.ts`

```typescript
import Phaser from 'phaser';
import { Quest } from '../../../../domain/quest/Quest';

export interface QuestPanelOptions {
  x?: number;
  y?: number;
  width?: number;
  height?: number;
  onAccept?: (quest: Quest) => void;
  onReject?: (quest: Quest) => void;
  onDeliver?: (quest: Quest) => void;
}

export interface IQuestPanel {
  readonly container: Phaser.GameObjects.Container;

  // ä¾é ¼è¨­å®š
  setQuest(quest: Quest | null): void;
  getQuest(): Quest | null;

  // é€²æ—æ›´æ–°
  updateProgress(progress: QuestProgress): void;

  // ãƒœã‚¿ãƒ³åˆ¶å¾¡
  setAcceptEnabled(enabled: boolean): void;
  setDeliverEnabled(enabled: boolean): void;
  showDeliverButton(show: boolean): void;

  // è¡¨ç¤ºåˆ¶å¾¡
  setVisible(visible: boolean): void;

  // ç ´æ£„
  destroy(): void;
}

export interface QuestProgress {
  items: Array<{
    itemId: string;
    required: number;
    current: number;
  }>;
  isComplete: boolean;
}
```

### 3. QuestPanelå®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ä¾é ¼ãƒ‘ãƒãƒ«*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/quest/QuestPanel.ts`

```typescript
import Phaser from 'phaser';
import { Quest } from '../../../../domain/quest/Quest';
import { IQuestPanel, QuestPanelOptions, QuestProgress } from './IQuestPanel';
import { QuestPanelLayout, QuestDifficultyColors } from './QuestPanelConstants';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class QuestPanel implements IQuestPanel {
  public readonly container: Phaser.GameObjects.Container;

  private scene: Phaser.Scene;
  private quest: Quest | null = null;
  private width: number;
  private height: number;

  // UIè¦ç´ 
  private background!: Phaser.GameObjects.Graphics;
  private questNameText!: Phaser.GameObjects.Text;
  private deadlineText!: Phaser.GameObjects.Text;
  private difficultyBadge!: Phaser.GameObjects.Container;
  private rewardSection!: Phaser.GameObjects.Container;
  private requirementSection!: Phaser.GameObjects.Container;
  private progressSection!: Phaser.GameObjects.Container;
  private acceptButton!: Phaser.GameObjects.Container;
  private deliverButton!: Phaser.GameObjects.Container;

  private onAccept?: (quest: Quest) => void;
  private onReject?: (quest: Quest) => void;
  private onDeliver?: (quest: Quest) => void;

  constructor(scene: Phaser.Scene, options: QuestPanelOptions = {}) {
    this.scene = scene;
    this.width = options.width ?? QuestPanelLayout.WIDTH;
    this.height = options.height ?? QuestPanelLayout.HEIGHT;
    this.onAccept = options.onAccept;
    this.onReject = options.onReject;
    this.onDeliver = options.onDeliver;

    const x = options.x ?? 0;
    const y = options.y ?? 0;

    this.container = scene.add.container(x, y);
    this.container.setDepth(250);

    this.createBackground();
    this.createHeader();
    this.createRewardSection();
    this.createRequirementSection();
    this.createProgressSection();
    this.createButtons();

    // åˆæœŸçŠ¶æ…‹ã¯ç©º
    this.showEmptyState();
  }

  private createBackground(): void {
    this.background = this.scene.add.graphics();
    this.background.fillStyle(Colors.panelBackground, 0.98);
    this.background.fillRoundedRect(0, 0, this.width, this.height, 12);
    this.background.lineStyle(2, Colors.panelBorder);
    this.background.strokeRoundedRect(0, 0, this.width, this.height, 12);
    this.container.add(this.background);
  }

  private createHeader(): void {
    const { PADDING, HEADER_HEIGHT } = QuestPanelLayout;

    // ä¾é ¼å
    this.questNameText = this.scene.add.text(
      PADDING,
      PADDING,
      'ä¾é ¼ã‚’é¸æŠã—ã¦ãã ã•ã„',
      { ...TextStyles.heading, fontSize: '18px', wordWrap: { width: this.width - PADDING * 2 - 80 } }
    );
    this.container.add(this.questNameText);

    // é›£æ˜“åº¦ãƒãƒƒã‚¸
    this.difficultyBadge = this.scene.add.container(this.width - PADDING - 40, PADDING + 10);
    this.container.add(this.difficultyBadge);

    // æœŸé™
    this.deadlineText = this.scene.add.text(
      PADDING,
      PADDING + 30,
      '',
      { ...TextStyles.bodySmall, fontSize: '12px', color: '#aaaaaa' }
    );
    this.container.add(this.deadlineText);

    // åŒºåˆ‡ã‚Šç·š
    const divider = this.scene.add.graphics();
    divider.lineStyle(1, Colors.panelBorder);
    divider.lineBetween(PADDING, HEADER_HEIGHT, this.width - PADDING, HEADER_HEIGHT);
    this.container.add(divider);
  }

  private createRewardSection(): void {
    const { PADDING, HEADER_HEIGHT, REWARD_HEIGHT } = QuestPanelLayout;
    const y = HEADER_HEIGHT + 10;

    this.rewardSection = this.scene.add.container(PADDING, y);

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
    const title = this.scene.add.text(0, 0, 'ğŸ“¦ å ±é…¬', {
      ...TextStyles.body,
      fontSize: '14px',
      fontStyle: 'bold',
    });
    this.rewardSection.add(title);

    this.container.add(this.rewardSection);

    // åŒºåˆ‡ã‚Šç·š
    const divider = this.scene.add.graphics();
    divider.lineStyle(1, Colors.panelBorder);
    divider.lineBetween(PADDING, y + REWARD_HEIGHT, this.width - PADDING, y + REWARD_HEIGHT);
    this.container.add(divider);
  }

  private createRequirementSection(): void {
    const { PADDING, HEADER_HEIGHT, REWARD_HEIGHT } = QuestPanelLayout;
    const y = HEADER_HEIGHT + REWARD_HEIGHT + 20;

    this.requirementSection = this.scene.add.container(PADDING, y);

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
    const title = this.scene.add.text(0, 0, 'ğŸ“‹ å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ ', {
      ...TextStyles.body,
      fontSize: '14px',
      fontStyle: 'bold',
    });
    this.requirementSection.add(title);

    this.container.add(this.requirementSection);
  }

  private createProgressSection(): void {
    const { PADDING } = QuestPanelLayout;
    const y = this.height - 130;

    this.progressSection = this.scene.add.container(PADDING, y);
    this.progressSection.setVisible(false);

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼èƒŒæ™¯
    const progressBg = this.scene.add.graphics();
    progressBg.fillStyle(Colors.backgroundDark, 1);
    progressBg.fillRoundedRect(0, 0, this.width - PADDING * 2, 20, 4);
    this.progressSection.add(progressBg);

    this.container.add(this.progressSection);
  }

  private createButtons(): void {
    const { PADDING } = QuestPanelLayout;
    const buttonY = this.height - 50;

    // å—æ³¨ãƒœã‚¿ãƒ³
    this.acceptButton = this.createButton(
      this.width / 2,
      buttonY,
      'ä¾é ¼ã‚’å—ã‘ã‚‹',
      () => {
        if (this.quest && this.onAccept) {
          this.onAccept(this.quest);
        }
      },
      true
    );
    this.container.add(this.acceptButton);

    // ç´å“ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
    this.deliverButton = this.createButton(
      this.width / 2,
      buttonY,
      'ç´å“ã™ã‚‹',
      () => {
        if (this.quest && this.onDeliver) {
          this.onDeliver(this.quest);
        }
      },
      true
    );
    this.deliverButton.setVisible(false);
    this.container.add(this.deliverButton);
  }

  setQuest(quest: Quest | null): void {
    this.quest = quest;

    if (!quest) {
      this.showEmptyState();
      return;
    }

    // ä¾é ¼å
    this.questNameText.setText(quest.name);

    // æœŸé™
    const remaining = quest.remainingDays;
    this.deadlineText.setText(`æœŸé™: æ®‹ã‚Š ${remaining} æ—¥`);
    this.deadlineText.setColor(remaining <= 3 ? '#ff4444' : '#aaaaaa');

    // é›£æ˜“åº¦ãƒãƒƒã‚¸
    this.updateDifficultyBadge(quest.difficulty);

    // å ±é…¬
    this.updateRewardSection(quest);

    // å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ 
    this.updateRequirementSection(quest);

    // ãƒœã‚¿ãƒ³è¡¨ç¤º
    this.acceptButton.setVisible(true);
    this.deliverButton.setVisible(false);
  }

  getQuest(): Quest | null {
    return this.quest;
  }

  updateProgress(progress: QuestProgress): void {
    // é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    this.progressSection.setVisible(true);
    // ... é€²æ—ãƒãƒ¼ã®æ›´æ–°
  }

  setAcceptEnabled(enabled: boolean): void {
    this.setButtonEnabled(this.acceptButton, enabled);
  }

  setDeliverEnabled(enabled: boolean): void {
    this.setButtonEnabled(this.deliverButton, enabled);
  }

  showDeliverButton(show: boolean): void {
    this.acceptButton.setVisible(!show);
    this.deliverButton.setVisible(show);
  }

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  destroy(): void {
    this.container.destroy();
  }

  private showEmptyState(): void {
    this.questNameText.setText('ä¾é ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
    this.deadlineText.setText('');
    this.clearDifficultyBadge();
    this.acceptButton.setVisible(false);
    this.deliverButton.setVisible(false);
  }

  private updateDifficultyBadge(difficulty: string): void {
    this.clearDifficultyBadge();

    const color = QuestDifficultyColors[difficulty] ?? 0x888888;
    const bg = this.scene.add.graphics();
    bg.fillStyle(color, 1);
    bg.fillRoundedRect(-30, -10, 60, 20, 4);
    this.difficultyBadge.add(bg);

    const text = this.scene.add.text(0, 0, difficulty.toUpperCase(), {
      fontSize: '10px',
      color: '#ffffff',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    this.difficultyBadge.add(text);
  }

  private clearDifficultyBadge(): void {
    this.difficultyBadge.removeAll(true);
  }

  private updateRewardSection(quest: Quest): void {
    // æ—¢å­˜ã®å ±é…¬è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ï¼‰
    while (this.rewardSection.length > 1) {
      this.rewardSection.getAt(1).destroy();
      this.rewardSection.removeAt(1);
    }

    const rewards: string[] = [];
    if (quest.reward.gold) rewards.push(`ğŸ’° ${quest.reward.gold} ã‚´ãƒ¼ãƒ«ãƒ‰`);
    if (quest.reward.exp) rewards.push(`âœ¨ ${quest.reward.exp} EXP`);
    if (quest.reward.card) rewards.push(`ğŸƒ ã‚«ãƒ¼ãƒ‰å ±é…¬ã‚ã‚Š`);

    rewards.forEach((reward, index) => {
      const text = this.scene.add.text(0, 25 + index * 20, reward, {
        ...TextStyles.body,
        fontSize: '13px',
      });
      this.rewardSection.add(text);
    });
  }

  private updateRequirementSection(quest: Quest): void {
    // æ—¢å­˜ã®è¦ä»¶è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä»¥å¤–ï¼‰
    while (this.requirementSection.length > 1) {
      this.requirementSection.getAt(1).destroy();
      this.requirementSection.removeAt(1);
    }

    quest.requiredItems.forEach((item, index) => {
      const text = this.scene.add.text(0, 25 + index * 20, `ãƒ»${item.name} x${item.quantity}`, {
        ...TextStyles.body,
        fontSize: '13px',
      });
      this.requirementSection.add(text);
    });
  }

  // ãƒœã‚¿ãƒ³ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆBasePhaseContainerã¨åŒæ§˜ï¼‰
  private createButton(...args: any[]): Phaser.GameObjects.Container {
    // å®Ÿè£…ã¯çœç•¥ï¼ˆBasePhaseContainerã¨åŒæ§˜ï¼‰
    return this.scene.add.container(0, 0);
  }

  private setButtonEnabled(button: Phaser.GameObjects.Container, enabled: boolean): void {
    // å®Ÿè£…ã¯çœç•¥
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ä¾é ¼è¨­å®š ğŸ”µ

**Given**: QuestPanelãŒã‚ã‚‹
**When**: setQuest(quest)ã‚’å‘¼ã¶
**Then**: ä¾é ¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ç©ºçŠ¶æ…‹è¡¨ç¤º ğŸ”µ

**Given**: QuestPanelã«ä¾é ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
**When**: setQuest(null)ã‚’å‘¼ã¶
**Then**: ç©ºçŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç´å“ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ ğŸ”µ

**Given**: QuestPanelãŒã‚ã‚‹
**When**: showDeliverButton(true)ã‚’å‘¼ã¶
**Then**: ç´å“ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã€å—æ³¨ãƒœã‚¿ãƒ³ãŒéè¡¨ç¤ºã«ãªã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0214` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- é•·ã„ä¾é ¼åã®ãƒ¯ãƒ¼ãƒ‰ãƒ©ãƒƒãƒ—
- å ±é…¬ãƒªã‚¹ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
- é€²æ—è¡¨ç¤ºã®è¨ˆç®—

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
