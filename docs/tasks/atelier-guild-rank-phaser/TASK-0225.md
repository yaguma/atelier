# TASK-0225: GatheringContainerãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0225
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

GatheringContaineré–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0224
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0226

## å®Œäº†æ¡ä»¶

- [ ] ç´ æç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] é¸æŠæ“ä½œã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] ã‚³ã‚¹ãƒˆè¨ˆç®—ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. GatheringMaterialGeneratorãƒ†ã‚¹ãƒˆ ğŸ”µ

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/ui/phase/GatheringMaterialGenerator.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { GatheringMaterialGenerator } from '../../../../../src/presentation/phaser/ui/phase/GatheringMaterialGenerator';
import { GatheringCard } from '../../../../../src/domain/card/GatheringCard';

describe('GatheringMaterialGenerator', () => {
  let generator: GatheringMaterialGenerator;

  beforeEach(() => {
    // å›ºå®šã‚·ãƒ¼ãƒ‰ã§å†ç¾å¯èƒ½ãªãƒ†ã‚¹ãƒˆ
    generator = new GatheringMaterialGenerator(12345);
  });

  describe('generateMaterialOptions', () => {
    it('æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç´ æãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹', () => {
      const card = createTestGatheringCard();
      const options = generator.generateMaterialOptions(card);

      expect(options).toBeDefined();
      expect(options.length).toBeGreaterThan(0);
    });

    it('ç´ æãŒç©ºã§ã‚‚æœ€ä½1ã¤ã¯è¿”ã™', () => {
      const card = createTestGatheringCardWithLowProbability();
      const options = generator.generateMaterialOptions(card);

      expect(options.length).toBeGreaterThanOrEqual(1);
    });

    it('ç¢ºç‡ãŒé«˜ã„ç´ æã»ã©å‡ºç¾ã—ã‚„ã™ã„', () => {
      const card = createTestGatheringCard();

      // è¤‡æ•°å›ç”Ÿæˆã—ã¦çµ±è¨ˆã‚’å–ã‚‹
      const appearances: Record<string, number> = {};

      for (let i = 0; i < 100; i++) {
        const gen = new GatheringMaterialGenerator(i);
        const options = gen.generateMaterialOptions(card);
        options.forEach(opt => {
          appearances[opt.material.id] = (appearances[opt.material.id] ?? 0) + 1;
        });
      }

      // ç¢ºç‡ãŒé«˜ã„ç´ æã®å‡ºç¾å›æ•°ãŒå¤šã„ã¯ãš
      // å…·ä½“çš„ãªå€¤ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ä¾å­˜
    });
  });

  describe('isRareMaterial', () => {
    it('ç¢ºç‡0.3æœªæº€ã¯ãƒ¬ã‚¢åˆ¤å®š', () => {
      expect(generator.isRareMaterial(0.2)).toBe(true);
      expect(generator.isRareMaterial(0.1)).toBe(true);
    });

    it('ç¢ºç‡0.3ä»¥ä¸Šã¯é€šå¸¸åˆ¤å®š', () => {
      expect(generator.isRareMaterial(0.3)).toBe(false);
      expect(generator.isRareMaterial(0.5)).toBe(false);
    });
  });
});

function createTestGatheringCard(): GatheringCard {
  return {
    id: 'gathering-1',
    name: 'ãƒ†ã‚¹ãƒˆæ¡å–åœ°',
    type: 'gathering',
    apCost: 2,
    possibleMaterials: [
      { material: { id: 'm1', name: 'è–¬è‰', category: 'plant', quality: 'normal' }, probability: 0.8, minQuantity: 1, maxQuantity: 3 },
      { material: { id: 'm2', name: 'é‰„é‰±çŸ³', category: 'mineral', quality: 'normal' }, probability: 0.5, minQuantity: 1, maxQuantity: 2 },
      { material: { id: 'm3', name: 'å¸Œå°‘é‰±çŸ³', category: 'mineral', quality: 'rare' }, probability: 0.1, minQuantity: 1, maxQuantity: 1 },
    ],
  } as any;
}

function createTestGatheringCardWithLowProbability(): GatheringCard {
  return {
    id: 'gathering-2',
    name: 'ä½ç¢ºç‡æ¡å–åœ°',
    type: 'gathering',
    apCost: 3,
    possibleMaterials: [
      { material: { id: 'm1', name: 'è–¬è‰', category: 'plant', quality: 'normal' }, probability: 0.01, minQuantity: 1, maxQuantity: 1 },
    ],
  } as any;
}
```

### 2. GatheringContainerãƒ†ã‚¹ãƒˆ ğŸ”µ

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/ui/phase/GatheringContainer.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';

describe('GatheringContainer', () => {
  describe('åˆæœŸåŒ–', () => {
    it.skip('ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¸¡ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã§ãã‚‹', () => {
      // Phaserã‚·ãƒ¼ãƒ³ã®ãƒ¢ãƒƒã‚¯ãŒå¿…è¦
    });

    it.skip('èƒŒæ™¯ã¨ã‚¿ã‚¤ãƒˆãƒ«ãŒä½œæˆã•ã‚Œã‚‹', () => {
      // UIè¦ç´ ã®ç¢ºèª
    });
  });

  describe('æ¡å–åœ°ã‚«ãƒ¼ãƒ‰è¨­å®š', () => {
    it.skip('setGatheringCardã§ã‚«ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã‚‹', () => {
      // ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã®ä½œæˆç¢ºèª
    });

    it.skip('getGatheringCardã§è¨­å®šã—ãŸã‚«ãƒ¼ãƒ‰ãŒå–å¾—ã§ãã‚‹', () => {
      // ã‚²ãƒƒã‚¿ãƒ¼ã®ç¢ºèª
    });
  });

  describe('ç´ æé¸æŠè‚¢è¨­å®š', () => {
    it.skip('setMaterialOptionsã§é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      // MaterialOptionViewã®ä½œæˆç¢ºèª
    });

    it.skip('ç©ºã®é¸æŠè‚¢ã§ã‚‚å‹•ä½œã™ã‚‹', () => {
      // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ç¢ºèª
    });
  });

  describe('APç®¡ç†', () => {
    it.skip('setCurrentAPã§APè¡¨ç¤ºãŒæ›´æ–°ã•ã‚Œã‚‹', () => {
      // GatheringCostViewã¸ã®åæ˜ ç¢ºèª
    });

    it.skip('APä¸è¶³æ™‚ã¯ç¢ºå®šãƒœã‚¿ãƒ³ãŒç„¡åŠ¹ã«ãªã‚‹', () => {
      // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®ç¢ºèª
    });
  });

  describe('ç´ æé¸æŠ', () => {
    it.skip('selectMaterialã§ç´ æãŒé¸æŠã•ã‚Œã‚‹', () => {
      // é¸æŠçŠ¶æ…‹ã®ç¢ºèª
    });

    it.skip('deselectMaterialã§é¸æŠãŒè§£é™¤ã•ã‚Œã‚‹', () => {
      // è§£é™¤çŠ¶æ…‹ã®ç¢ºèª
    });

    it.skip('é¸æŠä¸Šé™ã«é”ã™ã‚‹ã¨è¿½åŠ é¸æŠã§ããªã„', () => {
      // maxSelectionsåˆ¶é™ã®ç¢ºèª
    });

    it.skip('getSelectedMaterialsã§é¸æŠä¸­ã®ç´ æãŒå–å¾—ã§ãã‚‹', () => {
      // é¸æŠãƒªã‚¹ãƒˆå–å¾—ã®ç¢ºèª
    });
  });

  describe('ã‚³ã‚¹ãƒˆè¨ˆç®—', () => {
    it.skip('getTotalAPCostã§åˆè¨ˆã‚³ã‚¹ãƒˆãŒè¨ˆç®—ã•ã‚Œã‚‹', () => {
      // ã‚³ã‚¹ãƒˆè¨ˆç®—ã®ç¢ºèª
    });

    it.skip('é¸æŠç´ ææ•°ã«å¿œã˜ã¦ã‚³ã‚¹ãƒˆãŒå¢—åŠ ã™ã‚‹', () => {
      // ç´ ææ•°ã¨ã‚³ã‚¹ãƒˆã®é–¢ä¿‚ç¢ºèª
    });
  });

  describe('ç¢ºå®šå‡¦ç†', () => {
    it.skip('confirmGatheringã§gathering:confirmã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', () => {
      // EventBusã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ç¢ºèª
    });

    it.skip('APä¸è¶³æ™‚ã¯confirmGatheringãŒå®Ÿè¡Œã•ã‚Œãªã„', () => {
      // æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã®ç¢ºèª
    });

    it.skip('ç¢ºå®šå¾Œã«onGatheringCompleteã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹', () => {
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œç¢ºèª
    });

    it.skip('çµæœã«é¸æŠã—ãŸç´ æã¨APã‚³ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹', () => {
      // çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèª
    });
  });

  describe('ãƒªã‚»ãƒƒãƒˆ', () => {
    it.skip('resetSelectionã§é¸æŠãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹', () => {
      // é¸æŠã‚¯ãƒªã‚¢ã®ç¢ºèª
    });

    it.skip('gathering:resetã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ç¢ºèª
    });
  });

  describe('ã‚¹ã‚­ãƒƒãƒ—', () => {
    it.skip('ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã§onSkipãŒå‘¼ã°ã‚Œã‚‹', () => {
      // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œç¢ºèª
    });

    it.skip('gathering:skipã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ç¢ºèª
    });
  });

  describe('ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«', () => {
    it.skip('enteræ™‚ã«çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹', () => {
      // enterå‡¦ç†ã®ç¢ºèª
    });

    it.skip('exitæ™‚ã«è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹', () => {
      // exitå‡¦ç†ã®ç¢ºèª
    });

    it.skip('destroyã§å…¨ãƒªã‚½ãƒ¼ã‚¹ãŒè§£æ”¾ã•ã‚Œã‚‹', () => {
      // ç ´æ£„å‡¦ç†ã®ç¢ºèª
    });
  });
});
```

### 3. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã‚·ãƒ¼ãƒ³ ğŸ”µ

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/GatheringTestScene.ts`

```typescript
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { GatheringContainer } from '../ui/phase/GatheringContainer';
import { EventBus } from '../core/EventBus';
import { GatheringCard } from '../../../domain/card/GatheringCard';
import { Material } from '../../../domain/material/Material';

export class GatheringTestScene extends BaseGameScene {
  private gatheringContainer!: GatheringContainer;
  private eventBus!: EventBus;

  constructor() {
    super('GatheringTestScene' as any);
  }

  protected onInit(data?: SceneInitData): void {}
  protected onPreload(): void {}

  protected onCreate(data?: SceneInitData): void {
    this.eventBus = new EventBus();

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    this.eventBus.on('gathering:confirm', (result) => {
      console.log('Gathering confirmed:', result);
    });
    this.eventBus.on('gathering:skip', () => {
      console.log('Gathering skipped');
    });

    // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
    this.gatheringContainer = new GatheringContainer({
      scene: this,
      eventBus: this.eventBus,
      x: 50,
      y: 50,
      onGatheringComplete: (result) => {
        console.log('Gathering complete:', result);
      },
      onSkip: () => {
        console.log('Skipped');
      },
    });

    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®š
    this.gatheringContainer.setCurrentAP(8, 10);
    this.gatheringContainer.setGatheringCard(this.createTestCard());
    this.gatheringContainer.setMaterialOptions(this.createTestMaterials());
    this.gatheringContainer.enter();

    // ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    this.createTestControls();
  }

  private createTestCard(): GatheringCard {
    return {
      id: 'test-gathering',
      name: 'æ£®ã®æ¡å–åœ°',
      type: 'gathering',
      apCost: 2,
      description: 'ãƒ†ã‚¹ãƒˆç”¨ã®æ¡å–åœ°ã‚«ãƒ¼ãƒ‰',
    } as any;
  }

  private createTestMaterials(): MaterialOption[] {
    const materials: Material[] = [
      { id: 'm1', name: 'è–¬è‰', category: 'plant', quality: 'normal' } as Material,
      { id: 'm2', name: 'èµ¤ã„èŠ±', category: 'plant', quality: 'good' } as Material,
      { id: 'm3', name: 'é‰„é‰±çŸ³', category: 'mineral', quality: 'normal' } as Material,
      { id: 'm4', name: 'éŠ€é‰±çŸ³', category: 'mineral', quality: 'rare' } as Material,
      { id: 'm5', name: 'æ¸…æ°´', category: 'liquid', quality: 'normal' } as Material,
    ];

    return materials.map((material, index) => ({
      material,
      quantity: Math.floor(Math.random() * 3) + 1,
      probability: 0.3 + Math.random() * 0.6,
    }));
  }

  private createTestControls(): void {
    const buttonY = 580;

    // APå¤‰æ›´ãƒœã‚¿ãƒ³
    this.createTestButton(50, buttonY, 'AP+1', () => {
      const current = Math.min(10, this.gatheringContainer.getCurrentAP() + 1);
      this.gatheringContainer.setCurrentAP(current, 10);
    });

    this.createTestButton(150, buttonY, 'AP-1', () => {
      const current = Math.max(0, this.gatheringContainer.getCurrentAP() - 1);
      this.gatheringContainer.setCurrentAP(current, 10);
    });

    // ç´ æãƒªã‚»ãƒƒãƒˆ
    this.createTestButton(250, buttonY, 'ç´ æå†ç”Ÿæˆ', () => {
      this.gatheringContainer.setMaterialOptions(this.createTestMaterials());
    });
  }

  private createTestButton(x: number, y: number, label: string, onClick: () => void): void {
    const btn = this.add.text(x, y, label, {
      fontSize: '12px',
      backgroundColor: '#333333',
      padding: { x: 10, y: 5 },
    }).setInteractive();

    btn.on('pointerdown', onClick);
  }

  protected setupEventListeners(): void {}
}
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0225` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- Phaserã‚·ãƒ¼ãƒ³ã®ãƒ¢ãƒƒã‚¯æ–¹æ³•
- éåŒæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ
- EventBusã®ãƒ¢ãƒƒã‚¯

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
