# TASK-0265: æ˜‡æ ¼è©¦é¨“çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0265
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ãƒ©ãƒ³ã‚¯ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

æ˜‡æ ¼è©¦é¨“æ©Ÿèƒ½ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚è©¦é¨“æ¡ä»¶ã€åˆå¦åˆ¤å®šã€å ±é…¬ä»˜ä¸ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0246 (RankUpSceneãƒ†ã‚¹ãƒˆ)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0269

## å®Œäº†æ¡ä»¶

- [ ] æ˜‡æ ¼è©¦é¨“æ¡ä»¶ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] åˆæ ¼åˆ¤å®šã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ä¸åˆæ ¼åˆ¤å®šã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] å ±é…¬ä»˜ä¸ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ãƒ©ãƒ³ã‚¯é€²è¡Œã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

---

## ãƒ†ã‚¹ãƒˆå®Ÿè£…è©³ç´°

### 1. æ˜‡æ ¼è©¦é¨“çµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ†ã‚¹ãƒˆ*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/phase5/RankUpIntegration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createTestGame, waitForScene, navigateToRankUp } from '../../../utils/phaserTestUtils';
import { EventBus } from '@/presentation/phaser/core/EventBus';
import { PhaserStateManager } from '@/presentation/phaser/state/PhaserStateManager';
import { SceneKeys } from '@/presentation/phaser/config/SceneKeys';

describe('RankUp Integration', () => {
  let game: Phaser.Game;
  let eventBus: EventBus;
  let stateManager: PhaserStateManager;

  beforeEach(async () => {
    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
    stateManager = game.registry.get('stateManager');

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    eventBus.emit('ui:game:start:requested', { isNewGame: true });
  });

  afterEach(() => {
    game.destroy(true);
  });

  describe('Rank Progression E â†’ D', () => {
    beforeEach(async () => {
      // Eãƒ©ãƒ³ã‚¯ã€çµŒé¨“å€¤æº€ã‚¿ãƒ³
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);
    });

    it('Dãƒ©ãƒ³ã‚¯ã¸ã®æ˜‡æ ¼ã«æŒ‘æˆ¦ã§ãã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.rank).toBe('D');
      });
    });

    it('æ˜‡æ ¼ã§çµŒé¨“å€¤ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.exp).toBe(0);
      });
    });

    it('æ˜‡æ ¼ã§æ¬¡ãƒ©ãƒ³ã‚¯å¿…è¦çµŒé¨“å€¤ãŒè¨­å®šã•ã‚Œã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.maxExp).toBeGreaterThan(100); // Dãƒ©ãƒ³ã‚¯ã®å¿…è¦EXP
      });
    });

    it('æ˜‡æ ¼å ±é…¬ã‚’ç²å¾—ã™ã‚‹', async () => {
      // Arrange
      const initialGold = stateManager.getPlayerData().gold;

      const rewardCallback = vi.fn();
      eventBus.on('app:rankup:success', rewardCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        expect(rewardCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            newRank: 'D',
            rewards: expect.objectContaining({
              gold: expect.any(Number),
            }),
          })
        );
      });
    });
  });

  describe('Rank Progression D â†’ C', () => {
    beforeEach(async () => {
      stateManager.updatePlayer({
        rank: 'D',
        exp: 200,
        maxExp: 200,
      });
      await navigateToRankUp(game, eventBus);
    });

    it('Cãƒ©ãƒ³ã‚¯ã¸ã®æ˜‡æ ¼ã«æŒ‘æˆ¦ã§ãã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'C' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.rank).toBe('C');
      });
    });
  });

  describe('Rank Progression C â†’ B', () => {
    beforeEach(async () => {
      stateManager.updatePlayer({
        rank: 'C',
        exp: 400,
        maxExp: 400,
      });
      await navigateToRankUp(game, eventBus);
    });

    it('Bãƒ©ãƒ³ã‚¯ã¸ã®æ˜‡æ ¼ã«æŒ‘æˆ¦ã§ãã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'B' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.rank).toBe('B');
      });
    });
  });

  describe('Rank Progression B â†’ A', () => {
    beforeEach(async () => {
      stateManager.updatePlayer({
        rank: 'B',
        exp: 800,
        maxExp: 800,
      });
      await navigateToRankUp(game, eventBus);
    });

    it('Aãƒ©ãƒ³ã‚¯ã¸ã®æ˜‡æ ¼ã«æŒ‘æˆ¦ã§ãã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'A' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.rank).toBe('A');
      });
    });
  });

  describe('Rank Progression A â†’ S (Game Clear)', () => {
    beforeEach(async () => {
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
      await navigateToRankUp(game, eventBus);
    });

    it('Sãƒ©ãƒ³ã‚¯ã¸ã®æ˜‡æ ¼ã§ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã«ãªã‚‹', async () => {
      // Arrange
      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalled();
      });
    });

    it('GameClearSceneã«é·ç§»ã™ã‚‹', async () => {
      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await waitForScene(game, SceneKeys.GAME_CLEAR);
      expect(game.scene.isActive(SceneKeys.GAME_CLEAR)).toBe(true);
    });
  });

  describe('Failed Rank Up', () => {
    it('çµŒé¨“å€¤ä¸è¶³ã§æ˜‡æ ¼è©¦é¨“ã«å¤±æ•—ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 50, // 100å¿…è¦
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      const failedCallback = vi.fn();
      eventBus.on('app:rankup:failed', failedCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        expect(failedCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            reason: expect.stringContaining('çµŒé¨“å€¤'),
          })
        );
      });
    });

    it('å¤±æ•—ã—ã¦ã‚‚ãƒ©ãƒ³ã‚¯ã¯å¤‰ã‚ã‚‰ãªã„', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 50,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.rank).toBe('E');
      });
    });

    it('ã‚¹ã‚­ãƒƒãƒ—ã¯ã§ããªã„ï¼ˆé †ç•ªé€šã‚Šæ˜‡æ ¼ï¼‰', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act - Eãƒ©ãƒ³ã‚¯ã‹ã‚‰ç›´æ¥Bãƒ©ãƒ³ã‚¯ã¸
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'B' });

      // Assert
      await vi.waitFor(() => {
        expect(errorCallback).toHaveBeenCalled();
      });
    });
  });

  describe('RankUp Requirements', () => {
    it('å„ãƒ©ãƒ³ã‚¯ã®å¿…è¦çµŒé¨“å€¤ãŒæ­£ã—ã„', () => {
      // E â†’ D: 100
      // D â†’ C: 200
      // C â†’ B: 400
      // B â†’ A: 800
      // A â†’ S: 1600

      const rankExpRequirements = {
        E: 100,
        D: 200,
        C: 400,
        B: 800,
        A: 1600,
      };

      for (const [rank, exp] of Object.entries(rankExpRequirements)) {
        stateManager.updatePlayer({
          rank: rank as any,
          exp: 0,
          maxExp: exp,
        });

        const player = stateManager.getPlayerData();
        expect(player.maxExp).toBe(exp);
      }
    });
  });

  describe('RankUp Rewards', () => {
    it('ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚ã«å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã§ãã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      const initialDeckSize = stateManager.getDeck().cards.length;

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const deck = stateManager.getDeck();
        expect(deck.cards.length).toBeGreaterThan(initialDeckSize);
      });
    });

    it('ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ™‚ã«ã‚´ãƒ¼ãƒ«ãƒ‰å ±é…¬ã‚’ç²å¾—ã™ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
        gold: 500,
      });
      await navigateToRankUp(game, eventBus);

      const initialGold = stateManager.getPlayerData().gold;

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        const player = stateManager.getPlayerData();
        expect(player.gold).toBeGreaterThan(initialGold);
      });
    });

    it('é«˜ãƒ©ãƒ³ã‚¯ã»ã©å ±é…¬ãŒè±ªè¯', async () => {
      // å„ãƒ©ãƒ³ã‚¯ã®å ±é…¬ã‚’æ¯”è¼ƒ
      const rewards: number[] = [];

      const ranks = ['E', 'D', 'C', 'B', 'A'];
      const nextRanks = ['D', 'C', 'B', 'A', 'S'];
      const expRequirements = [100, 200, 400, 800, 1600];

      for (let i = 0; i < ranks.length; i++) {
        // Reset state
        const testSetup = await createTestGame();
        const localStateManager = testSetup.game.registry.get('stateManager');
        const localEventBus = testSetup.eventBus;

        localStateManager.updatePlayer({
          rank: ranks[i],
          exp: expRequirements[i],
          maxExp: expRequirements[i],
          gold: 0,
        });

        localEventBus.emit('ui:rankup:challenge:requested', { targetRank: nextRanks[i] });

        await vi.waitFor(() => {
          const player = localStateManager.getPlayerData();
          rewards.push(player.gold);
        });

        testSetup.game.destroy(true);
      }

      // å ±é…¬ãŒæ®µéšçš„ã«å¢—åŠ 
      for (let i = 1; i < rewards.length; i++) {
        expect(rewards[i]).toBeGreaterThan(rewards[i - 1]);
      }
    });
  });

  describe('RankUp Scene Navigation', () => {
    it('æ˜‡æ ¼è©¦é¨“ç”»é¢ã‹ã‚‰ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:close:requested');

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
    });

    it('æ˜‡æ ¼æˆåŠŸå¾Œã¯ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert - æˆåŠŸæ¼”å‡ºå¾Œã«ãƒ¡ã‚¤ãƒ³ã¸
      await vi.waitFor(() => {
        // æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆå¾Œã€ä¸€å®šæ™‚é–“ã§ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹
        expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
      }, { timeout: 5000 });
    });
  });

  describe('State Consistency', () => {
    it('æ˜‡æ ¼å¾Œã®ãƒ©ãƒ³ã‚¯ãŒå…¨ã‚·ã‚¹ãƒ†ãƒ ã§åŒæœŸã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'E',
        exp: 100,
        maxExp: 100,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'D' });

      // Assert
      await vi.waitFor(() => {
        // StateManager
        expect(stateManager.getPlayerData().rank).toBe('D');

        // UIæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¦ã„ã‚‹
        // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã•ã‚Œã‚‹
        const serialized = stateManager.serialize();
        const state = JSON.parse(serialized);
        expect(state.player.rank).toBe('D');
      });
    });
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0265` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|-----------|---------------|
| ãƒ©ãƒ³ã‚¯é·ç§» | 100% |
| å ±é…¬ä»˜ä¸ | 95% |
| å¤±æ•—ã‚±ãƒ¼ã‚¹ | 90% |
| çŠ¶æ…‹åŒæœŸ | 95% |

---

## æ³¨æ„äº‹é …

- ãƒ©ãƒ³ã‚¯é·ç§»ã®é †åºä¿è¨¼
- ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ¡ä»¶ã¨ã®é€£æº
- å ±é…¬è¨ˆç®—ã®æ­£ç¢ºæ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
