# TASK-0258: DayEndUIå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0258
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

1æ—¥ã®çµ‚äº†æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚µãƒãƒªãƒ¼ç”»é¢UIã‚’å®Ÿè£…ã™ã‚‹ã€‚ãã®æ—¥ã®æˆæœï¼ˆå®Œäº†ã—ãŸä¾é ¼ã€ç²å¾—ç´ æã€åˆæˆã‚¢ã‚¤ãƒ†ãƒ ã€åæ”¯ï¼‰ã‚’è¡¨ç¤ºã—ã€æ¬¡ã®æ—¥ã¸ã®é·ç§»ã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0175 (UIFactoryãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç”Ÿæˆå®Ÿè£…)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0259

## å®Œäº†æ¡ä»¶

- [ ] DayEndPanelã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] 1æ—¥ã®ã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ¬¡ã®æ—¥ã¸é€²ã‚€ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼/ã‚¯ãƒªã‚¢åˆ¤å®šã¨ã®é€£æºãŒå‹•ä½œã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. DayEndPanelå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ—¥çµ‚äº†UI*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/day/DayEndPanel.ts`

```typescript
import Phaser from 'phaser';
import { UIFactory } from '../UIFactory';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export interface DaySummary {
  day: number;
  questsCompleted: number;
  questsTotal: number;
  materialsGathered: number;
  itemsCrafted: number;
  goldEarned: number;
  goldSpent: number;
  expGained: number;
  currentRank: string;
  nextRankProgress: number;
}

export interface DayEndPanelOptions {
  scene: Phaser.Scene;
  x: number;
  y: number;
  summary: DaySummary;
  onContinue: () => void;
}

/**
 * 1æ—¥çµ‚äº†æ™‚ã®ã‚µãƒãƒªãƒ¼è¡¨ç¤ºãƒ‘ãƒãƒ«
 */
export class DayEndPanel extends Phaser.GameObjects.Container {
  private summary: DaySummary;
  private onContinue: () => void;
  private animationTimeline: Phaser.Tweens.Timeline | null = null;
  private continueButton: Phaser.GameObjects.Container | null = null;

  constructor(options: DayEndPanelOptions) {
    super(options.scene, options.x, options.y);

    this.summary = options.summary;
    this.onContinue = options.onContinue;

    this.createPanel();
    options.scene.add.existing(this);

    // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    this.playShowAnimation();
  }

  private createPanel(): void {
    const width = 500;
    const height = 480;

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯
    const overlay = this.scene.add.graphics();
    overlay.fillStyle(0x000000, 0.7);
    overlay.fillRect(-this.scene.cameras.main.width / 2, -this.scene.cameras.main.height / 2,
      this.scene.cameras.main.width, this.scene.cameras.main.height);
    this.add(overlay);

    // ãƒ‘ãƒãƒ«èƒŒæ™¯
    const bg = this.scene.add.graphics();
    bg.fillStyle(Colors.panelBackground, 0.98);
    bg.fillRoundedRect(-width / 2, -height / 2, width, height, 16);
    bg.lineStyle(3, Colors.accent);
    bg.strokeRoundedRect(-width / 2, -height / 2, width, height, 16);
    this.add(bg);

    // ã‚¿ã‚¤ãƒˆãƒ«
    const title = this.scene.add.text(
      0,
      -height / 2 + 40,
      `${this.summary.day}æ—¥ç›® çµ‚äº†`,
      {
        ...TextStyles.heading,
        fontSize: '28px',
        color: '#e94560',
      }
    ).setOrigin(0.5);
    this.add(title);

    // åŒºåˆ‡ã‚Šç·š
    const divider = this.scene.add.graphics();
    divider.lineStyle(1, 0x444466);
    divider.lineBetween(-width / 2 + 30, -height / 2 + 70, width / 2 - 30, -height / 2 + 70);
    this.add(divider);

    // ã‚µãƒãƒªãƒ¼é …ç›®ï¼ˆåˆæœŸçŠ¶æ…‹ã¯é€æ˜ï¼‰
    const startY = -height / 2 + 100;
    const lineHeight = 45;

    this.createSummaryRow('å®Œäº†ã—ãŸä¾é ¼', `${this.summary.questsCompleted} / ${this.summary.questsTotal}`, 0, startY, 'row-1');
    this.createSummaryRow('æ¡å–ã—ãŸç´ æ', `${this.summary.materialsGathered}å€‹`, 0, startY + lineHeight, 'row-2');
    this.createSummaryRow('åˆæˆã—ãŸã‚¢ã‚¤ãƒ†ãƒ ', `${this.summary.itemsCrafted}å€‹`, 0, startY + lineHeight * 2, 'row-3');

    // åæ”¯
    const profit = this.summary.goldEarned - this.summary.goldSpent;
    const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
    this.createSummaryRow('åå…¥', `+${this.summary.goldEarned}G`, 0, startY + lineHeight * 3, 'row-4', '#4ade80');
    this.createSummaryRow('æ”¯å‡º', `-${this.summary.goldSpent}G`, 0, startY + lineHeight * 4, 'row-5', '#f87171');
    this.createSummaryRow('åæ”¯', `${profit >= 0 ? '+' : ''}${profit}G`, 0, startY + lineHeight * 5, 'row-6', profitColor);

    // åŒºåˆ‡ã‚Šç·š2
    const divider2 = this.scene.add.graphics();
    divider2.lineStyle(1, 0x444466);
    divider2.lineBetween(-width / 2 + 30, startY + lineHeight * 5 + 30, width / 2 - 30, startY + lineHeight * 5 + 30);
    this.add(divider2);

    // çµŒé¨“å€¤ãƒ»ãƒ©ãƒ³ã‚¯
    this.createSummaryRow('ç²å¾—çµŒé¨“å€¤', `+${this.summary.expGained} EXP`, 0, startY + lineHeight * 6, 'row-7', '#60a5fa');

    // ãƒ©ãƒ³ã‚¯é€²æ—ãƒãƒ¼
    const progressBarY = startY + lineHeight * 7 + 10;
    this.createRankProgressBar(0, progressBarY);

    // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰
    this.continueButton = UIFactory.createButton(this.scene, {
      x: 0,
      y: height / 2 - 50,
      width: 180,
      height: 50,
      text: 'æ¬¡ã®æ—¥ã¸',
      style: 'primary',
      onClick: () => this.handleContinue(),
    });
    this.continueButton.setAlpha(0);
    this.add(this.continueButton);
  }

  private createSummaryRow(
    label: string,
    value: string,
    x: number,
    y: number,
    name: string,
    valueColor: string = '#ffffff'
  ): void {
    const container = this.scene.add.container(x, y);
    container.setAlpha(0);
    container.setName(name);

    const labelText = this.scene.add.text(-180, 0, label, {
      ...TextStyles.body,
      fontSize: '16px',
      color: '#a0a0c0',
    }).setOrigin(0, 0.5);

    const valueText = this.scene.add.text(180, 0, value, {
      ...TextStyles.body,
      fontSize: '18px',
      fontStyle: 'bold',
      color: valueColor,
    }).setOrigin(1, 0.5);

    container.add([labelText, valueText]);
    this.add(container);
  }

  private createRankProgressBar(x: number, y: number): void {
    const container = this.scene.add.container(x, y);
    container.setAlpha(0);
    container.setName('rank-progress');

    // ãƒ©ãƒ³ã‚¯ãƒ©ãƒ™ãƒ«
    const rankLabel = this.scene.add.text(-180, 0, `ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯: ${this.summary.currentRank}`, {
      ...TextStyles.body,
      fontSize: '14px',
      color: '#a0a0c0',
    }).setOrigin(0, 0.5);

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼èƒŒæ™¯
    const barWidth = 200;
    const barHeight = 16;
    const barBg = this.scene.add.graphics();
    barBg.fillStyle(0x333344, 1);
    barBg.fillRoundedRect(0, -barHeight / 2, barWidth, barHeight, 4);

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
    const progress = Math.min(this.summary.nextRankProgress, 1);
    const progressBar = this.scene.add.graphics();
    progressBar.fillStyle(Colors.accent, 1);
    progressBar.fillRoundedRect(0, -barHeight / 2, barWidth * progress, barHeight, 4);
    progressBar.setName('progress-fill');

    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
    const percentText = this.scene.add.text(barWidth + 10, 0, `${Math.floor(progress * 100)}%`, {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#e94560',
    }).setOrigin(0, 0.5);

    container.add([rankLabel, barBg, progressBar, percentText]);
    this.add(container);
  }

  private playShowAnimation(): void {
    const rows = ['row-1', 'row-2', 'row-3', 'row-4', 'row-5', 'row-6', 'row-7', 'rank-progress'];

    this.animationTimeline = this.scene.tweens.timeline({
      onComplete: () => {
        // å…¨è¡Œè¡¨ç¤ºå¾Œã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        this.showContinueButton();
      },
    });

    // ãƒ‘ãƒãƒ«å…¨ä½“ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    this.setAlpha(0);
    this.animationTimeline.add({
      targets: this,
      alpha: 1,
      duration: 300,
      ease: 'Power2',
    });

    // å„è¡Œã‚’é †ç•ªã«è¡¨ç¤º
    rows.forEach((rowName, index) => {
      const row = this.getByName(rowName);
      if (row) {
        this.animationTimeline!.add({
          targets: row,
          alpha: 1,
          y: `-=10`,
          duration: 200,
          ease: 'Power2',
          offset: `-=100`, // å°‘ã—é‡ã­ã‚‹
        });
      }
    });

    this.animationTimeline.play();
  }

  private showContinueButton(): void {
    if (this.continueButton) {
      this.scene.tweens.add({
        targets: this.continueButton,
        alpha: 1,
        scale: { from: 0.8, to: 1 },
        duration: 300,
        ease: 'Back.easeOut',
      });
    }
  }

  private handleContinue(): void {
    // é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.scene.tweens.add({
      targets: this,
      alpha: 0,
      scale: 0.9,
      duration: 200,
      ease: 'Power2',
      onComplete: () => {
        this.onContinue();
        this.destroy();
      },
    });
  }

  destroy(fromScene?: boolean): void {
    if (this.animationTimeline) {
      this.animationTimeline.destroy();
    }
    super.destroy(fromScene);
  }
}
```

### 2. DayEndManagerå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ—¥çµ‚äº†ç®¡ç†*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/managers/DayEndManager.ts`

```typescript
import { EventBus } from '../core/EventBus';
import { PhaserStateManager } from '../state/PhaserStateManager';
import { DayEndPanel, DaySummary } from '../ui/day/DayEndPanel';

/**
 * 1æ—¥çµ‚äº†æ™‚ã®å‡¦ç†ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
 */
export class DayEndManager {
  private eventBus: EventBus;
  private stateManager: PhaserStateManager;
  private scene: Phaser.Scene | null = null;
  private dayStats = {
    questsCompleted: 0,
    materialsGathered: 0,
    itemsCrafted: 0,
    goldEarned: 0,
    goldSpent: 0,
    expGained: 0,
  };

  constructor(eventBus: EventBus, stateManager: PhaserStateManager) {
    this.eventBus = eventBus;
    this.stateManager = stateManager;

    this.setupEventListeners();
  }

  setScene(scene: Phaser.Scene): void {
    this.scene = scene;
  }

  private setupEventListeners(): void {
    // çµ±è¨ˆã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
    this.eventBus.on('quest:delivered', (data: any) => {
      this.dayStats.questsCompleted++;
      this.dayStats.goldEarned += data.rewards?.gold ?? 0;
      this.dayStats.expGained += data.rewards?.exp ?? 0;
    });

    this.eventBus.on('gathering:complete', (data: any) => {
      this.dayStats.materialsGathered += data.materials?.length ?? 0;
    });

    this.eventBus.on('alchemy:crafted', () => {
      this.dayStats.itemsCrafted++;
    });

    this.eventBus.on('shop:purchased', (data: any) => {
      this.dayStats.goldSpent += data.cost ?? 0;
    });
  }

  /**
   * 1æ—¥çµ‚äº†å‡¦ç†ã‚’é–‹å§‹
   */
  async showDayEnd(): Promise<void> {
    if (!this.scene) {
      console.error('Scene not set for DayEndManager');
      return;
    }

    const state = this.stateManager.getState();
    const quests = this.stateManager.getQuests();
    const player = this.stateManager.getPlayerData();

    const summary: DaySummary = {
      day: state.progress.currentDay,
      questsCompleted: this.dayStats.questsCompleted,
      questsTotal: quests.accepted.length + this.dayStats.questsCompleted,
      materialsGathered: this.dayStats.materialsGathered,
      itemsCrafted: this.dayStats.itemsCrafted,
      goldEarned: this.dayStats.goldEarned,
      goldSpent: this.dayStats.goldSpent,
      expGained: this.dayStats.expGained,
      currentRank: player.rank,
      nextRankProgress: player.exp / player.maxExp,
    };

    return new Promise((resolve) => {
      new DayEndPanel({
        scene: this.scene!,
        x: this.scene!.cameras.main.centerX,
        y: this.scene!.cameras.main.centerY,
        summary,
        onContinue: () => {
          this.resetDayStats();
          this.eventBus.emit('ui:day:end:confirmed');
          resolve();
        },
      });
    });
  }

  /**
   * æ—¥ã®çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
   */
  private resetDayStats(): void {
    this.dayStats = {
      questsCompleted: 0,
      materialsGathered: 0,
      itemsCrafted: 0,
      goldEarned: 0,
      goldSpent: 0,
      expGained: 0,
    };
  }

  /**
   * æ‰‹å‹•ã§çµ±è¨ˆã‚’è¿½åŠ ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
   */
  addStats(stats: Partial<typeof this.dayStats>): void {
    Object.assign(this.dayStats, stats);
  }

  /**
   * ç¾åœ¨ã®çµ±è¨ˆã‚’å–å¾—
   */
  getStats(): typeof this.dayStats {
    return { ...this.dayStats };
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚µãƒãƒªãƒ¼è¡¨ç¤º ğŸŸ¡

**Given**: DayEndPanelãŒä½œæˆã•ã‚Œã‚‹
**When**: ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã‚‹
**Then**: å„é …ç›®ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸŸ¡

**Given**: ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
**When**: è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé–‹å§‹
**Then**: å„è¡ŒãŒé †ç•ªã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã™ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ ğŸŸ¡

**Given**: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œäº†
**When**: ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: onContinueã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: çµ±è¨ˆåé›† ğŸŸ¡

**Given**: DayEndManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹
**Then**: çµ±è¨ˆãŒæ­£ã—ãé›†è¨ˆã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0258` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
- å¤§ããªæ•°å€¤ã®è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- ãƒã‚¤ãƒŠã‚¹åæ”¯ã®è¦–è¦šçš„å¼·èª¿

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ï¼‰
