# TASK-0243: ShopSceneãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0243
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ShopSceneã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚å˜ä½“ãƒ†ã‚¹ãƒˆã¨è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0242
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0259

## å®Œäº†æ¡ä»¶

- [ ] ShopSceneã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚«ãƒ¼ãƒ‰è³¼å…¥ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ç´ æè³¼å…¥ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ShopSceneå˜ä½“ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *åŸºæœ¬ãƒ†ã‚¹ãƒˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/phaser/scenes/ShopScene.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { ShopScene, ShopSceneData } from '@/presentation/phaser/scenes/ShopScene';
import { ShopCategory } from '@/presentation/phaser/scenes/ShopSceneConstants';
import { createMockScene, createMockEventBus } from '@tests/utils/phaserTestUtils';

describe('ShopScene', () => {
  let scene: ShopScene;
  let mockEventBus: any;

  const mockShopData: ShopSceneData = {
    playerGold: 1000,
    availableCards: [
      { id: 'card1', name: 'æ£®ã®æ¡å–åœ°', type: 'gathering', price: 100, rarity: 'common' },
      { id: 'card2', name: 'è–¬è‰ã®ãƒ¬ã‚·ãƒ”', type: 'recipe', price: 200, rarity: 'uncommon' },
    ],
    availableMaterials: [
      { id: 'mat1', name: 'è–¬è‰', price: 50, quality: 30, stock: 10 },
      { id: 'mat2', name: 'é­”æ³•ã®èŠ±', price: 150, quality: 60, stock: -1 },
    ],
    availableArtifacts: [
      { id: 'art1', name: 'éŒ¬é‡‘è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–', price: 500, rarity: 'rare', effects: [{ description: 'èª¿åˆæˆåŠŸç‡+10%' }] },
    ],
  };

  beforeEach(() => {
    mockEventBus = createMockEventBus();
    scene = createMockScene(ShopScene, mockShopData, mockEventBus);
  });

  describe('åˆæœŸåŒ–', () => {
    it('æ‰€æŒé‡‘ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.getPlayerGold()).toBe(1000);
    });

    it('åˆæœŸã‚«ãƒ†ã‚´ãƒªãŒcardsã«ãªã£ã¦ã„ã‚‹', () => {
      expect(scene.getCurrentCategory()).toBe('cards');
    });

    it('å•†å“ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹', () => {
      const itemCount = scene.getDisplayedItemCount();
      expect(itemCount).toBe(2); // ã‚«ãƒ¼ãƒ‰2æš
    });
  });

  describe('ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ', () => {
    it('ç´ æã‚«ãƒ†ã‚´ãƒªã«åˆ‡ã‚Šæ›¿ãˆã§ãã‚‹', () => {
      scene.switchCategory('materials');

      expect(scene.getCurrentCategory()).toBe('materials');
      expect(scene.getDisplayedItemCount()).toBe(2);
    });

    it('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚«ãƒ†ã‚´ãƒªã«åˆ‡ã‚Šæ›¿ãˆã§ãã‚‹', () => {
      scene.switchCategory('artifacts');

      expect(scene.getCurrentCategory()).toBe('artifacts');
      expect(scene.getDisplayedItemCount()).toBe(1);
    });

    it('ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆã§é¸æŠãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹', () => {
      scene.selectItem(mockShopData.availableCards![0]);
      expect(scene.getSelectedItem()).not.toBeNull();

      scene.switchCategory('materials');

      expect(scene.getSelectedItem()).toBeNull();
    });
  });

  describe('å•†å“é¸æŠ', () => {
    it('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã‚‹', () => {
      const card = mockShopData.availableCards![0];
      scene.selectItem(card);

      expect(scene.getSelectedItem()).toBe(card);
    });

    it('é¸æŠæ™‚ã«è©³ç´°ãƒ‘ãƒãƒ«ãŒæ›´æ–°ã•ã‚Œã‚‹', () => {
      const card = mockShopData.availableCards![0];
      scene.selectItem(card);

      expect(scene.isDetailPanelVisible()).toBe(true);
    });

    it('è³¼å…¥ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      const card = mockShopData.availableCards![0];
      scene.selectItem(card);

      expect(scene.isPurchaseButtonVisible()).toBe(true);
    });
  });
});
```

### 2. ã‚«ãƒ¼ãƒ‰è³¼å…¥ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è³¼å…¥ãƒ•ãƒ­ãƒ¼*

```typescript
describe('ã‚«ãƒ¼ãƒ‰è³¼å…¥', () => {
  it('è³¼å…¥å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ã‚’è³¼å…¥ã§ãã‚‹', () => {
    const card = mockShopData.availableCards![0]; // 100G
    scene.selectItem(card);

    const purchaseHandler = vi.fn();
    mockEventBus.on('shop:card:purchase', purchaseHandler);

    scene.confirmPurchase();

    expect(purchaseHandler).toHaveBeenCalledWith({
      card,
      price: 100,
    });
  });

  it('æ‰€æŒé‡‘ä¸è¶³æ™‚ã¯è³¼å…¥ã§ããªã„', () => {
    const expensiveCard = { id: 'expensive', name: 'é«˜ç´šã‚«ãƒ¼ãƒ‰', type: 'gathering', price: 2000, rarity: 'legendary' };
    scene.setAvailableCards([expensiveCard]);
    scene.selectItem(expensiveCard);

    const result = scene.canPurchaseSelectedItem();

    expect(result).toBe(false);
  });

  it('è³¼å…¥å®Œäº†å¾Œã«æ‰€æŒé‡‘ãŒæ›´æ–°ã•ã‚Œã‚‹', () => {
    const card = mockShopData.availableCards![0];
    scene.selectItem(card);

    scene.onCardPurchaseComplete({
      card,
      newGold: 900,
    });

    expect(scene.getPlayerGold()).toBe(900);
  });

  it('è³¼å…¥å®Œäº†å¾Œã«ã‚«ãƒ¼ãƒ‰ãŒãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆãˆã‚‹', () => {
    const card = mockShopData.availableCards![0];
    const initialCount = scene.getDisplayedItemCount();

    scene.selectItem(card);
    scene.onCardPurchaseComplete({
      card,
      newGold: 900,
    });

    expect(scene.getDisplayedItemCount()).toBe(initialCount - 1);
  });
});
```

### 3. ç´ æè³¼å…¥ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ•°é‡è³¼å…¥*

```typescript
describe('ç´ æè³¼å…¥', () => {
  beforeEach(() => {
    scene.switchCategory('materials');
  });

  it('æ•°é‡ã‚’æŒ‡å®šã—ã¦è³¼å…¥ã§ãã‚‹', () => {
    const material = mockShopData.availableMaterials![0]; // 50G
    scene.selectMaterial(material);
    scene.setQuantity(5);

    const purchaseHandler = vi.fn();
    mockEventBus.on('shop:material:purchase', purchaseHandler);

    scene.confirmPurchase();

    expect(purchaseHandler).toHaveBeenCalledWith({
      material,
      quantity: 5,
      totalPrice: 250,
    });
  });

  it('æ‰€æŒé‡‘å†…ã§æœ€å¤§æ•°é‡ãŒè¨ˆç®—ã•ã‚Œã‚‹', () => {
    const material = mockShopData.availableMaterials![1]; // 150G
    scene.selectMaterial(material);

    const maxQuantity = scene.calculateMaxQuantity();

    expect(maxQuantity).toBe(6); // 1000 / 150 = 6
  });

  it('åœ¨åº«åˆ¶é™ãŒè€ƒæ…®ã•ã‚Œã‚‹', () => {
    const material = mockShopData.availableMaterials![0]; // 50G, stock: 10
    scene.selectMaterial(material);

    const maxQuantity = scene.calculateMaxQuantity();

    expect(maxQuantity).toBe(10); // åœ¨åº«åˆ¶é™
  });

  it('è³¼å…¥å¾Œã«åœ¨åº«ãŒæ¸›å°‘ã™ã‚‹', () => {
    const material = mockShopData.availableMaterials![0];
    scene.selectMaterial(material);

    scene.onMaterialPurchaseComplete({
      material,
      quantity: 3,
      newGold: 850,
    });

    // åœ¨åº«ãŒ7ã«ãªã£ã¦ã„ã‚‹ï¼ˆ10 - 3ï¼‰
    const updatedMaterial = scene.getMaterialById(material.id);
    expect(updatedMaterial.stock).toBe(7);
  });

  it('ç„¡é™åœ¨åº«ã®ç´ æã¯æ¸›å°‘ã—ãªã„', () => {
    const material = mockShopData.availableMaterials![1]; // stock: -1
    scene.selectMaterial(material);

    scene.onMaterialPurchaseComplete({
      material,
      quantity: 2,
      newGold: 700,
    });

    const updatedMaterial = scene.getMaterialById(material.id);
    expect(updatedMaterial.stock).toBe(-1);
  });
});
```

### 4. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ*

```typescript
describe('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥', () => {
  beforeEach(() => {
    scene.switchCategory('artifacts');
  });

  it('ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’è³¼å…¥ã§ãã‚‹', () => {
    const artifact = mockShopData.availableArtifacts![0]; // 500G
    scene.selectArtifact(artifact);

    const purchaseHandler = vi.fn();
    mockEventBus.on('shop:artifact:purchase', purchaseHandler);

    scene.confirmPurchase();

    expect(purchaseHandler).toHaveBeenCalledWith({
      artifact,
      price: 500,
    });
  });

  it('è³¼å…¥å¾Œã«ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆãˆã‚‹', () => {
    const artifact = mockShopData.availableArtifacts![0];

    scene.selectArtifact(artifact);
    scene.onArtifactPurchaseComplete({
      artifact,
      newGold: 500,
    });

    expect(scene.getDisplayedItemCount()).toBe(0);
  });

  it('è³¼å…¥ä¸å¯æ™‚ã¯èµ¤å­—ã§ä¾¡æ ¼è¡¨ç¤ºã•ã‚Œã‚‹', () => {
    const expensiveArtifact = {
      id: 'expensive',
      name: 'ä¼èª¬ã®è£…å‚™',
      price: 5000,
      rarity: 'legendary',
    };
    scene.setAvailableArtifacts([expensiveArtifact]);
    scene.selectArtifact(expensiveArtifact);

    const priceColor = scene.getDetailPanelPriceColor();
    expect(priceColor).toBe('#ff4444');
  });
});
```

### 5. è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ç›®è¦–ç¢ºèª*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/test/ShopTestScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene } from '../BaseGameScene';
import { ShopScene, ShopSceneData } from '../ShopScene';

export class ShopTestScene extends BaseGameScene {
  constructor() {
    super('ShopTestScene');
  }

  protected onCreate(): void {
    this.createTestControls();
    this.launchShopScene();
  }

  private createTestControls(): void {
    // ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«
    const panel = this.add.container(10, 10);

    const bg = this.add.graphics();
    bg.fillStyle(0x333333, 0.9);
    bg.fillRoundedRect(0, 0, 200, 300, 8);
    panel.add(bg);

    const title = this.add.text(100, 15, 'Shop Test', {
      fontSize: '16px',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    panel.add(title);

    // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
    const buttons = [
      { label: 'ã‚«ãƒ¼ãƒ‰ã‚¿ãƒ–', action: () => this.testSwitchToCards() },
      { label: 'ç´ æã‚¿ãƒ–', action: () => this.testSwitchToMaterials() },
      { label: 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ', action: () => this.testSwitchToArtifacts() },
      { label: 'æ‰€æŒé‡‘è¿½åŠ ', action: () => this.testAddGold() },
      { label: 'è³¼å…¥ãƒ†ã‚¹ãƒˆ', action: () => this.testPurchase() },
      { label: 'ãƒªãƒ­ãƒ¼ãƒ‰', action: () => this.reloadShopScene() },
    ];

    buttons.forEach((btn, index) => {
      const y = 50 + index * 40;
      const button = this.createTestButton(btn.label, 100, y, btn.action);
      panel.add(button);
    });

    panel.setDepth(1000);
  }

  private createTestButton(
    label: string,
    x: number,
    y: number,
    onClick: () => void
  ): Phaser.GameObjects.Container {
    const btn = this.add.container(x, y);

    const bg = this.add.graphics();
    bg.fillStyle(0x555555, 1);
    bg.fillRoundedRect(-80, -15, 160, 30, 4);
    btn.add(bg);

    const text = this.add.text(0, 0, label, {
      fontSize: '12px',
    }).setOrigin(0.5);
    btn.add(text);

    btn.setSize(160, 30);
    btn.setInteractive({ useHandCursor: true });
    btn.on('pointerdown', onClick);

    return btn;
  }

  private launchShopScene(): void {
    const testData: ShopSceneData = {
      playerGold: 1500,
      availableCards: [
        { id: 'card1', name: 'æ£®ã®æ¡å–åœ°', type: 'gathering', price: 100, rarity: 'common', materials: [{ name: 'è–¬è‰', probability: 80 }] },
        { id: 'card2', name: 'æ´çªŸã®æ¡å–åœ°', type: 'gathering', price: 200, rarity: 'uncommon', materials: [{ name: 'é‰„é‰±çŸ³', probability: 60 }] },
        { id: 'card3', name: 'è–¬è‰ã®ãƒ¬ã‚·ãƒ”', type: 'recipe', price: 150, rarity: 'common', outputItem: { name: 'ãƒ’ãƒ¼ãƒ«ãƒãƒ¼ã‚·ãƒ§ãƒ³' } },
        { id: 'card4', name: 'å¼·åŒ–ã®æ›¸', type: 'enhance', price: 300, rarity: 'rare', effect: { description: 'å“è³ª+10' } },
      ],
      availableMaterials: [
        { id: 'mat1', name: 'è–¬è‰', price: 30, quality: 30, category: 'æ¤ç‰©', stock: 20 },
        { id: 'mat2', name: 'é­”æ³•ã®èŠ±', price: 80, quality: 50, category: 'æ¤ç‰©', stock: -1 },
        { id: 'mat3', name: 'é‰„é‰±çŸ³', price: 50, quality: 40, category: 'é‰±ç‰©', stock: 15 },
        { id: 'mat4', name: 'ã‚¯ãƒªã‚¹ã‚¿ãƒ«', price: 200, quality: 70, category: 'é‰±ç‰©', stock: 5 },
      ],
      availableArtifacts: [
        { id: 'art1', name: 'éŒ¬é‡‘è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–', price: 500, rarity: 'rare', effects: [{ description: 'èª¿åˆæˆåŠŸç‡+10%' }] },
        { id: 'art2', name: 'æ¡å–ã®æ‰‹è¢‹', price: 300, rarity: 'uncommon', effects: [{ description: 'æ¡å–åŠ¹ç‡+5%' }] },
        { id: 'art3', name: 'ä¼èª¬ã®æ–', price: 2000, rarity: 'legendary', effects: [{ description: 'å…¨èƒ½åŠ›+20%' }, { description: 'APæ¶ˆè²»-10%' }] },
      ],
    };

    this.scene.launch('ShopScene', testData);
  }

  private testSwitchToCards(): void {
    const shopScene = this.scene.get('ShopScene') as ShopScene;
    shopScene?.switchCategory('cards');
  }

  private testSwitchToMaterials(): void {
    const shopScene = this.scene.get('ShopScene') as ShopScene;
    shopScene?.switchCategory('materials');
  }

  private testSwitchToArtifacts(): void {
    const shopScene = this.scene.get('ShopScene') as ShopScene;
    shopScene?.switchCategory('artifacts');
  }

  private testAddGold(): void {
    const shopScene = this.scene.get('ShopScene') as ShopScene;
    const currentGold = shopScene?.getPlayerGold() ?? 0;
    shopScene?.updateGold(currentGold + 500);
  }

  private testPurchase(): void {
    const shopScene = this.scene.get('ShopScene') as ShopScene;
    if (shopScene?.getSelectedItem()) {
      shopScene.confirmPurchase();
    } else {
      console.log('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
  }

  private reloadShopScene(): void {
    this.scene.stop('ShopScene');
    this.launchShopScene();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ ğŸ”µ

- ShopSceneåˆæœŸåŒ–: 100%
- ã‚«ãƒ†ã‚´ãƒªåˆ‡ã‚Šæ›¿ãˆ: 100%
- å•†å“é¸æŠ: 100%
- ã‚«ãƒ¼ãƒ‰è³¼å…¥: 100%
- ç´ æè³¼å…¥ï¼ˆæ•°é‡æŒ‡å®šï¼‰: 100%
- ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè³¼å…¥: 100%

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0243` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- EventBusã®ãƒ¢ãƒƒã‚¯åŒ–
- éåŒæœŸè³¼å…¥å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
- è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 5é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 5é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
