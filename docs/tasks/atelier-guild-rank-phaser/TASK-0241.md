# TASK-0241: ShopSceneã‚«ãƒ¼ãƒ‰è³¼å…¥å®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0241
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚·ãƒ§ãƒƒãƒ—ã§ã®ã‚«ãƒ¼ãƒ‰è³¼å…¥æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã€ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã€å¼·åŒ–ã‚«ãƒ¼ãƒ‰ã®è³¼å…¥UIã¨å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0240
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0242

## å®Œäº†æ¡ä»¶

- [ ] ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚«ãƒ¼ãƒ‰è©³ç´°ï¼ˆåŠ¹æœèª¬æ˜ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è³¼å…¥ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] è³¼å…¥å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ã‚«ãƒ¼ãƒ‰å•†å“è¡Œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚«ãƒ¼ãƒ‰è¡¨ç¤º*

```typescript
// ShopSceneã«è¿½åŠ 

private createCardItemRow(card: any): Phaser.GameObjects.Container {
  const container = this.add.container(0, 0);

  // èƒŒæ™¯
  const bg = this.add.graphics();
  bg.fillStyle(Colors.backgroundMedium, 1);
  bg.fillRoundedRect(0, 0, 560, 80, 8);
  container.add(bg);

  // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã‚¢ã‚¤ã‚³ãƒ³
  const typeIcon = this.getCardTypeIcon(card.type);
  const icon = this.add.text(15, 40, typeIcon, { fontSize: '24px' }).setOrigin(0, 0.5);
  container.add(icon);

  // ã‚«ãƒ¼ãƒ‰å
  const name = this.add.text(50, 20, card.name, {
    ...TextStyles.body,
    fontSize: '16px',
    fontStyle: 'bold',
  });
  container.add(name);

  // ã‚«ãƒ¼ãƒ‰åŠ¹æœç°¡æ˜“èª¬æ˜
  const effectText = this.getCardEffectSummary(card);
  const effect = this.add.text(50, 45, effectText, {
    ...TextStyles.body,
    fontSize: '12px',
    color: '#aaaaaa',
  });
  container.add(effect);

  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¡¨ç¤º
  const rarityColor = this.getRarityColor(card.rarity);
  const rarity = this.add.graphics();
  rarity.fillStyle(rarityColor, 1);
  rarity.fillCircle(540, 25, 8);
  container.add(rarity);

  // ä¾¡æ ¼
  const canAfford = card.price <= this.playerGold;
  const price = this.add.text(480, 50, `${card.price} G`, {
    ...TextStyles.body,
    fontSize: '16px',
    color: canAfford ? '#ffcc00' : '#ff4444',
  });
  container.add(price);

  // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
  container.setSize(560, 80);
  container.setInteractive({ useHandCursor: true });

  container.on('pointerover', () => {
    bg.clear();
    bg.fillStyle(Colors.buttonHover, 1);
    bg.fillRoundedRect(0, 0, 560, 80, 8);
  });

  container.on('pointerout', () => {
    bg.clear();
    bg.fillStyle(Colors.backgroundMedium, 1);
    bg.fillRoundedRect(0, 0, 560, 80, 8);
  });

  container.on('pointerdown', () => {
    this.selectItem(card);
  });

  return container;
}

private getCardTypeIcon(type: string): string {
  switch (type) {
    case 'gathering': return 'ğŸŒ¿';
    case 'recipe': return 'ğŸ“œ';
    case 'enhance': return 'âš¡';
    default: return 'ğŸƒ';
  }
}

private getCardEffectSummary(card: any): string {
  switch (card.type) {
    case 'gathering':
      return `æ¡å–: ${card.materials?.slice(0, 3).map((m: any) => m.name).join(', ')}...`;
    case 'recipe':
      return `èª¿åˆ: ${card.outputItem?.name ?? ''}`;
    case 'enhance':
      return card.effect?.description ?? 'ã‚«ãƒ¼ãƒ‰å¼·åŒ–';
    default:
      return '';
  }
}

private getRarityColor(rarity: string): number {
  switch (rarity) {
    case 'common': return 0xaaaaaa;
    case 'uncommon': return 0x00aa00;
    case 'rare': return 0x0088ff;
    case 'epic': return 0xaa00ff;
    case 'legendary': return 0xffaa00;
    default: return 0xaaaaaa;
  }
}
```

### 2. ã‚«ãƒ¼ãƒ‰è©³ç´°ãƒ‘ãƒãƒ« ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è©³ç´°è¡¨ç¤º*

```typescript
// ShopSceneã«è¿½åŠ 

private updateCardDetailPanel(card: any): void {
  const { DETAIL_AREA } = ShopSceneLayout;

  // æ—¢å­˜å†…å®¹ã‚¯ãƒªã‚¢
  this.clearDetailPanel();

  // ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const cardPreview = this.createCardPreview(card, DETAIL_AREA.WIDTH / 2, 100);
  this.detailPanel.add(cardPreview);

  // ã‚«ãƒ¼ãƒ‰å
  const nameText = this.add.text(DETAIL_AREA.WIDTH / 2, 200, card.name, {
    ...TextStyles.heading,
  }).setOrigin(0.5);
  this.detailPanel.add(nameText);

  // ã‚¿ã‚¤ãƒ—ãƒ»ãƒ¬ã‚¢ãƒªãƒ†ã‚£
  const typeLabel = this.getCardTypeLabel(card.type);
  const typeText = this.add.text(DETAIL_AREA.WIDTH / 2, 230, typeLabel, {
    ...TextStyles.body,
    fontSize: '14px',
    color: '#888888',
  }).setOrigin(0.5);
  this.detailPanel.add(typeText);

  // åŠ¹æœèª¬æ˜
  const effectDescription = this.getCardFullDescription(card);
  const descText = this.add.text(20, 260, effectDescription, {
    ...TextStyles.body,
    fontSize: '13px',
    wordWrap: { width: DETAIL_AREA.WIDTH - 40 },
    lineSpacing: 4,
  });
  this.detailPanel.add(descText);

  // ä¾¡æ ¼
  const canAfford = card.price <= this.playerGold;
  const priceText = this.add.text(DETAIL_AREA.WIDTH / 2, 360, `${card.price} G`, {
    ...TextStyles.heading,
    fontSize: '24px',
    color: canAfford ? '#ffcc00' : '#ff4444',
  }).setOrigin(0.5);
  this.detailPanel.add(priceText);

  // è³¼å…¥ä¸å¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if (!canAfford) {
    const warningText = this.add.text(DETAIL_AREA.WIDTH / 2, 385, 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¶³ã‚Šã¾ã›ã‚“', {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#ff4444',
    }).setOrigin(0.5);
    this.detailPanel.add(warningText);
  }
}

private createCardPreview(card: any, x: number, y: number): Phaser.GameObjects.Container {
  const preview = this.add.container(x, y);

  // ã‚«ãƒ¼ãƒ‰èƒŒæ™¯
  const bg = this.add.graphics();
  const rarityColor = this.getRarityColor(card.rarity);
  bg.fillStyle(rarityColor, 0.3);
  bg.fillRoundedRect(-50, -70, 100, 140, 8);
  bg.lineStyle(2, rarityColor);
  bg.strokeRoundedRect(-50, -70, 100, 140, 8);
  preview.add(bg);

  // ã‚¿ã‚¤ãƒ—ã‚¢ã‚¤ã‚³ãƒ³
  const icon = this.add.text(0, -20, this.getCardTypeIcon(card.type), {
    fontSize: '32px',
  }).setOrigin(0.5);
  preview.add(icon);

  // åå‰ï¼ˆçŸ­ç¸®ï¼‰
  const shortName = card.name.length > 8 ? card.name.slice(0, 7) + 'â€¦' : card.name;
  const nameText = this.add.text(0, 30, shortName, {
    fontSize: '12px',
    color: '#ffffff',
  }).setOrigin(0.5);
  preview.add(nameText);

  return preview;
}

private getCardTypeLabel(type: string): string {
  switch (type) {
    case 'gathering': return 'æ¡å–åœ°ã‚«ãƒ¼ãƒ‰';
    case 'recipe': return 'ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰';
    case 'enhance': return 'å¼·åŒ–ã‚«ãƒ¼ãƒ‰';
    default: return 'ã‚«ãƒ¼ãƒ‰';
  }
}

private getCardFullDescription(card: any): string {
  let desc = '';

  switch (card.type) {
    case 'gathering':
      desc = `ã€æ¡å–åœ°ã€‘\n`;
      desc += `æ¡å–å¯èƒ½ç´ æ:\n`;
      card.materials?.forEach((mat: any) => {
        desc += `  â€¢ ${mat.name} (${mat.probability}%)\n`;
      });
      break;

    case 'recipe':
      desc = `ã€ãƒ¬ã‚·ãƒ”ã€‘\n`;
      desc += `ä½œæˆã‚¢ã‚¤ãƒ†ãƒ : ${card.outputItem?.name ?? 'ä¸æ˜'}\n`;
      desc += `å¿…è¦ç´ æ:\n`;
      card.requiredMaterials?.forEach((mat: any) => {
        desc += `  â€¢ ${mat.name} x${mat.quantity}\n`;
      });
      break;

    case 'enhance':
      desc = `ã€å¼·åŒ–ã€‘\n`;
      desc += card.effect?.description ?? 'åŠ¹æœä¸æ˜';
      break;
  }

  return desc;
}
```

### 3. è³¼å…¥ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ç¢ºèªå‡¦ç†*

```typescript
// ShopSceneã«è¿½åŠ 

private showPurchaseConfirmDialog(card: any): void {
  const dialog = this.dialogManager.showConfirmDialog({
    title: 'è³¼å…¥ç¢ºèª',
    message: `ã€Œ${card.name}ã€ã‚’\n${card.price} G ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`,
    confirmText: 'è³¼å…¥',
    cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    onConfirm: () => {
      this.executePurchase(card);
    },
    onCancel: () => {
      // ä½•ã‚‚ã—ãªã„
    },
  });
}

private async executePurchase(card: any): Promise<void> {
  // è³¼å…¥å‡¦ç†ä¸­è¡¨ç¤º
  const loadingOverlay = this.showLoadingOverlay('è³¼å…¥ä¸­...');

  try {
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ï¼ˆApplicationå±¤ã§å‡¦ç†ï¼‰
    this.eventBus.emit('shop:card:purchase', {
      card,
      price: card.price,
    });

    // æˆåŠŸã‚’å¾…ã¤ï¼ˆEventBusã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    // å®Ÿéš›ã¯Applicationå±¤ã‹ã‚‰ã®å¿œç­”ã‚’å¾…ã¤

  } catch (error) {
    this.hideLoadingOverlay(loadingOverlay);
    this.showToast('è³¼å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// Applicationå±¤ã‹ã‚‰ã®è³¼å…¥å®Œäº†é€šçŸ¥
onCardPurchaseComplete(result: { card: any; newGold: number }): void {
  this.hideLoadingOverlay(this.currentLoadingOverlay);

  // è³¼å…¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  this.playPurchaseAnimation(result.card);

  // æ‰€æŒé‡‘æ›´æ–°
  this.updateGold(result.newGold);

  // å•†å“ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆè³¼å…¥æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã‚’é™¤å¤–ï¼‰
  this.shopData.availableCards = this.shopData.availableCards?.filter(
    c => c.id !== result.card.id
  );
  this.updateItemList();

  // é¸æŠè§£é™¤
  this.selectedItem = null;
  this.clearDetailPanel();
  this.purchaseButton.setVisible(false);

  // æˆåŠŸãƒˆãƒ¼ã‚¹ãƒˆ
  this.showToast(`${result.card.name}ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`, 'success');
}

private async playPurchaseAnimation(card: any): Promise<void> {
  return new Promise((resolve) => {
    // ã‚«ãƒ¼ãƒ‰ãŒé£›ã‚“ã§ã„ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const { DETAIL_AREA } = ShopSceneLayout;

    const animCard = this.createCardPreview(
      card,
      DETAIL_AREA.X + DETAIL_AREA.WIDTH / 2,
      DETAIL_AREA.Y + 100
    );
    animCard.setDepth(100);

    this.tweens.add({
      targets: animCard,
      x: ShopSceneLayout.SCREEN_WIDTH + 100,
      y: 100,
      scale: 0.5,
      alpha: 0,
      duration: 500,
      ease: 'Power2.easeIn',
      onComplete: () => {
        animCard.destroy();
        resolve();
      },
    });
  });
}
```

### 4. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼å‡¦ç† ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIçŠ¶æ…‹ç®¡ç†*

```typescript
// ShopSceneã«è¿½åŠ 

private currentLoadingOverlay: Phaser.GameObjects.Container | null = null;

private showLoadingOverlay(message: string): Phaser.GameObjects.Container {
  const overlay = this.add.container(0, 0);
  overlay.setDepth(200);

  // åŠé€æ˜èƒŒæ™¯
  const bg = this.add.graphics();
  bg.fillStyle(0x000000, 0.7);
  bg.fillRect(0, 0, ShopSceneLayout.SCREEN_WIDTH, ShopSceneLayout.SCREEN_HEIGHT);
  overlay.add(bg);

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼
  const spinner = this.add.graphics();
  spinner.lineStyle(4, Colors.primary);
  spinner.arc(
    ShopSceneLayout.SCREEN_WIDTH / 2,
    ShopSceneLayout.SCREEN_HEIGHT / 2,
    30,
    0,
    Phaser.Math.PI2 * 0.75
  );
  spinner.strokePath();
  overlay.add(spinner);

  // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  this.tweens.add({
    targets: spinner,
    angle: 360,
    duration: 1000,
    repeat: -1,
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const text = this.add.text(
    ShopSceneLayout.SCREEN_WIDTH / 2,
    ShopSceneLayout.SCREEN_HEIGHT / 2 + 60,
    message,
    { ...TextStyles.body }
  ).setOrigin(0.5);
  overlay.add(text);

  this.currentLoadingOverlay = overlay;
  return overlay;
}

private hideLoadingOverlay(overlay: Phaser.GameObjects.Container | null): void {
  if (overlay) {
    overlay.destroy();
  }
  this.currentLoadingOverlay = null;
}

// è³¼å…¥å¤±æ•—æ™‚
onCardPurchaseFailed(error: { message: string }): void {
  this.hideLoadingOverlay(this.currentLoadingOverlay);
  this.showToast(error.message, 'error');
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆè¡¨ç¤º ğŸ”µ

**Given**: ShopSceneã§ã‚«ãƒ¼ãƒ‰ã‚¿ãƒ–ã‚’é¸æŠ
**When**: ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
**Then**: ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è³¼å…¥ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° ğŸ”µ

**Given**: ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ã„ã‚‹
**When**: è³¼å…¥ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: è³¼å…¥ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: è³¼å…¥å‡¦ç† ğŸ”µ

**Given**: è³¼å…¥ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç¢ºèªã‚’ã‚¯ãƒªãƒƒã‚¯
**When**: è³¼å…¥å‡¦ç†ãŒæˆåŠŸ
**Then**: æ‰€æŒé‡‘ãŒæ¸›ã‚Šã€ã‚«ãƒ¼ãƒ‰ãŒè³¼å…¥ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0241` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã”ã¨ã®è¡¨ç¤ºå½¢å¼
- è³¼å…¥æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®é™¤å¤–
- åŒä¸€ã‚«ãƒ¼ãƒ‰ã®è¤‡æ•°è³¼å…¥åˆ¶é™

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
