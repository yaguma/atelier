# TASK-0223: GatheringContainerç´ ææç¤ºå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0223
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

GatheringContainerã®ç´ ææç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦æ¡å–å¯èƒ½ãªç´ æã‚’ç”Ÿæˆã—ã€ç¢ºç‡ã«å¿œã˜ã¦æç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0222
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0224

## å®Œäº†æ¡ä»¶

- [x] æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç´ æãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã§ãã‚‹
- [x] ç´ æã®å‡ºç¾ç¢ºç‡ãŒåæ˜ ã•ã‚Œã‚‹
- [x] ãƒ¬ã‚¢ç´ æã®å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹
- [x] ç´ æé¸æŠè‚¢ãŒè¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„

---

## å®Ÿè£…è©³ç´°

### 1. ç´ æç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¡å–ã‚·ã‚¹ãƒ†ãƒ *

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/GatheringMaterialGenerator.ts`

```typescript
import { GatheringCard } from '../../../../domain/card/GatheringCard';
import { Material } from '../../../../domain/material/Material';
import { MaterialOption } from '../material/IMaterialOptionView';

export interface GeneratedMaterial {
  material: Material;
  quantity: number;
  probability: number;
  isRare: boolean;
}

export class GatheringMaterialGenerator {
  private randomSeed?: number;

  constructor(seed?: number) {
    this.randomSeed = seed;
  }

  /**
   * æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç´ æé¸æŠè‚¢ã‚’ç”Ÿæˆ
   */
  generateMaterialOptions(card: GatheringCard): MaterialOption[] {
    const possibleMaterials = card.possibleMaterials ?? [];
    const options: MaterialOption[] = [];

    possibleMaterials.forEach((materialEntry) => {
      // ç¢ºç‡åˆ¤å®šã§å‡ºç¾ã™ã‚‹ã‹æ±ºå®š
      if (this.rollProbability(materialEntry.probability)) {
        const quantity = this.calculateQuantity(materialEntry);

        options.push({
          material: materialEntry.material,
          quantity: quantity,
          probability: materialEntry.probability,
        });
      }
    });

    // æœ€ä½1ã¤ã¯ç´ æã‚’å‡ºç¾ã•ã›ã‚‹
    if (options.length === 0 && possibleMaterials.length > 0) {
      const fallback = possibleMaterials[0];
      options.push({
        material: fallback.material,
        quantity: 1,
        probability: fallback.probability,
      });
    }

    return options;
  }

  /**
   * ç¢ºç‡åˆ¤å®š
   */
  private rollProbability(probability: number): boolean {
    const roll = this.random();
    return roll < probability;
  }

  /**
   * æ•°é‡è¨ˆç®—
   */
  private calculateQuantity(entry: { minQuantity?: number; maxQuantity?: number }): number {
    const min = entry.minQuantity ?? 1;
    const max = entry.maxQuantity ?? 3;
    return Math.floor(this.random() * (max - min + 1)) + min;
  }

  /**
   * ä¹±æ•°ç”Ÿæˆï¼ˆã‚·ãƒ¼ãƒ‰å¯¾å¿œï¼‰
   */
  private random(): number {
    if (this.randomSeed !== undefined) {
      // ã‚·ãƒ¼ãƒ‰ä»˜ãä¹±æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      this.randomSeed = (this.randomSeed * 9301 + 49297) % 233280;
      return this.randomSeed / 233280;
    }
    return Math.random();
  }

  /**
   * ãƒ¬ã‚¢åˆ¤å®š
   */
  isRareMaterial(probability: number): boolean {
    return probability < 0.3;
  }
}
```

### 2. ç´ ææç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/GatheringMaterialPresenter.ts`

```typescript
import Phaser from 'phaser';
import { MaterialOption } from '../material/IMaterialOptionView';
import { GatheringMaterialGenerator } from './GatheringMaterialGenerator';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class GatheringMaterialPresenter {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;

  constructor(scene: Phaser.Scene, container: Phaser.GameObjects.Container) {
    this.scene = scene;
    this.container = container;
  }

  /**
   * ç´ æé¸æŠè‚¢ã‚’é †æ¬¡è¡¨ç¤º
   */
  async presentMaterials(
    options: MaterialOption[],
    onComplete: () => void
  ): Promise<void> {
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    const loadingText = this.scene.add.text(
      200,
      200,
      'ğŸ” ç´ æã‚’æ¢ç´¢ä¸­...',
      { ...TextStyles.body, fontSize: '16px' }
    ).setOrigin(0.5);
    this.container.add(loadingText);

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.scene.tweens.add({
      targets: loadingText,
      alpha: 0.5,
      duration: 300,
      yoyo: true,
      repeat: 3,
    });

    await this.delay(1200);
    loadingText.destroy();

    // ç´ æã‚’é †æ¬¡è¡¨ç¤º
    const generator = new GatheringMaterialGenerator();

    for (let i = 0; i < options.length; i++) {
      const option = options[i];
      const isRare = generator.isRareMaterial(option.probability ?? 1);

      if (isRare) {
        await this.presentRareMaterial(option, i);
      } else {
        await this.presentNormalMaterial(option, i);
      }

      await this.delay(200);
    }

    onComplete();
  }

  private async presentNormalMaterial(option: MaterialOption, index: number): Promise<void> {
    // é€šå¸¸ç´ æï¼šãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    return new Promise((resolve) => {
      const particle = this.createMaterialParticle(option, index);

      particle.setAlpha(0);
      particle.setScale(0.5);

      this.scene.tweens.add({
        targets: particle,
        alpha: 1,
        scale: 1,
        duration: 300,
        ease: 'Back.easeOut',
        onComplete: () => resolve(),
      });
    });
  }

  private async presentRareMaterial(option: MaterialOption, index: number): Promise<void> {
    // ãƒ¬ã‚¢ç´ æï¼šç‰¹åˆ¥ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    return new Promise((resolve) => {
      // å…‰ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      const glow = this.scene.add.graphics();
      const x = 100 + (index % 3) * 100;
      const y = 100 + Math.floor(index / 3) * 80;

      glow.fillStyle(0xffd700, 0.5);
      glow.fillCircle(x, y, 40);
      this.container.add(glow);

      // ã‚°ãƒ­ãƒ¼ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      this.scene.tweens.add({
        targets: glow,
        alpha: 0,
        scale: 2,
        duration: 500,
        ease: 'Power2',
        onComplete: () => glow.destroy(),
      });

      // ç´ æãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
      const particle = this.createMaterialParticle(option, index);
      particle.setAlpha(0);
      particle.setScale(0);

      this.scene.tweens.add({
        targets: particle,
        alpha: 1,
        scale: 1.1,
        duration: 400,
        ease: 'Back.easeOut',
        onComplete: () => {
          // ãƒã‚¦ãƒ³ã‚¹
          this.scene.tweens.add({
            targets: particle,
            scale: 1,
            duration: 200,
            ease: 'Bounce.easeOut',
            onComplete: () => resolve(),
          });
        },
      });

      // ãƒ¬ã‚¢è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
      const rareText = this.scene.add.text(x, y - 30, 'â˜… RARE â˜…', {
        fontSize: '10px',
        color: '#ffd700',
        fontStyle: 'bold',
      }).setOrigin(0.5);
      this.container.add(rareText);

      this.scene.tweens.add({
        targets: rareText,
        y: y - 50,
        alpha: 0,
        duration: 1000,
        ease: 'Power2',
        onComplete: () => rareText.destroy(),
      });
    });
  }

  private createMaterialParticle(option: MaterialOption, index: number): Phaser.GameObjects.Text {
    const x = 100 + (index % 3) * 100;
    const y = 100 + Math.floor(index / 3) * 80;

    const emoji = this.getMaterialEmoji(option.material.category);
    const particle = this.scene.add.text(x, y, emoji, {
      fontSize: '32px',
    }).setOrigin(0.5);

    this.container.add(particle);
    return particle;
  }

  private getMaterialEmoji(category: string): string {
    switch (category) {
      case 'plant': return 'ğŸŒ¿';
      case 'mineral': return 'ğŸ’';
      case 'liquid': return 'ğŸ’§';
      case 'powder': return 'âœ¨';
      case 'monster': return 'ğŸ¦´';
      default: return 'ğŸ“¦';
    }
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => this.scene.time.delayedCall(ms, resolve));
  }
}
```

### 3. GatheringContainerã«çµ±åˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆ*

```typescript
// GatheringContainerã«è¿½åŠ 

private materialGenerator: GatheringMaterialGenerator;
private materialPresenter: GatheringMaterialPresenter;

// ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§åˆæœŸåŒ–
this.materialGenerator = new GatheringMaterialGenerator();
this.materialPresenter = new GatheringMaterialPresenter(this.scene, this.container);

/**
 * æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ç´ æã‚’ç”Ÿæˆã—ã¦æç¤º
 */
async generateAndPresentMaterials(card: GatheringCard): Promise<void> {
  this.setGatheringCard(card);

  // ç´ æç”Ÿæˆ
  const options = this.materialGenerator.generateMaterialOptions(card);

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  this.showLoading('ç´ æã‚’æ¢ç´¢ä¸­...');

  // ç´ ææç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.materialPresenter.presentMaterials(options, () => {
    this.hideLoading();
    this.setMaterialOptions(options);
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ç´ æç”Ÿæˆ ğŸ”µ

**Given**: æ¡å–åœ°ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹
**When**: generateMaterialOptions(card)ã‚’å‘¼ã¶
**Then**: ç¢ºç‡ã«å¿œã˜ãŸç´ æãƒªã‚¹ãƒˆãŒè¿”ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ¬ã‚¢åˆ¤å®š ğŸ”µ

**Given**: ç¢ºç‡ãŒ0.2ã®ç´ æ
**When**: isRareMaterial(0.2)ã‚’å‘¼ã¶
**Then**: trueãŒè¿”ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: æœ€ä½ä¿è¨¼ ğŸ”µ

**Given**: å…¨ç´ æãŒç¢ºç‡åˆ¤å®šã§è½ã¡ãŸå ´åˆ
**When**: generateMaterialOptionsã‚’å‘¼ã¶
**Then**: æœ€ä½1ã¤ã¯ç´ æãŒè¿”ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0223` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã®ãƒ†ã‚¹ãƒˆå¯¾å¿œ
- ãƒ¬ã‚¢ç´ æã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ¼”å‡º
- éåŒæœŸå‡¦ç†ã®æ‰±ã„

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
