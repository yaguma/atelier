# TASK-0233: DeliveryContainerç´å“æ“ä½œå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0233
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

DeliveryContainerã®ç´å“æ“ä½œã‚’å®Œæˆã•ã›ã‚‹ã€‚ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€å ±é…¬è¡¨ç¤ºã€å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0232
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0234

## å®Œäº†æ¡ä»¶

- [ ] ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç”Ÿã•ã‚Œã‚‹
- [ ] å ±é…¬ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ã€çµŒé¨“å€¤ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] å ±é…¬ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Œã°é¸æŠUIãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç´å“å®Œäº†å¾Œã«ä¾é ¼ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// DeliveryContainerã«è¿½åŠ 

private async playDeliveryAnimation(): Promise<void> {
  return new Promise((resolve) => {
    const centerX = DeliveryContainerLayout.WIDTH / 2;
    const centerY = DeliveryContainerLayout.HEIGHT / 2;

    // ç´å“ã‚¢ã‚¤ãƒ†ãƒ ãŒé£›ã‚“ã§ã„ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const items = this.getRequiredItems(this.selectedQuest!);

    const itemPromises = items.map((item, index) =>
      this.animateItemDelivery(item, index, centerX, centerY)
    );

    Promise.all(itemPromises).then(() => {
      // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      this.playCheckmarkEffect(centerX, centerY).then(resolve);
    });
  });
}

private animateItemDelivery(
  item: Item,
  index: number,
  targetX: number,
  targetY: number
): Promise<void> {
  return new Promise((resolve) => {
    // ã‚¢ã‚¤ãƒ†ãƒ ã®é–‹å§‹ä½ç½®
    const startX = 200;
    const startY = 200 + index * 40;

    // ã‚¢ã‚¤ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³
    const itemIcon = this.scene.add.text(startX, startY, 'ğŸ“¦', {
      fontSize: '32px',
    }).setOrigin(0.5);
    this.container.add(itemIcon);

    // ã‚¢ã‚¤ãƒ†ãƒ åãƒ©ãƒ™ãƒ«
    const itemLabel = this.scene.add.text(startX + 30, startY, item.name, {
      ...TextStyles.body,
      fontSize: '12px',
    }).setOrigin(0, 0.5);
    this.container.add(itemLabel);

    // å³å´ã¸é£›ã‚“ã§ã„ã
    const targetOffsetX = 400;

    this.scene.tweens.add({
      targets: [itemIcon, itemLabel],
      x: `+=${targetOffsetX}`,
      alpha: 0,
      duration: 600,
      delay: index * 150,
      ease: 'Power2.easeIn',
      onComplete: () => {
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        this.createDeliveryParticle(startX + targetOffsetX, startY);
        itemIcon.destroy();
        itemLabel.destroy();
        resolve();
      },
    });
  });
}

private createDeliveryParticle(x: number, y: number): void {
  // æ˜Ÿã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  for (let i = 0; i < 5; i++) {
    const star = this.scene.add.text(x, y, 'âœ¨', {
      fontSize: '16px',
    }).setOrigin(0.5);
    this.container.add(star);

    const angle = Math.random() * Math.PI * 2;
    const distance = 30 + Math.random() * 30;

    this.scene.tweens.add({
      targets: star,
      x: x + Math.cos(angle) * distance,
      y: y + Math.sin(angle) * distance,
      alpha: 0,
      scale: 0.5,
      duration: 400,
      ease: 'Power2',
      onComplete: () => star.destroy(),
    });
  }
}

private async playCheckmarkEffect(x: number, y: number): Promise<void> {
  return new Promise((resolve) => {
    // å††å½¢ã®èƒŒæ™¯
    const circle = this.scene.add.graphics();
    circle.fillStyle(0x00aa00, 0.9);
    circle.fillCircle(x, y, 0);
    this.container.add(circle);

    // æ‹¡å¤§
    this.scene.tweens.add({
      targets: circle,
      scale: 1,
      duration: 200,
      ease: 'Back.easeOut',
      onUpdate: (tween) => {
        const scale = tween.getValue();
        circle.clear();
        circle.fillStyle(0x00aa00, 0.9);
        circle.fillCircle(x, y, 40 * scale);
      },
    });

    // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
    const check = this.scene.add.text(x, y, 'âœ“', {
      fontSize: '48px',
      color: '#ffffff',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    check.setAlpha(0);
    check.setScale(0);
    this.container.add(check);

    this.scene.time.delayedCall(150, () => {
      this.scene.tweens.add({
        targets: check,
        alpha: 1,
        scale: 1,
        duration: 200,
        ease: 'Back.easeOut',
        onComplete: () => {
          // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          this.scene.time.delayedCall(500, () => {
            this.scene.tweens.add({
              targets: [circle, check],
              alpha: 0,
              scale: 1.5,
              duration: 300,
              ease: 'Power2',
              onComplete: () => {
                circle.destroy();
                check.destroy();
                resolve();
              },
            });
          });
        },
      });
    });
  });
}
```

### 2. å ±é…¬è¡¨ç¤º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å ±é…¬ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// DeliveryContainerã«è¿½åŠ 

private async showDeliverySuccess(result: DeliveryResult): Promise<void> {
  return new Promise((resolve) => {
    const centerX = DeliveryContainerLayout.WIDTH / 2;
    const centerY = DeliveryContainerLayout.HEIGHT / 2;

    // å ±é…¬ãƒ‘ãƒãƒ«
    const panel = this.scene.add.container(centerX, centerY);

    // èƒŒæ™¯
    const bg = this.scene.add.graphics();
    bg.fillStyle(0x1a1a3a, 0.95);
    bg.fillRoundedRect(-180, -120, 360, 240, 12);
    bg.lineStyle(2, 0xffd700);
    bg.strokeRoundedRect(-180, -120, 360, 240, 12);
    panel.add(bg);

    // ã‚¿ã‚¤ãƒˆãƒ«
    const title = this.scene.add.text(0, -90, 'ğŸ‰ ç´å“å®Œäº†ï¼ ğŸ‰', {
      ...TextStyles.heading,
      fontSize: '22px',
      color: '#ffd700',
    }).setOrigin(0.5);
    panel.add(title);

    // ä¾é ¼å
    const questName = this.scene.add.text(0, -50, result.quest.name, {
      ...TextStyles.body,
      fontSize: '16px',
    }).setOrigin(0.5);
    panel.add(questName);

    // å ±é…¬ã‚¿ã‚¤ãƒˆãƒ«
    const rewardTitle = this.scene.add.text(0, -15, 'â€• å ±é…¬ â€•', {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#aaaaaa',
    }).setOrigin(0.5);
    panel.add(rewardTitle);

    // ã‚´ãƒ¼ãƒ«ãƒ‰
    const goldText = this.scene.add.text(-60, 15, `ğŸ’° ${result.rewards.gold} G`, {
      ...TextStyles.body,
      fontSize: '18px',
      color: '#ffd700',
    }).setOrigin(0, 0);
    panel.add(goldText);

    // çµŒé¨“å€¤
    const expText = this.scene.add.text(-60, 45, `â­ ${result.rewards.exp} EXP`, {
      ...TextStyles.body,
      fontSize: '18px',
      color: '#00aaff',
    }).setOrigin(0, 0);
    panel.add(expText);

    // ã‚«ãƒ¼ãƒ‰å ±é…¬ãŒã‚ã‚Œã°è¡¨ç¤º
    if (result.rewards.rewardCards && result.rewards.rewardCards.length > 0) {
      const cardText = this.scene.add.text(-60, 75, `ğŸƒ ã‚«ãƒ¼ãƒ‰ x${result.rewards.rewardCards.length}`, {
        ...TextStyles.body,
        fontSize: '14px',
        color: '#aa88ff',
      }).setOrigin(0, 0);
      panel.add(cardText);
    }

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    const closeBtn = this.scene.add.text(0, 100, '[ OK ]', {
      ...TextStyles.body,
      fontSize: '16px',
      color: '#aaaaaa',
    }).setOrigin(0.5).setInteractive();

    closeBtn.on('pointerover', () => closeBtn.setColor('#ffffff'));
    closeBtn.on('pointerout', () => closeBtn.setColor('#aaaaaa'));
    closeBtn.on('pointerdown', () => {
      this.scene.tweens.add({
        targets: panel,
        alpha: 0,
        scale: 0.8,
        duration: 200,
        onComplete: () => {
          panel.destroy();
          resolve();
        },
      });
    });
    panel.add(closeBtn);

    // å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    panel.setAlpha(0);
    panel.setScale(0.8);
    this.container.add(panel);

    this.scene.tweens.add({
      targets: panel,
      alpha: 1,
      scale: 1,
      duration: 300,
      ease: 'Back.easeOut',
    });

    // å ±é…¬ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.animateRewardCountUp(goldText, 0, result.rewards.gold, 'ğŸ’°', 'G');
    this.animateRewardCountUp(expText, 0, result.rewards.exp, 'â­', 'EXP', 200);
  });
}

private animateRewardCountUp(
  textObject: Phaser.GameObjects.Text,
  from: number,
  to: number,
  prefix: string,
  suffix: string,
  delay: number = 0
): void {
  this.scene.time.delayedCall(delay, () => {
    const duration = 1000;
    const startTime = this.scene.time.now;

    const updateText = () => {
      const elapsed = this.scene.time.now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3); // easeOutCubic
      const current = Math.floor(from + (to - from) * eased);

      textObject.setText(`${prefix} ${current} ${suffix}`);

      if (progress < 1) {
        this.scene.time.delayedCall(16, updateText);
      }
    };

    updateText();
  });
}
```

### 3. å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠUI ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å ±é…¬é¸æŠ*

```typescript
// DeliveryContainerã«è¿½åŠ 

private async showRewardCardSelection(cards: Card[]): Promise<Card> {
  return new Promise((resolve) => {
    const selector = new RewardCardSelector({
      scene: this.scene,
      cards: cards,
      title: 'ğŸ å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸æŠ',
      onSelect: (card) => {
        selector.destroy();
        this.eventBus.emit('delivery:reward:card:selected', { card });
        resolve(card);
      },
    });
  });
}
```

### 4. ç´å“å¾Œã®çŠ¶æ…‹æ›´æ–° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çŠ¶æ…‹ç®¡ç†*

```typescript
// DeliveryContainerã«è¿½åŠ 

async deliver(): Promise<void> {
  if (!this.selectedQuest || !this.canDeliver(this.selectedQuest)) {
    this.showCannotDeliverFeedback();
    return;
  }

  const quest = this.selectedQuest;

  // æ“ä½œç„¡åŠ¹åŒ–
  this.setEnabled(false);

  // ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.playDeliveryAnimation();

  // çµæœç”Ÿæˆ
  const result: DeliveryResult = {
    quest,
    deliveredItems: this.getRequiredItems(quest),
    rewards: {
      gold: quest.reward.gold,
      exp: quest.reward.exp,
      rewardCards: quest.reward.cards,
    },
  };

  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.eventBus.emit('delivery:complete', result);

  // å ±é…¬ã‚«ãƒ¼ãƒ‰é¸æŠï¼ˆã‚ã‚Œã°ï¼‰
  let selectedRewardCard: Card | undefined;
  if (result.rewards.rewardCards && result.rewards.rewardCards.length > 0) {
    selectedRewardCard = await this.showRewardCardSelection(result.rewards.rewardCards);
    result.selectedRewardCard = selectedRewardCard;
  }

  // æˆåŠŸè¡¨ç¤º
  await this.showDeliverySuccess(result);

  // ä¾é ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
  this.removeDeliveredQuest(quest);

  // æ“ä½œå†æœ‰åŠ¹åŒ–
  this.setEnabled(true);

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (this.onDeliveryComplete) {
    this.onDeliveryComplete(result);
  }
}

private removeDeliveredQuest(quest: Quest): void {
  this.acceptedQuests = this.acceptedQuests.filter(q => q !== quest);
  this.selectedQuest = null;
  this.updateQuestList();
  this.questPanel?.setQuest(null);
  this.updateDeliverButtonState();

  // æ¬¡ã®ç´å“å¯èƒ½ä¾é ¼ã‚’è‡ªå‹•é¸æŠ
  const deliverableQuests = this.getDeliverableQuests();
  if (deliverableQuests.length > 0) {
    this.selectQuest(deliverableQuests[0]);
  }
}

private showCannotDeliverFeedback(): void {
  // ç´å“ä¸å¯ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  if (this.deliverButton) {
    this.scene.tweens.add({
      targets: this.deliverButton,
      x: this.deliverButton.x + 5,
      duration: 50,
      yoyo: true,
      repeat: 3,
    });
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  const message = this.scene.add.text(
    DeliveryContainerLayout.WIDTH / 2,
    DeliveryContainerLayout.ACTION_AREA.Y - 30,
    'ç´å“ã«å¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
    { ...TextStyles.body, fontSize: '12px', color: '#ff4444' }
  ).setOrigin(0.5);
  this.container.add(message);

  this.scene.tweens.add({
    targets: message,
    y: message.y - 20,
    alpha: 0,
    duration: 1500,
    ease: 'Power2',
    onComplete: () => message.destroy(),
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**Given**: ç´å“å¯èƒ½ãªä¾é ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
**When**: deliverã‚’å®Ÿè¡Œ
**Then**: ç´å“ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç”Ÿã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å ±é…¬è¡¨ç¤º ğŸ”µ

**Given**: ç´å“ãŒå®Œäº†ã—ãŸ
**When**: æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
**Then**: ã‚´ãƒ¼ãƒ«ãƒ‰ã¨çµŒé¨“å€¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒªã‚¹ãƒˆæ›´æ–° ğŸ”µ

**Given**: ä¾é ¼ã‚’ç´å“ã—ãŸ
**When**: ç´å“å®Œäº†å¾Œ
**Then**: ä¾é ¼ãƒªã‚¹ãƒˆã‹ã‚‰ç´å“æ¸ˆã¿ä¾é ¼ãŒæ¶ˆãˆã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0233` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- éåŒæœŸå‡¦ç†ã®ãƒã‚§ãƒ¼ãƒ³ç®¡ç†
- RewardCardSelectorã¨ã®é€£æº
- çŠ¶æ…‹ã®æ•´åˆæ€§ç¶­æŒ

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
