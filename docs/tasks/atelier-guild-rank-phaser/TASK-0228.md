# TASK-0228: AlchemyContainerãƒ¬ã‚·ãƒ”é¸æŠå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0228
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

AlchemyContainerã®ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰é¸æŠæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚æ‰‹æœ­ã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚’é¸æŠã—ã€è©³ç´°è¡¨ç¤ºã¨ç´ æè¦ä»¶ã‚’æç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0227
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0229

## å®Œäº†æ¡ä»¶

- [ ] ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã§ãã‚‹
- [ ] é¸æŠã—ãŸãƒ¬ã‚·ãƒ”ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç´ æè¦ä»¶ãŒæ˜ç¤ºã•ã‚Œã‚‹
- [ ] ãƒ¬ã‚·ãƒ”å¤‰æ›´æ™‚ã«ç´ æé¸æŠãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ãƒ¬ã‚·ãƒ”é¸æŠUIå¼·åŒ– ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ¬ã‚·ãƒ”é¸æŠ*

```typescript
// AlchemyContainerã«è¿½åŠ 

private recipeDetailPanel?: Phaser.GameObjects.Container;
private selectedRecipeHighlight?: Phaser.GameObjects.Graphics;

private createRecipeDetailPanel(): void {
  const { HAND_AREA } = AlchemyContainerLayout;

  this.recipeDetailPanel = this.scene.add.container(
    HAND_AREA.X + HAND_AREA.WIDTH + 20,
    HAND_AREA.Y
  );

  // èƒŒæ™¯
  const bg = this.scene.add.graphics();
  bg.fillStyle(0x2a2a4a, 0.9);
  bg.fillRoundedRect(0, 0, 200, 160, 8);
  bg.lineStyle(1, 0x4a4a6a);
  bg.strokeRoundedRect(0, 0, 200, 160, 8);
  this.recipeDetailPanel.add(bg);

  // ã‚¿ã‚¤ãƒˆãƒ«
  const title = this.scene.add.text(100, 10, 'ãƒ¬ã‚·ãƒ”è©³ç´°', {
    ...TextStyles.body,
    fontSize: '12px',
    color: '#aaaaaa',
  }).setOrigin(0.5, 0);
  this.recipeDetailPanel.add(title);

  this.recipeDetailPanel.setVisible(false);
  this.container.add(this.recipeDetailPanel);
}

private updateRecipeDetailPanel(): void {
  if (!this.selectedRecipe || !this.recipeDetailPanel) {
    this.recipeDetailPanel?.setVisible(false);
    return;
  }

  // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
  const children = this.recipeDetailPanel.getAll().slice(2); // èƒŒæ™¯ã¨ã‚¿ã‚¤ãƒˆãƒ«ã¯æ®‹ã™
  children.forEach(child => child.destroy());

  const recipe = this.selectedRecipe;

  // ãƒ¬ã‚·ãƒ”å
  const nameText = this.scene.add.text(100, 35, recipe.name, {
    ...TextStyles.body,
    fontSize: '14px',
    fontStyle: 'bold',
  }).setOrigin(0.5, 0);
  this.recipeDetailPanel.add(nameText);

  // å¿…è¦ç´ æã‚«ãƒ†ã‚´ãƒª
  const categoryLabel = this.scene.add.text(10, 60, 'å¿…è¦ç´ æ:', {
    ...TextStyles.body,
    fontSize: '11px',
    color: '#aaaaaa',
  });
  this.recipeDetailPanel.add(categoryLabel);

  const categories = recipe.requiredCategories ?? ['any'];
  const categoryText = this.scene.add.text(10, 78, categories.join(', '), {
    ...TextStyles.body,
    fontSize: '11px',
    color: '#ffffff',
  });
  this.recipeDetailPanel.add(categoryText);

  // å¿…è¦ç´ ææ•°
  const countLabel = this.scene.add.text(10, 100, 'å¿…è¦æ•°:', {
    ...TextStyles.body,
    fontSize: '11px',
    color: '#aaaaaa',
  });
  this.recipeDetailPanel.add(countLabel);

  const count = recipe.requiredMaterialCount ?? 1;
  const countText = this.scene.add.text(10, 118, `${count}å€‹`, {
    ...TextStyles.body,
    fontSize: '11px',
    color: '#ffffff',
  });
  this.recipeDetailPanel.add(countText);

  // åŠ¹æœèª¬æ˜
  if (recipe.description) {
    const descText = this.scene.add.text(10, 140, recipe.description, {
      ...TextStyles.body,
      fontSize: '10px',
      color: '#888888',
      wordWrap: { width: 180 },
    });
    this.recipeDetailPanel.add(descText);
  }

  this.recipeDetailPanel.setVisible(true);
}
```

### 2. é¸æŠçŠ¶æ…‹ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é¸æŠãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// AlchemyContainerã«è¿½åŠ 

private handleRecipeSelect(card: RecipeCard): void {
  // å‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
  this.clearRecipeSelection();

  this.selectedRecipe = card;

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
  this.showRecipeHighlight(card);

  // ç´ æã‚’ãƒªã‚»ãƒƒãƒˆ
  this.clearMaterials();

  // ç´ æé¸æŠè‚¢ã‚’æ›´æ–°
  this.updateMaterialOptions();

  // è©³ç´°ãƒ‘ãƒãƒ«æ›´æ–°
  this.updateRecipeDetailPanel();

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  this.updatePreview();

  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.eventBus.emit('alchemy:recipe:selected', { recipe: card });

  // é¸æŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  this.playRecipeSelectAnimation(card);
}

private clearRecipeSelection(): void {
  if (this.selectedRecipeHighlight) {
    this.selectedRecipeHighlight.destroy();
    this.selectedRecipeHighlight = undefined;
  }
}

private showRecipeHighlight(card: RecipeCard): void {
  // HandContainerã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  const cardIndex = this.recipeCards.indexOf(card);
  if (cardIndex < 0) return;

  const { HAND_AREA } = AlchemyContainerLayout;
  const cardWidth = 90;
  const spacing = 10;
  const x = HAND_AREA.X + cardIndex * (cardWidth + spacing) + cardWidth / 2;
  const y = HAND_AREA.Y + 70;

  this.selectedRecipeHighlight = this.scene.add.graphics();
  this.selectedRecipeHighlight.lineStyle(3, Colors.accent);
  this.selectedRecipeHighlight.strokeRoundedRect(
    x - cardWidth / 2 - 5,
    y - 70 - 5,
    cardWidth + 10,
    140 + 10,
    10
  );

  // ã‚°ãƒ­ãƒ¼åŠ¹æœ
  this.scene.tweens.add({
    targets: this.selectedRecipeHighlight,
    alpha: 0.5,
    duration: 500,
    yoyo: true,
    repeat: -1,
    ease: 'Sine.easeInOut',
  });

  this.container.add(this.selectedRecipeHighlight);
}

private playRecipeSelectAnimation(card: RecipeCard): void {
  // ã‚«ãƒ¼ãƒ‰ãŒä¸Šã«æµ®ãä¸ŠãŒã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  const cardIndex = this.recipeCards.indexOf(card);
  if (cardIndex < 0) return;

  // HandContainerã®ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  // å®Ÿéš›ã®å®Ÿè£…ã§ã¯HandContainerã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
  this.handContainer?.animateCardSelect(cardIndex);
}
```

### 3. ãƒ¬ã‚·ãƒ”å¤‰æ›´æ™‚ã®ç´ æãƒªã‚»ãƒƒãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çŠ¶æ…‹ç®¡ç†*

```typescript
// AlchemyContainerã«è¿½åŠ 

private previousRecipe: RecipeCard | null = null;

private handleRecipeSelect(card: RecipeCard): void {
  // åŒã˜ãƒ¬ã‚·ãƒ”ã‚’å†é¸æŠã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
  if (this.previousRecipe === card) {
    return;
  }

  // ãƒ¬ã‚·ãƒ”ãŒå¤‰ã‚ã£ãŸå ´åˆã¯ç´ æã‚’ãƒªã‚»ãƒƒãƒˆ
  if (this.previousRecipe !== null && this.previousRecipe !== card) {
    this.confirmRecipeChange(() => {
      this.executeRecipeChange(card);
    });
  } else {
    this.executeRecipeChange(card);
  }
}

private confirmRecipeChange(onConfirm: () => void): void {
  // ç´ æãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  if (this.selectedMaterials.length > 0) {
    this.showConfirmDialog(
      'ãƒ¬ã‚·ãƒ”ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\né¸æŠä¸­ã®ç´ æã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚',
      onConfirm,
      () => {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šå‰ã®ãƒ¬ã‚·ãƒ”ã‚’å†é¸æŠ
        this.handContainer?.selectCard(this.previousRecipe!);
      }
    );
  } else {
    onConfirm();
  }
}

private executeRecipeChange(card: RecipeCard): void {
  this.previousRecipe = this.selectedRecipe;
  this.selectedRecipe = card;

  // é¸æŠã‚’ã‚¯ãƒªã‚¢
  this.clearRecipeSelection();
  this.showRecipeHighlight(card);

  // ç´ æãƒªã‚»ãƒƒãƒˆ
  this.clearMaterials();

  // æ›´æ–°
  this.updateMaterialOptions();
  this.updateRecipeDetailPanel();
  this.updatePreview();

  this.eventBus.emit('alchemy:recipe:changed', {
    previousRecipe: this.previousRecipe,
    newRecipe: card,
  });
}

private showConfirmDialog(
  message: string,
  onConfirm: () => void,
  onCancel: () => void
): void {
  const dialogContainer = this.scene.add.container(0, 0);
  dialogContainer.setDepth(300);

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const overlay = this.scene.add.graphics();
  overlay.fillStyle(0x000000, 0.7);
  overlay.fillRect(0, 0, this.width, this.height);
  dialogContainer.add(overlay);

  // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const panelWidth = 300;
  const panelHeight = 150;
  const panelX = (this.width - panelWidth) / 2;
  const panelY = (this.height - panelHeight) / 2;

  const panel = this.scene.add.graphics();
  panel.fillStyle(Colors.panelBackground, 1);
  panel.fillRoundedRect(panelX, panelY, panelWidth, panelHeight, 12);
  panel.lineStyle(2, Colors.panelBorder);
  panel.strokeRoundedRect(panelX, panelY, panelWidth, panelHeight, 12);
  dialogContainer.add(panel);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const text = this.scene.add.text(this.width / 2, panelY + 40, message, {
    ...TextStyles.body,
    fontSize: '13px',
    align: 'center',
  }).setOrigin(0.5, 0);
  dialogContainer.add(text);

  // ãƒœã‚¿ãƒ³
  const cancelBtn = this.createButton(
    this.width / 2 - 50,
    panelY + panelHeight - 40,
    'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    () => {
      dialogContainer.destroy();
      onCancel();
    },
    false
  );
  dialogContainer.add(cancelBtn);

  const confirmBtn = this.createButton(
    this.width / 2 + 50,
    panelY + panelHeight - 40,
    'OK',
    () => {
      dialogContainer.destroy();
      onConfirm();
    },
    true
  );
  dialogContainer.add(confirmBtn);

  this.container.add(dialogContainer);
}
```

### 4. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£*

```typescript
// AlchemyContainerã«è¿½åŠ 

private currentRecipeIndex: number = -1;

private setupKeyboardControls(): void {
  // å·¦å³ã‚­ãƒ¼ã§ãƒ¬ã‚·ãƒ”é¸æŠ
  this.scene.input.keyboard?.on('keydown-LEFT', () => {
    if (!this.container.visible) return;
    this.selectPreviousRecipe();
  });

  this.scene.input.keyboard?.on('keydown-RIGHT', () => {
    if (!this.container.visible) return;
    this.selectNextRecipe();
  });

  // Enterã§èª¿åˆ
  this.scene.input.keyboard?.on('keydown-ENTER', () => {
    if (!this.container.visible) return;
    this.craft();
  });

  // Escapeã§ã‚¹ã‚­ãƒƒãƒ—
  this.scene.input.keyboard?.on('keydown-ESC', () => {
    if (!this.container.visible) return;
    this.handleSkip();
  });
}

private selectPreviousRecipe(): void {
  if (this.recipeCards.length === 0) return;

  this.currentRecipeIndex = Math.max(0, this.currentRecipeIndex - 1);
  this.selectRecipe(this.recipeCards[this.currentRecipeIndex]);
}

private selectNextRecipe(): void {
  if (this.recipeCards.length === 0) return;

  this.currentRecipeIndex = Math.min(
    this.recipeCards.length - 1,
    this.currentRecipeIndex + 1
  );
  this.selectRecipe(this.recipeCards[this.currentRecipeIndex]);
}

private removeKeyboardControls(): void {
  this.scene.input.keyboard?.off('keydown-LEFT');
  this.scene.input.keyboard?.off('keydown-RIGHT');
  this.scene.input.keyboard?.off('keydown-ENTER');
  this.scene.input.keyboard?.off('keydown-ESC');
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ¬ã‚·ãƒ”é¸æŠ ğŸ”µ

**Given**: ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒæ‰‹æœ­ã«ã‚ã‚‹
**When**: ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: é¸æŠçŠ¶æ…‹ã«ãªã‚Šè©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ¬ã‚·ãƒ”å¤‰æ›´æ™‚ã®ãƒªã‚»ãƒƒãƒˆ ğŸ”µ

**Given**: ãƒ¬ã‚·ãƒ”AãŒé¸æŠã•ã‚Œç´ æãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
**When**: ãƒ¬ã‚·ãƒ”Bã‚’é¸æŠ
**Then**: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€OKã§ç´ æãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚¤ãƒ™ãƒ³ãƒˆç™ºç« ğŸ”µ

**Given**: AlchemyContainerãŒã‚ã‚‹
**When**: ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ
**Then**: alchemy:recipe:selectedã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0228` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- HandContainerã¨ã®é€£æº
- ãƒ¬ã‚·ãƒ”å¤‰æ›´æ™‚ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (75%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (25%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
