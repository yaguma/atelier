# TASK-0249: GameOver/ClearSceneãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0249
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

GameOverSceneã¨GameClearSceneã®åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚å˜ä½“ãƒ†ã‚¹ãƒˆã¨è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0247, TASK-0248
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0259

## å®Œäº†æ¡ä»¶

- [ ] GameOverSceneã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] GameClearSceneã®å˜ä½“ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] çµ±è¨ˆè¡¨ç¤ºã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. GameOverSceneå˜ä½“ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *åŸºæœ¬ãƒ†ã‚¹ãƒˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/phaser/scenes/GameOverScene.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { GameOverScene, GameOverSceneData } from '@/presentation/phaser/scenes/GameOverScene';
import { createMockScene, createMockEventBus } from '@tests/utils/phaserTestUtils';

describe('GameOverScene', () => {
  let scene: GameOverScene;
  let mockEventBus: any;

  const mockSceneData: GameOverSceneData = {
    reason: 'æœŸé™åˆ‡ã‚Œ - 30æ—¥ä»¥å†…ã«Sç´šã«åˆ°é”ã§ãã¾ã›ã‚“ã§ã—ãŸ',
    finalDay: 30,
    finalRank: 'C',
    totalQuests: 25,
    totalAlchemy: 50,
  };

  beforeEach(() => {
    mockEventBus = createMockEventBus();
    scene = createMockScene(GameOverScene, mockSceneData, mockEventBus);
  });

  describe('åˆæœŸåŒ–', () => {
    it('ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.isCreated()).toBe(true);
    });

    it('å¤±æ•—ç†ç”±ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.getDisplayedReason()).toContain('æœŸé™åˆ‡ã‚Œ');
    });

    it('çµ±è¨ˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      const stats = scene.getDisplayedStats();
      expect(stats.finalDay).toBe(30);
      expect(stats.finalRank).toBe('C');
      expect(stats.totalQuests).toBe(25);
      expect(stats.totalAlchemy).toBe(50);
    });
  });

  describe('å¤±æ•—ç†ç”±åˆ¤å®š', () => {
    it('æœŸé™åˆ‡ã‚Œç†ç”±ã‚’æ­£ã—ãåˆ¤å®š', () => {
      const reasonInfo = scene.getGameOverReason();
      expect(reasonInfo.type).toBe('deadline');
      expect(reasonInfo.title).toBe('æœŸé™åˆ‡ã‚Œ');
    });

    it('è³‡é‡‘ä¸è¶³ç†ç”±ã‚’æ­£ã—ãåˆ¤å®š', () => {
      const bankruptData = {
        ...mockSceneData,
        reason: 'æ‰€æŒé‡‘ãŒ0ã«ãªã‚Šã¾ã—ãŸ',
      };
      const bankruptScene = createMockScene(GameOverScene, bankruptData, mockEventBus);

      const reasonInfo = bankruptScene.getGameOverReason();
      expect(reasonInfo.type).toBe('bankruptcy');
    });

    it('ãƒ©ãƒ³ã‚¯é™æ ¼ç†ç”±ã‚’æ­£ã—ãåˆ¤å®š', () => {
      const rankDownData = {
        ...mockSceneData,
        reason: 'ãƒ©ãƒ³ã‚¯ãŒé™æ ¼ã—ã¾ã—ãŸ',
      };
      const rankDownScene = createMockScene(GameOverScene, rankDownData, mockEventBus);

      const reasonInfo = rankDownScene.getGameOverReason();
      expect(reasonInfo.type).toBe('rankDown');
    });
  });

  describe('ãƒœã‚¿ãƒ³æ“ä½œ', () => {
    it('æœ€åˆã‹ã‚‰ãƒœã‚¿ãƒ³ã§game:restartã‚¤ãƒ™ãƒ³ãƒˆç™ºç«', () => {
      const restartHandler = vi.fn();
      mockEventBus.on('game:restart', restartHandler);

      scene.handleRetry();

      expect(restartHandler).toHaveBeenCalled();
    });

    it('ã‚¿ã‚¤ãƒˆãƒ«ãƒœã‚¿ãƒ³ã§ã‚·ãƒ¼ãƒ³é·ç§»', () => {
      const switchToSpy = vi.spyOn(scene.sceneManager, 'switchTo');

      scene.handleTitle();

      expect(switchToSpy).toHaveBeenCalledWith('TitleScene');
    });
  });
});
```

### 2. GameClearSceneå˜ä½“ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚¯ãƒªã‚¢ãƒ†ã‚¹ãƒˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/presentation/phaser/scenes/GameClearScene.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { GameClearScene, GameClearSceneData } from '@/presentation/phaser/scenes/GameClearScene';
import { createMockScene, createMockEventBus } from '@tests/utils/phaserTestUtils';

describe('GameClearScene', () => {
  let scene: GameClearScene;
  let mockEventBus: any;

  const mockSceneData: GameClearSceneData = {
    clearDay: 25,
    finalRank: 'S',
    totalQuests: 50,
    totalAlchemy: 100,
    totalGold: 15000,
    rareItems: ['ä¼èª¬ã®æ–', 'éŒ¬é‡‘è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–', 'è³¢è€…ã®çŸ³'],
    playTime: 7200, // 2æ™‚é–“
  };

  beforeEach(() => {
    mockEventBus = createMockEventBus();
    scene = createMockScene(GameClearScene, mockSceneData, mockEventBus);
  });

  describe('åˆæœŸåŒ–', () => {
    it('ã‚¯ãƒªã‚¢ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.isCreated()).toBe(true);
    });

    it('ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      expect(scene.hasElement('CONGRATULATIONS')).toBe(true);
    });

    it('çµ±è¨ˆæƒ…å ±ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      const stats = scene.getDisplayedStats();
      expect(stats.clearDay).toBe(25);
      expect(stats.totalQuests).toBe(50);
      expect(stats.totalAlchemy).toBe(100);
      expect(stats.totalGold).toBe(15000);
    });
  });

  describe('ãƒ—ãƒ¬ã‚¤æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', () => {
    it('æ™‚é–“å˜ä½ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', () => {
      expect(scene.formatPlayTime(3600)).toBe('1æ™‚é–“0åˆ†');
      expect(scene.formatPlayTime(7200)).toBe('2æ™‚é–“0åˆ†');
      expect(scene.formatPlayTime(3661)).toBe('1æ™‚é–“1åˆ†');
    });

    it('åˆ†å˜ä½ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', () => {
      expect(scene.formatPlayTime(60)).toBe('1åˆ†0ç§’');
      expect(scene.formatPlayTime(125)).toBe('2åˆ†5ç§’');
    });

    it('ç§’å˜ä½ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', () => {
      expect(scene.formatPlayTime(45)).toBe('0åˆ†45ç§’');
    });
  });

  describe('ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º', () => {
    it('ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
      const rareItemsDisplay = scene.getRareItemsDisplay();
      expect(rareItemsDisplay.length).toBe(3);
    });

    it('5ã¤ä»¥ä¸Šã®å ´åˆã¯+Nè¡¨ç¤º', () => {
      const manyItemsData = {
        ...mockSceneData,
        rareItems: ['item1', 'item2', 'item3', 'item4', 'item5', 'item6', 'item7'],
      };
      const manyItemsScene = createMockScene(GameClearScene, manyItemsData, mockEventBus);

      expect(manyItemsScene.hasMoreItems()).toBe(true);
      expect(manyItemsScene.getMoreItemsCount()).toBe(2);
    });

    it('ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯ç©º', () => {
      const noItemsData = {
        ...mockSceneData,
        rareItems: [],
      };
      const noItemsScene = createMockScene(GameClearScene, noItemsData, mockEventBus);

      expect(noItemsScene.getRareItemsDisplay().length).toBe(0);
    });
  });

  describe('ãƒœã‚¿ãƒ³æ“ä½œ', () => {
    it('ã‚¿ã‚¤ãƒˆãƒ«ãƒœã‚¿ãƒ³ã§ã‚·ãƒ¼ãƒ³é·ç§»', () => {
      const switchToSpy = vi.spyOn(scene.sceneManager, 'switchTo');

      scene.handleTitle();

      expect(switchToSpy).toHaveBeenCalledWith('TitleScene');
    });
  });
});
```

### 3. è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã‚·ãƒ¼ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ç›®è¦–ç¢ºèª*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/test/EndSceneTestScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene } from '../BaseGameScene';
import { GameOverScene, GameOverSceneData } from '../GameOverScene';
import { GameClearScene, GameClearSceneData } from '../GameClearScene';

export class EndSceneTestScene extends BaseGameScene {
  constructor() {
    super('EndSceneTestScene');
  }

  protected onCreate(): void {
    this.createTestControls();
  }

  private createTestControls(): void {
    const panel = this.add.container(512, 384);

    const bg = this.add.graphics();
    bg.fillStyle(0x333333, 0.95);
    bg.fillRoundedRect(-150, -200, 300, 400, 8);
    panel.add(bg);

    const title = this.add.text(0, -170, 'End Scene Test', {
      fontSize: '20px',
      fontStyle: 'bold',
    }).setOrigin(0.5);
    panel.add(title);

    // GameOverãƒ†ã‚¹ãƒˆ
    const gameOverTitle = this.add.text(0, -120, '--- Game Over ---', {
      fontSize: '14px',
      color: '#ff4444',
    }).setOrigin(0.5);
    panel.add(gameOverTitle);

    const gameOverButtons = [
      { label: 'æœŸé™åˆ‡ã‚Œ', action: () => this.testGameOver('deadline') },
      { label: 'è³‡é‡‘ä¸è¶³', action: () => this.testGameOver('bankruptcy') },
      { label: 'ãƒ©ãƒ³ã‚¯é™æ ¼', action: () => this.testGameOver('rankDown') },
    ];

    gameOverButtons.forEach((btn, index) => {
      const y = -80 + index * 40;
      const button = this.createTestButton(btn.label, 0, y, btn.action);
      panel.add(button);
    });

    // GameClearãƒ†ã‚¹ãƒˆ
    const gameClearTitle = this.add.text(0, 50, '--- Game Clear ---', {
      fontSize: '14px',
      color: '#00ff00',
    }).setOrigin(0.5);
    panel.add(gameClearTitle);

    const gameClearButtons = [
      { label: 'æ¨™æº–ã‚¯ãƒªã‚¢', action: () => this.testGameClear('normal') },
      { label: 'é€Ÿæ”»ã‚¯ãƒªã‚¢', action: () => this.testGameClear('fast') },
      { label: 'ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', action: () => this.testGameClear('collector') },
    ];

    gameClearButtons.forEach((btn, index) => {
      const y = 90 + index * 40;
      const button = this.createTestButton(btn.label, 0, y, btn.action);
      panel.add(button);
    });

    panel.setDepth(100);
  }

  private createTestButton(
    label: string,
    x: number,
    y: number,
    onClick: () => void
  ): Phaser.GameObjects.Container {
    const btn = this.add.container(x, y);

    const bg = this.add.graphics();
    bg.fillStyle(0x555555, 1);
    bg.fillRoundedRect(-100, -15, 200, 30, 4);
    btn.add(bg);

    const text = this.add.text(0, 0, label, {
      fontSize: '14px',
    }).setOrigin(0.5);
    btn.add(text);

    btn.setSize(200, 30);
    btn.setInteractive({ useHandCursor: true });
    btn.on('pointerdown', onClick);

    return btn;
  }

  private testGameOver(type: 'deadline' | 'bankruptcy' | 'rankDown'): void {
    let reason: string;
    switch (type) {
      case 'deadline':
        reason = 'æœŸé™åˆ‡ã‚Œ - 30æ—¥ä»¥å†…ã«Sç´šã«åˆ°é”ã§ãã¾ã›ã‚“ã§ã—ãŸ';
        break;
      case 'bankruptcy':
        reason = 'æ‰€æŒé‡‘ãŒ0ã«ãªã‚Šã¾ã—ãŸã€‚æ´»å‹•ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚';
        break;
      case 'rankDown':
        reason = 'ä¾é ¼ã®å¤±æ•—ãŒç¶šãã€ã‚®ãƒ«ãƒ‰ã‹ã‚‰é™¤åã•ã‚Œã¾ã—ãŸã€‚';
        break;
    }

    const data: GameOverSceneData = {
      reason,
      finalDay: Phaser.Math.Between(10, 30),
      finalRank: ['E', 'D', 'C', 'B'][Phaser.Math.Between(0, 3)],
      totalQuests: Phaser.Math.Between(5, 30),
      totalAlchemy: Phaser.Math.Between(10, 60),
    };

    this.scene.start('GameOverScene', data);
  }

  private testGameClear(type: 'normal' | 'fast' | 'collector'): void {
    let data: GameClearSceneData;

    switch (type) {
      case 'fast':
        data = {
          clearDay: 15,
          finalRank: 'S',
          totalQuests: 30,
          totalAlchemy: 60,
          totalGold: 8000,
          rareItems: ['è³¢è€…ã®çŸ³'],
          playTime: 3600,
        };
        break;
      case 'collector':
        data = {
          clearDay: 28,
          finalRank: 'S',
          totalQuests: 80,
          totalAlchemy: 200,
          totalGold: 50000,
          rareItems: [
            'ä¼èª¬ã®æ–', 'éŒ¬é‡‘è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–', 'è³¢è€…ã®çŸ³',
            'é»„é‡‘ã®é‹', 'æ°¸é ã®ç‚', 'ç«œã®æ¶™', 'æ˜Ÿå±‘',
          ],
          playTime: 14400,
        };
        break;
      default:
        data = {
          clearDay: 25,
          finalRank: 'S',
          totalQuests: 50,
          totalAlchemy: 100,
          totalGold: 15000,
          rareItems: ['ä¼èª¬ã®æ–', 'éŒ¬é‡‘è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–', 'è³¢è€…ã®çŸ³'],
          playTime: 7200,
        };
    }

    this.scene.start('GameClearScene', data);
  }
}
```

### 4. ã‚¨ãƒ³ãƒ‰ã‚·ãƒ¼ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ†ã‚¹ãƒˆ*

```typescript
describe('ã‚¨ãƒ³ãƒ‰ã‚·ãƒ¼ãƒ³çµ±åˆ', () => {
  it('GameOverã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚Œã‚‹', () => {
    const gameOverScene = createMockScene(GameOverScene, mockGameOverData, mockEventBus);
    const switchToSpy = vi.spyOn(gameOverScene.sceneManager, 'switchTo');

    gameOverScene.handleTitle();

    expect(switchToSpy).toHaveBeenCalledWith('TitleScene');
  });

  it('GameOverã‹ã‚‰å†æŒ‘æˆ¦ã§ãã‚‹', () => {
    const gameOverScene = createMockScene(GameOverScene, mockGameOverData, mockEventBus);
    const restartHandler = vi.fn();
    mockEventBus.on('game:restart', restartHandler);

    gameOverScene.handleRetry();

    expect(restartHandler).toHaveBeenCalled();
  });

  it('GameClearã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚Œã‚‹', () => {
    const gameClearScene = createMockScene(GameClearScene, mockGameClearData, mockEventBus);
    const switchToSpy = vi.spyOn(gameClearScene.sceneManager, 'switchTo');

    gameClearScene.handleTitle();

    expect(switchToSpy).toHaveBeenCalledWith('TitleScene');
  });
});
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ ğŸ”µ

- GameOverScene: 100%
- GameClearScene: 100%
- çµ±è¨ˆè¡¨ç¤º: 100%
- ãƒ—ãƒ¬ã‚¤æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: 100%
- ãƒœã‚¿ãƒ³æ“ä½œ: 100%

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0249` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- æ¼”å‡ºã®ãƒ†ã‚¹ãƒˆæ–¹æ³•
- è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¢ºèª
- è¦–è¦šçš„ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
