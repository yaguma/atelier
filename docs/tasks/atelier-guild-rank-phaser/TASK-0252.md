# TASK-0252: StateManager Phaseré€£æºå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0252
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

æ—¢å­˜ã®StateManagerã‚’Phaserç’°å¢ƒã«é©å¿œã•ã›ã‚‹ã€‚çŠ¶æ…‹å¤‰æ›´æ™‚ã®PhaserUIè‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0165
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0253

## å®Œäº†æ¡ä»¶

- [ ] StateManagerãŒPhaserç’°å¢ƒã§å‹•ä½œã™ã‚‹
- [ ] çŠ¶æ…‹å¤‰æ›´ãŒEventBusã«è‡ªå‹•é€šçŸ¥ã•ã‚Œã‚‹
- [ ] Phaserã‚·ãƒ¼ãƒ³é–“ã§ã®çŠ¶æ…‹å…±æœ‰ãŒå¯èƒ½
- [ ] ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. PhaserStateManagerå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *çŠ¶æ…‹ç®¡ç†*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/state/PhaserStateManager.ts`

```typescript
import { EventBus } from '../core/EventBus';
import { GameState, PlayerData, QuestData, InventoryData, DeckData } from '@/domain/types';

export interface StateChangeEvent {
  path: string[];
  previousValue: any;
  newValue: any;
}

export type StateChangeListener = (event: StateChangeEvent) => void;

/**
 * Phaserç’°å¢ƒå‘ã‘ã®çŠ¶æ…‹ç®¡ç†ã‚¯ãƒ©ã‚¹
 * çŠ¶æ…‹å¤‰æ›´ã‚’è‡ªå‹•çš„ã«EventBusã«é€šçŸ¥ã™ã‚‹
 */
export class PhaserStateManager {
  private state: GameState;
  private eventBus: EventBus;
  private listeners: Map<string, Set<StateChangeListener>> = new Map();
  private isNotifying: boolean = false;
  private pendingNotifications: StateChangeEvent[] = [];

  constructor(eventBus: EventBus, initialState?: GameState) {
    this.eventBus = eventBus;
    this.state = initialState ?? this.createInitialState();
  }

  private createInitialState(): GameState {
    return {
      player: {
        rank: 'E',
        exp: 0,
        maxExp: 100,
        gold: 500,
        ap: { current: 3, max: 3 },
      },
      progress: {
        currentDay: 1,
        maxDay: 30,
        currentPhase: 'quest-accept',
      },
      quests: {
        available: [],
        accepted: [],
        completed: [],
      },
      inventory: {
        materials: [],
        craftedItems: [],
        artifacts: [],
      },
      deck: {
        cards: [],
        hand: [],
        discard: [],
      },
    };
  }

  // ===== çŠ¶æ…‹å–å¾— =====

  getState(): GameState {
    return this.deepClone(this.state);
  }

  getPlayerData(): PlayerData {
    return this.deepClone(this.state.player);
  }

  getProgress(): typeof this.state.progress {
    return this.deepClone(this.state.progress);
  }

  getQuests(): QuestData {
    return this.deepClone(this.state.quests);
  }

  getInventory(): InventoryData {
    return this.deepClone(this.state.inventory);
  }

  getDeck(): DeckData {
    return this.deepClone(this.state.deck);
  }

  // ===== çŠ¶æ…‹æ›´æ–° =====

  updatePlayer(updates: Partial<PlayerData>): void {
    const previous = this.deepClone(this.state.player);
    this.state.player = { ...this.state.player, ...updates };

    this.notifyChange(['player'], previous, this.state.player);
    this.emitPlayerUpdate();
  }

  updateProgress(updates: Partial<typeof this.state.progress>): void {
    const previous = this.deepClone(this.state.progress);
    this.state.progress = { ...this.state.progress, ...updates };

    this.notifyChange(['progress'], previous, this.state.progress);

    if (updates.currentPhase) {
      this.emitPhaseChange(previous.currentPhase, updates.currentPhase);
    }
  }

  updateQuests(updates: Partial<QuestData>): void {
    const previous = this.deepClone(this.state.quests);
    this.state.quests = { ...this.state.quests, ...updates };

    this.notifyChange(['quests'], previous, this.state.quests);
    this.emitQuestsUpdate();
  }

  updateInventory(updates: Partial<InventoryData>): void {
    const previous = this.deepClone(this.state.inventory);
    this.state.inventory = { ...this.state.inventory, ...updates };

    this.notifyChange(['inventory'], previous, this.state.inventory);
    this.emitInventoryUpdate();
  }

  updateDeck(updates: Partial<DeckData>): void {
    const previous = this.deepClone(this.state.deck);
    this.state.deck = { ...this.state.deck, ...updates };

    this.notifyChange(['deck'], previous, this.state.deck);
    this.emitDeckUpdate();
  }

  // ===== ä¸€æ‹¬æ›´æ–° =====

  setState(newState: GameState): void {
    const previous = this.deepClone(this.state);
    this.state = this.deepClone(newState);

    this.notifyChange([], previous, this.state);
    this.emitFullStateUpdate();
  }

  // ===== ãƒªã‚¹ãƒŠãƒ¼ç®¡ç† =====

  subscribe(path: string, listener: StateChangeListener): () => void {
    if (!this.listeners.has(path)) {
      this.listeners.set(path, new Set());
    }
    this.listeners.get(path)!.add(listener);

    return () => {
      const listeners = this.listeners.get(path);
      if (listeners) {
        listeners.delete(listener);
      }
    };
  }

  private notifyChange(path: string[], previousValue: any, newValue: any): void {
    const event: StateChangeEvent = { path, previousValue, newValue };

    if (this.isNotifying) {
      this.pendingNotifications.push(event);
      return;
    }

    this.isNotifying = true;

    try {
      // å®Œå…¨ãƒ‘ã‚¹ãƒªã‚¹ãƒŠãƒ¼
      const pathKey = path.join('.');
      this.listeners.get(pathKey)?.forEach(listener => listener(event));

      // ãƒ«ãƒ¼ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã™ã¹ã¦ã®å¤‰æ›´ã‚’å—ã‘å–ã‚‹ï¼‰
      this.listeners.get('*')?.forEach(listener => listener(event));

      // ä¿ç•™ä¸­ã®é€šçŸ¥ã‚’å‡¦ç†
      while (this.pendingNotifications.length > 0) {
        const pending = this.pendingNotifications.shift()!;
        const pendingPathKey = pending.path.join('.');
        this.listeners.get(pendingPathKey)?.forEach(listener => listener(pending));
        this.listeners.get('*')?.forEach(listener => listener(pending));
      }
    } finally {
      this.isNotifying = false;
    }
  }

  // ===== EventBusé€šçŸ¥ =====

  private emitPlayerUpdate(): void {
    this.eventBus.emit('app:player:data:updated', {
      rank: this.state.player.rank,
      exp: this.state.player.exp,
      maxExp: this.state.player.maxExp,
      gold: this.state.player.gold,
      ap: this.state.player.ap.current,
      maxAP: this.state.player.ap.max,
      day: this.state.progress.currentDay,
      maxDay: this.state.progress.maxDay,
    });
  }

  private emitPhaseChange(previousPhase: string, currentPhase: string): void {
    this.eventBus.emit('app:phase:changed', {
      phase: currentPhase,
      previousPhase,
    });
  }

  private emitQuestsUpdate(): void {
    this.eventBus.emit('app:quests:available:updated', {
      quests: this.state.quests.available,
    });
    this.eventBus.emit('app:quests:accepted:updated', {
      quests: this.state.quests.accepted,
    });
  }

  private emitInventoryUpdate(): void {
    this.eventBus.emit('app:inventory:updated', {
      items: [
        ...this.state.inventory.materials,
        ...this.state.inventory.craftedItems,
      ],
    });
  }

  private emitDeckUpdate(): void {
    this.eventBus.emit('app:hand:updated', {
      cards: this.state.deck.hand,
    });
    this.eventBus.emit('app:deck:updated', {
      deckCount: this.state.deck.cards.length,
      discardCount: this.state.deck.discard.length,
    });
  }

  private emitFullStateUpdate(): void {
    this.eventBus.emit('app:game:state:updated', {
      currentPhase: this.state.progress.currentPhase,
      playerData: this.state.player,
      inventory: this.state.inventory,
      acceptedQuests: this.state.quests.accepted,
    });

    this.emitPlayerUpdate();
    this.emitQuestsUpdate();
    this.emitInventoryUpdate();
    this.emitDeckUpdate();
  }

  // ===== ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º =====

  serialize(): string {
    return JSON.stringify(this.state);
  }

  deserialize(data: string): void {
    try {
      const parsed = JSON.parse(data);
      this.setState(parsed);
    } catch (error) {
      console.error('Failed to deserialize state:', error);
      throw new Error('Invalid save data');
    }
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====

  private deepClone<T>(obj: T): T {
    return JSON.parse(JSON.stringify(obj));
  }

  reset(): void {
    const initial = this.createInitialState();
    this.setState(initial);
  }
}
```

### 2. çŠ¶æ…‹ã‚»ãƒ¬ã‚¯ã‚¿ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ´¾ç”ŸçŠ¶æ…‹*

```typescript
// src/presentation/phaser/state/StateSelectors.ts

import { PhaserStateManager } from './PhaserStateManager';

/**
 * çŠ¶æ…‹ã‹ã‚‰æ´¾ç”Ÿå€¤ã‚’è¨ˆç®—ã™ã‚‹ã‚»ãƒ¬ã‚¯ã‚¿
 */
export class StateSelectors {
  private stateManager: PhaserStateManager;

  constructor(stateManager: PhaserStateManager) {
    this.stateManager = stateManager;
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£
  canAfford(cost: number): boolean {
    return this.stateManager.getPlayerData().gold >= cost;
  }

  hasEnoughAP(required: number): boolean {
    const player = this.stateManager.getPlayerData();
    return player.ap.current >= required;
  }

  getExpProgress(): number {
    const player = this.stateManager.getPlayerData();
    return player.exp / player.maxExp;
  }

  getDayProgress(): number {
    const progress = this.stateManager.getProgress();
    return progress.currentDay / progress.maxDay;
  }

  // ä¾é ¼é–¢é€£
  getActiveQuestCount(): number {
    return this.stateManager.getQuests().accepted.length;
  }

  canAcceptMoreQuests(maxQuests: number = 3): boolean {
    return this.getActiveQuestCount() < maxQuests;
  }

  getDeliverableQuests(): any[] {
    const quests = this.stateManager.getQuests().accepted;
    const inventory = this.stateManager.getInventory();

    return quests.filter(quest => {
      return quest.requirements.every((req: any) => {
        const item = [...inventory.materials, ...inventory.craftedItems]
          .find(i => i.id === req.itemId);
        return item && item.quantity >= req.quantity;
      });
    });
  }

  // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªé–¢é€£
  getMaterialCount(materialId: string): number {
    const material = this.stateManager.getInventory().materials
      .find(m => m.id === materialId);
    return material?.quantity ?? 0;
  }

  hasRequiredMaterials(requirements: { itemId: string; quantity: number }[]): boolean {
    return requirements.every(req => this.getMaterialCount(req.itemId) >= req.quantity);
  }

  // ãƒ‡ãƒƒã‚­é–¢é€£
  getHandSize(): number {
    return this.stateManager.getDeck().hand.length;
  }

  getDeckSize(): number {
    return this.stateManager.getDeck().cards.length;
  }

  getDiscardSize(): number {
    return this.stateManager.getDeck().discard.length;
  }

  canDraw(): boolean {
    return this.getDeckSize() > 0 || this.getDiscardSize() > 0;
  }

  // è¤‡åˆæ¡ä»¶
  isGameOver(): boolean {
    const progress = this.stateManager.getProgress();
    const player = this.stateManager.getPlayerData();

    // æ—¥æ•°ã‚ªãƒ¼ãƒãƒ¼
    if (progress.currentDay > progress.maxDay) return true;

    // ã‚´ãƒ¼ãƒ«ãƒ‰æ¯æ¸‡
    if (player.gold < 0) return true;

    return false;
  }

  isGameClear(): boolean {
    const player = this.stateManager.getPlayerData();
    return player.rank === 'S';
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: çŠ¶æ…‹æ›´æ–°é€šçŸ¥ ğŸŸ¡

**Given**: StateManagerã«ãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
**When**: çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
**Then**: ãƒªã‚¹ãƒŠãƒ¼ãŒå‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: EventBusé€£æº ğŸŸ¡

**Given**: StateManagerãŒEventBusã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹
**When**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
**Then**: app:player:data:updatedã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º ğŸŸ¡

**Given**: çŠ¶æ…‹ãŒã‚ã‚‹
**When**: serializeâ†’deserializeã™ã‚‹
**Then**: å…ƒã®çŠ¶æ…‹ãŒå¾©å…ƒã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0252` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ä¸å¤‰æ€§ã®ç¶­æŒï¼ˆdeepCloneï¼‰
- å¾ªç’°é€šçŸ¥ã®é˜²æ­¢
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆé »ç¹ãªæ›´æ–°æ™‚ï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ï¼‰
