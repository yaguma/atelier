# TASK-0269: EventBuså…¨ã‚¤ãƒ™ãƒ³ãƒˆçµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0269
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

EventBusã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å…¨32ç¨®é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãç™ºç«ãƒ»å—ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0238 (MainScene EventBusçµ±åˆ), TASK-0251 (EventBus-UseCaseé€£æºå®Ÿè£…)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0270

## å®Œäº†æ¡ä»¶

- [x] UIâ†’Appã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ12ç¨®é¡ï¼‰ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Appâ†’UIã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ20ç¨®é¡ï¼‰ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å‹å®‰å…¨æ€§ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] ã‚¤ãƒ™ãƒ³ãƒˆé †åºã®æ¤œè¨¼ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

---

## ãƒ†ã‚¹ãƒˆå®Ÿè£…è©³ç´°

### 1. EventBusçµ±åˆãƒ†ã‚¹ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *çµ±åˆãƒ†ã‚¹ãƒˆ*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/phase5/EventBusIntegration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createTestGame } from '../../../utils/phaserTestUtils';
import { EventBus } from '@/presentation/phaser/core/EventBus';

describe('EventBus Full Integration', () => {
  let game: Phaser.Game;
  let eventBus: EventBus;

  beforeEach(async () => {
    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
  });

  afterEach(() => {
    game.destroy(true);
  });

  describe('UI to App Events (12 types)', () => {
    const uiToAppEvents = [
      'ui:quest:accept:requested',
      'ui:quest:delivery:requested',
      'ui:gathering:execute:requested',
      'ui:alchemy:craft:requested',
      'ui:shop:purchase:requested',
      'ui:card:draw:requested',
      'ui:deck:shuffle:requested',
      'ui:phase:skip:requested',
      'ui:day:end:requested',
      'ui:game:save:requested',
      'ui:game:load:requested',
      'ui:rankup:challenge:requested',
    ];

    uiToAppEvents.forEach(eventType => {
      it(`${eventType} ãŒç™ºç«ãƒ»å—ä¿¡ã§ãã‚‹`, async () => {
        // Arrange
        const callback = vi.fn();
        eventBus.on(eventType, callback);

        // Act
        eventBus.emit(eventType, { testPayload: true });

        // Assert
        expect(callback).toHaveBeenCalledWith({ testPayload: true });
      });
    });

    describe('Quest Events', () => {
      it('ui:quest:accept:requested ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('ui:quest:accept:requested', callback);

        eventBus.emit('ui:quest:accept:requested', { questId: 'quest_001' });

        expect(callback).toHaveBeenCalledWith({ questId: 'quest_001' });
      });

      it('ui:quest:delivery:requested ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('ui:quest:delivery:requested', callback);

        eventBus.emit('ui:quest:delivery:requested', {
          questId: 'quest_001',
          itemIds: ['item_1', 'item_2'],
        });

        expect(callback).toHaveBeenCalledWith({
          questId: 'quest_001',
          itemIds: ['item_1', 'item_2'],
        });
      });
    });

    describe('Gathering Events', () => {
      it('ui:gathering:execute:requested ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('ui:gathering:execute:requested', callback);

        eventBus.emit('ui:gathering:execute:requested', {
          cardId: 'card_001',
          selectedMaterialIds: ['mat_1', 'mat_2'],
        });

        expect(callback).toHaveBeenCalledWith({
          cardId: 'card_001',
          selectedMaterialIds: ['mat_1', 'mat_2'],
        });
      });
    });

    describe('Alchemy Events', () => {
      it('ui:alchemy:craft:requested ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('ui:alchemy:craft:requested', callback);

        eventBus.emit('ui:alchemy:craft:requested', {
          recipeCardId: 'recipe_001',
          materialIds: ['mat_1', 'mat_2', 'mat_3'],
        });

        expect(callback).toHaveBeenCalledWith({
          recipeCardId: 'recipe_001',
          materialIds: ['mat_1', 'mat_2', 'mat_3'],
        });
      });
    });

    describe('Shop Events', () => {
      it('ui:shop:purchase:requested ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('ui:shop:purchase:requested', callback);

        eventBus.emit('ui:shop:purchase:requested', {
          category: 'card',
          itemId: 'item_001',
          quantity: 2,
        });

        expect(callback).toHaveBeenCalledWith({
          category: 'card',
          itemId: 'item_001',
          quantity: 2,
        });
      });
    });
  });

  describe('App to UI Events (20 types)', () => {
    const appToUiEvents = [
      'app:quest:accepted',
      'app:quest:delivered',
      'app:quests:available:updated',
      'app:quests:accepted:updated',
      'app:gathering:complete',
      'app:alchemy:crafted',
      'app:shop:purchased',
      'app:hand:updated',
      'app:deck:updated',
      'app:inventory:updated',
      'app:player:data:updated',
      'app:phase:changed',
      'app:phase:data:loaded',
      'app:day:ended',
      'app:game:over',
      'app:game:clear',
      'app:game:state:updated',
      'app:rankup:success',
      'app:rankup:failed',
      'app:error:occurred',
    ];

    appToUiEvents.forEach(eventType => {
      it(`${eventType} ãŒç™ºç«ãƒ»å—ä¿¡ã§ãã‚‹`, async () => {
        // Arrange
        const callback = vi.fn();
        eventBus.on(eventType, callback);

        // Act
        eventBus.emit(eventType, { testPayload: true });

        // Assert
        expect(callback).toHaveBeenCalledWith({ testPayload: true });
      });
    });

    describe('Player Data Events', () => {
      it('app:player:data:updated ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:player:data:updated', callback);

        eventBus.emit('app:player:data:updated', {
          rank: 'C',
          exp: 250,
          maxExp: 400,
          gold: 1500,
          ap: 2,
          maxAP: 3,
          day: 15,
          maxDay: 30,
        });

        expect(callback).toHaveBeenCalledWith(
          expect.objectContaining({
            rank: 'C',
            gold: 1500,
            day: 15,
          })
        );
      });
    });

    describe('Phase Events', () => {
      it('app:phase:changed ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:phase:changed', callback);

        eventBus.emit('app:phase:changed', {
          phase: 'gathering',
          previousPhase: 'quest-accept',
        });

        expect(callback).toHaveBeenCalledWith({
          phase: 'gathering',
          previousPhase: 'quest-accept',
        });
      });

      it('app:phase:data:loaded ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:phase:data:loaded', callback);

        eventBus.emit('app:phase:data:loaded', {
          gatheringCards: [{ id: 'card_1' }],
          ap: 3,
        });

        expect(callback).toHaveBeenCalledWith(
          expect.objectContaining({
            gatheringCards: expect.any(Array),
          })
        );
      });
    });

    describe('Game End Events', () => {
      it('app:game:over ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:game:over', callback);

        eventBus.emit('app:game:over', {
          reason: 'æœŸé™åˆ‡ã‚Œ',
          stats: {
            finalDay: 30,
            finalRank: 'C',
            totalQuests: 15,
          },
        });

        expect(callback).toHaveBeenCalledWith(
          expect.objectContaining({
            reason: 'æœŸé™åˆ‡ã‚Œ',
            stats: expect.objectContaining({
              finalDay: 30,
            }),
          })
        );
      });

      it('app:game:clear ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:game:clear', callback);

        eventBus.emit('app:game:clear', {
          stats: {
            clearDay: 25,
            finalRank: 'S',
            totalQuests: 30,
            totalScore: 15000,
          },
        });

        expect(callback).toHaveBeenCalledWith(
          expect.objectContaining({
            stats: expect.objectContaining({
              clearDay: 25,
              finalRank: 'S',
            }),
          })
        );
      });
    });

    describe('Error Events', () => {
      it('app:error:occurred ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ã„', () => {
        const callback = vi.fn();
        eventBus.on('app:error:occurred', callback);

        eventBus.emit('app:error:occurred', {
          code: 'INSUFFICIENT_GOLD',
          message: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
          recoverable: true,
        });

        expect(callback).toHaveBeenCalledWith({
          code: 'INSUFFICIENT_GOLD',
          message: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
          recoverable: true,
        });
      });
    });
  });

  describe('Event Subscription Management', () => {
    it('ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ã§ãã‚‹', () => {
      const callback = vi.fn();
      const unsubscribe = eventBus.on('test:event', callback);

      unsubscribe();
      eventBus.emit('test:event', {});

      expect(callback).not.toHaveBeenCalled();
    });

    it('åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã«è¤‡æ•°ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã§ãã‚‹', () => {
      const callback1 = vi.fn();
      const callback2 = vi.fn();

      eventBus.on('test:event', callback1);
      eventBus.on('test:event', callback2);

      eventBus.emit('test:event', { data: 'test' });

      expect(callback1).toHaveBeenCalledWith({ data: 'test' });
      expect(callback2).toHaveBeenCalledWith({ data: 'test' });
    });

    it('once ã§ä¸€åº¦ã ã‘ç™ºç«ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã§ãã‚‹', () => {
      const callback = vi.fn();

      eventBus.once('test:event', callback);

      eventBus.emit('test:event', { first: true });
      eventBus.emit('test:event', { second: true });

      expect(callback).toHaveBeenCalledTimes(1);
      expect(callback).toHaveBeenCalledWith({ first: true });
    });

    it('å…¨ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ã§ãã‚‹', () => {
      const callback = vi.fn();
      eventBus.on('test:event', callback);

      eventBus.removeAllListeners('test:event');
      eventBus.emit('test:event', {});

      expect(callback).not.toHaveBeenCalled();
    });
  });

  describe('Event Order Verification', () => {
    it('ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«é †ã«å‡¦ç†ã•ã‚Œã‚‹', () => {
      const order: string[] = [];

      eventBus.on('event:a', () => order.push('a'));
      eventBus.on('event:b', () => order.push('b'));
      eventBus.on('event:c', () => order.push('c'));

      eventBus.emit('event:a', {});
      eventBus.emit('event:b', {});
      eventBus.emit('event:c', {});

      expect(order).toEqual(['a', 'b', 'c']);
    });

    it('åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²é †ã«å‡¦ç†ã•ã‚Œã‚‹', () => {
      const order: number[] = [];

      eventBus.on('test:event', () => order.push(1));
      eventBus.on('test:event', () => order.push(2));
      eventBus.on('test:event', () => order.push(3));

      eventBus.emit('test:event', {});

      expect(order).toEqual([1, 2, 3]);
    });
  });

  describe('Event Chain Verification', () => {
    it('UIâ†’Appâ†’UIã®ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
      // Arrange
      const chain: string[] = [];

      // UIâ†’Appãƒãƒ³ãƒ‰ãƒ©
      eventBus.on('ui:quest:accept:requested', (data) => {
        chain.push('ui-to-app');
        // Appå‡¦ç†å¾Œã«UIã¸é€šçŸ¥
        eventBus.emit('app:quest:accepted', {
          quest: { id: data.questId },
        });
      });

      // Appâ†’UIãƒãƒ³ãƒ‰ãƒ©
      eventBus.on('app:quest:accepted', () => {
        chain.push('app-to-ui');
      });

      // Act
      eventBus.emit('ui:quest:accept:requested', { questId: 'q1' });

      // Assert
      expect(chain).toEqual(['ui-to-app', 'app-to-ui']);
    });

    it('ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³ãŒæ­£ã—ã„', async () => {
      const chain: string[] = [];

      eventBus.on('ui:phase:complete', () => chain.push('phase-complete'));
      eventBus.on('app:phase:changed', () => chain.push('phase-changed'));
      eventBus.on('app:phase:data:loaded', () => chain.push('data-loaded'));

      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      eventBus.emit('ui:phase:complete', { phase: 'quest-accept' });
      eventBus.emit('app:phase:changed', { phase: 'gathering', previousPhase: 'quest-accept' });
      eventBus.emit('app:phase:data:loaded', { gatheringCards: [] });

      expect(chain).toEqual(['phase-complete', 'phase-changed', 'data-loaded']);
    });
  });

  describe('Error Handling', () => {
    it('ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼ãŒä»–ã®ãƒªã‚¹ãƒŠãƒ¼ã«å½±éŸ¿ã—ãªã„', () => {
      const callback1 = vi.fn().mockImplementation(() => {
        throw new Error('Listener error');
      });
      const callback2 = vi.fn();

      eventBus.on('test:event', callback1);
      eventBus.on('test:event', callback2);

      // ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
      try {
        eventBus.emit('test:event', {});
      } catch {
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶šè¡Œ
      }

      // 2ç•ªç›®ã®ãƒªã‚¹ãƒŠãƒ¼ã¯å‘¼ã°ã‚Œã‚‹ï¼ˆå®Ÿè£…ä¾å­˜ï¼‰
      // expect(callback2).toHaveBeenCalled();
    });

    it('æœªç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„', () => {
      // Act & Assert - ã‚¨ãƒ©ãƒ¼ãªã—
      expect(() => {
        eventBus.emit('nonexistent:event', {});
      }).not.toThrow();
    });
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0269` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|-----------|---------------|
| UIâ†’Appã‚¤ãƒ™ãƒ³ãƒˆ | 100% |
| Appâ†’UIã‚¤ãƒ™ãƒ³ãƒˆ | 100% |
| ãƒªã‚¹ãƒŠãƒ¼ç®¡ç† | 95% |
| ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒ¼ãƒ³ | 90% |

---

## æ³¨æ„äº‹é …

- ã‚¤ãƒ™ãƒ³ãƒˆåã®æ­£ç¢ºæ€§
- ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å‹ã®ä¸€è‡´
- ãƒªã‚¹ãƒŠãƒ¼è§£é™¤ã®ç¢ºå®Ÿæ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ï¼‰
