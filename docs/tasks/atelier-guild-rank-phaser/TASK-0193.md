# TASK-0193: CardViewホバーエフェクト実装

**タスクID**: TASK-0193
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 2 - 基本シーン・共通UI実装
**信頼性レベル**: 🟡 *妥当な推測に基づく*

## 関連文書

- **概要**: [overview.md](./overview.md)
- **UI設計**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## タスク概要

カードのホバー時にツールチップや詳細情報を表示するエフェクトを実装する。

## 依存タスク

- **前提タスク**: TASK-0192
- **後続タスク**: TASK-0194

## 完了条件

- [x] ホバー時にカードが拡大表示される
- [x] ホバー時にツールチップが表示される
- [x] ツールチップにカード詳細情報が含まれる
- [x] マウスアウトでツールチップが消える
- [x] アニメーションがスムーズである

---

## 実装詳細

### 1. CardTooltip実装 🟡

**信頼性**: 🟡 *rexUIのTooltipを参考*

**実装ファイル**: `src/presentation/phaser/ui/card/CardTooltip.ts`

```typescript
import Phaser from 'phaser';
import { Card } from '../../../../domain/card/Card';
import { GatheringCard } from '../../../../domain/card/GatheringCard';
import { RecipeCard } from '../../../../domain/card/RecipeCard';
import { EnhancementCard } from '../../../../domain/card/EnhancementCard';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class CardTooltip {
  private container: Phaser.GameObjects.Container;
  private scene: Phaser.Scene;
  private background!: Phaser.GameObjects.Graphics;
  private titleText!: Phaser.GameObjects.Text;
  private descriptionText!: Phaser.GameObjects.Text;
  private detailsText!: Phaser.GameObjects.Text;

  private readonly width = 220;
  private readonly padding = 12;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.container = scene.add.container(0, 0);
    this.container.setDepth(1500);
    this.container.setVisible(false);

    // 背景
    this.background = scene.add.graphics();
    this.container.add(this.background);

    // タイトル
    this.titleText = scene.add.text(
      this.padding, this.padding,
      '',
      { ...TextStyles.cardName, fontSize: '14px' }
    );
    this.container.add(this.titleText);

    // 説明
    this.descriptionText = scene.add.text(
      this.padding, this.padding + 25,
      '',
      { ...TextStyles.body, fontSize: '12px', wordWrap: { width: this.width - this.padding * 2 } }
    );
    this.container.add(this.descriptionText);

    // 詳細
    this.detailsText = scene.add.text(
      this.padding, this.padding + 70,
      '',
      { ...TextStyles.bodySmall, fontSize: '11px', wordWrap: { width: this.width - this.padding * 2 } }
    );
    this.container.add(this.detailsText);
  }

  show(card: Card, x: number, y: number): void {
    // カード情報を設定
    this.titleText.setText(card.name);
    this.descriptionText.setText(this.getDescription(card));
    this.detailsText.setText(this.getDetails(card));

    // 高さを計算
    const height = this.calculateHeight();

    // 背景を描画
    this.background.clear();
    this.background.fillStyle(Colors.backgroundDark, 0.95);
    this.background.fillRoundedRect(0, 0, this.width, height, 8);
    this.background.lineStyle(1, Colors.panelBorder);
    this.background.strokeRoundedRect(0, 0, this.width, height, 8);

    // 位置調整（画面外にはみ出さないように）
    const adjustedX = this.adjustX(x);
    const adjustedY = this.adjustY(y, height);
    this.container.setPosition(adjustedX, adjustedY);

    // 表示アニメーション
    this.container.setAlpha(0);
    this.container.setVisible(true);
    this.scene.tweens.add({
      targets: this.container,
      alpha: 1,
      duration: 150,
      ease: 'Power2',
    });
  }

  hide(): void {
    this.scene.tweens.add({
      targets: this.container,
      alpha: 0,
      duration: 100,
      ease: 'Power2',
      onComplete: () => {
        this.container.setVisible(false);
      },
    });
  }

  destroy(): void {
    this.container.destroy();
  }

  private getDescription(card: Card): string {
    if (card instanceof GatheringCard) {
      return `APコスト: ${card.apCost}\n採取地で素材を獲得`;
    } else if (card instanceof RecipeCard) {
      return `APコスト: ${card.apCost}\n${card.outputItem.name}を調合`;
    } else if (card instanceof EnhancementCard) {
      return `APコスト: ${card.apCost}\n${card.description ?? '特殊効果'}`;
    }
    return '';
  }

  private getDetails(card: Card): string {
    if (card instanceof GatheringCard) {
      return '獲得可能素材:\n' + card.materials.map(m => `・${m.name}`).join('\n');
    } else if (card instanceof RecipeCard) {
      return '必要素材:\n' + card.requiredMaterials.map(m => `・${m.material.name}`).join('\n');
    } else if (card instanceof EnhancementCard) {
      return card.effect?.description ?? '';
    }
    return '';
  }

  private calculateHeight(): number {
    const titleHeight = 25;
    const descHeight = this.descriptionText.height + 10;
    const detailsHeight = this.detailsText.height;
    return this.padding * 2 + titleHeight + descHeight + detailsHeight;
  }

  private adjustX(x: number): number {
    const screenWidth = this.scene.cameras.main.width;
    if (x + this.width > screenWidth - 10) {
      return x - this.width - 20;
    }
    return x + 20;
  }

  private adjustY(y: number, height: number): number {
    const screenHeight = this.scene.cameras.main.height;
    if (y + height > screenHeight - 10) {
      return screenHeight - height - 10;
    }
    return y;
  }
}
```

### 2. CardViewにツールチップ統合 🟡

**信頼性**: 🟡 *各CardViewクラスに追加*

```typescript
// 各CardViewクラスのコンストラクタに追加
private tooltip?: CardTooltip;

// setInteractiveメソッドに追加
this.container.on('pointerover', () => {
  // ... 既存のホバー処理 ...

  // ツールチップ表示
  if (this.tooltip) {
    const worldPoint = this.container.getWorldTransformMatrix();
    this.tooltip.show(this.card, worldPoint.tx + 80, worldPoint.ty);
  }
});

this.container.on('pointerout', () => {
  // ... 既存のアウト処理 ...

  // ツールチップ非表示
  if (this.tooltip) {
    this.tooltip.hide();
  }
});
```

---

## 単体テスト要件

### テストケース1: ツールチップ表示 🟡

**Given**: CardViewがある
**When**: ホバーする
**Then**: ツールチップが表示される

### テストケース2: ツールチップ非表示 🟡

**Given**: ツールチップが表示されている
**When**: マウスアウトする
**Then**: ツールチップが非表示になる

---

## 実装手順

1. `/tsumiki:tdd-requirements TASK-0193` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- ツールチップの画面外配置防止
- 高速マウス移動時の処理
- パフォーマンスへの影響

---

## 信頼性レベルサマリー

- **総項目数**: 2項目
- 🔵 **青信号**: 0項目 (0%)
- 🟡 **黄信号**: 2項目 (100%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 中品質
