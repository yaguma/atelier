# TASK-0165: EventBuså®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0165
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

IEventBusã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã€Phaser UIã¨Applicationå±¤ã®ç–çµåˆé€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0164
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0166, TASK-0167, TASK-0250, TASK-0252

## å®Œäº†æ¡ä»¶

- [ ] EventBusã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] emit/on/off/once/clearãƒ¡ã‚½ãƒƒãƒ‰ãŒå‹•ä½œã™ã‚‹
- [ ] å‹å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œãƒ»è³¼èª­ãŒã§ãã‚‹
- [ ] ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå–å¾—ã§ãã‚‹
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªãunsubscribeã§ãã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. EventBuså®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒŸãƒƒã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/EventBus.ts`

```typescript
import { IEventBus, EventCallback, UnsubscribeFn } from './IEventBus';
import { EventKey, EventPayloadMap } from './EventPayloads';

type Listener = {
  callback: EventCallback<unknown>;
  once: boolean;
};

export class EventBus implements IEventBus {
  private static instance: EventBus | null = null;
  private listeners: Map<string, Set<Listener>> = new Map();

  private constructor() {}

  public static getInstance(): EventBus {
    if (!EventBus.instance) {
      EventBus.instance = new EventBus();
    }
    return EventBus.instance;
  }

  public static resetInstance(): void {
    if (EventBus.instance) {
      EventBus.instance.clear();
      EventBus.instance = null;
    }
  }

  emit<K extends keyof EventPayloadMap>(
    event: K,
    payload: EventPayloadMap[K]
  ): void {
    const eventListeners = this.listeners.get(event as string);
    if (!eventListeners) return;

    const toRemove: Listener[] = [];
    eventListeners.forEach(listener => {
      listener.callback(payload);
      if (listener.once) {
        toRemove.push(listener);
      }
    });

    toRemove.forEach(listener => eventListeners.delete(listener));
  }

  emitVoid(event: EventKey): void {
    const eventListeners = this.listeners.get(event);
    if (!eventListeners) return;

    const toRemove: Listener[] = [];
    eventListeners.forEach(listener => {
      listener.callback(undefined);
      if (listener.once) {
        toRemove.push(listener);
      }
    });

    toRemove.forEach(listener => eventListeners.delete(listener));
  }

  on<K extends keyof EventPayloadMap>(
    event: K,
    callback: EventCallback<EventPayloadMap[K]>
  ): UnsubscribeFn {
    return this.addListener(event as string, callback as EventCallback<unknown>, false);
  }

  onVoid(event: EventKey, callback: () => void): UnsubscribeFn {
    return this.addListener(event, callback as EventCallback<unknown>, false);
  }

  once<K extends keyof EventPayloadMap>(
    event: K,
    callback: EventCallback<EventPayloadMap[K]>
  ): UnsubscribeFn {
    return this.addListener(event as string, callback as EventCallback<unknown>, true);
  }

  off(event: EventKey, callback?: EventCallback<unknown>): void {
    const eventListeners = this.listeners.get(event);
    if (!eventListeners) return;

    if (callback) {
      const toRemove = Array.from(eventListeners).filter(l => l.callback === callback);
      toRemove.forEach(l => eventListeners.delete(l));
    } else {
      eventListeners.clear();
    }
  }

  clear(): void {
    this.listeners.clear();
  }

  private addListener(
    event: string,
    callback: EventCallback<unknown>,
    once: boolean
  ): UnsubscribeFn {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }

    const listener: Listener = { callback, once };
    this.listeners.get(event)!.add(listener);

    return () => {
      const eventListeners = this.listeners.get(event);
      if (eventListeners) {
        eventListeners.delete(listener);
      }
    };
  }

  // ãƒ‡ãƒãƒƒã‚°ç”¨
  getListenerCount(event?: EventKey): number {
    if (event) {
      return this.listeners.get(event)?.size ?? 0;
    }
    let count = 0;
    this.listeners.forEach(set => count += set.size);
    return count;
  }
}
```

### 2. EventBusã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/index.ts`

```typescript
export { EventBus } from './EventBus';
export { IEventBus, EventCallback, UnsubscribeFn } from './IEventBus';
export { UIActionEvents, StateUpdateEvents, EventKey } from './EventTypes';
export * from './EventPayloads';
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã¨è³¼èª­ ğŸŸ¡

**Given**: EventBusã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹
**When**: on()ã§è³¼èª­ã—emit()ã§ç™ºè¡Œã™ã‚‹
**Then**: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è³¼èª­è§£é™¤ ğŸŸ¡

**Given**: ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¦ã„ã‚‹
**When**: unsubscribeé–¢æ•°ã‚’å‘¼ã¶
**Then**: ä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: onceè³¼èª­ ğŸŸ¡

**Given**: once()ã§è³¼èª­ã—ã¦ã„ã‚‹
**When**: ã‚¤ãƒ™ãƒ³ãƒˆã‚’2å›ç™ºè¡Œã™ã‚‹
**Then**: ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯1å›ã ã‘å‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: clear ğŸŸ¡

**Given**: è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¦ã„ã‚‹
**When**: clear()ã‚’å‘¼ã¶
**Then**: ã™ã¹ã¦ã®è³¼èª­ãŒè§£é™¤ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ ğŸŸ¡

**Given**: EventBus.getInstance()ã‚’2å›å‘¼ã¶
**When**: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¯”è¼ƒã™ã‚‹
**Then**: åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0165` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ãƒ†ã‚¹ãƒˆé–“ã§ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ã®ä¾‹å¤–ãŒã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã‚’å£Šã•ãªã„ã‚ˆã†ã«ã™ã‚‹
- ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒªã‚¹ãƒŠãƒ¼ã‚«ã‚¦ãƒ³ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
