# TASK-0212: BasePhaseContainerè¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0212
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

å„ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆä¾é ¼å—æ³¨ã€æ¡å–ã€èª¿åˆã€ç´å“ï¼‰ã®åŸºåº•ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒ©ã‚¹ã‚’è¨­è¨ˆã™ã‚‹ã€‚å…±é€šã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0168
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0213

## å®Œäº†æ¡ä»¶

- [x] IPhaseContainerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [x] å…±é€šãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ï¼ˆenter/exit/updateï¼‰ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [x] EventBusã¨ã®é€£æºæ–¹æ³•ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [x] å­ã‚¯ãƒ©ã‚¹ã§ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ˜ç¢º

---

## å®Ÿè£…è©³ç´°

### 1. IPhaseContainerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/IPhaseContainer.ts`

```typescript
import Phaser from 'phaser';
import { GamePhase } from '../../../../domain/common/GamePhase';
import { EventBus } from '../../core/EventBus';

export interface PhaseContainerConfig {
  scene: Phaser.Scene;
  eventBus: EventBus;
  x?: number;
  y?: number;
  width?: number;
  height?: number;
}

export interface IPhaseContainer {
  // è­˜åˆ¥
  readonly phase: GamePhase;
  readonly container: Phaser.GameObjects.Container;

  // ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
  enter(): Promise<void>;
  exit(): Promise<void>;
  update(delta: number): void;

  // è¡¨ç¤ºåˆ¶å¾¡
  setVisible(visible: boolean): void;
  setEnabled(enabled: boolean): void;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  canComplete(): boolean;
  complete(): void;
  cancel(): void;

  // ç ´æ£„
  destroy(): void;
}
```

### 2. PhaseContainerEvents ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/PhaseContainerEvents.ts`

```typescript
import { GamePhase } from '../../../../domain/common/GamePhase';

export interface PhaseContainerEvents {
  // ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†
  'phase:complete': { phase: GamePhase; result?: any };

  // ãƒ•ã‚§ãƒ¼ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒ«
  'phase:cancel': { phase: GamePhase };

  // ãƒ•ã‚§ãƒ¼ã‚ºå†…ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  'phase:action': { phase: GamePhase; action: string; data?: any };

  // ã‚¨ãƒ©ãƒ¼
  'phase:error': { phase: GamePhase; error: Error };
}
```

### 3. BasePhaseContaineråŸºåº•ã‚¯ãƒ©ã‚¹è¨­è¨ˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æŠ½è±¡ã‚¯ãƒ©ã‚¹*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/BasePhaseContainer.ts`

```typescript
import Phaser from 'phaser';
import { GamePhase } from '../../../../domain/common/GamePhase';
import { IPhaseContainer, PhaseContainerConfig } from './IPhaseContainer';
import { EventBus } from '../../core/EventBus';
import { Colors } from '../../config/ColorPalette';

export abstract class BasePhaseContainer implements IPhaseContainer {
  public abstract readonly phase: GamePhase;
  public readonly container: Phaser.GameObjects.Container;

  protected scene: Phaser.Scene;
  protected eventBus: EventBus;
  protected width: number;
  protected height: number;
  protected enabled: boolean = true;
  protected isActive: boolean = false;

  constructor(config: PhaseContainerConfig) {
    this.scene = config.scene;
    this.eventBus = config.eventBus;
    this.width = config.width ?? 800;
    this.height = config.height ?? 500;

    const x = config.x ?? 200;
    const y = config.y ?? 150;

    this.container = this.scene.add.container(x, y);
    this.container.setDepth(200);
    this.container.setVisible(false);

    // åŸºæœ¬æ§‹é€ ã‚’ä½œæˆ
    this.createBackground();
    this.createContent();
    this.setupEventListeners();
  }

  // --- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« ---

  async enter(): Promise<void> {
    this.isActive = true;
    this.container.setVisible(true);
    this.container.setAlpha(0);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    await this.animateIn();

    // ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–å‡¦ç†
    await this.onEnter();

    // ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆ
    this.eventBus.emit('phase:action', {
      phase: this.phase,
      action: 'enter',
    });
  }

  async exit(): Promise<void> {
    // ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®çµ‚äº†å‡¦ç†
    await this.onExit();

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    await this.animateOut();

    this.container.setVisible(false);
    this.isActive = false;
  }

  update(delta: number): void {
    if (!this.isActive || !this.enabled) return;
    this.onUpdate(delta);
  }

  // --- è¡¨ç¤ºåˆ¶å¾¡ ---

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  setEnabled(enabled: boolean): void {
    this.enabled = enabled;
    this.container.setAlpha(enabled ? 1 : 0.5);
    this.onEnabledChange(enabled);
  }

  // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---

  abstract canComplete(): boolean;

  complete(): void {
    if (!this.canComplete()) return;

    const result = this.getCompletionResult();
    this.eventBus.emit('phase:complete', {
      phase: this.phase,
      result,
    });
  }

  cancel(): void {
    this.eventBus.emit('phase:cancel', {
      phase: this.phase,
    });
  }

  // --- ç ´æ£„ ---

  destroy(): void {
    this.removeEventListeners();
    this.container.destroy();
  }

  // --- æŠ½è±¡ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ï¼‰ ---

  protected abstract createContent(): void;
  protected abstract onEnter(): Promise<void>;
  protected abstract onExit(): Promise<void>;
  protected abstract onUpdate(delta: number): void;
  protected abstract getCompletionResult(): any;

  // --- ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ ---

  protected onEnabledChange(enabled: boolean): void {}
  protected setupEventListeners(): void {}
  protected removeEventListeners(): void {}

  // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ ---

  private createBackground(): void {
    const bg = this.scene.add.graphics();
    bg.fillStyle(Colors.panelBackground, 0.95);
    bg.fillRoundedRect(0, 0, this.width, this.height, 12);
    bg.lineStyle(2, Colors.panelBorder);
    bg.strokeRoundedRect(0, 0, this.width, this.height, 12);
    this.container.add(bg);
  }

  private async animateIn(): Promise<void> {
    return new Promise((resolve) => {
      this.scene.tweens.add({
        targets: this.container,
        alpha: 1,
        y: this.container.y - 20,
        duration: 300,
        ease: 'Power2.easeOut',
        onComplete: () => resolve(),
      });
    });
  }

  private async animateOut(): Promise<void> {
    return new Promise((resolve) => {
      this.scene.tweens.add({
        targets: this.container,
        alpha: 0,
        y: this.container.y + 20,
        duration: 200,
        ease: 'Power2.easeIn',
        onComplete: () => resolve(),
      });
    });
  }

  // --- EventBusãƒ˜ãƒ«ãƒ‘ãƒ¼ ---

  protected emitAction(action: string, data?: any): void {
    this.eventBus.emit('phase:action', {
      phase: this.phase,
      action,
      data,
    });
  }

  protected emitError(error: Error): void {
    this.eventBus.emit('phase:error', {
      phase: this.phase,
      error,
    });
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« ğŸŸ¡

**Given**: BasePhaseContainerã®å…·è±¡ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹
**When**: enter()ã‚’å‘¼ã¶
**Then**: onEnterãŒå‘¼ã°ã‚Œã€ã‚³ãƒ³ãƒ†ãƒŠãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å®Œäº†å‡¦ç† ğŸŸ¡

**Given**: canCompleteãŒtrueã‚’è¿”ã™
**When**: complete()ã‚’å‘¼ã¶
**Then**: phase:completeã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ğŸŸ¡

**Given**: ãƒ•ã‚§ãƒ¼ã‚ºãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–
**When**: cancel()ã‚’å‘¼ã¶
**Then**: phase:cancelã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0212` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- éåŒæœŸãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®é©åˆ‡ãªç®¡ç†
- EventBusã¨ã®ç–çµåˆ
- ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã®æ‹¡å¼µæ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 3é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
