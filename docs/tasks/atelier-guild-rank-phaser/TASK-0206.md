# TASK-0206: SidebarUIä¾é ¼ãƒªã‚¹ãƒˆå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0206
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ä¾é ¼ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚å—æ³¨ä¸­ã®ä¾é ¼ã‚’ä¸€è¦§è¡¨ç¤ºã—ã€é¸æŠãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0205
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0207

## å®Œäº†æ¡ä»¶

- [ ] å—æ³¨ä¸­ä¾é ¼ãŒãƒªã‚¹ãƒˆè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ä¾é ¼åã€æœŸé™ã€å ±é…¬ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ä¾é ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã§ãã‚‹
- [ ] é¸æŠçŠ¶æ…‹ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹
- [ ] ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒªã‚¹ãƒˆã«ãªã£ã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. QuestListItemå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ä¾é ¼ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ *

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/sidebar/QuestListItem.ts`

```typescript
import Phaser from 'phaser';
import { Quest } from '../../../../domain/quest/Quest';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';
import { SidebarLayout } from './SidebarConstants';

export interface QuestListItemOptions {
  quest: Quest;
  x: number;
  y: number;
  width?: number;
  onClick?: (quest: Quest) => void;
}

export class QuestListItem {
  public readonly container: Phaser.GameObjects.Container;
  public readonly quest: Quest;

  private scene: Phaser.Scene;
  private background!: Phaser.GameObjects.Graphics;
  private nameText!: Phaser.GameObjects.Text;
  private deadlineText!: Phaser.GameObjects.Text;
  private rewardText!: Phaser.GameObjects.Text;
  private statusIndicator!: Phaser.GameObjects.Graphics;

  private width: number;
  private selected: boolean = false;
  private onClick?: (quest: Quest) => void;

  constructor(scene: Phaser.Scene, options: QuestListItemOptions) {
    this.scene = scene;
    this.quest = options.quest;
    this.width = options.width ?? (SidebarLayout.WIDTH - SidebarLayout.PADDING * 2);
    this.onClick = options.onClick;

    this.container = scene.add.container(options.x, options.y);
    this.create();
  }

  private create(): void {
    const height = SidebarLayout.ITEM_HEIGHT;

    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.drawBackground(false);
    this.container.add(this.background);

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆå·¦ç«¯ã®è‰²ä»˜ããƒãƒ¼ï¼‰
    this.statusIndicator = this.scene.add.graphics();
    this.updateStatusIndicator();
    this.container.add(this.statusIndicator);

    // ä¾é ¼å
    this.nameText = this.scene.add.text(15, 8, this.quest.name, {
      ...TextStyles.body,
      fontSize: '13px',
    });
    this.container.add(this.nameText);

    // æœŸé™
    const deadlineStr = this.getDeadlineString();
    this.deadlineText = this.scene.add.text(15, 28, deadlineStr, {
      ...TextStyles.bodySmall,
      fontSize: '11px',
      color: this.getDeadlineColor(),
    });
    this.container.add(this.deadlineText);

    // å ±é…¬
    const rewardStr = this.getRewardString();
    this.rewardText = this.scene.add.text(this.width - 10, height / 2, rewardStr, {
      ...TextStyles.bodySmall,
      fontSize: '11px',
      color: '#ffd700',
    }).setOrigin(1, 0.5);
    this.container.add(this.rewardText);

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
    this.container.setInteractive(
      new Phaser.Geom.Rectangle(0, 0, this.width, height),
      Phaser.Geom.Rectangle.Contains
    );

    this.container.on('pointerover', () => {
      if (!this.selected) {
        this.drawBackground(true);
      }
    });

    this.container.on('pointerout', () => {
      if (!this.selected) {
        this.drawBackground(false);
      }
    });

    this.container.on('pointerdown', () => {
      if (this.onClick) {
        this.onClick(this.quest);
      }
    });
  }

  private drawBackground(hover: boolean): void {
    const height = SidebarLayout.ITEM_HEIGHT;
    const bgColor = this.selected
      ? Colors.accent
      : hover
        ? 0x3a3a5a
        : 0x2a2a4a;
    const alpha = this.selected ? 0.3 : 0.8;

    this.background.clear();
    this.background.fillStyle(bgColor, alpha);
    this.background.fillRoundedRect(0, 0, this.width, height, 6);

    if (this.selected) {
      this.background.lineStyle(2, Colors.accent);
      this.background.strokeRoundedRect(0, 0, this.width, height, 6);
    }
  }

  private updateStatusIndicator(): void {
    const height = SidebarLayout.ITEM_HEIGHT;
    const statusColor = this.getStatusColor();

    this.statusIndicator.clear();
    this.statusIndicator.fillStyle(statusColor, 1);
    this.statusIndicator.fillRoundedRect(0, 0, 4, height, { tl: 6, bl: 6, tr: 0, br: 0 });
  }

  private getStatusColor(): number {
    // ä¾é ¼ã®çŠ¶æ…‹ã«å¿œã˜ãŸè‰²
    if (this.quest.isComplete) {
      return 0x00ff00; // å®Œäº†å¯èƒ½: ç·‘
    }
    if (this.isUrgent()) {
      return 0xff4444; // ç·Šæ€¥: èµ¤
    }
    return 0x0088ff; // é€šå¸¸: é’
  }

  private isUrgent(): boolean {
    // æ®‹ã‚ŠæœŸé™ãŒ3æ—¥ä»¥å†…
    return this.quest.remainingDays <= 3;
  }

  private getDeadlineString(): string {
    const remaining = this.quest.remainingDays;
    if (remaining <= 0) {
      return 'æœŸé™åˆ‡ã‚Œ';
    }
    return `æ®‹ã‚Š ${remaining} æ—¥`;
  }

  private getDeadlineColor(): string {
    const remaining = this.quest.remainingDays;
    if (remaining <= 0) return '#ff0000';
    if (remaining <= 3) return '#ff4444';
    if (remaining <= 7) return '#ffaa00';
    return '#aaaaaa';
  }

  private getRewardString(): string {
    const gold = this.quest.reward.gold ?? 0;
    const exp = this.quest.reward.exp ?? 0;
    const parts: string[] = [];
    if (gold > 0) parts.push(`${gold}G`);
    if (exp > 0) parts.push(`${exp}EXP`);
    return parts.join(' / ');
  }

  setSelected(selected: boolean): void {
    this.selected = selected;
    this.drawBackground(false);
  }

  update(quest: Quest): void {
    // ä¾é ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã®è¡¨ç¤ºæ›´æ–°
    this.nameText.setText(quest.name);
    this.deadlineText.setText(this.getDeadlineString());
    this.deadlineText.setColor(this.getDeadlineColor());
    this.updateStatusIndicator();
  }

  destroy(): void {
    this.container.destroy();
  }
}
```

### 2. SidebarUIã®ä¾é ¼ãƒªã‚¹ãƒˆå®Ÿè£… ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *TASK-0205ã®æ‹¡å¼µ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/sidebar/SidebarUI.ts` (è¿½åŠ )

```typescript
// SidebarUIã‚¯ãƒ©ã‚¹ã«è¿½åŠ 

private questItems: QuestListItem[] = [];
private selectedQuestId: string | null = null;

setQuests(quests: Quest[]): void {
  this.quests = quests;

  // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
  this.questItems.forEach(item => item.destroy());
  this.questItems = [];

  // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆ
  quests.forEach((quest, index) => {
    const item = new QuestListItem(this.scene, {
      quest,
      x: 0,
      y: index * (SidebarLayout.ITEM_HEIGHT + SidebarLayout.ITEM_SPACING),
      width: SidebarLayout.WIDTH - SidebarLayout.PADDING * 2,
      onClick: (q) => this.handleQuestClick(q),
    });
    this.questsContainer.add(item.container);
    this.questItems.push(item);
  });

  // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
  if (this.selectedQuestId) {
    this.highlightQuest(this.selectedQuestId);
  }
}

private handleQuestClick(quest: Quest): void {
  // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  this.selectedQuestId = quest.id;
  this.questItems.forEach(item => {
    item.setSelected(item.quest.id === quest.id);
  });

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (this.onQuestSelect) {
    this.onQuestSelect(quest);
  }
}

highlightQuest(questId: string): void {
  this.selectedQuestId = questId;
  this.questItems.forEach(item => {
    item.setSelected(item.quest.id === questId);
  });

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸä¾é ¼ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const index = this.quests.findIndex(q => q.id === questId);
  if (index >= 0) {
    this.scrollToItem(index);
  }
}

clearQuestHighlight(): void {
  this.selectedQuestId = null;
  this.questItems.forEach(item => {
    item.setSelected(false);
  });
}
```

### 3. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè£…ï¼ˆrexUIä½¿ç”¨ï¼‰ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *rexUIã®ScrollablePanel*

```typescript
// SidebarUIã«è¿½åŠ ï¼ˆrexUIãŒå¿…è¦ï¼‰

private createQuestsScrollablePanel(): void {
  const scene = this.scene as any; // rexUIæ‹¡å¼µã‚’ä½¿ç”¨

  if (!scene.rexUI) {
    console.warn('rexUI not available, using basic container');
    return;
  }

  // ScrollablePanelã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè£…
  this.scrollablePanel = scene.rexUI.add.scrollablePanel({
    x: SidebarLayout.PADDING,
    y: SidebarLayout.CONTENT_Y,
    width: SidebarLayout.WIDTH - SidebarLayout.PADDING * 2,
    height: SidebarLayout.CONTENT_HEIGHT,

    scrollMode: 0, // å‚ç›´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

    panel: {
      child: this.questsContainer,
      mask: {
        padding: 1,
      },
    },

    slider: {
      track: scene.rexUI.add.roundRectangle(0, 0, 8, 10, 4, 0x3a3a5a),
      thumb: scene.rexUI.add.roundRectangle(0, 0, 8, 40, 4, 0x6a6a8a),
    },

    space: {
      left: 0,
      right: 0,
      top: 0,
      bottom: 0,
      panel: 10,
    },
  }).layout();

  this.container.add(this.scrollablePanel);
}

scrollToTop(): void {
  if (this.scrollablePanel) {
    this.scrollablePanel.scrollToTop();
  }
}

scrollToItem(index: number): void {
  if (this.scrollablePanel) {
    const itemY = index * (SidebarLayout.ITEM_HEIGHT + SidebarLayout.ITEM_SPACING);
    this.scrollablePanel.setChildOY(-itemY);
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ä¾é ¼ãƒªã‚¹ãƒˆè¡¨ç¤º ğŸŸ¡

**Given**: å—æ³¨ä¸­ä¾é ¼ãŒ3ä»¶ã‚ã‚‹
**When**: setQuestsã‚’å‘¼ã¶
**Then**: 3ä»¶ã®ä¾é ¼ã‚¢ã‚¤ãƒ†ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ä¾é ¼é¸æŠ ğŸŸ¡

**Given**: ä¾é ¼ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: ä¾é ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
**Then**: ã‚¯ãƒªãƒƒã‚¯ã—ãŸä¾é ¼ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç·Šæ€¥ä¾é ¼ã®è¡¨ç¤º ğŸŸ¡

**Given**: æ®‹ã‚Š3æ—¥ã®ä¾é ¼ãŒã‚ã‚‹
**When**: ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã™ã‚‹
**Then**: èµ¤ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0206` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ä¾é ¼ãŒå¤šã„å ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- æœŸé™åˆ‡ã‚Œä¾é ¼ã®è¡¨ç¤ºæ–¹æ³•
- å®Œäº†å¯èƒ½ä¾é ¼ã®ç›®ç«‹ãŸã›æ–¹

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 3é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
