# TASK-0250: EventBus-UseCaseé€£æºè¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0250
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

EventBusã¨Applicationå±¤UseCaseé–“ã®é€£æºã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¨­è¨ˆã™ã‚‹ã€‚Phaser UIã¨ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ©‹æ¸¡ã—ã‚’å®šç¾©ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0165
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0251

## å®Œäº†æ¡ä»¶

- [ ] EventBus-UseCaseé€£æºã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾©ãŒå®Œæˆã—ã¦ã„ã‚‹
- [ ] UseCaseå‘¼ã³å‡ºã—ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ–¹é‡ãŒæ±ºå®šã—ã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾© ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/GameEvents.ts`

```typescript
/**
 * ã‚²ãƒ¼ãƒ å…¨ä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾©
 * UIå±¤ â†” Applicationå±¤ã®ã‚¤ãƒ™ãƒ³ãƒˆé€šä¿¡ã‚’å‹å®‰å…¨ã«è¡Œã†
 */

// ===== UI â†’ Application ã‚¤ãƒ™ãƒ³ãƒˆ =====

export interface QuestAcceptRequestEvent {
  type: 'quest:accept:request';
  payload: {
    questId: string;
  };
}

export interface QuestDeliveryRequestEvent {
  type: 'quest:delivery:request';
  payload: {
    questId: string;
    itemIds: string[];
  };
}

export interface GatheringExecuteRequestEvent {
  type: 'gathering:execute:request';
  payload: {
    cardId: string;
    selectedMaterialIds: string[];
  };
}

export interface AlchemyCraftRequestEvent {
  type: 'alchemy:craft:request';
  payload: {
    recipeCardId: string;
    materialIds: string[];
  };
}

export interface ShopPurchaseRequestEvent {
  type: 'shop:purchase:request';
  payload: {
    category: 'card' | 'material' | 'artifact';
    itemId: string;
    quantity?: number;
  };
}

export interface CardDrawRequestEvent {
  type: 'card:draw:request';
  payload: {
    count: number;
  };
}

export interface DeckShuffleRequestEvent {
  type: 'deck:shuffle:request';
  payload: {};
}

export interface PhaseSkipRequestEvent {
  type: 'phase:skip:request';
  payload: {
    phase: string;
  };
}

export interface DayEndRequestEvent {
  type: 'day:end:request';
  payload: {};
}

export interface GameSaveRequestEvent {
  type: 'game:save:request';
  payload: {
    slotId: number;
  };
}

export interface GameLoadRequestEvent {
  type: 'game:load:request';
  payload: {
    slotId: number;
  };
}

export interface RankUpChallengeRequestEvent {
  type: 'rankup:challenge:request';
  payload: {
    targetRank: string;
  };
}

// UI â†’ Application ã‚¤ãƒ™ãƒ³ãƒˆ Union
export type UIToAppEvent =
  | QuestAcceptRequestEvent
  | QuestDeliveryRequestEvent
  | GatheringExecuteRequestEvent
  | AlchemyCraftRequestEvent
  | ShopPurchaseRequestEvent
  | CardDrawRequestEvent
  | DeckShuffleRequestEvent
  | PhaseSkipRequestEvent
  | DayEndRequestEvent
  | GameSaveRequestEvent
  | GameLoadRequestEvent
  | RankUpChallengeRequestEvent;

// ===== Application â†’ UI ã‚¤ãƒ™ãƒ³ãƒˆ =====

export interface GameStateUpdatedEvent {
  type: 'game:state:updated';
  payload: {
    currentPhase: string;
    currentDay: number;
    playerRank: string;
    gold: number;
    ap: { current: number; max: number };
  };
}

export interface QuestAcceptedEvent {
  type: 'quest:accepted';
  payload: {
    quest: any; // Questå‹
    acceptedQuests: any[];
  };
}

export interface QuestDeliveredEvent {
  type: 'quest:delivered';
  payload: {
    quest: any;
    rewards: {
      gold: number;
      exp: number;
      items: any[];
    };
    rewardCards: any[];
  };
}

export interface GatheringCompleteEvent {
  type: 'gathering:complete';
  payload: {
    materials: any[];
    apUsed: number;
    remainingAp: number;
  };
}

export interface AlchemyCraftedEvent {
  type: 'alchemy:crafted';
  payload: {
    item: any;
    quality: number;
    traits: string[];
    success: boolean;
  };
}

export interface ShopPurchasedEvent {
  type: 'shop:purchased';
  payload: {
    item: any;
    quantity: number;
    newGold: number;
  };
}

export interface HandUpdatedEvent {
  type: 'hand:updated';
  payload: {
    cards: any[];
  };
}

export interface DeckUpdatedEvent {
  type: 'deck:updated';
  payload: {
    deckCount: number;
    discardCount: number;
  };
}

export interface InventoryUpdatedEvent {
  type: 'inventory:updated';
  payload: {
    items: any[];
  };
}

export interface PhaseChangedEvent {
  type: 'phase:changed';
  payload: {
    previousPhase: string | null;
    currentPhase: string;
    phaseData: any;
  };
}

export interface DayEndedEvent {
  type: 'day:ended';
  payload: {
    newDay: number;
    summary: {
      questsCompleted: number;
      itemsCrafted: number;
      goldEarned: number;
    };
  };
}

export interface RankUpSuccessEvent {
  type: 'rankup:success';
  payload: {
    newRank: string;
    rewards: any[];
  };
}

export interface RankUpFailedEvent {
  type: 'rankup:failed';
  payload: {
    reason: string;
  };
}

export interface GameOverEvent {
  type: 'game:over';
  payload: {
    reason: string;
    stats: any;
  };
}

export interface GameClearEvent {
  type: 'game:clear';
  payload: {
    stats: any;
  };
}

export interface ErrorOccurredEvent {
  type: 'error:occurred';
  payload: {
    code: string;
    message: string;
    recoverable: boolean;
  };
}

// Application â†’ UI ã‚¤ãƒ™ãƒ³ãƒˆ Union
export type AppToUIEvent =
  | GameStateUpdatedEvent
  | QuestAcceptedEvent
  | QuestDeliveredEvent
  | GatheringCompleteEvent
  | AlchemyCraftedEvent
  | ShopPurchasedEvent
  | HandUpdatedEvent
  | DeckUpdatedEvent
  | InventoryUpdatedEvent
  | PhaseChangedEvent
  | DayEndedEvent
  | RankUpSuccessEvent
  | RankUpFailedEvent
  | GameOverEvent
  | GameClearEvent
  | ErrorOccurredEvent;

// å…¨ã‚¤ãƒ™ãƒ³ãƒˆ
export type GameEvent = UIToAppEvent | AppToUIEvent;
```

### 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒãƒ³ãƒ‰ãƒ©è¨­è¨ˆ*

```typescript
// src/presentation/phaser/events/EventHandlers.ts

import { AppToUIEvent, UIToAppEvent } from './GameEvents';

/**
 * UIã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
export interface IUIEventHandler {
  handleQuestAcceptRequest(payload: { questId: string }): Promise<void>;
  handleQuestDeliveryRequest(payload: { questId: string; itemIds: string[] }): Promise<void>;
  handleGatheringExecuteRequest(payload: { cardId: string; selectedMaterialIds: string[] }): Promise<void>;
  handleAlchemyCraftRequest(payload: { recipeCardId: string; materialIds: string[] }): Promise<void>;
  handleShopPurchaseRequest(payload: { category: string; itemId: string; quantity?: number }): Promise<void>;
  handleCardDrawRequest(payload: { count: number }): Promise<void>;
  handleDeckShuffleRequest(): Promise<void>;
  handlePhaseSkipRequest(payload: { phase: string }): Promise<void>;
  handleDayEndRequest(): Promise<void>;
  handleGameSaveRequest(payload: { slotId: number }): Promise<void>;
  handleGameLoadRequest(payload: { slotId: number }): Promise<void>;
  handleRankUpChallengeRequest(payload: { targetRank: string }): Promise<void>;
}

/**
 * Applicationã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
export interface IAppEventListener {
  onGameStateUpdated(payload: AppToUIEvent['payload']): void;
  onQuestAccepted(payload: AppToUIEvent['payload']): void;
  onQuestDelivered(payload: AppToUIEvent['payload']): void;
  onGatheringComplete(payload: AppToUIEvent['payload']): void;
  onAlchemyCrafted(payload: AppToUIEvent['payload']): void;
  onShopPurchased(payload: AppToUIEvent['payload']): void;
  onHandUpdated(payload: AppToUIEvent['payload']): void;
  onDeckUpdated(payload: AppToUIEvent['payload']): void;
  onInventoryUpdated(payload: AppToUIEvent['payload']): void;
  onPhaseChanged(payload: AppToUIEvent['payload']): void;
  onDayEnded(payload: AppToUIEvent['payload']): void;
  onRankUpSuccess(payload: AppToUIEvent['payload']): void;
  onRankUpFailed(payload: AppToUIEvent['payload']): void;
  onGameOver(payload: AppToUIEvent['payload']): void;
  onGameClear(payload: AppToUIEvent['payload']): void;
  onErrorOccurred(payload: AppToUIEvent['payload']): void;
}
```

### 3. EventBusã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼è¨­è¨ˆ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼*

```typescript
// src/presentation/phaser/events/EventBusAdapter.ts

import { EventBus } from '../core/EventBus';
import { UIToAppEvent, AppToUIEvent, GameEvent } from './GameEvents';
import { IUIEventHandler, IAppEventListener } from './EventHandlers';

/**
 * EventBusã¨UseCase/UIã‚’æ©‹æ¸¡ã—ã™ã‚‹ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼
 */
export class EventBusAdapter {
  private eventBus: EventBus;
  private uiEventHandler: IUIEventHandler | null = null;
  private appEventListeners: Set<IAppEventListener> = new Set();

  constructor(eventBus: EventBus) {
    this.eventBus = eventBus;
    this.setupUIEventListeners();
  }

  /**
   * UIã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šï¼ˆApplicationå±¤ã‹ã‚‰ï¼‰
   */
  setUIEventHandler(handler: IUIEventHandler): void {
    this.uiEventHandler = handler;
  }

  /**
   * Appã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆUIå±¤ã‹ã‚‰ï¼‰
   */
  addAppEventListener(listener: IAppEventListener): void {
    this.appEventListeners.add(listener);
  }

  /**
   * Appã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
   */
  removeAppEventListener(listener: IAppEventListener): void {
    this.appEventListeners.delete(listener);
  }

  /**
   * UI â†’ Application ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
   */
  private setupUIEventListeners(): void {
    this.eventBus.on('quest:accept:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleQuestAcceptRequest(payload);
      }
    });

    this.eventBus.on('quest:delivery:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleQuestDeliveryRequest(payload);
      }
    });

    this.eventBus.on('gathering:execute:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleGatheringExecuteRequest(payload);
      }
    });

    this.eventBus.on('alchemy:craft:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleAlchemyCraftRequest(payload);
      }
    });

    this.eventBus.on('shop:purchase:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleShopPurchaseRequest(payload);
      }
    });

    this.eventBus.on('card:draw:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleCardDrawRequest(payload);
      }
    });

    this.eventBus.on('deck:shuffle:request', async () => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleDeckShuffleRequest();
      }
    });

    this.eventBus.on('phase:skip:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handlePhaseSkipRequest(payload);
      }
    });

    this.eventBus.on('day:end:request', async () => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleDayEndRequest();
      }
    });

    this.eventBus.on('game:save:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleGameSaveRequest(payload);
      }
    });

    this.eventBus.on('game:load:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleGameLoadRequest(payload);
      }
    });

    this.eventBus.on('rankup:challenge:request', async (payload) => {
      if (this.uiEventHandler) {
        await this.uiEventHandler.handleRankUpChallengeRequest(payload);
      }
    });
  }

  /**
   * Application â†’ UI ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
   */
  emitToUI(event: AppToUIEvent): void {
    // EventBusã«ç™ºç«
    this.eventBus.emit(event.type, event.payload);

    // ç™»éŒ²ã•ã‚ŒãŸãƒªã‚¹ãƒŠãƒ¼ã«é€šçŸ¥
    this.appEventListeners.forEach(listener => {
      this.dispatchToListener(listener, event);
    });
  }

  private dispatchToListener(listener: IAppEventListener, event: AppToUIEvent): void {
    switch (event.type) {
      case 'game:state:updated':
        listener.onGameStateUpdated(event.payload);
        break;
      case 'quest:accepted':
        listener.onQuestAccepted(event.payload);
        break;
      case 'quest:delivered':
        listener.onQuestDelivered(event.payload);
        break;
      case 'gathering:complete':
        listener.onGatheringComplete(event.payload);
        break;
      case 'alchemy:crafted':
        listener.onAlchemyCrafted(event.payload);
        break;
      case 'shop:purchased':
        listener.onShopPurchased(event.payload);
        break;
      case 'hand:updated':
        listener.onHandUpdated(event.payload);
        break;
      case 'deck:updated':
        listener.onDeckUpdated(event.payload);
        break;
      case 'inventory:updated':
        listener.onInventoryUpdated(event.payload);
        break;
      case 'phase:changed':
        listener.onPhaseChanged(event.payload);
        break;
      case 'day:ended':
        listener.onDayEnded(event.payload);
        break;
      case 'rankup:success':
        listener.onRankUpSuccess(event.payload);
        break;
      case 'rankup:failed':
        listener.onRankUpFailed(event.payload);
        break;
      case 'game:over':
        listener.onGameOver(event.payload);
        break;
      case 'game:clear':
        listener.onGameClear(event.payload);
        break;
      case 'error:occurred':
        listener.onErrorOccurred(event.payload);
        break;
    }
  }

  /**
   * ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   */
  destroy(): void {
    this.uiEventHandler = null;
    this.appEventListeners.clear();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ™ãƒ³ãƒˆå‹å®‰å…¨æ€§ ğŸŸ¡

**Given**: UIToAppEventã‚’ä½œæˆ
**When**: å‹ã‚’ç¢ºèª
**Then**: æ­£ã—ã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å‹ãŒå¼·åˆ¶ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒãƒ³ãƒ‰ãƒ©å‘¼ã³å‡ºã— ğŸŸ¡

**Given**: EventBusAdapterã«ãƒãƒ³ãƒ‰ãƒ©ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
**When**: UIã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
**Then**: å¯¾å¿œã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒªã‚¹ãƒŠãƒ¼é€šçŸ¥ ğŸŸ¡

**Given**: AppEventListenerãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
**When**: emitToUIã‚’å‘¼ã¶
**Then**: ãƒªã‚¹ãƒŠãƒ¼ã®å¯¾å¿œãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0250` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å‹å®‰å…¨æ€§ã®ç¢ºä¿
- éåŒæœŸå‡¦ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- å¾ªç’°å‚ç…§ã®å›é¿

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 3é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ï¼‰
