# TASK-0167: BaseGameSceneåŸºåº•ã‚¯ãƒ©ã‚¹è¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0167
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”´ *Phaserå›ºæœ‰ã®èª¿æŸ»ãŒå¿…è¦*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **è¨­è¨ˆæ–‡æ›¸**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ã‚·ãƒ¼ãƒ³ã®åŸºåº•ã‚¯ãƒ©ã‚¹ã¨ãªã‚‹BaseGameSceneã‚’è¨­è¨ˆã™ã‚‹ã€‚å…±é€šæ©Ÿèƒ½ï¼ˆEventBusé€£æºã€UIFactoryå‚ç…§ã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ï¼‰ã‚’æä¾›ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0165
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0168

## å®Œäº†æ¡ä»¶

- [ ] BaseGameSceneã®è¨­è¨ˆãŒå®Œäº†ã—ã¦ã„ã‚‹
- [ ] EventBusçµ±åˆã®ä»•çµ„ã¿ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] UIFactoryå‚ç…§ã®ä»•çµ„ã¿ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚·ãƒ¼ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ•ãƒƒã‚¯ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. BaseGameSceneè¨­è¨ˆ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaser.Sceneã®æ‹¡å¼µæ–¹æ³•è¦èª¿æŸ»*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/BaseGameScene.ts`

```typescript
import Phaser from 'phaser';
import RexUIPlugin from 'phaser3-rex-plugins/templates/ui/ui-plugin';
import { EventBus } from '../events/EventBus';
import { UIFactory } from '../ui/UIFactory';
import { SceneKey } from '../config/SceneKeys';

export interface SceneInitData {
  [key: string]: unknown;
}

export abstract class BaseGameScene extends Phaser.Scene {
  // rexUIãƒ—ãƒ©ã‚°ã‚¤ãƒ³å‚ç…§
  protected rexUI!: RexUIPlugin;

  // EventBuså‚ç…§
  protected eventBus: EventBus;

  // UIFactoryå‚ç…§ï¼ˆé…å»¶åˆæœŸåŒ–ï¼‰
  protected uiFactory!: UIFactory;

  // è³¼èª­è§£é™¤é–¢æ•°ãƒªã‚¹ãƒˆ
  private unsubscribers: (() => void)[] = [];

  constructor(key: SceneKey) {
    super({ key });
    this.eventBus = EventBus.getInstance();
  }

  // Phaserãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«: åˆæœŸåŒ–
  init(data?: SceneInitData): void {
    this.onInit(data);
  }

  // Phaserãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«: ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
  preload(): void {
    this.onPreload();
  }

  // Phaserãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«: ä½œæˆ
  create(data?: SceneInitData): void {
    // rexUIãƒ—ãƒ©ã‚°ã‚¤ãƒ³å–å¾—
    this.rexUI = this.plugins.get('rexUI') as RexUIPlugin;

    // UIFactoryåˆæœŸåŒ–
    this.uiFactory = new UIFactory(this, this.rexUI);

    // ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    this.setupEventListeners();

    // ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã®createå‡¦ç†
    this.onCreate(data);
  }

  // Phaserãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«: æ›´æ–°
  update(time: number, delta: number): void {
    this.onUpdate(time, delta);
  }

  // ã‚·ãƒ¼ãƒ³çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  shutdown(): void {
    this.cleanup();
    this.onShutdown();
  }

  // --- æŠ½è±¡ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ï¼‰ ---

  protected abstract onInit(data?: SceneInitData): void;
  protected abstract onPreload(): void;
  protected abstract onCreate(data?: SceneInitData): void;
  protected abstract setupEventListeners(): void;

  // --- ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ•ãƒƒã‚¯ ---

  protected onUpdate(_time: number, _delta: number): void {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚ã—ãªã„
  }

  protected onShutdown(): void {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä½•ã‚‚ã—ãªã„
  }

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰ ---

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã‚’ç™»éŒ²ã—ã€è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã«è¿½åŠ 
   */
  protected subscribe(unsubscriber: () => void): void {
    this.unsubscribers.push(unsubscriber);
  }

  /**
   * ã™ã¹ã¦ã®è³¼èª­ã‚’è§£é™¤
   */
  protected cleanup(): void {
    this.unsubscribers.forEach(unsub => unsub());
    this.unsubscribers = [];
  }

  /**
   * ã‚·ãƒ¼ãƒ³é·ç§»
   */
  protected goToScene(key: SceneKey, data?: SceneInitData): void {
    this.scene.start(key, data);
  }

  /**
   * ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚·ãƒ¼ãƒ³ã‚’é–‹ã
   */
  protected openOverlay(key: SceneKey, data?: SceneInitData): void {
    this.scene.launch(key, data);
    this.scene.pause();
  }

  /**
   * ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚·ãƒ¼ãƒ³ã‚’é–‰ã˜ã‚‹
   */
  protected closeOverlay(key: SceneKey): void {
    this.scene.stop(key);
    this.scene.resume();
  }
}
```

### 2. ã‚·ãƒ¼ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å›³ ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaserã®æ­£ç¢ºãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è¦ç¢ºèª*

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Scene Lifecycle                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  constructor() â†’ ã‚·ãƒ¼ãƒ³ã‚­ãƒ¼è¨­å®šã€EventBuså–å¾—            â”‚
â”‚       â†“                                                  â”‚
â”‚  init(data) â†’ onInit() ã‚µãƒ–ã‚¯ãƒ©ã‚¹åˆæœŸåŒ–                  â”‚
â”‚       â†“                                                  â”‚
â”‚  preload() â†’ onPreload() ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿                â”‚
â”‚       â†“                                                  â”‚
â”‚  create(data) â†’ rexUIå–å¾— â†’ UIFactoryä½œæˆ               â”‚
â”‚              â†’ setupEventListeners() ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­        â”‚
â”‚              â†’ onCreate() ã‚µãƒ–ã‚¯ãƒ©ã‚¹UIæ§‹ç¯‰               â”‚
â”‚       â†“                                                  â”‚
â”‚  update(time, delta) â†’ onUpdate() æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†        â”‚
â”‚       â†“                                                  â”‚
â”‚  shutdown() â†’ cleanup() è³¼èª­è§£é™¤                         â”‚
â”‚            â†’ onShutdown() ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚·ãƒ¼ãƒ³åˆæœŸåŒ– ğŸ”´

**Given**: BaseGameSceneã‚’ç¶™æ‰¿ã—ãŸã‚·ãƒ¼ãƒ³ãŒã‚ã‚‹
**When**: ã‚·ãƒ¼ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹
**Then**: EventBusãŒå–å¾—ã§ãã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ğŸ”´

**Given**: ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¦ã„ã‚‹
**When**: shutdown()ãŒå‘¼ã°ã‚Œã‚‹
**Then**: ã™ã¹ã¦ã®è³¼èª­ãŒè§£é™¤ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0167` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- Phaserã®æ­£ç¢ºãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç¢ºèª
- rexUIãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å–å¾—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«æ³¨æ„
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å¾¹åº•

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 2é …ç›® (100%)

**å“è³ªè©•ä¾¡**: è¦èª¿æŸ»
