# TASK-0218: QuestAcceptContainerå—æ³¨æ“ä½œå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0218
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

QuestAcceptContainerã®ä¾é ¼å—æ³¨æ“ä½œã‚’å®Ÿè£…ã™ã‚‹ã€‚å—æ³¨ç¢ºèªã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€è¤‡æ•°å—æ³¨ã®åˆ¶é™ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0217
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0219

## å®Œäº†æ¡ä»¶

- [x] ä¾é ¼å—æ³¨æ™‚ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [x] å—æ³¨ä¸Šé™ã®åˆ¶é™ãŒå‹•ä½œã™ã‚‹
- [x] å—æ³¨æˆåŠŸæ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç”Ÿã•ã‚Œã‚‹
- [x] EventBusã«å—æ³¨ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. å—æ³¨ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ç¢ºèªæ“ä½œ*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private showAcceptConfirmDialog(quest: Quest): void {
  const dialogContainer = this.scene.add.container(0, 0);
  dialogContainer.setDepth(300);

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const overlay = this.scene.add.graphics();
  overlay.fillStyle(0x000000, 0.7);
  overlay.fillRect(0, 0, this.width, this.height);
  dialogContainer.add(overlay);

  // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ‘ãƒãƒ«
  const panelWidth = 350;
  const panelHeight = 200;
  const panelX = (this.width - panelWidth) / 2;
  const panelY = (this.height - panelHeight) / 2;

  const panel = this.scene.add.graphics();
  panel.fillStyle(Colors.panelBackground, 1);
  panel.fillRoundedRect(panelX, panelY, panelWidth, panelHeight, 12);
  panel.lineStyle(2, Colors.panelBorder);
  panel.strokeRoundedRect(panelX, panelY, panelWidth, panelHeight, 12);
  dialogContainer.add(panel);

  // ã‚¿ã‚¤ãƒˆãƒ«
  const title = this.scene.add.text(
    this.width / 2,
    panelY + 20,
    'ä¾é ¼ã‚’å—æ³¨ã—ã¾ã™ã‹ï¼Ÿ',
    { ...TextStyles.heading, fontSize: '18px' }
  ).setOrigin(0.5, 0);
  dialogContainer.add(title);

  // ä¾é ¼å
  const questName = this.scene.add.text(
    this.width / 2,
    panelY + 55,
    quest.name,
    { ...TextStyles.body, fontSize: '14px', color: Colors.accent.toString(16) }
  ).setOrigin(0.5, 0);
  dialogContainer.add(questName);

  // å ±é…¬ã‚µãƒãƒªãƒ¼
  const rewardText = this.scene.add.text(
    this.width / 2,
    panelY + 85,
    `å ±é…¬: ${quest.reward.gold}G / ${quest.reward.exp}EXP`,
    { ...TextStyles.body, fontSize: '13px' }
  ).setOrigin(0.5, 0);
  dialogContainer.add(rewardText);

  // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
  const btnY = panelY + panelHeight - 50;

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  const cancelBtn = this.createButton(
    this.width / 2 - 70,
    btnY,
    'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    () => dialogContainer.destroy(),
    false
  );
  dialogContainer.add(cancelBtn);

  // å—æ³¨ãƒœã‚¿ãƒ³
  const acceptBtn = this.createButton(
    this.width / 2 + 70,
    btnY,
    'å—æ³¨ã™ã‚‹',
    () => {
      dialogContainer.destroy();
      this.executeQuestAccept(quest);
    },
    true
  );
  dialogContainer.add(acceptBtn);

  this.container.add(dialogContainer);
}
```

### 2. å—æ³¨ä¸Šé™ãƒã‚§ãƒƒã‚¯ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private maxAcceptedQuests: number = 5;
private currentAcceptedCount: number = 0;

setAcceptedQuestCount(count: number, max?: number): void {
  this.currentAcceptedCount = count;
  if (max !== undefined) {
    this.maxAcceptedQuests = max;
  }
  this.updateAcceptButtonState();
}

private canAcceptMoreQuests(): boolean {
  return this.currentAcceptedCount < this.maxAcceptedQuests;
}

private updateAcceptButtonState(): void {
  if (!this.canAcceptMoreQuests()) {
    // QuestPanelã®å—æ³¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    this.questPanel.setAcceptEnabled(false);

    // ä¸Šé™åˆ°é”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    this.showMaxQuestsWarning();
  } else {
    this.questPanel.setAcceptEnabled(true);
    this.hideMaxQuestsWarning();
  }
}

private maxQuestsWarning?: Phaser.GameObjects.Text;

private showMaxQuestsWarning(): void {
  if (this.maxQuestsWarning) return;

  this.maxQuestsWarning = this.scene.add.text(
    400,
    460,
    `å—æ³¨ä¸Šé™ï¼ˆ${this.maxAcceptedQuests}ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™`,
    { ...TextStyles.body, fontSize: '12px', color: '#ff4444' }
  );
  this.container.add(this.maxQuestsWarning);
}

private hideMaxQuestsWarning(): void {
  if (this.maxQuestsWarning) {
    this.maxQuestsWarning.destroy();
    this.maxQuestsWarning = undefined;
  }
}
```

### 3. å—æ³¨æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private async executeQuestAccept(quest: Quest): Promise<void> {
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  this.showLoading('ä¾é ¼ã‚’å—æ³¨ä¸­...');

  try {
    // EventBusã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
    this.eventBus.emit('quest:accept', { quest });

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    await this.playAcceptAnimation(quest);

    // æˆåŠŸé€šçŸ¥
    this.showAcceptSuccessMessage(quest);

    // çŠ¶æ…‹æ›´æ–°
    this.acceptedQuestIds.add(quest.id);
    this.currentAcceptedCount++;
    this.updateQuestList();
    this.questPanel.setQuest(null);

    // å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (this.onQuestAccepted) {
      this.onQuestAccepted(quest);
    }

  } catch (error) {
    this.showError('ä¾é ¼ã®å—æ³¨ã«å¤±æ•—ã—ã¾ã—ãŸ', () => {});
  } finally {
    this.hideLoading();
  }
}

private async playAcceptAnimation(quest: Quest): Promise<void> {
  return new Promise((resolve) => {
    // ä¾é ¼ãƒ‘ãƒãƒ«ã‹ã‚‰ä¾é ¼ãƒªã‚¹ãƒˆã¸é£›ã‚“ã§ã„ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const flyingCard = this.scene.add.container(
      this.questPanel.container.x + 190,
      this.questPanel.container.y + 175
    );

    const cardBg = this.scene.add.graphics();
    cardBg.fillStyle(Colors.accent, 1);
    cardBg.fillRoundedRect(-50, -30, 100, 60, 8);
    flyingCard.add(cardBg);

    const cardText = this.scene.add.text(0, 0, 'ğŸ“‹', { fontSize: '24px' }).setOrigin(0.5);
    flyingCard.add(cardText);

    this.container.add(flyingCard);

    // ç”»é¢å¤–ã¸é£›ã‚“ã§ã„ã
    this.scene.tweens.add({
      targets: flyingCard,
      x: -100,
      y: 300,
      scale: 0.5,
      alpha: 0,
      duration: 500,
      ease: 'Power2.easeIn',
      onComplete: () => {
        flyingCard.destroy();
        resolve();
      },
    });
  });
}

private showAcceptSuccessMessage(quest: Quest): void {
  const message = this.scene.add.text(
    this.width / 2,
    this.height / 2,
    `ã€Œ${quest.name}ã€ã‚’å—æ³¨ã—ã¾ã—ãŸï¼`,
    {
      ...TextStyles.heading,
      fontSize: '20px',
      color: '#00ff00',
    }
  ).setOrigin(0.5);

  this.container.add(message);

  this.scene.tweens.add({
    targets: message,
    y: message.y - 50,
    alpha: 0,
    duration: 1500,
    ease: 'Power2',
    onComplete: () => message.destroy(),
  });
}
```

### 4. EventBusé€£æº ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«*

```typescript
// QuestAcceptContainerã®setupEventListenersã«è¿½åŠ 

protected setupEventListeners(): void {
  // å¤–éƒ¨ã‹ã‚‰ã®ä¾é ¼ãƒªã‚¹ãƒˆæ›´æ–°
  this.eventBus.on('quests:available:updated', (data: { quests: Quest[] }) => {
    this.setAvailableQuests(data.quests);
  });

  // å—æ³¨æ¸ˆã¿ä¾é ¼ã®æ›´æ–°
  this.eventBus.on('quests:accepted:updated', (data: { questIds: string[] }) => {
    this.setAcceptedQuestIds(data.questIds);
  });
}

protected removeEventListeners(): void {
  this.eventBus.off('quests:available:updated');
  this.eventBus.off('quests:accepted:updated');
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: å—æ³¨ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° ğŸ”µ

**Given**: ä¾é ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹
**When**: å—æ³¨ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
**Then**: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: å—æ³¨ä¸Šé™ ğŸ”µ

**Given**: å—æ³¨ä¸Šé™ã«é”ã—ã¦ã„ã‚‹
**When**: æ–°ã—ã„ä¾é ¼ã‚’å—æ³¨ã—ã‚ˆã†ã¨ã™ã‚‹
**Then**: å—æ³¨ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å—æ³¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºç« ğŸ”µ

**Given**: ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œå—æ³¨ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
**When**: å—æ³¨å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹
**Then**: quest:acceptã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0218` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
- å—æ³¨å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®æ“ä½œåˆ¶é™

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
