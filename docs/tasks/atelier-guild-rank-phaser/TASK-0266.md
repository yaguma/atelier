# TASK-0266: ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0266
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼**: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ¡ä»¶ã¨çµæœè¡¨ç¤ºã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚Sãƒ©ãƒ³ã‚¯åˆ°é”æ™‚ã®ã‚¯ãƒªã‚¢åˆ¤å®šã€çµ±è¨ˆè¡¨ç¤ºã€ã‚¿ã‚¤ãƒˆãƒ«ã¸ã®å¾©å¸°ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0248 (GameClearSceneå®Ÿè£…), TASK-0263 (è¤‡æ•°æ—¥é€²è¡Œãƒ†ã‚¹ãƒˆ)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0269

## å®Œäº†æ¡ä»¶

- [ ] Sãƒ©ãƒ³ã‚¯åˆ°é”åˆ¤å®šã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚¯ãƒªã‚¢çµ±è¨ˆè¡¨ç¤ºã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚¿ã‚¤ãƒˆãƒ«å¾©å¸°ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [ ] ã‚¯ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹

---

## ãƒ†ã‚¹ãƒˆå®Ÿè£…è©³ç´°

### 1. ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢çµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ†ã‚¹ãƒˆ*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/phase5/GameClearIntegration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createTestGame, waitForScene, navigateToRankUp } from '../../../utils/phaserTestUtils';
import { EventBus } from '@/presentation/phaser/core/EventBus';
import { PhaserStateManager } from '@/presentation/phaser/state/PhaserStateManager';
import { SceneKeys } from '@/presentation/phaser/config/SceneKeys';

describe('Game Clear Integration', () => {
  let game: Phaser.Game;
  let eventBus: EventBus;
  let stateManager: PhaserStateManager;

  beforeEach(async () => {
    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
    stateManager = game.registry.get('stateManager');

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    eventBus.emit('ui:game:start:requested', { isNewGame: true });
  });

  afterEach(() => {
    game.destroy(true);
  });

  describe('Clear Condition - S Rank Achievement', () => {
    it('Sãƒ©ãƒ³ã‚¯åˆ°é”ã§ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã«ãªã‚‹', async () => {
      // Arrange
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalled();
      });
    });

    it('30æ—¥ã‚ˆã‚Šå‰ã«ã‚¯ãƒªã‚¢ã§ãã‚‹', async () => {
      // Arrange
      stateManager.updateProgress({ currentDay: 15, maxDay: 30 });
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await waitForScene(game, SceneKeys.GAME_CLEAR);
      expect(game.scene.isActive(SceneKeys.GAME_CLEAR)).toBe(true);
    });

    it('ã‚¯ãƒªã‚¢æ—¥æ•°ãŒè¨˜éŒ²ã•ã‚Œã‚‹', async () => {
      // Arrange
      const clearDay = 20;
      stateManager.updateProgress({ currentDay: clearDay, maxDay: 30 });
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            stats: expect.objectContaining({
              clearDay,
            }),
          })
        );
      });
    });
  });

  describe('Clear Statistics', () => {
    beforeEach(async () => {
      // ã‚¯ãƒªã‚¢ç›´å‰ã®çŠ¶æ…‹ã‚’è¨­å®š
      stateManager.updateProgress({ currentDay: 25, maxDay: 30 });
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
        gold: 5000,
      });
      stateManager.updateQuests({
        completed: [
          { id: 'q1' }, { id: 'q2' }, { id: 'q3' },
          { id: 'q4' }, { id: 'q5' }, { id: 'q6' },
          { id: 'q7' }, { id: 'q8' }, { id: 'q9' }, { id: 'q10' },
        ],
        accepted: [],
        available: [],
      });
    });

    it('å®Œäº†ã—ãŸä¾é ¼æ•°ãŒæ­£ã—ãé›†è¨ˆã•ã‚Œã‚‹', async () => {
      // Arrange
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            stats: expect.objectContaining({
              totalQuests: 10,
            }),
          })
        );
      });
    });

    it('æœ€çµ‚ã‚´ãƒ¼ãƒ«ãƒ‰ãŒè¨˜éŒ²ã•ã‚Œã‚‹', async () => {
      // Arrange
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            stats: expect.objectContaining({
              totalGold: 5000,
            }),
          })
        );
      });
    });

    it('ãƒ—ãƒ¬ã‚¤æ™‚é–“ãŒè¨˜éŒ²ã•ã‚Œã‚‹', async () => {
      // Arrange
      const saveLoadManager = game.registry.get('saveLoadManager');
      saveLoadManager.setPlaytime(3600); // 1æ™‚é–“

      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await vi.waitFor(() => {
        expect(gameClearCallback).toHaveBeenCalledWith(
          expect.objectContaining({
            stats: expect.objectContaining({
              playTime: expect.any(Number),
            }),
          })
        );
      });
    });
  });

  describe('Game Clear Scene', () => {
    beforeEach(async () => {
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
    });

    it('GameClearSceneã«é·ç§»ã™ã‚‹', async () => {
      // Arrange
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      // Assert
      await waitForScene(game, SceneKeys.GAME_CLEAR);
      expect(game.scene.isActive(SceneKeys.GAME_CLEAR)).toBe(true);
    });

    it('ã‚¯ãƒªã‚¢ç”»é¢ã«çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updateProgress({ currentDay: 20 });
      stateManager.updatePlayer({ gold: 8000 });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Assert
      const clearScene = game.scene.getScene(SceneKeys.GAME_CLEAR);
      expect(clearScene.data.get('clearDay')).toBe(20);
      expect(clearScene.data.get('finalRank')).toBe('S');
    });

    it('ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹', async () => {
      // Arrange
      await navigateToRankUp(game, eventBus);
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Act
      eventBus.emit('ui:return:title:requested');

      // Assert
      await waitForScene(game, SceneKeys.TITLE);
      expect(game.scene.isActive(SceneKeys.TITLE)).toBe(true);
    });

    it('ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹', async () => {
      // Arrange
      await navigateToRankUp(game, eventBus);
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Act
      eventBus.emit('ui:game:restart:requested');

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);

      // çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹
      const player = stateManager.getPlayerData();
      expect(player.rank).toBe('E');
      expect(player.gold).toBe(500); // åˆæœŸå€¤
    });
  });

  describe('Clear Data Persistence', () => {
    it('ã‚¯ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ãŒlocalStorageã«ä¿å­˜ã•ã‚Œã‚‹', async () => {
      // Arrange
      stateManager.updateProgress({ currentDay: 18 });
      stateManager.updatePlayer({
        rank: 'A',
        exp: 1600,
        maxExp: 1600,
      });
      await navigateToRankUp(game, eventBus);

      // Act
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Assert
      await vi.waitFor(() => {
        const clearData = localStorage.getItem('atelier_guild_rank_clear_history');
        expect(clearData).not.toBeNull();

        const history = JSON.parse(clearData!);
        expect(history).toContainEqual(
          expect.objectContaining({
            clearDay: 18,
            rank: 'S',
          })
        );
      });
    });

    it('è¤‡æ•°å›ã‚¯ãƒªã‚¢ã®å±¥æ­´ãŒä¿å­˜ã•ã‚Œã‚‹', async () => {
      // 1å›ç›®ã‚¯ãƒªã‚¢
      stateManager.updateProgress({ currentDay: 20 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600 });
      await navigateToRankUp(game, eventBus);
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã£ã¦å†ãƒ—ãƒ¬ã‚¤
      eventBus.emit('ui:game:restart:requested');
      await waitForScene(game, SceneKeys.MAIN);

      // 2å›ç›®ã‚¯ãƒªã‚¢
      stateManager.updateProgress({ currentDay: 15 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600 });
      await navigateToRankUp(game, eventBus);
      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Assert
      const clearData = localStorage.getItem('atelier_guild_rank_clear_history');
      const history = JSON.parse(clearData!);
      expect(history.length).toBe(2);
    });
  });

  describe('Clear Score Calculation', () => {
    it('æ—©ãã‚¯ãƒªã‚¢ã™ã‚‹ã»ã©é«˜ã‚¹ã‚³ã‚¢', async () => {
      // 20æ—¥ã‚¯ãƒªã‚¢
      stateManager.updateProgress({ currentDay: 20 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600, gold: 3000 });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      await vi.waitFor(() => {
        const call = gameClearCallback.mock.calls[0];
        const stats = call[0].stats;

        // æ—¥æ•°ãƒœãƒ¼ãƒŠã‚¹: (30 - 20) * 100 = 1000
        expect(stats.dayBonus).toBe(1000);
      });
    });

    it('ã‚´ãƒ¼ãƒ«ãƒ‰ãŒå¤šã„ã»ã©é«˜ã‚¹ã‚³ã‚¢', async () => {
      stateManager.updateProgress({ currentDay: 25 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600, gold: 10000 });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      await vi.waitFor(() => {
        const call = gameClearCallback.mock.calls[0];
        const stats = call[0].stats;

        // ã‚´ãƒ¼ãƒ«ãƒ‰ãƒœãƒ¼ãƒŠã‚¹
        expect(stats.goldBonus).toBeGreaterThan(0);
      });
    });

    it('å®Œäº†ä¾é ¼æ•°ãŒå¤šã„ã»ã©é«˜ã‚¹ã‚³ã‚¢', async () => {
      stateManager.updateProgress({ currentDay: 25 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600 });
      stateManager.updateQuests({
        completed: Array(20).fill({ id: 'q' }).map((_, i) => ({ id: `q${i}` })),
        accepted: [],
        available: [],
      });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      await vi.waitFor(() => {
        const call = gameClearCallback.mock.calls[0];
        const stats = call[0].stats;

        // ä¾é ¼ãƒœãƒ¼ãƒŠã‚¹
        expect(stats.questBonus).toBe(20 * 50); // 20 * 50ç‚¹
      });
    });

    it('ç·åˆã‚¹ã‚³ã‚¢ãŒè¨ˆç®—ã•ã‚Œã‚‹', async () => {
      stateManager.updateProgress({ currentDay: 20 });
      stateManager.updatePlayer({ rank: 'A', exp: 1600, maxExp: 1600, gold: 5000 });
      stateManager.updateQuests({
        completed: Array(10).fill({ id: 'q' }).map((_, i) => ({ id: `q${i}` })),
        accepted: [],
        available: [],
      });
      await navigateToRankUp(game, eventBus);

      const gameClearCallback = vi.fn();
      eventBus.on('app:game:clear', gameClearCallback);

      eventBus.emit('ui:rankup:challenge:requested', { targetRank: 'S' });

      await vi.waitFor(() => {
        const call = gameClearCallback.mock.calls[0];
        const stats = call[0].stats;

        expect(stats.totalScore).toBeDefined();
        expect(stats.totalScore).toBeGreaterThan(0);
      });
    });
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0266` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|-----------|---------------|
| ã‚¯ãƒªã‚¢åˆ¤å®š | 100% |
| çµ±è¨ˆè¡¨ç¤º | 95% |
| ã‚¹ã‚³ã‚¢è¨ˆç®— | 95% |
| ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– | 90% |

---

## æ³¨æ„äº‹é …

- ã‚¯ãƒªã‚¢æ¡ä»¶ã®ç¢ºå®Ÿãªæ¤œå‡º
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§
- å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
