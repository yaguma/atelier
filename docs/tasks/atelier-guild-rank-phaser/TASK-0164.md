# TASK-0164: EventBusã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

**ã‚¿ã‚¹ã‚¯ID**: TASK-0164
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - PhaseråŸºç›¤ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *å¦¥å½“ãªæ¨æ¸¬ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ **: [core-systems.md](../../design/atelier-guild-rank-phaser/core-systems.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/atelier-guild-rank-phaser/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

Phaser UIã¨Applicationå±¤ã®ç–çµåˆé€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹EventBusã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0160
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0165

## å®Œäº†æ¡ä»¶

- [x] IEventBusã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [x] 38ç¨®é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆå‹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ï¼ˆè¨­è¨ˆæ›¸ã®32ç¨®é¡ã‚’æ‹¡å¼µï¼‰
- [x] ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å‹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [x] å‹å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œãƒ»è³¼èª­ã®ä»•çµ„ã¿ãŒã‚ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾© ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *core-systems.mdã®32ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚è€ƒ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/EventTypes.ts`

```typescript
// UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆUI â†’ Applicationï¼‰
export const UIActionEvents = {
  // ã‚²ãƒ¼ãƒ é–‹å§‹
  NEW_GAME_CLICKED: 'ui:newGame:clicked',
  CONTINUE_CLICKED: 'ui:continue:clicked',

  // ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚º
  QUEST_SELECTED: 'ui:quest:selected',
  QUEST_ACCEPTED: 'ui:quest:accepted',
  QUEST_PHASE_COMPLETED: 'ui:questPhase:completed',

  // æ¡å–ãƒ•ã‚§ãƒ¼ã‚º
  GATHERING_CARD_SELECTED: 'ui:gatheringCard:selected',
  MATERIAL_OPTION_SELECTED: 'ui:materialOption:selected',
  GATHERING_CONFIRMED: 'ui:gathering:confirmed',
  GATHERING_SKIPPED: 'ui:gathering:skipped',

  // èª¿åˆãƒ•ã‚§ãƒ¼ã‚º
  RECIPE_CARD_SELECTED: 'ui:recipeCard:selected',
  MATERIAL_SLOT_SELECTED: 'ui:materialSlot:selected',
  ALCHEMY_CONFIRMED: 'ui:alchemy:confirmed',
  ALCHEMY_SKIPPED: 'ui:alchemy:skipped',

  // ç´å“ãƒ•ã‚§ãƒ¼ã‚º
  DELIVERY_ITEM_SELECTED: 'ui:deliveryItem:selected',
  DELIVERY_CONFIRMED: 'ui:delivery:confirmed',
  REWARD_CARD_SELECTED: 'ui:rewardCard:selected',

  // ã‚·ãƒ§ãƒƒãƒ—
  SHOP_ITEM_PURCHASED: 'ui:shopItem:purchased',
  SHOP_CLOSED: 'ui:shop:closed',

  // æ—¥çµ‚äº†
  DAY_END_CONFIRMED: 'ui:dayEnd:confirmed',

  // ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰
  SAVE_REQUESTED: 'ui:save:requested',
  LOAD_REQUESTED: 'ui:load:requested',
} as const;

// çŠ¶æ…‹æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆApplication â†’ UIï¼‰
export const StateUpdateEvents = {
  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  GAME_STATE_CHANGED: 'state:game:changed',
  PHASE_CHANGED: 'state:phase:changed',
  DAY_CHANGED: 'state:day:changed',

  // ãƒªã‚½ãƒ¼ã‚¹
  GOLD_CHANGED: 'state:gold:changed',
  AP_CHANGED: 'state:ap:changed',
  RANK_CHANGED: 'state:rank:changed',
  CONTRIBUTION_CHANGED: 'state:contribution:changed',

  // æ‰‹æœ­ãƒ»ãƒ‡ãƒƒã‚­
  HAND_UPDATED: 'state:hand:updated',
  DECK_UPDATED: 'state:deck:updated',

  // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª
  INVENTORY_UPDATED: 'state:inventory:updated',

  // ä¾é ¼
  QUESTS_UPDATED: 'state:quests:updated',
  ACTIVE_QUESTS_UPDATED: 'state:activeQuests:updated',
} as const;

export type UIActionEventKey = typeof UIActionEvents[keyof typeof UIActionEvents];
export type StateUpdateEventKey = typeof StateUpdateEvents[keyof typeof StateUpdateEvents];
export type EventKey = UIActionEventKey | StateUpdateEventKey;
```

### 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å‹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *è¨­è¨ˆæ›¸ã‹ã‚‰æ¨æ¸¬*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/EventPayloads.ts`

```typescript
import { Card } from '../../../domain/card/Card';
import { Material } from '../../../domain/material/Material';
import { Item } from '../../../domain/item/Item';
import { Quest } from '../../../domain/quest/Quest';
import { GuildRank } from '../../../domain/rank/GuildRank';
import { GamePhase } from '../../../domain/common/GamePhase';

// UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
export interface QuestSelectedPayload {
  questId: string;
}

export interface QuestAcceptedPayload {
  questId: string;
}

export interface GatheringCardSelectedPayload {
  cardId: string;
}

export interface MaterialOptionSelectedPayload {
  materialId: string;
  quality: string;
}

export interface RecipeCardSelectedPayload {
  cardId: string;
}

export interface MaterialSlotSelectedPayload {
  slotIndex: number;
  materialId: string;
}

export interface DeliveryItemSelectedPayload {
  itemId: string;
  questId: string;
}

export interface RewardCardSelectedPayload {
  cardId: string;
}

export interface ShopItemPurchasedPayload {
  itemId: string;
  itemType: 'card' | 'material' | 'artifact';
}

// çŠ¶æ…‹æ›´æ–°ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
export interface GameStateChangedPayload {
  state: 'title' | 'playing' | 'gameOver' | 'gameClear';
}

export interface PhaseChangedPayload {
  phase: GamePhase;
  previousPhase?: GamePhase;
}

export interface DayChangedPayload {
  day: number;
  maxDays: number;
}

export interface GoldChangedPayload {
  gold: number;
  delta: number;
}

export interface APChangedPayload {
  ap: number;
  maxAP: number;
}

export interface RankChangedPayload {
  rank: GuildRank;
  previousRank?: GuildRank;
}

export interface ContributionChangedPayload {
  contribution: number;
  maxContribution: number;
}

export interface HandUpdatedPayload {
  cards: Card[];
}

export interface DeckUpdatedPayload {
  deckCount: number;
  discardCount: number;
}

export interface InventoryUpdatedPayload {
  materials: Material[];
  items: Item[];
}

export interface QuestsUpdatedPayload {
  availableQuests: Quest[];
}

export interface ActiveQuestsUpdatedPayload {
  activeQuests: Quest[];
}

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
export interface EventPayloadMap {
  // UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  'ui:quest:selected': QuestSelectedPayload;
  'ui:quest:accepted': QuestAcceptedPayload;
  'ui:gatheringCard:selected': GatheringCardSelectedPayload;
  'ui:materialOption:selected': MaterialOptionSelectedPayload;
  'ui:recipeCard:selected': RecipeCardSelectedPayload;
  'ui:materialSlot:selected': MaterialSlotSelectedPayload;
  'ui:deliveryItem:selected': DeliveryItemSelectedPayload;
  'ui:rewardCard:selected': RewardCardSelectedPayload;
  'ui:shopItem:purchased': ShopItemPurchasedPayload;

  // çŠ¶æ…‹æ›´æ–°
  'state:game:changed': GameStateChangedPayload;
  'state:phase:changed': PhaseChangedPayload;
  'state:day:changed': DayChangedPayload;
  'state:gold:changed': GoldChangedPayload;
  'state:ap:changed': APChangedPayload;
  'state:rank:changed': RankChangedPayload;
  'state:contribution:changed': ContributionChangedPayload;
  'state:hand:updated': HandUpdatedPayload;
  'state:deck:updated': DeckUpdatedPayload;
  'state:inventory:updated': InventoryUpdatedPayload;
  'state:quests:updated': QuestsUpdatedPayload;
  'state:activeQuests:updated': ActiveQuestsUpdatedPayload;
}
```

### 3. IEventBusã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/events/IEventBus.ts`

```typescript
import { EventKey, EventPayloadMap } from './EventPayloads';

export type EventCallback<T> = (payload: T) => void;
export type UnsubscribeFn = () => void;

export interface IEventBus {
  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
   */
  emit<K extends keyof EventPayloadMap>(
    event: K,
    payload: EventPayloadMap[K]
  ): void;

  /**
   * ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãªã—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
   */
  emitVoid(event: EventKey): void;

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
   */
  on<K extends keyof EventPayloadMap>(
    event: K,
    callback: EventCallback<EventPayloadMap[K]>
  ): UnsubscribeFn;

  /**
   * ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãªã—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
   */
  onVoid(event: EventKey, callback: () => void): UnsubscribeFn;

  /**
   * ä¸€åº¦ã ã‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
   */
  once<K extends keyof EventPayloadMap>(
    event: K,
    callback: EventCallback<EventPayloadMap[K]>
  ): UnsubscribeFn;

  /**
   * ã‚¤ãƒ™ãƒ³ãƒˆã®è³¼èª­ã‚’è§£é™¤
   */
  off(event: EventKey, callback?: EventCallback<unknown>): void;

  /**
   * ã™ã¹ã¦ã®è³¼èª­ã‚’è§£é™¤
   */
  clear(): void;
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å‹ãƒã‚§ãƒƒã‚¯ ğŸŸ¡

**Given**: IEventBusã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
**When**: å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹
**Then**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¼ç¶²ç¾… ğŸŸ¡

**Given**: EventTypesãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
**When**: å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹
**Then**: 32ç¨®é¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0164` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å‹å®‰å…¨æ€§ã‚’æœ€å„ªå…ˆ
- ã‚¤ãƒ™ãƒ³ãƒˆåã¯ä¸€è²«ã—ãŸå‘½åè¦å‰‡ï¼ˆnamespace:entity:actionï¼‰
- ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã«

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 3é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: ä¸­å“è³ª
