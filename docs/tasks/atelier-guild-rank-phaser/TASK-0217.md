# TASK-0217: QuestAcceptContainerä¾é ¼è¡¨ç¤ºå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0217
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

QuestAcceptContainerã®ä¾é ¼ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã‚‹ã€‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0216
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0218

## å®Œäº†æ¡ä»¶

- [x] ä¾é ¼ãƒªã‚¹ãƒˆãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½
- [x] æœŸé™é †/å ±é…¬é †ã§ã‚½ãƒ¼ãƒˆã§ãã‚‹
- [x] é›£æ˜“åº¦ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãã‚‹
- [x] å—æ³¨æ¸ˆã¿ä¾é ¼ã¯è¡¨ç¤ºã•ã‚Œãªã„

---

## å®Ÿè£…è©³ç´°

### 1. ä¾é ¼ãƒªã‚¹ãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *rexUI ScrollablePanelä½¿ç”¨*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private scrollableQuestList?: any; // rexUI.ScrollablePanel

private createScrollableQuestList(): void {
  const scene = this.scene as any;

  if (!scene.rexUI) {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªã‚³ãƒ³ãƒ†ãƒŠä½¿ç”¨
    return;
  }

  this.scrollableQuestList = scene.rexUI.add.scrollablePanel({
    x: 20,
    y: 100,
    width: 350,
    height: 350,
    scrollMode: 0,

    panel: {
      child: this.createQuestListContent(),
      mask: { padding: 1 },
    },

    slider: {
      track: scene.rexUI.add.roundRectangle(0, 0, 8, 10, 4, 0x3a3a5a),
      thumb: scene.rexUI.add.roundRectangle(0, 0, 8, 40, 4, 0x6a6a8a),
    },

    space: {
      left: 10,
      right: 10,
      top: 10,
      bottom: 10,
      panel: 10,
    },
  }).layout();

  this.container.add(this.scrollableQuestList);
}

private createQuestListContent(): any {
  const scene = this.scene as any;

  // ç¸¦æ–¹å‘ã®Sizerã‚’ä½œæˆ
  const sizer = scene.rexUI.add.sizer({
    orientation: 'y',
    space: { item: 10 },
  });

  this.availableQuests.forEach((quest) => {
    const item = this.createQuestListItemForSizer(quest);
    sizer.add(item);
  });

  return sizer;
}
```

### 2. ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

type SortType = 'deadline' | 'reward' | 'difficulty';
private currentSort: SortType = 'deadline';
private sortButtons!: Phaser.GameObjects.Container;

private createSortButtons(): void {
  this.sortButtons = this.scene.add.container(20, 70);

  const sortOptions: Array<{ label: string; value: SortType }> = [
    { label: 'æœŸé™é †', value: 'deadline' },
    { label: 'å ±é…¬é †', value: 'reward' },
    { label: 'é›£æ˜“åº¦é †', value: 'difficulty' },
  ];

  sortOptions.forEach((option, index) => {
    const btn = this.createSortButton(option.label, option.value, index * 80);
    this.sortButtons.add(btn);
  });

  this.container.add(this.sortButtons);
}

private createSortButton(label: string, value: SortType, x: number): Phaser.GameObjects.Container {
  const btn = this.scene.add.container(x, 0);
  const isActive = this.currentSort === value;

  const bg = this.scene.add.graphics();
  bg.fillStyle(isActive ? 0x4a4a8a : 0x2a2a4a, 1);
  bg.fillRoundedRect(0, 0, 75, 25, 4);
  btn.add(bg);

  const text = this.scene.add.text(37, 12, label, {
    fontSize: '11px',
    color: '#ffffff',
  }).setOrigin(0.5);
  btn.add(text);

  btn.setInteractive(
    new Phaser.Geom.Rectangle(0, 0, 75, 25),
    Phaser.Geom.Rectangle.Contains
  );
  btn.on('pointerdown', () => this.setSortType(value));

  btn.setData('value', value);
  btn.setData('bg', bg);

  return btn;
}

private setSortType(type: SortType): void {
  this.currentSort = type;
  this.updateSortButtonVisuals();
  this.sortQuests();
  this.updateQuestList();
}

private sortQuests(): void {
  switch (this.currentSort) {
    case 'deadline':
      this.availableQuests.sort((a, b) => a.remainingDays - b.remainingDays);
      break;
    case 'reward':
      this.availableQuests.sort((a, b) => (b.reward.gold ?? 0) - (a.reward.gold ?? 0));
      break;
    case 'difficulty':
      const diffOrder = { 'easy': 0, 'normal': 1, 'hard': 2, 'expert': 3 };
      this.availableQuests.sort((a, b) =>
        (diffOrder[a.difficulty] ?? 0) - (diffOrder[b.difficulty] ?? 0)
      );
      break;
  }
}

private updateSortButtonVisuals(): void {
  this.sortButtons.each((child: Phaser.GameObjects.Container) => {
    const value = child.getData('value') as SortType;
    const bg = child.getData('bg') as Phaser.GameObjects.Graphics;
    const isActive = value === this.currentSort;

    bg.clear();
    bg.fillStyle(isActive ? 0x4a4a8a : 0x2a2a4a, 1);
    bg.fillRoundedRect(0, 0, 75, 25, 4);
  });
}
```

### 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private difficultyFilter: string | null = null;
private filterButtons!: Phaser.GameObjects.Container;

private createFilterButtons(): void {
  this.filterButtons = this.scene.add.container(240, 70);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
  const filterIcon = this.scene.add.text(0, 5, 'ğŸ”', { fontSize: '14px' });
  this.filterButtons.add(filterIcon);

  // é›£æ˜“åº¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼šãƒœã‚¿ãƒ³ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
  const difficulties = [null, 'easy', 'normal', 'hard', 'expert'];
  const labels = ['å…¨ã¦', 'ç°¡å˜', 'æ™®é€š', 'é›£', 'è¶…é›£'];

  // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º
  const currentFilterText = this.scene.add.text(25, 5, 'å…¨ã¦', {
    fontSize: '11px',
    color: '#ffffff',
  });
  this.filterButtons.add(currentFilterText);

  // ã‚¯ãƒªãƒƒã‚¯ã§å¾ªç’°
  this.filterButtons.setInteractive(
    new Phaser.Geom.Rectangle(0, 0, 80, 25),
    Phaser.Geom.Rectangle.Contains
  );
  this.filterButtons.on('pointerdown', () => {
    const currentIndex = difficulties.indexOf(this.difficultyFilter);
    const nextIndex = (currentIndex + 1) % difficulties.length;
    this.difficultyFilter = difficulties[nextIndex];
    currentFilterText.setText(labels[nextIndex]);
    this.updateQuestList();
  });

  this.container.add(this.filterButtons);
}

private getFilteredQuests(): Quest[] {
  if (!this.difficultyFilter) {
    return this.availableQuests;
  }
  return this.availableQuests.filter(q => q.difficulty === this.difficultyFilter);
}
```

### 4. å—æ³¨æ¸ˆã¿ä¾é ¼ã®é™¤å¤– ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çŠ¶æ…‹ç®¡ç†*

```typescript
// QuestAcceptContainerã«è¿½åŠ 

private acceptedQuestIds: Set<string> = new Set();

setAcceptedQuestIds(ids: string[]): void {
  this.acceptedQuestIds = new Set(ids);
  this.updateQuestList();
}

private getAvailableQuestsForDisplay(): Quest[] {
  const filtered = this.getFilteredQuests();
  return filtered.filter(q => !this.acceptedQuestIds.has(q.id));
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚½ãƒ¼ãƒˆ - æœŸé™é † ğŸ”µ

**Given**: æœŸé™ãŒãƒãƒ©ãƒãƒ©ã®ä¾é ¼ãƒªã‚¹ãƒˆ
**When**: setSortType('deadline')ã‚’å‘¼ã¶
**Then**: æœŸé™ãŒè¿‘ã„é †ã«ä¸¦ã¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ã‚½ãƒ¼ãƒˆ - å ±é…¬é † ğŸ”µ

**Given**: å ±é…¬ãŒãƒãƒ©ãƒãƒ©ã®ä¾é ¼ãƒªã‚¹ãƒˆ
**When**: setSortType('reward')ã‚’å‘¼ã¶
**Then**: å ±é…¬ãŒé«˜ã„é †ã«ä¸¦ã¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ğŸ”µ

**Given**: å„é›£æ˜“åº¦ã®ä¾é ¼ãŒã‚ã‚‹
**When**: difficultyFilter = 'hard'ã‚’è¨­å®š
**Then**: é›£ã—ã„ä¾é ¼ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0217` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚½ãƒ¼ãƒˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®çµ„ã¿åˆã‚ã›
- ç©ºã®çµæœæ™‚ã®è¡¨ç¤º
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆä¾é ¼æ•°ãŒå¤šã„å ´åˆï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
