# TASK-0221: GatheringCostViewå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0221
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

æ¡å–ãƒ•ã‚§ãƒ¼ã‚ºã§ã®APã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚ç¾åœ¨ã®APã¨å¿…è¦APã‚’è¦–è¦šçš„ã«è¡¨ç¤ºã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0173
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0222

## å®Œäº†æ¡ä»¶

- [ ] IGatheringCostViewã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] å¿…è¦APãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ç¾åœ¨ã®APã¨æ¯”è¼ƒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] APä¸è¶³æ™‚ã«è­¦å‘Šè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚³ã‚¹ãƒˆå¤‰æ›´æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. IGatheringCostViewã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/gathering/IGatheringCostView.ts`

```typescript
import Phaser from 'phaser';

export interface GatheringCostViewOptions {
  x?: number;
  y?: number;
  currentAP?: number;
  maxAP?: number;
}

export interface IGatheringCostView {
  readonly container: Phaser.GameObjects.Container;

  // APè¨­å®š
  setCurrentAP(current: number, max: number): void;
  setRequiredAP(cost: number): void;

  // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  canAfford(): boolean;
  getRequiredAP(): number;

  // è¡¨ç¤ºåˆ¶å¾¡
  setVisible(visible: boolean): void;

  // ç ´æ£„
  destroy(): void;
}
```

### 2. GatheringCostViewå®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *APã‚³ã‚¹ãƒˆè¡¨ç¤º*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/gathering/GatheringCostView.ts`

```typescript
import Phaser from 'phaser';
import { IGatheringCostView, GatheringCostViewOptions } from './IGatheringCostView';
import { Colors } from '../../config/ColorPalette';
import { TextStyles } from '../../config/TextStyles';

export class GatheringCostView implements IGatheringCostView {
  public readonly container: Phaser.GameObjects.Container;

  private scene: Phaser.Scene;
  private currentAP: number = 0;
  private maxAP: number = 10;
  private requiredAP: number = 0;

  // UIè¦ç´ 
  private background!: Phaser.GameObjects.Graphics;
  private apIcon!: Phaser.GameObjects.Text;
  private costLabel!: Phaser.GameObjects.Text;
  private costValue!: Phaser.GameObjects.Text;
  private remainingLabel!: Phaser.GameObjects.Text;
  private remainingValue!: Phaser.GameObjects.Text;
  private warningText?: Phaser.GameObjects.Text;
  private apGauge!: Phaser.GameObjects.Graphics;

  constructor(scene: Phaser.Scene, options: GatheringCostViewOptions = {}) {
    this.scene = scene;
    this.currentAP = options.currentAP ?? 0;
    this.maxAP = options.maxAP ?? 10;

    const x = options.x ?? 0;
    const y = options.y ?? 0;

    this.container = scene.add.container(x, y);
    this.create();
  }

  private create(): void {
    // èƒŒæ™¯
    this.background = this.scene.add.graphics();
    this.background.fillStyle(Colors.panelBackground, 0.95);
    this.background.fillRoundedRect(0, 0, 200, 120, 8);
    this.background.lineStyle(1, Colors.panelBorder);
    this.background.strokeRoundedRect(0, 0, 200, 120, 8);
    this.container.add(this.background);

    // ã‚¿ã‚¤ãƒˆãƒ«
    const title = this.scene.add.text(100, 15, 'âš¡ æ¶ˆè²»AP', {
      ...TextStyles.body,
      fontSize: '14px',
      fontStyle: 'bold',
    }).setOrigin(0.5, 0);
    this.container.add(title);

    // å¿…è¦APã‚³ã‚¹ãƒˆ
    this.costLabel = this.scene.add.text(20, 45, 'å¿…è¦:', {
      ...TextStyles.body,
      fontSize: '13px',
    });
    this.container.add(this.costLabel);

    this.costValue = this.scene.add.text(180, 45, '0 AP', {
      ...TextStyles.body,
      fontSize: '16px',
      fontStyle: 'bold',
    }).setOrigin(1, 0);
    this.container.add(this.costValue);

    // æ®‹ã‚ŠAP
    this.remainingLabel = this.scene.add.text(20, 70, 'æ®‹ã‚Š:', {
      ...TextStyles.body,
      fontSize: '13px',
      color: '#aaaaaa',
    });
    this.container.add(this.remainingLabel);

    this.remainingValue = this.scene.add.text(180, 70, '0 AP', {
      ...TextStyles.body,
      fontSize: '13px',
      color: '#aaaaaa',
    }).setOrigin(1, 0);
    this.container.add(this.remainingValue);

    // APã‚²ãƒ¼ã‚¸
    this.apGauge = this.scene.add.graphics();
    this.container.add(this.apGauge);
    this.updateAPGauge();
  }

  setCurrentAP(current: number, max: number): void {
    this.currentAP = current;
    this.maxAP = max;
    this.updateDisplay();
  }

  setRequiredAP(cost: number): void {
    const previousCost = this.requiredAP;
    this.requiredAP = cost;
    this.updateDisplay();

    // ã‚³ã‚¹ãƒˆå¤‰æ›´æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    if (previousCost !== cost) {
      this.animateCostChange();
    }
  }

  canAfford(): boolean {
    return this.currentAP >= this.requiredAP;
  }

  getRequiredAP(): number {
    return this.requiredAP;
  }

  private updateDisplay(): void {
    // ã‚³ã‚¹ãƒˆè¡¨ç¤º
    this.costValue.setText(`${this.requiredAP} AP`);

    // æ®‹ã‚ŠAPè¨ˆç®—
    const remaining = this.currentAP - this.requiredAP;

    // æ®‹ã‚Šè¡¨ç¤º
    this.remainingValue.setText(`${remaining} AP`);

    // è‰²è¨­å®š
    if (!this.canAfford()) {
      // APä¸è¶³
      this.costValue.setColor('#ff4444');
      this.remainingValue.setColor('#ff4444');
      this.showWarning();
    } else if (remaining <= 2) {
      // æ®‹ã‚Šã‚ãšã‹
      this.costValue.setColor('#ffaa00');
      this.remainingValue.setColor('#ffaa00');
      this.hideWarning();
    } else {
      // ååˆ†
      this.costValue.setColor('#00ff00');
      this.remainingValue.setColor('#aaaaaa');
      this.hideWarning();
    }

    this.updateAPGauge();
  }

  private updateAPGauge(): void {
    const gaugeX = 20;
    const gaugeY = 95;
    const gaugeWidth = 160;
    const gaugeHeight = 12;

    this.apGauge.clear();

    // èƒŒæ™¯
    this.apGauge.fillStyle(Colors.backgroundDark, 1);
    this.apGauge.fillRoundedRect(gaugeX, gaugeY, gaugeWidth, gaugeHeight, 4);

    // æ¶ˆè²»å¾Œã®æ®‹ã‚ŠAP
    const remainingRatio = this.maxAP > 0
      ? Math.max(0, (this.currentAP - this.requiredAP) / this.maxAP)
      : 0;
    const remainingWidth = gaugeWidth * remainingRatio;

    if (remainingWidth > 0) {
      this.apGauge.fillStyle(0x00aaff, 1);
      this.apGauge.fillRoundedRect(gaugeX, gaugeY, remainingWidth, gaugeHeight, 4);
    }

    // æ¶ˆè²»APéƒ¨åˆ†
    if (this.canAfford()) {
      const consumeRatio = this.maxAP > 0 ? this.requiredAP / this.maxAP : 0;
      const consumeWidth = gaugeWidth * consumeRatio;
      const consumeX = gaugeX + remainingWidth;

      if (consumeWidth > 0) {
        this.apGauge.fillStyle(0xff8800, 0.7);
        this.apGauge.fillRoundedRect(consumeX, gaugeY, consumeWidth, gaugeHeight, 4);
      }
    }

    // æ ç·š
    this.apGauge.lineStyle(1, Colors.panelBorder);
    this.apGauge.strokeRoundedRect(gaugeX, gaugeY, gaugeWidth, gaugeHeight, 4);
  }

  private showWarning(): void {
    if (this.warningText) return;

    this.warningText = this.scene.add.text(
      100,
      130,
      'âš ï¸ APãŒä¸è¶³ã—ã¦ã„ã¾ã™',
      {
        ...TextStyles.body,
        fontSize: '11px',
        color: '#ff4444',
      }
    ).setOrigin(0.5, 0);
    this.container.add(this.warningText);

    // ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.scene.tweens.add({
      targets: this.warningText,
      alpha: 0.5,
      duration: 500,
      yoyo: true,
      repeat: -1,
      ease: 'Sine.easeInOut',
    });
  }

  private hideWarning(): void {
    if (this.warningText) {
      this.warningText.destroy();
      this.warningText = undefined;
    }
  }

  private animateCostChange(): void {
    // ã‚³ã‚¹ãƒˆå€¤ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.scene.tweens.add({
      targets: this.costValue,
      scaleX: 1.2,
      scaleY: 1.2,
      duration: 100,
      yoyo: true,
      ease: 'Power2',
    });
  }

  setVisible(visible: boolean): void {
    this.container.setVisible(visible);
  }

  destroy(): void {
    this.hideWarning();
    this.container.destroy();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚³ã‚¹ãƒˆè¡¨ç¤º ğŸ”µ

**Given**: GatheringCostViewãŒã‚ã‚‹
**When**: setRequiredAP(3)ã‚’å‘¼ã¶
**Then**: "3 AP"ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: APä¸è¶³è­¦å‘Š ğŸ”µ

**Given**: currentAP=2
**When**: setRequiredAP(5)ã‚’å‘¼ã¶
**Then**: è­¦å‘Šãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: æ®‹ã‚ŠAPè¨ˆç®— ğŸ”µ

**Given**: currentAP=10, requiredAP=3
**When**: è¡¨ç¤ºã‚’ç¢ºèª
**Then**: æ®‹ã‚ŠAPãŒ7ã¨è¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0221` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- APã‚²ãƒ¼ã‚¸ã®è¦–è¦šçš„è¡¨ç¾
- è­¦å‘Šã®ç›®ç«‹ãŸã›æ–¹
- ã‚³ã‚¹ãƒˆå¤‰æ›´æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 2é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 2é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
