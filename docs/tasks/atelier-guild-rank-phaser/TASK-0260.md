# TASK-0260: å…¨ã‚·ãƒ¼ãƒ³é·ç§»çµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0260
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–ãƒ»ä»•ä¸Šã’
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

å…¨ã‚·ãƒ¼ãƒ³é–“ã®é·ç§»ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã™ã‚‹ã€‚æ­£å¸¸é·ç§»ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼å¾©æ—§ã‚’å«ã‚€åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0188, TASK-0238, TASK-0243, TASK-0246, TASK-0249
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0261

## å®Œäº†æ¡ä»¶ âœ… **å®Œäº†** (TDDé–‹ç™ºå®Œäº† - 17ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨é€šé)

- [x] Boot â†’ Titleé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Title â†’ Mainé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Main â†’ Shop â†’ Mainé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Main â†’ RankUp â†’ Mainé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Main â†’ GameOveré·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] Main â†’ GameClearé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] GameOver/GameClear â†’ Titleé·ç§»ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã™ã‚‹
- [x] ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆäºŒé‡é·ç§»é˜²æ­¢ç­‰ï¼‰ãŒãƒ‘ã‚¹ã™ã‚‹

---

## ãƒ†ã‚¹ãƒˆå®Ÿè£…è©³ç´°

### 1. ã‚·ãƒ¼ãƒ³é·ç§»çµ±åˆãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *çµ±åˆãƒ†ã‚¹ãƒˆ*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/phaser/phase5/SceneTransitionIntegration.test.ts`

```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import { createTestGame, waitForScene } from '../../../utils/phaserTestUtils';
import { SceneKeys } from '@/presentation/phaser/config/SceneKeys';
import { EventBus } from '@/presentation/phaser/core/EventBus';

describe('Scene Transition Integration', () => {
  let game: Phaser.Game;
  let eventBus: EventBus;

  beforeEach(async () => {
    const testSetup = await createTestGame();
    game = testSetup.game;
    eventBus = testSetup.eventBus;
  });

  afterEach(() => {
    game.destroy(true);
  });

  describe('Boot to Title', () => {
    it('BootSceneã‹ã‚‰TitleSceneã¸é·ç§»ã™ã‚‹', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.BOOT);

      // Act - ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      const bootScene = game.scene.getScene(SceneKeys.BOOT);
      bootScene.events.emit('complete');

      // Assert
      await waitForScene(game, SceneKeys.TITLE);
      expect(game.scene.isActive(SceneKeys.TITLE)).toBe(true);
      expect(game.scene.isActive(SceneKeys.BOOT)).toBe(false);
    });
  });

  describe('Title to Main', () => {
    it('æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ã§MainSceneã¸é·ç§»ã™ã‚‹', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.TITLE);

      // Act
      eventBus.emit('ui:game:start:requested', { isNewGame: true });

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
    });

    it('ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ã§MainSceneã¸é·ç§»ã™ã‚‹', async () => {
      // Arrange - ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      localStorage.setItem('atelier_guild_rank_save_1', JSON.stringify({
        version: '1.0.0',
        timestamp: Date.now(),
        playtime: 0,
        state: JSON.stringify({ progress: { currentDay: 5 } }),
      }));

      await waitForScene(game, SceneKeys.TITLE);

      // Act
      eventBus.emit('ui:game:continue:requested', { slotId: 1 });

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
    });
  });

  describe('Main to SubScenes', () => {
    beforeEach(async () => {
      // MainSceneã«é·ç§»
      await waitForScene(game, SceneKeys.TITLE);
      eventBus.emit('ui:game:start:requested', { isNewGame: true });
      await waitForScene(game, SceneKeys.MAIN);
    });

    it('Main â†’ Shop â†’ Mainã®å¾€å¾©é·ç§»', async () => {
      // Act - ã‚·ãƒ§ãƒƒãƒ—ã¸
      eventBus.emit('ui:shop:open:requested');
      await waitForScene(game, SceneKeys.SHOP);

      // Assert
      expect(game.scene.isActive(SceneKeys.SHOP)).toBe(true);

      // Act - ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹
      eventBus.emit('ui:shop:close:requested');
      await waitForScene(game, SceneKeys.MAIN);

      // Assert
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
      expect(game.scene.isActive(SceneKeys.SHOP)).toBe(false);
    });

    it('Main â†’ RankUp â†’ Mainã®å¾€å¾©é·ç§»', async () => {
      // Act - æ˜‡æ ¼è©¦é¨“ã¸
      eventBus.emit('ui:rankup:open:requested');
      await waitForScene(game, SceneKeys.RANK_UP);

      // Assert
      expect(game.scene.isActive(SceneKeys.RANK_UP)).toBe(true);

      // Act - ãƒ¡ã‚¤ãƒ³ã¸æˆ»ã‚‹
      eventBus.emit('ui:rankup:close:requested');
      await waitForScene(game, SceneKeys.MAIN);

      // Assert
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(true);
    });
  });

  describe('Game End Transitions', () => {
    beforeEach(async () => {
      await waitForScene(game, SceneKeys.TITLE);
      eventBus.emit('ui:game:start:requested', { isNewGame: true });
      await waitForScene(game, SceneKeys.MAIN);
    });

    it('ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«GameOverSceneã¸é·ç§»ã™ã‚‹', async () => {
      // Act
      eventBus.emit('app:game:over', {
        reason: 'æ—¥æ•°è¶…é',
        stats: { finalDay: 30, finalRank: 'C' },
      });

      // Assert
      await waitForScene(game, SceneKeys.GAME_OVER);
      expect(game.scene.isActive(SceneKeys.GAME_OVER)).toBe(true);
      expect(game.scene.isActive(SceneKeys.MAIN)).toBe(false);
    });

    it('ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ™‚ã«GameClearSceneã¸é·ç§»ã™ã‚‹', async () => {
      // Act
      eventBus.emit('app:game:clear', {
        stats: { clearDay: 20, finalRank: 'S' },
      });

      // Assert
      await waitForScene(game, SceneKeys.GAME_CLEAR);
      expect(game.scene.isActive(SceneKeys.GAME_CLEAR)).toBe(true);
    });

    it('GameOverã‹ã‚‰Titleã¸æˆ»ã‚Œã‚‹', async () => {
      // Arrange
      eventBus.emit('app:game:over', { reason: 'test', stats: {} });
      await waitForScene(game, SceneKeys.GAME_OVER);

      // Act
      eventBus.emit('ui:return:title:requested');

      // Assert
      await waitForScene(game, SceneKeys.TITLE);
      expect(game.scene.isActive(SceneKeys.TITLE)).toBe(true);
    });

    it('GameClearã‹ã‚‰Titleã¸æˆ»ã‚Œã‚‹', async () => {
      // Arrange
      eventBus.emit('app:game:clear', { stats: {} });
      await waitForScene(game, SceneKeys.GAME_CLEAR);

      // Act
      eventBus.emit('ui:return:title:requested');

      // Assert
      await waitForScene(game, SceneKeys.TITLE);
      expect(game.scene.isActive(SceneKeys.TITLE)).toBe(true);
    });
  });

  describe('Edge Cases', () => {
    it('é·ç§»ä¸­ã«äºŒé‡é·ç§»è¦æ±‚ãŒç„¡è¦–ã•ã‚Œã‚‹', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.TITLE);
      const consoleSpy = vi.spyOn(console, 'warn');

      // Act - åŒæ™‚ã«è¤‡æ•°é·ç§»è¦æ±‚
      eventBus.emit('ui:game:start:requested', { isNewGame: true });
      eventBus.emit('ui:game:start:requested', { isNewGame: true });

      // Assert
      await waitForScene(game, SceneKeys.MAIN);
      expect(consoleSpy).toHaveBeenCalledWith(expect.stringContaining('transition'));
    });

    it('å­˜åœ¨ã—ãªã„ã‚·ãƒ¼ãƒ³ã¸ã®é·ç§»è¦æ±‚ãŒã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.TITLE);
      const errorCallback = vi.fn();
      eventBus.on('app:error:occurred', errorCallback);

      // Act
      const sceneManager = game.registry.get('sceneManager');
      sceneManager.switchTo('NonExistentScene');

      // Assert
      expect(errorCallback).toHaveBeenCalled();
    });

    it('çŠ¶æ…‹ãŒæ­£ã—ãå¼•ãç¶™ãŒã‚Œã‚‹', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.TITLE);
      eventBus.emit('ui:game:start:requested', { isNewGame: true });
      await waitForScene(game, SceneKeys.MAIN);

      const stateManager = game.registry.get('stateManager');
      stateManager.updatePlayer({ gold: 999 });

      // Act - ã‚·ãƒ§ãƒƒãƒ—ã¸é·ç§»ã—ã¦æˆ»ã‚‹
      eventBus.emit('ui:shop:open:requested');
      await waitForScene(game, SceneKeys.SHOP);
      eventBus.emit('ui:shop:close:requested');
      await waitForScene(game, SceneKeys.MAIN);

      // Assert
      const player = stateManager.getPlayerData();
      expect(player.gold).toBe(999);
    });
  });

  describe('Transition Animations', () => {
    it('é·ç§»æ™‚ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹', async () => {
      // Arrange
      await waitForScene(game, SceneKeys.TITLE);
      const sceneManager = game.registry.get('sceneManager');
      const transitionSpy = vi.spyOn(sceneManager, 'switchTo');

      // Act
      eventBus.emit('ui:game:start:requested', { isNewGame: true });

      // Assert
      expect(transitionSpy).toHaveBeenCalledWith(
        SceneKeys.MAIN,
        expect.any(Object),
        expect.objectContaining({ transition: expect.any(String) })
      );
    });
  });
});
```

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0260` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | ç›®æ¨™ã‚«ãƒãƒ¬ãƒƒã‚¸ |
|-----------|---------------|
| æ­£å¸¸é·ç§»ãƒ‘ã‚¹ | 100% |
| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | 90% |
| ã‚¨ãƒ©ãƒ¼å¾©æ—§ | 85% |

---

## æ³¨æ„äº‹é …

- éåŒæœŸé·ç§»ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- çŠ¶æ…‹ã®å¼•ãç¶™ãæ¤œè¨¼
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
