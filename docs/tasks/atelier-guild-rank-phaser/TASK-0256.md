# TASK-0256: ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆæ›´æ–°

**ã‚¿ã‚¹ã‚¯ID**: TASK-0256
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: DIRECT
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”´ *Phaserå›ºæœ‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: [architecture.md](../../design/atelier-guild-rank-phaser/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

Phaserç‰ˆã‚²ãƒ¼ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆmain.tsï¼‰ã‚’æ›´æ–°ã™ã‚‹ã€‚Phaserã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åˆæœŸåŒ–ã€ã‚·ãƒ¼ãƒ³ã®ç™»éŒ²ã€ä¾å­˜æ€§æ³¨å…¥ã®è¨­å®šã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0183 (BootSceneãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè£…)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0257

## å®Œäº†æ¡ä»¶

- [ ] Phaserã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹
- [ ] å…¨ã‚·ãƒ¼ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] ä¾å­˜æ€§æ³¨å…¥ã‚³ãƒ³ãƒ†ãƒŠãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] EventBus/StateManager/FlowManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. main.tså®Ÿè£… ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/main.ts`

```typescript
import Phaser from 'phaser';
import { GameConfig } from './presentation/phaser/config/GameConfig';
import { SceneKeys } from './presentation/phaser/config/SceneKeys';

// ã‚·ãƒ¼ãƒ³ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { BootScene } from './presentation/phaser/scenes/BootScene';
import { TitleScene } from './presentation/phaser/scenes/TitleScene';
import { MainScene } from './presentation/phaser/scenes/MainScene';
import { ShopScene } from './presentation/phaser/scenes/ShopScene';
import { RankUpScene } from './presentation/phaser/scenes/RankUpScene';
import { GameOverScene } from './presentation/phaser/scenes/GameOverScene';
import { GameClearScene } from './presentation/phaser/scenes/GameClearScene';

// ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { EventBus } from './presentation/phaser/core/EventBus';
import { SceneManager } from './presentation/phaser/core/SceneManager';
import { PhaserStateManager } from './presentation/phaser/state/PhaserStateManager';
import { PhaserGameFlowManager } from './presentation/phaser/flow/PhaserGameFlowManager';
import { PhaserSaveLoadManager } from './presentation/phaser/save/PhaserSaveLoadManager';
import { DialogManager } from './presentation/phaser/ui/DialogManager';
import { ToastManager } from './presentation/phaser/ui/ToastManager';

// Applicationå±¤ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { EventBusAdapter } from './presentation/phaser/events/EventBusAdapter';
import { GameUseCaseHandler } from './presentation/phaser/application/GameUseCaseHandler';

// UseCaseã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { QuestUseCase } from './application/usecase/QuestUseCase';
import { GatheringUseCase } from './application/usecase/GatheringUseCase';
import { AlchemyUseCase } from './application/usecase/AlchemyUseCase';
import { ShopUseCase } from './application/usecase/ShopUseCase';
import { DeckUseCase } from './application/usecase/DeckUseCase';
import { GameFlowUseCase } from './application/usecase/GameFlowUseCase';
import { SaveLoadUseCase } from './application/usecase/SaveLoadUseCase';
import { RankUseCase } from './application/usecase/RankUseCase';

// ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { MasterDataRepository } from './infrastructure/repository/MasterDataRepository';

/**
 * ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 */
declare global {
  interface Window {
    game: Phaser.Game;
    eventBus: EventBus;
    stateManager: PhaserStateManager;
    flowManager: PhaserGameFlowManager;
    saveLoadManager: PhaserSaveLoadManager;
  }
}

/**
 * ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
 */
async function initializeGame(): Promise<Phaser.Game> {
  // ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
  const eventBus = new EventBus();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«EventBusã‚’å…¬é–‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  window.eventBus = eventBus;

  // Phaserã‚²ãƒ¼ãƒ è¨­å®š
  const config: Phaser.Types.Core.GameConfig = {
    ...GameConfig,
    scene: [
      BootScene,
      TitleScene,
      MainScene,
      ShopScene,
      RankUpScene,
      GameOverScene,
      GameClearScene,
    ],
    callbacks: {
      preBoot: (game) => {
        // ã‚²ãƒ¼ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«EventBusã‚’æ³¨å…¥
        game.registry.set('eventBus', eventBus);
      },
      postBoot: (game) => {
        // ã‚²ãƒ¼ãƒ èµ·å‹•å¾Œã®åˆæœŸåŒ–
        initializeManagers(game, eventBus);
      },
    },
  };

  // Phaserã‚²ãƒ¼ãƒ ä½œæˆ
  const game = new Phaser.Game(config);
  window.game = game;

  return game;
}

/**
 * ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
 */
function initializeManagers(game: Phaser.Game, eventBus: EventBus): void {
  // SceneManageråˆæœŸåŒ–
  const sceneManager = new SceneManager(game, eventBus);
  game.registry.set('sceneManager', sceneManager);

  // StateManageråˆæœŸåŒ–
  const stateManager = new PhaserStateManager(eventBus);
  game.registry.set('stateManager', stateManager);
  window.stateManager = stateManager;

  // GameFlowManageråˆæœŸåŒ–
  const flowManager = new PhaserGameFlowManager(eventBus, sceneManager, stateManager);
  game.registry.set('flowManager', flowManager);
  window.flowManager = flowManager;

  // SaveLoadManageråˆæœŸåŒ–
  const saveLoadManager = new PhaserSaveLoadManager(eventBus, stateManager, flowManager);
  game.registry.set('saveLoadManager', saveLoadManager);
  window.saveLoadManager = saveLoadManager;

  // UIãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ï¼ˆã‚·ãƒ¼ãƒ³èµ·å‹•å¾Œã«å„ã‚·ãƒ¼ãƒ³ã§å–å¾—ï¼‰
  game.registry.set('dialogManagerFactory', (scene: Phaser.Scene) => new DialogManager(scene));
  game.registry.set('toastManagerFactory', (scene: Phaser.Scene) => new ToastManager(scene));

  // Applicationå±¤åˆæœŸåŒ–
  initializeApplicationLayer(game, eventBus, stateManager);

  console.log('Phaser managers initialized');
}

/**
 * Applicationå±¤åˆæœŸåŒ–
 */
function initializeApplicationLayer(
  game: Phaser.Game,
  eventBus: EventBus,
  stateManager: PhaserStateManager
): void {
  // ãƒªãƒã‚¸ãƒˆãƒªåˆæœŸåŒ–
  const masterDataRepository = new MasterDataRepository();

  // UseCaseåˆæœŸåŒ–
  const questUseCase = new QuestUseCase(masterDataRepository, stateManager);
  const gatheringUseCase = new GatheringUseCase(masterDataRepository, stateManager);
  const alchemyUseCase = new AlchemyUseCase(masterDataRepository, stateManager);
  const shopUseCase = new ShopUseCase(masterDataRepository, stateManager);
  const deckUseCase = new DeckUseCase(stateManager);
  const gameFlowUseCase = new GameFlowUseCase(stateManager);
  const saveLoadUseCase = new SaveLoadUseCase(stateManager);
  const rankUseCase = new RankUseCase(masterDataRepository, stateManager);

  // EventBusAdapteråˆæœŸåŒ–
  const eventBusAdapter = new EventBusAdapter(eventBus);

  // GameUseCaseHandleråˆæœŸåŒ–
  const useCaseHandler = new GameUseCaseHandler(eventBusAdapter, {
    questUseCase,
    gatheringUseCase,
    alchemyUseCase,
    shopUseCase,
    deckUseCase,
    gameFlowUseCase,
    saveLoadUseCase,
    rankUseCase,
  });

  game.registry.set('useCaseHandler', useCaseHandler);
  game.registry.set('eventBusAdapter', eventBusAdapter);

  console.log('Application layer initialized');
}

/**
 * ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    console.log('Starting Atelier Guild Rank...');

    const game = await initializeGame();

    // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©
    window.addEventListener('resize', () => {
      game.scale.refresh();
    });

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Š
    window.addEventListener('beforeunload', (e) => {
      // ã‚²ãƒ¼ãƒ ä¸­ã®ã¿è­¦å‘Š
      const stateManager = window.stateManager;
      if (stateManager) {
        const progress = stateManager.getProgress();
        if (progress.currentDay > 1) {
          e.preventDefault();
          e.returnValue = 'ã‚²ãƒ¼ãƒ ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬å½“ã«é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
        }
      }
    });

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹/ãƒ–ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    window.addEventListener('blur', () => {
      game.sound.pauseAll();
    });

    window.addEventListener('focus', () => {
      game.sound.resumeAll();
    });

    console.log('Game initialized successfully');
  } catch (error) {
    console.error('Failed to initialize game:', error);

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    const container = document.getElementById('game-container');
    if (container) {
      container.innerHTML = `
        <div style="color: #ff4444; padding: 20px; text-align: center;">
          <h2>ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</h2>
          <p>ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
          <p style="font-size: 12px; color: #888;">${error}</p>
        </div>
      `;
    }
  }
});
```

### 2. GameConfigå®šç¾© ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *Phaserè¨­å®š*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/config/GameConfig.ts`

```typescript
import Phaser from 'phaser';

export const GameConfig: Phaser.Types.Core.GameConfig = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: 1280,
  height: 720,
  backgroundColor: '#1a1a2e',
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH,
    min: {
      width: 640,
      height: 360,
    },
    max: {
      width: 1920,
      height: 1080,
    },
  },
  dom: {
    createContainer: true,
  },
  input: {
    keyboard: true,
    mouse: true,
    touch: true,
    gamepad: false,
  },
  render: {
    pixelArt: false,
    antialias: true,
    antialiasGL: true,
  },
  audio: {
    disableWebAudio: false,
  },
  physics: {
    default: 'arcade',
    arcade: {
      debug: false,
    },
  },
  fps: {
    target: 60,
    forceSetTimeOut: false,
  },
  plugins: {
    global: [
      // rexUIãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯åˆ¥é€”ç™»éŒ²
    ],
  },
};

// é–‹ç™ºãƒ¢ãƒ¼ãƒ‰è¨­å®š
export const isDevelopment = import.meta.env.DEV;
export const isProduction = import.meta.env.PROD;

// ãƒ‡ãƒãƒƒã‚°è¨­å®š
export const DebugConfig = {
  showFPS: isDevelopment,
  logEvents: isDevelopment,
  skipBoot: false,
};
```

### 3. SceneKeyså®šç¾© ğŸ”´

**ä¿¡é ¼æ€§**: ğŸ”´ *ã‚·ãƒ¼ãƒ³ã‚­ãƒ¼*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/config/SceneKeys.ts`

```typescript
export const SceneKeys = {
  BOOT: 'BootScene',
  TITLE: 'TitleScene',
  MAIN: 'MainScene',
  SHOP: 'ShopScene',
  RANK_UP: 'RankUpScene',
  GAME_OVER: 'GameOverScene',
  GAME_CLEAR: 'GameClearScene',
} as const;

export type SceneKey = typeof SceneKeys[keyof typeof SceneKeys];
```

---

## å®Ÿè£…æ‰‹é †

1. `/direct-setup` - å®Ÿè£…å®Ÿè¡Œ
2. `/direct-verify` - å‹•ä½œç¢ºèª

---

## å‹•ä½œç¢ºèªæ‰‹é †

1. `npm run dev` ã§ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚²ãƒ¼ãƒ ãŒèµ·å‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«åˆæœŸåŒ–ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. BootScene â†’ TitleSceneã®é·ç§»ã‚’ç¢ºèª

---

## æ³¨æ„äº‹é …

- rexUIãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- éåŒæœŸåˆæœŸåŒ–ã®é †åº
- ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 3é …ç›® (100%)

**å“è³ªè©•ä¾¡**: ä½å“è³ªï¼ˆå®Ÿè£…æ™‚ã«èª¿æ•´è¦ãƒ»Phaserå›ºæœ‰ï¼‰
