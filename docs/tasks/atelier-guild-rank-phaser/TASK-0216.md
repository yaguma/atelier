# TASK-0216: QuestAcceptContainerè¨­è¨ˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0216
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¨­è¨ˆã™ã‚‹ã€‚åˆ©ç”¨å¯èƒ½ãªä¾é ¼ã®ä¸€è¦§è¡¨ç¤ºã¨å—æ³¨æ“ä½œã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0213, TASK-0214
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0217

## å®Œäº†æ¡ä»¶

- [ ] QuestAcceptContainerãŒBasePhaseContainerã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹
- [ ] åˆ©ç”¨å¯èƒ½ä¾é ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºé ˜åŸŸãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] é¸æŠã—ãŸä¾é ¼ã®è©³ç´°è¡¨ç¤ºãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹
- [ ] å—æ³¨/ã‚¹ã‚­ãƒƒãƒ—ã®æ“ä½œãƒ•ãƒ­ãƒ¼ãŒè¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. QuestAcceptContainerè¨­è¨ˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚º*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/phase/QuestAcceptContainer.ts`

```typescript
import Phaser from 'phaser';
import { BasePhaseContainer } from './BasePhaseContainer';
import { PhaseContainerConfig } from './IPhaseContainer';
import { GamePhase } from '../../../../domain/common/GamePhase';
import { Quest } from '../../../../domain/quest/Quest';
import { QuestPanel } from '../quest/QuestPanel';

export interface QuestAcceptContainerConfig extends PhaseContainerConfig {
  onQuestAccepted?: (quest: Quest) => void;
  onSkip?: () => void;
}

export class QuestAcceptContainer extends BasePhaseContainer {
  public readonly phase: GamePhase = 'quest_accept';

  private availableQuests: Quest[] = [];
  private selectedQuest: Quest | null = null;

  // UIè¦ç´ 
  private questListContainer!: Phaser.GameObjects.Container;
  private questPanel!: QuestPanel;
  private skipButton!: Phaser.GameObjects.Container;

  private onQuestAccepted?: (quest: Quest) => void;
  private onSkip?: () => void;

  constructor(config: QuestAcceptContainerConfig) {
    super(config);
    this.onQuestAccepted = config.onQuestAccepted;
    this.onSkip = config.onSkip;
  }

  // --- å…¬é–‹API ---

  setAvailableQuests(quests: Quest[]): void {
    this.availableQuests = quests;
    this.updateQuestList();
  }

  getSelectedQuest(): Quest | null {
    return this.selectedQuest;
  }

  // --- BasePhaseContainerå®Ÿè£… ---

  protected createContent(): void {
    this.createTitle('ğŸ“‹ ä¾é ¼å—æ³¨');
    this.createDescription(
      'ã‚®ãƒ«ãƒ‰ã®ä¾é ¼ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä¾é ¼ã‚’é¸æŠã—ã¦å—æ³¨ã—ã¾ã—ã‚‡ã†ã€‚\nè¤‡æ•°ã®ä¾é ¼ã‚’åŒæ™‚ã«å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚',
      50
    );

    this.createQuestListArea();
    this.createQuestDetailArea();
    this.createActionArea();
  }

  protected async onEnter(): Promise<void> {
    // ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã®å‡¦ç†
    this.selectedQuest = null;
    this.questPanel.setQuest(null);

    // ä¾é ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    this.updateQuestList();
  }

  protected async onExit(): Promise<void> {
    // ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†æ™‚ã®å‡¦ç†
    this.clearState();
  }

  protected onUpdate(delta: number): void {
    // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  }

  protected getCompletionResult(): any {
    return {
      acceptedQuest: this.selectedQuest,
    };
  }

  canComplete(): boolean {
    // ã‚¹ã‚­ãƒƒãƒ—ã‚‚å®Œäº†ã¨ã—ã¦æ‰±ã†
    return true;
  }

  // --- UIä½œæˆ ---

  private createQuestListArea(): void {
    // ä¾é ¼ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆå·¦å´ï¼‰
    this.questListContainer = this.scene.add.container(20, 100);

    // ã‚¨ãƒªã‚¢èƒŒæ™¯
    const listBg = this.scene.add.graphics();
    listBg.fillStyle(0x1a1a2e, 0.8);
    listBg.fillRoundedRect(0, 0, 350, 350, 8);
    this.questListContainer.add(listBg);

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    const header = this.scene.add.text(10, 10, 'åˆ©ç”¨å¯èƒ½ãªä¾é ¼', {
      ...TextStyles.body,
      fontSize: '14px',
      fontStyle: 'bold',
    });
    this.questListContainer.add(header);

    this.container.add(this.questListContainer);
  }

  private createQuestDetailArea(): void {
    // ä¾é ¼è©³ç´°ã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰
    this.questPanel = new QuestPanel(this.scene, {
      x: 400,
      y: 100,
      width: 380,
      height: 350,
      onAccept: (quest) => this.handleQuestAccept(quest),
    });
    this.container.add(this.questPanel.container);
  }

  private createActionArea(): void {
    // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³
    this.skipButton = this.createButton(
      this.width / 2,
      this.height - 40,
      'ä¾é ¼ã‚’å—ã‘ãšã«æ¬¡ã¸',
      () => this.handleSkip(),
      false
    );
    this.container.add(this.skipButton);
  }

  // --- ä¾é ¼ãƒªã‚¹ãƒˆæ›´æ–° ---

  private updateQuestList(): void {
    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
    // ... çœç•¥

    this.availableQuests.forEach((quest, index) => {
      const item = this.createQuestListItem(quest, index);
      this.questListContainer.add(item);
    });
  }

  private createQuestListItem(quest: Quest, index: number): Phaser.GameObjects.Container {
    const y = 40 + index * 60;
    const itemContainer = this.scene.add.container(10, y);

    // èƒŒæ™¯
    const bg = this.scene.add.graphics();
    bg.fillStyle(0x2a2a4a, 0.9);
    bg.fillRoundedRect(0, 0, 330, 55, 6);
    itemContainer.add(bg);

    // ä¾é ¼å
    const nameText = this.scene.add.text(10, 8, quest.name, {
      ...TextStyles.body,
      fontSize: '13px',
    });
    itemContainer.add(nameText);

    // æœŸé™
    const deadlineText = this.scene.add.text(10, 30, `æœŸé™: ${quest.remainingDays}æ—¥`, {
      ...TextStyles.bodySmall,
      fontSize: '11px',
      color: '#aaaaaa',
    });
    itemContainer.add(deadlineText);

    // å ±é…¬
    const rewardText = this.scene.add.text(200, 20, `ğŸ’°${quest.reward.gold}`, {
      ...TextStyles.bodySmall,
      fontSize: '11px',
      color: '#ffd700',
    });
    itemContainer.add(rewardText);

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
    itemContainer.setInteractive(
      new Phaser.Geom.Rectangle(0, 0, 330, 55),
      Phaser.Geom.Rectangle.Contains
    );
    itemContainer.on('pointerdown', () => this.selectQuest(quest));
    itemContainer.on('pointerover', () => {
      bg.clear();
      bg.fillStyle(0x3a3a5a, 0.9);
      bg.fillRoundedRect(0, 0, 330, 55, 6);
    });
    itemContainer.on('pointerout', () => {
      bg.clear();
      bg.fillStyle(quest === this.selectedQuest ? 0x4a4a8a : 0x2a2a4a, 0.9);
      bg.fillRoundedRect(0, 0, 330, 55, 6);
    });

    itemContainer.setData('quest', quest);
    itemContainer.setData('bg', bg);

    return itemContainer;
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

  private selectQuest(quest: Quest): void {
    this.selectedQuest = quest;
    this.questPanel.setQuest(quest);

    // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
    this.updateQuestListHighlight();
  }

  private updateQuestListHighlight(): void {
    this.questListContainer.each((child: Phaser.GameObjects.Container) => {
      const quest = child.getData('quest') as Quest | undefined;
      const bg = child.getData('bg') as Phaser.GameObjects.Graphics | undefined;

      if (quest && bg) {
        bg.clear();
        bg.fillStyle(quest === this.selectedQuest ? 0x4a4a8a : 0x2a2a4a, 0.9);
        bg.fillRoundedRect(0, 0, 330, 55, 6);
      }
    });
  }

  private handleQuestAccept(quest: Quest): void {
    if (this.onQuestAccepted) {
      this.onQuestAccepted(quest);
    }
    this.complete();
  }

  private handleSkip(): void {
    if (this.onSkip) {
      this.onSkip();
    }
    this.complete();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ä¾é ¼ãƒªã‚¹ãƒˆè¡¨ç¤º ğŸ”µ

**Given**: QuestAcceptContainerãŒã‚ã‚‹
**When**: setAvailableQuests([...])ã‚’å‘¼ã¶
**Then**: ä¾é ¼ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ä¾é ¼é¸æŠ ğŸ”µ

**Given**: ä¾é ¼ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: ä¾é ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
**Then**: QuestPanelã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0216` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ä¾é ¼ãƒªã‚¹ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
- é¸æŠçŠ¶æ…‹ã®ç®¡ç†
- ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 1é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 1é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
