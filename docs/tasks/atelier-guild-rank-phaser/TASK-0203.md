# TASK-0203: HeaderUIæ—¥æ•°ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ»APå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0203
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - åŸºæœ¬ã‚·ãƒ¼ãƒ³ãƒ»å…±é€šUIå®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒ˜ãƒƒãƒ€ãƒ¼UIã®æ—¥æ•°è¡¨ç¤ºã€ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºã€APã‚²ãƒ¼ã‚¸ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0202
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0204

## å®Œäº†æ¡ä»¶

- [ ] æ—¥æ•°è¡¨ç¤ºãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] APã‚²ãƒ¼ã‚¸ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] å„é …ç›®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãæ›´æ–°ãŒå‹•ä½œã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. æ—¥æ•°è¡¨ç¤ºå®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *TASK-0202ã®ç¶šã*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/ui/header/HeaderUI.ts` (è¿½åŠ )

```typescript
// HeaderUIã‚¯ãƒ©ã‚¹ã«è¿½åŠ 

updateDay(current: number, max: number): void {
  const dayStr = formatDay(current, max);
  this.dayText.setText(dayStr);

  // æ®‹ã‚Šæ—¥æ•°ãŒå°‘ãªããªã£ãŸã‚‰è­¦å‘Šè‰²
  const remaining = max - current;
  if (remaining <= 5) {
    this.dayText.setColor('#ff4444');
  } else if (remaining <= 10) {
    this.dayText.setColor('#ffaa00');
  } else {
    this.dayText.setColor('#ffffff');
  }
}

// æ—¥é€ã‚Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
animateDayAdvance(): Promise<void> {
  return new Promise((resolve) => {
    // ä¸€æ™‚çš„ã«æ‹¡å¤§
    this.scene.tweens.add({
      targets: this.dayText,
      scaleX: 1.3,
      scaleY: 1.3,
      duration: 200,
      yoyo: true,
      ease: 'Power2',
      onComplete: () => resolve(),
    });
  });
}
```

### 2. ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºå®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚´ãƒ¼ãƒ«ãƒ‰å¢—æ¸›è¡¨ç¤º*

```typescript
// HeaderUIã‚¯ãƒ©ã‚¹ã«è¿½åŠ 

updateGold(gold: number): void {
  const goldStr = formatGold(gold);
  this.goldText.setText(goldStr);
}

animateGoldChange(amount: number): void {
  const isGain = amount > 0;
  const sign = isGain ? '+' : '';
  const color = isGain ? '#00ff00' : '#ff4444';

  const floatText = this.scene.add.text(
    HeaderLayout.GOLD_X + 30,
    HeaderLayout.HEIGHT / 2 - 20,
    `${sign}${amount.toLocaleString()}`,
    { ...TextStyles.body, fontSize: '14px', color }
  ).setOrigin(0.5);
  this.container.add(floatText);

  this.scene.tweens.add({
    targets: floatText,
    y: floatText.y - 30,
    alpha: 0,
    duration: 1000,
    ease: 'Power2',
    onComplete: () => floatText.destroy(),
  });

  // ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  this.scene.tweens.add({
    targets: this.goldText,
    scaleX: 1.2,
    scaleY: 1.2,
    duration: 100,
    yoyo: true,
    ease: 'Power2',
  });
}
```

### 3. APã‚²ãƒ¼ã‚¸å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *APãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º*

```typescript
// HeaderUIã‚¯ãƒ©ã‚¹ã®createAPGaugeã‚’æ›´æ–°

private createAPGauge(): void {
  const gaugeX = HeaderLayout.AP_X;
  const gaugeY = HeaderLayout.HEIGHT / 2;
  const gaugeWidth = HeaderLayout.AP_GAUGE_WIDTH;
  const gaugeHeight = HeaderLayout.AP_GAUGE_HEIGHT;

  // APãƒ©ãƒ™ãƒ«
  const apLabel = this.scene.add.text(gaugeX, gaugeY - 20, 'AP', {
    ...TextStyles.bodySmall,
    fontSize: '11px',
  });
  this.container.add(apLabel);

  // APã‚¢ã‚¤ã‚³ãƒ³
  const apIcon = this.scene.add.text(gaugeX - 25, gaugeY, 'âš¡', {
    fontSize: '20px',
  }).setOrigin(0.5);
  this.container.add(apIcon);

  // ã‚²ãƒ¼ã‚¸èƒŒæ™¯
  this.apGaugeBackground = this.scene.add.graphics();
  this.apGaugeBackground.fillStyle(Colors.backgroundDark, 1);
  this.apGaugeBackground.fillRoundedRect(gaugeX, gaugeY - gaugeHeight / 2, gaugeWidth, gaugeHeight, 4);
  this.apGaugeBackground.lineStyle(1, Colors.panelBorder);
  this.apGaugeBackground.strokeRoundedRect(gaugeX, gaugeY - gaugeHeight / 2, gaugeWidth, gaugeHeight, 4);
  this.container.add(this.apGaugeBackground);

  // ã‚²ãƒ¼ã‚¸å¡—ã‚Š
  this.apGaugeFill = this.scene.add.graphics();
  this.container.add(this.apGaugeFill);

  // æ•°å€¤ãƒ†ã‚­ã‚¹ãƒˆ
  this.apText = this.scene.add.text(gaugeX + gaugeWidth / 2, gaugeY, '0/0', {
    ...TextStyles.body,
    fontSize: '12px',
  }).setOrigin(0.5);
  this.container.add(this.apText);
}

updateAP(current: number, max: number): void {
  const gaugeX = HeaderLayout.AP_X;
  const gaugeY = HeaderLayout.HEIGHT / 2;
  const gaugeWidth = HeaderLayout.AP_GAUGE_WIDTH;
  const gaugeHeight = HeaderLayout.AP_GAUGE_HEIGHT;

  const ratio = max > 0 ? Math.min(current / max, 1) : 0;
  const fillWidth = gaugeWidth * ratio;

  // APã®æ®‹é‡ã«å¿œã˜ãŸè‰²
  let fillColor = 0x00aaff; // é€šå¸¸: é’
  if (ratio <= 0.25) {
    fillColor = 0xff4444; // å±é™º: èµ¤
  } else if (ratio <= 0.5) {
    fillColor = 0xffaa00; // æ³¨æ„: ã‚ªãƒ¬ãƒ³ã‚¸
  }

  // ã‚²ãƒ¼ã‚¸æ›´æ–°
  this.apGaugeFill.clear();
  this.apGaugeFill.fillStyle(fillColor, 1);
  if (fillWidth > 0) {
    this.apGaugeFill.fillRoundedRect(
      gaugeX + 2, gaugeY - gaugeHeight / 2 + 2,
      fillWidth - 4, gaugeHeight - 4, 2
    );
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
  this.apText.setText(`${current}/${max}`);

  // APãŒå°‘ãªã„å ´åˆã¯ç‚¹æ»…
  if (ratio <= 0.25 && current > 0) {
    this.startAPWarningBlink();
  } else {
    this.stopAPWarningBlink();
  }
}

private apBlinkTween?: Phaser.Tweens.Tween;

private startAPWarningBlink(): void {
  if (this.apBlinkTween) return;

  this.apBlinkTween = this.scene.tweens.add({
    targets: this.apText,
    alpha: 0.5,
    duration: 500,
    yoyo: true,
    repeat: -1,
    ease: 'Sine.easeInOut',
  });
}

private stopAPWarningBlink(): void {
  if (this.apBlinkTween) {
    this.apBlinkTween.stop();
    this.apBlinkTween = undefined;
    this.apText.setAlpha(1);
  }
}

animateAPChange(amount: number): void {
  const isGain = amount > 0;
  const sign = isGain ? '+' : '';
  const color = isGain ? '#00ff00' : '#ff4444';

  const floatText = this.scene.add.text(
    HeaderLayout.AP_X + HeaderLayout.AP_GAUGE_WIDTH / 2,
    HeaderLayout.HEIGHT / 2 - 30,
    `${sign}${amount} AP`,
    { ...TextStyles.body, fontSize: '14px', color }
  ).setOrigin(0.5);
  this.container.add(floatText);

  this.scene.tweens.add({
    targets: floatText,
    y: floatText.y - 30,
    alpha: 0,
    duration: 1000,
    ease: 'Power2',
    onComplete: () => floatText.destroy(),
  });
}
```

### 4. APä¸è¶³æ™‚ã®è¦–è¦šåŠ¹æœ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯*

```typescript
// HeaderUIã‚¯ãƒ©ã‚¹ã«è¿½åŠ 

showAPInsufficient(): void {
  // APã‚²ãƒ¼ã‚¸ã‚’èµ¤ãç‚¹æ»…
  this.scene.tweens.add({
    targets: this.apGaugeFill,
    alpha: 0.3,
    duration: 100,
    yoyo: true,
    repeat: 2,
    ease: 'Power2',
  });

  // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¯å‹•
  const originalX = this.apText.x;
  this.scene.tweens.add({
    targets: this.apText,
    x: originalX + 5,
    duration: 50,
    yoyo: true,
    repeat: 3,
    ease: 'Power2',
    onComplete: () => this.apText.setX(originalX),
  });
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ—¥æ•°è¡¨ç¤º ğŸ”µ

**Given**: HeaderUIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: updateDay(5, 30)ã‚’å‘¼ã¶
**Then**: "Day 5/30"ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æ®‹ã‚Šæ—¥æ•°è­¦å‘Š ğŸ”µ

**Given**: HeaderUIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: updateDay(26, 30)ã‚’å‘¼ã¶
**Then**: ãƒ†ã‚­ã‚¹ãƒˆãŒè­¦å‘Šè‰²ã«ãªã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ã‚´ãƒ¼ãƒ«ãƒ‰å¤‰åŒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**Given**: HeaderUIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
**When**: animateGoldChange(500)ã‚’å‘¼ã¶
**Then**: "+500"ãŒãƒ•ãƒ­ãƒ¼ãƒˆã—ã¦æ¶ˆãˆã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: APæ®‹é‡è‰² ğŸ”µ

**Given**: HeaderUIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹
**When**: updateAP(2, 10)ã‚’å‘¼ã¶
**Then**: ã‚²ãƒ¼ã‚¸ãŒèµ¤è‰²ã§è¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0203` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- APè­¦å‘Šã®è¦–èªæ€§
- ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¡æ•°å¯¾å¿œ
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é‡è¤‡é˜²æ­¢

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 4é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
