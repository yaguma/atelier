# TASK-0224: GatheringContaineré¸æŠæ“ä½œå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0224
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒ¡ã‚¤ãƒ³ç”»é¢å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

GatheringContainerã®ç´ æé¸æŠãƒ»ç¢ºå®šæ“ä½œã‚’å®Ÿè£…ã™ã‚‹ã€‚è¤‡æ•°é¸æŠã€é¸æŠä¸Šé™ã€APç¢ºèªã€ç¢ºå®šå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0223
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0225

## å®Œäº†æ¡ä»¶

- [ ] è¤‡æ•°ç´ æã‚’é¸æŠã§ãã‚‹
- [ ] é¸æŠä¸Šé™ã«é”ã™ã‚‹ã¨è¿½åŠ é¸æŠã§ããªã„
- [ ] APä¸è¶³æ™‚ã«ç¢ºå®šã§ããªã„
- [ ] ç¢ºå®šæ™‚ã«æ¡å–çµæœã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç”Ÿã•ã‚Œã‚‹
- [ ] EventBusã«ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. é¸æŠçŠ¶æ…‹ç®¡ç†ã®å¼·åŒ– ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *é¸æŠãƒ­ã‚¸ãƒƒã‚¯*

```typescript
// GatheringContainerã«è¿½åŠ 

private maxSelections: number = 3;
private selectionHistory: Material[] = [];

setMaxSelections(max: number): void {
  this.maxSelections = max;
  this.materialOptionView?.setMaxSelections(max);
}

private handleMaterialSelect(material: Material): void {
  // é¸æŠå±¥æ­´ã«è¿½åŠ 
  this.selectionHistory.push(material);

  // ã‚³ã‚¹ãƒˆæ›´æ–°
  this.updateCostDisplay();

  // é¸æŠä¸Šé™ãƒã‚§ãƒƒã‚¯
  if (this.selectionHistory.length >= this.maxSelections) {
    this.showSelectionLimitReached();
  }

  this.eventBus.emit('gathering:material:selected', {
    material,
    totalSelected: this.selectionHistory.length,
    maxSelections: this.maxSelections,
  });
}

private handleMaterialDeselect(material: Material): void {
  // é¸æŠå±¥æ­´ã‹ã‚‰å‰Šé™¤
  this.selectionHistory = this.selectionHistory.filter(m => m !== material);

  // ã‚³ã‚¹ãƒˆæ›´æ–°
  this.updateCostDisplay();

  // ä¸Šé™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
  this.hideSelectionLimitReached();

  this.eventBus.emit('gathering:material:deselected', {
    material,
    totalSelected: this.selectionHistory.length,
    maxSelections: this.maxSelections,
  });
}

private selectionLimitText?: Phaser.GameObjects.Text;

private showSelectionLimitReached(): void {
  if (this.selectionLimitText) return;

  this.selectionLimitText = this.scene.add.text(
    GatheringContainerLayout.MATERIAL_AREA.X,
    GatheringContainerLayout.MATERIAL_AREA.Y + GatheringContainerLayout.MATERIAL_AREA.HEIGHT + 10,
    `é¸æŠä¸Šé™ï¼ˆ${this.maxSelections}å€‹ï¼‰ã«é”ã—ã¾ã—ãŸ`,
    { ...TextStyles.body, fontSize: '12px', color: '#ffaa00' }
  );
  this.container.add(this.selectionLimitText);
}

private hideSelectionLimitReached(): void {
  if (this.selectionLimitText) {
    this.selectionLimitText.destroy();
    this.selectionLimitText = undefined;
  }
}
```

### 2. APä¸è¶³æ™‚ã®è­¦å‘Š ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚³ã‚¹ãƒˆç¢ºèª*

```typescript
// GatheringContainerã«è¿½åŠ 

private apWarningText?: Phaser.GameObjects.Text;

private updateCostDisplay(): void {
  const totalCost = this.getTotalAPCost();
  this.costView?.setRequiredAP(totalCost);

  // APä¸è¶³ãƒã‚§ãƒƒã‚¯
  if (totalCost > this.currentAP) {
    this.showAPWarning();
  } else {
    this.hideAPWarning();
  }

  this.updateConfirmButtonState();
}

private showAPWarning(): void {
  if (this.apWarningText) return;

  const shortage = this.getTotalAPCost() - this.currentAP;

  this.apWarningText = this.scene.add.text(
    GatheringContainerLayout.SIDE_PANEL.X,
    GatheringContainerLayout.SIDE_PANEL.Y + 140,
    `âš ï¸ AP ${shortage} ä¸è¶³`,
    { ...TextStyles.body, fontSize: '12px', color: '#ff4444' }
  );
  this.container.add(this.apWarningText);

  // ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  this.scene.tweens.add({
    targets: this.apWarningText,
    alpha: 0.5,
    duration: 500,
    yoyo: true,
    repeat: -1,
  });
}

private hideAPWarning(): void {
  if (this.apWarningText) {
    this.scene.tweens.killTweensOf(this.apWarningText);
    this.apWarningText.destroy();
    this.apWarningText = undefined;
  }
}
```

### 3. ç¢ºå®šå‡¦ç†ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¡å–ç¢ºå®š*

```typescript
// GatheringContainerã«è¿½åŠ 

async confirmGathering(): Promise<void> {
  if (!this.canConfirmGathering()) {
    this.showCannotConfirmFeedback();
    return;
  }
  if (!this.gatheringCard) return;

  // æ“ä½œã‚’ç„¡åŠ¹åŒ–
  this.setEnabled(false);

  // ç¢ºå®šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  await this.playGatheringAnimation();

  // çµæœç”Ÿæˆ
  const result: GatheringResult = {
    selectedMaterials: this.getSelectedMaterials(),
    totalAPCost: this.getTotalAPCost(),
    gatheringCard: this.gatheringCard,
  };

  // EventBusç™ºç«
  this.eventBus.emit('gathering:confirm', result);

  // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  await this.showGatheringSuccess(result);

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (this.onGatheringComplete) {
    this.onGatheringComplete(result);
  }
}

private showCannotConfirmFeedback(): void {
  // ãƒœã‚¿ãƒ³ã‚’æºã‚‰ã™
  if (this.confirmButton) {
    this.scene.tweens.add({
      targets: this.confirmButton,
      x: this.confirmButton.x + 5,
      duration: 50,
      yoyo: true,
      repeat: 3,
    });
  }
}

private async playGatheringAnimation(): Promise<void> {
  return new Promise((resolve) => {
    const selectedMaterials = this.getSelectedMaterials();
    const centerX = GatheringContainerLayout.WIDTH / 2;
    const centerY = GatheringContainerLayout.HEIGHT / 2;

    // ç´ æãŒä¸­å¤®ã«é›†ã¾ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const particles: Phaser.GameObjects.Text[] = [];

    selectedMaterials.forEach((material, index) => {
      const startX = 100 + (index % 3) * 100;
      const startY = 150 + Math.floor(index / 3) * 80;

      const emoji = this.getMaterialEmoji(material.category);
      const particle = this.scene.add.text(startX, startY, emoji, {
        fontSize: '24px',
      }).setOrigin(0.5);

      this.container.add(particle);
      particles.push(particle);

      // ä¸­å¤®ã«é›†ã¾ã‚‹
      this.scene.tweens.add({
        targets: particle,
        x: centerX,
        y: centerY,
        scale: 0.5,
        duration: 500,
        delay: index * 100,
        ease: 'Power2.easeIn',
      });
    });

    // é›†åˆå¾Œã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    this.scene.time.delayedCall(500 + selectedMaterials.length * 100, () => {
      // å…‰ã®ãƒãƒ¼ã‚¹ãƒˆ
      const burst = this.scene.add.graphics();
      burst.fillStyle(0x00ff00, 0.5);
      burst.fillCircle(centerX, centerY, 10);
      this.container.add(burst);

      this.scene.tweens.add({
        targets: burst,
        scale: 5,
        alpha: 0,
        duration: 300,
        ease: 'Power2',
        onComplete: () => {
          burst.destroy();
          particles.forEach(p => p.destroy());
          resolve();
        },
      });
    });
  });
}

private async showGatheringSuccess(result: GatheringResult): Promise<void> {
  return new Promise((resolve) => {
    const centerX = GatheringContainerLayout.WIDTH / 2;
    const centerY = GatheringContainerLayout.HEIGHT / 2;

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const successText = this.scene.add.text(
      centerX,
      centerY,
      `âœ¨ ${result.selectedMaterials.length}å€‹ã®ç´ æã‚’æ¡å–ï¼`,
      {
        ...TextStyles.heading,
        fontSize: '24px',
        color: '#00ff00',
      }
    ).setOrigin(0.5);
    this.container.add(successText);

    // APæ¶ˆè²»è¡¨ç¤º
    const apText = this.scene.add.text(
      centerX,
      centerY + 40,
      `-${result.totalAPCost} AP`,
      {
        ...TextStyles.body,
        fontSize: '16px',
        color: '#ffaa00',
      }
    ).setOrigin(0.5);
    this.container.add(apText);

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    this.scene.tweens.add({
      targets: [successText, apText],
      y: '-=30',
      alpha: 0,
      duration: 1500,
      ease: 'Power2',
      onComplete: () => {
        successText.destroy();
        apText.destroy();
        resolve();
      },
    });
  });
}

private getMaterialEmoji(category: string): string {
  switch (category) {
    case 'plant': return 'ğŸŒ¿';
    case 'mineral': return 'ğŸ’';
    case 'liquid': return 'ğŸ’§';
    case 'powder': return 'âœ¨';
    case 'monster': return 'ğŸ¦´';
    default: return 'ğŸ“¦';
  }
}

private setEnabled(enabled: boolean): void {
  this.materialOptionView?.setEnabled(enabled);
  if (this.confirmButton) {
    this.confirmButton.setAlpha(enabled ? 1 : 0.5);
  }
  if (this.skipButton) {
    this.skipButton.setAlpha(enabled ? 1 : 0.5);
  }
}
```

### 4. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£*

```typescript
// GatheringContainerã«è¿½åŠ 

private setupKeyboardControls(): void {
  // Enterã§ç¢ºå®š
  this.scene.input.keyboard?.on('keydown-ENTER', () => {
    if (this.container.visible) {
      this.confirmGathering();
    }
  });

  // Escapeã§ã‚¹ã‚­ãƒƒãƒ—
  this.scene.input.keyboard?.on('keydown-ESC', () => {
    if (this.container.visible) {
      this.handleSkip();
    }
  });

  // Rã§ãƒªã‚»ãƒƒãƒˆ
  this.scene.input.keyboard?.on('keydown-R', () => {
    if (this.container.visible) {
      this.resetSelection();
    }
  });
}

private removeKeyboardControls(): void {
  this.scene.input.keyboard?.off('keydown-ENTER');
  this.scene.input.keyboard?.off('keydown-ESC');
  this.scene.input.keyboard?.off('keydown-R');
}

// enter()ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€exit()ã§å‰Šé™¤
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: é¸æŠä¸Šé™ ğŸ”µ

**Given**: maxSelections=3ã§2ã¤é¸æŠæ¸ˆã¿
**When**: 3ã¤ç›®ã‚’é¸æŠ
**Then**: é¸æŠã§ãã€ä¸Šé™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: APä¸è¶³ ğŸ”µ

**Given**: currentAP=2, é¸æŠä¸­ã®ã‚³ã‚¹ãƒˆ=5
**When**: ç¢ºå®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
**Then**: ç¢ºå®šã•ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ç¢ºå®šå‡¦ç† ğŸ”µ

**Given**: ç´ æãŒé¸æŠã•ã‚ŒAPååˆ†
**When**: confirmGathering()ã‚’å‘¼ã¶
**Then**: gathering:confirmã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—çµæœãŒæ¸¡ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0224` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- éåŒæœŸå‡¦ç†ä¸­ã®æ“ä½œåˆ¶é™
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®çŠ¶æ…‹ç®¡ç†
- EventBusã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 4é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (75%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (25%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
