# TASK-0248: GameClearSceneå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0248
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ã‚µãƒ–ã‚·ãƒ¼ãƒ³ãƒ»Applicationå±¤ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *è¨­è¨ˆæ›¸ã«è¨˜è¼‰*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [overview.md](./overview.md)
- **UIè¨­è¨ˆ**: [ui-design/overview.md](../../design/atelier-guild-rank-phaser/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã‚·ãƒ¼ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã€‚é”æˆçµ±è¨ˆã®è¡¨ç¤ºã¨ã‚¯ãƒªã‚¢æ¼”å‡ºã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0170, TASK-0173
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0249

## å®Œäº†æ¡ä»¶

- [ ] ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] é”æˆçµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¯ãƒªã‚¢æ¼”å‡ºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. GameClearSceneãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *UIè¨­è¨ˆæ›¸*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/phaser/scenes/GameClearScene.ts`

```typescript
import Phaser from 'phaser';
import { BaseGameScene, SceneInitData } from './BaseGameScene';
import { SceneKeys } from '../config/SceneKeys';
import { UIFactory } from '../ui/UIFactory';
import { Colors } from '../config/ColorPalette';
import { TextStyles } from '../config/TextStyles';

export interface GameClearSceneData extends SceneInitData {
  clearDay: number;
  finalRank: string;
  totalQuests: number;
  totalAlchemy: number;
  totalGold: number;
  rareItems: string[];
  playTime: number; // ç§’
}

export class GameClearScene extends BaseGameScene {
  private sceneData!: GameClearSceneData;
  private mainContainer!: Phaser.GameObjects.Container;

  constructor() {
    super(SceneKeys.GAME_CLEAR);
  }

  protected onInit(data?: GameClearSceneData): void {
    if (data) {
      this.sceneData = data;
    }
  }

  protected onPreload(): void {
    // GameClearSceneå›ºæœ‰ã‚¢ã‚»ãƒƒãƒˆ
  }

  protected onCreate(data?: GameClearSceneData): void {
    this.createBackground();
    this.createMainContent();
    this.playEntranceAnimation();
  }

  private createBackground(): void {
    // è±ªè¯ãªèƒŒæ™¯
    const bg = this.add.graphics();

    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
    for (let i = 0; i < 768; i++) {
      const ratio = i / 768;
      const r = Math.floor(10 + ratio * 20);
      const g = Math.floor(10 + ratio * 30);
      const b = Math.floor(30 + ratio * 50);
      const color = (r << 16) + (g << 8) + b;

      bg.fillStyle(color, 1);
      bg.fillRect(0, i, 1024, 1);
    }

    // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    this.createStarField();
  }

  private createStarField(): void {
    for (let i = 0; i < 100; i++) {
      const star = this.add.graphics();
      const size = Phaser.Math.Between(1, 3);
      star.fillStyle(0xffffff, Phaser.Math.FloatBetween(0.3, 1));
      star.fillCircle(0, 0, size);
      star.x = Phaser.Math.Between(0, 1024);
      star.y = Phaser.Math.Between(0, 768);

      // ç¬ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      this.tweens.add({
        targets: star,
        alpha: Phaser.Math.FloatBetween(0.2, 0.5),
        duration: Phaser.Math.Between(1000, 3000),
        yoyo: true,
        repeat: -1,
      });
    }
  }

  private createMainContent(): void {
    this.mainContainer = this.add.container(512, 384);
    this.mainContainer.setAlpha(0);

    // ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆ
    const clearText = this.add.text(0, -220, 'CONGRATULATIONS!', {
      fontSize: '48px',
      fontStyle: 'bold',
      color: '#ffcc00',
    }).setOrigin(0.5);
    this.mainContainer.add(clearText);

    // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«
    const subText = this.add.text(0, -160, 'Sç´šéŒ¬é‡‘è¡“å¸«ã«æ˜‡æ ¼ã—ã¾ã—ãŸï¼', {
      ...TextStyles.heading,
      fontSize: '24px',
      color: '#ffffff',
    }).setOrigin(0.5);
    this.mainContainer.add(subText);

    // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
    const trophy = this.createTrophy();
    trophy.setY(-60);
    this.mainContainer.add(trophy);

    // çµ±è¨ˆãƒ‘ãƒãƒ«
    const statsPanel = this.createStatsPanel();
    statsPanel.setY(80);
    this.mainContainer.add(statsPanel);

    // ãƒœã‚¿ãƒ³
    const titleButton = UIFactory.createButton(this, {
      x: 0,
      y: 250,
      width: 200,
      height: 50,
      text: 'ã‚¿ã‚¤ãƒˆãƒ«ã¸',
      onClick: () => this.handleTitle(),
    });
    this.mainContainer.add(titleButton);
  }

  private createTrophy(): Phaser.GameObjects.Container {
    const container = this.add.container(0, 0);

    // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼å…‰å½©
    const glow = this.add.graphics();
    glow.fillStyle(0xffcc00, 0.3);
    glow.fillCircle(0, 0, 60);
    container.add(glow);

    // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    this.tweens.add({
      targets: glow,
      scaleX: 1.2,
      scaleY: 1.2,
      alpha: 0.1,
      duration: 1500,
      yoyo: true,
      repeat: -1,
    });

    // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
    const trophy = this.add.text(0, 0, 'ğŸ†', {
      fontSize: '64px',
    }).setOrigin(0.5);
    container.add(trophy);

    return container;
  }

  private createStatsPanel(): Phaser.GameObjects.Container {
    const panel = this.add.container(0, 0);

    // ãƒ‘ãƒãƒ«èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(0x000033, 0.8);
    bg.fillRoundedRect(-250, -70, 500, 140, 8);
    bg.lineStyle(2, 0xffcc00, 0.5);
    bg.strokeRoundedRect(-250, -70, 500, 140, 8);
    panel.add(bg);

    // çµ±è¨ˆæƒ…å ±
    const stats = [
      { label: 'ã‚¯ãƒªã‚¢æ—¥æ•°', value: `${this.sceneData.clearDay} æ—¥ç›®`, icon: 'ğŸ“…' },
      { label: 'å®Œäº†ä¾é ¼', value: `${this.sceneData.totalQuests} ä»¶`, icon: 'ğŸ“‹' },
      { label: 'èª¿åˆå›æ•°', value: `${this.sceneData.totalAlchemy} å›`, icon: 'âš—ï¸' },
      { label: 'ç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰', value: `${this.sceneData.totalGold} G`, icon: 'ğŸ’°' },
    ];

    const leftStats = stats.slice(0, 2);
    const rightStats = stats.slice(2);

    leftStats.forEach((stat, index) => {
      const y = -40 + index * 50;
      const item = this.createStatItem(stat, -120, y);
      panel.add(item);
    });

    rightStats.forEach((stat, index) => {
      const y = -40 + index * 50;
      const item = this.createStatItem(stat, 120, y);
      panel.add(item);
    });

    return panel;
  }

  private createStatItem(
    stat: { label: string; value: string; icon: string },
    x: number,
    y: number
  ): Phaser.GameObjects.Container {
    const container = this.add.container(x, y);

    const icon = this.add.text(-80, 0, stat.icon, {
      fontSize: '20px',
    }).setOrigin(0.5);
    container.add(icon);

    const label = this.add.text(-50, -10, stat.label, {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#888888',
    });
    container.add(label);

    const value = this.add.text(-50, 10, stat.value, {
      ...TextStyles.body,
      fontSize: '16px',
      color: '#ffffff',
    });
    container.add(value);

    return container;
  }

  private async playEntranceAnimation(): Promise<void> {
    // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    this.playConfettiEffect();

    // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
    await this.delay(500);

    this.tweens.add({
      targets: this.mainContainer,
      alpha: 1,
      y: this.mainContainer.y - 30,
      duration: 800,
      ease: 'Power2.easeOut',
    });
  }

  private playConfettiEffect(): void {
    const colors = [0xffcc00, 0xff6600, 0x00ff00, 0x00ffff, 0xff00ff, 0xffffff];

    for (let i = 0; i < 100; i++) {
      const confetti = this.add.graphics();
      const color = colors[i % colors.length];
      confetti.fillStyle(color, 1);

      const shape = Phaser.Math.Between(0, 1);
      if (shape === 0) {
        confetti.fillRect(-4, -4, 8, 8);
      } else {
        confetti.fillCircle(0, 0, 4);
      }

      confetti.x = Phaser.Math.Between(0, 1024);
      confetti.y = -20;
      confetti.setDepth(10);

      this.tweens.add({
        targets: confetti,
        y: 800,
        x: confetti.x + Phaser.Math.Between(-200, 200),
        angle: Phaser.Math.Between(0, 720),
        alpha: { from: 1, to: 0 },
        duration: Phaser.Math.Between(3000, 5000),
        delay: Phaser.Math.Between(0, 2000),
        ease: 'Power1.easeIn',
        onComplete: () => confetti.destroy(),
      });
    }
  }

  private handleTitle(): void {
    this.sceneManager.switchTo(SceneKeys.TITLE);
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => this.time.delayedCall(ms, resolve));
  }
}
```

### 2. ãƒ—ãƒ¬ã‚¤æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯*

```typescript
// GameClearSceneã«è¿½åŠ 

private formatPlayTime(seconds: number): string {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;

  if (hours > 0) {
    return `${hours}æ™‚é–“${minutes}åˆ†`;
  }
  return `${minutes}åˆ†${secs}ç§’`;
}

// çµ±è¨ˆãƒ‘ãƒãƒ«ã«ãƒ—ãƒ¬ã‚¤æ™‚é–“ã‚’è¿½åŠ 
private addPlayTimeToStats(): void {
  const playTimeText = this.add.text(0, 180, `ãƒ—ãƒ¬ã‚¤æ™‚é–“: ${this.formatPlayTime(this.sceneData.playTime)}`, {
    ...TextStyles.body,
    fontSize: '14px',
    color: '#aaaaaa',
  }).setOrigin(0.5);
  this.mainContainer.add(playTimeText);
}
```

### 3. ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³*

```typescript
// GameClearSceneã«è¿½åŠ 

private createRareItemsDisplay(): Phaser.GameObjects.Container {
  const container = this.add.container(0, 0);

  if (!this.sceneData.rareItems || this.sceneData.rareItems.length === 0) {
    return container;
  }

  // ã‚¿ã‚¤ãƒˆãƒ«
  const title = this.add.text(0, 0, 'ç²å¾—ã—ãŸãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ', {
    ...TextStyles.heading,
    fontSize: '16px',
    color: '#ffcc00',
  }).setOrigin(0.5);
  container.add(title);

  // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆï¼ˆæœ€å¤§5ã¤è¡¨ç¤ºï¼‰
  const displayItems = this.sceneData.rareItems.slice(0, 5);
  const startX = -((displayItems.length - 1) * 60) / 2;

  displayItems.forEach((item, index) => {
    const x = startX + index * 60;
    const itemContainer = this.add.container(x, 40);

    // ã‚¢ã‚¤ãƒ†ãƒ èƒŒæ™¯
    const bg = this.add.graphics();
    bg.fillStyle(0xffaa00, 0.3);
    bg.fillRoundedRect(-25, -25, 50, 50, 8);
    itemContainer.add(bg);

    // ã‚¢ã‚¤ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå°†æ¥çš„ã«ã¯å®Ÿéš›ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
    const icon = this.add.text(0, 0, 'âœ¨', {
      fontSize: '24px',
    }).setOrigin(0.5);
    itemContainer.add(icon);

    container.add(itemContainer);
  });

  // è¿½åŠ ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚‹å ´åˆ
  if (this.sceneData.rareItems.length > 5) {
    const moreText = this.add.text(0, 80, `+${this.sceneData.rareItems.length - 5} more`, {
      ...TextStyles.body,
      fontSize: '12px',
      color: '#888888',
    }).setOrigin(0.5);
    container.add(moreText);
  }

  return container;
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ã‚·ãƒ¼ãƒ³åˆæœŸåŒ– ğŸ”µ

**Given**: GameClearSceneã‚’èµ·å‹•
**When**: createãŒå®Œäº†
**Then**: ã‚¯ãƒªã‚¢ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: çµ±è¨ˆè¡¨ç¤º ğŸ”µ

**Given**: ã‚¯ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
**When**: ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
**Then**: ã‚¯ãƒªã‚¢æ—¥æ•°ã€ä¾é ¼æ•°ã€èª¿åˆæ•°ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒ—ãƒ¬ã‚¤æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ğŸ”µ

**Given**: ãƒ—ãƒ¬ã‚¤æ™‚é–“ãŒ3661ç§’ï¼ˆ1æ™‚é–“1åˆ†1ç§’ï¼‰
**When**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ã‚’å‘¼ã¶
**Then**: "1æ™‚é–“1åˆ†"ã¨è¡¨ç¤ºã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

1. `/tsumiki:tdd-requirements TASK-0248` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- æ¼”å‡ºã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§
- å°†æ¥çš„ãªãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¸ã®æ‹¡å¼µæ€§

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

- **ç·é …ç›®æ•°**: 3é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 3é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
