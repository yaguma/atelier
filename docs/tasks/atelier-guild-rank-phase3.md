# Phase 3: アプリケーション層

**フェーズ期間**: 約16日（128時間）
**タスク数**: 16タスク（TASK-0102 〜 TASK-0117）
**目標**: ゲームフロー制御とユースケースの実装
**成果物**: ゲームフローマネージャー、状態管理、各種ユースケース

---

## フェーズ概要

アプリケーション層（ユースケース層）を実装する。
ドメイン層のビジネスロジックを組み合わせて、ゲームのユースケースを実現する。
ゲームフロー制御、状態管理、各種ユースケースを実装。

---

## 週次計画

### Week 1（TASK-0102〜0106）
- **目標**: コアマネージャーとゲーム開始ユースケースの実装
- **成果物**:
  - ゲームフローマネージャー、ステートマネージャー
  - ニューゲーム、ゲーム再開ユースケース
  - 依頼受注ユースケース

### Week 2（TASK-0107〜0112）
- **目標**: メインゲームプレイユースケースの実装
- **成果物**:
  - ドラフト採取、調合、納品ユースケース
  - フェーズ遷移、日数経過ユースケース
  - ショップ購入ユースケース

### Week 3（TASK-0113〜0117）
- **目標**: ゲーム終了条件とオートセーブの実装
- **成果物**:
  - 昇格試験開始・判定ユースケース
  - ゲームクリア・ゲームオーバー判定
  - オートセーブユースケース

---

## タスク詳細

### TASK-0102: ゲームフローマネージャー 🔵

- [x] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0099, TASK-0101
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('GameFlowManager', () => {
  it('ゲームを初期化できる');
  it('フェーズを順番に進行できる');
  it('フェーズ遷移時にイベントを発行する');
  it('日数経過を管理できる');
  it('ゲーム終了条件を監視できる');
  it('昇格試験モードに切り替えできる');
});
```

#### フェーズ順序

```
QUEST_ACCEPT → GATHERING → ALCHEMY → DELIVERY → (日数経過) → QUEST_ACCEPT ...
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] フェーズ遷移が正しく動作する
- [ ] イベント発行が正しく行われる

#### 完了条件

- GameFlowManagerが実装されている
- フェーズ遷移（QUEST_ACCEPT→GATHERING→ALCHEMY→DELIVERY）が正しく動作する
- フェーズ遷移時のイベント発行が正しく動作する
- 昇格試験モード切替が正しく動作する
- 全テストケースが通過する

---

### TASK-0103: ステートマネージャー 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0099
**設計参照**: [architecture.md](../design/atelier-guild-rank/architecture.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('StateManager', () => {
  it('ゲーム状態を取得できる');
  it('ゲーム状態を更新できる');
  it('状態変更を購読できる');
  it('状態変更時に通知される');
  it('状態のスナップショットを取得できる');
  it('状態をリセットできる');
});
```

#### 実装インターフェース

```typescript
interface IStateManager {
  getState(): GameState;
  getPlayerState(): PlayerState;
  getDeckState(): DeckState;
  getInventoryState(): InventoryState;
  getQuestState(): QuestState;

  updateState(updater: (state: State) => State): void;
  subscribe(listener: (state: State) => void): Unsubscribe;
  reset(): void;
}
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 状態管理が正しく動作する
- [ ] Observerパターンが実装されている

#### 完了条件

- StateManagerが実装されている
- 各種状態（Game/Player/Deck/Inventory/Quest）の取得・更新が正しく動作する
- 状態変更の購読・通知（Observer）パターンが正しく動作する
- 全テストケースが通過する

---

### TASK-0104: ニューゲームユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0102, TASK-0083
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('NewGameUseCase', () => {
  it('新規ゲームを開始できる');
  it('初期デッキが設定される');
  it('初期ランク（G）が設定される');
  it('初期ゴールドが設定される');
  it('初期日数が設定される');
  it('セーブデータが作成される');
  it('既存セーブデータがある場合は上書き確認');
});
```

#### 初期状態（設計書より）

- ランク: G
- ゴールド: 100G
- 初期デッキ: 基本採取地カード×3、基本レシピカード×2
- 行動ポイント: 3

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 初期状態が設計書通りに設定される

#### 完了条件

- NewGameUseCaseが実装されている
- 初期状態（G ランク、100G、初期デッキ、行動ポイント3）が正しく設定される
- セーブデータの作成と上書き確認が正しく動作する
- 全テストケースが通過する

---

### TASK-0105: ゲーム再開ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0102, TASK-0083
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('ContinueGameUseCase', () => {
  it('セーブデータからゲームを再開できる');
  it('セーブデータがない場合はエラー');
  it('状態が正しく復元される');
  it('フェーズが正しく復元される');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] セーブデータからの復元が正しく動作する

#### 完了条件

- ContinueGameUseCaseが実装されている
- セーブデータからの状態復元が正しく動作する
- セーブデータ不在時のエラーハンドリングが正しく動作する
- 全テストケースが通過する

---

### TASK-0106: 依頼受注ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0087, TASK-0103
**設計参照**: [game-mechanics.md](../design/atelier-guild-rank/game-mechanics.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('AcceptQuestUseCase', () => {
  it('依頼を受注できる');
  it('同時受注上限（3件）を超えると受注できない');
  it('ランク不足で受注できない');
  it('受注済み依頼は再受注できない');
  it('受注後に依頼リストから除外される');
  it('行動ポイントを消費しない');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 依頼受注のルールが正しく実装されている

#### 完了条件

- AcceptQuestUseCaseが実装されている
- 同時受注上限（3件）チェックが正しく動作する
- ランク要件チェックと重複受注防止が正しく動作する
- 全テストケースが通過する

---

### TASK-0107: ドラフト採取ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0092, TASK-0103
**設計参照**: [game-mechanics.md](../design/atelier-guild-rank/game-mechanics.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('DraftGatheringUseCase', () => {
  it('ドラフトを開始できる');
  it('カードを選択できる');
  it('選択したカードから素材を獲得できる');
  it('ラウンドが進行する');
  it('全ラウンド終了後にフェーズ終了');
  it('行動ポイントを消費する');
  it('行動ポイント不足でドラフトできない');
});
```

#### ドラフトフロー

1. ドラフト開始（採取地カード3枚表示）
2. 1枚選択 → 素材獲得
3. 残り2枚 + 新規1枚で次ラウンド
4. 3ラウンド繰り返し
5. フェーズ終了

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] ドラフト採取フローが正しく動作する

#### 完了条件

- DraftGatheringUseCaseが実装されている
- ドラフトフロー（3枚から1枚選択×3ラウンド）が正しく動作する
- 行動ポイント消費と不足チェックが正しく動作する
- 全テストケースが通過する

---

### TASK-0108: 調合実行ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0093, TASK-0094, TASK-0103
**設計参照**: [game-mechanics.md](../design/atelier-guild-rank/game-mechanics.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('CraftItemUseCase', () => {
  it('レシピカードを選択して調合できる');
  it('必要素材が消費される');
  it('完成アイテムがインベントリに追加される');
  it('品質が計算される');
  it('強化カードを適用できる');
  it('素材不足で調合できない');
  it('行動ポイントを消費する');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 調合処理が正しく動作する

#### 完了条件

- CraftItemUseCaseが実装されている
- レシピ選択・素材消費・アイテム生成が正しく動作する
- 品質計算と強化カード適用が正しく動作する
- 行動ポイント消費が正しく動作する
- 全テストケースが通過する

---

### TASK-0109: 納品ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0095, TASK-0103
**設計参照**: [game-mechanics.md](../design/atelier-guild-rank/game-mechanics.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('DeliverItemUseCase', () => {
  it('依頼にアイテムを納品できる');
  it('納品成功で報酬を獲得');
  it('納品成功で貢献度を獲得');
  it('品質ボーナスが適用される');
  it('納品後に依頼が完了状態になる');
  it('必要アイテム不足で納品できない');
  it('行動ポイントを消費しない');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 納品処理と報酬計算が正しく動作する

#### 完了条件

- DeliverItemUseCaseが実装されている
- アイテム納品と依頼完了処理が正しく動作する
- 報酬（ゴールド・貢献度）と品質ボーナス計算が正しく動作する
- 全テストケースが通過する

---

### TASK-0110: フェーズ遷移ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0102
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('PhaseTransitionUseCase', () => {
  it('次のフェーズに遷移できる');
  it('DELIVERYから次の日のQUEST_ACCEPTに遷移');
  it('フェーズ遷移時に行動ポイントがリセットされる');
  it('フェーズ遷移イベントが発行される');
  it('昇格試験中は試験用フェーズルールが適用される');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] フェーズ遷移が正しく動作する

#### 完了条件

- PhaseTransitionUseCaseが実装されている
- フェーズ遷移と日数経過処理が正しく動作する
- 行動ポイントリセットとイベント発行が正しく動作する
- 昇格試験中の特殊ルール適用が正しく動作する
- 全テストケースが通過する

---

### TASK-0111: 日数経過ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0096, TASK-0103
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('AdvanceDayUseCase', () => {
  it('日数が1日進む');
  it('ランク維持日数が減少する');
  it('依頼の期限が減少する');
  it('期限切れ依頼にペナルティ');
  it('ランク維持日数0でゲームオーバー');
  it('昇格試験中は試験日数が減少');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 日数経過処理が正しく動作する

#### 完了条件

- AdvanceDayUseCaseが実装されている
- 日数進行とランク維持日数減少が正しく動作する
- 期限切れ依頼ペナルティ処理が正しく動作する
- ゲームオーバー判定が正しく動作する
- 全テストケースが通過する

---

### TASK-0112: ショップ購入ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0098, TASK-0103
**設計参照**: [ui-design/screens/shop.md](../design/atelier-guild-rank/ui-design/screens/shop.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('PurchaseItemUseCase', () => {
  it('商品を購入できる');
  it('ゴールドが減少する');
  it('カード購入でデッキに追加');
  it('素材購入でインベントリに追加');
  it('アーティファクト購入で所持アーティファクトに追加');
  it('ゴールド不足で購入できない');
  it('ランク不足で購入できない');
  it('デッキ上限で購入できない');
  it('行動ポイントを1消費する');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] ショップ購入処理が正しく動作する

#### 完了条件

- PurchaseItemUseCaseが実装されている
- 購入処理（ゴールド消費・アイテム追加）が正しく動作する
- ゴールド・ランク・デッキ上限チェックが正しく動作する
- 行動ポイント消費が正しく動作する
- 全テストケースが通過する

---

### TASK-0113: 昇格試験開始ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0097, TASK-0103
**設計参照**: [ui-design/screens/rank-up.md](../design/atelier-guild-rank/ui-design/screens/rank-up.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('StartPromotionTestUseCase', () => {
  it('昇格試験を開始できる');
  it('試験課題が設定される');
  it('試験制限日数が設定される');
  it('通常依頼が受注不可になる');
  it('ゲーム状態が試験モードになる');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 昇格試験開始処理が正しく動作する

#### 完了条件

- StartPromotionTestUseCaseが実装されている
- 試験課題・制限日数の設定が正しく動作する
- ゲーム状態の試験モード切替が正しく動作する
- 全テストケースが通過する

---

### TASK-0114: 昇格試験判定ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0097, TASK-0103
**設計参照**: [ui-design/screens/rank-up.md](../design/atelier-guild-rank/ui-design/screens/rank-up.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('JudgePromotionTestUseCase', () => {
  it('課題達成で試験合格');
  it('合格時にランクアップ');
  it('合格時にボーナスゴールド獲得');
  it('合格時にアーティファクト選択肢を表示');
  it('制限日数超過で試験失敗');
  it('失敗時はゲームオーバー');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] 昇格試験判定が正しく動作する

#### 完了条件

- JudgePromotionTestUseCaseが実装されている
- 課題達成判定とランクアップ処理が正しく動作する
- 合格時報酬（ゴールド・アーティファクト選択）が正しく動作する
- 失敗時ゲームオーバー処理が正しく動作する
- 全テストケースが通過する

---

### TASK-0115: ゲームクリア判定ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0096, TASK-0103
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('CheckGameClearUseCase', () => {
  it('Sランク到達でゲームクリア');
  it('ゲームクリアイベントが発行される');
  it('プレイ統計が記録される');
  it('ゲーム進行状態がGAME_CLEARになる');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] ゲームクリア判定が正しく動作する

#### 完了条件

- CheckGameClearUseCaseが実装されている
- Sランク到達でのゲームクリア判定が正しく動作する
- ゲームクリアイベント発行と統計記録が正しく動作する
- 全テストケースが通過する

---

### TASK-0116: ゲームオーバー判定ユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0096, TASK-0103
**設計参照**: [core-systems.md](../design/atelier-guild-rank/core-systems.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('CheckGameOverUseCase', () => {
  it('ランク維持日数0でゲームオーバー');
  it('昇格試験失敗でゲームオーバー');
  it('ゲームオーバーイベントが発行される');
  it('ゲームオーバー理由が記録される');
  it('プレイ統計が記録される');
  it('ゲーム進行状態がGAME_OVERになる');
});
```

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] ゲームオーバー判定が正しく動作する

#### 完了条件

- CheckGameOverUseCaseが実装されている
- ランク維持日数0と昇格試験失敗でのゲームオーバー判定が正しく動作する
- ゲームオーバーイベント発行と理由記録が正しく動作する
- 全テストケースが通過する

---

### TASK-0117: オートセーブユースケース 🔵

- [ ] タスク完了

**種別**: TDD
**推定時間**: 8時間
**依存**: TASK-0083, TASK-0103
**設計参照**: [data-schema.md](../design/atelier-guild-rank/data-schema.md)
**要件名**: アトリエギルドランク HTML版
**GitHub Issue**: #TBD

#### テストケース

```typescript
describe('AutoSaveUseCase', () => {
  it('フェーズ終了時にオートセーブ');
  it('日数経過時にオートセーブ');
  it('ショップ購入後にオートセーブ');
  it('セーブデータにタイムスタンプが記録される');
  it('セーブ失敗時にエラーハンドリング');
});
```

#### オートセーブタイミング

- フェーズ遷移時
- 日数経過時
- ショップ購入後
- 昇格試験開始/終了時

#### 受け入れ基準

- [ ] 全テストケースが通過する
- [ ] オートセーブが適切なタイミングで実行される

#### 完了条件

- AutoSaveUseCaseが実装されている
- フェーズ遷移・日数経過・ショップ購入後のオートセーブが正しく動作する
- タイムスタンプ記録とエラーハンドリングが正しく動作する
- 全テストケースが通過する

---

## フェーズ完了基準

- [ ] 全16タスクが完了している
- [ ] 全テストが通過する
- [ ] カバレッジが80%以上
- [ ] ユースケースが設計書に準拠している
- [ ] ドキュメントが更新されている

---

## 次フェーズへの移行条件

1. 全タスクのチェックボックスが完了
2. CIでテストが通過
3. Phase 4の依存タスク（TASK-0102〜TASK-0117）が全て完了

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-02 | 1.0.0 | 初版作成 |
