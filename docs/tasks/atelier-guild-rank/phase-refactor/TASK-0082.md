# TASK-0082: features/quest/components作成

**タスクID**: TASK-0082
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 6 - features/quest機能
**信頼性レベル**: 🔵 *既存実装に基づく*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

依頼関連UIコンポーネントを features/quest/components に移動する。QuestDetailModal, DeliveryQuestPanel 等を整理し、依頼受注・納品フェーズUI関連を再利用可能なコンポーネントとして構成する。

## 依存タスク

- **前提タスク**: [TASK-0067](../phase-refactor/TASK-0067.md), [TASK-0081](TASK-0081.md)
- **後続タスク**: [TASK-0083](TASK-0083.md)

## 完了条件

- [ ] QuestDetailModal コンポーネントが移動されている
- [ ] DeliveryQuestPanel コンポーネントが移動されている
- [ ] 依頼受注・納品フェーズUI関連が整理されている
- [ ] 既存テストが全て通過する
- [ ] 新規コンポーネントのテストカバレッジが80%以上

---

## 実装詳細

### 1. QuestDetailModal コンポーネント移動 🔵

**信頼性**: 🔵 *既存実装に基づく*

依頼詳細を表示するモーダルコンポーネントを移動する。

**実装ファイル**: `src/features/quest/components/QuestDetailModal.ts`

```typescript
import type { Quest, Client } from '../types';
import { UIBackgroundBuilder, applyHoverAnimation } from '@presentation/ui/utils';
import { Colors, AnimationPresets } from '@presentation/theme';

export interface QuestDetailModalConfig {
  onAccept?: (quest: Quest) => void;
  onClose?: () => void;
}

export class QuestDetailModal {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private quest: Quest | null = null;
  private client: Client | null = null;
  private config: QuestDetailModalConfig;
  private visible: boolean = false;

  constructor(scene: Phaser.Scene, config: QuestDetailModalConfig) {
    this.scene = scene;
    this.config = config;
    this.create();
  }

  private create(): void {
    this.container = this.scene.add.container(0, 0);
    this.container.setVisible(false);
    this.createBackground();
    this.createContent();
    this.createButtons();
  }

  private createBackground(): void {
    const bg = new UIBackgroundBuilder(this.scene)
      .setSize(500, 400)
      .setFill(Colors.background.modal)
      .setBorder(Colors.border.accent)
      .setRadius(16)
      .build();
    this.container.add(bg);
  }

  private createContent(): void {
    // 依頼詳細表示（タイトル、説明、条件、報酬）
  }

  private createButtons(): void {
    // 受注・閉じるボタン
  }

  show(quest: Quest, client: Client): void {
    this.quest = quest;
    this.client = client;
    this.updateContent();
    this.container.setVisible(true);
    this.visible = true;
    this.playShowAnimation();
  }

  hide(): void {
    this.playHideAnimation(() => {
      this.container.setVisible(false);
      this.visible = false;
    });
  }

  private playShowAnimation(): void {
    // フェードイン・スケールアニメーション
  }

  private playHideAnimation(onComplete: () => void): void {
    // フェードアウトアニメーション
  }

  destroy(): void {
    this.container.destroy();
  }
}
```

### 2. DeliveryQuestPanel コンポーネント移動 🔵

**信頼性**: 🔵 *既存実装に基づく*

納品対象の依頼を表示するパネルコンポーネントを移動する。

**実装ファイル**: `src/features/quest/components/DeliveryQuestPanel.ts`

```typescript
import type { Quest } from '../types';
import type { CraftedItem } from '@features/alchemy/types';
import { validateQuest } from '../services';
import { UIBackgroundBuilder } from '@presentation/ui/utils';
import { Colors } from '@presentation/theme';

export interface DeliveryQuestPanelConfig {
  x: number;
  y: number;
  width: number;
  height: number;
  onDeliver?: (quest: Quest, items: CraftedItem[]) => void;
}

export class DeliveryQuestPanel {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private quest: Quest | null = null;
  private selectedItems: CraftedItem[] = [];
  private config: DeliveryQuestPanelConfig;

  constructor(scene: Phaser.Scene, config: DeliveryQuestPanelConfig) {
    this.scene = scene;
    this.config = config;
    this.create();
  }

  private create(): void {
    this.container = this.scene.add.container(this.config.x, this.config.y);
    this.createBackground();
    this.createQuestInfo();
    this.createItemSlots();
    this.createDeliverButton();
  }

  private createBackground(): void {
    const bg = new UIBackgroundBuilder(this.scene)
      .setSize(this.config.width, this.config.height)
      .setFill(Colors.background.panel)
      .setBorder(Colors.border.primary)
      .build();
    this.container.add(bg);
  }

  setQuest(quest: Quest): void {
    this.quest = quest;
    this.selectedItems = [];
    this.updateDisplay();
  }

  addItem(item: CraftedItem): void {
    this.selectedItems.push(item);
    this.updateValidation();
    this.updateDisplay();
  }

  removeItem(index: number): void {
    this.selectedItems.splice(index, 1);
    this.updateValidation();
    this.updateDisplay();
  }

  private updateValidation(): void {
    if (!this.quest) return;
    const result = validateQuest(this.quest, this.selectedItems);
    this.updateDeliverButton(result.valid);
  }

  destroy(): void {
    this.container.destroy();
  }
}
```

### 3. QuestCardUI コンポーネント作成 🔵

**信頼性**: 🔵 *既存実装に基づく*

依頼一覧で表示するカードコンポーネントを作成する。

**実装ファイル**: `src/features/quest/components/QuestCardUI.ts`

```typescript
import type { Quest, Client } from '../types';
import { UIBackgroundBuilder, applyHoverAnimation } from '@presentation/ui/utils';
import { Colors, AnimationPresets } from '@presentation/theme';

export interface QuestCardUIConfig {
  x: number;
  y: number;
  width: number;
  height: number;
  onClick?: () => void;
}

export class QuestCardUI {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private quest: Quest;
  private client: Client;

  constructor(
    scene: Phaser.Scene,
    quest: Quest,
    client: Client,
    config: QuestCardUIConfig
  ) {
    this.scene = scene;
    this.quest = quest;
    this.client = client;
    this.create(config);
  }

  private create(config: QuestCardUIConfig): void {
    this.container = this.scene.add.container(config.x, config.y);

    const bg = new UIBackgroundBuilder(this.scene)
      .setSize(config.width, config.height)
      .setFill(Colors.background.card)
      .setBorder(Colors.border.primary)
      .build();

    this.container.add(bg);
    this.createContent();
    this.setupInteraction(config);
  }

  private createContent(): void {
    // 依頼主、タイトル、報酬の表示
  }

  private setupInteraction(config: QuestCardUIConfig): void {
    this.container.setInteractive();
    applyHoverAnimation(this.container, this.scene, AnimationPresets.card.select);

    if (config.onClick) {
      this.container.on('pointerdown', config.onClick);
    }
  }

  destroy(): void {
    this.container.destroy();
  }
}
```

### 4. インデックスファイル作成 🔵

**信頼性**: 🔵 *標準的な実装パターン*

**実装ファイル**: `src/features/quest/components/index.ts`

```typescript
export { QuestDetailModal } from './QuestDetailModal';
export type { QuestDetailModalConfig } from './QuestDetailModal';

export { DeliveryQuestPanel } from './DeliveryQuestPanel';
export type { DeliveryQuestPanelConfig } from './DeliveryQuestPanel';

export { QuestCardUI } from './QuestCardUI';
export type { QuestCardUIConfig } from './QuestCardUI';
```

---

## 単体テスト要件

### テストケース1: QuestDetailModal テスト 🔵

**信頼性**: 🔵 *既存実装に基づく*

**テストファイル**: `tests/unit/features/quest/components/QuestDetailModal.test.ts`

```typescript
describe('QuestDetailModal', () => {
  it('should create container in hidden state', () => {
    // テスト実装
  });

  it('should show modal when show() is called', () => {
    // テスト実装
  });

  it('should call onAccept when accept button is clicked', () => {
    // テスト実装
  });
});
```

### テストケース2: DeliveryQuestPanel テスト 🔵

**信頼性**: 🔵 *既存実装に基づく*

**Given**: DeliveryQuestPanel インスタンス
**When**: アイテムを追加
**Then**: バリデーションが更新される

### テストケース3: QuestCardUI テスト 🔵

**信頼性**: 🔵 *既存実装に基づく*

**Given**: QuestCardUI インスタンス
**When**: クリック
**Then**: onClick コールバックが呼び出される

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0082` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 共通UIユーティリティ（TASK-0067）を積極的に使用すること
- features/quest/services の純粋関数を活用すること
- アニメーションはテーマ定数を参照すること

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 4 | 0 | 0 | 4 |
| 単体テスト | 3 | 0 | 0 | 3 |

### 全体評価

- **総項目数**: 7項目
- 🔵 **青信号**: 7項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高信頼性（既存実装に基づく移行タスク）
