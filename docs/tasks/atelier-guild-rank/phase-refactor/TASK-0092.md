# TASK-0092: features/rank/services作成

## 基本情報

| 項目 | 値 |
|------|-----|
| **タスクID** | TASK-0092 |
| **タスク名** | features/rank/services作成 |
| **見積時間** | 4時間 |
| **依存タスク** | TASK-0091 |
| **開発タイプ** | TDD |
| **フェーズ** | Phase 9 - features/rank機能 |
| **状態** | 🔲 未着手 |

---

## 概要

### 背景

FCIS（Functional Core, Imperative Shell）原則に基づき、ランク関連のビジネスロジックを純粋関数として再実装する必要がある。また、ContributionCalculatorとの統合も行う。

### 目的

RankServiceを純粋関数として再実装し、calculateRankProgress、checkPromotion等の操作を副作用のない関数として提供する。ContributionCalculatorのロジックも統合する。

### 現状

- 既存のサービスがクラスベースで実装されている可能性
- ContributionCalculatorが別モジュールとして存在している可能性

---

## 要件

### 機能要件

| 要件ID | 要件 | 信頼性 |
|--------|------|--------|
| REQ-092-01 | calculateRankProgress関数を純粋関数として実装する | 🔵 |
| REQ-092-02 | checkPromotion関数を純粋関数として実装する | 🔵 |
| REQ-092-03 | getNextRankRequirements関数を純粋関数として実装する | 🔵 |
| REQ-092-04 | calculateContribution関数を純粋関数として実装する | 🔵 |
| REQ-092-05 | applySpecialRule関数を純粋関数として実装する | 🔵 |

### 非機能要件

| 要件ID | 要件 |
|--------|------|
| NFR-092-01 | 全関数が純粋関数であること（副作用なし） |
| NFR-092-02 | 同じ入力に対して常に同じ出力を返すこと |
| NFR-092-03 | ContributionCalculatorのロジックが統合されていること |

---

## テストケース

### サービス関数テスト

```typescript
describe('features/rank/services', () => {
  describe('calculateRankProgress', () => {
    it('現在の進捗率を正しく計算すること', () => {});
    it('必要ポイントに対する達成率を返すこと', () => {});
    it('最大ランク時に100%を返すこと', () => {});
  });

  describe('checkPromotion', () => {
    it('昇格条件を満たす場合にtrueを返すこと', () => {});
    it('昇格条件を満たさない場合にfalseを返すこと', () => {});
    it('特殊ルールを考慮した判定を行うこと', () => {});
  });

  describe('calculateContribution', () => {
    it('クエスト完了による貢献度を計算すること', () => {});
    it('品質ボーナスを適用すること', () => {});
    it('ランク補正を適用すること', () => {});
  });

  describe('applySpecialRule', () => {
    it('特殊ルールの効果を正しく適用すること', () => {});
    it('複数ルールの組み合わせを処理すること', () => {});
    it('無効なルールを無視すること', () => {});
  });

  describe('純粋関数検証', () => {
    it('同じ入力に対して同じ出力を返すこと', () => {});
    it('外部状態に依存しないこと', () => {});
  });
});
```

---

## 実装計画

### ステップ1: 既存実装調査（1時間）

1. 既存のRankService、ContributionCalculatorの実装を確認
2. 現在の関数シグネチャを把握
3. 副作用のある箇所を特定

### ステップ2: 純粋関数設計（1時間）

1. 各関数のインターフェースを設計
2. 入出力の型を定義
3. ContributionCalculator統合方針を決定

### ステップ3: 実装（2時間）

1. テストを先に作成（TDD）
2. 純粋関数として実装
3. ContributionCalculatorのロジックを統合

---

## 対象ファイル

- `src/features/rank/services/rank-service.ts` - 新規作成
- `src/features/rank/services/contribution-calculator.ts` - 新規作成
- `src/features/rank/services/special-rule-processor.ts` - 新規作成
- `src/features/rank/services/index.ts` - 新規作成
- `tests/unit/features/rank/services/` - テスト作成

---

## 受け入れ条件

- [ ] calculateRankProgress関数が純粋関数として実装されている
- [ ] checkPromotion関数が純粋関数として実装されている
- [ ] calculateContribution関数が純粋関数として実装されている
- [ ] applySpecialRule関数が純粋関数として実装されている
- [ ] ContributionCalculatorのロジックが統合されている
- [ ] 全テストがパスする
- [ ] `pnpm lint`がエラーなしで完了する

---

## 関連ドキュメント

- **TASK-0091**: features/rank/types作成
- **TASK-0093**: features/rank/components and index.ts作成
- **設計文書**: `.claude/rules/architecture.md`

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 機能要件 | 5 | 0 | 0 | 5 |
| テストケース | 0 | 0 | 0 | 0 |

### 全体評価

- **総項目数**: 5項目
- 🔵 **青信号**: 5項目 (100%) - FCIS原則に基づく
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 良好（FCIS原則に従った明確な設計方針）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-09 | 初版作成 |
