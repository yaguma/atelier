# TASK-0081: features/quest/servicesä½œæˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0081
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 6 - features/questæ©Ÿèƒ½
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](../overview.md)
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

QuestServiceã‚’ç´”ç²‹é–¢æ•°ã¨ã—ã¦å†å®Ÿè£…ã™ã‚‹ã€‚ä¾é ¼ç”Ÿæˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€å ±é…¬è¨ˆç®—ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«å¤‰æ›ã—ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0080](TASK-0080.md)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0082](TASK-0082.md)

## å®Œäº†æ¡ä»¶

- [ ] generateQuests é–¢æ•°ãŒç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] validateQuest é–¢æ•°ãŒç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] å ±é…¬è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
- [ ] ä¾é ¼ç”Ÿæˆã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. generateQuests ç´”ç²‹é–¢æ•°å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸä¾é ¼ã‚’ç”Ÿæˆã™ã‚‹ç´”ç²‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/quest/services/generateQuests.ts`

```typescript
import type { Quest, Client } from '../types';

export interface GenerateQuestsConfig {
  rank: number;
  count: number;
  clients: Client[];
  seed?: number;
}

export function generateQuests(config: GenerateQuestsConfig): Quest[] {
  const { rank, count, clients, seed } = config;
  const quests: Quest[] = [];
  const random = createSeededRandom(seed);

  for (let i = 0; i < count; i++) {
    const client = selectRandomClient(clients, random);
    const quest = createQuestForRank(rank, client, random);
    quests.push(quest);
  }

  return quests;
}

function createSeededRandom(seed?: number): () => number {
  // ã‚·ãƒ¼ãƒ‰ä»˜ãä¹±æ•°ç”Ÿæˆå™¨
  let state = seed ?? Date.now();
  return () => {
    state = (state * 1103515245 + 12345) & 0x7fffffff;
    return state / 0x7fffffff;
  };
}

function selectRandomClient(clients: Client[], random: () => number): Client {
  const index = Math.floor(random() * clients.length);
  return clients[index];
}

function createQuestForRank(rank: number, client: Client, random: () => number): Quest {
  // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸä¾é ¼ç”Ÿæˆ
  return {
    id: `quest-${Date.now()}-${Math.floor(random() * 1000)}`,
    clientId: client.id,
    title: generateQuestTitle(rank, random),
    description: generateQuestDescription(rank),
    conditions: generateConditions(rank, random),
    reward: calculateBaseReward(rank),
    deadline: calculateDeadline(rank),
    rank,
    status: 'available',
  };
}
```

### 2. validateQuest ç´”ç²‹é–¢æ•°å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

ä¾é ¼ã®ç´å“æ¡ä»¶ã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ç´”ç²‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/quest/services/validateQuest.ts`

```typescript
import type { Quest, QuestCondition } from '../types';
import type { CraftedItem } from '@features/alchemy/types';

export interface ValidationResult {
  valid: boolean;
  errors: ValidationError[];
  matchedItems: CraftedItem[];
}

export interface ValidationError {
  condition: QuestCondition;
  message: string;
}

export function validateQuest(quest: Quest, items: CraftedItem[]): ValidationResult {
  const errors: ValidationError[] = [];
  const matchedItems: CraftedItem[] = [];

  for (const condition of quest.conditions) {
    const result = validateCondition(condition, items, matchedItems);
    if (!result.valid) {
      errors.push(result.error!);
    } else if (result.matchedItem) {
      matchedItems.push(result.matchedItem);
    }
  }

  return {
    valid: errors.length === 0,
    errors,
    matchedItems,
  };
}

function validateCondition(
  condition: QuestCondition,
  items: CraftedItem[],
  alreadyMatched: CraftedItem[]
): { valid: boolean; error?: ValidationError; matchedItem?: CraftedItem } {
  // æ¡ä»¶ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  return { valid: true };
}
```

### 3. calculateReward ç´”ç²‹é–¢æ•°å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

å ±é…¬ã‚’è¨ˆç®—ã™ã‚‹ç´”ç²‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/quest/services/calculateReward.ts`

```typescript
import type { Quest, QuestReward } from '../types';
import type { CraftedItem, Quality } from '@features/alchemy/types';

export interface RewardCalculationResult {
  baseReward: QuestReward;
  qualityBonus: number;
  totalGold: number;
  totalContribution: number;
}

export function calculateReward(
  quest: Quest,
  deliveredItems: CraftedItem[]
): RewardCalculationResult {
  const baseReward = quest.reward;
  const qualityBonus = calculateQualityBonus(deliveredItems);

  return {
    baseReward,
    qualityBonus,
    totalGold: Math.floor(baseReward.gold * (1 + qualityBonus)),
    totalContribution: Math.floor(baseReward.contribution * (1 + qualityBonus)),
  };
}

function calculateQualityBonus(items: CraftedItem[]): number {
  if (items.length === 0) return 0;

  const qualityMultipliers: Record<Quality, number> = {
    E: 0,
    D: 0.1,
    C: 0.2,
    B: 0.3,
    A: 0.5,
    S: 1.0,
  };

  const totalBonus = items.reduce((sum, item) => {
    return sum + qualityMultipliers[item.quality];
  }, 0);

  return totalBonus / items.length;
}
```

### 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¨™æº–çš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/quest/services/index.ts`

```typescript
export { generateQuests } from './generateQuests';
export type { GenerateQuestsConfig } from './generateQuests';

export { validateQuest } from './validateQuest';
export type { ValidationResult, ValidationError } from './validateQuest';

export { calculateReward } from './calculateReward';
export type { RewardCalculationResult } from './calculateReward';
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: generateQuests ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜å®Ÿè£…ã«åŸºã¥ã*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/features/quest/services/generateQuests.test.ts`

```typescript
describe('generateQuests', () => {
  it('should generate specified number of quests', () => {
    const result = generateQuests({
      rank: 1,
      count: 3,
      clients: mockClients,
    });
    expect(result).toHaveLength(3);
  });

  it('should generate quests with correct rank', () => {
    const result = generateQuests({
      rank: 2,
      count: 1,
      clients: mockClients,
    });
    expect(result[0].rank).toBe(2);
  });

  it('should produce deterministic results with same seed', () => {
    const config = { rank: 1, count: 3, clients: mockClients, seed: 12345 };
    const result1 = generateQuests(config);
    const result2 = generateQuests(config);
    expect(result1).toEqual(result2);
  });
});
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: validateQuest ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜å®Ÿè£…ã«åŸºã¥ã*

**Given**: ä¾é ¼ã¨ç´å“ã‚¢ã‚¤ãƒ†ãƒ 
**When**: validateQuest ã‚’å‘¼ã³å‡ºã™
**Then**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœãŒæ­£ã—ãè¿”ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: calculateReward ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

**Given**: ä¾é ¼ã¨ç´å“ã‚¢ã‚¤ãƒ†ãƒ 
**When**: calculateReward ã‚’å‘¼ã³å‡ºã™
**Then**: å ±é…¬ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0081` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç´”ç²‹é–¢æ•°ã¯å‰¯ä½œç”¨ã‚’æŒãŸãªã„ã“ã¨
- ä¹±æ•°ç”Ÿæˆã¯ã‚·ãƒ¼ãƒ‰ã‚’æ³¨å…¥å¯èƒ½ã«ã™ã‚‹ã“ã¨
- æ—¢å­˜ã® QuestService ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒã™ã‚‹ã“ã¨

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

### é …ç›®åˆ¥ä¿¡é ¼æ€§

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 4 | 0 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 0 | 0 | 3 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 7é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 7é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜ä¿¡é ¼æ€§ï¼ˆFCISåŸå‰‡ã«åŸºã¥ãè¨­è¨ˆï¼‰
