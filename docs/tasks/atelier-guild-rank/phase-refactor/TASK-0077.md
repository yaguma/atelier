# TASK-0077: features/alchemy/servicesä½œæˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0077
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - features/alchemyæ©Ÿèƒ½
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](../overview.md)
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

AlchemyServiceã‚’ç´”ç²‹é–¢æ•°ã¨ã—ã¦å†å®Ÿè£…ã™ã‚‹ã€‚æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹å®Ÿè£…ã‚’é–¢æ•°å‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«å¤‰æ›ã—ã€ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0076](TASK-0076.md)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0078](TASK-0078.md)

## å®Œäº†æ¡ä»¶

- [ ] calculateQuality é–¢æ•°ãŒç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] calculateAttributes é–¢æ•°ãŒç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] craft å‡¦ç†ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
- [ ] å“è³ªè¨ˆç®—ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. calculateQuality ç´”ç²‹é–¢æ•°å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

ç´ æã®å“è³ªã‹ã‚‰æœ€çµ‚å“è³ªã‚’è¨ˆç®—ã™ã‚‹ç´”ç²‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/alchemy/services/calculateQuality.ts`

```typescript
import type { Material } from '@features/materials/types';
import type { Quality } from '../types';
import { QUALITY_THRESHOLDS } from '../types';

export function calculateQuality(materials: Material[]): Quality {
  if (materials.length === 0) {
    return 'E';
  }

  const totalScore = materials.reduce((sum, m) => sum + getQualityScore(m.quality), 0);
  const averageScore = totalScore / materials.length;

  return scoreToQuality(averageScore);
}

function getQualityScore(quality: Quality): number {
  const scores: Record<Quality, number> = {
    E: 10,
    D: 30,
    C: 50,
    B: 70,
    A: 90,
    S: 100,
  };
  return scores[quality];
}

function scoreToQuality(score: number): Quality {
  if (score >= QUALITY_THRESHOLDS.S) return 'S';
  if (score >= QUALITY_THRESHOLDS.A) return 'A';
  if (score >= QUALITY_THRESHOLDS.B) return 'B';
  if (score >= QUALITY_THRESHOLDS.C) return 'C';
  if (score >= QUALITY_THRESHOLDS.D) return 'D';
  return 'E';
}
```

### 2. calculateAttributes ç´”ç²‹é–¢æ•°å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

ç´ æã®å±æ€§ã‹ã‚‰æœ€çµ‚å±æ€§ã‚’è¨ˆç®—ã™ã‚‹ç´”ç²‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/alchemy/services/calculateAttributes.ts`

```typescript
import type { Material } from '@features/materials/types';

export function calculateAttributes(materials: Material[]): Record<string, number> {
  const attributes: Record<string, number> = {};

  for (const material of materials) {
    for (const [key, value] of Object.entries(material.attributes ?? {})) {
      attributes[key] = (attributes[key] ?? 0) + value;
    }
  }

  return attributes;
}
```

### 3. craft å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

èª¿åˆå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç´”ç²‹é–¢æ•°ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/alchemy/services/craft.ts`

```typescript
import type { Recipe, CraftedItem, Material } from '../types';
import { calculateQuality } from './calculateQuality';
import { calculateAttributes } from './calculateAttributes';
import { determineGrade } from './determineGrade';

export interface CraftResult {
  success: boolean;
  item?: CraftedItem;
  error?: string;
}

export function craft(
  recipe: Recipe,
  materials: Material[],
  generateId: () => string
): CraftResult {
  const validationError = validateMaterials(recipe, materials);
  if (validationError) {
    return { success: false, error: validationError };
  }

  const quality = calculateQuality(materials);
  const attributes = calculateAttributes(materials);
  const grade = determineGrade(quality, attributes);

  const item: CraftedItem = {
    id: generateId(),
    recipeId: recipe.id,
    name: recipe.name,
    quality,
    grade,
    attributes,
    createdAt: Date.now(),
  };

  return { success: true, item };
}

function validateMaterials(recipe: Recipe, materials: Material[]): string | null {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
  return null;
}
```

### 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¨™æº–çš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/features/alchemy/services/index.ts`

```typescript
export { calculateQuality } from './calculateQuality';
export { calculateAttributes } from './calculateAttributes';
export { craft } from './craft';
export type { CraftResult } from './craft';
export { determineGrade } from './determineGrade';
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: calculateQuality ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜å®Ÿè£…ã«åŸºã¥ã*

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/features/alchemy/services/calculateQuality.test.ts`

```typescript
describe('calculateQuality', () => {
  it('should return E quality for empty materials', () => {
    expect(calculateQuality([])).toBe('E');
  });

  it('should calculate average quality from multiple materials', () => {
    const materials = [
      { quality: 'A' },
      { quality: 'B' },
    ];
    expect(calculateQuality(materials)).toBe('B');
  });

  it('should return S quality for all S materials', () => {
    const materials = [
      { quality: 'S' },
      { quality: 'S' },
    ];
    expect(calculateQuality(materials)).toBe('S');
  });
});
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: calculateAttributes ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜å®Ÿè£…ã«åŸºã¥ã*

**Given**: è¤‡æ•°ã®ç´ æ
**When**: calculateAttributes ã‚’å‘¼ã³å‡ºã™
**Then**: å±æ€§å€¤ãŒæ­£ã—ãåˆç®—ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: craft ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *FCISåŸå‰‡ã«åŸºã¥ã*

**Given**: ãƒ¬ã‚·ãƒ”ã¨ç´ æ
**When**: craft ã‚’å‘¼ã³å‡ºã™
**Then**: èª¿åˆçµæœãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0077` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç´”ç²‹é–¢æ•°ã¯å‰¯ä½œç”¨ã‚’æŒãŸãªã„ã“ã¨
- IDç”Ÿæˆãªã©ã®å‰¯ä½œç”¨ã¯å¼•æ•°ã¨ã—ã¦æ³¨å…¥ã™ã‚‹ã“ã¨
- æ—¢å­˜ã® AlchemyService ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒã™ã‚‹ã“ã¨

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

### é …ç›®åˆ¥ä¿¡é ¼æ€§

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 4 | 0 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 0 | 0 | 3 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 7é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 7é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜ä¿¡é ¼æ€§ï¼ˆFCISåŸå‰‡ã«åŸºã¥ãè¨­è¨ˆï¼‰
