# TASK-0053: 共通UIユーティリティ基盤作成

**タスクID**: TASK-0053
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 7 - Presentation層リファクタリング
**信頼性レベル**: 🟡 *コードベース調査結果より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

Presentation層で重複しているUI生成パターンを共通ユーティリティとして抽出・統合する。背景パネル作成、ホバーエフェクト、ボーダーライン生成など、5箇所以上で重複しているコードを一元化する。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: [TASK-0054](TASK-0054.md), [TASK-0055](TASK-0055.md), [TASK-0056](TASK-0056.md), [TASK-0057](TASK-0057.md), [TASK-0058](TASK-0058.md)

## 完了条件

- [x] UIBackgroundBuilder クラスが作成されている
- [x] HoverAnimationMixin が作成されている
- [x] BorderLineFactory が作成されている
- [x] 既存テストが全て通過する
- [x] 新規ユーティリティのテストカバレッジが80%以上

---

## 実装詳細

### 1. UIBackgroundBuilder クラス作成 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

背景パネル生成の共通パターンを抽出してBuilderパターンで実装する。

**実装ファイル**: `src/presentation/ui/utils/UIBackgroundBuilder.ts`

```typescript
export class UIBackgroundBuilder {
  private scene: Phaser.Scene;
  private x: number = 0;
  private y: number = 0;
  private width: number = 100;
  private height: number = 100;
  private fillColor: number = 0x2a2a3d;
  private fillAlpha: number = 0.95;
  private borderRadius: number = 8;
  private borderColor: number = 0x4a4a5d;
  private borderWidth: number = 2;

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
  }

  setPosition(x: number, y: number): this { /* ... */ }
  setSize(width: number, height: number): this { /* ... */ }
  setFill(color: number, alpha?: number): this { /* ... */ }
  setBorder(color: number, width?: number): this { /* ... */ }
  setRadius(radius: number): this { /* ... */ }
  build(): Phaser.GameObjects.Graphics { /* ... */ }
}
```

### 2. HoverAnimationMixin 作成 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

ホバーエフェクトの共通実装をMixinパターンで提供する。

**実装ファイル**: `src/presentation/ui/utils/HoverAnimationMixin.ts`

```typescript
export interface HoverAnimationConfig {
  scaleUp?: number;
  duration?: number;
  ease?: string;
  glowColor?: number;
  glowIntensity?: number;
}

export function applyHoverAnimation(
  gameObject: Phaser.GameObjects.GameObject,
  scene: Phaser.Scene,
  config?: HoverAnimationConfig
): void { /* ... */ }

export function removeHoverAnimation(
  gameObject: Phaser.GameObjects.GameObject
): void { /* ... */ }
```

### 3. BorderLineFactory 作成 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

ボーダーライン・セパレーター生成の共通化。

**実装ファイル**: `src/presentation/ui/utils/BorderLineFactory.ts`

```typescript
export class BorderLineFactory {
  static createHorizontalLine(
    scene: Phaser.Scene,
    x: number,
    y: number,
    width: number,
    color?: number,
    thickness?: number
  ): Phaser.GameObjects.Graphics;

  static createVerticalLine(
    scene: Phaser.Scene,
    x: number,
    y: number,
    height: number,
    color?: number,
    thickness?: number
  ): Phaser.GameObjects.Graphics;

  static createRoundedBorder(
    scene: Phaser.Scene,
    x: number,
    y: number,
    width: number,
    height: number,
    radius?: number,
    color?: number
  ): Phaser.GameObjects.Graphics;
}
```

### 4. インデックスファイル作成 🔵

**信頼性**: 🔵 *標準的な実装パターン*

**実装ファイル**: `src/presentation/ui/utils/index.ts`

```typescript
export { UIBackgroundBuilder } from './UIBackgroundBuilder';
export { applyHoverAnimation, removeHoverAnimation } from './HoverAnimationMixin';
export type { HoverAnimationConfig } from './HoverAnimationMixin';
export { BorderLineFactory } from './BorderLineFactory';
```

---

## 単体テスト要件

### テストケース1: UIBackgroundBuilder 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: UIBackgroundBuilderインスタンス
**When**: 各種設定を行いbuild()を呼び出す
**Then**: 設定に基づいたGraphicsオブジェクトが生成される

**テストファイル**: `tests/unit/presentation/ui/utils/UIBackgroundBuilder.test.ts`

```typescript
describe('UIBackgroundBuilder', () => {
  it('should create a graphics object with default settings', () => {
    // テスト実装
  });

  it('should apply custom fill color and alpha', () => {
    // テスト実装
  });

  it('should apply border settings', () => {
    // テスト実装
  });
});
```

### テストケース2: HoverAnimationMixin 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ゲームオブジェクト
**When**: applyHoverAnimationを適用
**Then**: ポインターオーバー/アウトイベントが設定される

### テストケース3: BorderLineFactory 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: シーンと座標
**When**: createHorizontalLineを呼び出す
**Then**: 指定位置に水平線が生成される

---

## 統合テスト要件

### 統合テスト1: 既存UIとの互換性 🟡

**信頼性**: 🟡 *妥当な推測*

**テスト内容**: 新規ユーティリティが既存UIコンポーネントで正常に動作すること
**期待結果**: 既存のUIテストが全て通過する

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0053` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 既存のUIコンポーネントを壊さないよう、段階的に移行する
- Phaser 3のGraphics APIとの互換性を保つ
- rexUIプラグインとの併用を考慮する

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 1 | 3 | 0 | 4 |
| 単体テスト | 0 | 3 | 0 | 3 |
| 統合テスト | 0 | 1 | 0 | 1 |

### 全体評価

- **総項目数**: 8項目
- 🔵 **青信号**: 1項目 (12.5%)
- 🟡 **黄信号**: 7項目 (87.5%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善（コードベース調査に基づく推測が多い）

**推測が多い項目**: UIBackgroundBuilder設計、HoverAnimationMixin設計、BorderLineFactory設計
