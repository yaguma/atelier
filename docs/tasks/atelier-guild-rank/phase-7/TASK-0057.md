# TASK-0057: DeliveryPhaseUIリファクタリング

**タスクID**: TASK-0057
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 7 - Presentation層リファクタリング
**信頼性レベル**: 🟡 *コードベース調査結果より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

884行のDeliveryPhaseUI.tsを責務ごとにコンポーネント分割する。ファイル内に定義されている大量のローカルインターフェースを適切な場所に移動し、コードの可読性と保守性を向上させる。

## 依存タスク

- **前提タスク**: [TASK-0053](TASK-0053.md), [TASK-0054](TASK-0054.md)
- **後続タスク**: [TASK-0059](TASK-0059.md), [TASK-0060](TASK-0060.md)

## 完了条件

- [x] DeliveryPhaseUI.tsが400行以下になっている（367行）
- [x] 3つ以上のサブコンポーネントに分割されている（4コンポーネント）
- [x] ローカルインターフェースが適切な場所に移動している（types.tsに一元管理）
- [x] 共通ユーティリティ（TASK-0053, 0054）を使用している（AnimationPresets使用）
- [x] 既存テストが全て通過する（1617テスト成功）
- [x] 新規コンポーネントのテストカバレッジが80%以上（90.1%達成）

### 品質確認結果（2026-01-24）

| コンポーネント | 行数 | カバレッジ |
|---------------|------|-----------|
| DeliveryPhaseUI.ts | 367行 | - |
| QuestDeliveryList.ts | 288行 | 93.44% |
| ItemSelector.ts | 271行 | 88.23% |
| DeliveryResultPanel.ts | 223行 | 93.87% |
| ContributionPreview.ts | 159行 | 80.64% |
| types.ts | 143行 | - |

**総合評価**: ✅ 完了

---

## 実装詳細

### 1. ローカルインターフェース移動 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

DeliveryPhaseUI.ts内の以下のインターフェースを適切な場所に移動：

| インターフェース | 移動先 |
|-----------------|--------|
| IEventBus | `src/shared/types/events.ts`（既存利用） |
| Quest | `src/domain/entities/Quest.ts`（既存利用） |
| ItemInstance | `src/domain/entities/ItemInstance.ts`（既存利用） |
| DeliveryResult | `src/shared/types/delivery.ts`（新規作成） |
| RewardCard | `src/shared/types/delivery.ts`（新規作成） |
| ContributionPreview | `src/shared/types/delivery.ts`（新規作成） |
| IQuestService | `src/domain/interfaces/IQuestService.ts`（既存利用） |
| IInventoryService | `src/domain/interfaces/IInventoryService.ts`（既存利用） |

**新規ファイル**: `src/shared/types/delivery.ts`

```typescript
export interface DeliveryResult {
  questId: string;
  success: boolean;
  deliveredItems: ItemInstance[];
  contributionGained: number;
  rewards: RewardItem[];
}

export interface RewardCard {
  cardId: string;
  cardName: string;
  rarity: string;
}

export interface ContributionPreview {
  current: number;
  gained: number;
  total: number;
  rankProgress: number;
}
```

### 2. コンポーネント分割計画 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

現在の884行を以下のコンポーネントに分割する：

| コンポーネント | 責務 | 推定行数 |
|---------------|------|---------|
| DeliveryPhaseUI.ts | フェーズ管理・コンポーネント統合 | 200行 |
| QuestDeliveryList.ts | 納品対象依頼一覧 | 150行 |
| ItemSelector.ts | 納品アイテム選択UI | 150行 |
| DeliveryResultPanel.ts | 納品結果表示 | 150行 |
| ContributionDisplay.ts | 貢献度表示・プレビュー | 100行 |

### 3. DeliveryPhaseUI.ts（メインコンポーネント）リファクタリング 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/phases/DeliveryPhaseUI.ts`

```typescript
import { QuestDeliveryList } from './components/QuestDeliveryList';
import { ItemSelector } from './components/ItemSelector';
import { DeliveryResultPanel } from './components/DeliveryResultPanel';
import { ContributionDisplay } from './components/ContributionDisplay';
import type { DeliveryResult, ContributionPreview } from '@shared/types/delivery';

export class DeliveryPhaseUI {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;

  private questList: QuestDeliveryList;
  private itemSelector: ItemSelector;
  private resultPanel: DeliveryResultPanel;
  private contributionDisplay: ContributionDisplay;

  constructor(scene: Phaser.Scene, eventBus: IEventBus) {
    this.scene = scene;
    this.initializeComponents();
    this.setupEventListeners(eventBus);
  }

  private initializeComponents(): void {
    this.questList = new QuestDeliveryList(this.scene);
    this.itemSelector = new ItemSelector(this.scene);
    this.resultPanel = new DeliveryResultPanel(this.scene);
    this.contributionDisplay = new ContributionDisplay(this.scene);
  }

  show(quests: Quest[], inventory: ItemInstance[]): void {
    this.questList.setQuests(quests);
    this.itemSelector.setInventory(inventory);
    this.container.setVisible(true);
  }

  showResult(result: DeliveryResult): void {
    this.resultPanel.show(result);
  }
}
```

### 4. QuestDeliveryList コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/phases/components/QuestDeliveryList.ts`

```typescript
import { Colors } from '@presentation/theme';
import { UIBackgroundBuilder } from '@presentation/ui/utils';

export class QuestDeliveryList {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;

  setQuests(quests: Quest[]): void {
    // 依頼リスト表示
  }

  onQuestSelect(callback: (quest: Quest) => void): void {
    // 選択コールバック設定
  }
}
```

### 5. ItemSelector コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/phases/components/ItemSelector.ts`

```typescript
export class ItemSelector {
  private scene: Phaser.Scene;
  private selectedItems: ItemInstance[] = [];

  setInventory(items: ItemInstance[]): void {
    // インベントリ表示
  }

  getSelectedItems(): ItemInstance[] {
    return this.selectedItems;
  }

  onSelectionChange(callback: (items: ItemInstance[]) => void): void {
    // 選択変更コールバック
  }
}
```

### 6. DeliveryResultPanel コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/phases/components/DeliveryResultPanel.ts`

```typescript
import { AnimationPresets } from '@presentation/ui/utils/AnimationPresets';

export class DeliveryResultPanel {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;

  show(result: DeliveryResult): void {
    // 結果表示アニメーション
    this.scene.tweens.add({
      targets: this.container,
      ...AnimationPresets.fade.in,
    });
  }

  hide(): void {
    // 非表示
  }
}
```

---

## 単体テスト要件

### テストケース1: DeliveryPhaseUIの初期化 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: DeliveryPhaseUIインスタンス
**When**: コンストラクタが呼び出される
**Then**: 全サブコンポーネントが初期化される

### テストケース2: QuestDeliveryList表示 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: QuestDeliveryListインスタンス
**When**: setQuests()が呼び出される
**Then**: 依頼が正しく表示される

### テストケース3: ItemSelector選択 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ItemSelectorインスタンス
**When**: アイテムを選択
**Then**: getSelectedItems()で選択アイテムが取得できる

### テストケース4: DeliveryResultPanel表示 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: DeliveryResultPanelインスタンス
**When**: show()が呼び出される
**Then**: フェードインアニメーションで表示される

---

## 統合テスト要件

### 統合テスト1: 納品フロー 🟡

**信頼性**: 🟡 *妥当な推測*

**テスト内容**: 依頼選択→アイテム選択→納品→結果表示のフローが正常に動作すること
**期待結果**: 貢献度が増加し、アイテムが消費される

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0057` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- ローカルインターフェース移動時に、既存の参照を全て更新する
- 型定義の移動は破壊的変更になるため、慎重に行う
- MainSceneからの呼び出しインターフェースを維持する

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 0 | 6 | 0 | 6 |
| 単体テスト | 0 | 4 | 0 | 4 |
| 統合テスト | 0 | 1 | 0 | 1 |

### 全体評価

- **総項目数**: 11項目
- 🔵 **青信号**: 0項目 (0%)
- 🟡 **黄信号**: 11項目 (100%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善（実際のコード構造に基づく詳細設計が必要）
