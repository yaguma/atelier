# TASK-0056: ShopSceneリファクタリング

**タスクID**: TASK-0056
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 7 - Presentation層リファクタリング
**信頼性レベル**: 🟡 *コードベース調査結果より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

890行のShopScene.tsを責務ごとにコンポーネント分割する。any型を適切な型定義に置き換え、共通ユーティリティを活用してコード重複を削減する。

## 依存タスク

- **前提タスク**: [TASK-0053](TASK-0053.md), [TASK-0054](TASK-0054.md)
- **後続タスク**: [TASK-0059](TASK-0059.md), [TASK-0060](TASK-0060.md)

## 完了条件

- [ ] ShopScene.tsが400行以下になっている
- [ ] 3つ以上のサブコンポーネントに分割されている
- [ ] any型が全て適切な型に置き換わっている
- [ ] 共通ユーティリティ（TASK-0053, 0054）を使用している
- [ ] 既存テストが全て通過する
- [ ] 新規コンポーネントのテストカバレッジが80%以上

---

## 実装詳細

### 1. コンポーネント分割計画 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

現在の890行を以下のコンポーネントに分割する：

| コンポーネント | 責務 | 推定行数 |
|---------------|------|---------|
| ShopScene.ts | シーン管理・コンポーネント統合 | 200行 |
| ShopHeader.ts | ヘッダー表示（所持金・タイトル） | 100行 |
| ShopItemList.ts | 商品一覧表示・スクロール | 200行 |
| ShopItemCard.ts | 個別商品カード表示 | 150行 |
| ShopPurchaseDialog.ts | 購入確認ダイアログ | 150行 |
| ShopCart.ts | カート・合計表示 | 100行 |

### 2. ShopScene.ts（メインシーン）リファクタリング 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/scenes/ShopScene.ts`

```typescript
import { ShopHeader } from './components/ShopHeader';
import { ShopItemList } from './components/ShopItemList';
import { ShopPurchaseDialog } from './components/ShopPurchaseDialog';
import { ShopCart } from './components/ShopCart';

export class ShopScene extends Phaser.Scene {
  private header: ShopHeader;
  private itemList: ShopItemList;
  private purchaseDialog: ShopPurchaseDialog;
  private cart: ShopCart;

  // rexUIプラグインの型定義
  private rexUI: RexUIPlugin;

  create(): void {
    this.initializeComponents();
    this.setupEventListeners();
    this.loadShopItems();
  }

  private initializeComponents(): void {
    this.header = new ShopHeader(this);
    this.itemList = new ShopItemList(this);
    this.purchaseDialog = new ShopPurchaseDialog(this);
    this.cart = new ShopCart(this);
  }

  private onItemSelect(item: ShopItem): void {
    this.purchaseDialog.show(item);
  }

  private onPurchaseConfirm(item: ShopItem): void {
    // 購入処理
  }
}
```

### 3. ShopItemList コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/scenes/components/ShopItemList.ts`

```typescript
import { Colors } from '@presentation/theme';
import { UIBackgroundBuilder } from '@presentation/ui/utils';
import { ShopItemCard } from './ShopItemCard';

export class ShopItemList {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private items: ShopItemCard[] = [];
  private scrollPanel: any; // rexUI ScrollablePanel

  constructor(scene: Phaser.Scene) {
    this.scene = scene;
    this.create();
  }

  private create(): void {
    // スクロール可能なリスト作成
  }

  setItems(items: ShopItem[]): void {
    this.items.forEach(card => card.destroy());
    this.items = items.map(item => new ShopItemCard(this.scene, item));
  }

  onItemClick(callback: (item: ShopItem) => void): void {
    // クリックイベント設定
  }
}
```

### 4. ShopItemCard コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/scenes/components/ShopItemCard.ts`

```typescript
import { Colors, AnimationPresets } from '@presentation/theme';
import { UIBackgroundBuilder, applyHoverAnimation } from '@presentation/ui/utils';

export class ShopItemCard {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private item: ShopItem;

  constructor(scene: Phaser.Scene, item: ShopItem) {
    this.scene = scene;
    this.item = item;
    this.create();
  }

  private create(): void {
    const bg = new UIBackgroundBuilder(this.scene)
      .setSize(200, 250)
      .setFill(Colors.background.card)
      .setBorder(Colors.border.primary)
      .build();

    applyHoverAnimation(this.container, this.scene, AnimationPresets.card.select);
  }
}
```

### 5. ShopPurchaseDialog コンポーネント 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

**実装ファイル**: `src/presentation/ui/scenes/components/ShopPurchaseDialog.ts`

```typescript
export class ShopPurchaseDialog {
  private scene: Phaser.Scene;
  private container: Phaser.GameObjects.Container;
  private visible: boolean = false;

  show(item: ShopItem): void {
    // ダイアログ表示
  }

  hide(): void {
    // ダイアログ非表示
  }

  onConfirm(callback: (item: ShopItem) => void): void {
    // 確認コールバック設定
  }

  onCancel(callback: () => void): void {
    // キャンセルコールバック設定
  }
}
```

### 6. any型の置き換え 🟡

**信頼性**: 🟡 *コードベース調査から妥当な推測*

```typescript
// Before
private itemGrid: any;
private confirmDialog: any;

// After
import type { RexUIPlugin, ScrollablePanel, Dialog } from '@presentation/types/rexui';

private itemGrid: Phaser.GameObjects.Container;
private confirmDialog: Phaser.GameObjects.Container;
```

---

## 単体テスト要件

### テストケース1: ShopSceneの初期化 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ShopSceneインスタンス
**When**: create()が呼び出される
**Then**: 全サブコンポーネントが初期化される

### テストケース2: ShopItemList表示 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ShopItemListインスタンス
**When**: setItems()が呼び出される
**Then**: 商品カードが正しく表示される

### テストケース3: ShopItemCardホバー 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ShopItemCardインスタンス
**When**: ポインターオーバー
**Then**: ホバーアニメーションが再生される

### テストケース4: ShopPurchaseDialog操作 🟡

**信頼性**: 🟡 *妥当な推測*

**Given**: ShopPurchaseDialogインスタンス
**When**: 確認ボタンをクリック
**Then**: onConfirmコールバックが呼び出される

---

## 統合テスト要件

### 統合テスト1: 購入フロー 🟡

**信頼性**: 🟡 *妥当な推測*

**テスト内容**: 商品選択から購入完了までのフローが正常に動作すること
**期待結果**: 所持金が減少し、アイテムが追加される

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0056` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- 既存の動作を壊さないよう、段階的にリファクタリングする
- rexUIのScrollablePanelとの互換性を維持する
- 購入処理のトランザクション性を保持する

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 0 | 6 | 0 | 6 |
| 単体テスト | 0 | 4 | 0 | 4 |
| 統合テスト | 0 | 1 | 0 | 1 |

### 全体評価

- **総項目数**: 11項目
- 🔵 **青信号**: 0項目 (0%)
- 🟡 **黄信号**: 11項目 (100%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 要改善（実際のコード構造に基づく詳細設計が必要）
