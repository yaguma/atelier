# TASK-0048: テストモック修正（fillRoundedRect）

## 基本情報

| 項目 | 値 |
|------|-----|
| **タスクID** | TASK-0048 |
| **タスク名** | テストモック修正（fillRoundedRect） |
| **見積時間** | 2時間 |
| **依存タスク** | なし |
| **開発タイプ** | DIRECT |
| **状態** | ✅ 完了 |

---

## 概要

### 背景

TASK-0047でHeaderUIの視覚実装を行った際、Phaser.GameObjects.Graphicsの`fillRoundedRect`メソッドを使用して昇格ゲージを実装した。しかし、Vitestのテストモックにはこのメソッドが定義されておらず、69件のテストが失敗している。

### 目的

Phaserのモック定義を拡張し、`fillRoundedRect`メソッドを追加することで、既存のテストを全てパスさせる。

### エラー内容

```
TypeError: this._gaugeBackground.fillRoundedRect is not a function
```

---

## 要件

### 機能要件

| 要件ID | 要件 | 信頼性 |
|--------|------|--------|
| REQ-048-01 | Phaserモックに`fillRoundedRect`メソッドを追加すること | 🔵 |
| REQ-048-02 | 追加したモックが正しい引数を受け取れること | 🔵 |
| REQ-048-03 | 既存のGraphicsモック（fillStyle, fillRect等）との整合性を保つこと | 🔵 |

### 非機能要件

| 要件ID | 要件 |
|--------|------|
| NFR-048-01 | 修正後、HeaderUI関連の69件のテストがすべてパスすること |
| NFR-048-02 | 他のコンポーネントのテストに影響を与えないこと |

---

## テストケース

### 修正前のテスト実行結果

```bash
pnpm test
# 70件失敗（header-ui-visual.test.ts: 69件、theme.spec.ts: 1件）
```

### 修正後の期待結果

```bash
pnpm test
# header-ui-visual.test.ts関連のテストがすべてパス
```

---

## 実装計画

### ステップ1: モックファイルの特定（0.5時間）

1. `tests/mocks/`ディレクトリ内のPhaserモック定義を確認
2. Graphicsオブジェクトのモック定義箇所を特定

### ステップ2: fillRoundedRectモックの追加（1時間）

1. `fillRoundedRect(x, y, width, height, radius)`のモック実装
2. メソッドチェーン対応（`this`を返す）

### ステップ3: テスト実行と確認（0.5時間）

1. 全テスト実行
2. 69件のテストがパスすることを確認

---

## 調査対象ファイル

- `tests/mocks/` - Phaserモック定義
- `atelier-guild-rank/vitest.config.ts` - テスト設定
- `src/presentation/ui/components/HeaderUI.ts:159` - fillRoundedRect使用箇所

---

## 受け入れ条件

- [x] `fillRoundedRect`メソッドがモックに追加されている
- [x] header-ui-visual.test.tsの69件のテストがすべてパスする
- [x] 他のテストに影響がない
- [x] `pnpm lint`がエラーなしで完了する

---

## 関連ドキュメント

- **HeaderUI実装**: `src/presentation/ui/components/HeaderUI.ts`
- **HeaderUIテスト**: `tests/unit/presentation/components/header-ui-visual.test.ts`
- **TASK-0047**: 共通UIコンポーネント視覚実装

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-22 | 初版作成 |
| 2026-01-22 | 完了：テストモック修正（複数の問題を解決） |

---

## 実施内容

### 修正したファイル

1. **tests/unit/presentation/main-scene.test.ts**
   - `fillRoundedRect`モックを追加
   - `lineStyle`, `beginPath`, `moveTo`, `lineTo`, `stroke`, `strokePath`モックを追加
   - `setStrokeStyle`をcircle・rectangleモックに追加
   - `bringToTop`をcontainerモックに追加
   - DIコンテナモックを追加（`@infrastructure/di/container`）
   - Event Handlingテストを修正（グローバルmockEventBusInstanceを使用）
   - Error Handlingテストを修正（resolve関数の戻り値を制御）

2. **tests/unit/presentation/scenes/BootScene.test.ts**
   - DIセットアップモックを追加（`@infrastructure/di/setup`）
   - 非同期テストを修正（`vi.waitFor()`を使用）

3. **src/presentation/ui/theme.spec.ts**
   - フォント名の期待値を更新（`'M PLUS Rounded 1c'`に変更）

### 修正結果

- **修正前**: 48テスト失敗
- **修正後**: 1479テスト成功（4スキップ）、64ファイル全てパス
