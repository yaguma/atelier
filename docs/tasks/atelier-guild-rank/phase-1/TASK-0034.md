# TASK-0034: Lefthook設定

**タスクID**: TASK-0034
**タスクタイプ**: DIRECT
**推定工数**: 2時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *architecture-overview.md v2.2.0より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

Lefthook（Git Hooks管理ツール）を設定し、コミット前の品質チェックを自動化する。Biomeによるlint/formatチェックとTypeScriptの型チェックを実行し、品質の低いコードがコミットされることを防ぐ。

## 依存タスク

- **前提タスク**: [TASK-0033: pnpm移行とBiome設定](TASK-0033.md)
- **後続タスク**: なし（Phase 1の品質管理基盤として他タスクに影響）

## 完了条件

- [x] Lefthook 1.xがインストールされている（v2.0.15インストール済み）
- [x] lefthook.ymlが設定済み（モノレポ対応設定完了）
- [x] `git commit` 時にpre-commitフックが実行される（確認済み）
- [x] lint/formatエラーがあるとコミットが拒否される（Biome連携確認済み）
- [x] 型エラーがあるとコミットが拒否される（TypeScript連携確認済み）

---

## 実装詳細

### 1. Lefthookインストール 🔵

**信頼性**: 🔵 *architecture-overview.md セクション1.2より*

```bash
pnpm add -D lefthook
```

### 2. lefthook.yml作成 🔵

**信頼性**: 🔵 *architecture-overview.md セクション1.2, 1.6より*

```yaml
# lefthook.yml
pre-commit:
  parallel: true
  commands:
    biome-check:
      glob: "*.{ts,tsx,js,jsx,json}"
      run: pnpm biome check --write --staged
      stage_fixed: true
    typecheck:
      glob: "*.{ts,tsx}"
      run: pnpm tsc --noEmit

commit-msg:
  commands:
    commitlint:
      run: |
        # コミットメッセージのフォーマットチェック（簡易版）
        # feat:, fix:, docs:, test:, refactor:, chore: で始まることを確認
        message=$(cat {1})
        if ! echo "$message" | grep -qE "^(feat|fix|docs|test|refactor|chore|style|perf|ci|build|revert)(\(.+\))?: .+"; then
          echo "コミットメッセージはConventional Commits形式で記述してください"
          echo "例: feat: 新機能追加"
          echo "例: fix(auth): ログインバグ修正"
          exit 1
        fi
```

**実装ファイル**: `lefthook.yml`

### 3. Git Hooksのインストール 🔵

**信頼性**: 🔵 *Lefthook標準手順*

```bash
# Git Hooksをインストール
pnpm lefthook install
```

### 4. package.jsonスクリプト追加 🟡

**信頼性**: 🟡 *利便性のための追加*

```json
{
  "scripts": {
    "prepare": "lefthook install",
    "hooks:install": "lefthook install",
    "hooks:uninstall": "lefthook uninstall"
  }
}
```

**実装ファイル**: `package.json`

---

## テスト要件

### 動作確認テスト 🔵

**信頼性**: 🔵 *標準的な動作確認*

1. **正常系テスト**
   - lint/formatエラーのないファイルを変更してコミット → 成功
   - コミットメッセージが `feat: test` の形式 → 成功

2. **異常系テスト**
   - lint/formatエラーのあるファイルをステージング → 自動修正されてコミット
   - TypeScript型エラーのあるコード → コミット拒否
   - 不正なコミットメッセージ `test commit` → コミット拒否

---

## 実装手順

### DIRECTタスク

1. `/tsumiki:direct-setup` - Lefthook設定
2. `/tsumiki:direct-verify` - 動作確認

---

## 注意事項

- `pnpm install` 後に `prepare` スクリプトで自動的にhooksがインストールされる
- チーム開発時は全員が `pnpm install` を実行することでhooksが有効になる
- CIでは `--no-verify` オプションが必要な場合がある

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 3 | 1 | 0 | 4 |
| テスト要件 | 1 | 0 | 0 | 1 |

### 全体評価

- **総項目数**: 5項目
- 🔵 **青信号**: 4項目 (80%)
- 🟡 **黄信号**: 1項目 (20%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
