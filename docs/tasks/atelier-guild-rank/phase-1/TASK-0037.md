# TASK-0037: Playwright E2Eè¨­å®š

**ã‚¿ã‚¹ã‚¯ID**: TASK-0037
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: DIRECT
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - åŸºç›¤æ§‹ç¯‰
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *architecture-overview.md v2.2.0ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](../overview.md)
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture-overview.md](../../../design/atelier-guild-rank/architecture-overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

Playwrightã‚’è¨­å®šã—ã€E2Eï¼ˆEnd-to-Endï¼‰ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å®Ÿéš›ã®ã‚²ãƒ¼ãƒ å‹•ä½œã‚’æ¤œè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å“è³ªã‚’ä¿è¨¼ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0033: pnpmç§»è¡Œã¨Biomeè¨­å®š](TASK-0033.md), [TASK-0008: PhaseråŸºæœ¬è¨­å®šã¨BootScene](TASK-0008.md)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: [TASK-0030: E2Eãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°](../phase-4/TASK-0030.md)

## å®Œäº†æ¡ä»¶

- [x] PlaywrightãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
- [x] playwright.config.tsãŒè¨­å®šæ¸ˆã¿
- [x] e2e/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [x] `pnpm test:e2e` ã§E2Eãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œå¯èƒ½
- [x] ã‚µãƒ³ãƒ—ãƒ«E2Eãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [x] Chromiumãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹

---

## å®Ÿè£…è©³ç´°

### 1. Playwrightã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture-overview.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³1.3ã‚ˆã‚Š*

```bash
pnpm add -D @playwright/test
pnpm exec playwright install chromium
```

### 2. playwright.config.tsä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *architecture-overview.md ã‚»ã‚¯ã‚·ãƒ§ãƒ³1.3ã‚ˆã‚Š*

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html', { outputFolder: 'playwright-report' }],
    ['list'],
  ],
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000,
  },
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `playwright.config.ts`

### 3. E2Eãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¨™æº–çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ*

```
e2e/
â”œâ”€â”€ fixtures/           # ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
â”‚   â””â”€â”€ game.fixture.ts
â”œâ”€â”€ pages/              # ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
â”‚   â””â”€â”€ game.page.ts
â””â”€â”€ specs/              # ãƒ†ã‚¹ãƒˆã‚¹ãƒšãƒƒã‚¯
    â””â”€â”€ boot.spec.ts
```

### 4. ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *Playwrightæ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³*

```typescript
// e2e/fixtures/game.fixture.ts
import { test as base, Page } from '@playwright/test';

export interface GameFixtures {
  gamePage: Page;
}

export const test = base.extend<GameFixtures>({
  gamePage: async ({ page }, use) => {
    // ã‚²ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ç§»å‹•
    await page.goto('/');
    // Phaserã‚­ãƒ£ãƒ³ãƒã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    await page.waitForSelector('#game-container canvas', { timeout: 10000 });
    await use(page);
  },
});

export { expect } from '@playwright/test';
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/fixtures/game.fixture.ts`

### 5. ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *Page Object Model ãƒ‘ã‚¿ãƒ¼ãƒ³*

```typescript
// e2e/pages/game.page.ts
import { Page, Locator } from '@playwright/test';

export class GamePage {
  readonly page: Page;
  readonly canvas: Locator;
  readonly gameContainer: Locator;

  constructor(page: Page) {
    this.page = page;
    this.gameContainer = page.locator('#game-container');
    this.canvas = page.locator('#game-container canvas');
  }

  async waitForGameLoad(): Promise<void> {
    await this.canvas.waitFor({ state: 'visible', timeout: 10000 });
  }

  async getCanvasSize(): Promise<{ width: number; height: number }> {
    const boundingBox = await this.canvas.boundingBox();
    return {
      width: boundingBox?.width ?? 0,
      height: boundingBox?.height ?? 0,
    };
  }

  async clickCanvas(x: number, y: number): Promise<void> {
    await this.canvas.click({ position: { x, y } });
  }

  async takeScreenshot(name: string): Promise<void> {
    await this.page.screenshot({ path: `e2e/screenshots/${name}.png` });
  }
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/pages/game.page.ts`

### 6. ã‚µãƒ³ãƒ—ãƒ«E2Eãƒ†ã‚¹ãƒˆä½œæˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å‹•ä½œç¢ºèªç”¨*

```typescript
// e2e/specs/boot.spec.ts
import { test, expect } from '../fixtures/game.fixture';
import { GamePage } from '../pages/game.page';

test.describe('Game Boot', () => {
  test('should load the game canvas', async ({ gamePage }) => {
    const game = new GamePage(gamePage);
    await game.waitForGameLoad();

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    await expect(game.canvas).toBeVisible();
  });

  test('should have correct canvas size', async ({ gamePage }) => {
    const game = new GamePage(gamePage);
    await game.waitForGameLoad();

    const size = await game.getCanvasSize();
    // è¨­è¨ˆæ›¸ã®è§£åƒåº¦ã«åŸºã¥ãï¼ˆ1280x720ã¾ãŸã¯é©åˆ‡ãªã‚µã‚¤ã‚ºï¼‰
    expect(size.width).toBeGreaterThan(0);
    expect(size.height).toBeGreaterThan(0);
  });

  test('should not have console errors on boot', async ({ gamePage }) => {
    const errors: string[] = [];
    gamePage.on('console', (msg) => {
      if (msg.type() === 'error') {
        errors.push(msg.text());
      }
    });

    const game = new GamePage(gamePage);
    await game.waitForGameLoad();

    // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
    expect(errors.filter((e) => !e.includes('warning'))).toHaveLength(0);
  });
});
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `e2e/specs/boot.spec.ts`

### 7. package.jsonã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ  ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¨™æº–çš„ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨­å®š*

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:report": "playwright show-report"
  }
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `package.json`

### 8. .gitignoreæ›´æ–° ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ³ã«ã‚ˆã‚‹*

```gitignore
# Playwright
playwright-report/
test-results/
e2e/screenshots/
```

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ¨™æº–çš„ãªå‹•ä½œç¢ºèª*

1. **E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª**
   - `pnpm test:e2e` ã§ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹
   - `pnpm test:e2e:ui` ã§UIä»˜ãã§å®Ÿè¡Œã•ã‚Œã‚‹
   - `pnpm test:e2e:headed` ã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¡¨ç¤ºã•ã‚Œã‚‹

2. **ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª**
   - `pnpm test:e2e:report` ã§HTMLãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - å¤±æ•—æ™‚ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒä¿å­˜ã•ã‚Œã‚‹

3. **é–‹ç™ºã‚µãƒ¼ãƒãƒ¼é€£æºç¢ºèª**
   - webServerã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒè‡ªå‹•èµ·å‹•ã•ã‚Œã‚‹
   - ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ã‚µãƒ¼ãƒãƒ¼ãŒé©åˆ‡ã«çµ‚äº†ã™ã‚‹

---

## å®Ÿè£…æ‰‹é †

### DIRECTã‚¿ã‚¹ã‚¯

1. `/tsumiki:direct-setup` - Playwrightè¨­å®š
2. `/tsumiki:direct-verify` - å‹•ä½œç¢ºèª

---

## æ³¨æ„äº‹é …

- Phaserã‚²ãƒ¼ãƒ ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã«UIã‚’æç”»ã™ã‚‹ãŸã‚ã€é€šå¸¸ã®DOMæ“ä½œã§ã®ãƒ†ã‚¹ãƒˆãŒå›°é›£
- ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹å½¢ã§ã®ãƒ†ã‚¹ãƒˆãŒä¸»ä½“ã¨ãªã‚‹
- æœ¬æ ¼çš„ãªE2Eãƒ†ã‚¹ãƒˆã¯ãƒ•ã‚§ãƒ¼ã‚º4ï¼ˆTASK-0030ï¼‰ã§å®Ÿæ–½

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

### é …ç›®åˆ¥ä¿¡é ¼æ€§

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 7 | 1 | 0 | 8 |
| ãƒ†ã‚¹ãƒˆè¦ä»¶ | 1 | 0 | 0 | 1 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 9é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 8é …ç›® (89%)
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›® (11%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
