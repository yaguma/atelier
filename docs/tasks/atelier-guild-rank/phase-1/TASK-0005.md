# TASK-0005: StateManagerå®Ÿè£…

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2026-01-16
**ãƒ•ã‚§ãƒ¼ã‚º**: 1 - åŸºç›¤æ§‹ç¯‰
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0004

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0005 |
| **ã‚¿ã‚¹ã‚¯å** | StateManagerå®Ÿè£… |
| **ã‚«ãƒ†ã‚´ãƒª** | åŸºç›¤æ§‹ç¯‰ |
| **å„ªå…ˆåº¦** | æœ€é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 StateManagerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/application/services/state-manager.interface.ts`:

```typescript
export interface IStateManager {
  // çŠ¶æ…‹å–å¾—
  getState(): GameState;

  // çŠ¶æ…‹æ›´æ–°
  updateState(partial: Partial<GameState>): void;

  // ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†
  setPhase(phase: GamePhase): void;
  canTransitionTo(phase: GamePhase): boolean;

  // æ—¥é€²è¡Œ
  advanceDay(): void;

  // ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
  spendActionPoints(amount: number): boolean;
  addGold(amount: number): void;
  spendGold(amount: number): boolean;

  // æ˜‡æ ¼ã‚²ãƒ¼ã‚¸
  addContribution(amount: number): void;

  // åˆæœŸåŒ–ãƒ»ãƒªã‚»ãƒƒãƒˆ
  initialize(initialState?: Partial<GameState>): void;
  reset(): void;

  // ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ç”¨
  loadFromSaveData(saveData: SaveData): void;
  exportToSaveData(): SaveData;
}
```

### 2.2 åˆæœŸçŠ¶æ…‹å®šç¾© ğŸ”µ

`src/application/services/initial-state.ts`:

```typescript
export const INITIAL_GAME_STATE: GameState = {
  currentRank: 'G',
  promotionGauge: 0,
  remainingDays: 30,
  gold: 100,
  actionPoints: 3,
  maxActionPoints: 3,
  currentPhase: 'quest_accept',
  currentDay: 1,
};
```

### 2.3 StateManagerå®Ÿè£… ğŸ”µ

`src/application/services/state-manager.ts`:

- çŠ¶æ…‹ã®ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ç®¡ç†
- ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
- ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã¨ã®é€£æºï¼ˆSTATE_CHANGED, PHASE_CHANGEDç­‰ï¼‰
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### 2.4 ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒ«ãƒ¼ãƒ« ğŸ”µ

```typescript
const VALID_TRANSITIONS: Record<GamePhase, GamePhase[]> = {
  'quest_accept': ['gathering'],
  'gathering': ['alchemy'],
  'alchemy': ['delivery'],
  'delivery': ['quest_accept'], // æ—¥çµ‚äº†å¾Œ
};
```

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [ ] çŠ¶æ…‹ã®å–å¾—ãƒ»æ›´æ–°ãŒã§ãã‚‹
- [ ] ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãŒæ­£ã—ãåˆ¶å¾¡ã•ã‚Œã‚‹
- [ ] ä¸æ­£ãªãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
- [ ] ãƒªã‚½ãƒ¼ã‚¹æ“ä½œãŒæ­£ã—ãå‹•ä½œã™ã‚‹

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [ ] çŠ¶æ…‹å¤‰æ›´æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0005-01 | åˆæœŸçŠ¶æ…‹ã®å–å¾— | INITIAL_STATEè¿”å´ |
| T-0005-02 | çŠ¶æ…‹æ›´æ–° | éƒ¨åˆ†æ›´æ–°ãŒåæ˜  |
| T-0005-03 | æœ‰åŠ¹ãªãƒ•ã‚§ãƒ¼ã‚ºé·ç§» | é·ç§»æˆåŠŸ |
| T-0005-04 | ç„¡åŠ¹ãªãƒ•ã‚§ãƒ¼ã‚ºé·ç§» | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ |
| T-0005-05 | APæ¶ˆè²»ï¼ˆååˆ†ãªå ´åˆï¼‰ | trueã€APæ¸›å°‘ |
| T-0005-06 | APæ¶ˆè²»ï¼ˆä¸è¶³æ™‚ï¼‰ | falseã€APå¤‰åŒ–ãªã— |
| T-0005-07 | ã‚´ãƒ¼ãƒ«ãƒ‰è¿½åŠ  | æ­£ã—ãåŠ ç®— |
| T-0005-08 | ã‚´ãƒ¼ãƒ«ãƒ‰æ¶ˆè²» | æ­£ã—ãæ¸›ç®— |
| T-0005-09 | æ—¥ã®é€²è¡Œ | day+1ã€APå›å¾© |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/application/services/state-manager.interface.ts` |
| åˆæœŸçŠ¶æ…‹ | `/src/application/services/initial-state.ts` |
| å®Ÿè£… | `/src/application/services/state-manager.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/services/state-manager.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©**: [../../design/atelier-guild-rank/interfaces.ts](../../design/atelier-guild-rank/interfaces.ts)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸**: [../../design/atelier-guild-rank/dataflow.md](../../design/atelier-guild-rank/dataflow.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
