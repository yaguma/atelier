# TASK-0004: ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹å®Ÿè£…

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2026-01-16
**ãƒ•ã‚§ãƒ¼ã‚º**: 1 - åŸºç›¤æ§‹ç¯‰
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0003

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0004 |
| **ã‚¿ã‚¹ã‚¯å** | ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹å®Ÿè£… |
| **ã‚«ãƒ†ã‚´ãƒª** | åŸºç›¤æ§‹ç¯‰ |
| **å„ªå…ˆåº¦** | æœ€é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾© ğŸ”µ

`src/application/events/event-types.ts`:

```typescript
export enum GameEventType {
  // çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
  STATE_CHANGED = 'state:changed',
  PHASE_CHANGED = 'phase:changed',
  DAY_STARTED = 'day:started',
  DAY_ENDED = 'day:ended',

  // ã‚«ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
  CARD_DRAWN = 'card:drawn',
  CARD_PLAYED = 'card:played',
  HAND_REFILLED = 'hand:refilled',

  // æ¡å–ã‚¤ãƒ™ãƒ³ãƒˆ
  GATHERING_STARTED = 'gathering:started',
  MATERIAL_SELECTED = 'material:selected',
  GATHERING_COMPLETED = 'gathering:completed',

  // èª¿åˆã‚¤ãƒ™ãƒ³ãƒˆ
  ALCHEMY_STARTED = 'alchemy:started',
  ITEM_CRAFTED = 'item:crafted',

  // ä¾é ¼ã‚¤ãƒ™ãƒ³ãƒˆ
  QUEST_ACCEPTED = 'quest:accepted',
  QUEST_DELIVERED = 'quest:delivered',
  QUEST_FAILED = 'quest:failed',

  // ãƒ©ãƒ³ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  RANK_PROMOTED = 'rank:promoted',
  PROMOTION_TEST_STARTED = 'promotion:test:started',

  // UI ã‚¤ãƒ™ãƒ³ãƒˆ
  UI_DIALOG_OPENED = 'ui:dialog:opened',
  UI_DIALOG_CLOSED = 'ui:dialog:closed',
}

export interface GameEvent<T = unknown> {
  type: GameEventType;
  payload: T;
  timestamp: number;
}
```

### 2.2 ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/application/events/event-bus.interface.ts`:

```typescript
export interface IEventBus {
  emit<T>(type: GameEventType, payload: T): void;
  on<T>(type: GameEventType, handler: (event: GameEvent<T>) => void): () => void;
  once<T>(type: GameEventType, handler: (event: GameEvent<T>) => void): void;
  off(type: GameEventType, handler: Function): void;
}
```

### 2.3 ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹å®Ÿè£… ğŸ”µ

`src/application/events/event-bus.ts`:

```typescript
export class EventBus implements IEventBus {
  private handlers: Map<GameEventType, Set<Function>> = new Map();

  emit<T>(type: GameEventType, payload: T): void {
    const event: GameEvent<T> = {
      type,
      payload,
      timestamp: Date.now(),
    };

    const typeHandlers = this.handlers.get(type);
    if (typeHandlers) {
      typeHandlers.forEach(handler => handler(event));
    }
  }

  on<T>(type: GameEventType, handler: (event: GameEvent<T>) => void): () => void {
    if (!this.handlers.has(type)) {
      this.handlers.set(type, new Set());
    }
    this.handlers.get(type)!.add(handler);

    return () => this.off(type, handler);
  }

  once<T>(type: GameEventType, handler: (event: GameEvent<T>) => void): void {
    const onceHandler = (event: GameEvent<T>) => {
      handler(event);
      this.off(type, onceHandler);
    };
    this.on(type, onceHandler);
  }

  off(type: GameEventType, handler: Function): void {
    this.handlers.get(type)?.delete(handler);
  }
}
```

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [ ] emit/on/once/offãƒ¡ã‚½ãƒƒãƒ‰ãŒå‹•ä½œã™ã‚‹
- [ ] å‹å®‰å…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã§ãã‚‹
- [ ] unsubscribeé–¢æ•°ã§è³¼èª­è§£é™¤ã§ãã‚‹

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›æ©Ÿèƒ½
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0004-01 | emitã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå‘¼ã°ã‚Œã‚‹ | ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè¡Œã•ã‚Œã‚‹ |
| T-0004-02 | onã§è¤‡æ•°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ² | å…¨ã¦å®Ÿè¡Œã•ã‚Œã‚‹ |
| T-0004-03 | onceã¯1å›ã®ã¿å®Ÿè¡Œ | 2å›ç›®ã¯å®Ÿè¡Œã•ã‚Œãªã„ |
| T-0004-04 | offã§è³¼èª­è§£é™¤ | è§£é™¤å¾Œã¯å®Ÿè¡Œã•ã‚Œãªã„ |
| T-0004-05 | æˆ»ã‚Šå€¤ã®unsubscribeã§è§£é™¤ | è§£é™¤å¾Œã¯å®Ÿè¡Œã•ã‚Œãªã„ |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| ã‚¤ãƒ™ãƒ³ãƒˆå‹å®šç¾© | `/src/application/events/event-types.ts` |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/application/events/event-bus.interface.ts` |
| å®Ÿè£… | `/src/application/events/event-bus.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/events/event-bus.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸**: [../../design/atelier-guild-rank/architecture-overview.md](../../design/atelier-guild-rank/architecture-overview.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸**: [../../design/atelier-guild-rank/dataflow.md](../../design/atelier-guild-rank/dataflow.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
