# TASK-0036: Vitest設定強化

**タスクID**: TASK-0036
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *architecture-overview.md v2.2.0より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **設計文書**: [📐 architecture-overview.md](../../../design/atelier-guild-rank/architecture-overview.md)

## タスク概要

Vitest 2.xを設定し、ユニットテスト環境を構築する。カバレッジ計測、テストユーティリティ、モック機能を含む包括的なテスト基盤を整備する。

## 依存タスク

- **前提タスク**: [TASK-0033: pnpm移行とBiome設定](TASK-0033.md)
- **後続タスク**: Phase 2以降のドメインロジックテスト

## 完了条件

- [ ] Vitest 2.xがインストールされている
- [ ] vitest.config.tsが設定済み
- [ ] カバレッジ計測が設定済み（@vitest/coverage-v8）
- [ ] `pnpm test` でテストが実行可能
- [ ] `pnpm test:coverage` でカバレッジレポートが生成される
- [ ] サンプルテストが正常に動作する

---

## 実装詳細

### 1. Vitestインストール 🔵

**信頼性**: 🔵 *architecture-overview.md セクション1.3より*

```bash
pnpm add -D vitest @vitest/coverage-v8 @vitest/ui
```

### 2. vitest.config.ts作成 🔵

**信頼性**: 🔵 *architecture-overview.md セクション1.3より*

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    include: ['src/**/*.{test,spec}.{ts,tsx}', 'tests/**/*.{test,spec}.{ts,tsx}'],
    exclude: ['node_modules', 'dist', 'e2e/**/*'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      reportsDirectory: './coverage',
      include: ['src/**/*.ts'],
      exclude: [
        'src/**/*.d.ts',
        'src/**/*.test.ts',
        'src/**/*.spec.ts',
        'src/main.ts',
      ],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80,
        },
      },
    },
    setupFiles: ['./tests/setup.ts'],
  },
});
```

**実装ファイル**: `vitest.config.ts`

### 3. テストセットアップファイル作成 🔵

**信頼性**: 🔵 *標準的なVitest設定*

```typescript
// tests/setup.ts
import { vi } from 'vitest';

// グローバルモックの設定
vi.mock('phaser', () => ({
  Game: vi.fn(),
  Scene: vi.fn(),
  AUTO: 'AUTO',
}));

// LocalStorageモック
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
};
vi.stubGlobal('localStorage', localStorageMock);

// requestAnimationFrameモック
vi.stubGlobal('requestAnimationFrame', (callback: FrameRequestCallback) => {
  return setTimeout(() => callback(Date.now()), 0);
});
```

**実装ファイル**: `tests/setup.ts`

### 4. TypeScript設定更新 🟡

**信頼性**: 🟡 *プロジェクト状況による*

```json
// tsconfig.json に追加
{
  "compilerOptions": {
    "types": ["vitest/globals"]
  }
}
```

### 5. package.jsonスクリプト確認 🔵

**信頼性**: 🔵 *TASK-0033で設定済み*

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:watch": "vitest --watch"
  }
}
```

**実装ファイル**: `package.json`

### 6. サンプルテスト作成 🔵

**信頼性**: 🔵 *動作確認用*

```typescript
// tests/sample.test.ts
import { describe, it, expect } from 'vitest';

describe('Sample Test Suite', () => {
  it('should pass a simple test', () => {
    expect(1 + 1).toBe(2);
  });

  it('should handle arrays', () => {
    const arr = [1, 2, 3];
    expect(arr).toHaveLength(3);
    expect(arr).toContain(2);
  });

  it('should handle objects', () => {
    const obj = { name: 'test', value: 42 };
    expect(obj).toHaveProperty('name');
    expect(obj.value).toBeGreaterThan(0);
  });
});
```

**実装ファイル**: `tests/sample.test.ts`

---

## テスト要件

### 動作確認テスト 🔵

**信頼性**: 🔵 *標準的な動作確認*

1. **テスト実行確認**
   - `pnpm test` でテストが実行される
   - `pnpm test:ui` でブラウザUIが起動する
   - `pnpm test:watch` でウォッチモードが動作する

2. **カバレッジ確認**
   - `pnpm test:coverage` でカバレッジレポートが生成される
   - `coverage/` ディレクトリにHTMLレポートが出力される

3. **モック確認**
   - Phaserモックが正常に動作する
   - localStorageモックが正常に動作する

---

## 実装手順

### DIRECTタスク

1. `/tsumiki:direct-setup` - Vitest設定
2. `/tsumiki:direct-verify` - 動作確認

---

## 注意事項

- Phaserはブラウザ環境を前提としているため、jsdom環境でのモックが必要
- カバレッジ閾値80%は設計書の要件に基づく
- E2Eテストは別途Playwrightで実施（TASK-0037）

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 5 | 1 | 0 | 6 |
| テスト要件 | 1 | 0 | 0 | 1 |

### 全体評価

- **総項目数**: 7項目
- 🔵 **青信号**: 6項目 (86%)
- 🟡 **黄信号**: 1項目 (14%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
