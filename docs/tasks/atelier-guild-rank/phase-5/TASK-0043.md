# TASK-0043: 依頼詳細モーダル・受注アニメーション

**タスクID**: TASK-0043
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 5 - UI強化・ポリッシュ
**信頼性レベル**: 🟡 *TASK-0022の推奨条件より*

## 関連文書

- **概要**: [📋 overview.md](../overview.md)
- **元タスク**: [📋 TASK-0022.md](../phase-3/TASK-0022.md) - 依頼受注フェーズUI推奨条件
- **UI設計**: [📐 ui-design/screens/quest-accept.md](../../design/atelier-guild-rank/ui-design/screens/quest-accept.md)

## タスク概要

依頼カードをクリックした際に詳細情報を表示するモーダルと、依頼受注時のアニメーションを実装する。ユーザーが依頼内容を十分に理解してから受注できるようにする。

## 依存タスク

- **前提タスク**: [TASK-0022: 依頼受注フェーズUI](../phase-3/TASK-0022.md) ✅完了
- **後続タスク**: なし（独立タスク）

## 完了条件

- [x] 依頼詳細モーダル実装
- [x] モーダル開閉アニメーション
- [x] 受注成功アニメーション
- [x] 受注後のカード移動アニメーション
- [x] 単体テスト実装

---

## 実装詳細

### 1. 依頼詳細モーダル 🟡

**信頼性**: 🟡 *TASK-0022設計から推測*

**実装ファイル**: `src/presentation/ui/components/QuestDetailModal.ts`

```typescript
export interface QuestDetailModalConfig {
  quest: Quest;
  onAccept: (quest: Quest) => void;
  onClose: () => void;
}

export class QuestDetailModal extends BaseComponent {
  private overlay!: Phaser.GameObjects.Rectangle;
  private panel!: Phaser.GameObjects.Container;

  constructor(scene: Phaser.Scene, private config: QuestDetailModalConfig) {
    super(scene, 0, 0);
  }

  create(): void {
    this.createOverlay();
    this.createPanel();
    this.createContent();
    this.createButtons();
    this.playOpenAnimation();
  }

  private createContent(): void {
    const { quest } = this.config;

    // 依頼者情報
    this.addText('依頼者', this.getClientIcon(quest.client.type) + ' ' + quest.client.name);

    // 依頼内容
    this.addText('依頼内容', this.formatRequirements(quest.requirements));

    // 期限
    this.addText('期限', `${quest.deadline}日以内`);

    // 報酬詳細
    this.addText('報酬', `${quest.reward.gold}G / 貢献度 +${quest.reward.contribution}`);

    // 難易度表示
    this.addText('難易度', this.getDifficultyStars(quest));
  }

  private formatRequirements(reqs: QuestRequirement[]): string {
    return reqs.map(req =>
      `${req.itemName} ×${req.quantity} (${req.minQuality}品質以上)`
    ).join('\n');
  }
}
```

### 2. モーダル開閉アニメーション 🟡

**信頼性**: 🟡 *標準的なUIパターンから推測*

```typescript
private playOpenAnimation(): void {
  // オーバーレイフェードイン
  this.overlay.setAlpha(0);
  this.scene.tweens.add({
    targets: this.overlay,
    alpha: 0.7,
    duration: 200,
  });

  // パネルスケールイン
  this.panel.setScale(0.8);
  this.panel.setAlpha(0);
  this.scene.tweens.add({
    targets: this.panel,
    scale: 1,
    alpha: 1,
    duration: 300,
    ease: 'Back.easeOut',
  });
}

close(): void {
  // パネルスケールアウト
  this.scene.tweens.add({
    targets: this.panel,
    scale: 0.8,
    alpha: 0,
    duration: 200,
    ease: 'Power2',
  });

  // オーバーレイフェードアウト
  this.scene.tweens.add({
    targets: this.overlay,
    alpha: 0,
    duration: 200,
    onComplete: () => {
      this.destroy();
      this.config.onClose();
    },
  });
}
```

### 3. 受注成功アニメーション 🟡

**信頼性**: 🟡 *標準的なUIパターンから推測*

```typescript
private playAcceptAnimation(callback: () => void): void {
  // 成功エフェクト
  const successText = this.scene.add.text(
    this.panel.x,
    this.panel.y,
    '受注完了！',
    {
      fontSize: '32px',
      color: '#00FF00',
      fontStyle: 'bold',
    }
  ).setOrigin(0.5);

  // スケールアップ＆フェードアウト
  this.scene.tweens.add({
    targets: successText,
    scale: 1.5,
    alpha: 0,
    y: this.panel.y - 50,
    duration: 500,
    onComplete: () => {
      successText.destroy();
      callback();
    },
  });

  // パネルを縮小しながら消える
  this.scene.tweens.add({
    targets: this.panel,
    scale: 0,
    alpha: 0,
    duration: 300,
    delay: 200,
  });
}
```

### 4. カード移動アニメーション 🟡

**信頼性**: 🟡 *TASK-0022実装から推測*

**実装ファイル**: `src/presentation/ui/phases/QuestAcceptPhaseUI.ts`

```typescript
// 受注後にカードをサイドバーへ移動するアニメーション
private animateCardToSidebar(card: QuestCardUI, targetY: number): void {
  const sidebarX = 80; // サイドバーのX座標

  this.scene.tweens.add({
    targets: card.container,
    x: sidebarX,
    y: targetY,
    scale: 0.6,
    duration: 400,
    ease: 'Power2',
    onComplete: () => {
      this.updateSidebarList();
    },
  });
}
```

---

## 単体テスト要件

### テストケース1: モーダル表示 🟡

**信頼性**: 🟡 *標準的なテストパターン*

**Given**: 依頼カードが存在
**When**: カードをクリック
**Then**: 詳細モーダルがアニメーション付きで表示される

### テストケース2: 受注処理 🟡

**信頼性**: 🟡 *標準的なテストパターン*

**Given**: 詳細モーダルが表示されている
**When**: 受注ボタンをクリック
**Then**: onAcceptコールバックが呼ばれ、受注アニメーションが再生される

### テストケース3: モーダル閉じる 🟡

**信頼性**: 🟡 *標準的なテストパターン*

**Given**: 詳細モーダルが表示されている
**When**: 閉じるボタンまたはオーバーレイをクリック
**Then**: モーダルがアニメーション付きで閉じる

---

## 実装手順

### TDDタスクの場合

1. `/tsumiki:tdd-requirements TASK-0043` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- モーダル表示中は背景の操作を無効化する
- ESCキーでモーダルを閉じられるようにする
- アニメーション中の重複クリックを防止する

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 0 | 4 | 0 | 4 |
| 単体テスト | 0 | 3 | 0 | 3 |

### 全体評価

- **総項目数**: 7項目
- 🔵 **青信号**: 0項目 (0%)
- 🟡 **黄信号**: 7項目 (100%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: 高品質
