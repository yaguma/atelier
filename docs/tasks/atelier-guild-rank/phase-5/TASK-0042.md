# TASK-0042: ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½

**ã‚¿ã‚¹ã‚¯ID**: TASK-0042
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - UIå¼·åŒ–ãƒ»ãƒãƒªãƒƒã‚·ãƒ¥
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *TASK-0021ã®æ¨å¥¨æ¡ä»¶ã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](../overview.md)
- **å…ƒã‚¿ã‚¹ã‚¯**: [ğŸ“‹ TASK-0021.md](../phase-3/TASK-0021.md) - ã‚«ãƒ¼ãƒ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¨å¥¨æ¡ä»¶
- **UIè¨­è¨ˆ**: [ğŸ“ ui-design/overview.md](../../design/atelier-guild-rank/ui-design/overview.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚«ãƒ¼ãƒ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã€‚æ‰‹æœ­ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ã¸ã®ã‚«ãƒ¼ãƒ‰ç§»å‹•ã€èª¿åˆç”»é¢ã§ã®ç´ æé…ç½®ãªã©ã§ä½¿ç”¨ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0021: ã‚«ãƒ¼ãƒ‰UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](../phase-3/TASK-0021.md) âœ…å®Œäº†
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—ï¼ˆç‹¬ç«‹ã‚¿ã‚¹ã‚¯ï¼‰

## å®Œäº†æ¡ä»¶

- [x] ã‚«ãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹/ç§»å‹•/çµ‚äº†å‡¦ç†
- [x] ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®å®šç¾©ã¨åˆ¤å®š
- [x] ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- [x] ãƒ‰ãƒ­ãƒƒãƒ—æˆåŠŸ/å¤±æ•—ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè£…

---

## å®Ÿè£…è©³ç´°

### 1. ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã‚«ãƒ¼ãƒ‰UI ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *TASK-0021å®Ÿè£…ã‹ã‚‰æ¨æ¸¬*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/ui/components/DraggableCardUI.ts`

```typescript
export interface DraggableCardConfig extends CardUIConfig {
  onDragStart?: (card: Card) => void;
  onDrag?: (card: Card, x: number, y: number) => void;
  onDrop?: (card: Card, zone: DropZone | null) => void;
}

export class DraggableCardUI extends CardUI {
  private isDragging = false;
  private startPosition: { x: number; y: number } = { x: 0, y: 0 };
  private dragOffset: { x: number; y: number } = { x: 0, y: 0 };

  protected setupInteraction(): void {
    super.setupInteraction();

    if (!this.config.interactive) return;

    this.background.setInteractive({ draggable: true });

    this.scene.input.on('dragstart', this.onDragStart, this);
    this.scene.input.on('drag', this.onDrag, this);
    this.scene.input.on('dragend', this.onDragEnd, this);
  }

  private onDragStart(pointer: Phaser.Input.Pointer): void {
    this.isDragging = true;
    this.startPosition = { x: this.container.x, y: this.container.y };
    this.dragOffset = {
      x: this.container.x - pointer.x,
      y: this.container.y - pointer.y,
    };

    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šåŠ¹æœ
    this.container.setScale(1.1);
    this.container.setAlpha(0.8);
    this.container.setDepth(100);

    this.config.onDragStart?.(this.card);
  }

  private onDrag(pointer: Phaser.Input.Pointer): void {
    if (!this.isDragging) return;

    this.container.setPosition(
      pointer.x + this.dragOffset.x,
      pointer.y + this.dragOffset.y
    );

    this.config.onDrag?.(this.card, this.container.x, this.container.y);
  }

  private onDragEnd(pointer: Phaser.Input.Pointer): void {
    if (!this.isDragging) return;

    this.isDragging = false;
    this.container.setScale(1);
    this.container.setAlpha(1);
    this.container.setDepth(0);

    const zone = this.findDropZone(pointer.x, pointer.y);

    if (zone) {
      this.config.onDrop?.(this.card, zone);
    } else {
      // å…ƒã®ä½ç½®ã«æˆ»ã™
      this.scene.tweens.add({
        targets: this.container,
        x: this.startPosition.x,
        y: this.startPosition.y,
        duration: 200,
        ease: 'Power2',
      });
      this.config.onDrop?.(this.card, null);
    }
  }
}
```

### 2. ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ç®¡ç† ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªD&Dãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ¨æ¸¬*

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/presentation/ui/components/DropZone.ts`

```typescript
export interface DropZone {
  id: string;
  bounds: Phaser.Geom.Rectangle;
  accepts: (card: Card) => boolean;
  onDrop: (card: Card) => void;
}

export class DropZoneManager {
  private zones: Map<string, DropZone> = new Map();

  registerZone(zone: DropZone): void {
    this.zones.set(zone.id, zone);
  }

  unregisterZone(id: string): void {
    this.zones.delete(id);
  }

  findZoneAt(x: number, y: number): DropZone | null {
    for (const zone of this.zones.values()) {
      if (zone.bounds.contains(x, y)) {
        return zone;
      }
    }
    return null;
  }

  highlightValidZones(card: Card): void {
    for (const zone of this.zones.values()) {
      if (zone.accepts(card)) {
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
      }
    }
  }
}
```

### 3. ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªUIãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ¨æ¸¬*

```typescript
// ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ã‚¾ãƒ¼ãƒ³ä¸Šã§ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
private updateDropZoneHighlight(x: number, y: number): void {
  const zone = DropZoneManager.getInstance().findZoneAt(x, y);

  if (zone && zone.accepts(this.card)) {
    // ç·‘è‰²ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    zone.highlight?.setVisible(true);
    zone.highlight?.setStrokeStyle(3, 0x00FF00);
  } else if (zone) {
    // èµ¤è‰²ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ä¸å¯ï¼‰
    zone.highlight?.setVisible(true);
    zone.highlight?.setStrokeStyle(3, 0xFF0000);
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

**Given**: ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨
**When**: ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
**Then**: onDragStartã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã€è¦–è¦šåŠ¹æœãŒé©ç”¨ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒ‰ãƒ­ãƒƒãƒ—æˆåŠŸ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

**Given**: æœ‰åŠ¹ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ä¸Šã§ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
**When**: ãƒ‰ãƒ­ãƒƒãƒ—
**Then**: onDropã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚¾ãƒ¼ãƒ³æƒ…å ±ã¨å…±ã«å‘¼ã°ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒ‰ãƒ­ãƒƒãƒ—å¤±æ•—ï¼ˆå…ƒã®ä½ç½®ã«æˆ»ã‚‹ï¼‰ ğŸŸ¡

**ä¿¡é ¼æ€§**: ğŸŸ¡ *æ¨™æº–çš„ãªãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³*

**Given**: ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³å¤–ã§ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
**When**: ãƒ‰ãƒ­ãƒƒãƒ—
**Then**: ã‚«ãƒ¼ãƒ‰ãŒå…ƒã®ä½ç½®ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§æˆ»ã‚‹

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ

1. `/tsumiki:tdd-requirements TASK-0042` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œã‚‚è€ƒæ…®ã™ã‚‹
- ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ä»–ã®å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã€ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å‡¦ç†ã‚’æœ€é©åŒ–ã™ã‚‹

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

### é …ç›®åˆ¥ä¿¡é ¼æ€§

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 0 | 3 | 0 | 3 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 0 | 3 | 0 | 3 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 6é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›® (0%)
- ğŸŸ¡ **é»„ä¿¡å·**: 6é …ç›® (100%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
