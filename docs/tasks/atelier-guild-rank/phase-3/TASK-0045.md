# TASK-0045: 調合フェーズUI実装（再実装）

**バージョン**: 1.0.0
**作成日**: 2026-01-21
**フェーズ**: 3 - UI層
**見積時間**: 4時間（半日）
**依存タスク**: TASK-0018, TASK-0012
**タイプ**: TDD

---

## 1. タスク概要

| 項目 | 値 |
|------|-----|
| **タスクID** | TASK-0045 |
| **タスク名** | 調合フェーズUI実装（再実装） |
| **カテゴリ** | UI層 |
| **優先度** | 最高 |
| **担当レイヤー** | Presentation |

### 背景

TASK-0024（調合フェーズUI）は完了とマークされていたが、実際にはAlchemyPhaseUI.tsファイルが存在しない。
本タスクはTASK-0024の内容を再実装するものである。

### 信頼性レベル

- 🔵 **青信号**: 設計文書に記載
- 🟡 **黄信号**: 設計文書から妥当な推測
- 🔴 **赤信号**: 設計文書にない推測

---

## 2. 実装内容

### 2.1 調合画面レイアウト 🔵

```
┌─────────────────────────────────────────────────────────────────┐
│                    🧪 調合フェーズ                              │
│                                                                 │
│  ┌─────────────────────┐    ┌─────────────────────────────────┐│
│  │    レシピ一覧       │    │       調合エリア               ││
│  │                     │    │                                 ││
│  │  ▶ 回復薬          │    │   素材スロット:                 ││
│  │    植物×1          │    │   [   ] + [   ] + [   ]         ││
│  │                     │    │                                 ││
│  │  ▷ 爆弾            │    │   ─────────────────────         ││
│  │    鉱物×1, 火薬×1   │    │                                 ││
│  │                     │    │   完成予測: 回復薬 (B品質)      ││
│  │  ▷ 鋼の剣          │    │                                 ││
│  │    鉱物×2          │    │   [調合する]                    ││
│  │                     │    │                                 ││
│  └─────────────────────┘    └─────────────────────────────────┘│
│                                                                 │
│  所持素材: [薬草C] [薬草B] [鉄鉱A] [花D]                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 AlchemyPhaseUI 🔵

`src/presentation/ui/phases/AlchemyPhaseUI.ts`:

```typescript
export class AlchemyPhaseUI extends BaseComponent {
  private recipeList: RecipeListUI;
  private materialSlots: MaterialSlotUI[] = [];
  private previewText: Phaser.GameObjects.Text;
  private craftButton: Button;
  private inventoryDisplay: Phaser.GameObjects.Container;

  private selectedRecipe: ItemMaster | null = null;
  private selectedMaterials: MaterialInstance[] = [];

  constructor(
    scene: Phaser.Scene,
    private alchemyService: IAlchemyService,
    private inventoryService: IInventoryService,
    onCraftComplete?: (item: ItemInstance) => void,
  ) {
    super(scene, x, y);
  }

  create(): void {
    this.createTitle();
    this.createRecipeList();
    this.createAlchemyArea();
    this.createMaterialInventory();
    this.createCraftButton();
  }

  private createRecipeList(): void {
    // 調合可能なレシピをリスト表示
  }

  private onRecipeSelect(recipe: ItemMaster): void {
    this.selectedRecipe = recipe;
    this.selectedMaterials = [];
    this.updateMaterialSlots();
    this.updatePreview();
  }

  private onMaterialSelect(slot: number, material: MaterialInstance): void {
    this.selectedMaterials[slot] = material;
    this.updatePreview();
  }

  private updatePreview(): void {
    // 品質プレビューを更新
  }

  private onCraft(): void {
    // 調合実行
  }
}
```

### 2.3 RecipeListUI 🔵

`src/presentation/ui/components/RecipeListUI.ts`:

```typescript
export class RecipeListUI extends BaseComponent {
  private recipes: ItemMaster[] = [];
  private recipeItems: RecipeItemUI[] = [];
  private selectedIndex: number = -1;
  private onSelectCallback?: (recipe: ItemMaster) => void;

  constructor(
    scene: Phaser.Scene,
    x: number,
    y: number,
    recipes: ItemMaster[],
    onSelect?: (recipe: ItemMaster) => void,
  ) {
    super(scene, x, y);
    this.recipes = recipes;
    this.onSelectCallback = onSelect;
  }

  create(): void {
    // レシピアイテムを縦に並べて表示
  }

  private onRecipeClick(index: number): void {
    this.selectedIndex = index;
    this.updateSelection();
    if (this.onSelectCallback && this.recipes[index]) {
      this.onSelectCallback(this.recipes[index]);
    }
  }
}
```

---

## 3. 受け入れ基準

### 3.1 必須条件 🔵

- [ ] AlchemyPhaseUI.tsファイルが作成される
- [ ] レシピ一覧が表示される
- [ ] 素材を選択・配置できる
- [ ] 完成品質がプレビューされる
- [ ] 調合が実行できる
- [ ] 調合後に素材が消費される

### 3.2 推奨条件 🟡

- [ ] レシピフィルタリング機能
- [ ] 調合エフェクト/アニメーション
- [ ] 素材不足時の警告表示

---

## 4. テストケース

### 4.1 ユニットテスト

| テストID | テスト内容 | 期待結果 |
|---------|----------|----------|
| T-0045-01 | AlchemyPhaseUI初期化 | 正常に初期化される |
| T-0045-02 | レシピ選択 | 選択状態が変わり、素材スロットが更新される |
| T-0045-03 | 素材選択 | スロットに素材が配置される |
| T-0045-04 | 品質プレビュー | 正しい品質が表示される |
| T-0045-05 | 調合実行 | アイテムが生成され、素材が消費される |
| T-0045-06 | 素材不足 | 調合ボタンが無効化される |

---

## 5. 成果物

| 成果物 | パス |
|--------|------|
| フェーズUI | `/src/presentation/ui/phases/AlchemyPhaseUI.ts` |
| レシピリスト | `/src/presentation/ui/components/RecipeListUI.ts` |
| テスト | `/tests/unit/presentation/alchemy-phase-ui.test.ts` |

---

## 6. 参考資料

- **TASK-0024**: 元の調合フェーズUIタスク定義
- **GatheringPhaseUI.ts**: 採取フェーズUIの実装パターン参照
- **DeliveryPhaseUI.ts**: 納品フェーズUIの実装パターン参照
- **AlchemyService**: 調合ロジックのインターフェース

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-01-21 | 1.0.0 | 初版作成（TASK-0024再実装タスク） |
