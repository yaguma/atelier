# TASK-0014: ContributionCalculatorãƒ»RankServiceå®Ÿè£…

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2026-01-16
**ãƒ•ã‚§ãƒ¼ã‚º**: 2 - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãƒ»ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0005, TASK-0013

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0014 |
| **ã‚¿ã‚¹ã‚¯å** | ContributionCalculatorãƒ»RankServiceå®Ÿè£… |
| **ã‚«ãƒ†ã‚´ãƒª** | ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ |
| **å„ªå…ˆåº¦** | é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Domain, Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 è²¢çŒ®åº¦è¨ˆç®—å¼ ğŸ”µ

```
æœ€çµ‚è²¢çŒ®åº¦ = åŸºç¤è²¢çŒ®åº¦ Ã— å“è³ªè£œæ­£ Ã— ä¾é ¼è€…è£œæ­£ Ã— ã‚³ãƒ³ãƒœè£œæ­£

å“è³ªè£œæ­£:
- D: 0.5
- C: 0.75
- B: 1.0
- A: 1.5
- S: 2.0

ä¾é ¼è€…è£œæ­£:
- villager: 1.0
- adventurer: 1.1
- merchant: 1.2
- noble: 1.3
- guild: 1.5

ã‚³ãƒ³ãƒœè£œæ­£:
- åŒæ—¥è¤‡æ•°ç´å“: 1 + 0.1 Ã— (ç´å“æ•° - 1)
```

### 2.2 ContributionCalculator ğŸ”µ

`src/domain/services/contribution-calculator.ts`:

```typescript
export class ContributionCalculator {
  calculate(delivery: DeliveryContext): number {
    const base = delivery.quest.reward.contribution;
    const qualityMod = this.getQualityModifier(delivery.itemQuality);
    const clientMod = this.getClientModifier(delivery.quest.clientType);
    const comboMod = this.getComboModifier(delivery.deliveryCount);

    return Math.floor(base * qualityMod * clientMod * comboMod);
  }

  private getQualityModifier(quality: Quality): number {
    const modifiers: Record<Quality, number> = {
      'D': 0.5,
      'C': 0.75,
      'B': 1.0,
      'A': 1.5,
      'S': 2.0,
    };
    return modifiers[quality];
  }

  private getClientModifier(clientType: ClientType): number {
    const modifiers: Record<ClientType, number> = {
      'villager': 1.0,
      'adventurer': 1.1,
      'merchant': 1.2,
      'noble': 1.3,
      'guild': 1.5,
    };
    return modifiers[clientType];
  }

  private getComboModifier(deliveryCount: number): number {
    return 1 + 0.1 * (deliveryCount - 1);
  }
}
```

### 2.3 RankServiceã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/domain/interfaces/rank-service.interface.ts`:

```typescript
export interface IRankService {
  // ãƒ©ãƒ³ã‚¯æ“ä½œ
  getCurrentRank(): GuildRank;
  getPromotionGauge(): number;
  addContribution(amount: number): void;

  // æ˜‡æ ¼åˆ¤å®š
  canPromote(): boolean;
  promote(): PromotionResult;

  // æ˜‡æ ¼è©¦é¨“
  startPromotionTest(): PromotionTest;
  completePromotionTest(success: boolean): void;

  // ãƒ©ãƒ³ã‚¯æƒ…å ±å–å¾—
  getRankRequirements(rank: GuildRank): GuildRankMaster;
  getNextRank(): GuildRank | null;
}

export interface PromotionResult {
  previousRank: GuildRank;
  newRank: GuildRank;
  bonusReward: number;
}
```

### 2.4 RankServiceå®Ÿè£… ğŸ”µ

`src/application/services/rank-service.ts`:

- æ˜‡æ ¼ã‚²ãƒ¼ã‚¸ç®¡ç†
- æ˜‡æ ¼æ¡ä»¶ãƒã‚§ãƒƒã‚¯
- æ˜‡æ ¼å‡¦ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [x] è²¢çŒ®åº¦è¨ˆç®—ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [x] å“è³ªãƒ»ä¾é ¼è€…ãƒ»ã‚³ãƒ³ãƒœè£œæ­£ãŒé©ç”¨ã•ã‚Œã‚‹
- [x] æ˜‡æ ¼ã‚²ãƒ¼ã‚¸ãŒ100åˆ°é”ã§æ˜‡æ ¼å¯èƒ½
- [x] Gâ†’Fâ†’E...â†’Sã®é †ã§æ˜‡æ ¼ã™ã‚‹

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [x] æ˜‡æ ¼æ™‚ã®ãƒœãƒ¼ãƒŠã‚¹å ±é…¬
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0014-01 | è²¢çŒ®åº¦è¨ˆç®—ï¼ˆåŸºæœ¬ï¼‰ | åŸºç¤å€¤ã®ã¿ |
| T-0014-02 | å“è³ªè£œæ­£é©ç”¨ | Så“è³ªã§2å€ |
| T-0014-03 | ä¾é ¼è€…è£œæ­£é©ç”¨ | guildä¾é ¼ã§1.5å€ |
| T-0014-04 | ã‚³ãƒ³ãƒœè£œæ­£é©ç”¨ | 3å›ç´å“ã§1.2å€ |
| T-0014-05 | æ˜‡æ ¼å¯èƒ½åˆ¤å®š | ã‚²ãƒ¼ã‚¸100ä»¥ä¸Šã§true |
| T-0014-06 | æ˜‡æ ¼å‡¦ç† | ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã€ã‚²ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| è²¢çŒ®åº¦è¨ˆç®— | `/src/domain/services/contribution-calculator.ts` |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/domain/interfaces/rank-service.interface.ts` |
| å®Ÿè£… | `/src/application/services/rank-service.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/domain/services/contribution-calculator.test.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/services/rank-service.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/game-mechanics.md](../../design/atelier-guild-rank/game-mechanics.md)
- **ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/core-systems-core-services.md](../../design/atelier-guild-rank/core-systems-core-services.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
| 2026-01-18 | 1.1.0 | StateManager.addContributionå®Ÿè£…å®Œäº†ã€IGameStateã«promotionGaugeè¿½åŠ  |
