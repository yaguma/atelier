# TASK-0011: GatheringServiceå®Ÿè£…ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–ï¼‰

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2026-01-16
**ãƒ•ã‚§ãƒ¼ã‚º**: 2 - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãƒ»ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0009, TASK-0010

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0011 |
| **ã‚¿ã‚¹ã‚¯å** | GatheringServiceå®Ÿè£…ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–ï¼‰ |
| **ã‚«ãƒ†ã‚´ãƒª** | ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ |
| **å„ªå…ˆåº¦** | æœ€é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 ãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦ ğŸ”µ

1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚«ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦APæ¶ˆè²»
2. ç´ æãƒ—ãƒ¼ãƒ«ï¼ˆ6ã¤ï¼‰ã‹ã‚‰1ã¤é¸æŠ
3. é¸æŠã—ãŸç´ æã‚’ç²å¾—ã€ãƒ—ãƒ¼ãƒ«ã¯1ã¤æ¸›å°‘
4. æ®‹ã‚Šãƒ—ãƒ¼ãƒ«ã‹ã‚‰å†åº¦é¸æŠã‚’ç¹°ã‚Šè¿”ã™
5. ãƒ—ãƒ¼ãƒ«æ¯æ¸‡ã¾ãŸã¯æ¡å–çµ‚äº†ã§å®Œäº†

### 2.2 GatheringServiceã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/domain/interfaces/gathering-service.interface.ts`:

```typescript
export interface IGatheringService {
  // ãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–é–‹å§‹
  startDraftGathering(card: Card): MaterialPool;

  // ç´ æé¸æŠ
  selectMaterial(poolIndex: number): MaterialInstance;

  // çŠ¶æ…‹å–å¾—
  getCurrentPool(): MaterialPool;
  getRemainingSelections(): number;
  isGatheringActive(): boolean;

  // æ¡å–ã‚³ã‚¹ãƒˆè¨ˆç®—
  calculateGatheringCost(card: Card): number;

  // æ¡å–çµ‚äº†
  endGathering(): MaterialInstance[];
}

export interface MaterialPool {
  materials: MaterialInstance[];
  maxSelections: number;
  currentSelections: number;
}
```

### 2.3 GatheringServiceå®Ÿè£… ğŸ”µ

`src/application/services/gathering-service.ts`:

```typescript
export class GatheringService implements IGatheringService {
  private currentPool: MaterialPool | null = null;
  private gatheredMaterials: MaterialInstance[] = [];

  constructor(
    private materialService: IMaterialService,
    private masterDataRepo: IMasterDataRepository,
    private eventBus: IEventBus,
  ) {}

  startDraftGathering(card: Card): MaterialPool {
    // ã‚«ãƒ¼ãƒ‰åŠ¹æœã«åŸºã¥ã„ã¦ãƒ—ãƒ¼ãƒ«ç”Ÿæˆ
    const poolSize = 6;
    const maxSelections = card.effect.gatheringCount ?? 3;

    const materials = this.generateMaterialPool(poolSize, card);

    this.currentPool = {
      materials,
      maxSelections,
      currentSelections: 0,
    };

    this.eventBus.emit(GameEventType.GATHERING_STARTED, {
      pool: this.currentPool,
    });

    return this.currentPool;
  }

  selectMaterial(poolIndex: number): MaterialInstance {
    if (!this.currentPool) {
      throw new Error('No active gathering session');
    }

    const material = this.currentPool.materials[poolIndex];
    this.gatheredMaterials.push(material);

    // ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å‰Šé™¤
    this.currentPool.materials.splice(poolIndex, 1);
    this.currentPool.currentSelections++;

    this.eventBus.emit(GameEventType.MATERIAL_SELECTED, { material });

    return material;
  }

  // ... ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
}
```

### 2.4 ç´ æãƒ—ãƒ¼ãƒ«ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ğŸ”µ

- ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸç´ æå€™è£œãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹ç´ æã‚«ãƒ†ã‚´ãƒªé‡ã¿ä»˜ã‘
- å“è³ªã®ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [ ] ãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–ãŒé–‹å§‹ã§ãã‚‹
- [ ] ç´ æãƒ—ãƒ¼ãƒ«ã‹ã‚‰é¸æŠã§ãã‚‹
- [ ] é¸æŠã—ãŸç´ æãŒã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ ã•ã‚Œã‚‹
- [ ] é¸æŠå›æ•°åˆ¶é™ãŒæ©Ÿèƒ½ã™ã‚‹

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [ ] ã‚«ãƒ¼ãƒ‰åŠ¹æœã«ã‚ˆã‚‹æ¡å–æ•°å¤‰å‹•
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0011-01 | ãƒ‰ãƒ©ãƒ•ãƒˆæ¡å–é–‹å§‹ | ãƒ—ãƒ¼ãƒ«6å€‹ç”Ÿæˆ |
| T-0011-02 | ç´ æé¸æŠ | ãƒ—ãƒ¼ãƒ«-1ã€ç²å¾—+1 |
| T-0011-03 | é¸æŠå›æ•°ä¸Šé™ | ä¸Šé™åˆ°é”ã§é¸æŠä¸å¯ |
| T-0011-04 | æ¡å–çµ‚äº† | ç²å¾—ç´ æãƒªã‚¹ãƒˆè¿”å´ |
| T-0011-05 | ã‚«ãƒ¼ãƒ‰åŠ¹æœé©ç”¨ | æ¡å–æ•°ãŒåŠ¹æœé€šã‚Š |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/domain/interfaces/gathering-service.interface.ts` |
| å®Ÿè£… | `/src/application/services/gathering-service.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/services/gathering-service.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/game-mechanics.md](../../design/atelier-guild-rank/game-mechanics.md)
- **ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/core-systems-core-services.md](../../design/atelier-guild-rank/core-systems-core-services.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
