# TASK-0012: ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»AlchemyServiceå®Ÿè£… âœ… **å®Œäº†** (TDDé–‹ç™ºå®Œäº† - 47ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨é€šé)

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.1
**ä½œæˆæ—¥**: 2026-01-16
**å®Œäº†æ—¥**: 2026-01-17
**ãƒ•ã‚§ãƒ¼ã‚º**: 2 - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãƒ»ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0010

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0012 |
| **ã‚¿ã‚¹ã‚¯å** | ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ»AlchemyServiceå®Ÿè£… |
| **ã‚«ãƒ†ã‚´ãƒª** | ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ |
| **å„ªå…ˆåº¦** | æœ€é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Domain, Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ ğŸ”µ

`src/domain/entities/ItemInstance.ts`:

```typescript
export class ItemInstance {
  constructor(
    public readonly instanceId: string,
    public readonly master: ItemMaster,
    public readonly quality: Quality,
    public readonly usedMaterials: MaterialInstance[],
  ) {}

  get itemId(): ItemId {
    return this.master.id;
  }

  get name(): string {
    return this.master.name;
  }

  get basePrice(): number {
    return this.master.basePrice;
  }

  // å“è³ªã«å¿œã˜ãŸä¾¡æ ¼è¨ˆç®—
  calculatePrice(): number {
    const qualityMultiplier = QUALITY_PRICE_MULTIPLIER[this.quality];
    return Math.floor(this.basePrice * qualityMultiplier);
  }
}

const QUALITY_PRICE_MULTIPLIER: Record<Quality, number> = {
  'D': 0.5,
  'C': 0.75,
  'B': 1.0,
  'A': 1.5,
  'S': 2.0,
};
```

### 2.2 AlchemyServiceã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/domain/interfaces/alchemy-service.interface.ts`:

```typescript
export interface IAlchemyService {
  // èª¿åˆå®Ÿè¡Œ
  craft(itemId: ItemId, materials: MaterialInstance[]): ItemInstance;

  // èª¿åˆå¯èƒ½ãƒã‚§ãƒƒã‚¯
  canCraft(itemId: ItemId, availableMaterials: MaterialInstance[]): boolean;

  // å“è³ªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  previewQuality(itemId: ItemId, materials: MaterialInstance[]): Quality;

  // ãƒ¬ã‚·ãƒ”å–å¾—
  getAvailableRecipes(materials: MaterialInstance[]): ItemMaster[];

  // ãƒ¬ã‚·ãƒ”è¦ä»¶ãƒã‚§ãƒƒã‚¯
  checkRecipeRequirements(itemId: ItemId, materials: MaterialInstance[]): RecipeCheckResult;
}

export interface RecipeCheckResult {
  canCraft: boolean;
  missingMaterials: RecipeRequirement[];
  matchedMaterials: MaterialInstance[];
}
```

### 2.3 AlchemyServiceå®Ÿè£… ğŸ”µ

`src/application/services/alchemy-service.ts`:

```typescript
export class AlchemyService implements IAlchemyService {
  constructor(
    private masterDataRepo: IMasterDataRepository,
    private eventBus: IEventBus,
  ) {}

  craft(itemId: ItemId, materials: MaterialInstance[]): ItemInstance {
    const itemMaster = this.masterDataRepo.getItemById(itemId);
    if (!itemMaster) {
      throw new Error(`Item not found: ${itemId}`);
    }

    if (!this.canCraft(itemId, materials)) {
      throw new Error('Cannot craft: insufficient materials');
    }

    const quality = this.previewQuality(itemId, materials);
    const instance = new ItemInstance(
      generateUniqueId(),
      itemMaster,
      quality,
      materials,
    );

    this.eventBus.emit(GameEventType.ITEM_CRAFTED, { item: instance });

    return instance;
  }

  previewQuality(itemId: ItemId, materials: MaterialInstance[]): Quality {
    // ç´ æã®å¹³å‡å“è³ªã‹ã‚‰å®Œæˆå“ã®å“è³ªã‚’æ±ºå®š
    const avgQuality = this.calculateAverageQuality(materials);
    return avgQuality;
  }

  // ... ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
}
```

### 2.4 ãƒ¬ã‚·ãƒ”è¦ä»¶ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ ğŸ”µ

- ã‚«ãƒ†ã‚´ãƒªãƒ™ãƒ¼ã‚¹ã®ç´ æãƒãƒƒãƒãƒ³ã‚°
- å¿…è¦æ•°é‡ã®ãƒã‚§ãƒƒã‚¯
- æœ€é©ç´ æã®é¸æŠï¼ˆå“è³ªé †ï¼‰

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [x] ãƒ¬ã‚·ãƒ”ã«åŸºã¥ã„ãŸèª¿åˆãŒã§ãã‚‹
- [x] ç´ æä¸è¶³æ™‚ã¯èª¿åˆä¸å¯
- [x] å“è³ªãŒç´ æå“è³ªã‹ã‚‰æ±ºå®šã•ã‚Œã‚‹
- [x] èª¿åˆçµæœãŒã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦è¿”ã‚‹

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [x] èª¿åˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šï¼ˆå®Ÿéš›: ItemInstance 100%, AlchemyService 91.8%ï¼‰

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0012-01 | èª¿åˆæˆåŠŸ | ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ |
| T-0012-02 | ç´ æä¸è¶³æ™‚ã®èª¿åˆ | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ |
| T-0012-03 | å“è³ªè¨ˆç®—ï¼ˆå…¨ã¦Cå“è³ªï¼‰ | Cå“è³ªã‚¢ã‚¤ãƒ†ãƒ  |
| T-0012-04 | å“è³ªè¨ˆç®—ï¼ˆæ··åˆå“è³ªï¼‰ | å¹³å‡å“è³ª |
| T-0012-05 | èª¿åˆå¯èƒ½ãƒ¬ã‚·ãƒ”å–å¾— | è©²å½“ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| ã‚¢ã‚¤ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | `/src/domain/entities/ItemInstance.ts` |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/domain/interfaces/alchemy-service.interface.ts` |
| å®Ÿè£… | `/src/application/services/alchemy-service.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/services/alchemy-service.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/game-mechanics.md](../../design/atelier-guild-rank/game-mechanics.md)
- **ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/core-systems-core-services.md](../../design/atelier-guild-rank/core-systems-core-services.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
| 2026-01-17 | 1.0.1 | TDDé–‹ç™ºå®Œäº†ã€47ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å…¨é€šéã€ã‚«ãƒãƒ¬ãƒƒã‚¸91.8%ã€œ100%é”æˆ |
