# TASK-0017: GameFlowManagerå®Ÿè£…

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2026-01-16
**ãƒ•ã‚§ãƒ¼ã‚º**: 2 - ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãƒ»ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹
**è¦‹ç©æ™‚é–“**: 4æ™‚é–“ï¼ˆåŠæ—¥ï¼‰
**ä¾å­˜ã‚¿ã‚¹ã‚¯**: TASK-0005, TASK-0009, TASK-0011, TASK-0012, TASK-0013

---

## 1. ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›® | å€¤ |
|------|-----|
| **ã‚¿ã‚¹ã‚¯ID** | TASK-0017 |
| **ã‚¿ã‚¹ã‚¯å** | GameFlowManagerå®Ÿè£… |
| **ã‚«ãƒ†ã‚´ãƒª** | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ |
| **å„ªå…ˆåº¦** | æœ€é«˜ |
| **æ‹…å½“ãƒ¬ã‚¤ãƒ¤ãƒ¼** | Application |

### ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«

- ğŸ”µ **é’ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«è¨˜è¼‰
- ğŸŸ¡ **é»„ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬
- ğŸ”´ **èµ¤ä¿¡å·**: è¨­è¨ˆæ–‡æ›¸ã«ãªã„æ¨æ¸¬

---

## 2. å®Ÿè£…å†…å®¹

### 2.1 GameFlowManagerã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ”µ

`src/application/services/game-flow-manager.interface.ts`:

```typescript
export interface IGameFlowManager {
  // ã‚²ãƒ¼ãƒ é–‹å§‹
  startNewGame(): void;
  continueGame(saveData: SaveData): void;

  // æ—¥ã®é€²è¡Œ
  startDay(): void;
  endDay(): void;

  // ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ
  startPhase(phase: GamePhase): void;
  endPhase(): void;
  skipPhase(): void;

  // ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®š
  checkGameOver(): GameEndCondition | null;
  checkGameClear(): GameEndCondition | null;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  rest(): void; // ä¼‘æ†©ï¼ˆAPæ¶ˆè²»ãªã—ã§æ—¥ã‚’é€²ã‚ã‚‹ï¼‰

  // çŠ¶æ…‹å–å¾—
  getCurrentPhase(): GamePhase;
  canAdvancePhase(): boolean;
}

export interface GameEndCondition {
  type: 'game_over' | 'game_clear';
  reason: string;
  finalRank: GuildRank;
  totalDays: number;
}
```

### 2.2 ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ğŸ”µ

```
æ—¥é–‹å§‹
  â†“
ä¾é ¼å—æ³¨ãƒ•ã‚§ãƒ¼ã‚º
  â†“
æ¡å–ãƒ•ã‚§ãƒ¼ã‚º
  â†“
èª¿åˆãƒ•ã‚§ãƒ¼ã‚º
  â†“
ç´å“ãƒ•ã‚§ãƒ¼ã‚º
  â†“
æ—¥çµ‚äº†ï¼ˆæœŸé™ãƒã‚§ãƒƒã‚¯ã€ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®šï¼‰
  â†“
æ¬¡ã®æ—¥ã¸ or ã‚²ãƒ¼ãƒ çµ‚äº†
```

### 2.3 GameFlowManagerå®Ÿè£… ğŸ”µ

`src/application/services/game-flow-manager.ts`:

```typescript
export class GameFlowManager implements IGameFlowManager {
  constructor(
    private stateManager: IStateManager,
    private deckService: IDeckService,
    private questService: IQuestService,
    private eventBus: IEventBus,
  ) {}

  startNewGame(): void {
    this.stateManager.initialize();
    this.deckService.initialize(INITIAL_DECK);
    this.startDay();
  }

  startDay(): void {
    this.stateManager.updateState({
      actionPoints: this.stateManager.getState().maxActionPoints,
    });
    this.questService.generateDailyQuests(
      this.stateManager.getState().currentRank
    );
    this.eventBus.emit(GameEventType.DAY_STARTED, {
      day: this.stateManager.getState().currentDay,
    });
    this.startPhase('quest_accept');
  }

  endDay(): void {
    // æœŸé™åˆ‡ã‚Œä¾é ¼å‡¦ç†
    const failedQuests = this.questService.processEndOfDay();

    // æ®‹ã‚Šæ—¥æ•°æ¸›å°‘
    const state = this.stateManager.getState();
    this.stateManager.updateState({
      remainingDays: state.remainingDays - 1,
      currentDay: state.currentDay + 1,
    });

    this.eventBus.emit(GameEventType.DAY_ENDED, {
      failedQuests,
      remainingDays: state.remainingDays - 1,
    });

    // ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®š
    const gameOver = this.checkGameOver();
    const gameClear = this.checkGameClear();

    if (!gameOver && !gameClear) {
      this.startDay();
    }
  }

  // ... ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
}
```

### 2.4 ã‚²ãƒ¼ãƒ çµ‚äº†æ¡ä»¶ ğŸ”µ

- **ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼**: æ®‹ã‚Šæ—¥æ•°0ã§Sãƒ©ãƒ³ã‚¯æœªåˆ°é”
- **ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢**: Sãƒ©ãƒ³ã‚¯åˆ°é”

---

## 3. å—ã‘å…¥ã‚ŒåŸºæº–

### 3.1 å¿…é ˆæ¡ä»¶ ğŸ”µ

- [ ] æ–°è¦ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã§ãã‚‹
- [ ] ãƒ•ã‚§ãƒ¼ã‚ºãŒé †ç•ªã«é€²è¡Œã™ã‚‹
- [ ] æ—¥ã®é€²è¡ŒãŒæ­£ã—ãå‹•ä½œã™ã‚‹
- [ ] ã‚²ãƒ¼ãƒ çµ‚äº†åˆ¤å®šãŒæ­£ã—ã„

### 3.2 æ¨å¥¨æ¡ä»¶ ğŸŸ¡

- [ ] ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼ãŒå‹•ä½œã™ã‚‹
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## 4. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### 4.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå†…å®¹ | æœŸå¾…çµæœ |
|---------|----------|----------|
| T-0017-01 | æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹ | åˆæœŸçŠ¶æ…‹è¨­å®š |
| T-0017-02 | ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ | æ­£ã—ã„é †åºã§é·ç§» |
| T-0017-03 | æ—¥çµ‚äº†å‡¦ç† | æ®‹ã‚Šæ—¥æ•°æ¸›å°‘ |
| T-0017-04 | ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š | æ¡ä»¶æº€ãŸã™ã¨true |
| T-0017-05 | ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢åˆ¤å®š | Sãƒ©ãƒ³ã‚¯ã§true |
| T-0017-06 | ä¼‘æ†©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | æ—¥ãŒé€²ã‚€ã€APæ¶ˆè²»ãªã— |

---

## 5. æˆæœç‰©

| æˆæœç‰© | ãƒ‘ã‚¹ |
|--------|------|
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | `/src/application/services/game-flow-manager.interface.ts` |
| å®Ÿè£… | `/src/application/services/game-flow-manager.ts` |
| ãƒ†ã‚¹ãƒˆ | `/tests/unit/application/services/game-flow-manager.test.ts` |

---

## é–¢é€£æ–‡æ›¸

- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸**: [../../design/atelier-guild-rank/dataflow.md](../../design/atelier-guild-rank/dataflow.md)
- **ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹è¨­è¨ˆ**: [../../design/atelier-guild-rank/game-mechanics.md](../../design/atelier-guild-rank/game-mechanics.md)

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2026-01-16 | 1.0.0 | åˆç‰ˆä½œæˆ |
