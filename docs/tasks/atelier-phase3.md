# Phase 3: 仕上げと最適化

## フェーズ概要

| 項目 | 値 |
|------|-----|
| フェーズ | Phase 3 |
| 期間 | 3週間 (15日) |
| タスク数 | 15タスク |
| 工数 | 120時間 |
| 目標 | ゲームを完成させ、プレイ可能な状態に仕上げる |
| 成果物 | リザルト画面、アセンション、ポリッシュ、最適化 |
| 要件名 | atelier |

---

## 週次計画

### Week 1: リザルト・メタ進行
- [ ] 目標達成: リザルト画面とメタ進行システム
- 成果物: リザルト画面、アセンションシステム、メタ報酬
- タスク: TASK-0057 〜 TASK-0060 (4タスク / 24時間)

### Week 2: アセット統合・ポリッシュ
- [ ] 目標達成: ビジュアル・オーディオの完成
- 成果物: エフェクト統合、アニメーション調整、UI磨き込み
- タスク: TASK-0061 〜 TASK-0064 (4タスク / 32時間)

### Week 3: 最適化・バランス調整・最終テスト
- [ ] 目標達成: リリース品質の達成
- 成果物: パフォーマンス最適化、バランス調整、最終確認
- タスク: TASK-0065 〜 TASK-0071 (7タスク / 56時間)

---

## タスク一覧

### Week 1: リザルト・メタ進行

---

#### TASK-0057: リザルト画面UIの作成 🔵
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0057 |
| タスク名 | リザルト画面UIの作成 |
| タスクタイプ | TDD |
| 推定工数 | 6時間 |
| 要件リンク | ui-design/screens/result.md |
| 依存タスク | Phase 2完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- 勝利/敗北タイトル表示
- フレーバーテキスト
- プレイ統計パネル
  - クリア/到達レベル
  - 達成依頼数
  - 暴発回数
  - 最終デッキ枚数
  - プレイ時間
- 獲得報酬パネル
  - 名声（今回獲得 + 累計）
  - 知識ポイント（今回獲得 + 累計）
- 新規解放アイテム表示
- リトライボタン（敗北時のみ）
- タイトルへ戻るボタン

**テスト要件**:
- [ ] 勝利時に正しい表示がされる
- [ ] 敗北時に正しい表示がされる
- [ ] 統計が正しく表示される
- [ ] 報酬が正しく表示される
- [ ] リトライボタンが敗北時のみ表示される

**UI/UX要件**:
- 勝利/敗北タイトルのスライドイン表示
- 統計数値のカウントアップアニメーション（0.5秒）
- 新規解放アイテムのキラキラエフェクト
- リトライ/タイトルボタンのホバーアニメーション
- 勝利時: 紙吹雪エフェクト、敗北時: 暗転エフェクト

**エラーハンドリング**:
- 統計データ計算エラー時のデフォルト表示
- セーブデータ反映失敗時のリトライ処理
- 解放判定エラー時のスキップ処理

**完了条件**:
- [ ] リザルト画面が設計書通りに表示される
- [ ] 全テストがパスしている

---

#### TASK-0058: メタ報酬計算システム 🔵
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0058 |
| タスク名 | メタ報酬計算システム |
| タスクタイプ | TDD |
| 推定工数 | 4時間 |
| 要件リンク | ui-design/screens/result.md |
| 依存タスク | TASK-0057 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
```csharp
public interface IMetaProgressService
{
    int CalculateFameReward(RunResult result);
    int CalculateKnowledgeReward(RunResult result);
    List<string> CheckUnlocks(RunResult result);
    void ApplyRewards(RunResult result);
}
```

**名声計算式** (result.mdより):
```
基本名声 = クリアレベル × 5
達成ボーナス = 達成依頼数 × 2
暴発ペナルティ = 暴発回数 × -1
合計名声 = 基本名声 + 達成ボーナス + 暴発ペナルティ
```

**知識ポイント計算式**:
```
基本ポイント = クリアレベル × 3
勝利ボーナス = 勝利時 +20
アセンションボーナス = アセンションLv × 5
合計ポイント = 基本ポイント + 勝利ボーナス + アセンションボーナス
```

**テスト要件**:
- [ ] 名声計算が正しく動作する
- [ ] 知識ポイント計算が正しく動作する
- [ ] 解放判定が正しく動作する
- [ ] 報酬がセーブデータに反映される

**完了条件**:
- [ ] メタ報酬システムが実装されている
- [ ] 全テストがパスしている

---

#### TASK-0059: アセンションシステムの実装 🔵
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0059 |
| タスク名 | アセンションシステムの実装 |
| タスクタイプ | TDD |
| 推定工数 | 8時間 |
| 要件リンク | balance-design.md |
| 依存タスク | TASK-0058 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
```csharp
public interface IAscensionService
{
    int CurrentAscensionLevel { get; }
    int MaxUnlockedLevel { get; }
    AscensionModifiers GetModifiers(int level);
    void UnlockNextLevel();
}

public class AscensionModifiers
{
    public float GoldMultiplier { get; }
    public float RequirementMultiplier { get; }
    public int FamePenalty { get; }
    public float ShopPriceMultiplier { get; }
    public int CursedCardCount { get; }
    public int EnergyReduction { get; }
    public float CardLostChanceBonus { get; }
    public float ExperimentFailureBonus { get; }
}
```

**アセンションレベル効果** (balance-design.mdより):
| レベル | 効果 |
|--------|------|
| 1 | 初期ゴールド-10% |
| 2 | 依頼の必要属性値+5% |
| 3 | 暴発ペナルティ増加（名声-2） |
| 4 | 商人の価格+10% |
| 5 | 初期デッキに「呪われたカード」1枚追加 |
| 6 | 依頼の必要属性値+10% |
| 7 | エネルギー回復-1 |
| 8 | 暴発時カードロスト確率+25% |
| 9 | 実験の成功率-10% |
| 10 | 全効果適用、依頼+15%、ボスHP+20% |

**テスト要件**:
- [ ] 各レベルの効果が正しく適用される
- [ ] クリア時に次レベルが解放される
- [ ] 効果の累積が正しく計算される
- [ ] アセンション選択がゲームに反映される

**完了条件**:
- [ ] アセンションシステムが実装されている
- [ ] 全テストがパスしている

---

#### TASK-0060: カード/スタイル解放システム 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0060 |
| タスク名 | カード/スタイル解放システム |
| タスクタイプ | TDD |
| 推定工数 | 6時間 |
| 要件リンク | data-schema.md |
| 依存タスク | TASK-0058 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
```csharp
public interface IUnlockService
{
    List<string> UnlockedCardIds { get; }
    List<string> UnlockedStyleIds { get; }
    bool IsCardUnlocked(string cardId);
    bool IsStyleUnlocked(string styleId);
    void UnlockCard(string cardId);
    void UnlockStyle(string styleId);
    event Action<string> OnCardUnlocked;
    event Action<string> OnStyleUnlocked;
}
```

**解放条件例**:
- 火の錬金術師クリア → 水の錬金術師解放
- アセンション3クリア → 特殊カード解放
- 知識ポイント100到達 → 新スタイル解放

**テスト要件**:
- [ ] 解放状態が正しく管理される
- [ ] 解放条件が正しく判定される
- [ ] 解放イベントが発行される
- [ ] 解放状態がセーブされる

**完了条件**:
- [ ] 解放システムが実装されている
- [ ] 全テストがパスしている

---

### Week 2: アセット統合・ポリッシュ

---

#### TASK-0061: ビジュアルエフェクトの統合 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0061 |
| タスク名 | ビジュアルエフェクトの統合 |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | ui-design/screens/quest.md, result.md |
| 依存タスク | Phase 2完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- カードプレイエフェクト（移動 + 回転）
- 属性加算エフェクト（数値カウントアップ）
- 暴発エフェクト（画面シェイク + 爆発）
- 依頼達成エフェクト（キラキラ）
- 勝利エフェクト（紙吹雪）
- 敗北エフェクト（暗転 + 煙）
- リザルト数値カウントアップ

**完了条件**:
- [ ] 全エフェクトがスムーズに再生される
- [ ] エフェクトがゲームプレイを妨げない
- [ ] スキップ可能なエフェクトはスキップできる

---

#### TASK-0062: アニメーション調整 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0062 |
| タスク名 | アニメーション調整 |
| タスクタイプ | DIRECT |
| 推定工数 | 6時間 |
| 要件リンク | ui-design/overview.md |
| 依存タスク | TASK-0061 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- 画面遷移アニメーション（フェードイン/アウト 0.3秒）
- ダイアログ表示アニメーション（スケールイン 0.2秒）
- ボタンホバー/クリックアニメーション
- カードドラッグアニメーション
- ノードホバーパルスアニメーション
- イージング関数の調整

**完了条件**:
- [ ] 全アニメーションが設計書通りの時間で再生される
- [ ] アニメーションが自然に見える
- [ ] 60fpsで安定動作する

---

#### TASK-0063: UI磨き込み 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0063 |
| タスク名 | UI磨き込み |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | ui-design/overview.md |
| 依存タスク | Phase 2完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- カラーパレットの統一（プライマリ: #8B4513、セカンダリ: #DAA520）
- フォント設定の調整（PixelMplus）
- 余白・間隔の統一（xs:4px, sm:8px, md:16px, lg:24px, xl:32px）
- アイコンの統一
- ツールチップの改善
- フォーカス表示の改善（色: #FFD700、太さ: 2px）

**UI/UX要件**:
- フォントサイズ: 見出し24px, 本文16px, 補足12px
- ボタン: 最小タッチ領域44×44px
- コントラスト比: 最低4.5:1
- 色覚多様性対応: 色+形状でステータス表示

**エラーハンドリング**:
- フォント読み込み失敗時のシステムフォントフォールバック
- アイコン読み込み失敗時のテキスト代替表示

**完了条件**:
- [ ] 全画面でデザインが統一されている
- [ ] 読みやすく操作しやすい
- [ ] アクセシビリティ基準を満たしている

---

#### TASK-0064: BGM/SE最終調整 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0064 |
| タスク名 | BGM/SE最終調整 |
| タスクタイプ | DIRECT |
| 推定工数 | 4時間 |
| 要件リンク | audio-design.md |
| 依存タスク | TASK-0053, TASK-0054 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- 音量バランスの調整
- BGMフェードタイミングの調整
- SE再生タイミングの調整
- 不足しているSEの追加
- 勝利/敗北BGMの追加（BGM_VICTORY, BGM_DEFEAT）

**完了条件**:
- [ ] 音量バランスが適切
- [ ] 全アクションに適切なフィードバック音がある
- [ ] BGM切り替えがスムーズ

---

### Week 3: 最適化・バランス調整・最終テスト

---

#### TASK-0065: メモリ最適化 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0065 |
| タスク名 | メモリ最適化 |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | - |
| 依存タスク | Phase 2完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- オブジェクトプーリングの導入（カードUI、エフェクト）
- 未使用アセットのアンロード
- テクスチャアトラスの作成
- GCアロケーションの削減

**完了条件**:
- [ ] メモリ使用量が安定している
- [ ] GCスパイクが発生しない
- [ ] 長時間プレイでメモリリークがない

---

#### TASK-0066: 描画最適化 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0066 |
| タスク名 | 描画最適化 |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | - |
| 依存タスク | TASK-0065 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- ドローコールの削減
- Canvas最適化
- UIレイヤリングの調整
- パーティクル最適化

**完了条件**:
- [ ] 60fpsで安定動作する
- [ ] ドローコールが適切な範囲内
- [ ] 低スペック環境でも動作する

---

#### TASK-0067: ロード時間最適化 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0067 |
| タスク名 | ロード時間最適化 |
| タスクタイプ | DIRECT |
| 推定工数 | 4時間 |
| 要件リンク | - |
| 依存タスク | TASK-0066 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- アセットの非同期ロード
- シーンロードの最適化
- 起動時ロードの最小化
- ローディング画面の改善

**UI/UX要件**:
- ローディング画面にプログレスバー表示
- ローディング中のtipsメッセージ表示
- 初回起動時のみスプラッシュスクリーン表示

**エラーハンドリング**:
- アセットロード失敗時のリトライ（最大3回）
- タイムアウト時のエラーダイアログ表示
- 破損アセットのスキップ処理

**完了条件**:
- [ ] シーン遷移が2秒以内
- [ ] 起動時間が5秒以内
- [ ] ローディング中も応答がある

---

#### TASK-0068: ゲームバランス調整 🔵
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0068 |
| タスク名 | ゲームバランス調整 |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | balance-design.md |
| 依存タスク | Phase 2完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- カード属性値の調整
- 依頼難易度の調整
- 報酬バランスの調整
- アセンション難易度の調整
- 経済バランスの確認

**バランスチェックリスト** (balance-design.mdより):
- [ ] 初回プレイヤーがレベル3まで到達できる
- [ ] 全スタイルでクリア可能
- [ ] 1プレイが40分を大幅に超えない
- [ ] 「必須カード」が存在しない
- [ ] 「罠カード」が存在しない
- [ ] アセンション10がクリア可能

**完了条件**:
- [ ] バランスチェックリストを満たしている
- [ ] プレイテストで問題が発生しない

---

#### TASK-0069: カード/依頼データ拡充 🔵
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0069 |
| タスク名 | カード/依頼データ拡充 |
| タスクタイプ | DIRECT |
| 推定工数 | 8時間 |
| 要件リンク | data-schema.md, core-systems.md |
| 依存タスク | TASK-0068 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- カードデータ追加（30枚程度）
  - 各属性のバリエーション
  - レアリティ別カード
  - シナジーカード
- 依頼データ追加（20件程度）
  - 難易度別依頼
  - 特殊条件依頼
- ボスデータ追加（3体程度）

**完了条件**:
- [ ] 十分な種類のカードが存在する
- [ ] 十分な種類の依頼が存在する
- [ ] ボスバトルが動作する

---

#### TASK-0070: 最終統合テスト 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0070 |
| タスク名 | 最終統合テスト |
| タスクタイプ | TDD |
| 推定工数 | 8時間 |
| 要件リンク | - |
| 依存タスク | 全タスク完了 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- フルプレイスルーテスト
  - 新規ゲーム開始〜クリア
  - 暴発による敗北
  - アセンション1〜10
- エッジケーステスト
  - デッキ枯渇
  - エネルギー不足
  - 大量カード
- ストレステスト
  - 長時間プレイ
  - 連続プレイ

**テスト要件**:
- [ ] 全シナリオでクラッシュしない
- [ ] 全機能が正常に動作する
- [ ] パフォーマンスが安定している

**完了条件**:
- [ ] 最終テストがパスしている
- [ ] 既知のバグが全て修正されている

---

#### TASK-0071: リリース準備 🟡
- [ ] 完了

| 項目 | 内容 |
|------|------|
| タスクID | TASK-0071 |
| タスク名 | リリース準備 |
| タスクタイプ | DIRECT |
| 推定工数 | 4時間 |
| 要件リンク | - |
| 依存タスク | TASK-0070 |
| 要件名 | atelier |
| GitHub Issue | - |

**実装詳細**:
- ビルド設定の確認
- 解像度設定の確認（1920x1080固定）
- 初期ボリューム設定の確認
- バージョン番号の設定
- README/ドキュメントの更新
- リリースビルドの作成

**完了条件**:
- [ ] リリースビルドが正常に動作する
- [ ] ドキュメントが最新化されている
- [ ] バージョン番号が正しく設定されている

---

## フェーズ完了条件

- [ ] 全15タスクが完了している
- [ ] リザルト画面が動作する
- [ ] アセンションシステムが動作する
- [ ] カード/スタイル解放が動作する
- [ ] 全エフェクト/アニメーションがスムーズ
- [ ] 60fpsで安定動作する
- [ ] ゲームバランスが適切
- [ ] 最終テストがパスしている
- [ ] リリースビルドが作成されている

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2025-12-21 | 1.0 | 初版作成 |
