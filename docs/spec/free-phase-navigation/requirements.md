# フェーズ自由遷移システム 要件定義書

**バージョン**: 1.1
**作成日**: 2026-02-19
**形式**: EARS記法（Easy Approach to Requirements Syntax）

## 概要

現在の固定フェーズ進行（依頼受注→採取→調合→納品→日終了）を、プレイヤーが自由にフェーズを切り替えられるシステムに変更する。
加えて、採取を「場所選択→ドラフト採取」の2段階に分割し、採取・調合のAP消費による自動日数進行を導入する。

### 変更の目的

- プレイヤーの戦略的自由度の向上
- 日数管理のリアリティ向上（行動にかかる時間の表現）
- 採取体験の深化（場所選択という意思決定の追加）

## 関連文書

- **ヒアリング記録**: [interview-record.md](interview-record.md)
- **ユーザストーリー**: [user-stories.md](user-stories.md)
- **受け入れ基準**: [acceptance-criteria.md](acceptance-criteria.md)
- **既存要件定義書**: [../atelier-guild-rank-requirements.md](../atelier-guild-rank-requirements.md)
- **既存ゲームメカニクス設計書**: [../../design/atelier-guild-rank/game-mechanics.md](../../design/atelier-guild-rank/game-mechanics.md)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:
- 🔵 **青信号**: ユーザヒアリングで確認済みの確実な要件
- 🟡 **黄信号**: ヒアリング内容から妥当な推測による要件
- 🔴 **赤信号**: ヒアリングにない推測による要件

---

### 1. フェーズ自由遷移（通常要件）

- **REQ-001**: システムは、プレイヤーが依頼受注・採取・調合・納品の4フェーズを任意の順序で自由に切り替えられるようにしなければならない 🔵 *ヒアリングQ1: 完全自由切り替え*

- **REQ-001-01**: システムは、どのフェーズからでも他の任意のフェーズへ即座に遷移できなければならない 🔵 *ヒアリングQ1より*

- **REQ-001-02**: システムは、フェーズ切り替え時に進行中の操作がない場合、即座に切り替えなければならない 🟡 *ヒアリングQ1から妥当な推測: 操作中の場合の挙動*

- **REQ-001-03**: 採取中（ドラフト採取セッション進行中）の場合、システムは採取を中断してフェーズ切り替えを行うか、確認を求めなければならない 🟡 *既存GatheringPhaseUIの状態管理から推測*

---

### 2. 採取2段階化（通常要件）

- **REQ-002**: 採取フェーズは「場所選択」と「ドラフト採取」の2段階に分割しなければならない 🔵 *ヒアリングQ4: 採取地一覧・マップ表示*

- **REQ-002-01**: 場所選択画面は、利用可能な採取地をマップ形式で一覧表示しなければならない 🔵 *ヒアリングQ4: 採取地一覧（マップ表示）*

- **REQ-002-02**: 場所選択画面は、各採取地の移動APコストを表示しなければならない 🔵 *ヒアリングQ4: 移動日数の表示*

- **REQ-002-03**: 場所選択画面は、各採取地で入手可能な素材のプレビューを表示しなければならない 🔵 *ヒアリングQ4: 採取可能素材のプレビュー*

- **REQ-002-04**: 場所選択画面は、手札にある採取地カードと連動し、カードを持っている採取地のみ選択可能としなければならない 🔵 *ヒアリングQ4: 手札の採取地カードと連動*

- **REQ-002-05**: 採取地を選択すると、既存のドラフト採取システム（素材3つ提示→1つ選択）を開始しなければならない 🔵 *既存仕様維持*

---

### 3. AP超過による自動日進行（条件付き要件）

- **REQ-003**: AP消費が上限（現在3）を超過した場合、システムは自動的に日を進行しなければならない 🔵 *ヒアリングQ5: AP上限超過で自動日進行*

- **REQ-003-01**: AP超過分は翌日のAPから差し引かれなければならない（例: AP4消費→翌日AP = 3 - 1 = 2） 🔵 *ヒアリングQ5: AP上限超過で翌日AP2開始*

- **REQ-003-02**: 自動日進行時も、既存の日終了処理（依頼期限更新、手札補充、ランク判定）を実行しなければならない 🔵 *ヒアリングQ10: 既存処理を維持*

- **REQ-003-03**: AP超過が上限の2倍以上（例: AP6消費）の場合、複数日分を消費しなければならない 🟡 *ヒアリングQ5から妥当な推測: 大量AP消費時の挙動*

- **REQ-003-04**: 自動日進行により残り日数が0以下になった場合、ゲームオーバー判定を実行しなければならない 🔵 *既存仕様（checkGameOver）維持*

- **REQ-003-05**: 採取フェーズでのAP消費（採取地の基本コスト + 選択個数による追加コスト）がAP上限を超過した場合、自動日進行を適用しなければならない 🔵 *ヒアリングQ2・Q3より*

- **REQ-003-06**: 調合フェーズでのAP消費（レシピのAPコスト）がAP上限を超過した場合、自動日進行を適用しなければならない 🔵 *ヒアリングQ8: レシピごとAPコスト*

- **REQ-003-07**: 旧「7個以上採取で+1日」ルール（追加日数ペナルティ）はAP超過モデルに統合し、廃止しなければならない 🔵 *AP超過モデル導入に伴い、APコストのみで日数消費を統一管理。追加日数の二重計算を回避*

- **REQ-003-08**: AP超過の1回の行動における上限はMAX_AP × 2（現在6）としなければならない。6APを超える行動は実行不可とする 🟡 *火山(基本2)+6個(追加3)=5APなど連鎖リスクを考慮した安全弁*

#### AP超過計算アルゴリズム（v1.1 確定版）

以下の計算式でAP超過と自動日進行を処理する:

```
定数:
  MAX_AP = 3（1日の行動ポイント上限）

入力:
  currentAP: 現在の残りAP
  apCost: 行動のAPコスト

前提条件:
  apCost <= MAX_AP × 2（REQ-003-08による上限チェック）

計算:
  apAfterAction = currentAP - apCost

  if apAfterAction >= 0:
    // 超過なし - APを減算するだけ
    newAP = apAfterAction
    daysConsumed = 0
  else:
    // 超過あり - 日進行が発生
    overflow = abs(apAfterAction)              // 超過量
    daysConsumed = ceil(overflow / MAX_AP)      // 消費日数
    newAP = (MAX_AP * daysConsumed) - overflow  // 翌日開始時のAP

出力:
  newAP: 行動後（日進行後）のAP残量
  daysConsumed: 自動日進行する日数（0 = 日進行なし）
```

**計算例**:

| シナリオ | currentAP | apCost | apAfterAction | overflow | daysConsumed | newAP |
|---------|-----------|--------|---------------|----------|-------------|-------|
| 通常行動 | 3 | 2 | 1 | - | 0 | 1 |
| ちょうど消費 | 3 | 3 | 0 | - | 0 | 0 |
| 1日超過 | 2 | 4 | -2 | 2 | 1 | 1 |
| 1日超過(ヒアリング例) | 3 | 4 | -1 | 1 | 1 | 2 |
| 2日超過 | 1 | 5 | -4 | 4 | 2 | 2 |
| 最大超過 | 0 | 6 | -6 | 6 | 2 | 0 |

**自動日進行処理の順序**:
1. AP超過を検知
2. daysConsumed分の日終了処理をループ実行（各日ごとに依頼期限更新・手札補充・ランク判定）
3. ループ中にゲームオーバー条件を満たした場合、即座に中断してゲームオーバー
4. ループ完了後、newAPで新しい日を開始

---

### 4. 明示的日終了（通常要件）

- **REQ-004**: システムは、プレイヤーが任意のタイミングで「日終了」を選択できるボタンを提供しなければならない 🔵 *ヒアリングQ7: 両方あり*

- **REQ-004-01**: 「日終了」ボタン押下時は、残りAPを破棄して既存の日終了処理を実行しなければならない 🟡 *既存endDay()から妥当な推測*

---

### 5. 依頼掲示板システム（通常要件）

- **REQ-005**: 依頼受注は「掲示板方式」と「訪問方式」を併用しなければならない 🔵 *ヒアリングQ6: 訪問+掲示板の両方*

- **REQ-005-01**: 掲示板には依頼が累積的に掲載され、期限切れまで残らなければならない 🔵 *ヒアリングQ6: 掲示板方式*

- **REQ-005-02**: 訪問依頼は3日ごとに更新されなければならない 🔵 *ヒアリングQ6: 数日で変わる → 3日に確定（#307）*

- **REQ-005-03**: 掲示板の依頼更新頻度は、ランクに応じて変化してよい 🟡 *既存ランクシステムから妥当な推測*

---

### 6. タブ切り替えUI（通常要件）

- **REQ-006**: フッターのフェーズインジケーターは、プログレスバーからタブ切り替えUIに変更しなければならない 🔵 *ヒアリングQ9: タブ切り替えUIに変更*

- **REQ-006-01**: タブは「依頼」「採取」「調合」「納品」の4つで構成しなければならない 🔵 *既存4フェーズの維持*

- **REQ-006-02**: 現在アクティブなフェーズのタブは、視覚的に強調表示しなければならない 🟡 *既存PHASE_COLORSから妥当な推測*

- **REQ-006-03**: タブをクリック/タップすることで即座にフェーズを切り替えなければならない 🔵 *REQ-001との整合性*

---

### 制約要件

- **REQ-401**: 既存の同時依頼受注上限（3件）は維持しなければならない 🔵 *ヒアリングQ11: 特になし*

- **REQ-402**: 既存のAP上限（3/日）は維持しなければならない 🔵 *ヒアリングQ11: 特になし*

- **REQ-403**: 既存のデッキシステム（初期15枚、上限30枚、手札上限7枚）は維持しなければならない 🔵 *ヒアリングQ11: 特になし*

- **REQ-404**: 既存のギルドランクシステム（G〜S、昇格ゲージ、昇格試験）は維持しなければならない 🔵 *ヒアリングQ11: 特になし*

- **REQ-405**: 既存のショップシステム（カード/素材/強化/アーティファクト）は維持しなければならない 🔵 *ヒアリングQ11: 特になし*

---

## 非機能要件

### パフォーマンス

- **NFR-001**: フェーズ切り替え（タブクリック→UI表示）は200ms以内に完了しなければならない 🟡 *既存showPhase()のパフォーマンスから推測*

- **NFR-002**: 自動日進行処理（AP超過検知→日終了処理→次日開始）は500ms以内に完了しなければならない 🟡 *既存endDay()+startDay()のパフォーマンスから推測*

### ユーザビリティ

- **NFR-101**: 自動日進行時は、プレイヤーに日が進行したことを視覚的に通知しなければならない 🟡 *既存DAY_STARTEDイベント表示から推測*

- **NFR-102**: AP超過による自動日進行前に、消費APと翌日APをプレビュー表示しなければならない 🟡 *ゲーム体験の観点から推測*

---

## Edgeケース

### エラー処理

- **EDGE-001**: 採取中（ドラフト採取セッション中）にフェーズを切り替えた場合、採取セッションの状態を保持するか確認ダイアログを表示しなければならない 🟡 *既存GatheringPhaseUIの状態管理から推測*

- **EDGE-002**: AP超過による自動日進行で複数日が消費される場合（例: AP7消費→2日分）、各日の日終了処理を順次実行しなければならない 🟡 *REQ-003-03から推測*

### 境界値

- **EDGE-101**: AP残量0の状態で行動しようとした場合、「日終了」を促すメッセージを表示しなければならない 🟡 *既存AP管理から推測*

- **EDGE-102**: 全フェーズで何も行動せず「日終了」した場合、通常の日終了処理を実行しなければならない（ペナルティなし） 🔵 *既存仕様: 依頼失敗ペナルティなし*

- **EDGE-103**: 採取場所選択で手札に採取地カードが0枚の場合、「採取地カードがありません」と表示し、ショップへの誘導を表示してよい 🟡 *ゲーム体験の観点から推測*

---

## 既存要件からの変更点サマリー

| 変更項目 | 現在の仕様 | 新しい仕様 |
|---------|-----------|-----------|
| **フェーズ遷移** | 固定順序（QUEST_ACCEPT→GATHERING→ALCHEMY→DELIVERY） | 自由遷移（任意のフェーズへ切り替え可能） |
| **フェーズUI** | プログレスバー（FooterUI） | タブ切り替えUI |
| **採取フェーズ** | 直接ドラフト採取開始 | 場所選択→ドラフト採取の2段階 |
| **日数進行** | 「日終了」ボタンのみ | AP超過による自動日進行 + 「日終了」ボタン |
| **AP回復** | 日開始時にMAX(3)に完全回復 | 日開始時にMAX(3) - 前日超過分 で回復 |
| **依頼受注** | 毎日新しい依頼者が来訪 | 掲示板（累積）+ 訪問（数日更新）の併用 |
| **「次へ」ボタン** | フェーズ固定遷移 | 廃止（タブ切り替えで代替） |

## 影響を受ける既存コンポーネント

| コンポーネント | ファイルパス | 影響内容 |
|-------------|-----------|---------|
| **VALID_PHASE_TRANSITIONS** | `src/shared/services/state-manager/initial-state.ts` | 全フェーズ間の遷移を許可に変更 |
| **StateManager.setPhase()** | `src/shared/services/state-manager/StateManager.ts` | 遷移バリデーションの緩和 |
| **GameFlowManager.endPhase()** | `src/shared/services/game-flow/game-flow-manager.ts` | 固定順序ロジックの廃止、AP超過ロジック追加 |
| **GameFlowManager.startDay()** | `src/shared/services/game-flow/game-flow-manager.ts` | AP回復ロジックの変更（超過分差し引き） |
| **MainScene.showPhase()** | `src/scenes/MainScene.ts` | タブ切り替えとの連携 |
| **FooterUI** | `src/shared/components/FooterUI.ts` | プログレスバー→タブUIへの変更 |
| **GatheringPhaseUI** | `src/features/gathering/components/GatheringPhaseUI.ts` | 場所選択ステージの追加 |
| **QuestService** | `src/features/quest/` | 掲示板方式+訪問方式への変更 |
| **GamePhase** | `src/shared/types/common.ts` | 変更不要（4フェーズ維持） |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-02-19 | 1.0 | 初版作成 |
| 2026-02-23 | 1.1 | AP超過計算アルゴリズムv1.1を追加（REQ-003-07, REQ-003-08）。旧「7個以上+1日」ルールのAP超過モデル統合を明記。AP超過上限(MAX_AP×2)を設定。 |
