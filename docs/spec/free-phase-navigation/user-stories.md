# フェーズ自由遷移システム ユーザストーリー

**作成日**: 2026-02-19
**関連要件定義**: [requirements.md](requirements.md)
**ヒアリング記録**: [interview-record.md](interview-record.md)

**【信頼性レベル凡例】**:
- 🔵 **青信号**: ユーザヒアリング・既存設計文書を参考にした確実なストーリー
- 🟡 **黄信号**: ヒアリング内容・既存設計から妥当な推測によるストーリー
- 🔴 **赤信号**: ヒアリング・設計文書にない推測によるストーリー

---

## エピック1: フェーズ自由遷移

### ストーリー 1.1: 任意フェーズへの切り替え 🔵

**信頼性**: 🔵 *ヒアリングQ1: 完全自由切り替え*

**私は** プレイヤー **として**
**依頼受注・採取・調合・納品の4フェーズを任意の順序で自由に切り替えたい**
**そうすることで** 自分の戦略に合わせた柔軟なプレイができる

**関連要件**: REQ-001, REQ-001-01

**詳細シナリオ**:
1. プレイヤーは現在「採取」フェーズにいる
2. フッターのタブUIで「調合」タブをクリックする
3. 即座に調合フェーズの画面に切り替わる
4. 調合後、「依頼」タブをクリックして依頼受注に戻る

**前提条件**:
- ゲームがメインシーン（MainScene）で実行中
- いずれかのフェーズが表示されている

**制約事項**:
- 進行中の操作がない場合は即座に切り替え
- 採取ドラフトセッション中の場合は確認が必要（ストーリー1.2参照）

**優先度**: Must Have

---

### ストーリー 1.2: 採取中のフェーズ切り替え確認 🟡

**信頼性**: 🟡 *既存GatheringPhaseUIの状態管理から妥当な推測*

**私は** プレイヤー **として**
**ドラフト採取セッション中にフェーズを切り替える際、確認を求められたい**
**そうすることで** 意図しない採取セッションの中断を防げる

**関連要件**: REQ-001-02, REQ-001-03, EDGE-001

**詳細シナリオ**:
1. プレイヤーはドラフト採取セッション進行中（素材選択中）
2. フッターのタブUIで別フェーズのタブをクリックする
3. 「採取を中断しますか？」という確認ダイアログが表示される
4. 「はい」を選択すると採取セッションを中断してフェーズが切り替わる
5. 「いいえ」を選択すると採取セッションに戻る

**前提条件**:
- ドラフト採取セッションが進行中

**優先度**: Should Have

**備考**: 採取セッション中の状態保持可否は設計フェーズで詳細化が必要

---

## エピック2: 採取2段階化

### ストーリー 2.1: 採取地の選択 🔵

**信頼性**: 🔵 *ヒアリングQ4: 採取地一覧（マップ表示）、移動日数、素材プレビュー、手札連動*

**私は** プレイヤー **として**
**採取フェーズで採取地をマップ形式の一覧から選択したい**
**そうすることで** 移動コストや入手素材を考慮した戦略的な採取ができる

**関連要件**: REQ-002, REQ-002-01, REQ-002-02, REQ-002-03, REQ-002-04

**詳細シナリオ**:
1. プレイヤーが採取フェーズに切り替える
2. 場所選択画面がマップ形式で表示される
3. 手札にある採取地カードに対応する場所のみ選択可能（ハイライト表示）
4. 各採取地に移動APコストと採取可能素材のプレビューが表示される
5. プレイヤーが採取地を選択する
6. 選択した採取地のドラフト採取セッションが開始される

**前提条件**:
- 手札に1枚以上の採取地カードがある
- 採取フェーズが表示されている

**制約事項**:
- 手札にない採取地は選択不可（グレーアウト表示）
- 移動APコストは採取地カードの基本コストを使用

**優先度**: Must Have

---

### ストーリー 2.2: 採取地カード未所持時の案内 🟡

**信頼性**: 🟡 *ゲーム体験の観点から妥当な推測*

**私は** プレイヤー **として**
**手札に採取地カードがない場合に案内を受けたい**
**そうすることで** 次に何をすべきか理解できる

**関連要件**: EDGE-103

**詳細シナリオ**:
1. プレイヤーが採取フェーズに切り替える
2. 手札に採取地カードが0枚の状態
3. 「採取地カードがありません」というメッセージが表示される
4. ショップへの誘導リンク/ボタンが表示される

**前提条件**:
- 手札に採取地カードが0枚

**優先度**: Could Have

**備考**: ショップへの誘導方法は設計フェーズで詳細化

---

### ストーリー 2.3: 場所選択後のドラフト採取 🔵

**信頼性**: 🔵 *既存仕様維持: ドラフト採取システム*

**私は** プレイヤー **として**
**採取地を選択した後、既存のドラフト採取（素材3つ提示→1つ選択）を行いたい**
**そうすることで** 慣れ親しんだ採取体験を維持できる

**関連要件**: REQ-002-05

**詳細シナリオ**:
1. プレイヤーが場所選択画面で採取地を選択する
2. 移動APコストが消費される
3. 既存のドラフト採取システムが開始される（素材3つ提示→1つ選択の繰り返し）
4. 採取完了後、場所選択画面に戻る

**前提条件**:
- 場所選択画面で有効な採取地を選択済み

**優先度**: Must Have

---

## エピック3: AP超過による自動日進行

### ストーリー 3.1: 採取時のAP超過による日進行 🔵

**信頼性**: 🔵 *ヒアリングQ2・Q3・Q5: AP超過で自動日進行*

**私は** プレイヤー **として**
**採取でAP上限（3）を超える消費をした場合、自動的に日が進行してほしい**
**そうすることで** 遠い採取地への遠征が自然な日数消費として表現される

**関連要件**: REQ-003, REQ-003-01, REQ-003-05

**詳細シナリオ**:
1. 現在AP残量2の状態で、基本コスト2の採取地を選択する
2. 採取完了後、合計AP消費が4（基本2 + 追加コスト）になる
3. AP上限3を超過したため、自動的に日が進行する
4. 翌日のAPは 3 - (4 - 3) = 2 で開始される
5. 日進行の通知が表示される

**前提条件**:
- ゲームが進行中（残り日数 > 0）

**制約事項**:
- 自動日進行時も既存の日終了処理（依頼期限更新、手札補充、ランク判定）を実行
- 翌日APは MAX(3) - 超過分

**優先度**: Must Have

---

### ストーリー 3.2: 調合時のAP超過による日進行 🔵

**信頼性**: 🔵 *ヒアリングQ8: レシピごとAPコスト、採取と同じ仕組み*

**私は** プレイヤー **として**
**調合でAP上限を超える消費をした場合、自動的に日が進行してほしい**
**そうすることで** 複雑なレシピの調合に時間がかかることが表現される

**関連要件**: REQ-003, REQ-003-01, REQ-003-06

**詳細シナリオ**:
1. 現在AP残量1の状態で、APコスト2のレシピを調合する
2. 合計AP消費が3（ちょうど上限）なので日は進行しない
3. 続けてAPコスト1のレシピを調合する
4. 累計AP消費が4となり上限を超過
5. 自動的に日が進行し、翌日AP = 3 - 1 = 2 で開始

**前提条件**:
- 調合に必要な素材を所持している

**制約事項**:
- レシピごとのAPコスト（1〜2）は既存設計を維持

**優先度**: Must Have

---

### ストーリー 3.3: AP超過プレビュー表示 🟡

**信頼性**: 🟡 *ゲーム体験の観点から妥当な推測*

**私は** プレイヤー **として**
**AP超過による自動日進行が発生する前に、消費APと翌日APをプレビューで確認したい**
**そうすることで** 意図しない日進行を避けられる

**関連要件**: NFR-102

**詳細シナリオ**:
1. プレイヤーがAP超過を伴う行動を選択する
2. 「AP 4消費 → 翌日AP 2で開始します。よろしいですか？」というプレビューが表示される
3. 「はい」を選択すると行動を実行し、自動日進行が発生する
4. 「いいえ」を選択すると行動をキャンセルする

**前提条件**:
- AP超過を伴う行動を選択している

**優先度**: Should Have

**備考**: プレビューUIの具体的なデザインは設計フェーズで詳細化

---

### ストーリー 3.4: 複数日分のAP超過 🟡

**信頼性**: 🟡 *ヒアリングQ5から妥当な推測: 大量AP消費時の挙動*

**私は** プレイヤー **として**
**AP上限の2倍以上を消費した場合、適切に複数日が消費されてほしい**
**そうすることで** 大きなAP消費でもゲームルールが一貫する

**関連要件**: REQ-003-03, EDGE-002

**詳細シナリオ**:
1. AP7を消費する行動を行う（例: 高コスト採取地 + 多数素材選択）
2. AP上限3に対して超過4 → 2日分消費
3. 各日の日終了処理が順次実行される（依頼期限-2、手札補充×2等）
4. 翌々日のAP = 3 - (7 - 6) = 2 で開始

**前提条件**:
- 残り日数が2日以上

**制約事項**:
- 各日の日終了処理を順次実行（スキップしない）
- 残り日数が0以下になった場合はゲームオーバー判定

**優先度**: Should Have

**備考**: AP超過の計算式: 消費日数 = ceil(消費AP / AP上限)、残余AP = 消費AP mod AP上限

---

### ストーリー 3.5: 自動日進行によるゲームオーバー 🔵

**信頼性**: 🔵 *既存仕様（checkGameOver）維持*

**私は** プレイヤー **として**
**自動日進行で残り日数が0になった場合、ゲームオーバー判定を受けたい**
**そうすることで** ゲームの終了条件が一貫する

**関連要件**: REQ-003-04

**詳細シナリオ**:
1. 残り日数1の状態でAP超過を伴う行動を行う
2. 自動日進行により残り日数が0になる
3. 既存のゲームオーバー判定（checkGameOver）が実行される
4. 条件を満たしていればゲームオーバー画面に遷移

**前提条件**:
- 残り日数が少ない状態

**優先度**: Must Have

---

## エピック4: 明示的日終了

### ストーリー 4.1: 手動での日終了 🔵

**信頼性**: 🔵 *ヒアリングQ7: 両方あり*

**私は** プレイヤー **として**
**任意のタイミングで「日終了」ボタンを押して日を終了したい**
**そうすることで** APを使い切らなくても日を進められる

**関連要件**: REQ-004, REQ-004-01

**詳細シナリオ**:
1. プレイヤーが任意のフェーズで「日終了」ボタンをクリックする
2. 残りAPが破棄される
3. 既存の日終了処理が実行される（依頼期限更新、手札補充、ランク判定）
4. 翌日がAP = 3 で開始される（超過なしのため通常回復）

**前提条件**:
- ゲームがメインシーンで実行中

**制約事項**:
- どのフェーズからでも「日終了」可能

**優先度**: Must Have

---

### ストーリー 4.2: 何もせず日終了 🔵

**信頼性**: 🔵 *既存仕様: ペナルティなし*

**私は** プレイヤー **として**
**何も行動せずに日を終了してもペナルティを受けたくない**
**そうすることで** 様子見の戦略も取れる

**関連要件**: EDGE-102

**詳細シナリオ**:
1. 日開始後、どのフェーズでも行動を行わない
2. 「日終了」ボタンをクリックする
3. 通常の日終了処理が実行される（ペナルティなし）
4. 翌日がAP = 3 で通常開始

**優先度**: Must Have

---

## エピック5: 依頼掲示板システム

### ストーリー 5.1: 掲示板での依頼確認 🔵

**信頼性**: 🔵 *ヒアリングQ6: 掲示板方式*

**私は** プレイヤー **として**
**掲示板に累積された依頼を確認して受注したい**
**そうすることで** 好きなタイミングで依頼を選べる

**関連要件**: REQ-005, REQ-005-01

**詳細シナリオ**:
1. プレイヤーが依頼受注フェーズに切り替える
2. 掲示板に過去から累積された依頼が一覧表示される
3. 期限切れの依頼は自動的に掲示板から消えている
4. プレイヤーが依頼を選択して受注する

**前提条件**:
- 依頼受注フェーズが表示されている
- 受注中の依頼が上限（3件）未満

**制約事項**:
- 同時受注上限3件は維持（REQ-401）
- 掲示板の依頼は期限切れまで残り続ける

**優先度**: Must Have

---

### ストーリー 5.2: 訪問依頼の受注 🔵

**信頼性**: 🔵 *ヒアリングQ6: 訪問方式の併用*

**私は** プレイヤー **として**
**数日ごとに更新される訪問依頼も確認して受注したい**
**そうすることで** 掲示板にない特別な依頼も受けられる

**関連要件**: REQ-005, REQ-005-02

**詳細シナリオ**:
1. 依頼受注フェーズで、訪問依頼セクションを確認する
2. 現在の訪問者による依頼が表示される
3. 数日経過すると訪問者が入れ替わり、新しい依頼が表示される
4. プレイヤーが訪問依頼を選択して受注する

**前提条件**:
- 依頼受注フェーズが表示されている

**制約事項**:
- 訪問依頼は数日で更新（具体的な日数は設計フェーズで決定）

**優先度**: Must Have

---

### ストーリー 5.3: ランクによる掲示板更新 🟡

**信頼性**: 🟡 *既存ランクシステムから妥当な推測*

**私は** プレイヤー **として**
**ギルドランクが上がると掲示板に掲載される依頼の質が変化してほしい**
**そうすることで** ランクアップの恩恵を実感できる

**関連要件**: REQ-005-03

**詳細シナリオ**:
1. ランクがGからFに昇格する
2. 掲示板に新しい難易度の依頼が追加されるようになる
3. 更新頻度がランクに応じて変化する

**優先度**: Could Have

**備考**: 具体的な更新頻度・難易度配分は設計フェーズで詳細化

---

## エピック6: タブ切り替えUI

### ストーリー 6.1: タブによるフェーズ切り替え 🔵

**信頼性**: 🔵 *ヒアリングQ9: タブ切り替えUIに変更*

**私は** プレイヤー **として**
**フッターのタブ（依頼/採取/調合/納品）をクリックしてフェーズを切り替えたい**
**そうすることで** 直感的にフェーズ移動ができる

**関連要件**: REQ-006, REQ-006-01, REQ-006-03

**詳細シナリオ**:
1. フッターに4つのタブ（依頼/採取/調合/納品）が表示される
2. プレイヤーが「調合」タブをクリックする
3. 即座に（200ms以内）調合フェーズの画面に切り替わる
4. 「調合」タブがアクティブ状態として強調表示される

**前提条件**:
- メインシーンでフッターUIが表示されている

**制約事項**:
- フェーズ切り替えは200ms以内に完了（NFR-001）

**優先度**: Must Have

---

### ストーリー 6.2: アクティブタブの視覚的強調 🟡

**信頼性**: 🟡 *既存PHASE_COLORSから妥当な推測*

**私は** プレイヤー **として**
**現在のフェーズが一目でわかるようにタブが強調表示されてほしい**
**そうすることで** 今どのフェーズにいるか迷わない

**関連要件**: REQ-006-02

**詳細シナリオ**:
1. プレイヤーが「採取」フェーズにいる
2. フッターの「採取」タブが他のタブと異なる色・スタイルで強調表示される
3. 他のタブは非アクティブ状態の色で表示される
4. フェーズを切り替えると、アクティブタブが即座に切り替わる

**優先度**: Should Have

**備考**: 具体的な色・スタイルは既存PHASE_COLORSを活用し、設計フェーズで詳細化

---

## エピック7: AP残量管理

### ストーリー 7.1: AP残量0での行動制限 🟡

**信頼性**: 🟡 *既存AP管理から妥当な推測*

**私は** プレイヤー **として**
**AP残量0の状態で行動しようとした場合、「日終了」を促されたい**
**そうすることで** 無駄な操作を避けられる

**関連要件**: EDGE-101

**詳細シナリオ**:
1. AP残量が0の状態で採取地を選択しようとする
2. 「APが足りません。日終了してAPを回復してください」というメッセージが表示される
3. プレイヤーは「日終了」ボタンを押して日を進行させる

**前提条件**:
- AP残量が0

**優先度**: Should Have

---

### ストーリー 7.2: 自動日進行の通知 🟡

**信頼性**: 🟡 *既存DAY_STARTEDイベント表示から推測*

**私は** プレイヤー **として**
**自動日進行が発生した時、日が進行したことを視覚的に確認したい**
**そうすることで** ゲームの状況変化を見逃さない

**関連要件**: NFR-101

**詳細シナリオ**:
1. AP超過により自動日進行が発生する
2. 「日が進みました（Day X → Day Y）」という通知が表示される
3. 翌日のAP残量が表示される
4. 一定時間後に通知が消え、ゲームプレイが続行される

**優先度**: Should Have

---

## ストーリーマップ

```
エピック1: フェーズ自由遷移
├── ストーリー 1.1 (🔵 Must Have) 任意フェーズへの切り替え
└── ストーリー 1.2 (🟡 Should Have) 採取中の切り替え確認

エピック2: 採取2段階化
├── ストーリー 2.1 (🔵 Must Have) 採取地の選択
├── ストーリー 2.2 (🟡 Could Have) 採取地カード未所持時の案内
└── ストーリー 2.3 (🔵 Must Have) 場所選択後のドラフト採取

エピック3: AP超過による自動日進行
├── ストーリー 3.1 (🔵 Must Have) 採取時のAP超過
├── ストーリー 3.2 (🔵 Must Have) 調合時のAP超過
├── ストーリー 3.3 (🟡 Should Have) AP超過プレビュー表示
├── ストーリー 3.4 (🟡 Should Have) 複数日分のAP超過
└── ストーリー 3.5 (🔵 Must Have) 自動日進行によるゲームオーバー

エピック4: 明示的日終了
├── ストーリー 4.1 (🔵 Must Have) 手動での日終了
└── ストーリー 4.2 (🔵 Must Have) 何もせず日終了

エピック5: 依頼掲示板システム
├── ストーリー 5.1 (🔵 Must Have) 掲示板での依頼確認
├── ストーリー 5.2 (🔵 Must Have) 訪問依頼の受注
└── ストーリー 5.3 (🟡 Could Have) ランクによる掲示板更新

エピック6: タブ切り替えUI
├── ストーリー 6.1 (🔵 Must Have) タブによるフェーズ切り替え
└── ストーリー 6.2 (🟡 Should Have) アクティブタブの視覚的強調

エピック7: AP残量管理
├── ストーリー 7.1 (🟡 Should Have) AP残量0での行動制限
└── ストーリー 7.2 (🟡 Should Have) 自動日進行の通知
```

## 信頼性レベルサマリー

- 🔵 青信号: 12件 (67%)
- 🟡 黄信号: 6件 (33%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: 高品質 - ヒアリングにより大半の要件が確認済み
