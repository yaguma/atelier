# フェーズ自由遷移システム ヒアリング記録

**作成日**: 2026-02-19
**ヒアリング実施**: step4 既存情報ベースの差分ヒアリング

## ヒアリング目的

既存のフェーズシステム（依頼受注→採取→調合→納品の固定順序）を自由遷移システムに変更するにあたり、具体的な仕様を明確化するためのヒアリングを実施しました。

## 質問と回答

### Q1: フェーズの自由切り替え方式

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 現在のフェーズ遷移は `VALID_PHASE_TRANSITIONS` で `QUEST_ACCEPT→GATHERING→ALCHEMY→DELIVERY` の一方向のみ許可されている。「切り替えられるようにしたい」の具体的な範囲を確認する必要があった。

**回答**: **完全自由切り替え** - どのフェーズからでも任意のフェーズに移動可能（例: 納品中に採取に戻る、調合中に依頼受注に戻る等）

**信頼性への影響**:
- REQ-001（フェーズ自由遷移）の信頼性レベルが 🔴 → 🔵 に向上
- `VALID_PHASE_TRANSITIONS` の全面改修が確定

---

### Q2: 採取での日数消費タイミング

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 現在の日数進行は `endDay()` のみ。「採取や調合でも日数が過ぎる」の具体的な仕組みを確認する必要があった。

**回答**: 「採取場所に行くのに採取地によってAPがかかる。その後、採取はAPで日数消費、日またぎあり。調合は作成するもので変化」

**信頼性への影響**:
- REQ-003（AP超過による自動日進行）が新規要件として追加（🔵）
- 既存の採取コスト計算（基本コスト+追加コスト）との統合方針が確定

---

### Q3: 採取場所への移動コスト

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 既存の「基本コスト（AP）」と新しい「移動日数」の関係を確認する必要があった。

**回答**: **既存APシステムを活用** - 基本コスト（AP）を維持し、消費APが上限（3）を超えた場合に翌日に持ち越す。

**信頼性への影響**:
- 既存の採取地カードの基本コスト設計がそのまま活用可能であることを確認（🔵）

---

### Q4: 採取場所選択画面のUI

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 採取を「場所選択→採取」の2段階に分ける際のUI仕様を確認する必要があった。

**回答**: 以下の全てを含む
- 採取地一覧（マップ表示）
- 移動日数（APコスト）の表示
- 採取可能素材のプレビュー
- 手札の採取地カードと連動

**信頼性への影響**:
- REQ-002（採取2段階化）の詳細UIが確定（🔵）

---

### Q5: AP上限超過時の日またぎ処理

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: AP消費が上限を超えた場合の具体的な処理を確認する必要があった。

**回答**: **AP上限超過で自動日進行** - AP4消費 → 翌日AP = 3 - (4-3) = AP2で開始

**信頼性への影響**:
- REQ-003の詳細仕様が確定（🔵）
- 既存のAP回復ロジック（日開始時にMAX_ACTION_POINTS=3に回復）の変更が必要

---

### Q6: 依頼受注の仕組み変更

**質問日時**: 2026-02-19
**カテゴリ**: 追加要件
**背景**: フェーズ自由化に伴い、「毎日新しい依頼者が来訪」する既存仕様との整合性を確認する必要があった。

**回答**: 「数日で変わる。ただし訪問＋掲示板の両方とする」- 掲示板方式（依頼が累積、期限切れで消える）と訪問方式の併用

**信頼性への影響**:
- REQ-005（依頼掲示板システム）が新規要件として追加（🔵）
- 既存のQuestService.generateDailyQuests()の変更が必要

---

### Q7: 日終了のトリガー

**質問日時**: 2026-02-19
**カテゴリ**: 既存設計確認
**背景**: フェーズ自由化により「納品後に日終了」の固定フローがなくなるため、日終了のトリガーを確認する必要があった。

**回答**: **両方あり** - 明示的な「日終了」ボタン + AP超過時の自動日進行

**信頼性への影響**:
- REQ-004（明示的日終了）とREQ-003（自動日進行）の両立が確定（🔵）

---

### Q8: 調合のコスト仕様

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 「作成するもので変化」の具体的な仕様を確認する必要があった。

**回答**: **レシピごとにAPコスト設定** - 既存の仕組み（レシピごとのAPコスト1〜2）を維持し、AP超過で日数消費（採取と同じ仕組み）

**信頼性への影響**:
- 既存のレシピAPコスト設計がそのまま活用可能（🔵）
- 調合もAP超過による自動日進行の対象であることが確定

---

### Q9: フェーズインジケーターの変更

**質問日時**: 2026-02-19
**カテゴリ**: 未定義部分詳細化
**背景**: 現在のプログレスバー形式のフェーズインジケーターの変更方針を確認する必要があった。

**回答**: **タブ切り替えUIに変更** - プログレスバーを廃止し、タブ（依頼/採取/調合/納品）で自由に切り替えるUIに変更

**信頼性への影響**:
- REQ-006（タブUIへの変更）が確定（🔵）
- FooterUIの大幅改修が必要

---

### Q10: 自動日進行時の日終了処理

**質問日時**: 2026-02-19
**カテゴリ**: 既存設計確認
**背景**: AP超過による自動日進行時に、既存の日終了処理（依頼期限-1、手札補充、ランク判定等）がそのまま実行されるかを確認する必要があった。

**回答**: **既存処理を維持** - 自動日進行時も既存の日終了処理（依頼期限更新、手札補充、AP回復、ランク判定）をそのまま実行

**信頼性への影響**:
- 既存のendDay()ロジックの再利用が確定（🔵）
- AP回復は「MAX - 超過分」に変更が必要

---

### Q11: その他の変更

**質問日時**: 2026-02-19
**カテゴリ**: 影響範囲確認
**背景**: フェーズシステム変更に伴い、他の既存機能への変更が必要かを確認する必要があった。

**回答**: **特になし** - 依頼受注上限（3件）、AP上限（3）、ショップ機能はそのまま維持

**信頼性への影響**:
- 影響範囲が限定的であることが確定
- 既存の数値バランスは変更不要

---

## ヒアリング結果サマリー

### 確認できた事項
- フェーズは完全自由遷移（タブUIで切り替え）
- 採取は「場所選択→ドラフト採取」の2段階
- 日数進行はAP超過（>3）による自動進行 + 明示的「日終了」ボタン
- AP超過分は翌日のAPから差し引き（AP4消費→翌日AP2）
- 依頼受注は掲示板方式+訪問方式の併用（数日で更新）
- 調合はレシピごとのAPコスト維持、AP超過で日進行
- 自動日進行時も既存の日終了処理を実行
- 既存の数値バランス（AP上限3、依頼上限3等）は維持

### 追加/変更要件
- フェーズ遷移ルール（VALID_PHASE_TRANSITIONS）の全面改修
- FooterUI: プログレスバー→タブ切り替えUIへの変更
- GatheringPhaseUI: 場所選択ステージの追加
- GameFlowManager: AP超過による自動日進行ロジックの追加
- QuestService: 掲示板方式+訪問方式への変更
- StateManager: AP回復ロジックの変更（超過分差し引き）

### 残課題
- 採取場所選択のマップUIの具体的なデザイン（🟡）
- 依頼掲示板の更新頻度の具体的な数値（「数日」の定義）（🟡）
- AP超過が大きい場合（例: AP6消費→2日分消費）の挙動（🟡）

### 信頼性レベル分布

**ヒアリング前**:
- 🔵 青信号: 0件
- 🟡 黄信号: 3件
- 🔴 赤信号: 8件

**ヒアリング後**:
- 🔵 青信号: 9件 (+9)
- 🟡 黄信号: 3件 (±0)
- 🔴 赤信号: 0件 (-8)

## 関連文書

- **要件定義書**: [requirements.md](requirements.md)
- **ユーザストーリー**: [user-stories.md](user-stories.md)
- **受け入れ基準**: [acceptance-criteria.md](acceptance-criteria.md)
