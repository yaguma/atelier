# フェーズ自由遷移システム 受け入れ基準

**作成日**: 2026-02-19
**関連要件定義**: [requirements.md](requirements.md)
**関連ユーザストーリー**: [user-stories.md](user-stories.md)
**ヒアリング記録**: [interview-record.md](interview-record.md)

**【信頼性レベル凡例】**:
- 🔵 **青信号**: ユーザヒアリング・既存設計文書を参考にした確実な基準
- 🟡 **黄信号**: ヒアリング内容・既存設計から妥当な推測による基準
- 🔴 **赤信号**: ヒアリング・設計文書にない推測による基準

---

## REQ-001: フェーズ自由遷移 🔵

**信頼性**: 🔵 *ヒアリングQ1: 完全自由切り替え*

### Given（前提条件）
- ゲームがメインシーンで実行中
- いずれかのフェーズ（依頼受注/採取/調合/納品）が表示されている

### When（実行条件）
- プレイヤーがフッターのタブUIで任意のフェーズタブをクリックする

### Then（期待結果）
- 即座にクリックしたフェーズの画面に切り替わる
- フッターのアクティブタブが切り替わる
- StateManagerの`currentPhase`が更新される
- `PHASE_CHANGED`イベントが発行される

### テストケース

#### 正常系

- [ ] **TC-001-01**: 依頼受注→採取への切り替え 🔵
  - **入力**: 依頼受注フェーズ表示中に「採取」タブクリック
  - **期待結果**: 採取フェーズの場所選択画面が表示される
  - **信頼性**: 🔵 *ヒアリングQ1: 完全自由切り替え*

- [ ] **TC-001-02**: 採取→調合への切り替え 🔵
  - **入力**: 採取フェーズ（場所選択画面）表示中に「調合」タブクリック
  - **期待結果**: 調合フェーズ画面が表示される
  - **信頼性**: 🔵 *ヒアリングQ1*

- [ ] **TC-001-03**: 調合→納品への切り替え 🔵
  - **入力**: 調合フェーズ表示中に「納品」タブクリック
  - **期待結果**: 納品フェーズ画面が表示される
  - **信頼性**: 🔵 *ヒアリングQ1*

- [ ] **TC-001-04**: 納品→依頼受注への切り替え 🔵
  - **入力**: 納品フェーズ表示中に「依頼」タブクリック
  - **期待結果**: 依頼受注フェーズ画面が表示される
  - **信頼性**: 🔵 *ヒアリングQ1*

- [ ] **TC-001-05**: 任意のフェーズから任意のフェーズへの切り替え（全12パターン） 🔵
  - **入力**: 4フェーズ × 3遷移先 = 12パターンの遷移
  - **期待結果**: すべてのパターンで正常に遷移する
  - **信頼性**: 🔵 *ヒアリングQ1: 完全自由切り替え*

- [ ] **TC-001-06**: 同一フェーズタブの再クリック 🟡
  - **入力**: 現在のフェーズと同じタブをクリック
  - **期待結果**: 何も起こらない（または画面がリフレッシュされる）
  - **信頼性**: 🟡 *既存showPhase()から妥当な推測*

#### 異常系

- [ ] **TC-001-E01**: ドラフト採取セッション中のフェーズ切り替え 🟡
  - **入力**: ドラフト採取セッション進行中に別フェーズタブクリック
  - **期待結果**: 確認ダイアログが表示される
  - **信頼性**: 🟡 *既存GatheringPhaseUI状態管理から推測*

---

## REQ-002: 採取2段階化 🔵

**信頼性**: 🔵 *ヒアリングQ4: 採取地一覧・マップ表示*

### Given（前提条件）
- 採取フェーズが表示されている
- 手札に1枚以上の採取地カードがある

### When（実行条件）
- プレイヤーが採取フェーズに遷移する

### Then（期待結果）
- 場所選択画面がマップ形式で表示される
- 手札の採取地カードに対応する場所が選択可能状態で表示される
- 各採取地に移動APコストが表示される
- 各採取地に採取可能素材のプレビューが表示される

### テストケース

#### 正常系

- [ ] **TC-002-01**: 場所選択画面の表示 🔵
  - **入力**: 採取フェーズに遷移（手札に採取地カード2枚所持）
  - **期待結果**: マップ形式の場所選択画面が表示され、2箇所が選択可能状態
  - **信頼性**: 🔵 *ヒアリングQ4*

- [ ] **TC-002-02**: 移動APコストの表示 🔵
  - **入力**: 場所選択画面表示
  - **期待結果**: 各採取地に基本コスト（AP）が表示される
  - **信頼性**: 🔵 *ヒアリングQ4: 移動日数の表示*

- [ ] **TC-002-03**: 採取可能素材プレビューの表示 🔵
  - **入力**: 場所選択画面表示
  - **期待結果**: 各採取地で入手可能な素材のプレビューが表示される
  - **信頼性**: 🔵 *ヒアリングQ4: 採取可能素材のプレビュー*

- [ ] **TC-002-04**: 手札連動による選択可能制限 🔵
  - **入力**: 手札に「森」カードのみ所持、マップに「森」「山」「洞窟」表示
  - **期待結果**: 「森」のみ選択可能、「山」「洞窟」は選択不可（グレーアウト）
  - **信頼性**: 🔵 *ヒアリングQ4: 手札連動*

- [ ] **TC-002-05**: 採取地選択後のドラフト採取開始 🔵
  - **入力**: 有効な採取地を選択
  - **期待結果**: 既存のドラフト採取システム（素材3つ提示→1つ選択）が開始される
  - **信頼性**: 🔵 *既存仕様維持*

#### 異常系

- [ ] **TC-002-E01**: 手札に採取地カード0枚 🟡
  - **入力**: 採取フェーズに遷移（手札に採取地カードなし）
  - **期待結果**: 「採取地カードがありません」メッセージとショップ誘導が表示される
  - **信頼性**: 🟡 *ゲーム体験の観点から推測*

- [ ] **TC-002-E02**: 手札にない採取地の選択試行 🟡
  - **入力**: グレーアウトされた採取地をクリック
  - **期待結果**: 選択が無効化される（何も起きない、またはツールチップ表示）
  - **信頼性**: 🟡 *UI操作の妥当な推測*

---

## REQ-003: AP超過による自動日進行 🔵

**信頼性**: 🔵 *ヒアリングQ5: AP上限超過で自動日進行*

### Given（前提条件）
- ゲームが進行中（残り日数 > 0）
- AP上限は3

### When（実行条件）
- プレイヤーの行動によりAP消費が上限（3）を超過する

### Then（期待結果）
- 自動的に日が進行する
- 翌日のAPは MAX(3) - 超過分 で開始される
- 既存の日終了処理（依頼期限更新、手札補充、ランク判定）が実行される
- 日進行の通知が表示される

### テストケース

#### 正常系

- [ ] **TC-003-01**: AP超過1での自動日進行（採取） 🔵
  - **入力**: AP残量2で基本コスト2の採取地を選択（合計AP消費4）
  - **期待結果**: 自動日進行、翌日AP = 3 - 1 = 2
  - **信頼性**: 🔵 *ヒアリングQ5: AP4消費→翌日AP2*

- [ ] **TC-003-02**: AP超過1での自動日進行（調合） 🔵
  - **入力**: AP残量1でAPコスト2のレシピ調合、続けてAPコスト1のレシピ調合（合計AP消費4）
  - **期待結果**: 自動日進行、翌日AP = 3 - 1 = 2
  - **信頼性**: 🔵 *ヒアリングQ8: レシピごとAPコスト*

- [ ] **TC-003-03**: AP上限ちょうどでは日が進行しない 🔵
  - **入力**: AP残量3で合計AP消費3の行動
  - **期待結果**: 日は進行せず、AP残量0になる
  - **信頼性**: 🔵 *AP上限の仕様*

- [ ] **TC-003-04**: 自動日進行時の日終了処理実行 🔵
  - **入力**: AP超過による自動日進行発生
  - **期待結果**: 依頼期限-1、手札補充、ランク判定が実行される
  - **信頼性**: 🔵 *ヒアリングQ10: 既存処理を維持*

- [ ] **TC-003-05**: 複数日分のAP超過 🟡
  - **入力**: AP残量3で合計AP消費7
  - **計算**: apAfterAction = 3 - 7 = -4, overflow = 4, daysConsumed = ceil(4/3) = 2, newAP = (3×2) - 4 = 2
  - **期待結果**: 2日分消費（日終了処理が2回実行される）、翌々日AP = 2
  - **信頼性**: 🟡 *AP超過計算アルゴリズムv1.1に基づく*

- [ ] **TC-003-06**: AP超過分の翌日差し引き 🔵
  - **入力**: AP超過2で自動日進行
  - **期待結果**: 翌日AP = 3 - 2 = 1
  - **信頼性**: 🔵 *ヒアリングQ5*

#### 異常系

- [ ] **TC-003-E01**: 自動日進行でゲームオーバー 🔵
  - **入力**: 残り日数1でAP超過による自動日進行
  - **期待結果**: ゲームオーバー判定が実行される
  - **信頼性**: 🔵 *既存checkGameOver仕様維持*

- [ ] **TC-003-E02**: 複数日AP超過で途中ゲームオーバー 🟡
  - **入力**: 残り日数2でAP7消費（3日分）
  - **期待結果**: 2日目で残り日数0、ゲームオーバー判定
  - **信頼性**: 🟡 *REQ-003-03から推測*

#### 境界値

- [ ] **TC-003-B01**: AP消費ちょうど上限（3） 🔵
  - **入力**: AP消費3
  - **期待結果**: 日は進行しない、AP残量0
  - **信頼性**: 🔵 *AP上限仕様*

- [ ] **TC-003-B02**: AP消費上限+1（4） 🔵
  - **入力**: AP消費4
  - **期待結果**: 1日進行、翌日AP = 2
  - **信頼性**: 🔵 *ヒアリングQ5*

- [ ] **TC-003-B03**: AP消費上限×2（6）、AP残量3 🟡
  - **入力**: AP残量3でAP消費6
  - **計算**: apAfterAction = -3, overflow = 3, daysConsumed = ceil(3/3) = 1, newAP = 3 - 3 = 0
  - **期待結果**: 1日進行、翌日AP = 0
  - **信頼性**: 🟡 *AP超過計算アルゴリズムv1.1に基づく*

- [ ] **TC-003-B04**: AP消費上限×2+1（7）は実行不可 🟡
  - **入力**: AP消費7を試行
  - **期待結果**: REQ-003-08により実行不可（AP上限×2=6が最大）
  - **信頼性**: 🟡 *AP超過上限ルール*

- [ ] **TC-003-B05**: AP消費6、AP残量0 🟡
  - **入力**: AP残量0でAP消費6
  - **計算**: apAfterAction = -6, overflow = 6, daysConsumed = ceil(6/3) = 2, newAP = 6 - 6 = 0
  - **期待結果**: 2日進行、翌々日AP = 0
  - **信頼性**: 🟡 *AP超過計算アルゴリズムv1.1に基づく*

---

## REQ-004: 明示的日終了 🔵

**信頼性**: 🔵 *ヒアリングQ7: 両方あり*

### Given（前提条件）
- ゲームがメインシーンで実行中
- 任意のフェーズが表示されている

### When（実行条件）
- プレイヤーが「日終了」ボタンをクリックする

### Then（期待結果）
- 残りAPが破棄される
- 既存の日終了処理が実行される
- 翌日がAP = 3 で開始される（超過なし）

### テストケース

#### 正常系

- [ ] **TC-004-01**: AP残量ありでの日終了 🔵
  - **入力**: AP残量2の状態で「日終了」クリック
  - **期待結果**: AP2が破棄され、翌日AP = 3で開始
  - **信頼性**: 🔵 *ヒアリングQ7*

- [ ] **TC-004-02**: AP残量0での日終了 🟡
  - **入力**: AP残量0の状態で「日終了」クリック
  - **期待結果**: 翌日AP = 3で開始
  - **信頼性**: 🟡 *既存endDay()から推測*

- [ ] **TC-004-03**: 何も行動せず日終了 🔵
  - **入力**: 日開始直後（AP = 3）で「日終了」クリック
  - **期待結果**: 通常の日終了処理が実行される（ペナルティなし）
  - **信頼性**: 🔵 *既存仕様: ペナルティなし*

- [ ] **TC-004-04**: 各フェーズからの日終了 🔵
  - **入力**: 依頼受注/採取/調合/納品の各フェーズから「日終了」
  - **期待結果**: どのフェーズからでも正常に日終了処理が実行される
  - **信頼性**: 🔵 *ヒアリングQ7*

---

## REQ-005: 依頼掲示板システム 🔵

**信頼性**: 🔵 *ヒアリングQ6: 訪問+掲示板の両方*

### Given（前提条件）
- 依頼受注フェーズが表示されている

### When（実行条件）
- プレイヤーが依頼一覧を確認する

### Then（期待結果）
- 掲示板の累積依頼と訪問依頼が両方表示される
- 期限切れの依頼は掲示板から消えている
- 訪問依頼は数日ごとに更新されている

### テストケース

#### 正常系

- [ ] **TC-005-01**: 掲示板依頼の累積表示 🔵
  - **入力**: 複数日経過後に依頼受注フェーズを表示
  - **期待結果**: 過去に掲載された依頼が（期限内のものは）累積表示される
  - **信頼性**: 🔵 *ヒアリングQ6: 掲示板方式*

- [ ] **TC-005-02**: 期限切れ依頼の自動削除 🔵
  - **入力**: 期限切れの依頼がある状態で掲示板を表示
  - **期待結果**: 期限切れの依頼は掲示板から消えている
  - **信頼性**: 🔵 *ヒアリングQ6: 期限切れで消える*

- [ ] **TC-005-03**: 訪問依頼の表示 🔵
  - **入力**: 依頼受注フェーズを表示
  - **期待結果**: 訪問者による依頼が表示される
  - **信頼性**: 🔵 *ヒアリングQ6: 訪問方式*

- [ ] **TC-005-04**: 訪問依頼の数日ごとの更新 🔵
  - **入力**: 数日経過後に依頼受注フェーズを表示
  - **期待結果**: 訪問者が入れ替わり、新しい依頼が表示される
  - **信頼性**: 🔵 *ヒアリングQ6: 数日で変わる*

#### 異常系

- [ ] **TC-005-E01**: 受注上限到達時の受注試行 🔵
  - **入力**: 受注中の依頼が3件の状態で新たな依頼を受注しようとする
  - **期待結果**: 受注不可のメッセージが表示される
  - **信頼性**: 🔵 *既存仕様: 同時受注上限3件*

---

## REQ-006: タブ切り替えUI 🔵

**信頼性**: 🔵 *ヒアリングQ9: タブ切り替えUIに変更*

### Given（前提条件）
- メインシーンのフッターUIが表示されている

### When（実行条件）
- プレイヤーがフェーズタブをクリックする

### Then（期待結果）
- 4つのタブ（依頼/採取/調合/納品）が表示されている
- クリックしたタブのフェーズに即座に切り替わる
- アクティブタブが視覚的に強調される

### テストケース

#### 正常系

- [ ] **TC-006-01**: 4つのタブの表示 🔵
  - **入力**: メインシーン表示
  - **期待結果**: フッターに「依頼」「採取」「調合」「納品」の4タブが表示される
  - **信頼性**: 🔵 *ヒアリングQ9*

- [ ] **TC-006-02**: タブクリックによるフェーズ切り替え 🔵
  - **入力**: 非アクティブなタブをクリック
  - **期待結果**: 対応するフェーズに切り替わる
  - **信頼性**: 🔵 *ヒアリングQ9、REQ-001*

- [ ] **TC-006-03**: アクティブタブの強調表示 🟡
  - **入力**: フェーズ切り替え後
  - **期待結果**: 現在のフェーズタブが他タブと異なるスタイルで強調される
  - **信頼性**: 🟡 *既存PHASE_COLORSから推測*

---

## 非機能要件テスト

### NFR-001: フェーズ切り替えパフォーマンス 🟡

**信頼性**: 🟡 *既存showPhase()のパフォーマンスから推測*

- [ ] **TC-NFR-001-01**: フェーズ切り替えレスポンス時間
  - **測定項目**: タブクリックからUI表示完了までの時間
  - **目標値**: 200ms以内
  - **測定条件**: 全12パターンの遷移で計測
  - **信頼性**: 🟡 *既存パフォーマンスから推測*

### NFR-002: 自動日進行パフォーマンス 🟡

**信頼性**: 🟡 *既存endDay()+startDay()から推測*

- [ ] **TC-NFR-002-01**: 自動日進行処理時間
  - **測定項目**: AP超過検知から次日開始までの時間
  - **目標値**: 500ms以内
  - **測定条件**: 1日分の日進行
  - **信頼性**: 🟡 *既存パフォーマンスから推測*

- [ ] **TC-NFR-002-02**: 複数日進行処理時間
  - **測定項目**: 複数日分の日進行処理時間
  - **目標値**: 500ms × 日数以内
  - **測定条件**: 2-3日分の日進行
  - **信頼性**: 🟡 *推測*

### NFR-101: 自動日進行通知 🟡

**信頼性**: 🟡 *既存DAY_STARTEDイベントから推測*

- [ ] **TC-NFR-101-01**: 日進行通知の表示
  - **検証内容**: 自動日進行時に視覚的通知が表示されること
  - **期待結果**: 「Day X → Day Y」の通知表示
  - **信頼性**: 🟡 *推測*

### NFR-102: AP超過プレビュー 🟡

**信頼性**: 🟡 *ゲーム体験の観点から推測*

- [ ] **TC-NFR-102-01**: AP超過プレビュー表示
  - **検証内容**: AP超過を伴う行動の前にプレビューが表示されること
  - **期待結果**: 消費AP、翌日APのプレビュー表示と確認ダイアログ
  - **信頼性**: 🟡 *推測*

---

## Edgeケーステスト

### EDGE-001: 採取中のフェーズ切り替え 🟡

**信頼性**: 🟡 *既存GatheringPhaseUI状態管理から推測*

- [ ] **TC-EDGE-001-01**: ドラフト採取中のフェーズ切り替え
  - **条件**: ドラフト採取セッション中（素材選択中）にフェーズ切り替え
  - **期待結果**: 確認ダイアログ表示、「はい」で中断して切り替え、「いいえ」で継続
  - **信頼性**: 🟡 *推測*

### EDGE-002: 複数日AP超過の順次処理 🟡

**信頼性**: 🟡 *REQ-003-03から推測*

- [ ] **TC-EDGE-002-01**: 2日分の日終了処理順次実行
  - **条件**: AP残量1でAP5消費（overflow=4, daysConsumed=2）
  - **期待結果**: 各日の日終了処理（依頼期限更新、手札補充等）が順次2回実行される
  - **信頼性**: 🟡 *AP超過計算アルゴリズムv1.1に基づく*

### EDGE-101: AP残量0での行動試行 🟡

**信頼性**: 🟡 *既存AP管理から推測*

- [ ] **TC-EDGE-101-01**: AP0で採取試行
  - **条件**: AP残量0で採取地を選択しようとする
  - **期待結果**: 「APが足りません」メッセージと「日終了」誘導表示
  - **信頼性**: 🟡 *推測*

### EDGE-102: 行動なし日終了 🔵

**信頼性**: 🔵 *既存仕様*

- [ ] **TC-EDGE-102-01**: 何も行動せず日終了
  - **条件**: 日開始後、何も行動せず「日終了」
  - **期待結果**: 通常の日終了処理実行、ペナルティなし
  - **信頼性**: 🔵 *既存仕様*

### EDGE-103: 採取地カード0枚 🟡

**信頼性**: 🟡 *ゲーム体験の観点から推測*

- [ ] **TC-EDGE-103-01**: 採取地カード0枚で採取フェーズ表示
  - **条件**: 手札に採取地カード0枚
  - **期待結果**: 案内メッセージとショップ誘導表示
  - **信頼性**: 🟡 *推測*

---

## テストケースサマリー

### カテゴリ別件数

| カテゴリ | 正常系 | 異常系 | 境界値 | 合計 |
|---------|--------|--------|--------|------|
| 機能要件（REQ-001〜006） | 22 | 5 | 4 | 31 |
| 非機能要件（NFR） | 4 | 0 | 0 | 4 |
| Edgeケース（EDGE） | 0 | 5 | 0 | 5 |
| **合計** | **26** | **10** | **4** | **40** |

### 信頼性レベル分布

- 🔵 青信号: 24件 (60%)
- 🟡 黄信号: 16件 (40%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: 高品質 - 主要な正常系テストケースはヒアリングに基づいた確実な基準

### 優先度別テストケース

- **Must Have**: 31件（機能要件の正常系・異常系・境界値）
- **Should Have**: 9件（非機能要件・Edgeケース）

---

## テスト実施計画

### Phase 1: 基本機能テスト
- REQ-001: フェーズ自由遷移（全12遷移パターン）
- REQ-006: タブ切り替えUI
- REQ-004: 明示的日終了
- 優先度: Must Have
- 対応ストーリー: 1.1, 4.1, 4.2, 6.1

### Phase 2: 採取・日進行テスト
- REQ-002: 採取2段階化
- REQ-003: AP超過による自動日進行
- 優先度: Must Have
- 対応ストーリー: 2.1, 2.3, 3.1, 3.2, 3.5

### Phase 3: 依頼掲示板テスト
- REQ-005: 依頼掲示板システム
- 優先度: Must Have
- 対応ストーリー: 5.1, 5.2

### Phase 4: エッジケース・非機能テスト
- EDGE-001〜103: エッジケース
- NFR-001〜102: 非機能要件
- 優先度: Should Have
- 対応ストーリー: 1.2, 3.3, 3.4, 6.2, 7.1, 7.2
