# フェーズ自由遷移システム 設計ヒアリング記録

**作成日**: 2026-02-19
**ヒアリング実施**: 既存情報ベースの設計判断

## ヒアリング目的

既存の要件定義・設計文書・実装コードを確認し、技術設計に必要な不明点や設計判断を明確化するための調査を実施しました。要件定義フェーズで包括的なヒアリングが完了しているため、設計フェーズでは既存情報に基づく技術的判断の記録を中心とします。

---

## 設計判断記録

### D1: VALID_PHASE_TRANSITIONSの変更方式

**判断日時**: 2026-02-19
**カテゴリ**: アーキテクチャ
**背景**: 現在の `VALID_PHASE_TRANSITIONS` は `initial-state.ts` で `Record<GamePhase, GamePhase[]>` として定義されている。全フェーズ間の遷移を許可する方式として、(A) 既存の構造を維持して値のみ変更、(B) バリデーション自体を廃止 の2案があった。

**判断**: **(A) 既存の構造を維持して値のみ変更**

**理由**:
- 既存の `StateManager.canTransitionTo()` がそのまま活用可能
- 将来的に特定の遷移を制限する必要が出た場合（例: 条件付きフェーズロック）にも対応可能
- 最小限の変更で要件を満たせる

**信頼性への影響**:
- VALID_PHASE_TRANSITIONSの変更 → 🔵（既存構造の値変更のみ）
- StateManager.setPhase() → 🔵（変更不要が確定）

---

### D2: AP超過計算ロジックの配置

**判断日時**: 2026-02-19
**カテゴリ**: アーキテクチャ
**背景**: AP超過計算（消費AP > 残AP → 日数消費を算出）をどのレイヤーに配置するか。(A) GatheringService/AlchemyService内に組み込み、(B) 独立した純粋関数サービスとして新設。

**判断**: **(B) 独立した APOverflowService を新設**

**理由**:
- 採取・調合の両方で使用する共通ロジック（DRY原則）
- 純粋関数としてテスト容易性を最大化（Functional Core パターン）
- 既存の GatheringService.calculateGatheringCost() と AlchemyService.getAlchemyCost() は消費AP計算まで担当し、超過判定は APOverflowService に委譲

**信頼性への影響**:
- APOverflowService → 🔵（Functional Coreパターンに従った設計）
- 配置: `src/features/gathering/services/ap-overflow-service.ts`（将来的に `src/shared/services/` に移動検討）

---

### D3: 採取セッション中断時の状態保持方針

**判断日時**: 2026-02-19
**カテゴリ**: データモデル
**背景**: 採取ドラフトセッション中にフェーズを切り替えた場合、セッションを保持するか破棄するか。(A) セッション保持（戻った時に続きから）、(B) セッション破棄（戻った時は場所選択から）。

**判断**: **(B) セッション破棄**

**理由**:
- 既存の `GatheringPhaseUI` ではフェーズ離脱時に `finalizeGatheringSession()` を呼び出しており、セッション破棄パターンが確立されている
- セッション保持は状態管理の複雑化を招く（部分的に選択した素材の一時保存が必要）
- REQ-001-03の「中断してフェーズ切り替え」は確認ダイアログで対応し、中断=破棄とする
- ユーザー体験上、採取セッションは短時間（数操作）で完了するため、やり直しのコストは低い

**信頼性への影響**:
- EDGE-001の実装方針 → 🟡（妥当な推測、ユーザー確認推奨）

---

### D4: FooterUIの変更方針

**判断日時**: 2026-02-19
**カテゴリ**: UI設計
**背景**: 現在のFooterUIのプログレスバーをタブUIに変更する方式として、(A) FooterUI内のプログレスバー部分のみ置換、(B) PhaseTabUIを別コンポーネントとして新設しFooterUIに組み込み。

**判断**: **(B) PhaseTabUI を別コンポーネントとして新設**

**理由**:
- 単一責任原則: タブ切り替え機能を独立コンポーネントとして管理
- FooterUI は手札カード表示・アクションボタンとの統合レイアウトを担当
- PhaseTabUI はフェーズ切り替え・アクティブ表示の責務に集中
- テスト容易性: PhaseTabUI 単体でのテストが可能

**信頼性への影響**:
- PhaseTabUI → 🔵（REQ-006の要件に直接対応）
- FooterUI変更 → 🟡（レイアウト詳細は推測）

---

### D5: 掲示板サービスの配置

**判断日時**: 2026-02-19
**カテゴリ**: アーキテクチャ
**背景**: 掲示板管理ロジックの配置先として、(A) 既存QuestService内に追加、(B) QuestBoardServiceとして新設。

**判断**: **(B) QuestBoardService として新設**

**理由**:
- 既存 QuestService は依頼生成・受注・完了判定を担当
- 掲示板管理（累積、期限切れ削除、訪問更新）は別の責務
- Feature-Based Architecture に従い、機能の追加は既存ファイルの肥大化ではなく新ファイル作成が望ましい

**信頼性への影響**:
- QuestBoardService → 🟡（配置・APIは妥当な推測）

---

### D6: 自動日進行の複数日消費時の処理順序

**判断日時**: 2026-02-19
**カテゴリ**: データモデル
**背景**: AP超過が大きい場合（例: AP6消費で2日分）、日終了処理をどう実行するか。(A) 2回のendDay()を順次実行、(B) 一括処理で2日分をまとめて処理。

**判断**: **(A) 順次実行**

**理由**:
- REQ-003-02「自動日進行時も、既存の日終了処理を実行」の要件を忠実に実現
- EDGE-002「各日の日終了処理を順次実行」の要件に直接対応
- 各日の依頼期限更新・手札補充が正しく行われることを保証
- ゲームオーバー判定を各日で行い、途中でゲームオーバーになった場合に正しく停止

**信頼性への影響**:
- 複数日消費処理 → 🔵（EDGE-002の要件に直接対応）

---

### D7: AP超過プレビューの表示タイミング

**判断日時**: 2026-02-19
**カテゴリ**: UX設計
**背景**: AP超過が発生する行動の実行前にプレビューを表示するタイミングとして、(A) 行動確定ボタン押下前（常時表示）、(B) 行動確定ボタン押下後・実行前（確認ダイアログ）。

**判断**: **(B) 行動確定後の確認ダイアログ**

**理由**:
- NFR-102「AP超過による自動日進行前に、消費APと翌日APをプレビュー表示」
- 「自動日進行前に」というタイミングは、行動確定後が自然
- 確認ダイアログ方式により、ユーザーが意図せず日を進めてしまうことを防止
- 常時表示は情報過多になりUIが煩雑になる

**信頼性への影響**:
- AP超過プレビュー → 🟡（表示方式の詳細は妥当な推測）

---

### D8: 場所選択UIの表示方式

**判断日時**: 2026-02-19
**カテゴリ**: UI設計
**背景**: 採取場所選択のマップUIの実装方式として、(A) rexUIのscrollablePanel内にカード形式でリスト表示、(B) Phaserの座標ベースでマップ上にアイコン配置。

**判断**: **(A) rexUI scrollablePanel + カード形式リスト**

**理由**:
- 既存の手札表示・依頼一覧がrexUIベースのリスト表示
- UIの一貫性を維持
- マップ表示はREQ-002-01で言及されているが、初期実装ではリスト形式で要件を満たし、マップビジュアルは段階的に追加可能
- 各カードにAPコスト・素材プレビューを表示する構成は既存パターンと整合

**信頼性への影響**:
- LocationSelectUI → 🟡（UIデザインの詳細は推測、マップ表示の具体的ビジュアルは未定）

---

## 設計判断サマリー

### 確認できた事項
- VALID_PHASE_TRANSITIONS は既存構造を維持して値のみ変更（最小影響）
- StateManager.setPhase() は変更不要（既存バリデーションがそのまま使える）
- AP超過計算は純粋関数として独立サービス化（テスト容易性）
- 複数日消費は順次endDay()実行（要件EDGE-002に直接対応）
- FooterUI のタブUI化は別コンポーネント新設方式

### 設計方針の決定事項
- Functional Core パターンの維持・拡張
- 採取セッション中断時はセッション破棄（保持しない）
- AP超過プレビューは確認ダイアログ方式
- 場所選択は初期はリスト形式、マップビジュアルは段階的追加

### 残課題
- 採取場所選択のマップUIの具体的なビジュアルデザイン（🟡）
- 依頼掲示板の更新頻度の具体的な数値（「数日」の定義、REQ-005-02）（🟡）
- PhaseTabUI のデザイン詳細（タブサイズ、アニメーション等）（🟡）

### 信頼性レベル分布

**設計判断前（要件定義のみ）**:
- 🔵 青信号: 5件
- 🟡 黄信号: 3件
- 🔴 赤信号: 0件

**設計判断後**:
- 🔵 青信号: 6件 (+1)
- 🟡 黄信号: 2件 (-1)
- 🔴 赤信号: 0件 (±0)

---

## 関連文書

- **アーキテクチャ設計**: [architecture.md](architecture.md)
- **データフロー**: [dataflow.md](dataflow.md)
- **型定義**: [interfaces.ts](interfaces.ts)
- **要件定義**: [requirements.md](../../spec/free-phase-navigation/requirements.md)
- **要件ヒアリング記録**: [interview-record.md](../../spec/free-phase-navigation/interview-record.md)
- **ユーザストーリー**: [user-stories.md](../../spec/free-phase-navigation/user-stories.md)
- **受け入れ基準**: [acceptance-criteria.md](../../spec/free-phase-navigation/acceptance-criteria.md)
