# システムアーキテクチャ設計書

**バージョン**: 2.0.0
**作成日**: 2026-01-01
**最終更新**: 2026-01-14
**対象**: アトリエ錬金術ゲーム（ギルドランク制）Phaser版

# システムアーキテクチャ設計書 - 概要

このドキュメントは [システムアーキテクチャ設計書](architecture.md) の一部なのだ。

---

## 概要

本ドキュメントは、錬金術をテーマにしたギルドランク制デッキ構築RPGのシステムアーキテクチャを定義する。

### システム概要

> 錬金術師（プレイヤー）が、採取地カードとレシピカードのデッキを駆使し、
> 依頼を達成して貢献度を稼ぎ、ギルドランクという「敵」を倒していく
> 「戦略的デッキ構築」と「ランクアップの達成感」を味わうゲーム

### アーキテクチャの特徴

- **Clean Architecture（4層構造）** によるビジネスロジックの独立性確保
- **Phaserフレームワーク** による洗練されたゲームUI表現
- **イベント駆動設計** による疎結合な通信
- Domain/Application/Infrastructure層は既存設計を維持し、Presentation層のみPhaserに置き換え

### 信頼性レベル凡例

- 🔵 **青信号**: 要件定義書・既存設計書に詳細記載
- 🟡 **黄信号**: 要件定義書・既存設計から妥当な推測
- 🔴 **赤信号**: Phaser対応のための新規追加

---

## 1. 技術スタック 🔴

### 1.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| TypeScript | 5.x | メイン言語 |
| **Phaser** | 3.87+ | ゲームフレームワーク |
| **rexUI Plugin** | 最新 | UIコンポーネント（ダイアログ、ボタン等） |
| Vite | 5.x | ビルドツール |

### 1.2 データ永続化

| 技術 | 用途 |
|------|------|
| localStorage | セーブデータ保存 |
| JSON | マスターデータ形式 |

### 1.3 依存ライブラリ

| ライブラリ | 用途 | 必須 |
|-----------|------|------|
| phaser | ゲームフレームワーク | ○ |
| phaser3-rex-plugins | UI拡張（Dialog, Buttons, Sizer等） | ○ |

**設計方針**:
- 既存のDomain/Application/Infrastructure層はそのまま維持
- Presentation層のみPhaserに置き換え
- ビジネスロジックはPhaserに依存しない
- 外部依存を必要最小限に抑える

---

## 2. アーキテクチャパターン 🟡

### 2.1 採用パターン

- **Clean Architecture**: 4層構造による責務分離
- **Scene-based Architecture**: Phaserのシーン管理を活用 🔴
- **イベント駆動設計**: EventBusによる疎結合な通信
- **State Machine**: フェーズ管理に状態機械パターンを適用

### 2.2 選択理由

| パターン | 理由 |
|---------|------|
| Clean Architecture | ビジネスロジックの独立性確保、テスタビリティ向上 |
| Scene-based | Phaserの画面管理との親和性 |
| イベント駆動 | UI・ロジック間およびPhaser-Domain間の疎結合化、拡張性確保 |
| State Machine | フェーズ遷移の厳密な管理、不正遷移防止 |

---

## 3. レイヤー構造 🔴

```
┌─────────────────────────────────────────────────────────────┐
│                 Presentation Layer (Phaser)                 │
│  (Phaser Scenes, GameObjects, rexUI Components)             │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │BootScene   │ │ TitleScene  │ │ MainScene   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ ShopScene   │ │RankUpScene  │ │ResultScene  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────────────────────────────────────┐           │
│  │           UI Components (rexUI)              │           │
│  │  Dialog, Buttons, Sizer, ProgressBar, etc.  │           │
│  └─────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────┘
                           ↓↑ Events / Method Calls
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
│  (ゲームフロー制御, 状態管理, イベント調整)                    │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │GameFlowMgr  │ │PhaseManager │ │ EventBus    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐                           │
│  │StateManager │ │ UseCases    │                           │
│  └─────────────┘ └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
                           ↓↑ Method Calls
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                           │
│  (ビジネスロジック, ドメインサービス, エンティティ)             │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ DeckService │ │GatheringSvc │ │ AlchemySvc  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ QuestService│ │ContribCalc  │ │ ShopService │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ RankService │ │ArtifactSvc  │ │MaterialSvc  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                           ↓↑ Data Access
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                      │
│  (データアクセス, 外部システム連携, ユーティリティ)            │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │SaveDataRepo │ │MasterLoader │ │RandomGen    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 3.1 各レイヤーの責務

| レイヤー | 責務 | 依存可能なレイヤー | 変更点 |
|---------|------|------------------|--------|
| Presentation | UI表示、ユーザー入力受付 | Application | **Phaser化** |
| Application | ゲームフロー制御、状態管理 | Domain | 維持 |
| Domain | ビジネスロジック、ルール実装 | Infrastructure (インターフェース経由) | 維持 |
| Infrastructure | データ永続化、外部連携 | なし | 維持 |

---


---

## 関連文書

- [→ Phaser実装設計](architecture-phaser.md)
- [コンポーネント設計](architecture-components.md)
- [コアシステム設計](core-systems-overview.md)
