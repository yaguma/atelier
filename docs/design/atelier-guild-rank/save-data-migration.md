# セーブデータマイグレーション設計書

**バージョン**: 1.0.0
**作成日**: 2026-02-24
**関連Issue**: #310
**対象**: アトリエ錬金術ゲーム（ギルドランク制）HTML版

---

## 1. 概要

### 1.1 背景

フェーズ自由遷移システムの導入により、`IGameState` に以下の新規フィールドが追加された。

| フィールド | 型 | 追加理由 |
|-----------|-----|---------|
| `apOverflow` | `number` | AP超過分の翌日持ち越し |
| `questBoard` | `IQuestBoardState` | 掲示板依頼の累積管理 |

既存のセーブデータ（v1.0.0）にはこれらのフィールドが存在しないため、ロード時にマイグレーションが必要になる。

### 1.2 目的

- セーブデータのバージョン間互換性を確保する
- 既存プレイヤーのセーブデータを安全に新バージョンへ移行する
- 改ざん・破損データに対する堅牢性を確保する
- 将来のスキーマ変更に対応可能な拡張性のあるマイグレーション基盤を構築する

### 1.3 設計原則

- **Functional Core**: マイグレーション関数はすべて純粋関数として実装
- **段階的マイグレーション**: v1 -> v2 -> v3 のように各バージョン間で1ステップずつ移行
- **フェイルセーフ**: マイグレーション失敗時は新規ゲーム開始へフォールバック
- **後方互換性**: メジャーバージョン内ではマイナー・パッチ変更は後方互換

---

## 2. バージョニング方針

### 2.1 セマンティックバージョニング

セーブデータバージョンはセマンティックバージョニング（`MAJOR.MINOR.PATCH`）に従う。

| 変更種別 | バージョン変更 | マイグレーション要否 | 例 |
|---------|-------------|------------------|-----|
| **MAJOR** | `X.0.0` | 必須（破壊的変更） | フィールド削除、型変更 |
| **MINOR** | `1.X.0` | 自動対応可能（フィールド追加） | `apOverflow` 追加 |
| **PATCH** | `1.0.X` | 不要（互換性保証） | バグ修正のみ |

### 2.2 バージョン履歴

| バージョン | 変更内容 | リリース日 |
|-----------|---------|-----------|
| `1.0.0` | 初期リリース | 2026-01-01 |
| `1.1.0` | フェーズ自由遷移対応（`apOverflow`, `questBoard` 追加） | 予定 |

### 2.3 互換性判定ルール

```
メジャーバージョンが異なる場合:
  -> マイグレーション不可（新規ゲーム開始を推奨）

メジャーバージョンが同じ場合:
  -> マイナーバージョンが低い場合: 段階的マイグレーション実行
  -> マイナーバージョンが高い場合: ダウングレード不可（新規ゲーム開始を推奨）
  -> パッチバージョンのみ異なる場合: そのまま読み込み可能
```

---

## 3. マイグレーションアーキテクチャ

### 3.1 処理フロー

```
localStorage からデータ取得
  -> JSON.parse（失敗時: フォールバック）
  -> バージョン検出（バージョンフィールド欠損時: フォールバック）
  -> 互換性判定
    -> 同一バージョン: そのまま使用
    -> マイグレーション可能: 段階的マイグレーション実行
    -> マイグレーション不可: フォールバック
  -> バリデーション（失敗時: フォールバック）
  -> 正常なセーブデータとして返却
```

### 3.2 段階的マイグレーション

マイグレーションは「1バージョン分ずつ」実行する。例えば v1.0.0 -> v1.2.0 への移行は以下の順で行う。

```
v1.0.0 -> v1.1.0（MigrationStep_1_0_to_1_1）
v1.1.0 -> v1.2.0（MigrationStep_1_1_to_1_2）
```

各ステップは純粋関数であり、入力データを受け取って新しいデータを返す。

### 3.3 マイグレーションレジストリ

すべてのマイグレーションステップはレジストリに登録され、バージョンチェーンを自動的に構築する。

```
レジストリ:
  "1.0.0" -> "1.1.0": MigrationStep_1_0_to_1_1
  "1.1.0" -> "1.2.0": MigrationStep_1_1_to_1_2

パス解決:
  migrate("1.0.0", "1.2.0")
    -> ["1.0.0" -> "1.1.0", "1.1.0" -> "1.2.0"]
    -> 順次実行
```

---

## 4. マイグレーションシナリオ

### 4.1 v1.0.0 -> v1.1.0: フェーズ自由遷移対応

#### 追加フィールド

| フィールド | パス | 型 | デフォルト値 | 説明 |
|-----------|------|-----|-----------|------|
| `apOverflow` | `gameState.apOverflow` | `number` | `0` | AP超過分 |
| `questBoard` | `gameState.questBoard` | `IQuestBoardState` | `{ boardQuests: [], visitorQuests: [], lastVisitorUpdateDay: 0 }` | 掲示板状態 |

#### マイグレーション処理

```
入力: v1.0.0 の ISaveData
処理:
  1. gameState.apOverflow が存在しない場合、0 を設定
  2. gameState.questBoard が存在しない場合、空の初期状態を設定
  3. version を "1.1.0" に更新
出力: v1.1.0 の ISaveData
```

#### 既存データとの互換性

- `currentPhase`: 既存の4フェーズ値はそのまま有効
- 自由遷移は有効になるが、既存の進行状態に影響なし
- `todayQuests` / `todayClients`: 既存の依頼データは訪問依頼として扱い、掲示板は空で初期化

### 4.2 将来のマイグレーションシナリオ（例）

#### v1.1.0 -> v2.0.0: メジャーバージョンアップ（仮想例）

- メジャーバージョン変更はマイグレーション不可とし、新規ゲーム開始を促す
- 理由: データ構造の根本的な変更（例: IDスキーマ変更）はロスレス変換が困難

---

## 5. フォールバック動作定義

### 5.1 フォールバックが発生するケース

| ケース | 原因 | フォールバック動作 |
|--------|------|-----------------|
| JSONパース失敗 | データ破損、手動改ざん | 新規ゲーム開始 |
| バージョンフィールド欠損 | 古いプロトタイプデータ、改ざん | 新規ゲーム開始 |
| マイグレーション不可 | メジャーバージョン不一致、ダウングレード | 新規ゲーム開始 |
| マイグレーション実行時エラー | データ不整合、予期しない型 | 新規ゲーム開始 |
| バリデーション失敗 | 値の範囲外、必須フィールド欠損 | 新規ゲーム開始 |

### 5.2 フォールバック時の処理

```
1. コンソールに警告ログを出力（原因の記録）
2. 破損データをlocalStorageから削除しない（デバッグ用に保持）
3. MigrationResult.fallback = true を返却
4. 呼び出し元（SaveLoadService）が新規ゲーム開始を判断
5. ユーザーには「セーブデータに問題がありました。新しいゲームを開始します」と通知
```

### 5.3 フォールバック前のデータ保護

- 破損データを別キーにバックアップしてから新規ゲームを開始
- バックアップキー: `atelier-guild-rank-save-backup-{timestamp}`
- バックアップは最大1つ保持（古いバックアップは上書き）

---

## 6. エラーハンドリング方針

### 6.1 改ざんデータ対策

マイグレーション関数は以下の改ざんパターンに対して安全に動作する。

| 改ざんパターン | 対策 |
|--------------|------|
| フィールド欠損 | デフォルト値で補完 |
| 型の不一致（string -> number等） | 型チェックで検出、フォールバック |
| 値の範囲外（gold: -999） | バリデーションで検出、フォールバック |
| 余分なフィールド追加 | 無視（必要なフィールドのみ抽出） |
| version フィールド改ざん | バリデーションで検出 |
| 完全に無関係なJSON | 構造チェックで検出、フォールバック |

### 6.2 バリデーションルール

マイグレーション後のデータに対して以下のバリデーションを実施する。

#### GameState バリデーション

| フィールド | ルール |
|-----------|-------|
| `currentRank` | `GuildRank` の有効値であること |
| `rankHp` | 0以上の整数 |
| `promotionGauge` | 0以上の数値 |
| `remainingDays` | 0以上の整数 |
| `currentDay` | 1以上の整数 |
| `currentPhase` | `GamePhase` の有効値であること |
| `gold` | 0以上の整数 |
| `comboCount` | 0以上の整数 |
| `actionPoints` | 0以上の整数 |
| `isPromotionTest` | boolean型であること |
| `apOverflow` | 0以上の整数 |
| `questBoard` | `IQuestBoardState` の構造に適合 |

#### DeckState バリデーション

| フィールド | ルール |
|-----------|-------|
| `deck` | 文字列の配列であること |
| `hand` | 文字列の配列であること |
| `discard` | 文字列の配列であること |
| `ownedCards` | 文字列の配列であること |

#### InventoryState バリデーション

| フィールド | ルール |
|-----------|-------|
| `materials` | 配列であること、各要素が `materialId`, `quality`, `quantity` を持つ |
| `craftedItems` | 配列であること |
| `storageLimit` | 1以上の整数 |

#### QuestState バリデーション

| フィールド | ルール |
|-----------|-------|
| `activeQuests` | 配列であること |
| `todayClients` | 文字列の配列であること |
| `todayQuests` | 配列であること |
| `questLimit` | 1以上の整数 |

### 6.3 エラーコード

既存の `ErrorCodes` に以下を追加する。

| コード | 用途 |
|--------|------|
| `MIGRATION_FAILED` | マイグレーション処理の失敗 |
| `VALIDATION_FAILED` | セーブデータバリデーションの失敗 |

---

## 7. TypeScriptインターフェース概要

### 7.1 ファイル配置

```
src/
└── shared/
    └── services/
        └── save-load/
            ├── migration/
            │   ├── types.ts              # マイグレーション関連型定義
            │   ├── migration-registry.ts  # マイグレーションレジストリ（純粋関数）
            │   ├── save-data-validator.ts  # バリデーション関数（純粋関数）
            │   ├── migrations/
            │   │   └── v1_0_to_v1_1.ts    # v1.0.0 -> v1.1.0 マイグレーション
            │   └── index.ts              # 公開API
            ├── save-load-service.ts       # 既存（マイグレーション統合）
            └── index.ts                  # 既存
```

### 7.2 主要インターフェース

- `SaveDataVersion`: セマンティックバージョンの構造化表現
- `IMigrationStep`: 1バージョン分のマイグレーション定義
- `IMigrationResult`: マイグレーション実行結果
- `IMigrationRegistry`: マイグレーションステップの管理
- `migrateSaveData()`: マイグレーション実行関数（純粋関数）
- `validateSaveData()`: セーブデータバリデーション関数（純粋関数）

詳細は `src/shared/services/save-load/migration/types.ts` を参照。

---

## 8. 既存コードへの影響

### 8.1 変更が必要なファイル

| ファイル | 変更内容 |
|---------|---------|
| `save-load-service.ts` | `load()` にマイグレーション・バリデーション処理を統合 |
| `local-storage-save-repository.ts` | `isValidVersion()` をマイグレーション対応に変更 |
| `errors.ts` | `MIGRATION_FAILED`, `VALIDATION_FAILED` エラーコードを追加 |
| `save-data.ts` | ISaveDataにバージョン型の厳密化（既存互換） |

### 8.2 影響を受けないファイル

- `StateManager.ts`: `loadFromSaveData()` の入力はマイグレーション済みデータのため変更不要
- `game-state.ts`: 型定義自体は既にフェーズ自由遷移対応済み
- `initial-state.ts`: 初期状態は変更なし

---

## 9. テスト戦略

### 9.1 ユニットテスト（Functional Core）

| テストケース | 対象関数 |
|------------|---------|
| v1.0.0 -> v1.1.0 マイグレーション | `migrateV1_0ToV1_1()` |
| 段階的マイグレーション（v1.0.0 -> v1.2.0） | `migrateSaveData()` |
| 同一バージョン（マイグレーション不要） | `migrateSaveData()` |
| 互換性判定（上位バージョン） | `canMigrate()` |
| 互換性判定（下位メジャーバージョン） | `canMigrate()` |
| フィールド欠損データのマイグレーション | `migrateV1_0ToV1_1()` |
| GameState バリデーション成功 | `validateSaveData()` |
| GameState バリデーション失敗（型不一致） | `validateSaveData()` |
| GameState バリデーション失敗（範囲外） | `validateSaveData()` |
| 改ざんデータ（完全に無関係なJSON） | `validateSaveData()` |

### 9.2 統合テスト

| テストケース | 対象 |
|------------|------|
| 古いバージョンのセーブデータからのロード成功 | `SaveLoadService.load()` |
| 破損データからのフォールバック | `SaveLoadService.load()` |
| マイグレーション後のゲーム状態復元 | `SaveLoadService` + `StateManager` |

---

## 関連文書

- [データスキーマ設計書（セーブデータ）](data-schema-save.md)
- [フェーズ自由遷移アーキテクチャ](../free-phase-navigation/architecture.md)
- [コアサービス設計](core-systems-core-services.md)
