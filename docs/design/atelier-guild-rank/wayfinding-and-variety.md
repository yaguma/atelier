# ウェイファインディング（ユーザー誘導）と最適解固定化対策 設計書

**バージョン**: 1.1.0
**作成日**: 2026-02-28
**関連Issue**: #315
**関連要件定義**: [フェーズ自由遷移 要件定義書](../../spec/free-phase-navigation/requirements.md)

---

## 概要

フェーズ自由遷移システム（REQ-001）の導入により、プレイヤーは依頼受注・採取・調合・納品の4フェーズを任意の順序で切り替えられるようになる。この自由度の向上は戦略性を高める一方で、以下2つのプレイヤー体験リスクが生じる。

| リスク | 内容 | 影響 |
|--------|------|------|
| **ウェイファインディング不足** | 「今何をすべきか」が分かりにくくなる | 新規プレイヤーの離脱、操作迷子 |
| **最適解固定化** | 効率的な行動パターンが発見されると単調化する | リプレイ性の低下、飽き |

本設計書では、これらのリスクに対する具体的な対策を定義する。

### 設計原則

1. **自由度を損なわない**: 制約による誘導ではなく、情報提供による誘導を優先する
2. **段階的開示**: 初心者には手厚く、熟練者には控えめに
3. **発見の喜びを奪わない**: 最適解を直接教えるのではなく、気づきを促す
4. **既存UIとの統合**: 新規画面の追加を最小限にし、既存UIの拡張で対応する

### 信頼性レベル凡例

- 🔵 **青信号**: 既存設計文書・要件定義書に基づく確実な設計
- 🟡 **黄信号**: 既存設計から妥当な推測による設計
- 🔴 **赤信号**: 新規の設計提案（要検証）

---

## Section 1: ウェイファインディングシステム設計

### 1.1 ドットインジケーター（タブ通知バッジ）🟡

#### 背景

フェーズ自由遷移により、プレイヤーは任意のタイミングで任意のフェーズに移動できる（REQ-001）。しかし、初心者にとっては「次に何をすべきか」の判断が難しくなる。タブUI上のドットインジケーターにより、各フェーズで「やれること」や「注目すべきこと」を視覚的に通知する。

#### 仕様

##### インジケーターの種類

| 種類 | 表示条件 | アイコン | 色 |
|------|----------|---------|-----|
| **アクション可能** | そのフェーズで実行可能なアクションがある | ドット（●） | 緑 (#66BB6A) |
| **注意喚起** | 期限切れが迫る依頼がある等 | ドット（●） | オレンジ (#FFB300) |
| **新着** | 新しい依頼が掲示板に追加された | ドット（●） | 青 (#42A5F5) |

##### フェーズごとのインジケーター発火条件

| フェーズ | 条件 | インジケーター種類 |
|----------|------|-------------------|
| **依頼受注** | 未受注の新着依頼がある | 新着（青） |
| **依頼受注** | 受注中の依頼に期限2日以内のものがある | 注意喚起（オレンジ） |
| **依頼受注** | 受注枠に空きがあり、掲示板に依頼がある | アクション可能（緑） |
| **採取** | 手札に採取地カードがあり、AP残量がある | アクション可能（緑） |
| **調合** | 調合可能なレシピと素材の組み合わせがある | アクション可能（緑） |
| **納品** | 受注済み依頼の納品条件を満たす完成品がある | アクション可能（緑） |
| **納品** | 受注済み依頼に期限1日以内のものがある | 注意喚起（オレンジ） |

##### 表示ルール

- インジケーターは対応するフェーズタブの右上に小さなドット（直径8px）として表示する
- 複数条件が同時に成立する場合、最も優先度の高いインジケーターのみ表示する
  - 優先度: 注意喚起（オレンジ） > アクション可能（緑） > 新着（青）
- 現在アクティブなフェーズのタブにはインジケーターを表示しない（既にそのフェーズにいるため）
- フェーズを切り替えた時点で、そのフェーズのインジケーターは消える

##### UIレイアウト

```
フッターバー（PhaseTabUI）
┌──────┬──────┬──────┬──────┐ ┌─────────────┐ ┌────┐
│依頼 ●│ 採取 │調合 ●│ 納品 │ │ [手札カード] │ │日終│
│[活性]│      │      │      │ │             │ │了  │
└──────┴──────┴──────┴──────┘ └─────────────┘ └────┘
  ^                ^
  新着(青)          アクション可能(緑)
```

##### 状態計算のタイミング

インジケーターの状態は以下のタイミングで再計算する:

- フェーズ切り替え時（`PHASE_CHANGED` イベント）
- 日開始時（`DAY_STARTED` イベント）
- アクション実行後（`QUEST_ACCEPTED`, `ITEM_CRAFTED`, `QUEST_COMPLETED` 等）
- インベントリ変更時（`INVENTORY_CHANGED` イベント）

##### 実装方針

```mermaid
flowchart TD
    subgraph "インジケーター計算"
        Event[イベント発火] --> Calc[TabIndicatorService]
        Calc --> QA{依頼フェーズ<br>チェック}
        Calc --> GA{採取フェーズ<br>チェック}
        Calc --> AL{調合フェーズ<br>チェック}
        Calc --> DE{納品フェーズ<br>チェック}

        QA --> |条件判定| QR[依頼インジケーター状態]
        GA --> |条件判定| GR[採取インジケーター状態]
        AL --> |条件判定| AR[調合インジケーター状態]
        DE --> |条件判定| DR[納品インジケーター状態]
    end

    subgraph "UI更新"
        QR --> Tab[PhaseTabUI更新]
        GR --> Tab
        AR --> Tab
        DR --> Tab
    end
```

- `TabIndicatorService` は純粋関数として `features/wayfinding/services/` に配置する（Functional Core）
- `IGameState` を入力として受け取り、各フェーズのインジケーター状態を返す
- PhaseTabUI が EventBus 経由でインジケーター状態を監視し、表示を更新する（Imperative Shell）

##### 既存バッジとの統合方針

既存の PhaseTabUI 設計書（[phase-tab-ui.md](ui-design/screens/phase-tab-ui.md) セクション6）では、直径16pxの赤色丸バッジ（数値表示: 未受注依頼件数、調合可能レシピ数、納品可能件数）が定義されている。本設計書のドットインジケーター（直径8px・3色）は、これを**置き換えるのではなく拡張する形**で統合する。

| 表示要素 | 仕様 | 表示位置 | 役割 |
|---------|------|---------|------|
| **数値バッジ（既存）** | 直径16px、背景色をインジケーター状態に応じて変更 | タブラベル右上 | 具体的な件数の通知（「何件あるか」） |
| **ドットインジケーター（本設計）** | 直径8px、3色 | タブ右上角（数値バッジの左下、4pxオフセット） | 状態の種別通知（「何が起きているか」） |

統合ルール:

1. **数値バッジがある場合**: 数値バッジの背景色をインジケーター状態の色に変更する（赤→緑/オレンジ/青）。ドットは非表示にする（情報の重複を避ける）
2. **数値バッジがない場合**（採取フェーズ等、件数表示がないフェーズ）: ドットインジケーターのみを表示する
3. **おすすめアクション時**: 数値バッジまたはドットにパルスアニメーションを適用する

この方針により、既存の PhaseTabUI 設計との互換性を維持しつつ、状態の種別情報を追加で提供できる。PhaseTabUI 設計書の次回更新時に、バッジ色の動的変更仕様を反映する。

---

### 1.2 チュートリアル/ヒントシステム設計 🔴

#### 背景

Gランク（チュートリアル）では、プレイヤーにゲームの基本操作と戦略の基礎を教える必要がある。フェーズ自由遷移の導入により、初回プレイ時の「何をすればいいのか分からない」リスクが高まる。

#### 仕様

##### チュートリアルの構成

チュートリアルは**ステップ形式のガイド**と**コンテキストヒント**の2層構造で構成する。

```mermaid
flowchart TD
    subgraph "第1層: ステップガイド（初回のみ）"
        S1[Step 1: 依頼を受注しよう] --> S2[Step 2: 素材を採取しよう]
        S2 --> S3[Step 3: アイテムを調合しよう]
        S3 --> S4[Step 4: 依頼を納品しよう]
        S4 --> S5[Step 5: 自由に行動しよう]
    end

    subgraph "第2層: コンテキストヒント（常時）"
        H1[状況に応じたヒント表示]
        H2[非表示設定可能]
    end
```

##### 第1層: ステップガイド（Gランク1日目のみ）

| ステップ | トリガー | 表示内容 | 完了条件 |
|---------|---------|---------|---------|
| 1 | ゲーム開始直後 | 「まずは依頼を受注してみよう！依頼タブをクリックしてね」 | 依頼タブをクリック |
| 2 | 依頼受注後 | 「次は素材を集めよう！採取タブをクリックして採取地を選ぼう」 | 採取タブをクリック |
| 3 | 採取完了後 | 「素材が集まったら調合だ！調合タブでレシピを選ぼう」 | 調合タブをクリック |
| 4 | 調合完了後 | 「完成品ができた！納品タブで依頼を納品しよう」 | 納品タブをクリック |
| 5 | 納品完了後 | 「素晴らしい！あとは自由に行動していいよ。APがなくなったら日終了ボタンを押そう」 | 日終了ボタンをクリック |

##### 第2層: コンテキストヒント（常時利用可能）

メインコンテンツエリアの上部に、現在の状況に応じたヒントを1行で表示する。

| 状況 | ヒントメッセージ |
|------|-----------------|
| 受注依頼が0件 | 「依頼を受注すると貢献度を稼げるよ。依頼タブを確認しよう！」 |
| 手札に採取地カードがない | 「採取地カードがないよ。ショップで購入するか、休憩で手札を入れ替えよう」 |
| 調合可能なレシピがある | 「調合できるレシピがあるよ！調合タブを確認してみよう」 |
| 納品可能な完成品がある | 「納品できる依頼があるよ！納品タブで確認しよう」 |
| AP残量が0 | 「APがなくなったよ。日終了ボタンで翌日に進もう」 |
| 期限2日以内の依頼がある | 「期限が迫っている依頼があるよ！早めに納品しよう」 |
| 何も行動せず日終了可能 | 「何もしなくても日終了できるよ。でも依頼の期限は進むから注意！」 |

##### 表示仕様

```
メインコンテンツエリア
┌─────────────────────────────────────────────────┐
│ 💡 調合できるレシピがあるよ！調合タブを確認してみよう  [✕]│
├─────────────────────────────────────────────────┤
│                                                   │
│              （フェーズ別コンテンツ）                │
│                                                   │
└─────────────────────────────────────────────────┘
```

- ヒントバーは半透明の背景（THEME定数: `THEME.colors.hintBar.background`）で表示。ライトテーマ: `rgba(255, 248, 225, 0.9)`、ダークテーマ: `rgba(66, 66, 50, 0.9)` をTHEME定数で切り替える
- [✕] ボタンで個別に閉じられる
- 設定画面で「ヒントを表示しない」オプションを提供
- ステップガイドはセーブデータに完了状態を保存し、一度完了したら再表示しない

##### 実装方針

- `HintService` を `features/wayfinding/services/hint-service.ts` に配置（Functional Core）
- ゲーム状態を入力として、表示すべきヒントメッセージを返す純粋関数
- ヒントの優先度は上表の順序で、最も優先度の高いヒント1つのみ表示

---

### 1.3 おすすめアクション表示の設計 🔴

#### 背景

フェーズ自由遷移では、プレイヤーが「次にどのフェーズに行くべきか」を自分で判断する必要がある。特にゲーム中盤以降、依頼期限・素材状況・AP残量を総合的に考慮した最適な行動を見極めることが求められる。おすすめアクション表示は、この判断を補助する仕組みである。

#### 仕様

##### おすすめアクションの算出ロジック

おすすめアクションは以下の優先度で算出する:

```mermaid
flowchart TD
    Start[状態チェック開始] --> P1{納品可能な<br>依頼がある？}
    P1 -->|Yes| R1["おすすめ: 納品（★★★）"]
    P1 -->|No| P2{期限2日以内の<br>依頼がある？}

    P2 -->|Yes| P3{その依頼の<br>納品条件を<br>満たせる？}
    P3 -->|調合すれば可| R2["おすすめ: 調合（★★★）"]
    P3 -->|素材不足| R3["おすすめ: 採取（★★★）"]
    P3 -->|不可能| R4["おすすめ: 別の依頼受注（★★）"]

    P2 -->|No| P4{受注依頼が<br>0件？}
    P4 -->|Yes| R5["おすすめ: 依頼受注（★★★）"]
    P4 -->|No| P5{調合可能な<br>レシピがある？}
    P5 -->|Yes| R6["おすすめ: 調合（★★）"]
    P5 -->|No| P6{採取可能？}
    P6 -->|Yes| R7["おすすめ: 採取（★★）"]
    P6 -->|No| R8["おすすめ: 日終了（★）"]
```

##### 表示場所と方式

おすすめアクションは**ドットインジケーター（1.1節）の拡張**として表示する。最も推奨されるフェーズのタブインジケーターを**点滅（パルスアニメーション）**にすることで、他のインジケーターと区別する。

| 推奨度 | インジケーター表示 |
|--------|-------------------|
| ★★★ 強く推奨 | ドットが緩やかに点滅（パルスアニメーション、周期1.5秒） |
| ★★ 推奨 | 通常のドット表示（静的） |
| ★ 低推奨 | インジケーターなし |

##### 制約事項

- おすすめアクションは**あくまでヒント**であり、強制ではない
- プレイヤーが明示的に別フェーズに移動した場合、おすすめは無視される
- おすすめ計算はフェーズ切り替え時と日開始時に実行する
- 計算が重くならないよう、簡易的な条件判定に留める

---

## Section 2: 最適解固定化対策

### 2.1 日ごとインセンティブ（早期受注ボーナス等）🔴

#### 背景

フェーズ自由遷移では、プレイヤーが「採取→調合→納品」のサイクルを最適化し、依頼受注を後回しにするパターンが固定化するリスクがある。日ごとのインセンティブにより、異なるタイミングでの行動を促す。

#### 仕様

##### 早期受注ボーナス

依頼が掲示板に掲載された日に受注すると、ボーナスが付与される。

| ボーナス種類 | 条件 | 効果 |
|-------------|------|------|
| **早期受注ボーナス** | 依頼掲載日に受注 | 報酬ゴールド +20% |
| **連続受注ボーナス** | 3日連続で依頼を受注 | 報酬貢献度 +10% |

##### 早期受注ボーナスの経済バランスへの影響分析

早期受注ボーナス（+20%G）がゲーム経済に与える影響を、既存のバランス設計（[balance-design.md](balance-design.md) セクション5.1）に基づき試算する。

| ランク帯 | 依頼難易度 | 基本報酬金 | +20%G額 | 1日あたり最大恩恵 | 影響評価 |
|---------|-----------|-----------|---------|------------------|---------|
| **Gランク（序盤）** | 簡単 | 30〜50G | +6〜10G | +6〜10G（1件/日想定） | 低: カードショップ最安(50G)に対して微小。初心者の金欠緩和に寄与 |
| **Fランク（序盤）** | 簡単〜普通 | 30〜100G | +6〜20G | +12〜40G（2件/日想定） | 低〜中: 素材ショップ(10〜100G)の1回分程度 |
| **D〜Cランク（中盤）** | 普通〜難しい | 60〜200G | +12〜40G | +24〜80G（2件/日想定） | 中: 強化カード(80〜200G)の補助になる程度 |
| **B〜Aランク（終盤）** | 難しい〜最難関 | 120〜500G | +24〜100G | +48〜200G（2件/日想定） | 中: アーティファクト(300〜500G)には数日分の蓄積が必要 |

総合評価:
- +20%Gは全ランク帯で「あると嬉しいが必須ではない」程度の効果であり、ゲーム経済を破壊するリスクは低い
- ゲーム全体を通して、早期受注を意識するかどうかで総獲得ゴールドに約10〜15%の差が生じる想定
- 行動パターンの多様化という目的に対して適切な水準と判断する
- Phase D（バランス調整）でプレイテスト結果に基づき、+15%〜+25%の範囲で最終調整を行う

##### 一番乗り報酬

訪問依頼は3日ごとに更新される（REQ-005-02）。更新時、未受注の訪問依頼は掲示板に残らず消滅する（訪問者が去るため）。訪問者が来た初日（更新日）に依頼を受注すると、特別な報酬が追加される。

| ボーナス種類 | 条件 | 効果 |
|-------------|------|------|
| **一番乗り報酬** | 訪問依頼の更新日に受注 | 追加素材1つプレゼント |

##### 日替わりボーナスフェーズ

毎日ランダムに1つのフェーズがボーナスフェーズとなり、そのフェーズでの行動に微小なボーナスが付く。

| ボーナスフェーズ | 効果 |
|----------------|------|
| 依頼受注 | 掲示板に追加依頼が1件多く掲載される |
| 採取 | 採取ラウンドで追加素材が出現しやすくなる（レア出現率 +5%） |
| 調合 | 調合品質に +5 のボーナス |
| 納品 | 納品報酬のゴールドに +10% のボーナス |

##### 表示仕様

日替わりボーナスはヘッダーバーに小さなアイコンで表示する。

```
ヘッダーバー
┌──────────────────────────────────────────────────┐
│ ランク: E [ゲージ] | 残り: 30日 | G 100G | AP: 3/3  │
│                              本日のボーナス: 🧪調合+5 │
└──────────────────────────────────────────────────┘
```

---

### 2.2 ランダム要素の活用 🟡

#### 背景

最適解固定化の根本原因は「毎回同じ状況に対して同じ行動が最適になる」ことにある。ランダム要素を適切に導入することで、状況ごとに最適な行動を変化させる。

#### 仕様

##### 掲示板ラインナップの変動

掲示板の依頼ラインナップに変動要素を導入する。

```mermaid
flowchart LR
    subgraph "掲示板依頼生成"
        Base[基本プール<br>ランク別依頼] --> Filter{ランダム<br>フィルタ}
        Filter --> Day[日ごとの<br>シード値]
        Day --> Result[掲示板<br>ラインナップ]
    end

    subgraph "変動要素"
        V1[依頼タイプの偏り<br>日ごとに変化]
        V2[報酬倍率の変動<br>0.8x～1.2x]
        V3[期限の変動<br>基本値±1日]
    end

    V1 --> Filter
    V2 --> Filter
    V3 --> Filter
```

| 変動要素 | 範囲 | 目的 |
|---------|------|------|
| **依頼タイプの偏り** | 日ごとに特定タイプの出現率が変化 | 毎日同じ依頼を受注できない |
| **報酬倍率の変動** | 基本報酬の 0.8x ～ 1.2x | 高報酬の依頼を探す動機づけ |
| **期限の変動** | 基本期限 ±1日 | 計画の再考を促す |

##### 報酬倍率の複合効果と上限キャップ

報酬倍率変動（0.8x〜1.2x）は、既存の依頼者補正（[game-mechanics.md](game-mechanics.md) セクション3.1: 村人×0.8〜貴族×2.0）と乗算で適用される。複合効果の振れ幅が過大にならないよう、最終補正に上限キャップを設ける。

**複合効果の計算例（ゴールド報酬）**:

```
最終ゴールド報酬 = 基本報酬金 × 依頼者お金補正 × 報酬倍率変動

※ 上限キャップ適用後:
最終ゴールド報酬 = 基本報酬金 × min(依頼者お金補正 × 報酬倍率変動, 2.0)
```

| 組み合わせ | 依頼者補正 | 報酬倍率変動 | 複合効果（キャップ前） | キャップ後 |
|-----------|-----------|-------------|---------------------|-----------|
| 村人 × 低倍率 | ×0.8 | ×0.8 | ×0.64 | ×0.64（キャップ不要） |
| 冒険者 × 標準 | ×1.0 | ×1.0 | ×1.00 | ×1.00 |
| 商人 × 高倍率 | ×1.5 | ×1.2 | ×1.80 | ×1.80（キャップ不要） |
| 貴族 × 高倍率 | ×2.0 | ×1.2 | ×2.40 | **×2.00（キャップ適用）** |
| 貴族 × 標準 | ×2.0 | ×1.0 | ×2.00 | ×2.00 |

**上限キャップの設計**:

| 報酬種別 | 最終補正の上限 | 最終補正の下限 | 根拠 |
|---------|--------------|-------------|------|
| ゴールド報酬 | ×2.0 | ×0.5 | 貴族の既存補正(×2.0)を超えないよう制限 |
| 貢献度報酬 | ×1.8 | ×0.6 | 貢献度の過剰獲得によるランク進行速度の歪みを防止 |

この上限キャップにより、最も有利な組み合わせでも基本報酬の2倍を超えることがなく、ゲームバランスの安定性を確保する。

##### 採取地の素材出現テーブル変動

同じ採取地でも、日ごとに出現する素材の確率テーブルが微妙に変化する。

| パラメータ | 変動範囲 | 目的 |
|-----------|---------|------|
| **通常素材の出現率** | 基本値 ±10% | 「今日はこの素材が取りやすい」を作る |
| **レア素材の出現率** | 基本値 ±3% | レア素材を求めて複数日チャレンジ |

##### 訪問者の多様化

訪問依頼の依頼者を多様化し、特殊な報酬条件を持つ依頼者を登場させる。

| 訪問者タイプ | 出現条件 | 特殊効果 |
|-------------|---------|---------|
| **通常訪問者** | 常時 | 通常の依頼を持参 |
| **富豪の旅人** | ランダム（10%） | 報酬ゴールド 1.5x、ただし難易度高め |
| **急ぎの商人** | ランダム（15%） | 期限が短いが報酬貢献度 1.3x |
| **コレクター** | ランク D以上で出現 | 特定素材を高額で買い取る |

---

### 2.3 訪問方式の差別化 🟡

#### 背景

掲示板方式と訪問方式の差別化が不十分だと、プレイヤーは一方の方式のみを利用する最適パターンに収束する。両方式に明確な役割の違いを設け、使い分けを促す。

#### 仕様

##### 掲示板と訪問の役割分担

```mermaid
flowchart TD
    subgraph "掲示板（累積型）"
        B1[大量の依頼が蓄積]
        B2[自分のペースで選択可能]
        B3[標準的な報酬]
        B4[期限は比較的長い]
    end

    subgraph "訪問（更新型）"
        V1[少数の厳選依頼]
        V2[3日ごとに更新]
        V3[特別な報酬条件]
        V4[限定素材やカード報酬]
    end

    B1 --> Strategy[プレイヤーの戦略]
    V1 --> Strategy

    Strategy --> Mix["両方を使い分けることで<br>効率的に進行"]
```

##### 具体的な差別化ポイント

| 項目 | 掲示板依頼 | 訪問依頼 |
|------|-----------|---------|
| **更新頻度** | 毎日新規追加（累積） | 3日ごとに全更新（未受注分は消滅） |
| **依頼数** | 多い（3～5件/日追加） | 少ない（1～2件/更新） |
| **期限** | 標準（3～7日） | やや短め（2～5日） |
| **報酬（ゴールド）** | 標準 | やや高め（1.0x～1.3x） |
| **報酬（貢献度）** | 標準 | 標準～やや高め |
| **特殊報酬** | なし | あり（限定素材、カード等） |
| **難易度** | ランク相応 | やや高め～ランク相応 |
| **早期受注ボーナス** | あり（掲載日受注で+20%G） | あり（初日受注で追加素材） |

##### 訪問依頼の特殊報酬例

| 報酬種類 | 出現頻度 | 内容 |
|---------|---------|------|
| **限定素材** | 訪問依頼の30% | 通常入手困難な素材を追加報酬として獲得 |
| **カード報酬** | 訪問依頼の10% | 新しい採取地カードまたはレシピカードを獲得 |
| **ショップ割引券** | 訪問依頼の20% | 次回ショップ購入時に20%割引 |

---

## Section 3: 実装優先度・フェーズ分け

### 全体ロードマップ

```mermaid
gantt
    title ウェイファインディング・最適解対策 実装ロードマップ
    dateFormat YYYY-MM-DD

    section Phase A: MVP（最小限の誘導）
    ドットインジケーター基本実装       :a1, 2026-03-01, 5d
    コンテキストヒント基本実装          :a2, after a1, 3d

    section Phase B: 基本対策
    早期受注ボーナス                   :b1, after a2, 3d
    掲示板ラインナップ変動              :b2, after b1, 3d
    訪問者差別化                       :b3, after b2, 4d

    section Phase C: 拡張
    おすすめアクション表示              :c1, after b3, 4d
    日替わりボーナスフェーズ            :c2, after c1, 3d
    ステップガイド（チュートリアル）     :c3, after c2, 5d
    特殊訪問者                        :c4, after c3, 3d

    section Phase D: 調整
    バランス調整                       :d1, after c4, 5d
    ユーザーテスト・フィードバック反映    :d2, after d1, 5d
```

### Phase A: MVP（最小限の誘導）-- 必須

| 項目 | 優先度 | 工数目安 | 依存 |
|------|--------|---------|------|
| ドットインジケーター基本実装 | **Must** | 5日 | フェーズ自由遷移UI（REQ-006） |
| コンテキストヒント基本実装 | **Must** | 3日 | ドットインジケーター |

**目的**: フェーズ自由遷移リリース時に、最低限の誘導を提供する。

**成果物**:
- `TabIndicatorService`（各フェーズのインジケーター状態を計算する純粋関数）
- `HintService`（状況に応じたヒントメッセージを返す純粋関数）
- PhaseTabUI のインジケーター表示拡張

### Phase B: 基本対策 -- 推奨

| 項目 | 優先度 | 工数目安 | 依存 |
|------|--------|---------|------|
| 早期受注ボーナス | **Should** | 3日 | 依頼掲示板システム（REQ-005） |
| 掲示板ラインナップ変動 | **Should** | 3日 | 依頼掲示板システム（REQ-005） |
| 訪問者差別化 | **Should** | 4日 | 依頼掲示板システム（REQ-005） |

**目的**: 最適解固定化を防ぐ基本的な仕組みを導入する。

**成果物**:
- `QuestBoardService` の拡張（ランダム要素、ボーナス計算）
- 訪問者タイプの追加データ定義

### Phase C: 拡張 -- あると良い

| 項目 | 優先度 | 工数目安 | 依存 |
|------|--------|---------|------|
| おすすめアクション表示 | **Could** | 4日 | Phase A |
| 日替わりボーナスフェーズ | **Could** | 3日 | なし |
| ステップガイド（チュートリアル） | **Could** | 5日 | Phase A |
| 特殊訪問者 | **Could** | 3日 | Phase B |

**目的**: プレイヤー体験をさらに豊かにする。

### Phase D: 調整 -- 必要に応じて

| 項目 | 優先度 | 工数目安 | 依存 |
|------|--------|---------|------|
| バランス調整 | **Must** | 5日 | Phase B, C |
| ユーザーテスト・フィードバック反映 | **Should** | 5日 | Phase D 前半 |

---

## Section 4: UI仕様概要

### 4.1 ドットインジケーター レイアウト詳細

```
タブ1つのサイズ: 約80px x 40px

  ┌────────────┐
  │  依頼    ● │  ← ドット: 直径8px、タブ右上から(-4px, +4px)オフセット
  │            │
  └────────────┘

ドットの仕様:
- サイズ: 直径 8px
- 位置: タブの右上角から内側に4pxオフセット
- 色: 発火条件に応じて変化（緑/オレンジ/青）
- アニメーション（おすすめ時）: scaleX/scaleY 1.0→1.3→1.0 のパルス、周期1.5秒
- 影: DropShadow 2px、同系色の半透明
```

### 4.2 コンテキストヒントバー レイアウト詳細

```
メインコンテンツエリア上部（高さ約36px）

┌─────────────────────────────────────────────────────────┐
│ 💡│ 調合できるレシピがあるよ！調合タブを確認してみよう    │[✕]│
└─────────────────────────────────────────────────────────┘

仕様:
- 高さ: 36px
- 背景色: THEME.colors.hintBar.background
  - ライトテーマ: rgba(255, 248, 225, 0.9)（半透明クリーム）
  - ダークテーマ: rgba(66, 66, 50, 0.9)（半透明ダークオリーブ）
- 左アイコン: 💡 (16x16px)
- テキスト: 14px、色 THEME.colors.hintBar.text
  - ライトテーマ: #5D4037（ダークブラウン）
  - ダークテーマ: #FFF8E1（クリームホワイト）
- 閉じるボタン: 16x16px、色 THEME.colors.hintBar.closeButton
  - ライトテーマ: #9E9E9E
  - ダークテーマ: #757575
- アニメーション: 上からスライドイン（200ms、EaseOut）
- 非表示時: 高さ0にアニメーション（メインコンテンツが上に詰まる）
```

### 4.3 日替わりボーナス表示 レイアウト詳細

```
ヘッダーバー右端に追加（AP表示の右側）

┌────────────────────────────────────────────────────────┐
│ ランク: E [ゲージ] │ 残り: 30日 │ G 100G │ AP: 3/3 │🧪+5│
└────────────────────────────────────────────────────────┘

仕様:
- サイズ: 約48x24px
- アイコン: フェーズに対応する絵文字（📋依頼/🌿採取/🧪調合/📦納品）
- テキスト: 12px、色 #FFD700（ゴールド）
- 背景: rgba(0, 0, 0, 0.3)（半透明黒）
- ツールチップ: ホバーで「本日のボーナス: 調合品質+5」を表示
```

### 4.4 早期受注ボーナス表示 レイアウト詳細

```
依頼カード上の掲載日表示（既存の依頼カードを拡張）

┌──────────────────────┐
│ 冒険者からの依頼       │
│ ┌─────────┐ 条件:1個  │
│ │ [依頼者  │ 84貢/48G │
│ │ アイコン]│ 期限:6日 │
│ └─────────┘          │
│ ★早期受注で+20%G★    │  ← 掲載初日のみ表示
└──────────────────────┘

仕様:
- 表示条件: 掲載日と現在日が同じ場合のみ
- テキスト: 12px、太字、色 #FFB300（アンバー）
- 背景: rgba(255, 179, 0, 0.1)
- 角丸: 4px
```

### 4.5 コンポーネント配置図

```mermaid
flowchart TD
    subgraph "UIコンポーネント構成"
        Header[HeaderUI]
        Main[MainContentArea]
        Footer[FooterUI / PhaseTabUI]

        Header --> DailyBonus[DailyBonusIndicator]
        Main --> HintBar[ContextHintBar]
        Main --> PhaseContent[各フェーズUI]
        Footer --> TabDot[TabDotIndicator x4]
        Footer --> HandCards[手札カード]
        Footer --> DayEndBtn[日終了ボタン]
    end

    subgraph "サービス層"
        TIS[TabIndicatorService<br>Functional Core]
        HS[HintService<br>Functional Core]
        RAS[RecommendedActionService<br>Functional Core]
        DBS[DailyBonusService<br>Functional Core]
    end

    TIS --> TabDot
    HS --> HintBar
    RAS --> TabDot
    DBS --> DailyBonus
```

---

## 依存関係・影響範囲

### 影響を受ける既存コンポーネント

| コンポーネント | 影響内容 |
|-------------|---------|
| **PhaseTabUI** | ドットインジケーター表示の追加 |
| **HeaderUI** | 日替わりボーナス表示の追加 |
| **MainScene** | コンテキストヒントバーの追加 |
| **QuestService** | 早期受注ボーナス、掲示板ラインナップ変動 |
| **QuestBoardService** | 訪問者差別化、特殊訪問者対応 |
| **IGameState** | `dailyBonusPhase`, `tutorialStep`, `hintsEnabled` フィールド追加 |

### IGameState 追加フィールドの型定義

本設計で `IGameState` に追加するフィールドの詳細を以下に定義する。

```typescript
// IGameState への追加フィールド
interface IGameStateWayfindingExtension {
  /**
   * 本日のボーナスフェーズ
   * 毎日ランダムに1つのフェーズが選ばれ、そのフェーズでのアクションにボーナスが付く
   */
  dailyBonusPhase: GamePhase | null;

  /**
   * チュートリアルの進行ステップ
   * 0: 未開始、1〜5: 各ステップ進行中、6: 完了済み
   * Gランク1日目のステップガイドの進行状態を管理する
   */
  tutorialStep: number;

  /**
   * コンテキストヒントの表示有効/無効
   * 設定画面から切り替え可能
   */
  hintsEnabled: boolean;
}
```

| フィールド | 型 | デフォルト値 | セーブデータ含有 | 備考 |
|-----------|-----|-------------|---------------|------|
| `dailyBonusPhase` | `GamePhase \| null` | `null` | **含まない** | 日開始時に毎回ランダム生成するため、セーブ不要 |
| `tutorialStep` | `number` | `0` | **含む** | チュートリアル完了状態を永続化する必要がある |
| `hintsEnabled` | `boolean` | `true` | **含む** | ユーザー設定として永続化する必要がある |

セーブデータスキーマへの影響:
- `tutorialStep` と `hintsEnabled` をセーブデータのスキーマに追加する
- 既存セーブデータとの後方互換性のため、フィールドが存在しない場合はデフォルト値を適用する
- `dailyBonusPhase` は揮発性のため、ゲーム起動時（日開始処理内）で毎回計算する

### 新規コンポーネント

| コンポーネント | 配置先 | 種類 |
|-------------|--------|------|
| `TabIndicatorService` | `features/wayfinding/services/` | Functional Core |
| `HintService` | `features/wayfinding/services/` | Functional Core |
| `RecommendedActionService` | `features/wayfinding/services/` | Functional Core |
| `DailyBonusService` | `features/quest/services/` | Functional Core |
| `TabDotIndicator` | `features/wayfinding/components/` | UIコンポーネント |
| `ContextHintBar` | `features/wayfinding/components/` | UIコンポーネント |
| `DailyBonusIndicator` | `shared/components/` | UIコンポーネント |

---

## 設計上の注意事項

### ゲーム体験への影響

1. **ドットインジケーターの頻度**: インジケーターが常に全タブに表示されると、情報過多で効果が薄れる。「本当に重要なアクション」のみにインジケーターを出すことが重要
2. **ヒントの押し付け感**: コンテキストヒントが頻繁に出すぎると、プレイヤーにストレスを与える。非表示オプションと、同じヒントの繰り返し防止（クールダウン）を実装する
3. **ランダム要素のバランス**: ランダム要素が強すぎると「運ゲー」になり、弱すぎると固定化を防げない。基本値からの変動幅は ±20% 以内に留める

### パフォーマンス考慮

- `TabIndicatorService` の計算は毎フレームではなく、イベント駆動で実行する
- インジケーターのアニメーション（パルス）は Phaser の Tween を使用し、GPUアクセラレーションが効くようにする
- ヒントメッセージの計算は、フェーズ切り替え時のみ実行する（update()に入れない）

#### TabIndicatorService の調合可能判定キャッシュ戦略

調合フェーズのインジケーター判定は「調合可能なレシピと素材の組み合わせがあるか」をチェックするため、計算量が O(recipes x materials) となる。レシピ数・素材数の増加に伴いコストが増大するため、以下のキャッシュ戦略を適用する。

```typescript
// TabIndicatorService 内の調合可能判定キャッシュ（設計方針）
interface AlchemyCheckCache {
  /** キャッシュの有効性を示すキー（インベントリのハッシュ値） */
  inventoryHash: string;
  /** キャッシュされた判定結果 */
  canCraft: boolean;
  /** キャッシュ作成時刻（デバッグ用） */
  timestamp: number;
}
```

**キャッシュ無効化トリガー**:

| トリガーイベント | 無効化理由 |
|---------------|-----------|
| `INVENTORY_CHANGED` | 素材の増減により調合可否が変化する可能性 |
| `ITEM_CRAFTED` | 素材消費により調合可否が変化する |
| `MATERIAL_ADDED` / `MATERIAL_CONSUMED` | 素材の増減 |
| `DAY_STARTED` | 日替わりボーナス（調合品質+5）の有無が変化 |

**キャッシュ戦略**:

1. **インベントリハッシュによる変更検知**: インベントリの内容（素材IDと個数のソート済みリスト）からハッシュ値を算出し、前回計算時と比較。ハッシュが同一ならキャッシュヒットとして前回の結果を返す
2. **イベント駆動の遅延再計算**: 上記トリガーイベント発火時にキャッシュを無効化し、次回のインジケーター状態取得時に再計算する（即時再計算ではなく遅延評価）
3. **早期打ち切り**: 調合可能なレシピが1つでも見つかった時点で `true` を返し、全レシピの走査を打ち切る

この戦略により、インベントリが変更されない限り O(1) でインジケーター状態を返せるようになり、頻繁なフェーズ切り替え時のパフォーマンスを確保する。

### テスト戦略

| 対象 | テスト種別 | カバレッジ目標 |
|------|-----------|-------------|
| `TabIndicatorService` | ユニットテスト | 90%+ |
| `HintService` | ユニットテスト | 90%+ |
| `RecommendedActionService` | ユニットテスト | 90%+ |
| `DailyBonusService` | ユニットテスト | 90%+ |
| ドットインジケーター表示 | E2Eテスト | クリティカルパス |
| チュートリアルフロー | E2Eテスト | クリティカルパス |

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|---------|
| 2026-02-28 | 1.0.0 | 初版作成（Issue #315） |
| 2026-02-28 | 1.1.0 | PR #352 レビュー指摘反映: 既存バッジ統合方針追加、IGameState型定義追加、経済バランス影響分析追加、報酬倍率複合効果キャップ追加、ヒントバー色のTHEME定数対応、訪問依頼更新用語統一、調合可能判定キャッシュ戦略追加 |
