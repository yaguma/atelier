# ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

## æ¦‚è¦

ğŸ”µ æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ã€Œã‚¢ãƒˆãƒªã‚¨ã€HTMLãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ ã‚’å®šç¾©ã™ã‚‹ã€‚
è¦ä»¶å®šç¾©æ›¸v5.1ã«åŸºã¥ãã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å‘ã‘ã«ç°¡ç•¥åŒ–ã—ãŸã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã€‚

**å‚ç…§å…ƒ**: [docs/spec/atelier-game-requirements.md](../../spec/atelier-game-requirements.md) v5.1

---

## ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§

| ã‚·ã‚¹ãƒ†ãƒ å | è²¬å‹™ | å„ªå…ˆåº¦ |
|-----------|------|--------|
| ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  | ã‚«ãƒ¼ãƒ‰ç®¡ç†ãƒ»å±æ€§è¨ˆç®— | å¿…é ˆ |
| ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ  | ä¾é ¼å—æ³¨ãƒ»ç´å“ | å¿…é ˆ |
| æ¡å–ã‚·ã‚¹ãƒ†ãƒ  | ç´ æç²å¾— | å¿…é ˆ |
| èª¿åˆã‚·ã‚¹ãƒ†ãƒ  | ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ | å¿…é ˆ |
| è²·ã„ç‰©ã‚·ã‚¹ãƒ†ãƒ  | ç´ æè³¼å…¥ | å¿…é ˆ |
| ãƒ‡ãƒƒã‚­ç®¡ç† | ã‚«ãƒ¼ãƒ‰æ‰€æŒç®¡ç† | å¿…é ˆ |
| ã‚¿ãƒ¼ãƒ³ç®¡ç† | ã‚¿ãƒ¼ãƒ³é€²è¡Œãƒ»æ¶ˆè€—åº¦ | å¿…é ˆ |

---

## 1. ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 

### 1.1 ã‚«ãƒ¼ãƒ‰å±æ€§

ğŸ”µ **4å±æ€§åˆ¶**ï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰

| å±æ€§ | èª¬æ˜ | ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ | å‚¾å‘ç´ æ |
|------|------|-------------|---------|
| ç« (Fire) | æ”»æ’ƒçš„ã€é«˜ã„å±æ€§å€¤ | #FF4500 | é‰±ç‰©ç³»ï¼ˆé‰„é‰±çŸ³ã€ç¡«é»„ï¼‰ |
| æ°´ (Water) | å›å¾©çš„ã€å®‰å®šã—ãŸåŠ¹æœ | #1E90FF | ãƒãƒ¼ãƒ–ç³»ï¼ˆè–¬è‰ã€è‹”ï¼‰ |
| åœŸ (Earth) | æŒç¶šçš„ã€é˜²å¾¡åŠ¹æœ | #8B4513 | é‰±ç‰©ç³»ï¼ˆç²˜åœŸã€çŸ³ï¼‰ |
| é¢¨ (Wind) | è»½é‡ã€ã‚³ã‚¹ãƒˆè»½æ¸› | #90EE90 | ãƒãƒ¼ãƒ–ç³»ï¼ˆèŠ±ã€ç¨®ï¼‰ |

### 1.2 ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—

ğŸŸ¡ **ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯2ç³»çµ±ã«ç°¡ç•¥åŒ–**

| ç³»çµ± | å½¹å‰² | åŠ¹æœ | å®Ÿè£… |
|------|------|------|------|
| **ç´ æ (Material)** | å±æ€§å€¤ã‚’æä¾› | ç«+3ã€æ°´+2 ãªã© | å¿…é ˆ |
| **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ** | æ°¸ç¶šãƒ‘ãƒƒã‚·ãƒ– | æ¶ˆè€—åº¦-10%ãªã© | å¾Œå›ã— |

â€» æ“ä½œãƒ»çŸ¥è­˜ãƒ»ç‰¹æ®Šã‚«ãƒ¼ãƒ‰ã¯æœ¬ç•ªå®Ÿè£…æ™‚ã«è¿½åŠ 

### 1.3 Cardã‚¯ãƒ©ã‚¹è¨­è¨ˆ

```javascript
/**
 * ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
class Card {
  constructor(data) {
    this.id = data.id;              // "card_001"
    this.name = data.name;          // "é‰„é‰±çŸ³"
    this.type = data.type;          // "material"
    this.rarity = data.rarity;      // "common" | "uncommon" | "rare"
    this.attributes = {
      fire: data.fire || 0,
      water: data.water || 0,
      earth: data.earth || 0,
      wind: data.wind || 0
    };
    this.description = data.description;
    this.cost = data.cost || 0;     // è³¼å…¥ä¾¡æ ¼
  }

  /**
   * å±æ€§å€¤ã®åˆè¨ˆã‚’å–å¾—
   */
  getTotalAttributes() {
    return this.attributes.fire +
           this.attributes.water +
           this.attributes.earth +
           this.attributes.wind;
  }

  /**
   * ç‰¹å®šå±æ€§ã®å€¤ã‚’å–å¾—
   */
  getAttribute(type) {
    return this.attributes[type] || 0;
  }
}
```

### 1.4 å±æ€§è¨ˆç®—

ğŸ”µ **AttributeCalculator**

```javascript
/**
 * å±æ€§è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
class AttributeCalculator {
  /**
   * è¤‡æ•°ã‚«ãƒ¼ãƒ‰ã®å±æ€§ã‚’åˆç®—
   * @param {Card[]} cards
   * @returns {Object} åˆç®—ã•ã‚ŒãŸå±æ€§å€¤
   */
  static sumAttributes(cards) {
    return cards.reduce((sum, card) => ({
      fire: sum.fire + card.attributes.fire,
      water: sum.water + card.attributes.water,
      earth: sum.earth + card.attributes.earth,
      wind: sum.wind + card.attributes.wind
    }), { fire: 0, water: 0, earth: 0, wind: 0 });
  }

  /**
   * å±æ€§åˆè¨ˆå€¤ã‚’å–å¾—
   */
  static getTotalValue(attributes) {
    return attributes.fire + attributes.water +
           attributes.earth + attributes.wind;
  }

  /**
   * ä¾é ¼è¦ä»¶ã‚’æº€ãŸã™ã‹åˆ¤å®š
   * @param {Object} attributes - åˆç®—ã—ãŸå±æ€§
   * @param {Object} requirements - ä¾é ¼ã®è¦ä»¶
   */
  static meetsRequirements(attributes, requirements) {
    if (requirements.fire && attributes.fire < requirements.fire) return false;
    if (requirements.water && attributes.water < requirements.water) return false;
    if (requirements.earth && attributes.earth < requirements.earth) return false;
    if (requirements.wind && attributes.wind < requirements.wind) return false;
    if (requirements.total) {
      const total = this.getTotalValue(attributes);
      if (total < requirements.total) return false;
    }
    return true;
  }
}
```

---

## 2. ä¾é ¼ã‚·ã‚¹ãƒ†ãƒ 

### 2.1 ä¾é ¼ã®æµã‚Œ

ğŸ”µ **å—æ³¨â†’ç´å“å‹**ï¼ˆè¦ä»¶å®šç¾©æ›¸æº–æ‹ ï¼‰

```mermaid
flowchart LR
    A[ä¾é ¼ãƒªã‚¹ãƒˆç¢ºèª] --> B[ä¾é ¼å—æ³¨]
    B --> C[ç´ æèª¿é”]
    C --> D[èª¿åˆ]
    D --> E[ä¾é ¼ç´å“]
    E --> F[å ±é…¬ç²å¾—]
```

### 2.2 Questã‚¯ãƒ©ã‚¹è¨­è¨ˆ

```javascript
/**
 * ä¾é ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
class Quest {
  constructor(data) {
    this.id = data.id;                    // "quest_001"
    this.name = data.name;                // "é‹¼ã®å‰£"
    this.description = data.description;  // "ç«å±æ€§15ä»¥ä¸Šã®æ­¦å™¨ã‚’ç´å“"
    this.category = data.category;        // "weapon" | "medicine"
    this.difficulty = data.difficulty;    // "easy" | "normal" | "hard"

    // è¦ä»¶
    this.requirements = {
      fire: data.requirements?.fire || 0,
      water: data.requirements?.water || 0,
      earth: data.requirements?.earth || 0,
      wind: data.requirements?.wind || 0,
      total: data.requirements?.total || 0
    };

    // å ±é…¬
    this.reward = {
      money: data.reward.money,           // ãŠé‡‘
      explorationRate: data.reward.explorationRate || 0,  // é–‹æ‹“åº¦UP
      exhaustionReduction: data.reward.exhaustionReduction || 0  // æ¶ˆè€—åº¦DOWN
    };

    // æœŸé™
    this.deadline = data.deadline;        // æ®‹ã‚Šã‚¿ãƒ¼ãƒ³æ•°
    this.maxDeadline = data.deadline;     // åˆæœŸæœŸé™

    // çŠ¶æ…‹
    this.status = 'available';            // "available" | "active" | "completed" | "expired"
  }

  /**
   * ã‚¿ãƒ¼ãƒ³çµŒéã§æœŸé™ã‚’æ¸›å°‘
   */
  decreaseDeadline() {
    if (this.status === 'active' && this.deadline > 0) {
      this.deadline--;
      if (this.deadline <= 0) {
        this.status = 'expired';
        return true; // æœŸé™åˆ‡ã‚Œ
      }
    }
    return false;
  }

  /**
   * ç´å“å¯èƒ½ã‹åˆ¤å®š
   */
  canDeliver(craftedItem) {
    if (this.status !== 'active') return false;
    if (craftedItem.category !== this.category) return false;
    return AttributeCalculator.meetsRequirements(
      craftedItem.attributes,
      this.requirements
    );
  }
}
```

### 2.3 QuestService

```javascript
/**
 * ä¾é ¼ã‚µãƒ¼ãƒ“ã‚¹
 */
class QuestService {
  constructor(gameManager) {
    this.gameManager = gameManager;
    this.maxActiveQuests = 2;  // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã¯åŒæ™‚2ä»¶
  }

  /**
   * ä¾é ¼ã‚’å—æ³¨
   */
  acceptQuest(quest) {
    const state = this.gameManager.getState();
    if (state.quests.active.length >= this.maxActiveQuests) {
      return { success: false, message: 'å—æ³¨ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™' };
    }

    quest.status = 'active';
    state.quests.active.push(quest);
    state.quests.available = state.quests.available.filter(q => q.id !== quest.id);

    this.gameManager.emit(GameEvents.QUEST_ACCEPTED, { quest });
    return { success: true };
  }

  /**
   * ä¾é ¼ã‚’ç´å“
   */
  deliverQuest(quest, craftedItem) {
    if (!quest.canDeliver(craftedItem)) {
      return { success: false, message: 'è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“' };
    }

    const state = this.gameManager.getState();

    // å ±é…¬é©ç”¨
    state.player.money += quest.reward.money;
    state.player.explorationRate += quest.reward.explorationRate;
    state.player.exhaustionRate = Math.max(0,
      state.player.exhaustionRate - quest.reward.exhaustionReduction
    );

    // çŠ¶æ…‹æ›´æ–°
    quest.status = 'completed';
    state.quests.active = state.quests.active.filter(q => q.id !== quest.id);
    state.quests.completed.push(quest);

    // ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆè²»
    state.crafting.craftedItems = state.crafting.craftedItems.filter(
      item => item !== craftedItem
    );

    this.gameManager.emit(GameEvents.QUEST_DELIVERED, { quest, craftedItem });
    this.gameManager.emit(GameEvents.MONEY_CHANGED, { money: state.player.money });
    this.gameManager.emit(GameEvents.EXPLORATION_CHANGED, {
      rate: state.player.explorationRate
    });

    return { success: true };
  }
}
```

---

## 3. æ¡å–ã‚·ã‚¹ãƒ†ãƒ 

### 3.1 æ¡å–åœ°

ğŸŸ¡ **ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã¯2ç®‡æ‰€ã«ç°¡ç•¥åŒ–**

| æ¡å–åœ° | ã‚¿ãƒ¼ãƒ³æ¶ˆè²» | ç²å¾—æ•° | å‚¾å‘ |
|--------|----------|--------|------|
| **è¿‘éƒŠã®æ£®** | 1 | 2æš | æ°´ãƒ»é¢¨å±æ€§å¤šã‚ |
| **å±±éº“ã®å²©å ´** | 2 | 3æš | ç«ãƒ»åœŸå±æ€§å¤šã‚ |

### 3.2 GatheringService

```javascript
/**
 * æ¡å–ã‚µãƒ¼ãƒ“ã‚¹
 */
class GatheringService {
  constructor(gameManager, masterDataLoader, randomGenerator) {
    this.gameManager = gameManager;
    this.masterData = masterDataLoader;
    this.random = randomGenerator;

    // æ¡å–åœ°å®šç¾©
    this.locations = {
      forest: {
        id: 'forest',
        name: 'è¿‘éƒŠã®æ£®',
        turnCost: 1,
        cardCount: 2,
        cardPool: ['card_herb', 'card_flower', 'card_seed', 'card_moss'],
        weights: { water: 2, wind: 2, fire: 1, earth: 1 }
      },
      rocky: {
        id: 'rocky',
        name: 'å±±éº“ã®å²©å ´',
        turnCost: 2,
        cardCount: 3,
        cardPool: ['card_iron', 'card_stone', 'card_clay', 'card_sulfur'],
        weights: { fire: 2, earth: 2, water: 1, wind: 1 }
      }
    };
  }

  /**
   * æ¡å–ã‚’å®Ÿè¡Œ
   */
  gather(locationId) {
    const location = this.locations[locationId];
    if (!location) {
      return { success: false, message: 'ç„¡åŠ¹ãªæ¡å–åœ°ã§ã™' };
    }

    const state = this.gameManager.getState();

    // ãƒ‡ãƒƒã‚­ä¸Šé™ãƒã‚§ãƒƒã‚¯
    if (state.deck.cards.length >= state.deck.maxSize) {
      return { success: false, message: 'ãƒ‡ãƒƒã‚­ãŒæº€æ¯ã§ã™' };
    }

    // ã‚¿ãƒ¼ãƒ³æ¶ˆè²»
    this.gameManager.consumeTurns(location.turnCost);

    // ã‚«ãƒ¼ãƒ‰ç²å¾—
    const gatheredCards = [];
    for (let i = 0; i < location.cardCount; i++) {
      if (state.deck.cards.length >= state.deck.maxSize) break;

      const cardId = this.random.weightedChoice(location.cardPool);
      const cardData = this.masterData.getCard(cardId);
      const card = new Card(cardData);

      state.deck.cards.push(card);
      gatheredCards.push(card);
    }

    this.gameManager.emit(GameEvents.GATHERING_COMPLETE, {
      location,
      cards: gatheredCards
    });

    return { success: true, cards: gatheredCards };
  }
}
```

---

## 4. èª¿åˆã‚·ã‚¹ãƒ†ãƒ 

### 4.1 èª¿åˆã®æµã‚Œ

ğŸ”µ **ç´ æã‚«ãƒ¼ãƒ‰æ¶ˆè²» â†’ ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ**

```mermaid
sequenceDiagram
    participant P as Player
    participant CS as CraftingService
    participant AC as AttributeCalculator
    participant D as Deck

    P->>CS: èª¿åˆé–‹å§‹ï¼ˆã‚«ãƒ¼ãƒ‰é¸æŠï¼‰
    CS->>AC: å±æ€§è¨ˆç®—
    AC-->>CS: åˆç®—å±æ€§
    CS->>CS: ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    CS->>D: ã‚«ãƒ¼ãƒ‰æ¶ˆè²»
    CS-->>P: èª¿åˆçµæœï¼ˆã‚¢ã‚¤ãƒ†ãƒ ï¼‰
```

### 4.2 ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š

ğŸ”µ **è¦ä»¶å®šç¾©æ›¸æº–æ‹ **

| ã‚«ãƒ†ã‚´ãƒª | åˆ¤å®šæ¡ä»¶ | ç´å“æ™‚åŠ¹æœ |
|---------|---------|-----------|
| **æ­¦å™¨** | ç«å±æ€§ >= 10 ã¾ãŸã¯ åœŸå±æ€§ >= 10 | é–‹æ‹“åº¦UP + ãŠé‡‘ |
| **è–¬** | æ°´å±æ€§ >= 10 ã¾ãŸã¯ é¢¨å±æ€§ >= 10 | æ¶ˆè€—åº¦DOWN + ãŠé‡‘ |
| **é“å…·** | ä¸Šè¨˜ä»¥å¤– | ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŒ–ï¼ˆå¾Œå›ã—ï¼‰ |

### 4.3 CraftingService

```javascript
/**
 * èª¿åˆã‚µãƒ¼ãƒ“ã‚¹
 */
class CraftingService {
  constructor(gameManager) {
    this.gameManager = gameManager;
    this.minCardsRequired = 2;  // æœ€å°ç´ ææ•°
    this.maxCardsAllowed = 5;   // æœ€å¤§ç´ ææ•°
  }

  /**
   * èª¿åˆã‚’å®Ÿè¡Œ
   * @param {Card[]} selectedCards - é¸æŠã—ãŸç´ æã‚«ãƒ¼ãƒ‰
   */
  craft(selectedCards) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (selectedCards.length < this.minCardsRequired) {
      return { success: false, message: `æœ€ä½${this.minCardsRequired}æšå¿…è¦ã§ã™` };
    }
    if (selectedCards.length > this.maxCardsAllowed) {
      return { success: false, message: `æœ€å¤§${this.maxCardsAllowed}æšã¾ã§ã§ã™` };
    }

    const state = this.gameManager.getState();

    // å±æ€§è¨ˆç®—
    const attributes = AttributeCalculator.sumAttributes(selectedCards);
    const total = AttributeCalculator.getTotalValue(attributes);

    // ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š
    const category = this.determineCategory(attributes);

    // èª¿åˆã‚¿ãƒ¼ãƒ³æ¶ˆè²»ï¼ˆç´ ææ•°ã«å¿œã˜ã¦ï¼‰
    const turnCost = selectedCards.length <= 3 ? 1 : 2;
    this.gameManager.consumeTurns(turnCost);

    // ã‚«ãƒ¼ãƒ‰æ¶ˆè²»
    selectedCards.forEach(card => {
      const index = state.deck.cards.findIndex(c => c === card);
      if (index !== -1) {
        state.deck.cards.splice(index, 1);
      }
    });

    // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
    const craftedItem = {
      id: `item_${Date.now()}`,
      name: this.generateItemName(category, total),
      category: category,
      attributes: attributes,
      total: total
    };

    state.crafting.craftedItems.push(craftedItem);

    this.gameManager.emit(GameEvents.CRAFTING_COMPLETE, { item: craftedItem });

    return { success: true, item: craftedItem };
  }

  /**
   * ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®š
   */
  determineCategory(attributes) {
    if (attributes.fire >= 10 || attributes.earth >= 10) {
      return 'weapon';
    }
    if (attributes.water >= 10 || attributes.wind >= 10) {
      return 'medicine';
    }
    return 'tool';
  }

  /**
   * ã‚¢ã‚¤ãƒ†ãƒ åã‚’ç”Ÿæˆ
   */
  generateItemName(category, total) {
    const quality = total >= 30 ? 'é«˜å“è³ª' : total >= 20 ? 'ä¸Šè³ª' : 'æ™®é€š';
    const categoryName = {
      weapon: 'æ­¦å™¨',
      medicine: 'è–¬',
      tool: 'é“å…·'
    }[category];
    return `${quality}ã®${categoryName}`;
  }
}
```

---

## 5. è²·ã„ç‰©ã‚·ã‚¹ãƒ†ãƒ 

### 5.1 ã‚·ãƒ§ãƒƒãƒ—ä»•æ§˜

ğŸŸ¡ **ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç‰ˆï¼ˆç°¡ç•¥åŒ–ï¼‰**

| è¦ç´  | ä»•æ§˜ |
|------|------|
| ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ— | 3ã€œ4ç¨®é¡ã®ç´ æã‚«ãƒ¼ãƒ‰ |
| ä¾¡æ ¼ | 10Gã€œ50Gï¼ˆãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¾å­˜ï¼‰ |
| æ›´æ–° | 3ã‚¿ãƒ¼ãƒ³ã”ã¨ã«è‡ªå‹•æ›´æ–° |

### 5.2 ShopService

```javascript
/**
 * ã‚·ãƒ§ãƒƒãƒ—ã‚µãƒ¼ãƒ“ã‚¹
 */
class ShopService {
  constructor(gameManager, masterDataLoader, randomGenerator) {
    this.gameManager = gameManager;
    this.masterData = masterDataLoader;
    this.random = randomGenerator;

    this.shopItems = [];
    this.refreshInterval = 3;  // 3ã‚¿ãƒ¼ãƒ³ã”ã¨æ›´æ–°
    this.lastRefreshTurn = 0;
  }

  /**
   * ã‚·ãƒ§ãƒƒãƒ—ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã‚’æ›´æ–°
   */
  refreshShop() {
    const allCards = this.masterData.getAllCards()
      .filter(c => c.type === 'material');

    this.shopItems = [];
    const count = 3 + Math.floor(Math.random() * 2); // 3-4å€‹

    for (let i = 0; i < count; i++) {
      const cardData = this.random.choice(allCards);
      this.shopItems.push({
        card: new Card(cardData),
        price: this.calculatePrice(cardData)
      });
    }

    this.lastRefreshTurn = this.gameManager.getState().player.currentTurn;
  }

  /**
   * ä¾¡æ ¼ã‚’è¨ˆç®—
   */
  calculatePrice(cardData) {
    const basePrice = {
      common: 10,
      uncommon: 25,
      rare: 50
    }[cardData.rarity] || 10;

    // å±æ€§åˆè¨ˆã§ãƒœãƒ¼ãƒŠã‚¹
    const total = (cardData.fire || 0) + (cardData.water || 0) +
                  (cardData.earth || 0) + (cardData.wind || 0);
    return basePrice + Math.floor(total * 2);
  }

  /**
   * è³¼å…¥
   */
  purchase(shopItem) {
    const state = this.gameManager.getState();

    // ãŠé‡‘ãƒã‚§ãƒƒã‚¯
    if (state.player.money < shopItem.price) {
      return { success: false, message: 'ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“' };
    }

    // ãƒ‡ãƒƒã‚­ä¸Šé™ãƒã‚§ãƒƒã‚¯
    if (state.deck.cards.length >= state.deck.maxSize) {
      return { success: false, message: 'ãƒ‡ãƒƒã‚­ãŒæº€æ¯ã§ã™' };
    }

    // è³¼å…¥å‡¦ç†
    state.player.money -= shopItem.price;
    state.deck.cards.push(shopItem.card);

    // ã‚·ãƒ§ãƒƒãƒ—ã‹ã‚‰å‰Šé™¤
    this.shopItems = this.shopItems.filter(item => item !== shopItem);

    // 1ã‚¿ãƒ¼ãƒ³æ¶ˆè²»
    this.gameManager.consumeTurns(1);

    this.gameManager.emit(GameEvents.SHOP_PURCHASE, { item: shopItem });
    this.gameManager.emit(GameEvents.MONEY_CHANGED, { money: state.player.money });

    return { success: true };
  }
}
```

---

## 6. ãƒ‡ãƒƒã‚­ç®¡ç†

### 6.1 Deckã‚¯ãƒ©ã‚¹

```javascript
/**
 * ãƒ‡ãƒƒã‚­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
 */
class Deck {
  constructor(maxSize = 15) {
    this.cards = [];
    this.maxSize = maxSize;
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
   */
  addCard(card) {
    if (this.cards.length >= this.maxSize) {
      return false;
    }
    this.cards.push(card);
    return true;
  }

  /**
   * ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
   */
  removeCard(card) {
    const index = this.cards.findIndex(c => c === card);
    if (index !== -1) {
      this.cards.splice(index, 1);
      return true;
    }
    return false;
  }

  /**
   * ç©ºãå®¹é‡ã‚’å–å¾—
   */
  getRemainingCapacity() {
    return this.maxSize - this.cards.length;
  }

  /**
   * å±æ€§åˆ¥ã«ã‚«ãƒ¼ãƒ‰ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
   */
  groupByAttribute() {
    return {
      fire: this.cards.filter(c => c.attributes.fire > 0),
      water: this.cards.filter(c => c.attributes.water > 0),
      earth: this.cards.filter(c => c.attributes.earth > 0),
      wind: this.cards.filter(c => c.attributes.wind > 0)
    };
  }
}
```

---

## 7. ã‚¿ãƒ¼ãƒ³ç®¡ç†

### 7.1 TurnManager

```javascript
/**
 * ã‚¿ãƒ¼ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
 */
class TurnManager {
  constructor(gameManager) {
    this.gameManager = gameManager;
    this.exhaustionPerTurn = 3;  // 1ã‚¿ãƒ¼ãƒ³ã‚ãŸã‚Šæ¶ˆè€—åº¦+3%
  }

  /**
   * ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†
   */
  startTurn() {
    const state = this.gameManager.getState();

    this.gameManager.emit(GameEvents.TURN_START, {
      turn: state.player.currentTurn
    });

    // ä¾é ¼æœŸé™ãƒã‚§ãƒƒã‚¯
    state.quests.active.forEach(quest => {
      if (quest.decreaseDeadline()) {
        this.gameManager.emit(GameEvents.QUEST_EXPIRED, { quest });
      }
    });
  }

  /**
   * ã‚¿ãƒ¼ãƒ³ã‚’æ¶ˆè²»
   */
  consumeTurns(count) {
    const state = this.gameManager.getState();

    for (let i = 0; i < count; i++) {
      state.player.currentTurn++;
      state.player.exhaustionRate += this.exhaustionPerTurn;

      this.gameManager.emit(GameEvents.EXHAUSTION_CHANGED, {
        rate: state.player.exhaustionRate
      });

      // æ•—åŒ—åˆ¤å®š
      if (state.player.exhaustionRate >= 100) {
        this.gameManager.emit(GameEvents.GAME_LOSE, {
          reason: 'æ¶ˆè€—åº¦ãŒ100%ã«é”ã—ã¾ã—ãŸ'
        });
        return;
      }

      // å‹åˆ©åˆ¤å®š
      if (state.player.explorationRate >= 100) {
        this.gameManager.emit(GameEvents.GAME_WIN, {
          turn: state.player.currentTurn
        });
        return;
      }
    }

    this.gameManager.emit(GameEvents.TURN_END, {
      turn: state.player.currentTurn
    });
  }
}
```

---

## ã‚·ã‚¹ãƒ†ãƒ é–“ä¾å­˜é–¢ä¿‚

```mermaid
graph TB
    GM[GameManager] --> TM[TurnManager]
    GM --> QS[QuestService]
    GM --> GS[GatheringService]
    GM --> CS[CraftingService]
    GM --> SS[ShopService]

    QS --> AC[AttributeCalculator]
    CS --> AC
    GS --> RG[RandomGenerator]
    SS --> RG

    QS --> Quest
    GS --> Card
    CS --> Card
    SS --> Card

    GM --> Deck
    GM --> Player
```

---

## å‚ç…§

- [architecture.md](architecture.md) - ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [game-mechanics.md](game-mechanics.md) - ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹è¨­è¨ˆ
- [data-schema.md](data-schema.md) - ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|----------|---------|
| 2025-12-29 | 1.0 | åˆç‰ˆä½œæˆï¼ˆHTMLãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ç”¨ï¼‰ |
